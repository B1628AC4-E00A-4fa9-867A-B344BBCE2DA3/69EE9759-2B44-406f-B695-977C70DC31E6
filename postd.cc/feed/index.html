<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア]]></title><description><![CDATA[POSTD は、ニジボックスが運営する、エンジニアに向けたキュレーションメディアです。ニジボックスはWebサービスの企画、制作、開発、運用を一貫して担うリクルートの100%子会社です。 リクルートグループのオンラインサービスをはじめ、様々な業種・業界・業態のサービス開発を行っております。]]></description><link>https://postd.cc</link><generator>GatsbyJS</generator><lastBuildDate>Thu, 21 Apr 2022 07:21:58 GMT</lastBuildDate><language>ja</language><atom:link href="https://postd.cc/feed/" rel="self" type="application/rss+xml"/><image><title>POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア</title><link>https://postd.cc</link></image><item><title><![CDATA[あまり知られていないPostgreSQLの機能]]></title><description><![CDATA[あなたが知らない既存機能があるかもしれません！ マイクロソフト社は2006年、Microsoft Officeの新バージョンで追加してほしい機能について、顧客調査を実施しました。驚いたことに、ユーザ…]]></description><link>https://postd.cc/postgresql-unknown-features/</link><guid isPermaLink="false">https://postd.cc/postgresql-unknown-features/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[PostgreSQL]]></category><pubDate>Mon, 18 Apr 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<style>
    .toc-for-article {
        clear: both;
        box-shadow: 0 9px 30px -5px rgb(50 50 83 / 25%), 0 8px 8px -12px rgb(0 0 0 / 20%), 0 -6px 16px -6px rgb(0 0 0 / 3%);
        border-radius: 11px;
        padding: 2em;
        background-color: #fff;
        margin: 1.25em 0 3em;
        columns: 2;

    }
</style>
<p>あなたが知らない既存機能があるかもしれません！</p>
<p>マイクロソフト社は2006年、Microsoft Officeの新バージョンで追加してほしい機能について、顧客調査を実施しました。驚いたことに、ユーザが希望した機能の90%以上はすでに実装されており、その存在が知られていないだけであることが判明しました。機能の「見つけにくさ」の問題の解決策として同社が考案したのが、現在のMicrosoft Office製品でおなじみの「リボンUI」です。</p>
<p>この問題はOfficeに限ったものではありません。日々使用するツールの機能をすべて把握している人はほとんどいません。PostgreSQLのように大規模なツールであればなおさらです。数週間前にPostgreSQL 14がリリースされたばかりなので、この機会にPostgreSQLのあまり知られていない機能に注目してみたいと思います。</p>
<p><strong>この記事では、PostgreSQLのあまり知られていない機能を紹介します。</strong></p>
<div style="margin: 0 auto; text-align: center;">
<img src="https://hakibenita.com/images/00-postgresql-unknown-features.png" style="height: 350px; width: 270px;">
<br>Illustration by <a href="https://www.instagram.com/_wrightdesign/">Eleanor Wright</a>
</div>
<h3>目次</h3>
<ul class="toc-for-article">
    <li><a href="#01">UPSERTにおいて更新、挿入された行数の取得</a></li>
    <li><a href="#02">特定の列の権限付与</a></li>
    <li><a href="#03">複数パターンに対するマッチング</a></li>
    <li><a href="#04">シーケンスを進めることなく現在値を確認する</a></li>
    <li><a href="#05">複数行のSQLで\COPYを使用する</a></li>
    <li><a href="#06">自動生成キーの値の設定を防ぐ</a></li>
    <li><a href="#07">ピボットテーブルを作成するもう2つの方法</a></li>
    <li><a href="#08">ドル引用</a></li>
    <li><a href="#09">データベースオブジェクトに関するコメント</a></li>
    <li><a href="#10">データベースごとに個別の履歴ファイルを維持する</a></li>
    <li><a href="#11">大文字の予約語の自動補完</a></li>
    <li><a href="#12">スリープ時間の指定</a></li>
    <li><a href="#13">サブクエリを使用せず、グループの最初または最後の行を取得する</a></li>
    <li><a href="#14">拡張機能なしでUUIDを生成する</a></li>
    <li><a href="#15">再現可能なランダムデータの生成</a></li>
    <li><a href="#16">直ちに検証することなく制約を追加する</a></li>
    <li><a href="#17">PostgreSQLにおけるシノニム</a></li>
    <li><a href="#18">重複レンジを探す</a></li>
</ul>
<h2>UPSERTにおいて更新、挿入された行数の取得 <a name="01"></a></h2>
<p>INSERT ON CONFLICTは、Extract(抽出) Transform(変換) Load(読み込み) プロセスでは特に便利なコマンドであり、Oracleの「MERGE」に相当し、「UPSERT」（UPDATEとINSERTを組み合わせた造語）とも呼ばれます。INSERT文のON CONFLICT句を使用することで、キー列に重複がある場合の処理をデータベースに指示できます。</p>
<p>以下は従業員テーブルのデータを同期するためのクエリの例です。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">WITH</span> new_employees <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'George'</span><span class="token punctuation">,</span> <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Manager'</span><span class="token punctuation">,</span>   <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Jane'</span><span class="token punctuation">,</span>   <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Developer'</span><span class="token punctuation">,</span> <span class="token number">1200</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
         <span class="token keyword">name</span><span class="token punctuation">,</span>      department<span class="token punctuation">,</span> role<span class="token punctuation">,</span>       salary
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token punctuation">(</span><span class="token keyword">name</span><span class="token punctuation">,</span> department<span class="token punctuation">,</span> role<span class="token punctuation">,</span> salary<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">name</span><span class="token punctuation">,</span> department<span class="token punctuation">,</span> role<span class="token punctuation">,</span> salary
<span class="token keyword">FROM</span> new_employees
<span class="token keyword">ON</span> CONFLICT <span class="token punctuation">(</span><span class="token keyword">name</span><span class="token punctuation">)</span> <span class="token keyword">DO</span> <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span>
    department <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>department<span class="token punctuation">,</span>
    role <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>role<span class="token punctuation">,</span>
    salary <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>salary
<span class="token keyword">RETURNING</span> <span class="token operator">*</span><span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ department │   role    │ salary
────────┼────────────┼───────────┼────────
 George │ Sales      │ Manager   │   <span class="token number">1000</span>
 Jane   │ R<span class="token operator">&amp;</span>D        │ Developer │   <span class="token number">1200</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このクエリは、新しい従業員データをテーブルに挿入します。追加しようとした従業員の名前がすでに存在する場合、データを挿入する代わりにその行が更新されます。</p>
<div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>RETURNING *</h5></div><div class="admonition-content"><p><a href="https://hakibenita.com/sql-tricks-application-dba#implement-complete-processes-using-with-and-returning">WITHとRETURNINGを使用して完全なプロセスを実行する方法</a>はこちらをご覧ください。</p></div></div>
<p>上記コマンドの出力INSERT 0 2から、影響のある従業員が2名いることが分かります。では、挿入された行数と更新された行数はいくつでしょうか。この出力からは判断できません。</p>
<p>筆者が同様のクエリを使用したETLプロセスのロギングを改善する方法を探していた際、<a href="https://stackoverflow.com/a/39204667/2000875">Stack Overflowで投稿された質問に対する回答</a>に、これと全く同じ問題に対する有効な解決策を偶然見つけました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">WITH</span> new_employees <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'George'</span><span class="token punctuation">,</span> <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Manager'</span><span class="token punctuation">,</span>   <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Jane'</span><span class="token punctuation">,</span>   <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Developer'</span><span class="token punctuation">,</span> <span class="token number">1200</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
         <span class="token keyword">name</span><span class="token punctuation">,</span>      department<span class="token punctuation">,</span> role<span class="token punctuation">,</span>       salary
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token punctuation">(</span><span class="token keyword">name</span><span class="token punctuation">,</span> department<span class="token punctuation">,</span> role<span class="token punctuation">,</span> salary<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">name</span><span class="token punctuation">,</span> department<span class="token punctuation">,</span> role<span class="token punctuation">,</span> salary
<span class="token keyword">FROM</span> new_employees
<span class="token keyword">ON</span> CONFLICT <span class="token punctuation">(</span><span class="token keyword">name</span><span class="token punctuation">)</span> <span class="token keyword">DO</span> <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span>
    department <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>department<span class="token punctuation">,</span>
    role <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>role<span class="token punctuation">,</span>
    salary <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>salary
<span class="token keyword">RETURNING</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>xmax <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> inserted<span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ department │   role    │ salary │ inserted
────────┼────────────┼───────────┼────────┼──────────
 Jane   │ R<span class="token operator">&amp;</span>D        │ Developer │   <span class="token number">1200</span> │ t
 George │ Sales      │ Manager   │   <span class="token number">1000</span> │ f
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>RETURNING句の違いに注目してください。こちらの例では、xmaxという特殊な列を使用して挿入された行数を計算するinsertedという計算済みフィールドが含まれています。コマンドによって返されたデータから、「Jane」の行が新たに挿入されたものの、「George」はすでにテーブルに存在したため、その行は更新されたことが分かります。</p>
<p>xmax列は、<a href="https://www.postgresql.org/docs/current/ddl-system-columns.html">特殊なシステム列</a>です。</p>
<p>削除トランザクションの識別情報（トランザクションID）です。削除されていない行ではゼロです。
PostgreSQLでは、行が更新されると古いバージョンが削除され、xmaxに削除トランザクションのIDが保持されます。行が挿入されると、古い行の削除は行われないため、xmaxの値は0になります。この解決策では、この挙動を賢く利用して更新された行と挿入された行を区別しています。</p>
<hr>
<h2>特定の列の権限付与 <a name="02"></a></h2>
<p>認証情報、パスワード、個人を特定できる情報などのセンシティブ情報を含むユーザテーブルがあるとします。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">,</span>
    username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    personal_id <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    password_hash <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'haki'</span><span class="token punctuation">,</span> <span class="token string">'12222227'</span><span class="token punctuation">,</span> <span class="token string">'super-secret-hash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">1</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このテーブルは、アナリストなど組織内のさまざまな人が、データにアクセスして随時レポートを作成するために使用します。アナリストにアクセスを許可するため、データベースに特別ユーザを追加します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">USER</span> analyst<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span>

db<span class="token operator">=</span># <span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> users <span class="token keyword">TO</span> analyst<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>現在、データベース「db」にユーザ「analyst」として接続されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \<span class="token keyword">connect</span> db analyst
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"analyst"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
 id │ username │ personal_id │   password_hash
────┼──────────┼─────────────┼───────────────────
  <span class="token number">1</span> │ haki     │ <span class="token number">12222227</span>    │ super<span class="token operator">-</span>secret<span class="token operator">-</span><span class="token keyword">hash</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>前に述べたように、アナリストはレポートを作成し、分析を行うためにユーザデータにアクセスしますが、センシティブ情報や個人を特定できる情報にアクセスできることは望ましくありません。</p>
<p>ユーザがテーブル内でアクセスできるデータを詳細に制御するため、PostgreSQLでは特定の列のみを対象に権限を付与できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \<span class="token keyword">connect</span> db postgres
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"postgres"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">REVOKE</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> users <span class="token keyword">FROM</span> analyst<span class="token punctuation">;</span>
<span class="token keyword">REVOKE</span>

db<span class="token operator">=</span># <span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">)</span> <span class="token keyword">ON</span> users <span class="token keyword">TO</span> analyst<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>テーブル上の既存の選択権限を取り消した後、id列とusername列のみを対象として、analystに選択権限を付与しました。これで、analystはこれら以外の列にはアクセスできなくなります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \<span class="token keyword">connect</span> db analyst
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"analyst"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
ERROR:  permission denied <span class="token keyword">for</span> <span class="token keyword">table</span> users

db<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> personal_id <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
ERROR:  permission denied <span class="token keyword">for</span> <span class="token keyword">table</span> users

db<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> username <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
 id │ username
────┼──────────
  <span class="token number">1</span> │ haki</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ユーザ「analyst」が制限された列に明示的、あるいは「*」を使用して黙示的にアクセスしようとすると、「permission denied」エラーが返されます。</p>
<hr>
<h2>複数パターンに対するマッチング <a name="03"></a></h2>
<p>SQLでは、パターンマッチングをよく使用します。以下は「gmail.com」のメールアカウントを保有するユーザを検索するクエリの例です。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> email <span class="token operator">LIKE</span> <span class="token string">'%@gmail.com'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>このクエリは、ワイルドカード「%」を使用し、メールアドレスが「@gmail.com」で終わるユーザを検索します。では、同じクエリの中で「yahoo.com」のメールアカウントを保有するユーザも検索したい場合はどうすればよいでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span>
    email <span class="token operator">LIKE</span> <span class="token string">'%@gmail.com'</span>
    <span class="token operator">OR</span> email <span class="token operator">LIKE</span> <span class="token string">'%@yahoo.com'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>いずれかのパターンに対するマッチングを行うには、OR条件を指定する方法があります。しかし、PostgreSQLでは、複数パターンに対してマッチングを行う方法は他にもあります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> email SIMILAR <span class="token keyword">TO</span> <span class="token string">'%@gmail.com|%@yahoo.com'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p><a href="https://www.postgresql.org/docs/current/functions-matching.html#FUNCTIONS-SIMILARTO-REGEXP">SIMILAR TO</a>演算子を使用することで、単純なクエリにより複数パターンとのマッチングを行うことができます。</p>
<p>regexpを使用して複数パターンとのマッチングを行う方法もあります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> email <span class="token operator">~</span> <span class="token string">'@gmail\.com$|@yahoo\.com$'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>regexpを使用する際には注意が必要です。ピリオド（.）は任意の文字にマッチするため、gmail.comやyahoo.comに含まれるピリオドとマッチングするには、「.」のようにエスケープ文字を追加する必要があります。</p>
<p>筆者がこの情報を<a href="https://twitter.com/be_haki/status/1435859174538293248?s=20">Twitterに</a>投稿したところ、いくつかの興味深い反応が得られました。Pythonに対応したPostgreSQLドライバであるpsycopgの公式アカウントから届いた<a href="https://twitter.com/psycopg/status/1435926642388516866?s=20">コメント</a>は、別の方法を提案しました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> email <span class="token operator">~</span> <span class="token keyword">ANY</span><span class="token punctuation">(</span><span class="token keyword">ARRAY</span><span class="token punctuation">[</span><span class="token string">'@gmail\.com$'</span><span class="token punctuation">,</span> <span class="token string">'@yahoo\.com$'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>このクエリでは、ANY演算子を使用してさまざまなパターンに対してマッチングを行います。メールアドレスがいずれかのパターンにマッチすれば、条件は真となります。このアプローチは、Pythonなどのホスト言語から行うとやりやすいでしょう。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">with</span> connection<span class="token punctuation">.</span><span class="token keyword">cursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">cursor</span>:
    <span class="token keyword">cursor</span><span class="token punctuation">.</span><span class="token keyword">execute</span><span class="token punctuation">(</span><span class="token string">'''
        SELECT *
        FROM users
        WHERE email ~ ANY(ARRAY%(patterns)s)
    '''</span> <span class="token operator">%</span> {
        <span class="token string">'patterns'</span>: <span class="token punctuation">[</span>
            <span class="token string">'@gmail\.com$'</span><span class="token punctuation">,</span>
            <span class="token string">'@yahoo\.com$'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    }<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>SIMILAR TO演算子を用いた前述のアプローチとは異なり、ANY演算子を使用すればパターンのリストを変数に結合できます。</p>
<hr>
<h2>シーケンスを進めることなく現在値を確認する <a name="04"></a></h2>
<p>シーケンスの現在値を確認する必要がある場合、おそらく最初に<a href="https://www.postgresql.org/docs/current/functions-sequence.html">currval</a>を使用するでしょう。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> currval<span class="token punctuation">(</span><span class="token string">'sale_id_seq'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR:  currval <span class="token keyword">of</span> <span class="token keyword">sequence</span> <span class="token string">"sale_id_seq"</span> <span class="token operator">is</span> <span class="token operator">not</span> yet defined <span class="token operator">in</span> this <span class="token keyword">session</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>その場合、筆者と同じように、currvalはシーケンスが現在のセッションで定義または使用されていなければ使えないことに気付くと思います。特に理由もなくシーケンスを進めることは通常避けたいため、これは好ましい解決策ではありません。</p>
<p>PostgreSQL 10では、シーケンスに関する情報に容易にアクセスできるよう、<a href="https://www.postgresql.org/docs/current/view-pg-sequences.html">pg_sequences</a>ビューが追加されました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> pg_sequences <span class="token keyword">WHERE</span> sequencename <span class="token operator">=</span> <span class="token string">'sale_id_seq'</span><span class="token punctuation">;</span>
─<span class="token punctuation">[</span> <span class="token keyword">RECORD</span> <span class="token number">1</span> <span class="token punctuation">]</span>─┬────────────
schemaname    │ <span class="token keyword">public</span>
sequencename  │ sale_id_seq
sequenceowner │ db
data_type     │ <span class="token keyword">integer</span>
start_value   │ <span class="token number">1</span>
min_value     │ <span class="token number">1</span>
max_value     │ <span class="token number">2147483647</span>
increment_by  │ <span class="token number">1</span>
<span class="token keyword">cycle</span>         │ f
cache_size    │ <span class="token number">1</span>
last_value    │ <span class="token number">155</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このテーブルでも現在値は確認できますが、これは「あまり知られていない機能」というよりも、情報スキーマにおけるテーブルの1つに過ぎません。</p>
<p>ドキュメントには記載されていないのですが、pg<em>sequence</em>last_valueという関数を使用してシーケンスの現在値を確認する方法もあります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> pg_sequence_last_value<span class="token punctuation">(</span><span class="token string">'sale_id_seq'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pg_sequence_last_value
────────────────────────
                   <span class="token number">155</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>なぜこの関数がドキュメントに記載されていないのかは定かではありませんが、筆者が確認したところ、<a href="https://www.postgresql.org/search/?u=%2Fdocs%2F14%2F&#x26;q=pg_sequence_last_value">公式ドキュメント</a>の中では言及されていませんでした。使用する場合はその点も考慮してください。</p>
<p>興味深いことに、このテーマについて調査をしているとき、テーブルと同じようにシーケンスもクエリできることを発見しました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sale_id_seq<span class="token punctuation">;</span>

 last_value │ log_cnt │ is_called
────────────┼─────────┼───────────
        <span class="token number">155</span> │      <span class="token number">10</span> │ t</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>PostgreSQLでは他にどのような種類のオブジェクトをクエリでき、どのような値が返されるのか気になるところです。</p>
<p>注意すべき点として、この機能はシーケンスを大まかに確認するためだけに使用してください。この出力の値をもとにIDの更新を試みるべきではありません。IDを更新したい場合はnextvalを使用してください。</p>
<hr>
<h2>複数行のSQLで\COPYを使用する <a name="05"></a></h2>
<p>psqlを頻繁に使用する人は、データベースからデータをエクスポートするために\COPYをかなりの頻度で使用しているのではないでしょうか。筆者は頻繁に使用しています。\COPYに関する不満点の1つは、複数行のクエリに対応していないことです。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \COPY <span class="token punctuation">(</span>
\copy: parse error <span class="token keyword">at</span> <span class="token keyword">end</span> <span class="token keyword">of</span> line</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>\COPYコマンドに新しい行を追加しようとすると、このようなエラーメッセージが表示されます。
この制約を回避するため、筆者はまずビューを使用しました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> v_department_dbas <span class="token keyword">AS</span>
    <span class="token keyword">SELECT</span> department<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> employees
    <span class="token keyword">FROM</span> emp
    <span class="token keyword">WHERE</span> role <span class="token operator">=</span> <span class="token string">'dba'</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> department
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> employees<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span>

db<span class="token operator">=</span># \COPY <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> v_department_dbas<span class="token punctuation">)</span> <span class="token keyword">TO</span> department_dbas<span class="token punctuation">.</span>csv <span class="token keyword">WITH</span> CSV HEADER<span class="token punctuation">;</span>
COPY <span class="token number">5</span>

db<span class="token operator">=</span># <span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> v_department_dbas<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">VIEW</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この方法も有効ではあるものの、途中で何かがうまく行かなかった場合、ビューが散乱する結果になりかねません。スキーマはきれいに整理された状態にしておきたいので、作業後のクリーンアップを自動的に行える方法を探してみました。検索すると、<a href="https://www.postgresql.org/docs/current/sql-createview.html#id-1.9.3.97.6">一時ビュー</a>がすぐに出てきました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TEMPORARY</span> <span class="token keyword">VIEW</span> v_department_dbas <span class="token keyword">AS</span> # <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span>

db<span class="token operator">=</span># \COPY <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> v_department_dbas<span class="token punctuation">)</span> <span class="token keyword">TO</span> department_dbas<span class="token punctuation">.</span>csv <span class="token keyword">WITH</span> CSV HEADER<span class="token punctuation">;</span>
COPY <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>一時ビューは、セッションが終了すると自動的に削除されるため、これを使用することで作業後のクリーンアップを行う必要がなくなりました。
しばらく一時ビューを使用していましたが、<a href="https://www.postgresql.org/docs/current/app-psql.html#APP-PSQL-META-COMMANDS-COPY">psqlドキュメント</a>の中に素晴らしい発見がありました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># COPY <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> department<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> employees
    <span class="token keyword">FROM</span> emp
    <span class="token keyword">WHERE</span> role <span class="token operator">=</span> <span class="token string">'dba'</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> department
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> employees
<span class="token punctuation">)</span> <span class="token keyword">TO</span> STDOUT <span class="token keyword">WITH</span> CSV HEADER \g department_dbas<span class="token punctuation">.</span>csv
COPY <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>実に秀逸ではないでしょうか。細かく見ていきましょう。</p>
<ul>
<li><strong>\COPYの代わりにCOPYを使用する</strong>：COPYコマンドはサーバ上で実行されるサーバコマンドであり、\COPYは同じインターフェースを持つpsqlコマンドです。したがって、\COPYは複数行のクエリに対応していませんが、COPYは対応しています。</li>
<li><strong>STDOUTに結果を書き込む</strong>：クエリの結果は、COPYを使用してサーバ上のディレクトリに書き込むか、TO STDOUTを使用して標準出力に書き込むことができます。</li>
<li><strong>\gを使用してSTDOUTをローカルファイルに書き込む</strong>：最後に、psqlは出力を標準出力からファイルに書き込むためのコマンドを提供しています。</li>
</ul>
<p>これら3つの機能を組み合わせることで、求めていた通りの結果が得られました。</p>
<div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>コピーの達人</h5></div><div class="admonition-content"><p>大量のデータを動かす場合、<a href="https://hakibenita.com/fast-load-data-python-postgresql">Fastest Way to Load Data Into PostgreSQL Using Python</a>もチェックしてみてください。</p></div></div>
<hr>
<h2>自動生成キーの値の設定を防ぐ <a name="06"></a></h2>
<p>PostgreSQLで自動生成の主キーを使用している場合、おそらくまだ<a href="https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL">SERIALデータ型</a>を使用しているのではないでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sale <span class="token punctuation">(</span>
    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    sold_at TIMESTAMPTZ<span class="token punctuation">,</span>
    amount <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>裏では、PostgreSQLは行が追加された場合に使用するシーケンスを作成しています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sale<span class="token punctuation">;</span>
 id │           sold_at             │ amount
────┼───────────────────────────────┼────────
  <span class="token number">1</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">10</span>:<span class="token number">06</span>:<span class="token number">56.646298</span><span class="token operator">+</span><span class="token number">03</span> │   <span class="token number">1000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>SERIALデータ型はPostgreSQLに固有のものであり、いくつか既知の問題があります。したがって、バージョン10以降、SERIALデータ型はやんわり非推奨とされ、id列の使用が推奨されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sale <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> GENERATED <span class="token keyword">BY</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">AS</span> <span class="token keyword">IDENTITY</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    sold_at TIMESTAMPTZ<span class="token punctuation">,</span>
    amount <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>id列は、SERIALデータ型の仕組みと非常に似ています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sale<span class="token punctuation">;</span>
 id │           sold_at             │ amount
────┼───────────────────────────────┼────────
  <span class="token number">1</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">10</span>:<span class="token number">11</span>:<span class="token number">57.771121</span><span class="token operator">+</span><span class="token number">03</span> │   <span class="token number">1000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>では、次のシナリオを検討してみてください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR:  <span class="token keyword">duplicate</span> <span class="token keyword">key</span> <span class="token keyword">value</span> violates <span class="token keyword">unique</span> <span class="token keyword">constraint</span> <span class="token string">"sale_pkey"</span>
DETAIL:  <span class="token keyword">Key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> already <span class="token keyword">exists</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>なぜエラーになったのでしょうか？</p>
<ul>
<li>最初のINSERTコマンドは、id列の値2を明示的に指定しているため、シーケンスは使用されませんでした。</li>
<li>2つ目のINSERTコマンドはidの値を指定していないため、シーケンスが使用されます。このコマンドは、シーケンスの次の値が偶然2であったため、一意性制約違反によりエラーになりました。</li>
</ul>
<p>自動採番するIDを手動で設定する必要があることはまれであり、手動で設定すると混乱を招くおそれがあります。では、ユーザが設定を行わないようにするにはどうすればよいでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sale <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> GENERATED ALWAYS <span class="token keyword">AS</span> <span class="token keyword">IDENTITY</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    sold_at TIMESTAMPTZ<span class="token punctuation">,</span>
    amount <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>GENERATED BY DEFAULTの代わりにGENERATED ALWAYSを使用するのです。両者の違いを理解するために、再び同じシナリオを試してみましょう。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR:  cannot <span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">column</span> <span class="token string">"id"</span>
DETAIL:  <span class="token keyword">Column</span> <span class="token string">"id"</span> <span class="token operator">is</span> an <span class="token keyword">identity</span> <span class="token keyword">column</span> defined <span class="token keyword">as</span> GENERATED ALWAYS<span class="token punctuation">.</span>
HINT:  <span class="token keyword">Use</span> <span class="token keyword">OVERRIDING</span> SYSTEM <span class="token keyword">VALUE</span> <span class="token keyword">to</span> override<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>何が変わりましたか？</p>
<ul>
<li>最初のINSERTコマンドはidの値を指定せず、正常に完了します。
しかし、2つ目のINSERTコマンドはidに値2を設定しようとしてエラーになっています。</li>
<li>親切にも、PostgreSQLではid列に明示的に値を設定したい場合の解決策がエラーメッセージに記述されています。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>
<span class="token keyword">OVERRIDING</span> SYSTEM <span class="token keyword">VALUE</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>INSERTコマンドにOVERRIDING SYSTEM VALUEを追加することで、id列の値を設定可能にするようPostgreSQLに明示的に指示できます。それでも、一意性制約違反に対処する必要はあるかもしれませんが、それをPostgreSQLのせいにすることはもはやできません。</p>
<hr>
<h2>ピボットテーブルを作成するもう2つの方法 <a name="07"></a></h2>
<p>以前執筆した記事の中で、筆者は<a href="https://hakibenita.com/sql-for-data-analysis#pivot-tables">条件付き集計を使用してピボットテーブルを作成する方法</a>を説明しました。その記事を書いた後、PostgreSQLでピボットテーブルを生成する方法をさらに2つ発見しました。</p>
<p>各部門の職務ごとの従業員数を調べたいと思います。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">WITH</span> employees <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'Haki'</span><span class="token punctuation">,</span>    <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Manager'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Dan'</span><span class="token punctuation">,</span>     <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Developer'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Jax'</span><span class="token punctuation">,</span>     <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Developer'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'George'</span><span class="token punctuation">,</span>  <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Manager'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Bill'</span><span class="token punctuation">,</span>    <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Developer'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'David'</span><span class="token punctuation">,</span>   <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Developer'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
        <span class="token keyword">name</span><span class="token punctuation">,</span>       department<span class="token punctuation">,</span>  role
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> role<span class="token punctuation">,</span> department<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> employees
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> role<span class="token punctuation">,</span> department<span class="token punctuation">;</span>

   role    │ department │ count
───────────┼────────────┼───────
 Developer │ Sales      │     <span class="token number">2</span>
 Manager   │ Sales      │     <span class="token number">1</span>
 Manager   │ R<span class="token operator">&amp;</span>D        │     <span class="token number">1</span>
 Developer │ R<span class="token operator">&amp;</span>D        │     <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>同じ情報でも、ピボットテーブルを使用した方が見やすいでしょう。psqlでは、\crosstabviewコマンドを使用することで、前回のクエリの結果をピボットテーブルに変換できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \crosstabview

   role    │ Sales │ R<span class="token operator">&amp;</span>D
───────────┼───────┼─────
 Developer │     <span class="token number">2</span> │   <span class="token number">2</span>
 Manager   │     <span class="token number">1</span> │   <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この通り！</p>
<p>このコマンドは、デフォルトで最初の2つの列からピボットテーブルを作成しますが、これは引数を使用することで制御できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \crosstabview department role

 department │ Developer │ Manager
────────────┼───────────┼─────────
 Sales      │         <span class="token number">2</span> │       <span class="token number">1</span>
 R<span class="token operator">&amp;</span>D        │         <span class="token number">2</span> │       <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>利便性の面では若干劣りますが、あらかじめ組み込まれている<a href="https://www.postgresql.org/docs/current/tablefunc.html">tablefunc拡張機能</a>を使用してピボットテーブルを作成する方法もあります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> EXTENSION tablefunc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTENSION

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> crosstab<span class="token punctuation">(</span><span class="token string">'
    SELECT role, department, count(*) AS employees
    FROM employees
    GROUP BY 1, 2
    ORDER BY role
'</span><span class="token punctuation">,</span> <span class="token string">'
    SELECT DISTINCT department
    FROM employees
    ORDER BY 1
'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>role <span class="token keyword">text</span><span class="token punctuation">,</span> sales <span class="token keyword">int</span><span class="token punctuation">,</span> rnd <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   role    │ sales │ rnd
───────────┼───────┼─────
 Developer │     <span class="token number">2</span> │   <span class="token number">2</span>
 Manager   │     <span class="token number">1</span> │   <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://www.postgresql.org/docs/current/tablefunc.html#id-1.11.7.47.5.5">crosstab</a>関数を使用することで、ピボットテーブルを作成できます。この方法の欠点は、出力列をあらかじめ定義しておく必要があることです。しかし、crosstab関数が作成したテーブルをサブクエリとして使用し、さらなる処理を行えることは利点です。</p>
<hr>
<h2>ドル引用 <a name="08"></a></h2>
<p>データベースにテキストフィールド、特にパラグラフ全体を格納している場合、おそらくエスケープ文字についてはよくご存じでしょう。例えば、文字列リテラルにシングルクォート（'）を含める場合、もう1つシングルクォート（''）を使用して
エスケープする必要があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token string">'John''s Pizza'</span><span class="token punctuation">;</span>
   ?<span class="token keyword">column</span>?
──────────────
 John's Pizza</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>テキストの規模が大きくなり、バックスラッシュなどの文字や新しい行が含まれるようになると、エスケープ文字を追加するのがかなり面倒になってきます。この問題に対処するため、PostgreSQLでは文字列定数を記述する方法が他にも用意されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> $$a <span class="token keyword">long</span>
<span class="token keyword">string</span> <span class="token keyword">with</span> <span class="token keyword">new</span> <span class="token keyword">lines</span>
<span class="token operator">and</span> <span class="token string">'single quotes'</span>
<span class="token operator">and</span> <span class="token string">"double quotes

PostgreSQL doesn't mind ;)$$ AS text;
           text
───────────────────────────
 a long                   ↵
 string with new lines    ↵
 and 'single quotes'      ↵
 and "</span><span class="token keyword">double</span> quotes       ↵
                          ↵
 PostgreSQL doesn't mind <span class="token punctuation">;</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>文字列の始めと終わりにあるドル記号$$に注目してください。$$の間にある文字は文字列として扱われます。PostgreSQLでは、これを<a href="https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING">「ドル引用」</a>と呼んでいます。</p>
<p>これだけではありません。テキスト内で$$記号を使用する必要がある場合、タグを追加できるのですが、これが利便性を一層高めてくれるのです。以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> $JSON${
    <span class="token string">"name"</span>: <span class="token string">"John's Pizza"</span><span class="token punctuation">,</span>
    <span class="token string">"tagline"</span>: <span class="token string">"Best value for your $$"</span>
}$JSON$ <span class="token keyword">AS</span> json<span class="token punctuation">;</span>

                  json
─────────────────────────────────────────
 {                                      ↵
     <span class="token string">"name"</span>: <span class="token string">"John's Pizza"</span><span class="token punctuation">,</span>            ↵
     <span class="token string">"tagline"</span>: <span class="token string">"Best value for your $$"</span>↵
 }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このブロックでは、$JSON$というタグを付けているため、出力には「$$」記号全体が含まれています。</p>
<p>また、これを使用して特殊文字を含むjsonbオブジェクトを素早く生成することもできます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> $JSON${
    <span class="token string">"name"</span>: <span class="token string">"John's Pizza"</span><span class="token punctuation">,</span>
    <span class="token string">"tagline"</span>: <span class="token string">"Best value for your $$"</span>
}$JSON$::jsonb <span class="token keyword">AS</span> json<span class="token punctuation">;</span>
                          json
─────────────────────────────────────────────────────────────
 {<span class="token string">"name"</span>: <span class="token string">"John's Pizza"</span><span class="token punctuation">,</span> <span class="token string">"tagline"</span>: <span class="token string">"Best value for your $$"</span>}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>値はjsonbオブジェクトとなり、意のままに操作できます。</p>
<h2>データベースオブジェクトに関するコメント <a name="09"></a></h2>
<p>PostgreSQLには、<a href="https://www.postgresql.org/docs/current/sql-comment.html">ほぼすべてのデータベースオブジェクトについてコメントを追加できる</a>便利な機能があります。以下の例では、テーブルに関するコメントを追加しています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">TABLE</span> sale <span class="token operator">IS</span> <span class="token string">'Sales made in the system'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>このコメントは、psql（およびおそらく他のIDE）で表示できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \dt<span class="token operator">+</span> sale
                                  List <span class="token keyword">of</span> relations
 <span class="token keyword">Schema</span> │ <span class="token keyword">Name</span> │ <span class="token keyword">Type</span>  │ Owner │ Persistence │    <span class="token keyword">Size</span>    │       Description
────────┼──────┼───────┼───────┼─────────────┼────────────┼──────────────────────────
 <span class="token keyword">public</span> │ sale │ <span class="token keyword">table</span> │ haki  │ permanent   │ <span class="token number">8192</span> bytes │ Sales made <span class="token operator">in</span> <span class="token keyword">the</span> system</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>テーブルの列に関するコメントを追加し、拡張記述を使用する際に表示できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> sale<span class="token punctuation">.</span>sold_at <span class="token operator">IS</span> <span class="token string">'When was the sale finalized'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span>

db<span class="token operator">=</span># \d<span class="token operator">+</span> sale
  <span class="token keyword">Column</span>  │           <span class="token keyword">Type</span>           │         Description
──────────┼──────────────────────────┼─────────────────────────────
 id       │ <span class="token keyword">integer</span>                  │
 sold_at │ <span class="token keyword">timestamp</span> <span class="token keyword">with</span> <span class="token keyword">time</span> <span class="token keyword">zone</span> │ <span class="token keyword">When</span> was <span class="token keyword">the</span> sale finalized
 amount   │ <span class="token keyword">integer</span>                  │</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>また、COMMENTコマンドとドル引用を組み合わせて、関数などのより長く意義のある記述を含めることができます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">FUNCTION</span> generate_random_string <span class="token operator">IS</span> $docstring$
Generate a random <span class="token keyword">string</span> <span class="token keyword">at</span> a given <span class="token keyword">length</span> <span class="token keyword">from</span> a list <span class="token keyword">of</span> possible characters<span class="token punctuation">.</span>

<span class="token keyword">Parameters</span>:

    <span class="token operator">-</span> <span class="token keyword">length</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>: <span class="token keyword">length</span> <span class="token keyword">of</span> <span class="token keyword">the</span> output <span class="token keyword">string</span>
    <span class="token operator">-</span> characters <span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span>: possible characters <span class="token keyword">to</span> choose <span class="token keyword">from</span>

Example:

    db<span class="token operator">=</span># <span class="token keyword">SELECT</span> generate_random_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     generate_random_string
    ────────────────────────
     o0QsrMYRvp

    db<span class="token operator">=</span># <span class="token keyword">SELECT</span> generate_random_string<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'AB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     generate_random_string
    ────────────────────────
     ABB
$docstring$<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この関数は、筆者が過去に<a href="https://hakibenita.com/sql-medium-text-performance#toast-compression">中規模のテキストがパフォーマンスに与える影響</a>を実証するために使用したものです。コメントにdocstringを記述しているため、関数の使い方を思い出すために再び記事を見返す必要はもうありません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \df<span class="token operator">+</span> generate_random_string
List <span class="token keyword">of</span> functions
────────────┬────────────────────────────────────────────────────────────────────────────────
<span class="token keyword">Schema</span>      │ <span class="token keyword">public</span>
<span class="token keyword">Name</span>        │ generate_random_string
<span class="token comment">/* ... */</span>
Description │ Generate a random <span class="token keyword">string</span> <span class="token keyword">at</span> a given <span class="token keyword">length</span> <span class="token keyword">from</span> a list <span class="token keyword">of</span> possible characters<span class="token punctuation">.</span>↵
            │                                                                               ↵
            │ <span class="token keyword">Parameters</span>:                                                                   ↵
            │                                                                               ↵
            │     <span class="token operator">-</span> <span class="token keyword">length</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>: <span class="token keyword">length</span> <span class="token keyword">of</span> <span class="token keyword">the</span> output <span class="token keyword">string</span>                               ↵
            │     <span class="token operator">-</span> characters <span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span>: possible characters <span class="token keyword">to</span> choose <span class="token keyword">from</span>                   ↵
            │                                                                               ↵
            │ Example:                                                                      ↵
            │                                                                               ↵
            │     db<span class="token operator">=</span># <span class="token keyword">SELECT</span> generate_random_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                   ↵
            │      generate_random_string                                                   ↵
            │     ────────────────────────                                                  ↵
            │      o0QsrMYRvp                                                               ↵
            │                                                                               ↵
            │     db<span class="token operator">=</span># <span class="token keyword">SELECT</span> generate_random_string<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'AB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              ↵
            │      generate_random_string                                                   ↵
            │     ────────────────────────                                                  ↵
            │      ABB                                                                      ↵
            │</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<hr>
<h2>データベースごとに個別の履歴ファイルを維持する <a name="10"></a></h2>
<p>CLIツールを使用している場合、過去のコマンドを検索する機能をかなり頻繁に使用しているのではないでしょうか。bashとpsqlでは、<code class="language-text">CTRL + R</code>を押すことで通常逆引きが可能です。</p>
<p>ターミナルの他に複数のデータベースで作業する場合、データベースごとに個別の履歴ファイルを維持すると便利かもしれません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \<span class="token keyword">set</span> HISTFILE <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>psql_history<span class="token operator">-</span> :DBNAME</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>そうすることで、現在接続しているデータベースに関連するマッチを見つけやすくなります。このファイルは、<a href="https://www.postgresql.org/docs/current/app-psql.html#id-1.9.4.20.10">~/.psqlrc file</a>に置くことで永続化できます。</p>
<hr>
<h2>大文字の予約語の自動補完 <a name="11"></a></h2>
<p>SQLのキーワードを小文字で記述すべきか、それとも大文字で記述すべきかについては常に多くの議論（と冗談）の的になっています。このテーマに関する筆者の意見は明白です。</p>
<p>筆者のようにSQLで大文字のキーワードを使用するのを好む場合、大文字のキーワードを自動補完するオプションがpsqlに用意されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># selec <span class="token operator">&lt;</span>tab<span class="token operator">></span>
db<span class="token operator">=</span># <span class="token keyword">select</span>

db<span class="token operator">=</span># \<span class="token keyword">set</span> COMP_KEYWORD_CASE upper
db<span class="token operator">=</span># selec <span class="token operator">&lt;</span>tab<span class="token operator">></span>
db<span class="token operator">=</span># <span class="token keyword">SELECT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>COMP<em>KEYWORD</em>CASEをupperに設定すると、<strong>TAB</strong>キーを押すことでキーワードが大文字で自動補完されるようになります。</p>
<hr>
<h2>スリープ時間の指定 <a name="12"></a></h2>
<p>プログラムの実行を遅らせることは、テストやスロットリングなどにおいてかなり有益な場合があります。PostgreSQLでプログラムの実行を遅らせるには、通常pg_sleep関数を使用します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \timing
Timing <span class="token operator">is</span> <span class="token keyword">on</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> pg_sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pg_sleep
──────────

<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span>

<span class="token keyword">Time</span>: <span class="token number">3014.913</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">03.015</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この関数は、指定した秒数スリープします。しかし、長い時間スリープする必要がある場合、秒数の計算が煩わしくなることもあります。以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> pg_sleep<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>この関数がどれだけの時間スリープするか分かりますか？計算機を取り出す必要はありません。4分15秒です。
長い時間スリープする場合の利便性向上のため、PostgreSQLでは別の関数が用意されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> pg_sleep_for<span class="token punctuation">(</span><span class="token string">'4 minutes 15 seconds'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>姉妹関数のpg<em>sleepとは異なり、[pg</em>sleep_for](<a href="https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-DELAY">https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-DELAY</a>)関数は時間間隔（interval）での設定が可能であり、秒数よりもはるかに読みやすく、直感的に理解できます。</p>
<hr>
<h2>サブクエリを使用せず、グループの最初または最後の行を取得する <a name="13"></a></h2>
<p>筆者はこの機能をいつも使用しているため、最初にこのリストを作成したときは、これを「あまり知られていない機能」だとは考えていませんでした。しかし、意外にもこの問題に対して奇妙な解決策が提示されていることが多く、これからお見せする方法で簡単に解決できるため、リストに加えることにしました。
以下のような生徒テーブルがあるとします。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> students<span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height
────────┼───────┼────────
 Haki   │ A     │    <span class="token number">186</span>
 Dan    │ A     │    <span class="token number">175</span>
 Jax    │ A     │    <span class="token number">182</span>
 George │ B     │    <span class="token number">178</span>
 Bill   │ B     │    <span class="token number">167</span>
 David  │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<details>
<summary>⚙テーブルデータ</summary>
<p>このセクションのクエリーを再現するために、以下のCTEを使用することができます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> students <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'Haki'</span><span class="token punctuation">,</span>    <span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token number">186</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Dan'</span><span class="token punctuation">,</span>     <span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token number">175</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Jax'</span><span class="token punctuation">,</span>     <span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token number">182</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'George'</span><span class="token punctuation">,</span>  <span class="token string">'B'</span><span class="token punctuation">,</span>    <span class="token number">178</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Bill'</span><span class="token punctuation">,</span>    <span class="token string">'B'</span><span class="token punctuation">,</span>    <span class="token number">167</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'David'</span><span class="token punctuation">,</span>   <span class="token string">'B'</span><span class="token punctuation">,</span>    <span class="token number">178</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
        <span class="token keyword">name</span><span class="token punctuation">,</span>       class<span class="token punctuation">,</span>  height
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> students<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p><strong>各クラスで一番背の高い生徒の行全体を取得するにはどうすればよいでしょうか?</strong></p>
<p>最初に思いつく方法は次のようなものではないでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> class<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token keyword">as</span> tallest
<span class="token keyword">FROM</span> students
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> class<span class="token punctuation">;</span>

 class │ tallest
───────┼─────────
 A     │     <span class="token number">186</span>
 B     │     <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これだと身長は取得できますが、生徒の名前は得られません。次に、サブクエリを使用して、身長をもとに一番背の高い生徒を見つけようとするかもしれません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> students
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>class<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> class<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token keyword">as</span> tallest
    <span class="token keyword">FROM</span> students
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> class
<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height
────────┼───────┼────────
 Haki   │ A     │    <span class="token number">186</span>
 George │ B     │    <span class="token number">178</span>
 David  │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで、各クラスで一番背の高い生徒に関する情報がすべて揃いましたが、まだ別の問題があります。</p>
<div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>追記</h5></div><div class="admonition-content"><p>前のクエリ（(class, height) IN (...)）のようにレコードのセットをマッチングする機能もあまり知られていない、非常に強力なPostgreSQLの機能です。</p></div></div>
<p>クラス「B」には同じ身長の生徒が2人いますが、これがクラスで一番高い身長でもあります。集計関数MAXを使用すると身長しか得られないため、このような状況に直面する可能性があります。</p>
<p>MAXの使用が難しいのは、身長だけをもとに身長を選ばなくてはならないことであり、この場合は全く理にかなっているのですが、生徒を1人だけ選ぶ必要があります。2つ以上の列をもとに行を「ランク付け」できる別のアプローチとして、ウィンドウ関数を使用する方法があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span>
    students<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
    ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
        <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> class
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
<span class="token keyword">FROM</span>
    students<span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height │ rn
────────┼───────┼────────┼────
 Haki   │ A     │    <span class="token number">186</span> │  <span class="token number">1</span>
 Jax    │ A     │    <span class="token number">182</span> │  <span class="token number">2</span>
 Dan    │ A     │    <span class="token number">175</span> │  <span class="token number">3</span>
 David  │ B     │    <span class="token number">178</span> │  <span class="token number">1</span>
 George │ B     │    <span class="token number">178</span> │  <span class="token number">2</span>
 Bill   │ B     │    <span class="token number">167</span> │  <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>身長をもとに生徒を「ランク付け」するには、各行に行番号を振ることができます。行番号はクラスごとに決められ（PARTITION BY class）まず身長の高い順にランク付けされ、次に生徒の名前でランク付けされます（ORDER BY height DESC, name）。身長の他に生徒の名前も追加することで、決定性のある結果が得られます（同じ名前がないと仮定した場合）。</p>
<p>各クラスで一番背の高い生徒の行だけを取得するには、サブクエリを使用できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span>
    <span class="token keyword">name</span><span class="token punctuation">,</span> class<span class="token punctuation">,</span> height
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        students<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
        ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> class
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        students
<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">inner</span>
<span class="token keyword">WHERE</span>
    rn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

 <span class="token keyword">name</span>  │ class │ height
───────┼───────┼────────
 Haki  │ A     │    <span class="token number">186</span>
 David │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>できました！これが各クラスで一番背の高い生徒の行全体です。</p>
<p>DISTINCT ONを<strong>使用する</strong></p>
<p>かなり手間のかかる方法を見てきましたが、次はもっと簡単な方法を紹介したいと思います。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">ON</span> <span class="token punctuation">(</span>class<span class="token punctuation">)</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    students
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    class<span class="token punctuation">,</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token punctuation">;</span>

 <span class="token keyword">name</span>  │ class │ height
───────┼───────┼────────
 Haki  │ A     │    <span class="token number">186</span>
 David │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>いかがでしょうか？<a href="https://hakibenita.com/the-many-faces-of-distinct-in-postgre-sql#distinct-on">最初にDISTINCT ONを発見した</a>ときは、とても感動しました。Oracleから来たものですが、他に同じような機能はなく、筆者が知る限りでは、PostgreSQL以外のデータベースに同様の機能はありません。</p>
<p>DISTINCT ONを<strong>直感的に理解する</strong></p>
<p>DISTINCT ONの仕組みを理解するために、その挙動について順を追って見ていきましょう。以下がテーブル上の生データです。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> students<span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height
────────┼───────┼────────
 Haki   │ A     │    <span class="token number">186</span>
 Dan    │ A     │    <span class="token number">175</span>
 Jax    │ A     │    <span class="token number">182</span>
 George │ B     │    <span class="token number">178</span>
 Bill   │ B     │    <span class="token number">167</span>
 David  │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>次に、データを並べ替えます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> students
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> class<span class="token punctuation">,</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height
────────┼───────┼────────
 Haki   │ A     │    <span class="token number">186</span>
 Jax    │ A     │    <span class="token number">182</span>
 Dan    │ A     │    <span class="token number">175</span>
 David  │ B     │    <span class="token number">178</span>
 George │ B     │    <span class="token number">178</span>
 Bill   │ B     │    <span class="token number">167</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>DISTINCT ON句を追加します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">ON</span> <span class="token punctuation">(</span>class<span class="token punctuation">)</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> students
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> class<span class="token punctuation">,</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>DISTINCT ONがこの時点で何をするかを理解するには、2つのステップを経なくてはいけません。</p>
<p>まず、DISTINCT ON句の中の列（この場合はclass）をもとに、データをグループに分けます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">  <span class="token keyword">name</span>  │ class │ height
─────────────────────────
 Haki   │ A     │    <span class="token number">186</span>  ┓
 Jax    │ A     │    <span class="token number">182</span>  ┣━━ class<span class="token operator">=</span>A
 Dan    │ A     │    <span class="token number">175</span>  ┛

 David  │ B     │    <span class="token number">178</span>  ┓
 George │ B     │    <span class="token number">178</span>  ┣━━ class<span class="token operator">=</span>B
 Bill   │ B     │    <span class="token number">167</span>  ┛</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>次に、各グループの1行目だけを残します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"> <span class="token keyword">name</span>  │ class │ height
─────────────────────────
 Haki   │ A     │    <span class="token number">186</span>  ┣━━ class<span class="token operator">=</span>A
 David  │ B     │    <span class="token number">178</span>  ┣━━ class<span class="token operator">=</span>B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで終わりです。各クラスで一番背の高い生徒が得られました。</p>
<p>DISTINCT ONを使う上での唯一の要件は、ORDER BY句の先行列がDISTINCT ON句の列と一致することです。ORDER BY句の残りの列は、各グループのどの行を選択するかを判断するために使用します。</p>
<p>ORDER BYが結果にどう影響するかを理解するには、各クラスで一番背の低い生徒を特定する次のクエリを検討してください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">ON</span> <span class="token punctuation">(</span>class<span class="token punctuation">)</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    students
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    class<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token punctuation">;</span>

 <span class="token keyword">name</span> │ class │ height
──────┼───────┼────────
 Dan  │ A     │    <span class="token number">175</span>
 Bill │ B     │    <span class="token number">167</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>各クラスで一番背の低い生徒を選ぶには、各グループの1行目が一番背の低い生徒になるよう並び順を変えるだけでいいのです。</p>
<hr>
<h2>拡張機能なしでUUIDを生成する <a name="14"></a></h2>
<p>PostgreSQLのバージョン13より前では、おそらく<a href="https://www.postgresql.org/docs/current/uuid-ossp.html#id-1.11.7.53.5">拡張機能uuid-ossp</a>を使用してUUIDを生成していたのではないでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> EXTENSION <span class="token string">"uuid-ossp"</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTENSION

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> uuid_generate_v4<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> uuid<span class="token punctuation">;</span>
                 uuid
──────────────────────────────────────
 <span class="token number">8</span>e55146d<span class="token operator">-</span><span class="token number">0</span>ce5<span class="token operator">-</span><span class="token number">40</span>ab<span class="token operator">-</span>a346<span class="token operator">-</span><span class="token number">5</span>dbd466ff5f2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>バージョン13以降、<a href="https://www.postgresql.org/docs/current/functions-uuid.html">ランダムなUUID（バージョン4）を生成するための関数</a>が組み込まれています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> uuid<span class="token punctuation">;</span>
                 uuid
──────────────────────────────────────
 ba1ac0f5<span class="token operator">-</span><span class="token number">5</span>d4d<span class="token operator">-</span><span class="token number">4</span>d80<span class="token operator">-</span><span class="token number">974</span>d<span class="token operator">-</span><span class="token number">521</span>dbdcca2b2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>拡張機能uuid-osspは、バージョン4以外のUUIDを生成したい場合はまだ必要です。</p>
<hr>
<h2>再現可能なランダムデータの生成 <a name="15"></a></h2>
<p>ランダムデータの生成は、デモやテストなどさまざまな場面で非常に役立ちます。いずれの場合も、「ランダム」データを再現できると有用です。</p>
<p>PostgreSQLのrandom関数を使用することで、<a href="https://hakibenita.com/sql-for-data-analysis#random">さまざまなタイプのランダムデータを生成</a>できます。以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span>
    random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_float<span class="token punctuation">,</span>
    ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_int_0_10<span class="token punctuation">,</span>
    <span class="token string">'2022-01-01'</span>::<span class="token keyword">date</span> <span class="token operator">+</span> <span class="token keyword">interval</span> <span class="token string">'1 days'</span> <span class="token operator">*</span> ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_day_in_2022<span class="token punctuation">;</span>

─<span class="token punctuation">[</span> <span class="token keyword">RECORD</span> <span class="token number">1</span> <span class="token punctuation">]</span>──────┬────────────────────
random_float       │ <span class="token number">0.6031888056092001</span>
random_int_0_10    │ <span class="token number">3</span>
random_day_in_2022 │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このクエリを再度実行すると、異なる結果が得られます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span>
    random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_float<span class="token punctuation">,</span>
    ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_int_0_10<span class="token punctuation">,</span>
    <span class="token string">'2022-01-01'</span>::<span class="token keyword">date</span> <span class="token operator">+</span> <span class="token keyword">interval</span> <span class="token string">'1 days'</span> <span class="token operator">*</span> ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_day_in_2022<span class="token punctuation">;</span>

─<span class="token punctuation">[</span> <span class="token keyword">RECORD</span> <span class="token number">1</span> <span class="token punctuation">]</span>──────┬────────────────────
random_float       │ <span class="token number">0.7363406030115378</span>
random_int_0_10    │ <span class="token number">2</span>
random_day_in_2022 │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>再現可能なランダムデータを生成するには、<a href="https://www.postgresql.org/docs/current/functions-math.html#FUNCTIONS-MATH-RANDOM-TABLE">setseed</a>を使用できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> setseed<span class="token punctuation">(</span><span class="token number">0.4050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 setseed
─────────

<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span>
    random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_float<span class="token punctuation">,</span>
    ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_int_0_10<span class="token punctuation">,</span>
    <span class="token string">'2022-01-01'</span>::<span class="token keyword">date</span> <span class="token operator">+</span> <span class="token keyword">interval</span> <span class="token string">'1 days'</span> <span class="token operator">*</span> ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_day_in_2022
<span class="token keyword">FROM</span>
    generate_series<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    random_float    │ random_int_0_10 │ random_day_in_2022
────────────────────┼─────────────────┼─────────────────────
 <span class="token number">0.1924247516794324</span> │               <span class="token number">9</span> │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span>
 <span class="token number">0.9720620908236377</span> │               <span class="token number">5</span> │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>新しいセッションで再び同じブロックを実行すると、異なるデータベースであっても全く同じ結果が得られます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">otherdb<span class="token operator">=</span># <span class="token keyword">SELECT</span> setseed<span class="token punctuation">(</span><span class="token number">0.4050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 setseed
─────────

<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span>

otherdb<span class="token operator">=</span># <span class="token keyword">SELECT</span>
    random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_float<span class="token punctuation">,</span>
    ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_int_0_10<span class="token punctuation">,</span>
    <span class="token string">'2022-01-01'</span>::<span class="token keyword">date</span> <span class="token operator">+</span> <span class="token keyword">interval</span> <span class="token string">'1 days'</span> <span class="token operator">*</span> ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_day_in_2022
<span class="token keyword">FROM</span>
    generate_series<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    random_float    │ random_int_0_10 │ random_day_in_2022
────────────────────┼─────────────────┼─────────────────────
 <span class="token number">0.1924247516794324</span> │               <span class="token number">9</span> │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span>
 <span class="token number">0.9720620908236377</span> │               <span class="token number">5</span> │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>結果はランダムであるものの、全く同じであることに注目してください。次にデモを行ったり、スクリプトを共有したりする場合、結果を簡単に再現できるようsetseedを使用してみてください。</p>
<hr>
<h2>直ちに検証することなく制約を追加する <a name="16"></a></h2>
<p>制約はRDBMSに不可欠な要素です。制約はデータをクリーンで信頼できる状態に保つため、なるべく使用することが望まれます。本番稼働中のシステムでは、新たな制約を追加しなくてはならないことがしばしばありますが、制約の種類によっては、システムの動作を妨げる非常に制限の厳しいロックが必要になることもあります。</p>
<p>例として、大規模なテーブルに単純なチェック制約を追加してみてください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> orders <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> check_price_gt_zero <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>price <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span>
<span class="token keyword">Time</span>: <span class="token number">10745.662</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">10.746</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>この文は、注文の価格が0以上になるようチェック制約を追加します。制約を追加する際、データベースがテーブル全体をスキャンし、制約が既存のすべての行に対して有効であることを確認しました。このプロセスには約10秒かかり、その間テーブルはロックされました。</p>
<p><strong>PostgreSQLでは、制約を追加するプロセスを2つのステップに分けることができます。</strong></p>
<p>まず、制約を追加して新しいデータのみを検証し、既存のデータについては有効かどうかをチェックしません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> orders <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> check_price_gt_zero <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>price <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> VALID<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span>
<span class="token keyword">Time</span>: <span class="token number">13.590</span> ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>最後のNOT VALIDは、既存の行について新しい制約の検証を行わないようPostgreSQLに指示するものです。これは、データベースがテーブル全体をスキャンする必要がないことを意味します。この文が前の文に比べて所要時間が大幅に短く、ほぼ瞬時に処理されたことに注目してください。</p>
<p>次に、既存のデータについて、はるかに制限が緩く、テーブル上の他の演算を許容するロックを使用し、制約を検証します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> orders <span class="token keyword">VALIDATE</span> <span class="token keyword">CONSTRAINT</span> check_price_gt_zero<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span>
<span class="token keyword">Time</span>: <span class="token number">11231.189</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">11.231</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>制約の検証に要した時間が、制約の追加と検証を行った最初の例とおおむね同じであることにお気づきでしょうか。これは、既存のテーブルに制約を追加する際、ほとんどの時間が既存の行の検証に費やされていることを再確認させるものです。プロセスを2つのステップに分けることで、テーブルがロックされている時間を短縮できます。</p>
<p>ドキュメントは、<a href="https://www.postgresql.org/docs/current/sql-altertable.html#SQL-ALTERTABLE-NOTES">NOT VALIDの別のユースケース</a>についても言及しています。それは、たとえ好ましくない値があったとしても、将来のアップデートに対してのみ制約を適用するというものです。つまり、NOT VALIDを追加し、VALIDATEは行わないということです。</p>
<p>Paypalのエンジニアリングチームが<a href="https://medium.com/paypal-tech/postgresql-at-scale-database-schema-changes-without-downtime-20d3749ed680">ダウンタイムなしでスキーマに変更を加える</a>方法について素晴らしい記事を執筆しています。<a href="https://hakibenita.com/sql-tricks-application-dba#disable-constraints-and-indexes-during-bulk-loads">バルクロードを行う際に制約とインデックスを無効化する</a>ことを提案した筆者の記事も併せてご覧ください。</p>
<hr>
<h2>PostgreSQLにおけるシノニム <a name="17"></a></h2>
<p>シノニム（同義語）は、オブジェクトを別の名前で参照する手段を提供するもので、Linuxのシンボリックリンクと似ています。Oracleの使用経験がある方はシノニムになじみがあるかと思われますが、そうでなければ聞いたことがないかもしれません。PostgreSQLには「シノニム」という名前の機能はありませんが、同様のことができないわけではありません。</p>
<p>特定の名前に別のデータベースオブジェクトを参照させるには、まず、PostgreSQLが条件を持たない名前をどのように解決するのか理解する必要があります。例えば、ユーザhakiとしてデータベースに接続し、テーブルfooを参照した場合、PostgreSQLは以下のオブジェクトを、以下の順序で検索します。</p>
<ol>
<li>haki.foo</li>
<li>public.foo</li>
</ol>
<p>この順序は<a href="https://www.postgresql.org/docs/current/ddl-schemas.html#DDL-SCHEMAS-PATH">search_pathパラメータ</a>によって決まります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SHOW</span> search_path<span class="token punctuation">;</span>
   search_path
─────────────────
 <span class="token string">"$user"</span><span class="token punctuation">,</span> <span class="token keyword">public</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>最初の値"$user"は特殊な値であり、現在接続しているユーザの名前に解決されます。2つ目の値publicはデフォルトスキーマの名前です。</p>
<p>サーチパスに関してできることを実証するため、データベースdbにテーブルfooを作成してみてください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> foo <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">TEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> foo <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> foo<span class="token punctuation">;</span>
 <span class="token keyword">value</span>
───────
 A
<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>何らかの理由により、ユーザhakiがfooという名前を参照した際に異なるオブジェクトを表示させたい場合、2つの選択肢があります。</p>
<p><strong>1. hakiという名前のスキーマにfooという名前のオブジェクトを作成する。</strong></p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span> haki<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span>

db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> haki<span class="token punctuation">.</span>foo <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> haki<span class="token punctuation">.</span>foo <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># \conninfo
You are connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"haki"</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> foo<span class="token punctuation">;</span>
<span class="token keyword">value</span>
───────
B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ユーザhakiがfooという名前を参照すると、PostgreSQLがpublic.fooではなくhaki.fooに名前を解決することに注目してください。これは、サーチパス上でスキーマhakiがpublicよりも前に来るためです。</p>
<p><strong>2.サーチパスのアップデート。</strong></p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span> synonyms<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span>

db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> synonyms<span class="token punctuation">.</span>foo <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> synonyms<span class="token punctuation">.</span>foo <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">SHOW</span> search_path<span class="token punctuation">;</span>
   search_path
─────────────────
 <span class="token string">"$user"</span><span class="token punctuation">,</span> <span class="token keyword">public</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> foo<span class="token punctuation">;</span>
 <span class="token keyword">value</span>
───────
 A

db<span class="token operator">=</span># <span class="token keyword">SET</span> search_path <span class="token keyword">TO</span> synonyms<span class="token punctuation">,</span> <span class="token string">"$user"</span><span class="token punctuation">,</span> <span class="token keyword">public</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> foo<span class="token punctuation">;</span>
 <span class="token keyword">value</span>
───────
 C</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>サーチパスにスキーマsynonymsが含まれるよう変更を加えると、PostgreSQLがfooという名前をsynonyms.fooに解決するようになります。</p>
<p><strong>シノニムはなぜ有用か？</strong></p>
<p>筆者は以前、シノニムは避けるべきコードの臭いだと考えていましたが、その後シノニムが有用なユースケースをいくつか発見しました。その1つは、ゼロダウンタイムの移行です。</p>
<p>本番稼働中のシステムのテーブルに変更を加える際、アプリケーションの新旧バージョン両方を同時にサポートしなくてはならないことが多々あります。これは、アプリケーションの各バージョンが想定するテーブル構造が異なるため、困難を伴います。</p>
<p>テーブルから特定の列を削除する移行を例に検討してみましょう。移行が実行されている間、アプリケーションの古いバージョンは稼働しており、テーブルにその列があることを想定しているため、単純に削除することはできません。この問題に対処する1つの方法として、新しいバージョンを2段階に分けてリリースできます。1つ目のリリースではその列を無視し、2つ目のリリースで削除するのです。</p>
<p>ただし、1回のリリースで変更を行う必要がある場合、その列を含むテーブルのビューを古いバージョンに提供してから削除できます。これには「シノニム」を使用できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \conninfo
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"app"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
 username │ active
──────────┼────────
 haki     │ t</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>アプリケーションは、ユーザappとしてデータベースdbに接続しています。active列を削除したいのですが、アプリケーションがこの列を使用しています。移行を無事完了するためには、古いバージョンが稼働している間、その列がまだそこにあるとユーザappに思わせる必要があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \conninfo
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"admin"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span> app<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span>

db<span class="token operator">=</span># <span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span> <span class="token keyword">ON</span> <span class="token keyword">SCHEMA</span> app <span class="token keyword">TO</span> app<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span>

db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> app<span class="token punctuation">.</span>users <span class="token keyword">AS</span> <span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token keyword">AS</span> active <span class="token keyword">FROM</span> <span class="token keyword">public</span><span class="token punctuation">.</span>users<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span>

db<span class="token operator">=</span># <span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> app<span class="token punctuation">.</span>users <span class="token keyword">TO</span> app<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ユーザappを「騙す」ために、ユーザの名前を用いたスキーマと、計算済みフィールドactiveを持つビューを作成しました。アプリケーションがユーザappとして接続しているとき、テーブルではなくそのビューが見えるため、列を削除しても問題ありません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \conninfo
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"admin"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> users <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> active<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># \<span class="token keyword">connect</span> db app
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"app"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
 username │ active
──────────┼────────
 haki     │ t</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>列を削除すると、アプリケーションは代わりに計算済みフィールドを参照します。後は少しクリーンアップを行って終了です。</p>
<hr>
<h2>重複レンジを探す <a name="18"></a></h2>
<p>以下のような会議テーブルがあるとします。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> meetings<span class="token punctuation">;</span>
       starts_at     │        ends_at
─────────────────────┼─────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">00</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">30</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">30</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">45</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<details>
<summary>⚙テーブルデータ</summary>
<p>以下のCTEを使用して、このセクションのクエリーを再現することができます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        starts_at::timestamptz <span class="token keyword">AS</span> starts_at<span class="token punctuation">,</span>
        ends_at::timestamptz <span class="token keyword">AS</span> ends_at
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'2021-10-01 10:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 10:30 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'2021-10-01 12:30 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:45 UTC'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
        starts_at<span class="token punctuation">,</span>               ends_at<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> meetings<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>新しい会議の予定を入れたいのですが、その前に、他の会議と重ならないことを確認する必要があります。いくつか検討すべきシナリオがあります。</p>
<ul>
<li>[A] 新しい会議は既存の会議が開始した後終了する。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token operator">|</span><span class="token comment">-------NEW MEETING--------|</span>
    <span class="token operator">|</span><span class="token comment">--------*EXISTING MEETING--------*|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[B] 新しい会議は既存の会議が終わる前に開始する。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">        <span class="token operator">|</span><span class="token comment">-------NEW MEETING--------|</span>
<span class="token operator">|</span><span class="token comment">--------*EXISTING MEETING--------*|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[C] 新しい会議は既存の会議が実施されている間に行われる。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">   <span class="token operator">|</span><span class="token comment">----NEW MEETING----|</span>
<span class="token operator">|</span><span class="token comment">--------*EXISTING MEETING--------*|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[D] 既存の会議は新しい会議が予定されている時間内に行われる。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token operator">|</span><span class="token comment">--------NEW MEETING--------|</span>
    <span class="token operator">|</span><span class="token operator">*</span><span class="token operator">*</span>EXISTING MEETING<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[E] 新しい会議は既存の会議と全く同じ時間に予定されている。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token operator">|</span><span class="token comment">--------NEW MEETING--------|</span>
<span class="token operator">|</span><span class="token comment">----**EXISTING MEETING--------|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>重複の有無をチェックするクエリをテストするため、上記のシナリオがすべて含まれるテーブルを作成し、以下の簡単な条件式を試してみてください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        id<span class="token punctuation">,</span>
        starts_at::timestamptz <span class="token keyword">as</span> starts_at<span class="token punctuation">,</span>
        ends_at::timestamptz <span class="token keyword">as</span> ends_at
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> t<span class="token punctuation">(</span>
        id<span class="token punctuation">,</span>   starts_at<span class="token punctuation">,</span>               ends_at
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">;</span>

       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>最初の試みでは、5 つのシナリオのうち 4 つのシナリオで重複を発見しました
。シナリオDでは、新しい会議が既存の会議の前に始まり、後に終わる場合、重複を検出しませんでした。このシナリオも処理するためには、条件をもう少し長くする必要があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> new_meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">;</span>


       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ D  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このクエリは5つすべてのシナリオで重複を検出しますが、以下の追加シナリオを検討してください。</p>
<ul>
<li>[F] 新しい会議は既存の会議の直後に予定されている。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">                            <span class="token operator">|</span><span class="token comment">--------NEW MEETING--------|</span>
<span class="token operator">|</span><span class="token comment">----**EXISTING MEETING--------|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[G] 新しい会議は既存の会議の開始直後に終了する予定になっている。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token operator">|</span><span class="token comment">--------NEW MEETING--------|</span>
                            <span class="token operator">|</span><span class="token comment">----**EXISTING MEETING--------|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>会議が連続するのはよくあることですが、これらについては重複と認識されるべきではありません。2つのシナリオをテストに追加し、クエリを実行してみます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        id<span class="token punctuation">,</span>
        starts_at::timestamptz <span class="token keyword">as</span> starts_at<span class="token punctuation">,</span>
        ends_at::timestamptz <span class="token keyword">as</span> ends_at
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:10 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> t<span class="token punctuation">(</span>
        id<span class="token punctuation">,</span>   starts_at<span class="token punctuation">,</span>               ends_at
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> new_meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">;</span>

       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ D  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ F  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">10</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ G  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">00</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>2つの会議が連続するシナリオFとGは、誤って重複に分類されています。これは、<a href="https://hakibenita.com/sql-dos-and-donts#use-between-only-for-inclusive-ranges">演算子BETWEENがその前後を含む</a>ためです。BETWEENを使用せずにこの条件式を実行するには、以下のようにする必要があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    <span class="token punctuation">(</span>new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">></span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">&lt;</span> meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
    <span class="token operator">OR</span>
    <span class="token punctuation">(</span>new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">></span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">&lt;</span> meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
    <span class="token operator">OR</span>
    <span class="token punctuation">(</span>meetings<span class="token punctuation">.</span>starts_at <span class="token operator">></span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">&lt;</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
    <span class="token operator">OR</span>
    <span class="token punctuation">(</span>meetings<span class="token punctuation">.</span>ends_at <span class="token operator">></span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> meetings<span class="token punctuation">.</span>ends_at <span class="token operator">&lt;</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
    <span class="token operator">OR</span>
    <span class="token punctuation">(</span>meetings<span class="token punctuation">.</span>starts_at <span class="token operator">=</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> meetings<span class="token punctuation">.</span>ends_at <span class="token operator">=</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ D  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>クエリはシナリオA～Eを重複として正しく認識し、会議が連続するシナリオFとGは重複とは認識しません。求めていた結果はこれです。しかし、この条件式はあまりにも複雑です。容易に手に負えなくなってしまうでしょう。</p>
<p>そこで、PostgreSQLの以下の演算子が極めて有益となります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        id<span class="token punctuation">,</span>
        starts_at::timestamptz <span class="token keyword">as</span> starts_at<span class="token punctuation">,</span>
        ends_at::timestamptz <span class="token keyword">as</span> ends_at
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:10 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> t<span class="token punctuation">(</span>
        id<span class="token punctuation">,</span>   starts_at<span class="token punctuation">,</span>               ends_at
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    <span class="token punctuation">(</span>new_meetings<span class="token punctuation">.</span>starts_at<span class="token punctuation">,</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
        <span class="token keyword">OVERLAPS</span> <span class="token punctuation">(</span>meetings<span class="token punctuation">.</span>starts_at<span class="token punctuation">,</span> meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ D  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これです！<a href="https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-TABLE">OVERLAPS演算子</a>を使用することで、5つの複雑な条件式が不要になり、クエリは短く単純で、読みやすく、分かりやすくなりました。</p>
<hr>
<p><em>改訂履歴</em></p>
<ul>
<li>2021年11月9日：<a href="https://www.reddit.com/r/programming/comments/qpj4cy/comment/hjwwqgi/?utm_source=share&#x26;utm_medium=web2x&#x26;context=3">Redditのコメント投稿者</a>が、「大文字の予約語の自動補完」のセクションでpsqlパラメータの名前の誤りを見つけてくれました。COMP<em>KEYWORD</em>UPPERをCOMP<em>KEYWORD</em>CASEに修正しました。</li>
<li>2021年11月9日：pg<em>sleepの例は、記事の中で以前述べていたように4分ではなく4時間（14400秒）のスリープでした。pg</em>sleep_forによる時間間隔を用いるメリットをより明確に伝えるため、例に変更を加えました。</li>
</ul>]]></content:encoded></item><item><title><![CDATA[Web開発者の悩みの種ランキング（2021年版）]]></title><description><![CDATA[私は先日、開発者が何を最も大きな課題に挙げているかを知ることで、開発者コミュニティのニーズを理解できるという記事を書きました。 元々の投稿はMDN Developer Needs Assessmen…]]></description><link>https://postd.cc/top-web-developer-pain-points-in-2021/</link><guid isPermaLink="false">https://postd.cc/top-web-developer-pain-points-in-2021/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[まとめ]]></category><category><![CDATA[Web開発]]></category><pubDate>Tue, 15 Mar 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>私は先日、開発者が何を<a href="https://paul.kinlan.me/thinking-about-developer-satisfaction-and-web-developers/">最も大きな課題</a>に挙げているかを知ることで、開発者コミュニティのニーズを理解できるという記事を書きました。</p>
<p>元々の投稿は<a href="https://insights.developer.mozilla.org/">MDN Developer Needs Assessment</a>（2019年）の結果を要約したものでしたが、不運なことに、この調査は2020年に中止されました。この調査情報は、Webプラットフォーム全体の方向性を定めるのに役立つ点で、私たちのチームにとって重要だったため、調査の中止は残念なことです。</p>
<p>調査を実施していたMozillaの代わりとして、私はチームのために、開発者の大まかなニーズを把握する調査を企画しました。</p>
<p>3カ月ごとに、米国、英国、インドのWeb開発者やWeb開発における意思決定者約700人をランダムにサンプリングして実施し、過去に実施したすべての調査とデータを比較して、トレンドに変化があるかを見ていきます。</p>
<p>注意すべきなのは、MDN Surveyと私たちの調査は違うということです。両者調査の回答者は異なっており、質問内容も（可能な限り似せようとしましたが）微妙に違います。回答者の人数も違うため、Max-Diff法を使用せずに、問題だと思っていること上位3つを選択する形式です。そのため、回答の優先順位をどのように付けるべきかという疑問が生じますが、結果を詳しく見てみると、結論に大差はありません。</p>
<p>2020年の調査では、開発者がフラストレーションを感じる主な点として、以下が挙げられました。</p>
<blockquote>
<ol>
<li>ブラウザの互換性 – <a href="https://paul.kinlan.me/the-lumpy-web/">Webは「でこぼこ」している、</a>もっと滑らかであるべきだ。Chromeは幅広いWebプラットフォームとの互換性を確保し続けるべき。Chromeはすべてのブラウザベンダーと協力して互換性を支援すべき。ChromeはWebブラウザがChromeのみにならないように手助けすべき。</li>
<li>テスト – すべてのブラウザでサイトのエンドツーエンドテストを簡単に実施できるようにすべきだ。現在はテストを実施するのが難しすぎる。</li>
<li>ドキュメント – 最適かつ最新の参照資料や、筆者の意見が記された検証済みのベストプラクティスガイダンスを、開発者が簡単に見つけられるようにすべきだ。</li>
<li>デバッグ – 開発者はデバッグを失敗と捉えている。直面している問題について、開発者が理解し、可能な限り速やかに解決できるように、あらゆるツールを利用できるようにすべきだ。</li>
<li>フレームワーク - 非常に多くの開発者がフレームワークを利用している事実から逃れることはできない。ブラウザベンダーとフレームワーク作者との強固な関係を確実に維持するには、また、開発者がこうしたツールの効果的な利用ノウハウを維持していくには、どうすればよいか？</li>
<li>プライバシーとセキュリティ – 有効競争によって生じるエコシステムの変化のみならず、非常に多くの法令が開発スピードを遅らせる要因となっている。こうした変化は開発者を悩ませ、私たちは人々の助けとなるガイダンスとツールを必要としている。</li>
</ol>
</blockquote>
<p>それでは、2021年はどうでしょうか？</p>
<p>（ドラムロール）</p>
<p>結果はほとんど変わりませんでした。測定方法が変わったため、一定の変化はありましたが、全体的な方向性は同じです。</p>
<p>トップ5は以下の通りです（パーセンテージは、その問題を上位3つに入れた開発者の割合を表します）。</p>
<table>
<thead>
<tr>
<th>課題</th>
<th>第1四半期</th>
<th>第2四半期</th>
<th>第3四半期</th>
</tr>
</thead>
<tbody>
<tr>
<td>WebプラットフォームやWeb標準の変化についていく</td>
<td>27%</td>
<td>26%</td>
<td>27%</td>
</tr>
<tr>
<td>大量の新しい（および既存の）ツールやフレームワークについていく</td>
<td>26%</td>
<td>26%</td>
<td>25%</td>
</tr>
<tr>
<td>異なるブラウザでもデザインやユーザー体験が同一になるようにする</td>
<td>26%</td>
<td>28%</td>
<td>24%</td>
</tr>
<tr>
<td>複数のブラウザでテストを行う</td>
<td>23%</td>
<td>24%</td>
<td>20%</td>
</tr>
<tr>
<td>セキュリティ対策を理解し、実装する</td>
<td>23%</td>
<td>25%</td>
<td>20%</td>
</tr>
</tbody>
</table>
<p>各四半期の結果はほとんど同じです。</p>
<p>私にとって、このデータは、具体的に何を修正すべきかを教えてはくれませんが、どの分野の調査を深めればよいか分かる点で価値があります。</p>
<p>例えば、私は昨年、このデータの解釈として、「開発者にとって、プラットフォームレベルでも、ツールのエコシステムという点でも、変化やツールの数が多すぎる（両者は常に問題の上位に入っている）。この問題に対処する必要がある」と考えました。</p>
<p>上記のデータからは、開発者が利用するツールが、複数のブラウザにおけるテストや、ブラウザをまたぐ均一なユーザー体験を実現するには不十分であることも分かります。<a href="https://web.dev/compat2021/">Compat 2021</a>は、こうしたデータに基づいて私たちが構築したプログラムの1つであり、開発者はその成果に気づき始めていると言えるでしょう。しかし、このようなブラウザ間の互換性向上に関する取り組みが、開発者にとって有意義な変化をもたらしたかどうかを判断するには、まだ時期尚早であると考えられます。</p>
<h2>追記</h2>
<p>「Webサイトやアプリを開発するときに直面する最も大きな課題は何ですか？（3つ選択してください）」という質問に対する回答の結果全体。</p>
<table>
<thead>
<tr>
<th>課題</th>
<th>第1四半期 n=698</th>
<th>第2四半期 n=760</th>
<th>第3四半期 n=738</th>
</tr>
</thead>
<tbody>
<tr>
<td>WebプラットフォームやWeb標準の変化についていく</td>
<td>27%</td>
<td>26%</td>
<td>27%</td>
</tr>
<tr>
<td>大量の新しい（および既存の）ツールやフレームワークについていく</td>
<td>26%</td>
<td>26%</td>
<td>25%</td>
</tr>
<tr>
<td>異なるブラウザでもデザインやユーザー体験が同一になるようにする</td>
<td>26%</td>
<td>28%</td>
<td>24%</td>
</tr>
<tr>
<td>複数のブラウザでテストを行う</td>
<td>23%</td>
<td>24%</td>
<td>20%</td>
</tr>
<tr>
<td>セキュリティ対策を理解し、実装する</td>
<td>23%</td>
<td>25%</td>
<td>20%</td>
</tr>
<tr>
<td>よく実施する小さなタスクが自動化されていない</td>
<td>15%</td>
<td>17%</td>
<td>18%</td>
</tr>
<tr>
<td>能力が不足しているため、望ましいユーザー体験を生み出すことができない</td>
<td>15%</td>
<td>13%</td>
<td>18%</td>
</tr>
<tr>
<td>最新のWebテクノロジーを活用するための知識が不足している</td>
<td>16%</td>
<td>16%</td>
<td>17%</td>
</tr>
<tr>
<td>既存のツールやフレームワークの使用法を理解する</td>
<td>16%</td>
<td>14%</td>
<td>17%</td>
</tr>
<tr>
<td>望ましいパフォーマンスを達成するのが困難/不可能</td>
<td>11%</td>
<td>12%</td>
<td>17%</td>
</tr>
<tr>
<td>組織内においてWebへの取り組みを優先させる</td>
<td>15%</td>
<td>16%</td>
<td>16%</td>
</tr>
<tr>
<td>古いブラウザをサポートする</td>
<td>21%</td>
<td>23%</td>
<td>16%</td>
</tr>
<tr>
<td>参照資料やドキュメントが不足している</td>
<td>14%</td>
<td>13%</td>
<td>15%</td>
</tr>
<tr>
<td>開発者向けのツールが不足している/乏しい</td>
<td>11%</td>
<td>14%</td>
<td>15%</td>
</tr>
<tr>
<td>望ましいUIを実現するのが困難/不可能</td>
<td>14%</td>
<td>13%</td>
<td>15%</td>
</tr>
<tr>
<td>上記のいずれでもない上記のいずれでもない</td>
<td>3%</td>
<td>1%</td>
<td>1%</td>
</tr>
</tbody>
</table>
<ul>
<li>「古いブラウザをサポートする」が大幅に低下しているのは興味深い点です。</li>
</ul>
<h3>筆者について：Paul Kinlan</h3>
<p>GoogleのChrome Developer Relationsチームでリーダーを務めています。
私たちは、ユーザーがネイティブアプリをインストールしたり、クローズドプラットフォームの中でコンテンツを制作したりしなくても、Web上で可能な限り最高の体験を享受できるようにしたいと考えています。</p>
<p>私たちのチームが目指すのは、開発者がWeb上での開発を進めやすくすることです。そのために、すべてのChromeのリリースをサポートし、<a href="https://web.dev/">web.dev</a>上で開発者を支援するための優れたコンテンツを生み出し、MDNに貢献しているほか、ブラウザの互換性や、特に優れた開発者向けツール（ほんの数例を挙げるとLighthouse、Workbox、Squooshなど）の改善を支援しています。</p>]]></content:encoded></item><item><title><![CDATA[Core Web VitalsはWebを高速化したか？]]></title><description><![CDATA[Core Web Vitals（CWV）は2020年5月に発表されました。Googleはこの発表の中で、「より良いWebのためにページエクスペリエンスを評価する」と述べています。特に重要なのは、この…]]></description><link>https://postd.cc/have-core-web-vitals-made-the-web-faster/</link><guid isPermaLink="false">https://postd.cc/have-core-web-vitals-made-the-web-faster/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[CWV]]></category><pubDate>Mon, 14 Feb 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<style>
  .image-text {
    margin-left: 1rem;
    margin-right: 1rem;
  }
  .image-text, .image-text ul li {
    font-size: 0.6rem;
  }
</style>
<p><a href="https://web.dev/vitals/">Core Web Vitals（CWV）</a>は2020年5月に発表されました。Googleはこの発表の中で、「<a href="https://developers.google.com/search/blog/2020/05/evaluating-page-experience">より良いWebのためにページエクスペリエンスを評価する</a>」と述べています。特に重要なのは、この評価がGoogleの検索順位アルゴリズムの一部を構成することでした。つまり、高速なWebサイトは、同等の遅いWebサイトよりも順位が上になり、Google検索によるトラフィック（ほとんどのWebサイトにとってWebトラフィックの最も大きな部分を占める）が増えます。</p>
<p>Webパフォーマンスコミュニティは、Webパフォーマンスのビジネス上のメリットを売り込むことに関して、常にSEO業界に劣っていました。Webパフォーマンスがビジネスのパフォーマンスに<a href="https://wpostats.com/">直接影響を及ぼす証拠</a>が数多く存在するにもかかわらずです。しかし、今やSEO業界全体がWebパフォーマンスを重視するようになり、企業もWebパフォーマンスについて真剣に考えなければならなくなったのです。</p>
<p>Googleは2020年11月に次の発表を行い、<a href="https://developers.google.com/search/blog/2020/11/timing-for-page-experience">2021年5月までにWebサイトをCore Web Vitalsに対応させる必要があるという明確な期限を定めました</a>（モバイルサイトの場合。<a href="https://developers.google.com/search/blog/2021/11/bringing-page-experience-to-desktop">デスクトップ向けサイトは1年後の予定</a>）。</p>
<p>そうして、Core Web Vitalsが検索順位に影響を与えるようになってから約半年が経ちました。実際に、何らかの影響はあったのでしょうか？GoogleがSEOという大きな力を振るったことで、Webは高速化したのでしょうか？</p>
<p>確かに影響はあったと示唆するサクセスストーリーは数多く存在します。しかし、筆者は「クリスマス嫌いのグリンチ」（※訳注：米国の童話の登場人物）のようにひねくれ者なので、あまり納得できずにいます。</p>
<h2>Core Web Vitalsに肯定的な証拠</h2>
<p>筆者は<a href="https://httparchive.org/">HTTP Archive</a>のメンテナンスに関わっています。このプロジェクトはWebの状態のトラッキングを目指すものです。HTTP Archiveは毎月Webのクローリングを実行し、発見したさまざまな事実や数値を報告することでトラッキングを行っています。このプロジェクトでは主に3つの方法でデータを提供しています。</p>
<ol>
<li>すべての基礎データを<a href="https://github.com/HTTPArchive/httparchive.org/blob/main/docs/gettingstarted_bigquery.md">BigQueryのデータセットとして公開しています</a>。SQLに関する多少の知識があればクエリを実行できます。</li>
<li><a href="https://httparchive.org/reports">Webサイト上でレポートとしてさまざまな統計を提供しています</a>。</li>
<li><a href="https://calendar.perfplanet.com/2021/have-core-web-vitals-made-the-web-faster/#:~:text=report%20called%20the-,Web%20Almanac,-which%20is%20a">Web Almanac</a>というレポートを毎年公開しています。このレポートは、業界の専門家がデータを詳細に分析し、そこから読み取れることを報告するものです（<a href="https://almanac.httparchive.org/en/2021/">2021年版</a>は最近発表されたばかりです。ぜひご覧ください）。</li>
</ol>
<p>また、HTTP Archiveは<a href="https://developers.google.com/web/tools/chrome-user-experience-report">Chrome User Experience Report（CrUX）</a>データセットとも連携し、より多くのデータについて報告するためにCrUXを活用しています。CrUXは、実際にWeb VitalsがどのようにGoogleに報告されるのかを明らかにするものです。そのレポートの1つは、特に2021年5月の期限以降において、Core Web Vitalsを達成したWebサイトが増加したことを明確に示しています。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image8.png"></p>
<div class="image-text">
画像内訳
<em>Core Web Vitals（LCP、FID、CLS）の３つの指標すべてで「良好」なエクスペリエンスを達成したオリジンの割合。オリジンのFIDのデータがない場合、残りの指標のパフォーマンスに基づいて評価。</em>
</div>
<p>さらに、他にも統計は公表されています（筆者自身も統計を公表している1人です）。多くの統計はHTTP Archiveのデータに基づいており、特に<a href="https://datastudio.google.com/u/0/reporting/55bc8fad-44c2-4280-aa0b-5f3f0cd3d2be/page/M6ZPC">Core Web Vitals Technology</a>レポートを活用しています。このレポートは、テクノロジーを通じてデータの詳細分析を行うためにHTTP Archiveが作成したものです。これらの統計はいずれも、とても前向きなストーリーを示しています。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image3.png"></p>
<div class="image-text">
画像内訳
<em>Webのパフォーマンスは改善しているか？答えはYES :) 今やオリジンの33%がCore Web Vitalsのしきい値を達成！フレームワークを利用しているサイトも大幅に改善</em>
<ul>
  <li><em>現在、全体で33%のオリジンがCore Web Vitalsの推奨しきい値を達成</em></li>
  <li><em>昨年以降、Core Web Vitalsのしきい値を達成したオリジンは26%増加</em></li>
</ul>
</div>
<p>このように、問題の答えは明らかになりました。このとても短いブログ記事は、タイトルで提示した疑問（Core Web VitalsはWebを高速化したか？）に回答したことになります。記事を読んでいただき、ありがとうございました！</p>
<h2>あまり楽観的ではない見方</h2>
<p>いやいや、ちょっと待ってください。最初のグラフはCore Web Vitalsを達成したWebサイトの数を表しています。これをWebが高速化しているかどうかを示す代理データとして使用するには、いくつかの前提が必要です。</p>
<ul>
<li>Core Web Vitalsを達成するためのしきい値は変化していない（実際もほとんど変化していない）。</li>
<li>測定対象のWebサイトは同一（CrUXは「広く知られているかどうか」（popularity threshold）を定めており、対象は毎月変わるが、全体としては概ね同一）。</li>
<li>改善の主な理由はCore Web Vitalsである（ネットワーク全般の速度が改善したことや、パンデミックによって多くの人が家にこもり、ブロードバンド接続を利用するようになったことなどが理由ではない）。</li>
<li>Core Web Vitalsの測定方法は、測定期間を通じて一貫しており、大幅に変更されていない。</li>
</ul>
<p>特に気になるのは最後の項目です。Core Web Vitalsは<strong>生まれたばかり</strong>の指標です。<a href="https://twitter.com/anniesullie">Annie Sullivan</a>はちょうど2年前に、<a href="https://calendar.perfplanet.com/2019/developing-the-largest-contentful-paint-metric/">3つのCore Web Vitalsの1つ（LCP）がどのように開発されたかに関する記事</a>をWeb Performance Calendarに投稿しています。つまり、Core Web Vitalsは人間でいうところの「魔の2歳児」と呼ばれる時期です。そして、親なら誰でも知っているとおり、生まれてから2歳になるまでには多くの変化が起こります。</p>
<p>このような新しい指標を最初から完璧な形で導入するのは不可能です。GoogleのChromeチームは、特にSEOへの影響を考慮して、熱心にCore Web Vitalsの改善に取り組み、適切な測定ができていないケースに対処してきました。Core Web Vitalsは多くの点で改善されています（すべての改善点は<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/README.md">公開変更ログ</a>で明確に追跡できます）。</p>
<p><a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/lcp.md">Largest Contentful Paint（LCP）は、最大のコンテンツ要素を正しく特定するためにいくつかの点が変更されています</a>。非表示の画像や背景の画像は「コンテンツ」ではないものとして無視され、LCPの計算が停止するタイミングも変更されました。これらはすべて（プラスとマイナスの）影響を及ぼすとみられ、LCPの改善のグラフは最初に示したグラフよりも（特にモバイルで）やや横ばいとなっています。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image10.png"></p>
<div class="image-text">
画像内訳
<em>LCPエクスペリエンスが「良好」（2.5秒以下）であるオリジンの割合。</em>
</div>
<p><a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/fid.md">First Input Delay（FID）の変更点</a>は、LCPに比べると多くありません。ただし、Chromeが<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/2021_05_fid.md">ダブルタップによるズームの禁止</a>条件を変更したことはプラスの影響を及ぼしています。これは2021年5月にリリースされており、リリース直後からモバイルのFIDの数値に影響を与えていることが分かります。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image7.png"></p>
<div class="image-text">
画像内訳
<em>FIDエクスペリエンスが「良好」（100ミリ秒以下）であるオリジンの割合。CrUXのFIDを参照。</em>
</div>
<p>FIDは通常、Core Web Vitalsの中で達成するのが最も簡単です。そのため、多くの人（何よりも<a href="https://web.dev/better-responsiveness-metric/">Chromeチーム自身</a>）が、抜本的な変更が必要ではないかという疑問を提起しています。したがって、来年ごろにはFID（少なくともCore Web VitalsにおけるFID）に何らかの大きな変化があるでしょう。</p>
<p>最後に、3番目のCore Web VitalsであるCumulative Layout Shift（CLS）は最も大きく変更されています。CLSは、Cumulative（累積）という名称が示すとおり、以前はページが存在する限り増加し続けていました。これは、シングルページアプリケーション（SPA）が不当に不利な立場に置かれているという苦情の原因となりました。SPAのページは長期にわたって存続すると見込まれるためです。CLSに対する影響がわずかであっても、時とともに蓄積し、しきい値を超えて「改善が必要」や「不十分」となる可能性が高まります。</p>
<p>CLSは、<a href="https://web.dev/evolving-cls/">1回のセッションウィンドウの間の最大累積CLSのみを報告する</a>ように変更されました。実質的に、現在のCLSスコアはすべてのCLSシフトの合計ではなく、一定の時間におけるCLSシフトの最大の部分を示すものとなっています。この変更は2021年5月ごろのChrome 91でリリースされており、グラフでは同じ時期にCLSスコアが良好なサイトが急増しているのが分かります。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image2.png"></p>
<div class="image-text">
画像内訳
<em>CLSエクスペリエンスが「良好」（0.1以下）であるオリジンの割合。</em>
</div>
<p>2021年9月のChrome 93では<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/cls.md">さらなる改善点</a>がリリースされており、再びグラフが上昇しています。</p>
<p>指標の変更と同様に、測定のベースラインにも留意する必要があります。3つすべてのCore Web Vitalsを達成したAngularサイトの数が111%増加したのは結構なことですが、詳しく見てみると、<a href="https://datastudio.google.com/u/0/reporting/55bc8fad-44c2-4280-aa0b-5f3f0cd3d2be/page/M6ZPC?params=%7B%22df44%22:%22include%25EE%2580%25800%25EE%2580%2580IN%25EE%2580%2580Angular%22%7D">Angularサイト全体の3%から6%に増えただけ</a>であり、素晴らしい改善というには程遠いようです。しかも、これらの統計が示す改善がなされていないAngularサイトであっても、上記の指標の変更による恩恵を受けているはずです。</p>
<h2>Webは高速化したのか？</h2>
<p>これまで筆者は、気難しいエベニーザ・スクルージ（※訳注：小説『クリスマス・キャロル』の登場人物）のように、クリスマスに水を差してきました。そして、Core Web Vitalsが向上した理由は、単に測定方法が改善されたためである可能性があるので、プラスの影響を主張するのはやや時期尚早かもしれないことを示しました。しかし、実際に多くのサイトはパフォーマンスの改善に忙しく取り組んでいます。そのため、Core Web Vitalsの向上の理由はすべて測定方法にあると主張するのは、逆の方向に極端であり、あまりに悲観的過ぎるかもしれません。では、指標の定義の大幅な変更を踏まえ、測定方法による影響と真のパフォーマンスの向上を分離し、Web全体が改善したのかを確認するにはどうすれば良いのでしょうか？</p>
<p>そのための方法の1つは、従来のより安定した指標に回帰し、それを読み解くことです。真新しく光るLCP、FID、CLSという指標が舞台に突然現れスポットライトを浴びる以前、Webパフォーマンスコミュニティでは、<a href="https://web.dev/first-contentful-paint/">First Contentful Paint</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/Events/load">onLoad</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/DOMContentLoaded_event">edDOMContentLoad</a>、<a href="https://web.dev/lighthouse-total-blocking-time/">Total Blocking Time</a>、<a href="https://web.dev/interactive/">Time to Interactive</a>など多くの他の指標に頼っていました。筆者のお気に入りの1つは<a href="https://web.dev/speed-index/">Speed Index</a>です。</p>
<p>誤解のないように言うと、筆者はCore Web Vitalsの方が<strong>はるかに</strong>優れた指標だと考えています。Core Web Vitalsの3つの指標は、ユーザー体験の代わりとなることを意図した恣意的で細かな数値ではなく、ユーザーにとって意味のある影響を測定しようとしています。ユーザーはDOMがいつ読み込まれるかなどといったことは気にしません。ユーザーが気にするのは、目的のコンテンツがページにいつ表示されるかです。特に、ラボベース（※訳注：開発者内部の環境下で行われるモニタリング）の完全に人為的な測定から、リアルユーザモニタリング（RUM）ベースの現場での測定への転換は非常に大きな進歩です。ラボベースのテストがユーザー体験の良い指標となるように膨大な仮定を置く必要がなく、ユーザーが体験する実際のWebパフォーマンスを報告できるのはとても良いことです。</p>
<p>しかし、これまで見てきたとおり、この記事で挙げている疑問に答えるには、新たな指標は変動が大き過ぎると言わなければなりません。新しい指標は優れていますが、古い指標が役に立たなかったわけではありません。Webパフォーマンスが改善されれば、古い指標にもプラスの影響があるはずです。そこで、これらの指標を詳しく調べ、何が分かるのかを見ていきましょう。</p>
<p>筆者はSpeed Indexがお気に入りの「昔ながらの」指標だと述べました。Speed Indexは基本的に、読み込み中のページのスクリーンショットを保存して、変化ごとのページの「完成度」を計算し、それを使用してページの読み込みに関するスコアを算出するものです。ロゴなどわずかな一部を除いてほとんど読み込みが終わっているページと、最後まで一切描画されないページを比べると、一部の指標（onLoad、DOMContentLoadedなど）は同じであっても、Speed Indexでは前者の方が良い数値になります。</p>
<p>このように、Speed IndexはLCPの測定対象とそれほど違っておらず、CLSの一部も含まれています。LCPに影響する要素の読み込みが速く、読み込み中のビューポート内のコンテンツがあまり移動しなければ、Speed Indexも改善するでしょう。Annieは、上記の過去の記事で、Speed IndexがCore Web Vitalsとして使用されず、代わりにLCPが考案された主な理由として「Speed Indexを実行するのは大きなコストがかかり、リアルタイムで利用できないこと」を挙げています。Speed Indexはあくまでラボベースの指標なのです。</p>
<p>HTTP Archiveは2016年から、調査の一環としてSpeed Indexを算出しています。Speed Indexがラボベースであるという事実は、RUMベースの指標に影響を与える一部の変動やノイズに左右されないことを意味します。このような変動やノイズには、例えばネットワーク速度の改善や、パンデミックによってモバイルネットワークよりも家庭用のWi-Fiを利用した在宅勤務が増えていることなどがあります。HTTP Archiveの調査ではこうした要素が除去されています。クローリングに使用するハードウェアや、ネットワークの調査手法に（とても）一貫性があるからです。</p>
<p>注意すべき点として、HTTP Archiveは、Speed Indexの独自の定義を定めている<a href="https://www.webpagetest.org/">WebPageTest</a>（WPT）を利用しています。これは（WPTの定義を基礎とする）Lighthouseの定義とはわずかに異なります。WPTは色ヒストグラムを利用しているため、（コンテンツがビューポートの内外を移動しない限り）コンテンツの移動による影響をあまり受けません。一方、Lighthouse版はより複雑な<a href="https://www.imatest.com/docs/ssim/">構造的類似性</a>（SSIM）指数を利用しており、コンテンツの移動による影響を受けやすくなっています。</p>
<p>Speed IndexのグラフはHTTP ArchiveのWebサイトでは提供していませんでした。しかし、データは既に収集してあったので、この記事を作成する一環として<a href="https://httparchive.org/reports/loading-speed#speedIndex">グラフを追加しました</a>。以下がそのグラフです（数値は低いほど良い）。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image6.png"></p>
<div class="image-text">
画像内訳
<em>ページのコンテンツが視覚的に表示される速度。この指標はWebPageTestによるものであり、（WebPageTestの定義を基礎とする）Lighthouse版とはわずかに異なる。</em>
</div>
<p>グラフは筆者が恐れていたことを示しています。Core Web Vitalsの代わりに変動の小さいSpeed Indexで測定したところ、Core Web Vitalsの導入以降、Webは全体として大幅に高速化してはいないようです。それどころか、モバイルでは2021年6月以降にSpeed Indexも悪化しています。</p>
<p>HTTP Archiveによる<a href="https://httparchive.org/reports/loading-speed">読み込み速度レポート</a>では、他の指標も同様の結果を示しています。実質的な変化はなく、First Contentful Paintがある程度改善した程度にとどまりました（ただし、この指標も<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/fcp.md">最近変更がありました</a>）。Time to InteractiveもWebサイトの応答時間の長期化を示しています（恐らく<a href="https://almanac.httparchive.org/en/2021/javascript#how-much-javascript-do-we-load">JavaScriptの使用が多過ぎる</a>ためでしょう）。この傾向はCore Web Vitalsが登場する以前から続いているものです。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image9.png"></p>
<div class="image-text">
画像内訳
<em>操作が開始された時点から、CPUが5秒以上停止するまでの秒数。この指標はLighthouseによるもので、モバイルのテストでのみ利用できる。</em>
</div>
<h2>とても残念な結果に思えるが……</h2>
<p>以上のように、Googleや、同社の最も人気のあるWebブラウザや検索エンジンの絶大な影響力をもってしても、パフォーマンスを改善できていないようです。これはとても残念な結果であり、Webパフォーマンスマニアのクリスマスを台無しにしてしまったことを申し訳なく思います……。しかし、筆者はそこまで残念だとは思っていません。ですから、この記事はもっと明るい雰囲気で終わらせましょう。</p>
<p>HTTP ArchiveとCrUXのデータの重要な違いは、HTTP Archiveがホームページのみをクローリングしているという点です。CrUXのデータは、Webサイト全ページの実際の利用状況に基づいています。この取り組みの優れた点の1つは、ホームページ以外のパフォーマンス指標を明らかにしているところにあります。過去のWebパフォーマンス測定ツールでは、ホームページのみを測定対象としていた場合もあったはずです。</p>
<p>かつてのパフォーマンス測定ではホームページばかりが注目されていたことや、ホームページは比較的シンプルなので問題がある可能性が低いことは、十分にあり得ます。もしかすると、筆者が悲観的過ぎるだけであって、上記のCrUXデータの方が、ユーザーが体験した実際のパフォーマンスの改善状況をよく表しているのでしょうか。筆者は、真実はその中間にあるとみています。しかし、胸に手を当てて考えてみると、HTTP Archiveのクローリングによるグラフの方が恐らく真実に近いでしょう。ただし、指標が成熟するにつれて変化が小さくなると仮定すれば、将来的にはCrUXベースのグラフは大いに興味深いものになるとみられます。</p>
<p>どれほどの影響力を持っていても、Web全体で何かを変えるのは困難です。<a href="https://httparchive.org/reports/state-of-the-web#numUrls">HTTP Archiveはクローリングの一環として750万件以上のWebサイトをクロールしています</a>。そして、WebパフォーマンスやSEOのコミュニティがパフォーマンスについて大騒ぎをしていたにもかかわらず、大部分のサイトはその間も大きく変化してはいないでしょう。一方で、変化したサイトも数多く存在するため、Webサイトは実際に高速化したのかもしれません。しかし、それはまだWeb全体を見た場合に有意義な影響を与えられるほど十分な規模ではありません。</p>
<p>筆者はCore Web Vitalsを気に入っており、優れた指標だと考えています。また、GoogleによるCore Web Vitalsへの投資や、同社がWebサイトに対して改善に向けた圧力をかけていることも評価しています。たとえその取り組みの一部に不満があったとしてもです（Google Search Consoleにおけるページのグルーピングの不透明さは大いに不満です）。指標が依然として発展途上であるという指摘は、批判ではなく、とても前向きなものです。この事実は、Core Web Vitalsは変化を拒むものではなく、あくまでWebパフォーマンスの改善に向けた次のステップだという認識を示しており、だからこそ前進できるのです。</p>
<p>たとえ上記のHTTP Archiveのデータに対する影響がまだ表れていないとしても、Webパフォーマンスに関する議論が大幅に増えたのは事実です。そして、こうした議論が今や、比較的小さいWebパフォーマンスコミュニティ（いつでも歓迎します！）の外でも行われるようになったのは素晴らしいことです。</p>
<h2>最後にうれしいニュースを紹介</h2>
<p>上位1,000件のWebサイトを見てみると、Core Web Vitalsを達成したWebサイトの割合は全体よりも大幅に上昇していることが分かります。2021年5月以降の改善割合は、モバイルWebサイト全体では32.8%ですが、上位1,000件のサイトでは37.1%となっています。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image5.png"></p>
<div class="image-text">
画像内訳
<em>Core Web Vitals達成割合の時系列データ</em>
</div>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image1.png"></p>
<div class="image-text">
画像内訳
<em>上位1,000件のサイトのCore Web Vitals達成割合の時系列データ</em>
</div>
<p>当然ながら、大規模なサイトほど予算も多く（改善のインセンティブも大きく）、SEOのトレンドをより正確に把握しているかもしれません。また、こうしたサイトは指標の改善による影響が比較的大きい場合があるという事実が一因となっている可能性もあります。しかし、それでも筆者はこれを前向きな兆候と捉えています。こうしたサイトが先頭を進み、他のWebサイトがそれを追いかけるというトリクルダウン効果が起きるのはよくあることです。</p>
<p>また、Wixなどの一部のプラットフォームは、<a href="https://www.smashingmagazine.com/2021/11/improving-performance-wix-websites-case-study/">パフォーマンスを改善するための取り組みに膨大な労力を費やしています</a>。これらのWebサイトの取り組みは、HTTP ArchiveのSpeed Indexのスコアに反映されています（これは、Speed Indexを使用するという筆者の判断を正当化するのに役立っており、Speed IndexがCrUXに比べて実情を反映していないのではないかという筆者の懸念をある程度緩和するものです）。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image4.png"></p>
<p>一度に1つのプラットフォームのみに注目するよりも、（<a href="https://datastudio.google.com/u/0/reporting/55bc8fad-44c2-4280-aa0b-5f3f0cd3d2be/page/M6ZPC?params=%7B%22df44%22:%22include%25EE%2580%25800%25EE%2580%2580IN%25EE%2580%2580Angular%22%7D">Core Web Vitals Technology Report</a>が示すように）その他のプラットフォームの相対的な改善度合いに注目する方が指標として優れているかもしれません。しかし、<a href="https://twitter.com/igrigorik/status/1415340002494402564?s=20">多少の競争がある</a>のはきっと良いことです。</p>
<p>恐らくもっと興味深い点として、<a href="https://almanac.httparchive.org/en/2021/cms#fig-6">Web全体の3分の1に利用されている</a>WordPressは最近、「<a href="https://make.wordpress.org/core/2021/10/12/proposal-for-a-performance-team/">パフォーマンス改善提案チーム</a>」を立ち上げました。これはWixなどが強調しているパフォーマンスの改善に対応して、WordPressが後れを取っているという印象を避けるためです。WordPressはまさに「Webを動かす」力を持っており、そのことは<a href="https://twitter.com/rick_viscomi/status/1344380340153016321?s=20">ネイティブLazyload</a>の導入にも表れています（ただし、大いなる力には大いなる責任が伴うもので、<a href="https://web.dev/lcp-lazy-loading/">導入の方法がやや稚拙だったという証拠もあります</a>）。</p>
<h2>そろそろ質問に答えてくれ！</h2>
<p>結局、Core Web VitalsによってWebは高速化したのでしょうか？筆者はイエスだと考えていますが、Core Web Vitalsの一部のデータが示すほど数値は明確に改善してはいません。しかし、この記事で言及した一部のプラットフォームの例に追随するプラットフォームが増え、Webパフォーマンスへの投資が増加すれば、上記の数値も間違いなく追いつくでしょう。もしかすると、来年のブログ記事はもっと短くなり、すべてうまくいっていると述べるだけになるかもしれません。それまでは、指標から読み取れることをしっかりと理解し、出来過ぎた話には疑問を持つようにしてください。たとえ、それが本当であってほしいと望むストーリーであってもです。</p>
<p><em>この記事のために質問に答えてくれたこと、また言うまでもなく、Speed Index、WebPageTestや、その他にもWebパフォーマンスを測定・改善するための素晴らしいツールを数多く作成してくれたことについて、<a href="https://twitter.com/patmeenan">Patrick Meenan</a>にとても感謝しています。</em></p>]]></content:encoded></item><item><title><![CDATA[Rustのビルドを高速化する方法]]></title><description><![CDATA[Rustコードのコンパイルが遅いことは誰でも知っています。しかし筆者は、世の中のほとんどのRustコードはコンパイルをもっと速くできると強く感じています。 例えば、つい最近の記事にこのように書かれて…]]></description><link>https://postd.cc/fast-rust-builds/</link><guid isPermaLink="false">https://postd.cc/fast-rust-builds/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[Rust]]></category><pubDate>Mon, 24 Jan 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>Rustコードのコンパイルが遅いことは誰でも知っています。しかし筆者は、世の中のほとんどのRustコードはコンパイルをもっと速くできると強く感じています。</p>
<p>例えば、つい最近の<a href="https://kerkour.com/blog/rust-development-workflow/">記事</a>にこのように書かれていました。</p>
<blockquote>
<p>一方、Rustでは、プロジェクトやCIサーバーの性能にもよりますが、
CIパイプラインの実行に15～45分かかります。</p>
</blockquote>
<p>これは筆者には理解できません。GitHub Actions上にあるrust-analyzerのCIの所要時間は8分です。しかも、これは100万行の依存関係に加え、20万行の独自コードが記述されたとても大規模で複雑なプロジェクトでの話です。</p>
<p>確かに、Rustは根本的な部分で非常にコンパイルが遅いのは間違いありません。Rustは<a href="https://research.swtch.com/generic">ジェネリクスのジレンマ</a>において「遅いコンパイラ」を選び、全体的な設計思想としてコンパイル時間よりもランタイムを優先しています（この点に関する優れたシリーズ記事を紹介します：<a href="https://pingcap.com/blog/rust-compilation-model-calamity">1</a>、<a href="https://pingcap.com/blog/generics-and-compile-time-in-rust">2</a>、<a href="https://pingcap.com/blog/rust-huge-compilation-units">3</a>、<a href="https://pingcap.com/blog/reasons-rust-compiles-slowly">4</a>）。しかし、rustcは低速なコンパイラではありません。rustcは業務用コンパイラの中で最も<a href="https://blog.jetbrains.com/kotlin/2020/09/the-dark-secrets-of-fast-compilation-for-kotlin/#:~:text=I%20think%20Rust%20qualifies%20as%20a%20counter%20example%20here">先進的なインクリメンタルコンパイル手法</a>を導入し、適切なモジュール（クレート）に基づくコンパイルモデルを活用しており、<a href="https://blog.mozilla.org/nnethercote/2020/09/08/how-to-speed-up-the-rust-compiler-one-last-time/">細かい部分まで最適化されています</a>。Rustプロジェクトの高速なコンパイルは、たとえ一般的ではなくても現実に可能です。ただし、それにはいくつかの注意点と専門知識が必要です。</p>
<p>それでは、私たちがrust-analyzerのコンパイル時間を妥当な範囲に収めるために実施した対策を詳しく見ていきましょう。</p>
<h2>ビルド時間を気にする理由</h2>
<p>筆者が明確にしておきたいのは、プロジェクトのビルド時間を最適化するのは、ある意味ではあまり価値のない取り組みだという点です。コンパイル時間を削減しても、ユーザーにとっての<strong>直接的</strong>なメリットはごくわずかで、あくまで本質から外れた問題にすぎません。</p>
<p>とはいえ、コンパイル時間はほぼすべての作業の所要時間を<strong>倍増</strong>させます。追加機能の搭載、コードの高速化、要件変更への対応や、新しいコントリビュータの勧誘にもビルド時間が関わってきます。</p>
<p>コンパイル時間には間接的な影響もあります。コンパイラの作業を待つだけなら比較的小さな問題です。大きな問題は、コードのコンパイルの間に、集中力が失われたり、さらに悪いことに気分が変わって別の作業をしたくなったりすることです。コンパイラにとっては1分の仕事でも、人間にとっては1分以上の時間が無駄になります。</p>
<p>こうした影響を定量化するのは困難ですが、直感的にはプロジェクトの1人当たりのコードが数千行を超えると、ビルド時間は非常に重要になると思います。</p>
<p>ビルド時間の最も恐ろしい特徴は、気づかないうちに増大する点です。プロジェクトが小規模なうちは、ビルド時間は許容できる範囲にとどまるでしょう。プロジェクトが成長するにつれて、ビルド時間もゆっくりと増加し始めます。放っておくと、後でコントロールできる状態に戻そうとしても困難になる恐れがあります。</p>
<p>プロジェクトのコンパイル時間がすでに許容できないほど遅くなっている場合は、以下のような事態を招きます。</p>
<ul>
<li>ビルド時間の改善には時間がかかります。なぜなら、「変更を試し、ビルドを実行して、改善度を測定する」ためのイテレーションに毎回長い時間がかかるからです（ビルド時間はすべての作業の所要時間を倍増させますが、それにはビルド時間自体も含まれます）。</li>
<li>簡単に成果を上げるのは難しいでしょう。ランタイムのパフォーマンスとは異なり、パレートの法則は機能しません。1,000行のコードのうち、パフォーマンスに影響するのは100行かもしれませんが、コンパイル時間は1行ごとに増えます。</li>
<li>ビルド時間がわずかに短縮されても、それが十分に蓄積するまでは、取るに足らないと感じられるでしょう。コンパイル時間を5秒削減できたとして、元々のビルド時間が5分であれば非常に大きな成果ですが、1時間であればそうでもありません。</li>
<li>同様に、ビルド時間がわずかに増加しても誰も気づきません。</li>
</ul>
<p>これには文化的な要因もあります。あなたがプロジェクトに参加して、そのCIに1時間かかるとしたら、1時間のCIは普通だと思うようになるでしょう。</p>
<p>うれしいことに、ビルド時間の問題を解決するには簡単なコツがあります。</p>
<h2>銀の弾丸</h2>
<p>ビルド時間は、問題になる<strong>前</strong>から注視し、修正する必要があります。ビルド時間の短縮は、最適化に関する問題としてはかなり簡単です。直接的なフィードバックを得る方法は明確で（ビルド時間を測るだけです）、プロファイリングツールも数多く存在し、目安となるベンチマークを考案する必要さえありません。課題となるのはコンパイラ全般のパフォーマンスの向上ではなく、特定のプロジェクトのビルド時間の最適化です。一般に、ビルド時間の最適化のように本質的でない問題では、ほとんどのケースでこのような好ましい特徴が見られます。つまり、エンジニアリング問題としての定義が明確で、その解決策もよく知られている傾向があります。</p>
<p>コンパイル時間に関して唯一難しいのは、実際に問題になるまで、それが問題だと認識できない点です。ですから、この記事から学べる最も有益なポイントは、もしあなたがRustプロジェクトに取り組んでいるなら、今日はビルドの最適化のためにある程度時間をとり、今後もなるべく、たまには最適化を行うべきだということです。</p>
<p>これでソフトウェアエンジニアリングの話は終わったので、ようやく実用的なプログラミングのアドバイスに入ることができます。</p>
<h2>bors</h2>
<p>筆者は、注目すべき主要な指標の1つとして好んでCI実行時間を利用します。</p>
<p>理由の1つはCI時間それ自体が重要だからです。機能の開発がCIに制約されない場合でも、CI時間は1つの作業を終えて次の作業を始めるための意識の切り替えによる負担に直接影響します。CI完了を待ちながら、5件のプルリクエスト（PR）を同時並行で処理するのは生産的ではありません。またCIが長くなると、作業を独立したまとまりに分割しにくくなります。1つのタイポを訂正するのにPRタブを30分開いておく必要があるなら、次の機能のブランチで修正を実行する方が良いでしょう。</p>
<p>しかし、それより大きな理由は、CIが標準的なベンチマークになることです。ローカル環境では、コンパイルは徐々に行われ、変更の内容によってビルド時間は大きく異なります。通常、コンパイルするのはプロジェクトの一部です。こうした変動が避けられないため、ローカル環境におけるビルドでは、ビルド時間に関する継続的なフィードバックを十分に得られません。一方、標準化されたCIはすべての変更に対して実行されるので、直接比較可能なデータを時系列で把握できます。</p>
<p>CIによる標準化を推進するには、“<a href="https://graydon2.dreamwidth.org/1597.html">ロケットサイエンスのルール</a>”ではなく、メインブランチのあらゆる段階でCIを確実に実行するためのマージボットの設定をお勧めします。筆者は特に<a href="https://bors.tech/">bors</a>をよく導入していますが、他の方法もあります。</p>
<p>borsのようなツールには、（導入の決め手には全くなりませんが）妥当なコンパイル時間を実現するうえで2つのメリットがあります。</p>
<ul>
<li>あらゆる変更に対してCIが確実に実行されるようにし、全体的なCIの健全性の維持を推進します。</li>
<li>PRに<code class="language-text">r+</code>コメントを付けてから「PR merged」の通知を受け取るまでの時間を常にフィードバックループで活用できます。わざわざビルド時間を測定する必要はなく、あらゆるPRがビルドのベンチマークとなります。</li>
</ul>
<h2>CIキャッシング</h2>
<p>考えてみれば、優れたキャッシング戦略がCIにとって有効なのはどう見ても明らかです。めったに変更されないものをキャッシュするのは理にかなっていますが、頻繁に変更されるものをキャッシュしても無意味です。つまり、依存関係はすべてキャッシュすべきですが、プロジェクト自体のクレートはキャッシュすべきではありません。</p>
<p>しかし、残念なことに、これを実践している人はほとんどいません。<a href="https://github.com/actions/cache/blob/main/examples.md#rust---cargo">よくあるのが</a><code class="language-text">./target</code>ディレクトリ全体をキャッシュしているケースです。これは間違っています。<code class="language-text">./target</code>はサイズが大きく、その大部分はCIには不要です。</p>
<p>とはいえ、修正するのはそれほど簡単ではありません。悲しいことに、Cargoを使用しても、<code class="language-text">./target</code>のどの部分が持続的な依存関係で、どの部分が変更されやすいローカルなクレートであるかを容易には判別できません。ですから、キャッシュを保存する前に<code class="language-text">./target</code>を整理するための<a href="https://github.com/rust-analyzer/rust-analyzer/blob/94d9fc2a28ea5d97e3a9293b9dac05bdb00304cc/xtask/src/pre_cache.rs#L30-L53">コード</a>を書く必要があります。特にGitHub Actionsでは<a href="https://github.com/Swatinem/rust-cache">Swatinem/rust-cache</a>も利用できます。</p>
<h2>CIワークフロー</h2>
<p>キャッシングは通常、簡単に大きな成果を上げられます。しかし、他にも微調整できる点はいくつか存在します。</p>
<p>まず、CIを<code class="language-text">cargo test --no-run</code>と<code class="language-text">cargo test</code>に<a href="https://github.com/rust-analyzer/rust-analyzer/blob/48f84a7b60bcbd7ec5fa6434d92d9e7a8eb9731b/.github/workflows/ci.yaml#L56-L61">分割</a>します。CIのどの部分がビルドで、どの部分がテストかを把握するのは必要不可欠です。</p>
<p>次に、インクリメンタルコンパイルを<a href="https://github.com/rust-analyzer/rust-analyzer/blob/25368d24308d6a94ffe8b99f0122bcf5a2175322/.github/workflows/ci.yaml#L11">無効化</a>します。CIビルドはスクラッチビルドに近いケースが多いです。通常、変更はローカルな編集とコンパイルのサイクルよりはるかに大規模になるからです。スクラッチビルドでは、インクリメンタルコンパイルによって、新たな依存関係を追跡するオーバーヘッドが増えます。IOの量と<code class="language-text">./target</code>のサイズも大幅に増加し、キャッシングの有効性が低下します。</p>
<p>debuginfoを<a href="https://github.com/rust-analyzer/rust-analyzer/blob/48f84a7b60bcbd7ec5fa6434d92d9e7a8eb9731b/Cargo.toml#L6-L10">無効化</a>するのも有効です。debuginfoは<code class="language-text">./target</code>のサイズを大幅に増大させるため、やはりキャッシングにとって悪影響です。望ましいワークフローに応じて、debuginfoを無条件に無効化することを検討しても良いでしょう。ローカル環境でのビルドにとっても一定のメリットがあります。</p>
<p>ついでに、<code class="language-text">-D warnings</code>を<code class="language-text">RUSTFLAGS</code>環境変数に<a href="https://github.com/rust-analyzer/rust-analyzer/blob/3dae94bf2b3e496adb049da589c7efef272a39b8/.github/workflows/ci.yaml#L15">追加</a>して、すべてのクレートの警告をまとめて拒否しましょう。<code class="language-text">#![deny(warnings)]</code>をコードに追加するのは良いアイデアではありません。すべてのクレートで同じことを繰り返さなければならず、ローカルの開発を不必要に困難にし、ユーザーがコンパイラをアップグレードする際に気力をそがれる恐れがあります。Cargoネットワークのリトライ回数を増やすのも有効かもしれません。</p>
<h2>Lockfileを読み込む</h2>
<p>他のアドバイスとしては、当然のことですが、利用する依存関係の数を減らし小規模化すると良いでしょう。</p>
<p>ただし、これには微妙な点があります。ライブラリは実際に問題を解決するものです。crates.ioで解決済みの問題に自分でソリューションを導入するのはばかげています。そして、あなたのソリューションがより小規模である保証はありません。</p>
<p>しかし、アプリケーションが解決しようとしている問題と、そうでない問題を認識するのは重要です。数千人が利用するCLIユーティリティを構築している場合、<a href="http://clap.rs/">clap</a>とそのすべての機能は絶対に必要です。一方、CIの間に実行する簡単なスクリプトを書いていて、それがチームにしか使用されない場合、コマンドラインのパーシングを単純にして、ビルドを高速化しても構わないでしょう。</p>
<p>これに関して、<code class="language-text">Cargo.lock</code>（Cargo.tomlではありません）を読み、それぞれの依存関係が自分のアプリケーションを使用する人たちにとってどんな実際の問題を解決するか考えてみるのは、とても有用なトレーニングとなります。<strong>自分の環境</strong>では依存関係が全く意味を持たないのに気づくのは非常によくあることです。</p>
<p>例を挙げると、rust-analyzerはregexに依存していますが、これは無意味です。私たちには RustとMarkdown向けの厳密なパーサーとレキサーがあるため、ランタイムで正規表現を解釈する必要はありません。さらに、regexは小規模な言語を丸ごと導入するため、依存関係がかなり重いクレートの1つです。この依存関係が存在する理由は、私たちが利用しているロギングライブラリにおいて、以下のような記述が可能になるためです。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">RUST_LOG=rust_analyzer=very complex filtering expression</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>この場合、フィルタリング式のパーシングは正規表現によって行われます。</p>
<p>これは一部のアプリケーションにとって間違いなくとても便利な機能ですが、rust-analyzerに関しては不要です。<code class="language-text">env_logger-</code>の単純なフィルタリングで十分でしょう。</p>
<p>同様に冗長な依存関係を特定したら、どこかのfeaturesフィールドを微修正するか、PRを上流に送信して不必要な部分を変更可能にすれば十分です。</p>
<p>時にはもっと大規模なyak shaving（※訳注 問題を解決しようとすると別の問題が出てきて、それを解決しようとするとさらに別の問題が出てくるという繰り返しのこと）が必要な場合もあります。例えば、rust-analyzerはオプションでjemallocクレートを利用しており、そのビルドスクリプトは<a href="https://docs.rs/fs_extra">fs_extra</a>と（よりによって）<a href="https://docs.rs/paste">paste</a>を呼び出します。ここでの理想的な解決策はもちろん、堅牢で安定した純正なrustメモリアロケータの導入です。</p>
<h2>最適化の前にプロファイリングを</h2>
<p>ここまで常識的な対策を実施してきたので、そろそろビルド時間を削減する前に測定してみましょう。今回使用するツールはCargoのtimingsフラグです（<a href="https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#timings">ドキュメントはこちら</a>）。悲しいことに、筆者はこの機能の質の高さと洗練性を十分に表現できるだけの雄弁さを持ち合わせていません。そこで、ここでは愛 ❤️ を表明するだけにとどめ、ドライに説明を続けさせてください。</p>
<p><code class="language-text">cargo build -Z timingsは</code>、ビルド中のプロファイリングデータを記録し、それをとても読みやすくて情報が詰まったHTMLファイルとして出力します。これはナイトリー版の機能であるため、<code class="language-text">+nightly</code>トグルが必要です。とはいえ、ときどき手動で実行すればよいだけなので、実際は問題ありません。</p>
<p>以下はrust-analyzerの例です。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">cargo +nightly build -p rust-analyzer --bin rust-analyzer \
  -Z timings –release</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p><img src="https://matklad.github.io/assets/cargo-timings.png"></p>
<p>各クレートのコンパイルにどれだけ時間がかかったかだけでなく、個々のコンパイルがどのようにスケジューリングされ、各クレートのコンパイルがいつ開始されたかや、クリティカルな依存関係も分かります。</p>
<h2>コンパイルのモデル：クレート</h2>
<p>ここからは重要な最後のポイントを説明します。クレートは依存関係の有向非巡回グラフを形成し、マルチコアのCPUではこのグラフの形状がコンパイル時間に大きく影響します。</p>
<p>以下はすべてのクレートを順番にコンパイルする必要があるため、コンパイルに時間がかかります。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">A -&gt; B -&gt; C -&gt; D -&gt; E</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>一方、以下のグラフでは並列処理が可能な部分が大幅に増えるため、コンパイルははるかに速くなります。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">   +-  B  -+
  /         \
A  -&gt;  C  -&gt;  E
  \         /
   +-  D  -+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>並列処理とインクリメンタリティにも関係があります。2番目の大きいグラフでは、Bを変更してもCとDを再びコンパイルする必要はありません。</p>
<p>Rustのコンパイル時間について不満を言うと、最初に返ってくるアドバイスは「コードをクレートに分割しよう」です。しかし、これはさほど簡単ではありません。最初のグラフのような形状になっている場合、大きな成果は見込めません。アプリケーションを2番目のグラフのように構築するのが重要となります。つまり、共通用語のクレート、複数の独立した機能、そしてすべてを繋ぐ「葉」の役割を果たすクレートから成る構造です。クレートの最も重要なプロパティは、そのクレートが（推移的に）依存していないクレートはどれかということです。</p>
<p>もう1つの重要な検討事項は、最終的なアーティファクト（最も一般的にはバイナリ）の数です。Rustは静的リンク方式であるため、2つの異なるバイナリが同一のライブラリを使用する場合、各バイナリにはそれぞれ別にリンクされたライブラリのコピーが含まれます。仮にn個のバイナリとm個のライブラリが存在し、各バイナリが各ライブラリを使用するとき、リンクを作成する際の作業量は<strong>m * n</strong>です。そのため、アーティファクトの数は最小限に抑えると良いでしょう。よくあるテクニックの1つが、<a href="https://www.busybox.net/FAQ.html#design">BusyBox</a>のような多機能ナイフ型の実行可能ファイルです。このアイデアは、同じ実行可能ファイルを、異なる名前を持つ複数のファイルとしてハードリンクするものです。プログラムは0番目のコマンドライン引数を参照することで、自らが呼び出されたファイル名を把握し、それをサブコマンドの名前として有効に利用できます。ただし、Cargoに特有の注意点として、<code class="language-text">./examples</code>と<code class="language-text">./tests</code>フォルダ内の各ファイルはデフォルトで新たな実行可能ファイルを作成します。</p>
<h2>コンパイルのモデル：マクロとパイプライン化</h2>
<p>しかし、Cargoにはそれ以上にスマートな機能があります。それはコンパイルのパイプライン化です。Cargoはクレートのコンパイルをメタデータとコード生成の段階に分け、メタデータの段階が終わるとすぐに依存するクレートのコンパイルを開始します。</p>
<p>このとき、手続きマクロ（とビルドスクリプト）との間に面白い関係が発生します。<code class="language-text">rustc</code>はクレートのメタデータを計算するために手続きマクロを実行する必要があります。これは手続きマクロがパイプライン化できないことや、手続きマクロが完全にコンパイルされてバイナリコードになるまで、その手続きマクロを使用するクレートがブロックされることを意味します。</p>
<p>一方、手続きマクロはRustコードをパースする必要がありますが、これはかなり複雑なタスクです。この機能を担うデファクトスタンダードのクレートである<code class="language-text">syn/serde</code>はコンパイルに長い時間がかかります（肥大化しているからではなく、単純にRustのパーシングが難しいからです）。</p>
<p>これは一般に、プロジェクトにおいて、コンパイル中のCPU稼働率のプロファイルに <code class="language-text">syn/serde</code> は大きく穴をあける傾向にあることを意味します。（訳注: syn/serde によって、 コンパイル中にCPUに対して大きく負荷がかかります）そのため、手続きマクロはそれが十分に活用される場合のみ使用し、<code class="language-text">cargo -Z timings</code>グラフで<code class="language-text">syn</code>の前にクレートを配置することがかなり重要です。</p>
<p>ただし、後者は難しい場合があります。手続きマクロの依存関係はいつの間にか増大する可能性があるからです。こうした依存関係はフィーチャーフラグに隠れていることが多く、それらのフィーチャーフラグが川下のクレートによって有効化されるケースが問題となります。以下の例を考えてみましょう。</p>
<p>便利なユーティリティ型、例えばSSO文字列が<code class="language-text">small_string</code>クレートに存在するとします。シリアル化を実装するには、実は継承は必要ないため（Stringへの委譲で十分です）、<code class="language-text">serde</code>との（任意の）依存関係を追加します。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[package]
name = &quot;small-string&quot;

[dependencies]
serde = { version = &quot;1&quot; }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>SSO文字列は非常に便利な抽象型なので、コードベース全体で使用されます。その後、例えばJSON APIを公開する必要がある葉のクレートに、<code class="language-text">serde</code>フィーチャーを持つ<code class="language-text">small_string</code>と、deriveフィーチャーを持つ<code class="language-text">serde</code>自体との依存関係を追加します。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[package]
name = &quot;json-api&quot;

[dependencies]
small-string = { version = &quot;1&quot;, features = [ &quot;serde&quot; ] }
serde = { version = &quot;1&quot;, features = [ &quot;derive&quot; ] }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ここで問題になるのは、<code class="language-text">json-api</code>が<code class="language-text">serde</code>の<code class="language-text">derive</code>フィーチャーを有効化するため、<code class="language-text">small-string</code>とその逆依存関係のすべてが<code class="language-text">syn</code>のコンパイルを待つ必要があることです。同様に、あるクレートが<code class="language-text">syn</code>のフィーチャーの一部にしか依存していなくても、クレートグラフ内の別の何かがすべてのフィーチャーを有効化すると、元のクレートにはそのフィーチャーも追加されます。</p>
<p>これは必ずしも破滅的な状況ではありませんが、依存関係グラフがフィーチャーの存在によって厄介なものとなり得ることが分かります。うれしいことに、<code class="language-text">cargo -Z timings</code>は問題の発生を気づきやすくしてくれます。もっとも、いったい何が間違っているのか明らかになるとは限りませんが。</p>
<p>手続きマクロは、もっと直接的にコンパイルを遅くする原因にもなります。マクロが大量のコードを生成する場合、コンパイルに一定の時間がかかります。というのも、一部のマクロは少量のソースコードを書くことを可能にしており、それ自体は害がないように感じられますが、そのコードが大量のロジックに拡大するのです。代表的な例はシリアル化です。筆者は、数値からJSONへの変換（とその逆）がコンパイルにおいて驚くほど大きな部分を占めていると気づきました。ここではクレートのグラフ全体について考えるのが役立ちます。シリアル化は、システムの境界の葉のクレートで実行するようにすべきです。システムの根幹の付近にシリアル化を導入すると、すべての中間クレートがビルド時間のコストを負担することになります。</p>
<p>いずれにせよ、面白いポイントは、手続きマクロは本質的にコンパイルが遅いわけではないことです。むしろ、ほとんどの手続きマクロはRustをパースする必要があるか、あるいは多くのコードを生成するために遅くなっています。ときには、マクロはsynなしでパースできる単純な構文を受け入れ、それに基づいてわずかなRustコードを生成する場合もあります。有効なRustの生成は、そのパーシングに比べれば全く複雑ではありません。</p>
<h2>コンパイルのモデル：モノモーフィゼーション</h2>
<p>以上でクレートレベルのマクロに関する問題はカバーしたので、コードレベルの問題を詳しく見ていきましょう。主に注目するのはジェネリクスです。ジェネリクスがどのようにコンパイルされるかを理解するのは非常に重要です。Rustの場合はモノモーフィゼーションによって実現されます。以下のありふれたジェネリック関数について考えてみましょう。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">fn frobnicate&lt;T: SomeTrait&gt;(x: &amp;T) {
   ...
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>Rustがこの関数をコンパイルするとき、実際には機械語は出力しません。代わりに、関数の本体の抽象表現をライブラリに保存します。実際のコンパイルは、関数を特定の型の変数で<strong>インスタンス化</strong>したときに行われます。直感的な理解のためにC++の用語を借用するならば、 <code class="language-text">frobnicate</code>は「テンプレート」です。これは変数Tに具体的な型が代入された際に実際の関数を生成します。</p>
<p>言い換えると、以下のケースでは</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">fn frobnicate_both(x: String, y: Widget) {
  frobnicate(&amp;x);
  frobnicate(&amp;y);
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>機械語のレベルで2つの異なる<code class="language-text">frobnicate</code>のコピーが生成されます。両者は変数の詳細な処理が違っていますが、それ以外は同一です。</p>
<p>これではとても困ると思いませんか？どうやら大規模なジェネリック関数を書くと、それをインスタンス化するために複数の型のコードを少し書いただけで、コンパイラに大きな負荷がかかるようです。</p>
<p>ここで残念なお知らせがあります。現実は想像よりもはるかに悪いのです。型が異なっていない場合さえ、重複は発生します。例えば、以下のようなダイヤモンド型の4つのクレートがあるとしましょう。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">   +- B -+
  /       \
A           D
  \       /
   +- C -+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">frobnicate</code>はAで定義され、BとCで使用されます。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// A
pub fn frobnicate&lt;T: SomeTrait&gt;(x: &amp;T) { ... }

// B
pub fn do_b(s: String) { a::frobnicate(&amp;s) }

// C
pub fn do_c(s: String) { a::frobnicate(&amp;s) }

// D
fn main() {
  let hello = &quot;hello&quot;.to_owned();
  b::do_b(&amp;hello);
  c::do_c(&amp;hello);
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このケースでは<code class="language-text">frobincate</code>を<code class="language-text">String</code>でしかインスタンス化していませんが、モノモーフィゼーションはクレートごとに行われるため、コンパイルは2回となります。BとCは別々にコンパイルされ、それぞれに<code class="language-text">do_*</code>関数の機械語が含まれるため、<code class="language-text">frobnicate&lt;String&gt;</code>を必要とします。最適化が無効な場合、<code class="language-text">rustc</code>はテンプレートのインスタンス化を直接の依存関係と共有できますが、親が共通の依存関係とは共有しません。最適化が有効な場合、<code class="language-text">rustc</code>は直接の依存関係とさえモノモーフィゼーションを共有しません。</p>
<p>言い換えると、Rustのジェネリクスによって、多くのクレートでコンパイル回数が意図せず二次関数的に増加する恐れがあります。</p>
<p>これ以上悪いことがあり得るのかと考えているなら、その答えはイエスです。筆者は、モノモーフィゼーションの実際の単位はコード生成単位だと考えており、そのため重複は1つのクレート内でも発生する可能性があります。</p>
<h2>インスタンス化に注意</h2>
<p>ジェネリクスには、重複に加えて、コンパイル時間を利用者に転嫁する問題もあります。ジェネリック関数のコンパイル時間のコストの大部分はその機能を使用するクレートが負担する一方、定義が記述されたクレートはコードを一切生成せず、コードの型をチェックするだけです。何が、どこで、なぜインスタンス化されるかが全く明確でない場合（<a href="https://github.com/rust-analyzer/rust-analyzer/issues/10065">例</a>）もあるため、ジェネリックAPIを直接追跡するのは困難です。</p>
<p>しかし、うれしいことに、その作業は必要ありません。そのためのツールがあるからです。<a href="https://github.com/dtolnay/cargo-llvm-lines">cargo llvm-lines</a>は、特定のクレートでどのようなモノモーフィゼーションが起きているかを教えてくれます。</p>
<p>以下は<a href="https://github.com/rust-analyzer/rust-analyzer/issues/10065">最近の調査に基づく例</a>です。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ cargo llvm-lines --lib --release -p ide_ssr | head -n 12
 Lines          Copies        Function name
  -----          ------        -------------
  533069 (100%)  28309 (100%)  (TOTAL)
   20349 (3.8%)    357 (1.3%)  RawVec&lt;T,A&gt;::current_memory
   18324 (3.4%)    332 (1.2%)  &lt;Weak&lt;T&gt; as Drop&gt;::drop
   14024 (2.6%)    332 (1.2%)  Weak&lt;T&gt;::inner
   11718 (2.2%)    378 (1.3%)  core::ptr::metadata::from_raw_parts_mut
   10710 (2.0%)    357 (1.3%)  &lt;RawVec&lt;T,A&gt; as Drop&gt;::drop
    7984 (1.5%)    332 (1.2%)  &lt;Arc&lt;T&gt; as Drop&gt;::drop
    7968 (1.5%)    332 (1.2%)  Layout::for_value_raw
    6790 (1.3%)     97 (0.3%)  hashbrown::raw::RawTable&lt;T,A&gt;::drop_elements
    6596 (1.2%)     97 (0.3%)  &lt;hashbrown::raw::RawIterRange&lt;T&gt; as Iterator&gt;::next</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この表は各ジェネリック関数について、生成されたコピーの数とその合計サイズを示しています。サイズは関数のエンコードに必要なllvm irの行数として非常に大ざっぱに測定されています。有益な情報としては、llvmはジェネリック関数を持っていません。関数テンプレートをインスタンス化によって実際の関数に変えるのはrustcの仕事です。</p>
<h2>インスタンス化のコントロール</h2>
<p>モノモーフィゼーションの落とし穴が分かれば、大まかな対策も明らかになります。それはジェネリックコードをクレート間の境界に設置しないことです。大規模なシステムを設計するときは、一連のコンポーネントとして設計したうえで、各コンポーネントが具体的な作業を行い、ジェネリックでないインターフェースを持つようにします。</p>
<p>型安全性や作業効率を改善するためにジェネリックインターフェースが必要な場合は、必ずインターフェースのレイヤーを薄くし、ジェネリックでない実装にすぐに委譲するようにします。ここで埋め込むべき関数の典型的な例は、<code class="language-text">str::fs</code>モジュールに記述され、パス上で動作するさまざまな関数です。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">pub fn read&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; io::Result&lt;Vec&lt;u8&gt;&gt; {
  fn inner(path: &amp;Path) -&gt; io::Result&lt;Vec&lt;u8&gt;&gt; {
    let mut file = File::open(path)?;
    let mut bytes = Vec::new();
    file.read_to_end(&amp;mut bytes)?;
    Ok(bytes)
  }
  inner(path.as_ref())
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>外側の関数はパラメータ化されており、効率良く使用できますが、川下のあらゆるクレートで毎回コンパイルされます。とはいえ、この関数は非常に小規模で、stdでコンパイルされるジェネリックでない関数にすぐ移譲されるので問題ありません。</p>
<p>引数としてパスを必要とする関数を記述する場合、<code class="language-text">&amp;Path</code>を利用するか、あるいは<code class="language-text">impl AsRef&lt;Path&gt;</code>を利用してジェネリックでない実装へ委譲しましょう。APIの効率が気になって、implトレイトを利用するくらいなら、<code class="language-text">inner</code>をうまく使うべきです。関数を呼び出すのに使用される構文と同様に、コンパイル時間も効率の大きな要素となります。</p>
<p>第2の典型的なケースはクロージャです。基本的に<code class="language-text">&amp;dyn Fn()</code>を<code class="language-text">impl Fn()</code>よりも優先しましょう。パスの場合と同様に、<code class="language-text">impl</code>ベースの優れたAPIを薄いラッパーとして、<code class="language-text">dyn</code>ベースの実装が大部分の作業を実施するのが良いでしょう。</p>
<p>これに関する別のアイデアは、「ジェネリックなインラインのホットパスと、コンクリート（具体的）なアウトラインのコールドパス」です。<a href="https://lib.rs/crates/once_cell">once_cell</a>クレートには、以下のような面白いパターンが記述されています（以下は簡略化済み。<a href="https://github.com/matklad/once_cell/blob/f92720a4cac370c117e9d565aebbae2b8de51852/src/imp_std.rs#L86">実際のソース</a>はこちら）。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">struct OnceCell&lt;T&gt; {
  state: AtomicUsize,
  inner: Option&lt;T&gt;,
}

impl&lt;T&gt; OnceCell&lt;T&gt; {
  #[cold]
  fn initialize&lt;F: FnOnce() -&gt; T&gt;(&amp;self, f: F) {
    let mut f = Some(f);
    synchronize_access(self.state, &amp;mut || {
      let f = f.take().unwrap();
      match self.inner {
        None =&gt; self.inner = Some(f()),
        Some(_value) =&gt; (),
      }
    });
  }
}

fn synchronize_access(state: &amp;AtomicUsize, init: &amp;mut dyn FnMut()) {
  // One hundred lines of tricky synchronization code on atomics.
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この<code class="language-text">initialize</code>関数は2回ジェネリックになります。最初に<code class="language-text">OnceCell</code>が、保存された値の型とともに変数化され、次に<code class="language-text">initialize</code>がジェネリックなクロージャ変数を受け取ります。<code class="language-text">initialize</code>の仕事は、（たとえ同時に多くのスレッドから呼び出されたとしても）最大で1つのfしか実行されないようにすることです。この相互排他タスクは、コンパイル時間を改善するために、実際は具体的なTやFに依存せず、ジェネリックではない<code class="language-text">synchronize_access</code>として実装されています。理想的には<code class="language-text">init: dyn FnOnce()</code>引数を使用したいのですが、現在のRustでは記述できないのが欠点です。このケースでは、<code class="language-text">let mut f = Some(f) / let f = f.take().unwrap()</code>が標準的な次善の策となります。</p>
<h2>結論</h2>
<p>大体こんなところでしょうか！要点を振り返っておきましょう。</p>
<p>ビルド時間はプロジェクトに取り組む人間のトータルな生産性に大きく影響します。ビルド時間の最適化はエンジニアリング課題としては単純で、ツールも存在します。恐らく難しいのは、取り組みが少しずつ後退しないようにすることです。この記事がそのための十分なモチベーションとインスピレーションになるように願っています。大まかな目安として、20万行のRustプロジェクトのビルド時間を妥当な範囲に収めるためにある程度最適化すれば、GitHub Actions上のCIの所要時間は約10分となるはずです。</p>
<p><a href="https://old.reddit.com/r/rust/comments/pid70f/blog_post_fast_rust_builds">/r/rust</a>での議論はこちらです。</p>
<p>本記事は<a href="https://matklad.github.io/2021/09/05/Rust100k.html">One Hundred Thousand Lines of Rust</a>シリーズの一部です。</p>]]></content:encoded></item><item><title><![CDATA[中身のないnpmパッケージ「-」が70万回以上ダウンロードされる— その理由とは]]></title><description><![CDATA[名前が1文字の「-」という謎めいたnpmパッケージは、2020年にレジストリで公開されて以来、70万回以上ダウンロードされています。 さらに、このパッケージには有効なコードが含まれていません。では、…]]></description><link>https://postd.cc/empty-npm-package-has-over-700-000-downloads-heres-why/</link><guid isPermaLink="false">https://postd.cc/empty-npm-package-has-over-700-000-downloads-heres-why/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[npm]]></category><category><![CDATA[JavaScript]]></category><category><![CDATA[NodeJS]]></category><category><![CDATA[オープンソース]]></category><category><![CDATA[OSS]]></category><pubDate>Mon, 13 Dec 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>名前が1文字の「-」という謎めいたnpmパッケージは、2020年にレジストリで公開されて以来、70万回以上ダウンロードされています。</p>
<p>さらに、このパッケージには有効なコードが含まれていません。では、一体なぜこれほど多くダウンロードされているのでしょうか？</p>
<h2>npmパッケージ「-」の中身</h2>
<p>「-」というnpmパッケージは、2020年初めにnpmレジストリで公開されてから、約72万回もダウンロードされてきました。</p>
<p>パッケージのバージョンは0.0.1のみで、ファイルは3つです。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">tar tvf 0.0.1/--0.0.1.tgz

package/dist/index.js
package/package.json
package/README.md</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これらのファイルは主にマニフェスト（package.json）とindex.jsで、特に面白い点はなく、スケルトンコードが書かれているだけです。</p>
<p>マニフェストはdevDependenciesでパッケージを導入し、「ts-node」コンポーネントのコマンドを呼び出していますが、それ以上のことは書かれていません。今のところ、実質的にはデッドコードです。
<img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/npm-package-contents.jpg">
<em>「-」のindex.jsファイルとマニフェストファイル（package.json）（BleepingComputer）</em></p>
<h2>50以上のパッケージが「-」を使用</h2>
<p>さらに不思議なこともあります。</p>
<p>無用同然のパッケージ「-」は50以上のnpmパッケージで、明確な説明なしに依存関係として使用されているのです。
<img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/dash-package-dependencies.jpg">
<em>56のパッケージがnpmパッケージ「-」を使用（npmjs.org）</em></p>
<p>しかし、ほとんどの依存関係は週に数十回しかダウンロードされていません。</p>
<p>それでは、なぜ「-」は約72万回もダウンロードされているのでしょうか？</p>
<p>おそらく、このパッケージが呼び出される理由は、npmコマンドをターミナルから実行する際のタイプミスでしょう。</p>
<p>例えば、「somepackage」というnpmパッケージをインストールするときは、以下を実行する必要があります。</p>
<p><code class="language-text">npm i somepackage</code></p>
<p>フラグを指定するときに、例えば次のようなミスをしたとします。</p>
<p><code class="language-text">npm i - someFlag somepackage</code></p>
<p>「-」とsomeFlagの間にスペースがあります。そのため、「-」という名前のパッケージが存在する場合、npm によってそのパッケージがインストールされます。</p>
<p>つまり、このパッケージが何十万回もダウンロードされたのは、開発者のタイプミスによるものと考えられます。</p>
<p>同様に、コマンドラインを通じて<a href="https://docs.npmjs.com/specifying-dependencies-and-devdependencies-in-a-package-json-file#adding-dependencies-to-a-packagejson-file-from-the-command-line">package.json</a>に依存関係を追加するとき、誤って「-」が混入することは簡単に予想できます。</p>
<p>BleepingComputerは、テストで「<a href="https://twitter.com/Ax_Sharma/status/1360311640621654016">somepackage</a>」と「<a href="https://twitter.com/Ax_Sharma/status/1360311640621654016">axsharma</a>」をnpmからダウンロードするため、以下のコマンドを実行しました。</p>
<p>ただし、意図的にタイプミスして、「--save」フラグの前に余計な「-」を入れました。</p>
<p><code class="language-text">npm install somepackage axsharma - --save</code></p>
<p>予想通り、実行後のpackage-lock.jsonファイルとnode_modules/フォルダには「-」パッケージが含まれています。このように現実の依存関係にも「-」が混入する可能性があります。</p>
<p><img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/bc-poc2.jpeg">
<em>生成されたnode_modulesフォルダとpackage-lock.jsonファイルには「-」パッケージが含まれる（BleepingComputer）</em></p>
<p>パッケージのREADME.mdファイルとnpmページは、いずれも「-」がスクリプトによって生成されたことを示しています。</p>
<p><img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/readme.jpg">
<em>「-」のREADMEファイル（BleepingComputer）</em></p>
<h2>「-」を作成した開発者のインタビュー</h2>
<p>BleepingComputerはパッケージの作成者<a href="https://www.npmjs.com/~parzhitsky">Dmitry Parzhitsky</a>氏を取材し、このパッケージを作成した理由などを質問しました。以下はその回答です。</p>
<p>「最初に言っておくと、このパッケージによって、誰かに害を与えるつもりは全くありません」とParzhitsky氏は語りました。パッケージは作成当時のnpmの命名規則に完全に準拠しており、テストとして作成されたものだと強く主張したのです。</p>
<p>「もともとパッケージを公開した理由は、『-』が<a href="https://github.com/npm/validate-npm-package-name#naming-rules">命名規則</a>に沿った有効なパッケージであるかを確認することでした。不思議なことですが、この名前は有効です。例えば『--』という名前のパッケージも公開できます」と彼は続けました。</p>
<p>Parzhitsky氏は、ダウンロード回数が異様に多い理由について、おそらく開発者のタイプミスだろうというBleepingComputerの仮説に同意しています。</p>
<p>さらに彼は、今のところ「-」には何の機能もないが、誤ってパッケージをインストールしたときにエラーメッセージを返すように修正するという意向を明確にしました。</p>
<p>Parzhitsky氏は「このパッケージの挙動は奇妙で、いくらか危険かもしれません。ですから、『-』や『g』、『D』などのパッケージを誤ってインストールしたと疑われる場合に警告を返す機能を導入する予定です」と述べて、私たちとのメールによるインタビューを締めくくりました。
<img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/github-issue.jpg">
<em>GitHubのイシューでは開発者が警告を導入する計画が公表されている</em></p>
<p>今のところ、「-」が悪意あるプログラムだと示すものは何もありませんが、開発者は誤って「-」などのパッケージをビルドに混入させないよう注意すべきだといえます。</p>
<p>その他、1文字の名前のパッケージや、npmコマンドに似た名前のパッケージとしては、<a href="https://www.npmjs.com/package/i">i</a>、<a href="https://www.npmjs.com/package/g">g</a>、<a href="https://www.npmjs.com/package/install">install</a>、<a href="https://www.npmjs.com/package/D">D</a>、<a href="https://www.npmjs.com/package/s">s</a>などが挙げられます。</p>
<p>つまり、誤って「npm i somePackage」ではなく「npm i i somePackage」とタイプした場合、somePackageに加えてiというパッケージもインストールされます。</p>
<p>「本当に問題なのは、これらのパッケージが気づかないうちにインストールされることです。誤ってnpm install - g my-packageを実行しても、目的のパッケージはインストールできます」</p>
<p>「後で別の場所からパッケージにアクセスしようとするまで、タイプミスの可能性には気づきません。それまでは『-』と『g』の両方がプロジェクトに混入しています」</p>
<p>「npmはコマンドと同じ名前のコンポーネントを禁止できるはずです（おそらく禁止すべきでしょう）」。Sonatypeのソフトウェア開発者である<a href="https://www.linkedin.com/in/mtfreeland/">Matt Freeland</a>氏は、BleepingComputerに情報を提供した後でこのように語りました。</p>
<p>さらにFreeland氏は、npm install の実行後に、インストールされたパッケージ名がそのままリストアップされず、「3つのパッケージを追加し、8つのパッケージを検査しました」といった簡単な成功メッセージが表示されることを指摘しました。</p>
<p>そして「インストールしたパッケージ名を成功メッセージに記載すれば、開発者が誤りに気づく可能性があります」と続けています。</p>
<p>最近はnpmなどのオープンソースレジストリがマルウェアや<a href="https://www.bleepingcomputer.com/news/security/spammers-flood-pypi-with-pirated-movie-links-and-bogus-packages/">害のあるコンテンツ</a>であふれる事態が再三にわたり発生しています[<a href="https://www.bleepingcomputer.com/news/security/npm-package-steals-chrome-passwords-on-windows-via-recovery-tool/">1</a>, <a href="https://www.bleepingcomputer.com/news/security/new-linux-macos-malware-hidden-in-fake-browserify-npm-package/">2</a>, <a href="https://www.bleepingcomputer.com/news/security/malicious-npm-packages-target-amazon-slack-with-new-dependency-attacks/">3</a>]。</p>
<p>開発者は、ターミナルにnpmコマンドを入力するとき（特にフラグを使用する場合）は、注意を払うべきです。また、自分のパッケージがなぜこのような謎めいたパッケージに依存しているのかを確認するのも良いでしょう。</p>
<p><em>※2021年8月4日午前7時15分（米国東部時間）更新：BleepingComputerがParzhitsky氏（「-」の開発者）に連絡したのは、本記事が公表されるかなり以前のことです。しかし、詳細な回答が返ってきたのは相当の時間が経ってからで、本記事を公表した後でした。そのため、本記事の一部を更新し、開発者の回答を追加しました。透明性を確保するため、元記事をアーカイブしたコピーを<a href="http://web.archive.org/web/20210803104122/https:/www.bleepingcomputer.com/news/software/empty-npm-package-has-over-700-000-downloads-heres-why/">Wayback Machine</a>で閲覧できるようにしています。</em></p>
<p>関連記事:</p>
<ul>
<li><a href="https://www.bleepingcomputer.com/news/security/npm-fixes-private-package-names-leak-serious-authorization-bug/">NPM fixes private package names leak, serious authorization bug</a></li>
<li><a href="https://www.bleepingcomputer.com/news/security/popular-coa-npm-library-hijacked-to-steal-user-passwords/">Popular 'coa' NPM library hijacked to steal user passwords</a></li>
<li><a href="https://www.bleepingcomputer.com/offer/deals/give-the-gift-of-learning-a-new-language-with-this-subscription/">Give the gift of learning a new language with this subscription</a></li>
<li><a href="https://www.bleepingcomputer.com/offer/deals/get-unlimited-access-to-210-top-mac-apps-for-42-this-black-friday/">Get unlimited access to 210 top Mac apps for $42 this Black Friday</a></li>
<li><a href="https://www.bleepingcomputer.com/offer/deals/read-edit-and-write-pdfs-with-apples-app-of-the-year/">Read, edit, and write PDFs with Apple's App of the year</a></li>
</ul>]]></content:encoded></item><item><title><![CDATA[JavaScriptのバンドルとトランスパイルが不要なモダンWebアプリ]]></title><description><![CDATA[筆者はES6以前のVanilla JSがあまり好きではありませんでした。
そこで、バニラJavaScriptをなるべく書かなくていいように、2000年代を通じてさまざまなアプローチを追求してきました…]]></description><link>https://postd.cc/modern-web-apps-without-javascript-bundling-or-transpiling/</link><guid isPermaLink="false">https://postd.cc/modern-web-apps-without-javascript-bundling-or-transpiling/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[JavaScript]]></category><pubDate>Mon, 15 Nov 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>筆者はES6以前のVanilla JSがあまり好きではありませんでした。
そこで、バニラJavaScriptをなるべく書かなくていいように、2000年代を通じてさまざまなアプローチを追求してきました。最初はRJS（Ruby-to-JavaScript）、次はCoffeeScriptでした。どちらのアプローチも、バニラJavaScriptより楽しく書けるソースコードを、ブラウザが実行できるバージョンのJavaScriptへトランスパイルするものです。ある程度は、うまくいっていました。</p>
<p>とはいえ、これは明らかにその場しのぎの手段に過ぎず、ブラウザがより洗練されたJavaScriptを理解できる日を待ちわびていたのです。ただ、そんな日が来ることはなく、永久にその場しのぎでやり過ごすのかと思われる時期がしばらく続きました。</p>
<p>しかし、幸いなことにJavaScriptは改善を続け、2015年にはES6の仕様が確定し飛躍的な進歩を遂げました。そのかなり前から（そして確定後もしばらくの間）Babelトランスパイラによって未来のJavaScriptであるES6を書くことができました。</p>
<p>これは素晴らしいことでした。さまざまなブラウザがES6のサポートを開始する前から、大幅に改善されたJavaScriptでプログラムを書くことができたのです。まるでズルをしているような気分でした。何の対価も支払うことなく、得をしているように感じたのです。とはいえ、それは必ずしも正しくありませんでした。</p>
<p>Babelでトランスパイルが行われるようになったことで、複雑極まりないパイプラインやツールが増え続けることになりました。未来のJavaScriptは無償で書けるわけではなく、複雑性が増大し続けるという代償を伴っていたのです。目指すゴールがこれではないことは明らかでした。</p>
<p>とはいえ、webpackなどのツールによって、この変化に対応できたのはありがたいことです。webpackは複雑ですが、それを差し引いても価値があると思えるものでした。そこで筆者は、2016年に<a href="https://github.com/rails/webpacker/">Webpacker</a>を作成し、2017年にはRailsでJavaScriptを管理するためのアプローチとしてWebpackerを採用した<a href="https://weblog.rubyonrails.org/2017/2/23/Rails-5-1-beta1/">Rails 5.2</a>をリリースしました。</p>
<p>それから5年が経ち、ついに開発現場の状況は変わりました。筆者はもはや、新しく登場したほとんどのアプリケーションにとって、複雑さに目をつぶってまでwebpackを使い続ける価値があるとは考えていません。ただし、webpackは完全に終わったわけではなく、依然として一部のアプリケーション（たとえばReactなど）で利用するのは理にかなっています。あくまでRailsにとっては優れたデフォルトツールではなくなったということです。</p>
<p>最初の決定的な変化は、すべての主要なブラウザでES6がサポートされるようになったことです。Chrome、Edge、Safari、FirefoxはいずれもES6を完全にサポートしています。最後に残ったのはIE11でしたが、<a href="https://www.onmsft.com/news/microsoft-end-support-for-ie11-on-june-2022">Microsoftは今年、ありがたいことにサポート終了を宣言しました</a>。</p>
<p>その結果、ES6をブラウザで実行するために、トランスパイルによって別のコードに変換する作業が必要なくなりました。ES6はそのままで問題なく実行され、変更は不要です。これは非常に大きな進歩です。</p>
<p>第二の決定的な変化はHTTP2が普及したことです。HTTP2では、1つの大規模なファイルを送信する代わりに、多くの小さなファイルをさほどのデメリットもなく送信できるようになりました。1回の接続で、必要なレスポンスをすべて多重送信できるのです。複数の接続を管理したり、複数のSSLハンドシェイクの費用を支払ったりする必要はありません。これは、すべてのJavaScriptを1つのファイルにバンドルしても、パフォーマンス上のメリットはあまりないことも意味します（ツリーシェイキングのメリットはまだありますが）。</p>
<p>実際、単独の大規模なバンドルの利用は、今や開発者の作業効率（バンドルにかかる時間が長いなど）以外にも複数のデメリットがあります。例えば、すべてのJavaScriptモジュールを1つのファイルにバンドルすると、1つのモジュールが変更されただけでバンドル全体が無効となってしまいます。この場合、ブラウザがバンドル全体を改めてダウンロードし、再びすべてをパースする必要があります。これはよろしくありません。</p>
<p>ちなみに、各モジュールを分ければ、1個のモジュールが無効となっても他のモジュールには影響しません。モジュールが20個あり、1個だけが変更される場合、他の19個はキャッシュされたままです。こうしたキャッシュの仕組みは、パフォーマンスの改善に熱心な人にとっては特にありがたいでしょう。</p>
<p>しかし、それ以上に強調しておきたいのは、バンドルする理由がパフォーマンスのためだけだったとしたら、今後バンドラーは一切不要になることです。シンプルに各モジュールを独立したファイルとして直接ブラウザに提供すれば済むのです。</p>
<p>どういうことか分かりますか？書きやすいJavaScriptを書くためのトランスパイルも、すべてのモジュールをパッケージ化するためのバンドルも必要ありません。つまり、ソースコードを別の何かに変換するためのJavaScriptツールチェーンは不要なのです。そもそも複雑性そのものが取り払われつつあるのです。</p>
<p>上記2つの決定的な変化に加え、パラダイムが変わる最後の一押しは、インポートマップです。インポートマップは、ES6（別名ESM）のモジュールについて、論理参照を可能にします。これまでの明示的なファイル参照方法の問題は、ダイジェスト化されたファイル名を利用した、キャッシュを長期間持続する標準的なアプローチとの相性が悪いことでした。</p>
<p>例えば、<code class="language-text">main-a6d26cef87d241eba5fa.js</code>のようなファイル名において、最後の英数字の部分はファイル全体のダイジェストを表しています。ダイジェストは各ファイルに固有で、ファイルが変更されるとダイジェストも変わります。同じファイルのダイジェストは決して変わらないため、ブラウザはファイルとダイジェストを永久にキャッシュすることができるわけです。もちろん、ファイルが変更されれば、ファイル名も新しくなります。このことは、キャッシュの有効期限をコントロールし、優れたパフォーマンスを実現する上でとても重要です。</p>
<p>しかし、もし50個のファイルが存在し、そのすべてについて<code class="language-text">&quot;import { Controller } from &#39;./javascript/stimulus-a6d26cef87d241eba5fa.js&#39;&quot;</code>のようなimport文をプログラムの初めに書く必要があるとすればどうでしょうか。きっとうんざりするはずです。Stimulusに依存する箇所を変更するたびに、ファイルをひとつずつ更新しなければなりません。しかも、これらのファイルは個別に無効となるのです。</p>
<p>この問題を解決するのが<a href="https://github.com/WICG/import-maps">インポートマップ</a>です。<a href="https://caniuse.com/?search=importmap">この機能はすでにChromeとEdgeに搭載されています</a>。Firefoxも搭載を検討中のようです。Safariはインポートマップに全く言及していませんが、心配は無用です。<a href="https://github.com/guybedford/es-module-shims">完全な実行機能を持つshim</a>を利用して、ESMをサポートするすべてのブラウザ（ES6をサポートするすべてのブラウザに該当）にインポートマップのサポートを導入できます。</p>
<p>インポートマップではインポートの対応関係を定義できます。つまり、<code class="language-text">&quot;./javascript/stimulus-a6d26cef87d241eba5fa.js&quot;</code>に代わって単に<code class="language-text">&quot;stimulus&quot;</code>と記載し、インポートマップは<code class="language-text">&quot;stimulus&quot;: &quot;/javascript/stimulus-a6d26cef87d241eba5fa.js&quot;</code>とします。Stimulusを変更しても、参照文ではなくマップを変更するだけで済みます。</p>
<p>とはいえ、インポートマップを手作業でメンテナンスするのは少々手間がかかります。そこで、筆者はRails向けに<a href="https://github.com/rails/importmap-rails/">importmap-rails</a>というgemを新たに作成しました。このgemでは、プログラムでマップを構築できます。shimも搭載されているため、すべてのブラウザで機能します。さらに、使い慣れた信頼性の高いアセットパイプラインエンジンのSprocketsを利用して、ダイジェスト作業を実施します。まさに完全なパッケージです。</p>
<p>トランスパイラとバンドラーが不要であるのに加え、インポートマップを生成できれば、Node.jsをローカル環境にインストールすることもなく、最新で素晴らしいWebアプリの開発環境を整えることができます。</p>
<p>Rails向けの<a href="https://hotwired.dev/">Hotwire</a> gemは、<a href="https://github.com/hotwired/stimulus-rails">Stimulus</a>と<a href="https://github.com/hotwired/turbo-rails">Turbo</a>の両方について、上記の設定に依存するように変更されています。このgemは、プログラムによるアクセスを利用してバックグラウンドでインポートマップの設定を行うため、application.jsにモジュールを直接インポートできます。</p>
<p>このように、膨大な量の複雑な作業をすっかりなくしてしまうことで、開発体験は言葉にできないほど劇的に変化します。まるで生まれ変わったようです。しかし、依然として未解決の課題や妥協点も残っています。</p>
<p>第一に、上記のとおり、JSXをコンパイルして利用するReactなど人気フレームワークの一部では、これまで紹介してきた技術は（今のところは？）いずれもうまくいきません。明示的なトランスパイルやコンパイルのステップが必要である場合、トランスパイラやコンパイラが求められるのは明らかです。これでは振り出しに戻ってしまいます。</p>
<p>第二に、Action Text、Active Storage、Action Cableなどの機能については、Rails上でJavaScriptを併用しつつ、HotwireをRubyの gemとアセットパイプラインで利用することはできますが、他にも改善が必要なJavaScriptエコシステムはまだ大量に残っています。</p>
<p>このエコシステムは、UMD（Node.jsが使用している旧来のパッケージングシステム）の代わりにESMパッケージを公開する必要があります。とはいえ、<a href="https://www.skypack.dev/">skypack.dev</a>などのサービスは、UMDパッケージをESMに変換することで橋渡しとなるかもしれません。</p>
<p>Railsは、package.jsonファイルを使用し、npmを通じてパッケージを管理しない場合、これらのパッケージに依存し、更新を行う方法を見つけなければなりません。いくつかアイデアはあるものの、まだ具体化には至っていません。それまでの間は、単純にこれらのESMパッケージをダウンロードして、vendorディレクトリにローカルで保存すると良いでしょう。</p>
<p>このように、これまで紹介した技術はいずれも有望で、またES6、HTTP2、インポートマップの普及は飛躍的な進歩を実現しましたが、webpack（とWebpacker）を必要とするアプリが依然として数多く存在するのは明らかです。しかし、それは問題ではありません。私たちは無駄をなくすことで前進してきました。webpackやWebpackerはまだ完全にはなくなりませんが、不要になった人は大いに満足するでしょう。</p>
<p>この基本的な考え方に反する新たなエビデンスが出てこない限り、Rails 7.0のデフォルト設定はインポートマップに基づくものとし、Webpackerによるアプローチはオプションの選択肢にとどめる予定です。</p>
<p>複雑化したフロントエンドを修正し、シンプルな状態に回帰する動きは非常に遅れていました。しかし、ES6、HTTP2、インポートマップがまさにそれを実現してくれるでしょう。本当にうれしい限りです。</p>]]></content:encoded></item><item><title><![CDATA[CDNは5時間で開発できる]]></title><description><![CDATA[「CDN」（content delivery network）という言葉からは、Googleのような大企業がいくつもの巨大なハードウェアを管理し、1秒当たり何百ギガビットものデータを処理する様子が想…]]></description><link>https://postd.cc/the-5-hour-cdn/</link><guid isPermaLink="false">https://postd.cc/the-5-hour-cdn/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[CDN]]></category><pubDate>Mon, 18 Oct 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>「CDN」（content delivery network）という言葉からは、Googleのような大企業がいくつもの巨大なハードウェアを管理し、1秒当たり何百ギガビットものデータを処理する様子が想像されます。しかし、CDNは単なるWebアプリケーションです。私たちのイメージとは違いますが、それが事実です。8年前に買ったノートパソコンを使って、コーヒーショップの席に座りながらでも、きちんと機能するCDNを構築できます。この記事では、これから5時間でCDNを開発しようとするときに、<a href="https://github.com/fly-apps/nginx-cluster">直面するかもしれないこと</a>を紹介します。</p>
<p>まずはCDNの機能を明らかにしておきましょう。CDNはセントラルリポジトリ（通称：<code class="language-text">オリジン</code>）からファイルを吸い上げ、ユーザーに近い場所でコピーを保存します。初期のオリジンはCDNのFTPサーバーでした。現在、オリジンは単なるWebアプリとなり、CDNはプロキシサーバーとして機能しています。つまり、私たちが構築しようとしているCDNとは分散キャッシングプロキシです。</p>
<h2>プロキシによるキャッシュ</h2>
<p>HTTPが定義するキャッシュ機能は<a href="https://portswigger.net/research/practical-web-cache-poisoning">非常に細かく複雑で</a>、取っつき難いものです。ですから、一からから構築したい欲求は抑えて、他の人が作ってくれたものを利用しましょう。</p>
<p>CDNにはいくつかの選択肢があります。<a href="https://varnish-cache.org/">Varnish</a>（スクリプト、Edge Side Includes、開発者ブログあり）、<a href="https://trafficserver.apache.org/">Apache Traffic Server</a>（導入すれば、今年新たにATSを採用する唯一のチームとなるでしょう）、<a href="https://www.nginx.com/">NGINX</a>（当社も既に利用しています）のどれを利用しても構いません。しかし、これだけは断言できますが、どれを選んでも使いこなすのは大変です。全部試してみて、一番使いやすいものを選びましょう。</p>
<p>（NetlifyはATSで構築されています。CloudflareはNGINX、FastlyはVarnishを利用しています。）</p>
<p>これから構築するCDNは、基本的な水準には達していません。しかし、全く使えないものでもありません。やるべきことは、昔ながらのRailsで開発し、複数の都市で実行するだけです。もしオーストラリアのユーザーをシドニーのサーバーに、チリのユーザーをサンティアゴのサーバーに誘導できれば、それをCDNと呼んで差し支えないでしょう。</p>
<h2>トラフィックのルーティング</h2>
<p>ユーザーを最寄りのサーバーにルーティングするという問題に対しては、基本的に3つの選択肢があります。</p>
<ol>
<li>エニーキャスト：ルーティング可能なアドレスのブロックを取得し、BGP4を通じて複数箇所に対して転送します。あとはTwitterで「コミュニティ」や「ルートリフレクタ」について詳しいふりをしていましょう。代わりにインターネットがルーティングを済ませてくれます。この方法のデメリットは、難易度が高く、インターネットに任せてもうまくいかない場合があることです。メリットは、知ったかぶりできることくらいでしょうか。</li>
<li>DNS：特殊なDNSサーバーを稼働し、IPジオロケーションに基づく特定のサーバーのアドレスを返します。デメリットは、インターネットにおいて、位置を特定できるDNSソースアドレスの利用が減っていることです。メリットとしては、助けを借りずにどこにでも導入できます。</li>
<li>ゲームのサーバーと同様の方式：複数のサーバーにpingを送り、ベストなサーバーを利用します。デメリットとしてはクライアントが必要になります。しかし、あなたはクライアントを持っていないので、ここでは関係ありません。</li>
</ol>
<p>通常、この3つの選択肢のうち（1）と（2）をそれぞれ少しずつ利用することになるでしょう。DNSのロードバランシングは非常にシンプルです。自力で構築する必要はなく、DNSimpleなどの企業のサービスを利用してDNSをホストし、アドレスを返すための規則を定義するだけで済みます。</p>
<p>エニーキャストは難易度が高いです。説明すべきことがたくさんありますが、この記事ではこれ以上踏み込みません。その代わり、<a href="https://fly.io/">当社のサービス</a>を利用すれば、エニーキャストアドレス付きのアプリを2分で実装できます。当社の宣伝のようになってしまいましたが、事実でもあります。</p>
<p>CDNの開発に戻ります。NGINXをそれぞれの都市群に設定し、トラフィックのルーティングのためにDNSかエニーキャストを実行したら、もう90%完了です。しかし、残りの10%に数カ月かかります。</p>
<h2>インターネットの障害</h2>
<p>深海の底に敷き詰められた海底ケーブルは、<a href="https://www.theguardian.com/business/2008/feb/01/internationalpersonalfinancebusiness.internet">常に近くを航行する船に切断される危険にさらされています</a>。とはいえ、陸が海に比べて安全というわけではありません。昔のネットワーク技術者は、「ショベルでうんと深く掘ると、バックボーン（回線）がダメになる」とよく口ずさんでいたものです。回線が切断される懸念は、サーバー1台を1カ所で稼働させるだけならあまり気にならないでしょう。2台以上稼働すると徐々に気になってきます。世界中でサーバーを稼働するとなると心配で夜も眠れません。</p>
<p>しかし、幸いにも、1つのNGINXを複数の都市で稼働すれば、大きな冗長性をすぐに確保できます。サーバーの1つが何らかの理由でダウンしたとしても、多くのサーバーにトラフィックを送信可能です。1台のサーバーがオフラインになっても、残りのサーバーは引き続きほとんどのユーザーにサービスを提供できます。</p>
<p>これを実現するための作業は、退屈ですが簡単です。まずはヘルスチェックを行います（ちなみに、CDNのリージョンがダウンすると通常は通信速度が遅くなります。そのため、ヘルスチェックで検知できるはずです）。すると、NGINXのサーバーがダウンしたタイミングが分かります。それに応じて、DNSを変更するスクリプトを実行したり、BGPのルートを取り消したり（場合によっては単にそのリージョンのBGP4サービスを停止したり）します。</p>
<p>これはサーバーの障害なので発見するのは簡単ですが、インターネットの障害は発見しづらくなります。複数のロケーションから外部のヘルスチェックを実施しなければならないからです。しかし、複数の視点を持つ、基本的なモニタリングは難しくありません。当社では<a href="https://www.datadoghq.com/product/synthetic-monitoring/">Datadog</a>と<a href="https://updown.io/">updown.io</a>を利用しており、<a href="https://fly.io/blog/building-clusters-with-serf/">独自の社内サービスも開発中です</a>。必要な情報は、<code class="language-text">cURL</code>で分かる情報と大差ないはずです。繰り返しになりますが、CDNに関して特に注意すべきことは、リージョンの通信速度が遅くなることであって、インターネットが完全に遮断されることではありません。</p>
<p>ちなみに、こうしたモニタリングのオプションは全て、他のデータセンターから自分のデータセンターへの通信をモニタリングするものです。データセンター間のトラフィックは、出発点としては悪くありませんし、通信量も膨大です。しかし、ユーザーはデータセンターに（おそらく）住んではいないため、代表的なトラフィックとは言えません。あなたのサイトが非常に人気なら、実際のクライアントの状況がよく分かるようなモニタリングが望ましいでしょう。そうしたニーズに応えて、何百もの企業が、通常は密かに埋め込まれたJavaScriptのバグという形態でRUM（リアルユーザーモニタリング）サービスを販売しています。私が好きなRUMはお酒のほうのラムですけどね。これをたくさん飲みながら、<a href="https://www.honeycomb.io/">Honeycomb.io</a>を利用して自分でモニタリング用のコードを追加します。</p>
<p>インターネットのくだらない問題には本当にうんざりします。しかし、幸いにも、多くの人がインターネットを利用する中で解決策を編み出しているため、この問題についてそれほど語る必要はありません。キャッシュの仕組みはもっと面白いものです。以下では「玉ねぎ（※後述参照）」についてお話ししましょう。</p>
<h2>黄金のキャッシュヒット率</h2>
<p>キャッシュの効率性の指標を「キャッシュ率」といいます。キャッシュ率は、オリジンからデータを読み込む場合に対して、キャッシュからデータを読み込む場合の割合を測定したものです。</p>
<p>キャッシュ率80%とは、「リクエストを受信したとき、80%はキャッシュからデータを提供できるが、残りの20%はリクエストをオリジンに転送しなければならない」という意味です。CDNのようなサービスを構築する場合、キャッシュ率が高いほうが良いです。</p>
<p>前述のGitHubリポジトリのリンクにアクセスすると、当社の<a href="https://github.com/fly-apps/nginx/">素朴なNGINX設定</a>ファイルで、サーバーの設定が分離された単独サーバーとなっていることに気づくかもしれません。これを20カ所で導入すると、20台の個別サーバーを所有していることになります。実にシンプルです。しかし、シンプルさの代償として、リージョンごとの冗長性がありません。20台のサーバーは全て、オリジンにリクエストを送信する必要があります。この構造は脆弱で、キャッシュ率は低くなるでしょう。もっと良い方法がほかにあるはずです。</p>
<p>各リージョンに2台目のサーバーを追加すれば、冗長性を簡単に高めることができます。しかし、これはキャッシュ率を大幅に低下させかねません。サーバーを1台のみにするメリットは、全てのユーザーに1つのキャッシュをホスティングすれば良い点です。サーバーが2台だと、オリジン1台当たりのリクエスト件数は2倍になり、キャッシュがないケースも倍増します。</p>
<p>この問題を解決するには、サーバー同士がコミュニケーションを取り、相手のサーバーがコンテンツをキャッシュしている場合はそれを要求できるようにすれば良いでしょう。そのための最も簡単な方法は、キャッシュシャードの作成です。データを分割し、各サーバーがその一部を保持するようにして、リクエストを受けたサーバーは適切な部分のキャッシュシャードを保持しているサーバーにリクエストを転送します。</p>
<p>これは複雑に思えますが、NGINXに搭載されたロードバランサーはハッシュベースのロードバランシングをサポートしています。この機能ではリクエストをハッシュ化し、サーバーが利用可能であると想定して「同じリクエスト」を同じサーバーに転送します。このブログ記事のホーム版をご覧の方は、こちらから<a href="https://github.com/fly-apps/nginx-cluster">すぐに使えるNGINXクラスタの例</a>を確認できます。このクラスタでは、ピアを発見し、URLをハッシュ化し、利用可能なサーバーを通じてリクエストを送信します。</p>
<p><img src="https://fly.io/blog/2021-03-16/consistent-hashing.png?2/3&#x26;centered"></p>
<p><code class="language-text">a.jpg</code>のリクエストがNGINXインスタンスに到達すると、全てのインスタンスがリクエストをクラスタ内の同じサーバーに転送します。<code class="language-text">b.jpg</code>についても同様です。この設定によって、サーバーはロードバランサーのプロキシとストレージの一部としての両方の機能を果たします。さらに先進的な機能をCDNに搭載したい場合は、これらのレイヤーを分離することもできます。</p>
<blockquote>
<h2>PRのためのちょっとした余談</h2>
<p>クラスタNGINXの例ではFlyを利用しています。当社は、Flyの機能は本当に素晴らしいと考えています。<a href="https://fly.io/blog/persistent-storage-and-fast-remote-builds/">永続ボリューム</a>はNGINXのアップグレード間もキャッシュ率を高水準に維持することに寄与します。<a href="https://fly.io/blog/incoming-6pn-private-networks/">暗号化されたプライベートネットワーキング</a>は、NGINX間の安全・簡単なコミュニケーションを実現し、<a href="https://twitter.com/colmmacc/status/1057018254940504064?lang=en">mTLSの複雑な設定</a>の手間を省きます。ビルトインのDNSサービスディスカバリーは、サーバーを追加・削除するときにクラスタを最新に保つのに役立ちます。こうした機能がCDNとあまりに完璧にマッチしているではないかと思われるかもしれませんね。それは当社がこれらの機能をCDN型のワークロード専用に構築したからです。
もちろん、上記の機能は全てFly以外でも実現できます。しかし、<a href="https://fly.io/docs/speedrun/">Flyなら簡単です</a>。</p>
</blockquote>
<h2>玉ねぎのレイヤー</h2>
<p>2つの真実をお伝えしましょう。高いキャッシュ率は善、インターネットは悪です。一石二鳥を好む人なら、キャッシュ率の問題と、インターネットのルーティングがうまくいかない問題を同時に解決できればありがたいと思うでしょう。どちらの問題の解決にも、インターネットがHTTPリクエストを雑に処理しないようにすることが必要となります。キャッシュ率を高めるには、コントロールできないインターネットは迂回して、適切に機能して信頼が置けるネットワークを通じてオリジンへのリクエストを送信することです。</p>
<p>CDNは通常、顧客のオリジンに近いリージョンへサーバーを設置しています。当社のNGINXの例をバージニア州に設定すれば、即座にAWSの最大のリージョン近くにサーバーを所有したことになります。そして、あなたには間違いなくAWSを利用している顧客がいるはずです。これが大規模で強力な独占企業に寄り添うメリットです。</p>
<p><img src="https://fly.io/blog/2021-03-16/proxy-region-to-origin.png?2/3&#x26;centered"></p>
<p>NGINXとプロキシを少し調整すれば、オリジンサーバーへのリクエストを全てバージニア経由で送信できます。これはうれしいことです。というのも、あなたのバージニアのサーバーと、顧客の<code class="language-text">us-east-1</code>（AWSのバージニア州北部リージョン）のサーバーの間には、インターネットに比べてデータ通信を妨げる罠が少ないからです。これで特定の顧客のリクエストを処理する単独の正式なサーバーの組み合わせが設定できました。</p>
<p>うれしいことに、上記の設定はキャッシュ率を改善するだけでなく、インターネットによるルーティングを回避することも可能です。さらに、追加のCDN機能の基礎としての役割も果たします。</p>
<p>CDNを選ぼうとすると、「シールディング」や「リクエスト集約」といった言葉を目にします。オリジンのシールディングとは通常、単に全てのトラフィックを所定のデータセンターを通じて送信することを意味します。オリジンサーバーへのトラフィックを最小化するだけでなく、自分のCDNリージョンが利用しているIPが分かる可能性が高いので、シンプルなL4ファイアウォール規則によってアクセスを制御できます。</p>
<p>また、リクエストの集約もオリジンのトラフィックを最小化できます。この方法は、多くのユーザーが同じコンテンツにアクセスしようとする大規模なイベントで特に有効です。10万人のユーザーが一斉に、<a href="https://fly.io/blog/the-5-hour-content-delivery-network/#">あなたが執筆した最新のブログ記事にアクセス</a>し、しかもその記事がまだキャッシュされていない場合、オリジンに10万件のリクエストが同時に送信される可能性があります。これはほとんどのオリジンが処理しきれないレベルのトラフィックです。この問題を解決するには、特定のURLを「ロック」し、1つのNGINXサーバーがリクエストをオリジンに送信している間、他のクライアントはファイルがキャッシュされるまで一時停止するようにすれば良いのです。当社のクラスタNGINXの例では、<a href="https://github.com/fly-apps/nginx-cluster/blob/main/nginx.conf#L114-L115">この設定はわずか2行で済みます</a>。</p>
<h2>それでも通信が遅いときは</h2>
<p>1つのリージョンを通じてリクエストを送信してキャッシュ率を高めるのは、ちょっとした裏技のようなものです。CDN全体の目的は、ユーザーのために速度を速めることにあります。オーストラリアからバージニアにリクエストを送れば、速度はほんの少しだけ速くなります。コンテンツをキャッシュしたNGINXサーバーからの応答は、ほぼ必ずオリジンサーバーよりも速いからです。しかし、これでも速度は遅く、満足とは言えません。</p>
<p>この問題は玉ねぎのレイヤーを増やすことで解決できます。</p>
<p><img src="https://fly.io/blog/2021-03-16/proxy-region-to-origin-2.png?2/3&#x26;centered"></p>
<p>オーストラリアからのリクエストを、シンガポールを通じてバージニアに送信すれば良いのです。オーストラリアからバージニアまでの14,624kmは光の速さでも時間がかかります。そこで、オーストラリアからの距離が4,300kmのシンガポールへリクエストを送信し、シンガポールのキャッシュを利用することで、はっきりと分かるような遅延を回避します。この場合、キャッシュが存在しないと、直接バージニアにリクエストを送信する場合より通信速度が少し遅くなります。しかし、ここでの差は「イライラするほどの遅さ」と「イライラするほどの遅さよりも150ミリ秒遅い」の違い程度のわずかなものです。</p>
<p>汎用的なCDNを構築している場合は、これは良い方法といえます。各リージョンのキャッシュデータを集積するいくつかの広域リージョンを設定すればよいのです。</p>
<p>汎用的なCDNではなく、単にアプリケーションの速度を速めたい場合、この解決策には不安があります。アプリケーションの一部を複数のリージョンに分散させるほうが良いでしょう。</p>
<h2>まとめ</h2>
<p>CDNの基本的な考え方は目新しいものではなく、簡単に理解できます。一方で、CDNの構築は従来、野心的なチームのための事業であり、個人の開発者が週末に手掛けるようなプロジェクトではありませんでした。</p>
<p>しかし今や、有用なCDNを構築するための基本要素をNGINXなどのツールで利用できるようになってずいぶん経ちました。<a href="https://github.com/fly-apps/nginx-cluster">自宅で前述のGitHubリポジトリを試した</a>方は、ここで取り扱っている最も複雑な設計のイテレーション、つまりリージョンごとの冗長性を有し、リクエストのリージョン間ルーティングの基本的な制御が可能な設計でさえも、ほとんどの場合はNGINXを設定するだけで済むことに気づいたでしょう。しかも、その設定もそれほど複雑ではありません。当社が追加した「コード」は、アドレスのプラグインに必要な<code class="language-text">bash</code>だけです。</p>
<p>これでCDNの出来上がりです。単純なキャッシュなら問題なくこなせます。ただし、複雑なアプリで利用するには足りない部分があります。</p>
<p>特に、この記事ではキャッシュの期限切れについて全く取り上げませんでした。CDNを利用するときに必ずと言っていいほど起きるのが、ローンチのリリースに恥ずかしいタイプミスがあり、気づくのが遅れ、あらゆるキャッシュサーバーに誤字入りのコピーが保存されることです。分散されたキャッシュの削除は、CDNにとって厄介で大きな問題です。この問題だけでまるまる1本記事が書けるでしょう。</p>
<p>CDNレイヤーはアプリの機能を追加する場所としても非常に優れています。画像の最適化、WAF、APIレート制限、ボット検知などの機能が利用できます。これらのテーマだけで10本記事が書けるでしょう。</p>
<p>最後にもう1点。前述のとおり、この記事は全体にバイアスがかかっています。当社がこのCDN設計を取り上げているのは、それをとても簡単に実現できるプラットフォームを当社が構築したからです（皆さんもぜひお試しください）。このプラットフォームの機能を利用すれば、FlyでCDNを容易に構築できるだけでなく、アプリケーション全体を簡単に配信することも可能です。エッジ配信用に設計されたアプリケーションは、CDNを全く必要としない場合もあります。</p>
<hr>
<p>詳細については<a href="https://community.fly.io/t/the-5-hour-cdn/946">こちら</a>までお問い合わせください。</p>
<p>最終更新日：2021年3月16日（*訳註　翻訳時の原文記載更新日）</p>]]></content:encoded></item><item><title><![CDATA[フロントエンドのテストは皆のためのもの]]></title><description><![CDATA[テストとは人によって反応が分かれるものの1つであり、大喜びする人もいれば、見ないようにして去ろうとする人もいます。あなたがどちらの側であるにせよ、ここではフロントエンドのテストは皆のためのものである…]]></description><link>https://postd.cc/frontend-testing-is-for-everyone/</link><guid isPermaLink="false">https://postd.cc/frontend-testing-is-for-everyone/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[JavaScript]]></category><category><![CDATA[デバッグ]]></category><category><![CDATA[まとめ]]></category><pubDate>Mon, 13 Sep 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>テストとは人によって反応が分かれるものの1つであり、大喜びする人もいれば、見ないようにして去ろうとする人もいます。あなたがどちらの側であるにせよ、ここでは<strong>フロントエンドのテストは皆のためのものである</strong>ということを説明します。実際、テストには多くの種類があり、それがテストに対して初めに恐れや混乱を感じる一因なのかもしれません。</p>
<p>この記事では、特に有名で広く利用されている種類のテストを扱います。なかには目新しいものはないと感じる読者の方もいらっしゃるかもしれませんが、少なくとも復習にはなるでしょう。どちらにせよ、筆者の目標は、この記事を通じて世の中のさまざまな種類のテストについて理解を深めてもらうことです。ここではユニットテスト、統合テスト、アクセシビリティテスト、ビジュアルリグレッションテストなどを一緒に見ていきます。</p>
<p>さらに、Mocha、Jest、Puppeteer、Cypressなど、各種類のテストに使用されているライブラリとフレームワークも紹介します。専門用語はあまり使わないようにしますので、ご心配は無用です。ただし、これから扱う事例を理解するには、ある程度フロントエンドの開発経験があったほうがいいでしょう。</p>
<p>それでは始めましょう。</p>
<h3>目次</h3>
<ul>
<li><a href="#h-what-is-testing">テストとは？</a></li>
<li><a href="#h-different-tests-look-at-different-parts-of-the-project">プロジェクトのどの部分をチェックするかはテストごとに異なる</a></li>
<li><a href="#h-unit-testing">ユニットテスト</a></li>
<li><a href="#h-integration-testing">統合テスト</a></li>
<li><a href="#h-end-to-end-e2e-testing">エンドツーエンド（E2E）テスト</a></li>
<li><a href="#h-accessibility-testing">アクセシビリティテスト</a></li>
<li><a href="#h-visual-regression-testing">ビジュアルリグレッションテスト</a></li>
<li><a href="#h-performance-testing">パフォーマンステスト</a></li>
<li><a href="#h-wrapping-up">まとめ</a></li>
</ul>
<h2 id="h-what-is-testing">テストとは？</h2>
<blockquote>
<p>「ソフトウェアのテストとは、テスト対象のソフトウェア製品またはサービスの品質に関する情報を利害関係者に提供するために行われる調査である」
-Cem Kaner, “<a href="http://kaner.com/pdfs/ETatQAI.pdf">Exploratory Testing</a>”（2006年11月17日）</p>
</blockquote>
<p><img src="https://i2.wp.com/css-tricks.com/wp-content/uploads/2021/05/24gR1Ckg.png?resize=1000%2C750&#x26;ssl=1"></p>
<p>テストの最も基本的な定義は、開発の可能な限り早い段階でエラーを発見するための自動化されたツールです。テストによって、本稼働前に問題を修正できます。またテストには、アクセシビリティなど、特定の観点からのチェック漏れを思い出させてくれる役割もあります。</p>
<p>要するに、フロントエンドのテストは、こちらの意図通りにユーザーがサイトを閲覧し、サイト上で機能を使用できるかを検証するものです。</p>
<p>フロントエンドのテストはアプリケーションのクライアントサイドのために存在します。例えば、フロントエンドのテストでは、「削除」ボタンを押すことで画面からアイテムが適切に削除されるかを確認できます。
一方、データベースから実際に削除されたかの確認は、別途バックエンドのテストでカバーします。
一言で言えば、フロントエンドのテストとはクライアントサイドのエラーを発見し、コードのデプロイ前に修正することです。</p>
<h2 id="h-different-tests-look-at-different-parts-of-the-project">プロジェクトのどの部分をチェックするかはテストごとに異なる</h2>
<p><img src="https://i0.wp.com/css-tricks.com/wp-content/uploads/2021/05/sbLag5lf.png?resize=1000%2C750&#x26;ssl=1"></p>
<p>テストの種類ごとに、プロジェクトのどの側面をカバー出来るのかは異なります。ですので、各種類の役割を理解することは重要です。種類ごとの目的を混同すると、テストスイートが乱雑で信頼できないものとなってしまいます。</p>
<p>理想的には、さまざまなタイプの潜在的な問題を明らかにするため、複数の異なる種類のテストを実施するのが良いでしょう。中には<strong>カバレッジ</strong>の分析機能がついたテストもあり、コードのどの程度の割合（%）をチェックできるかを明示できます。これは素晴らしい機能であり、カバレッジを100%にしようとする開発者もいますが、筆者はこの指標のみには頼りません。最も重要なのは、あり得るすべてのエッジケースをカバーし、考慮することです。</p>
<p>このことを念頭に置いて、さまざまな種類のテストに注目していきましょう。ちなみに、これらのテストを全て実施する必要はありません。大事なのは、テストを区別することができ、それによって特定の状況でどのテストを使用すべきかを理解することです。</p>
<h2 id="h-unit-testing">ユニットテスト</h2>
<ul>
<li><strong>レベル</strong>：低</li>
<li><strong>範囲</strong>：アプリケーションの関数とメソッドをテストする</li>
<li><strong>ツール候補</strong>：<a href="https://github.com/avajs/ava">AVA</a>、<a href="https://jasmine.github.io/">Jasmine</a>、<a href="https://jestjs.io/">Jest</a>、<a href="https://karma-runner.github.io/latest/index.html">Karma</a>、<a href="https://mochajs.org/">Mocha</a></li>
</ul>
<p>ユニットテストは、様々なテスト方法がある中での最も基本的な構成要素です。このテストでは個々のコンポーネントをチェックし、意図したとおりに機能するかを確認します。この種のテストはあらゆるフロントエンドのアプリケーションに必要不可欠です。なぜなら、コードベースとアプリの信頼性の大幅な向上につながるためです。ユニットテストではエッジケースなどを検討し、カバーすることもできます。</p>
<p>ユニットテストはAPIのテストにおいて特に有効です。本番APIを呼び出すのではなく、ハードコードされた（「モック」）データを使用することで、常に一貫したテストを確実に実行することができます。</p>
<p>例えば、以下の非常にシンプルな（そして原始的な）関数を見てみましょう。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">sayHello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Hello human!"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>繰り返しますが、これは基本的なケースです。それでも、ユーザーがアプリケーションに名前を入力しなかった場合という小規模なエッジケースをカバーできていることが分かります。nameが入力されていれば、“<code class="language-text">Hello ${name}!</code>”が表示されます。<code class="language-text">${name}</code>はユーザーが入力すると想定される部分です。</p>
<p>「なぜそんな些細なことをテストする必要があるの？」と思われるかもしれません。これには、以下のとても重要な理由があります。</p>
<ul>
<li>関数が出力し得る結果について深く考えるきっかけとなります。たいていはエッジケースを実際に発見し、コードでそのケースをカバーするのに役立ちます。</li>
<li>コードの一部がこのエッジケースに依存する場合があります。誰かが重要な部分を削除したときに、テストプログラムが、このコードは重要なので削除してはならないという警告を発します。</li>
</ul>
<p>ユニットテストは小規模でシンプルなものが多いです。以下は例その例です。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"sayHello function"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should return the proper greeting when a user doesn't pass a name"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">"Hello human!"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should return the proper greeting with the name passed"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">"Evgeny"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">"Hello Evgeny!"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>describeとitはただのシンタックスシュガーで、最も重要な行はexpectとtoEqualです。describeとitはテストを論理的なブロックに分け、ターミナルに出力します。expect関数は検証対象の入力に、toEqualは望ましい出力に対応します。アプリケーションのテストに使える関数とメソッドは多種多様です。</p>
<p>ユニットのプログラム開発用ライブラリであるJestを使用してみましょう。上記の例では、JestはsayHello関数をタイトルとしてターミナルで表示します。it関数内のすべては単独のテストとみなされ、ターミナルで関数のタイトルの下に報告されます。すべてが非常に読みやすく表示されています。</p>
<p><img src="https://i2.wp.com/css-tricks.com/wp-content/uploads/2021/05/Rnlr5AaA.png?w=853&#x26;ssl=1">
<em>緑のチェックマークは両方のテストに通過したことを意味します。やった！</em></p>
<h2 id="h-integration-testing">結合テスト</h2>
<ul>
<li><strong>レベル</strong>：中</li>
<li><strong>範囲</strong>：ユニット間のインタラクションをテストする</li>
<li><strong>ツール候補</strong>：<a href="https://github.com/avajs/ava">AVA</a>、<a href="https://jestjs.io/">Jest</a>、<a href="https://testing-library.com/">Testing Library</a> </li>
</ul>
<p><img src="https://i1.wp.com/css-tricks.com/wp-content/uploads/2021/05/T9H4dkPU.png?resize=1000%2C750&#x26;ssl=1"></p>
<p>ユニットテストが単独の機能の動作をテストするものだとすれば、結合テストは複数の要素が問題なく連動するかを確かめるものです。結合テストが非常に重要なのは、コンポーネント間の相互作用をテストできるからです。アプリケーションが、単独で機能する独立した部分のみで構成されることは（あったとしても）非常に稀です。ですから、結合テストに頼る必要があります。</p>
<p>ユニットテストを実施した関数をもう一度使用しましょう。今回はシンプルなReactアプリケーションの中で使用します。例えば、ボタンをクリックすると画面にあいさつが表示されるとします。これは、関数だけではなく、HTML DOMやボタンの機能もテストに関係することを意味します。これらすべてが一体となってどのように機能するかをテストしましょう。</p>
<p>以下はテスト対象の<code class="language-text">&lt;Greeting /&gt;</code>コンポーネントのコードです。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">Greeting</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  
  <span class="token keyword">const</span> <span class="token punctuation">[</span>showGreeting<span class="token punctuation">,</span> setShowGreeting<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

 <span class="token keyword">return</span> <span class="token punctuation">(</span>  
   <span class="token operator">&lt;</span>div<span class="token operator">></span>  
     <span class="token operator">&lt;</span>p data<span class="token operator">-</span>testid<span class="token operator">=</span><span class="token string">"greeting"</span><span class="token operator">></span><span class="token punctuation">{</span>showGreeting <span class="token operator">&amp;&amp;</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>  
     <span class="token operator">&lt;</span>button data<span class="token operator">-</span>testid<span class="token operator">=</span><span class="token string">"show-greeting-button"</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setShowGreeting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>Show Greeting<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>  
   <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>以下は結合テストの例です。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;Greeting />'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'shows correct greeting'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  
    <span class="token keyword">const</span> screen <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Greeting <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
     <span class="token keyword">const</span> greeting <span class="token operator">=</span> screen<span class="token punctuation">.</span><span class="token function">getByTestId</span><span class="token punctuation">(</span><span class="token string">'greeting'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
     <span class="token keyword">const</span> button <span class="token operator">=</span> screen<span class="token punctuation">.</span><span class="token function">getByTestId</span><span class="token punctuation">(</span><span class="token string">'show-greeting-button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

     <span class="token function">expect</span><span class="token punctuation">(</span>greeting<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
     fireEvent<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>  
     <span class="token function">expect</span><span class="token punctuation">(</span>greeting<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'Hello human!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>describeとitはユニットテストで確認したとおりです。これらはテストをロジックごとに分割します。特別にエミュレートしたDOMに<code class="language-text">&lt;Greeting /&gt;</code>コンポーネントを表示するrender関数を設定しており、実際のDOMに触れることなくコンポーネントとのインタラクションをテストできます。そうしなければコストがかかる可能性があります。</p>
<p>次に、テストプログラムはテストID（#greetingと#show-greeting-button）を通じてそれぞれ<code class="language-text">&lt;p&gt;</code>と<code class="language-text">&lt;button&gt;</code>の要素を取得しています。テストIDを使用するのは、エミュレートしたDOMから必要なコンポーネントを取得するのが比較的容易であるためです。他にもコンポーネントを取得する方法はありますが、筆者はこの方法を最もよく使っています。</p>
<p>7行目からやっと実際の結合テストが始まります。まずは<code class="language-text">&lt;p&gt;</code>タグが空であることを確認し、次にclickイベントをシミュレーションすることでボタンをクリックします。最後に、<code class="language-text">&lt;p&gt;</code>タグの中身が“Hello human!”であることを確認します。これで終了です。テストするのは、ボタンをクリックした後に、テキストが空のパラグラフに格納されるということだけです。これでコンポーネントはカバーされました。</p>
<p>もちろん、名前の入力欄にインプットを追加して、その入力内容をgreeting関数で使用することもできます。しかし、ここではもう少しシンプルな内容にしました。インプットの使用については、他の種類のテストをカバーするときに説明します。</p>
<p>以下は、結合テストを実行したときのターミナルの表示です。
<img src="https://i1.wp.com/css-tricks.com/wp-content/uploads/2021/05/s_E32271F2C12EE856B0A0138BD6634D2E534F561CE231B7ED84F3864DF6AF3CD6_1620061978349_Screenshot2021-04-27at21.18.08.png?w=715&#x26;ssl=1">
<em>完璧！<code class="language-text">&lt;Greeting /&gt;</code>コンポーネントは、ボタンをクリックしたときに正しいあいさつを返しています。</em></p>
<h2 id="h-end-to-end-e2e-testing">エンドツーエンド（E2E）テスト</h2>
<ul>
<li><strong>レベル</strong>：高</li>
<li><strong>範囲</strong>：何をすべきか、およびどのような結果が期待されているかに関して、プログラムに指示を出し、実際のブラウザでのユーザーとの間のインタラクションをテストする</li>
<li><strong>ツール候補</strong>：<a href="https://www.cypress.io/">Cypress</a>、<a href="https://github.com/puppeteer/puppeteer">Puppeteer</a></li>
</ul>
<p>E2Eテストはこのリストの中で最高レベルのテストです。このテストは、ユーザーにとってアプリケーションがどう見えるか、ユーザーがどのようにアプリケーションとインタラクトするかという点のみを扱います。コードや実装とは一切関係ありません。</p>
<p>E2Eテストではブラウザに対し、何をすべきか、何をクリックすべきか、そして何を入力すべきかについて指示を出します。あらゆる種類のインタラクションを作成し、エンドユーザーが体験するとおりにさまざまな機能やフローをテストできます。このテストは、アプリケーションをくまなくクリックしてインタラクションを行い、すべてが機能していることを確かめるという、まさにロボットとしての役割を果たすものです。</p>
<p>E2Eテストは結合テストとやや似ています。しかし、E2Eテストは、モックアップではなく実際のDOMを有する実際のブラウザで実行されるものです。これらのテストでは通常、実際のデータと実際のAPIを使用します。</p>
<p>ユニットテストと結合テストでカバレッジ100%を目指しても良いでしょう。しかし、実際にブラウザでアプリケーションを実行したとき、ユーザーは予想外の挙動に直面する可能性があります。E2Eテストは、それに対する完璧な解決策となるのです。</p>
<p>以下では、極めて有名なテスト用ライブラリの<a href="https://www.cypress.io/">Cypress</a>を使用した例を見てみましょう。前述したコンポーネントのE2EテストのためだけにCypressを使用します。ただし、今回はブラウザ内で実行し、機能をいくつか追加しています。</p>
<p>繰り返しになりますが、アプリケーションのコードを見る必要はありません。ここでの想定は、何らかのアプリケーションがあり、それをユーザーとしてテストしたいということだけです。私たちはどのボタンをクリックすべきか、それらのボタンのIDが何であるかを知っています。それだけでテストを始めるには十分です。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Greetings functionality'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should navigate to greetings page and confirm it works'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    cy<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000'</span><span class="token punctuation">)</span>  
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greeting-nav-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greetings-input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'Evgeny'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> delay<span class="token operator">:</span> <span class="token number">400</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greetings-show-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greeting-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'include.text'</span><span class="token punctuation">,</span> <span class="token string">'Hello Evgeny!'</span><span class="token punctuation">)</span>  
  <span class="token punctuation">}</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このE2Eテストは前述の結合テストとそっくりで、コマンドが非常によく似ています。主な違いは実際のブラウザで実行されることです。</p>
<p>まずcy.visitを使用して、アプリケーションが存在する特定のURLへ移動します。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">cy<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000'</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>次にcy.getを使用してIDからナビゲーションボタンを取得し、テストプログラムに対してボタンをクリックするよう指示します。このアクションによって<Greetings />コンポーネントを有するページに移動します。筆者はこのコンポーネントを個人Webサイトに追加し、そのURLへのルートを設定しています。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greeting-nav-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>さらに、続けてinputタグに“Evgeny”と入力し、#greetings-show-buttonボタンをクリックし、最後に望ましいあいさつが出力されていることを確認します。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greetings-input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'Evgeny'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> delay<span class="token operator">:</span> <span class="token number">400</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greetings-show-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greeting-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'include.text'</span><span class="token punctuation">,</span> <span class="token string">'Hello Evgeny!'</span><span class="token punctuation">)</span>  </code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>実際のブラウザで、テストプログラムによってボタンがクリックされるのを見るのは非常に壮観です。以下は、何が起きているか分かるように、テストのスピードを遅くしたものです。通常、テストはすべて非常に速いスピードで実行されます。</p>
<p><img src="https://i2.wp.com/css-tricks.com/wp-content/uploads/2021/05/ezgif.com-resize.gif?resize=1200%2C749&#x26;ssl=1"></p>
<p>以下はターミナルの出力です。</p>
<p><img src="https://i1.wp.com/css-tricks.com/wp-content/uploads/2021/05/nPIhU_4A.png?w=927&#x26;ssl=1"></p>
<h2 id="h-accessibility-testing">アクセシビリティテスト</h2>
<ul>
<li>レベル：高</li>
<li>範囲：アクセシビリティ標準の基準に従い、アプリケーションのインターフェイスをテストする</li>
<li>ツール候補：<a href="https://github.com/accesslint/accesslint.js/tree/master">AccessLint</a>、<a href="https://github.com/dequelabs/axe-core">axe-core</a>、<a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a>、<a href="https://pa11y.org/">pa11y</a></li>
</ul>
<blockquote>
<p>Webのアクセシビリティとは、Webサイト、ツール、テクノロジーが、障害のある人でも利用できるように設計・開発されていることを意味する
-<a href="https://www.w3.org/WAI/fundamentals/accessibility-intro/#what">W3C</a></p>
</blockquote>
<p>アクセシビリティテストは、障害のある人がWebサイトへアクセスし、効果的に使用できるようにするためのものです。これらのテストでは、アクセシビリティを考慮したWebサイトを実装するための基準に従っているかを検証します。</p>
<p>例えば、目が見えない人の多くはスクリーンリーダーを使用します。スクリーンリーダーはWebサイトをスキャンし、障害のあるユーザーでも理解可能な形式（通常は音声）で情報提供することを目指すものです。開発者としては、スクリーンリーダーの負担を軽くしたいと思うでしょう。そんなとき、アクセシビリティテストは、どこから着手すればよいかを把握する助けとなります。</p>
<p>アクセシビリティテストのツールは<a href="https://css-tricks.com/accessibility-testing-tools/">多種多様</a>です。自動化されているものもあれば、手動で検証するものもあります。例えば、ChromeはすでにDevToolsに<a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a>というツールを搭載しています。名前をご存じの方もいるでしょう。</p>
<p><img src="https://i2.wp.com/css-tricks.com/wp-content/uploads/2021/05/r95FRXzA.png?resize=1000%2C796&#x26;ssl=1"></p>
<p>ここではLighthouseを使用して、E2Eテストのセクションで作成したアプリケーションを検証してみます。Chrome DevToolsでLighthouseを開き、「Accessibility」テストオプションをクリックし、レポートを「Generate」します。</p>
<p><img src="https://i2.wp.com/css-tricks.com/wp-content/uploads/2021/05/lighthouse-start.png?resize=1000%2C471&#x26;ssl=1"></p>
<p>やるべきことは、たったのこれだけです。あとはLighthouseがテストを実行し、素晴らしいレポートを作成します。レポートには、スコア、実行したテストのサマリー、スコアの改善余地の概要が記載されます。</p>
<p><img src="https://i0.wp.com/css-tricks.com/wp-content/uploads/2021/05/Nb047kMQ.png?resize=1000%2C551&#x26;ssl=1"></p>
<p>しかし、これは特定の観点からアクセシビリティを測定するためのツールの1つにすぎません。アクセシビリティテストにはあらゆる種類のツールが存在します。ですから、何をテストするのか、そのためにどのようなツールを用意するのかについて計画を立てるのは価値があることです。</p>
<h2 id="h-visual-regression-testing">ビジュアルリグレッションテスト</h2>
<ul>
<li><strong>レベル</strong>：高</li>
<li><strong>範囲</strong>：コードの変更によって生じる視覚的な差異など、アプリケーションの視覚的な構造をテストする</li>
<li><strong>ツール候補</strong>：<a href="https://docs.cypress.io/guides/tooling/visual-testing">Cypress</a>、<a href="https://percy.io/">Percy</a>、<a href="https://applitools.com/">Applitools</a></li>
</ul>
<p>E2Eテストは、場合によっては、アプリケーションの直近の変更によってインターフェイスの見た目が崩れていないかを確認するのに不十分なことがあります。一部を変更したコードを本番環境にプッシュした結果、他の部分のレイアウトが変になってしまったということはありませんか？そんな経験をしたのは、あなただけではありません。大抵の場合、コードベースを変更すると、アプリの視覚的な構造やレイアウトは崩れてしまいます。</p>
<p>それを解決するのがビジュアルリグレッションテストです。その仕組みは非常に単純で、ページやコンポーネントのスクリーンショットを撮り、過去の成功したテストのスクリーンショットと比較するだけです。テストでスクリーンショットに差異が見つかった場合、何らかの通知が行われます。</p>
<p><a href="https://percy.io/">Percy</a>というビジュアルリグレッションツールを使って、ビジュアルリグレッションテストの仕組みを見てみましょう。ビジュアルリグレッションテストの方法は他にも数多くありますが、筆者は動作を見るならPercyが分かりやすいと考えています。<a href="https://css-tricks.com/testing-for-visual-regressions-with-percy/">Paul Ryanが執筆したこちらのCSS-Tricksの記事</a>では、Percyについて詳しく説明しています。
ここではコンセプトを説明するため、非常にシンプルな例を試してみます。</p>
<p>Greetingアプリケーションのボタンを入力欄の下に動かして、レイアウトを意図的に崩しました。このエラーをPercyで発見してみましょう。</p>
<p>PercyはCypressと相性が良いので、<a href="https://docs.percy.io/docs/cypress">インストールガイド</a>に従い、既存のE2Eテストと共にPercyのリグレッションテストを実行できます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Greetings functionality'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should navigate to greetings page and confirm everything is there'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  
    cy<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000'</span><span class="token punctuation">)</span>  
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greeting-nav-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greetings-input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'Evgeny'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> delay<span class="token operator">:</span> <span class="token number">400</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greetings-show-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'#greeting-text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'include.text'</span><span class="token punctuation">,</span> <span class="token string">'Hello Evgeny!'</span><span class="token punctuation">)</span>  


    <span class="token comment">// Percy test</span>
     cy<span class="token punctuation">.</span><span class="token function">percySnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// HIGHLIGHT</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>E2Eテストの末尾に1行だけ<code class="language-text">cy.percySnapshot()</code>を追加しました。これによってスクリーンショットを取得し、Percyに送信して比較します。たったこれだけです。テストが終わると、リグレッションを確認するためのリンクが送られてきます。以下はターミナルの出力です。</p>
<p><img src="https://i1.wp.com/css-tricks.com/wp-content/uploads/2021/05/s_E32271F2C12EE856B0A0138BD6634D2E534F561CE231B7ED84F3864DF6AF3CD6_1620062291768_Screenshot2021-05-01at17.07.14.png?w=852&#x26;ssl=1">
<em>なんと、E2Eテストを問題なく通過してしまいました。このように、E2Eテストは常に視覚的なエラーを発見できるわけではないことが分かります。</em></p>
<p>以下がPercyの出力です。
<img src="https://i1.wp.com/css-tricks.com/wp-content/uploads/2021/05/quuMXWdA.gif?resize=2018%2C1173&#x26;ssl=1">
<em>明らかに何かが変わっており、修正が必要です。</em></p>
<h2 id="h-performance-testing">パフォーマンステスト</h2>
<ul>
<li>レベル：高</li>
<li>範囲：アプリケーションのパフォーマンスと安定性をテストする</li>
<li>ツール候補：<a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a>、<a href="https://developers.google.com/speed/pagespeed/insights/">PageSpeed Insights</a>、<a href="https://webpagetest.org/">WebPageTest</a>、<a href="https://github.com/marcelduran/yslow/">YSlow</a></li>
</ul>
<p>パフォーマンステストはアプリケーションの速度を確認するのに適しています。パフォーマンスがビジネスにとって極めて重要である場合（最近は<a href="https://css-tricks.com/the-core-web-vitals-hype-train/">Core Web VitalsとSEOでも注目されている</a>ようです）、コードベースの変更がアプリケーションの速度に悪影響を与えていないかを確認することは必須でしょう。</p>
<p>パフォーマンステストは、一連のテストフローに組み込むことも、手動で実行することもできます。これらのテストをどう実行するか、どれくらいの頻度で実行するかはあなた次第です。一部の開発者はいわゆる<a href="https://css-tricks.com/your-first-performance-budget-with-lighthouse/">「パフォーマンスバジェット」</a>を作成しており、アプリの容量を計算するテストを実行しています。容量が一定の閾値を超えた場合、テストは失敗となり、デプロイが出来なくなります。あるいは、Lighthouseはパフォーマンス指標も測定できるので、折に触れて手動でテストを行うという手段もあります。2つを組み合わせて、<a href="https://css-tricks.com/continuous-performance-analysis-with-lighthouse-ci-and-github-actions/">Lighthouseをテストスイートに組み込む</a>のもいいでしょう。</p>
<p>パフォーマンステストは、パフォーマンスに関連するあらゆるものを測定できます。アプリケーションの読み込み速度、最初のバンドルの容量、さらに特定の機能の速度さえ測定可能です。パフォーマンステストは、ある程度広い範囲を対象としているのです。</p>
<p>ここでLighthouseを使用した簡単なテストを紹介します。LighthouseはCore Web Vitalsに重点を置いており、またインストールや設定の必要なくChromeのDevToolsから容易にアクセス可能であるため、パフォーマンステストを理解するのに適していると思います。</p>
<p><img src="https://i1.wp.com/css-tricks.com/wp-content/uploads/2021/05/s_E32271F2C12EE856B0A0138BD6634D2E534F561CE231B7ED84F3864DF6AF3CD6_1620062379377_Screenshot2021-05-03at17.17.14.png?resize=1000%2C612&#x26;ssl=1">
<em>あまり良いスコアではありませんが、少なくともどんな状況かは分かります。さらに、改善余地についていくつかのアドバイスが提示されています。</em></p>
<h2 id="h-wrapping-up">まとめ</h2>
<p>以下はこの記事で紹介したテストの内訳です。</p>
<table>
<thead>
<tr>
<th>種類</th>
<th>レベル</th>
<th>範囲</th>
<th>ツールの例</th>
</tr>
</thead>
<tbody>
<tr>
<td>ユニット</td>
<td>低</td>
<td>アプリケーションの関数とメソッドをテストする。</td>
<td><a href="https://github.com/avajs/ava">AVA</a><br><a href="https://jasmine.github.io/">Jasmine</a><br><a href="https://jestjs.io/">Jest</a><br><a href="https://karma-runner.github.io/latest/index.html">Karma</a><br><a href="https://mochajs.org/">Mocha</a></td>
</tr>
<tr>
<td>結合</td>
<td>中</td>
<td>ユニット間のインタラクションをテストする。</td>
<td><a href="https://github.com/avajs/ava">AVA</a><br><a href="https://jestjs.io/">Jest</a><br><a href="https://testing-library.com/">Testing Library</a></td>
</tr>
<tr>
<td>エンドツーエンド</td>
<td>高</td>
<td>何をすべきか、およびどのような結果が期待されているかに関して、プログラムに指示を出し、実際のブラウザでのユーザーとの間のインタラクションをテストする。</td>
<td><a href="https://www.cypress.io/">Cypress</a><br><a href="https://github.com/puppeteer/puppeteer">Puppeteer</a></td>
</tr>
<tr>
<td>アクセシビリティ</td>
<td>高</td>
<td>アクセシビリティ標準の基準に従い、アプリケーションのインターフェイスをテストする。</td>
<td><a href="https://github.com/accesslint/accesslint.js/tree/master">AccessLint</a><br><a href="https://github.com/dequelabs/axe-core">axe-core</a><br><a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a><br><a href="https://pa11y.org/">pa11y</a></td>
</tr>
<tr>
<td>ビジュアルリグレッション</td>
<td>高</td>
<td>コードの変更によって生じる視覚的な差異など、アプリケーションの視覚的な構造をテストする。</td>
<td><a href="https://applitools.com/">Applitools</a><br><a href="https://docs.cypress.io/guides/tooling/visual-testing">Cypress</a><br><a href="https://percy.io/">Percy</a></td>
</tr>
<tr>
<td>パフォーマンス</td>
<td>高</td>
<td>アプリケーションのパフォーマンスと安定性をテストする。</td>
<td><a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a><br><a href="https://developers.google.com/speed/pagespeed/insights/">PageSpeed Insights</a><br><a href="https://webpagetest.org/">WebPageTest</a><br><a href="https://github.com/marcelduran/yslow/">YSlow</a></td>
</tr>
</tbody>
</table>
<p>結局、テストは皆のためのものなのでしょうか？その答えはイエスです。開発のあらゆる段階で、アプリケーションのさまざまな側面をテストすることができるライブラリ、サービス、ツールは数多く存在します。ですから少なくとも、コードを基準や予想に照らして測定・テストできるようにしてくれる何かが見つかるはずです。さらに、一部のツールはコードや設定さえ必要ありません。</p>
<p>筆者の経験では、多くの開発者はテストを軽視しており、単純にアプリをくまなくクリックしたり、開発後チェックを実施したりすれば、コードの変更によって発生し得るバグを避けられると考えています。アプリケーションが意図した通りに動作し、可能な限り多くの人にとってインクルーシブなものとなり、効率的に実行され、また優れた設計となることを確実にしたいならば、自動か手動かを問わず、テストをワークフローの中心に据える必要があります。</p>
<p>テストの種類やその機能が分かったところで、皆さんの業務にもテストを導入してみてはいかがでしょうか。</p>]]></content:encoded></item><item><title><![CDATA[フォント読み込みの影響を軽減するための新しい方法：CSSフォントディスクリプタ]]></title><description><![CDATA[クイックサマリー ‐ Webフォントは往々にしてWebのパフォーマンスをひどく低下させており、この問題に対して特に効果的なフォント読み込みの戦略は存在しません。しかし、今後公表されるフォントのオプシ…]]></description><link>https://postd.cc/a-new-way-to-reduce-font-loading-impact/</link><guid isPermaLink="false">https://postd.cc/a-new-way-to-reduce-font-loading-impact/</guid><category><![CDATA[プログラミング]]></category><category><![CDATA[デザイン]]></category><category><![CDATA[CSS]]></category><category><![CDATA[Webフォント]]></category><pubDate>Wed, 18 Aug 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>クイックサマリー ‐ Webフォントは往々にしてWebのパフォーマンスをひどく低下させており、この問題に対して特に効果的なフォント読み込みの戦略は存在しません。しかし、今後公表されるフォントのオプションによって、フォールバックフォントを最終的なフォントに合わせやすくなるかもしれません。</p>
<p>フォントの読み込みはWebのパフォーマンスにとって長年にわたる悩みの種であり、<a href="https://twitter.com/jaffathecake/status/1293250032632844294?s=20">これを解決する良い方法はありません</a>。Webフォントを使用する場合は基本的に、フォントをダウンロードするまでテキストが表示されないFOIT（Flash of Invisible Text）か、最初はフォールバック用のシステムフォントを使用し、ダウンロードが済んだらWebフォントに更新するFOUT（Flash of Unstyled Text）のどちらかを選ぶ必要があります。正直に言って、どちらの選択肢もあまり満足の行くものではなく、どちらかが特に「勝っている」わけではありません。</p>
<h2><code class="language-text">font-display</code>はこの問題を解決するはずだったのでは？</h2>
<p><code class="language-text">@font-face</code>の<code class="language-text">font-display</code>プロパティは、以前はブラウザがFOITかFOUTかを決めていたのに対して（従来はIEとEdgeがFOUTを好み、他のブラウザがFOITを好んでいました）、Web開発者に選択肢を与えました。しかし、それ以上の問題は解決しませんでした。</p>
<p><code class="language-text">font-display: swap</code>が発表された当初、多くのサイトはこれに移行し、<a href="https://twitter.com/hdjirdeh/status/1130895027712995329?s=20">Google Fontsに至っては2019年にデフォルトに設定しました</a>。この背景にある考え方は、たとえフォールバックフォントであっても、<strong>テキストを可能な限り速く表示</strong>して、ダウンロードが終わってからフォントを変えるほうがパフォーマンスにとっては望ましいというものでした。</p>
<p>筆者もかつては<a href="https://www.tunetheweb.com/blog/should-you-self-host-google-fonts/">この考え方を支持</a>していましたが、Webフォントがダウンロードされるとフォント間の違いによって文字が拡大（または縮小）する「ハイドレーション効果」にイライラするようになりました。Smashing Magazineでは、ほとんどのパブリッシャと同様にWebフォントを使用しています。以下のスクリーンショットは最初のレンダリング（フォールバックフォント）と最終的なレンダリング（Webフォント）の差を示したものです。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/86ef8737-1499-442d-b99c-fb6adfda35ab/smashingmag-different-fonts.png">
<em>Smashing Magazineの記事をフォールバックフォントで表示した場合とすべてWebフォントで表示した場合 (<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/86ef8737-1499-442d-b99c-fb6adfda35ab/smashingmag-different-fonts.png">プレビューを拡大</a>)</em></p>
<p>並べてみると、Webフォントはフォールバックフォントよりもかなり見た目が良く、Smashing Magazineのブランドにも適しています。しかし、2つのフォントの間には<strong>テキストのレイアウトに大きな差</strong>があります。フォントのサイズが非常に異なるため、画面上のコンテンツが動いているのです。現在の<a href="https://www.smashingmagazine.com/category/core-web-vitals">Core Web Vitals</a>の時代に、（全く当然ながら）Cumulative Layout Shift（CLS）がユーザーにとってマイナスと認識されていることを踏まえると、<code class="language-text">font-display: swap</code> はレイアウトが動くので選択肢として今ひとつです。</p>
<p>筆者はテキストのがたつきが本当に不快でうっとうしかったので、自分が担当したサイトは<code class="language-text">font-display: block</code>に戻しました。確かに<code class="language-text">block</code>ではがたつきを防げませんが（フォントは依然として不可視のテキストとしてレンダリングされます）、少なくともユーザーには気になりにくくなります。また筆者は、<strong>サブセット化したフォントをセルフホスティングし</strong>、プリロードするフォントを可能な限り小さくすることで<a href="https://www.tunetheweb.com/blog/should-you-self-host-google-fonts/">フォント読み込みを最適化</a>しており、そのため訪問者がフォールバックフォントを見る時間はごくわずかになっていました。<code class="language-text">swap</code>でフォールバックフォントが表示される時間は非常に短く、筆者の場合、最初から正しくレンダリングさせるために少し待つほうが好みだったのです。</p>
<h2><code class="language-text">font-display: optional</code>はFOITとFOUTを解決できるが、代償が必要</h2>
<p><code class="language-text">font-display: optional</code>を使用するという選択肢もあります。この選択肢では一般にWebフォントがオプションとなります。言い換えれば、ページが必要とする時点までにフォントが準備されていない場合、フォントを変更するかどうかをブラウザに任せることが可能です。このオプションでは、基本的にダウンロード済みのフォントのみを使用すれば<strong>FOITとFOUTの両方を回避</strong>できます。</p>
<p>Webフォントが使用できなければ、フォールバックフォントの読み込みが行われますが、次のページへ移動するとき（または同じページを再読み込みするとき）はWebフォントが使用されます。その頃にはダウンロードが終わっているはずだからです。しかし、Webフォントがサイトにとってその程度の重要性ならば、Webフォントを完全になくしてしまうだけで良いのかもしれません。そのほうがWebのパフォーマンスにとっても望ましいのですから！</p>
<p>とはいえ、第一印象は大切であり、最初の読み込みを全くWebフォントなしで行うのは少しやり過ぎと感じられます。また、根拠は全くないのですが、ユーザーに対してWebサイトが何か「変」だという（場合によっては無意識の）印象を与え、Webサイトの使用状況に影響を及ぼす可能性があると思われます。</p>
<p>したがって、Webフォントを全く使わないことや、システムフォントを使用すること（<a href="https://www.smashingmagazine.com/2015/11/using-system-ui-fonts-practical-guide/">制約はありますが、多くの人が考えるほど大きな制約ではないかもしれません</a>）を含め、フォントをめぐる選択肢にはすべて欠点があります。</p>
<h2>フォールバックフォントを本来のフォントにより近づける</h2>
<p>Webフォントの読み込みにおける究極の目標は、<strong>フォールバックフォントを実際のWebフォントに近づけ</strong>、目立つ変化を可能な限り小さくして、swapの使用による影響を軽減することです。変化を完全に回避するのは今後も不可能でしょうが、上記のスクリーンショットよりもうまくやる方法はあります。<code class="language-text">Monica Dinculescu</code>(<a href="https://twitter.com/notwaldorf">https://twitter.com/notwaldorf</a>)の<code class="language-text">Font Style Matcher</code>(<a href="https://meowni.ca/font-style-matcher/">https://meowni.ca/font-style-matcher/</a>)アプリは、フォントの読み込みに関する記事でたびたび紹介されており、この分野の素晴らしい可能性をうかがわせてくれます。このアプリは、<strong>同じテキストを2つの異なるフォントで重ね合わせて表示</strong>し、両者の違いを確認できるようにすることで、フォントのスタイリングを調整して差を小さくするのに役立ちます。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a673ea2f-d411-4265-b390-b5a9aab8f606/font-style-matcher-screenshots.png">
<em><a href="https://meowni.ca/font-style-matcher/">Font Style Matcher</a>のスクリーンショット。2つのフォントをデフォルトの同じ設定で重ね合わせた場合（上）と、両者をより近づけるように設定を調整した場合（下）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a673ea2f-d411-4265-b390-b5a9aab8f606/font-style-matcher-screenshots.png">プレビューを拡大</a>)</em></p>
<p>残念ながら、フォントのスタイルのマッチングには問題があります。これらのCSSスタイルはフォールバックフォントのみに適用することができないため、<a href="https://noti.st/zachleat/KNaZEg/the-five-whys-of-web-font-loading-performance#sWkN4u4">JavaScriptとFontFace.load API</a>を使用して、<strong>Webフォントの読み込み時</strong>にスタイルの差を適用する（あるいは元に戻す）必要があるのです。</p>
<p>コードの量は膨大ではありませんが、それでも必要以上に手間がかかっているように感じます。とはいえ、JavaScript APIを使用することには他の利点や可能性もあります。2018年に<a href="https://twitter.com/zachleat">Zach Leatherman</a>が<a href="https://www.youtube.com/watch?v=FbguhX3n3Uc&#x26;feature=youtu.be&#x26;t=1934">この素晴らしい講演</a>で説明した通り、JavaScript APIを通じてリフローを削減し、<code class="language-text">data-server</code>モードと<code class="language-text">prefers-reduced-motion</code>を扱うことができるのです（ただし、この講演以降、data-serverモードとprefers-reduced-motionは共にCSSの影響を受けるようになっています）。</p>
<p>また、多様なフォールバックスタイルの違いの処理が難しいのはもちろんのこと、既にキャッシュされたフォントを扱うのも大変です。Smashing Magazineでは、さまざまなユーザーとオペレーティングシステムがインストールしているシステムフォントを最大限に活用するため、以下のように多くのフォールバックを試しています。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token property">font-family</span><span class="token punctuation">:</span> Mija<span class="token punctuation">,</span>-apple-system<span class="token punctuation">,</span>Arial<span class="token punctuation">,</span>BlinkMacSystemFont<span class="token punctuation">,</span>roboto slab<span class="token punctuation">,</span>droid serif<span class="token punctuation">,</span>segoe ui<span class="token punctuation">,</span>Ubuntu<span class="token punctuation">,</span>Cantarell<span class="token punctuation">,</span>Georgia<span class="token punctuation">,</span>serif<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>どのフォントが使用されているかを把握し、各フォントを別々に調整してそれが正しく適用されるようにすることは、極めて煩雑な作業となる可能性があります。</p>
<p><a href="" id="a-better-solution-is-coming"></a></p>
<h2>優れたソリューションが間もなく登場</h2>
<p>以上が現状の簡単なまとめです。しかし、<a href="https://twitter.com/addyosmani/status/1395997862065053696">地平線の向こうに変化の兆しが見え始めています</a>。</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Excited for the CSS &quot;size-adjust&quot; descriptor for fonts: reduce layout shifts by matching up a fallback font and primary web font through a scale factor for glyphs (percentage). <br><br>See <a href="https://t.co/mdRW2BMg6A">https://t.co/mdRW2BMg6A</a> by <a href="https://twitter.com/cramforce?ref_src=twsrc%5Etfw">@cramforce</a> for a demo (Chrome Canary/FF Nightly with flags) <a href="https://t.co/hEg1HfUJlT">pic.twitter.com/hEg1HfUJlT</a></p>&mdash; Addy Osmani (@addyosmani) <a href="https://twitter.com/addyosmani/status/1395997862065053696?ref_src=twsrc%5Etfw">May 22, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>前述の通り、フォールバックフォントとのスタイルの差を適用する際の主な問題は、スタイルを追加して、それから削除しなければならないことでした。もしブラウザに対して、これらの差をフォールバックフォントのみに適用するように指示できたらどうでしょうか？</p>
<p>これこそまさに<a href="https://drafts.csswg.org/css-fonts-5/">CSS Fonts Module Level 5</a>の一部として提案されている、新たな一連のフォントディスクリプタが実現することです。このディスクリプタは個々のフォントが定義されている<code class="language-text">@font-face</code>の宣言に適用されます。</p>
<p>Simon Hearneはfont-faceディスクリプタの仕様のアップデート案について<a href="https://simonhearne.com/2021/layout-shifts-webfonts/#reduce-layout-shift-with-f-mods">文書を執筆</a>しており、<a href="https://docs.google.com/document/d/1PW-5ML5hOZw7GczOargelPo6_8Zkuk2DXtgfOtJ59Eo/edit">そのアップデートの中に</a><code class="language-text">ascent-override</code>、<code class="language-text">descent-override</code>、<code class="language-text">line-gap-override</code>、<code class="language-text">advance-override</code>（その後取り下げ）という4つの新たなディスクリプタが含まれています。Simonは<a href="https://codepen.io/simonjhearne/pen/rNMGJyr">フォントメトリクスの上書き用のプレイグラウンド</a>を作成しています。ここではカスタムフォントとフォールバックフォントを読み込み、上書きによってフォントを完璧に合わせられるかを試すことができます。</p>
<p>Simonが書いている通り、この4つのディスクリプタを組み合わせれば、フォールバックフォントのレイアウトを上書きしてWebフォントに近づけることが可能ですが、これらは行間と垂直位置の調整しかできません。そのため、字送りについては別途CSSの設定が必要になります。</p>
<p>しかし、状況は再び変わりつつあるようです。<a href="https://twitter.com/addyosmani/status/1395997862065053696">つい最近</a>、<code class="language-text">advance-override</code>の導入が中止され、代わりに<code class="language-text">size-adjust</code><a href="https://twitter.com/addyosmani/status/1395997862065053696">ディスクリプタ</a>が採用される予定です。このディスクリプタでは、グリフのスケールファクタ（パーセンテージ）を通じてフォールバックフォントと主要なWebフォントを一致させ、レイアウトの移動を減らすことができます。</p>
<p>どのような仕組みになっているのでしょうか？以下のCSSを想定してみましょう。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">{</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'Lato'</span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'/static/fonts/Lato.woff2'</span><span class="token punctuation">)</span></span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'woff2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">font-weight</span><span class="token punctuation">:</span> 400<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">h1</span> <span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> Lato<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>次にArialをフォールバックフォントとする<code class="language-text">@font-face</code>を作成し、size-adjustディスクリプタを適用します。CSSスニペットは以下のようになります。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">{</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'Lato'</span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'/static/fonts/Lato.woff2'</span><span class="token punctuation">)</span></span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'woff2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">font-weight</span><span class="token punctuation">:</span> 400<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"Lato-fallback"</span><span class="token punctuation">;</span>
    <span class="token property">size-adjust</span><span class="token punctuation">:</span> 97.38%<span class="token punctuation">;</span>
    <span class="token property">ascent-override</span><span class="token punctuation">:</span> 99%<span class="token punctuation">;</span>
    <span class="token property">src</span><span class="token punctuation">:</span> <span class="token function">local</span><span class="token punctuation">(</span><span class="token string">"Arial"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">h1</span> <span class="token punctuation">{</span>
    <span class="token property">font-family</span><span class="token punctuation">:</span> Lato<span class="token punctuation">,</span> Lato-fallback<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これは、元々<code class="language-text">Lato-fallback</code>が使用されている場合（Arialは<code class="language-text">local</code>フォントであり、何も追加でダウンロードしなくても即座に使用できます）、<code class="language-text">size-adjust</code>と<code class="language-text">ascent-override</code>の設定によってフォールバックフォントをLatoフォントに近づけられることを意味します。<code class="language-text">@font-face</code>宣言を余分に書く必要がありますが、以前まで必要だった手順に比べればずっと簡単であるのは間違いありません。</p>
<p>全体として、この仕様には<code class="language-text">size-adjust</code>、<code class="language-text">ascent-override</code>、<code class="language-text">descent-override</code>、<code class="language-text">line-gap-override</code>の4つの主要な<code class="language-text">@font-face</code>ディスクリプタが含まれており、他にも下付き文字や上付き文字などの用途向けにいくつかのディスクリプタが検討されています。</p>
<p><a href="https://twitter.com/cramforce">Malte Ubl</a>は、任意の2つのフォントと上記の新たな設定をサポートするブラウザ（後ほど説明します）について、<a href="https://deploy-preview-15--upbeat-shirley-608546.netlify.app/perfect-ish-font-fallback/">これらの設定を自動的に計算する非常に便利なツール</a>を作成しました。Malteが指摘している通り、コンピュータはこの種の作業が大得意です。うまくいけば、よく使われているフォントについて、これらの設定をWeb開発者に公開できるかもしれません（例えばGoogle Fontsのようなフォントコレクションでヒントを公開するなど）。そうすれば、きっと採用される機会が増えるでしょう。</p>
<p>現在はオペレーティングシステムごとに<strong>フォントの設定がわずかに異なる</strong>場合があり、完璧な調整は基本的に不可能なのですが、それを目指しているわけではありません。目的はギャップを埋め、<code class="language-text">font-display: swap</code>の利用体験を不快でないものにすることです。そのために<code class="language-text">optional</code>を使用する、あるいはWebフォントを全くなくしてしまうという極端な行動に走る必要はありません。</p>
<h2>いつから使用できるか？</h2>
<p>上記のうち3つの設定は<strong>Chromeのバージョン87</strong>からすでに組み込まれていますが、カギとなる<code class="language-text">size-adjust</code>ディスクリプタはどの安定版のブラウザでもまだ使用できません。しかし、<a href="https://twitter.com/addyosmani/status/1395997862065053696?s=20">Chrome Canaryには搭載されており、Firefoxにもflags（試験運用機能）として実装されています</a>。ですから、これはただのアイデアでも非現実的なコンセプトでもなく、すぐに実現し得るものです。</p>
<p>現時点の<a href="https://drafts.csswg.org/css-fonts-5/">仕様</a>にはあらゆる種類の免責事項と警告が記載されており、まだリアルタイムで使用する準備は整っていないと書かれていますが、その実現が近づいているのは確実だと思います。いつものように、われわれデザイナーと開発者の間には、一方がテストを実施してフィードバックを提供し、一方が使用をやめるように促すというバランスが存在します。ですから、あまりに多くの人が初期のドラフト版を使用しているからという理由で、実装が滞る心配はありません。</p>
<p>Chromeは<a href="https://www.chromestatus.com/features/schedule">7月20日にリリース予定</a>の<a href="https://chromestatus.com/feature/5662073285509120">Chrome 92で<code class="language-text">size-adjust</code>を使用できるようにする</a>つもりだと述べており、恐らく実現まであと一歩であることを示しています。</p>
<p>ですから、今すぐではなくても近い将来には使用できるようです。それまでに<a href="https://deploy-preview-15--upbeat-shirley-608546.netlify.app/perfect-ish-font-fallback/?font=Judson">Chrome Canaryでデモを試し</a>、フォントの読み込みをめぐる問題や、それによるCLSへの影響を少しでも解消できるのかについて確かめてみましょう。</p>]]></content:encoded></item><item><title><![CDATA[パフォーマンスの文化を創る]]></title><description><![CDATA[パフォーマンスの文化を創る Webパフォーマンスの向上は、コンバージョンの改善と利益の増加につながります。これに関しては極めて多くのケーススタディが存在しており、テクノロジーの専門知識を持たないプロ…]]></description><link>https://postd.cc/creating-a-performance-culture/</link><guid isPermaLink="false">https://postd.cc/creating-a-performance-culture/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[パフォーマンス]]></category><pubDate>Mon, 12 Jul 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<h2>パフォーマンスの文化を創る</h2>
<p>Webパフォーマンスの向上は、コンバージョンの改善と利益の増加につながります。これに関しては極めて多くの<a href="https://wpostats.com/">ケーススタディ</a>が存在しており、テクノロジーの専門知識を持たないプロダクトマネージャーでさえこの事実を知っていることも珍しくありません。それでは一体なぜ、最後の差し迫った緊急事態に至るまで、場合によっては顧客のネガティブなフィードバックが殺到し、Webサイトのパフォーマンスの悪さが浮き彫りになるまで、パフォーマンスへの取り組みは後回しにされることが非常に多いのでしょうか？</p>
<p>私は幸運にも、それぞれ独自の背景と課題を有する幅広いプロジェクトのパフォーマンス面に長年取り組むことができました。しかし、経験を積むにつれて、私はほとんどの時間をコードの最適化ではなく<strong>プロセスの最適化</strong>に費やすようになりました。私は元々ソフトウェア開発者なので、コードを精査してボトルネックを発見し、別の選択肢を提案・実装し、自分でも驚くような仕事とパフォーマンススコアの向上を実現する方が性に合っています。私がコンサルタントとして参加するチームが、高いスキルを持つエンジニアで構成された既に確立したチームである場合、私は往々にして懐疑的な目で見られていました。ですから、技術的なノウハウによって、同僚に対して「自分の能力を証明する」ことが必要だと感じる場合もありました。</p>
<p>しかし、私を雇用したマネージャーは、（ほとんどの場合は）すぐに成果を出すことではなく、いわゆる俯瞰的な見方を求めていたのです。私の役割は、Webサイト（場合によっては複数のWebサイト）のパフォーマンスを絶えず改善することでした。これは私一人では不可能であり、少なくとも自分が書いたコードをプッシュするだけでは実現できません。手っ取り早くいくつかの改善策を実装してLighthouseのスコアが良くなったとしても、1週間後には誰かが作業をプッシュする際に画像が最適化されていないことでスコアは元に戻ってしまうでしょう。そうではなく、私の役割は、誰もがWebサイトのパフォーマンス改善に貢献できるようにすることでした。</p>
<h2>競争は善</h2>
<p>パフォーマンスの高さが優れた業績につながることは誰もが認識していましたが、自サイトのパフォーマンス状況には気付けませんでした。ほとんどの開発者は、高速なインターネット接続が可能なハイエンドのマシンで作業をしており、パフォーマンスにあまり注意を払っていなかったのです。開発者の名誉のために言うと、彼らはそれぞれの分野で高度な知識を有する専門家です。ただ、パフォーマンスを最高クラスの優先項目として取り扱うことには慣れていませんでした。</p>
<p><img src="https://calendar.perfplanet.com/images/2020/kevin/competitive-benchmarking.png" alt="Competitive Benchmarking"></p>
<p>私は、自分の仕事内容を説明する最初の機会を得たときに、開発中の自社Webサイト、競合他社のWebサイト、そして現状の自社Webサイトでの読み込み速度を比較して見せました。その場にいた開発者と経営幹部に衝撃を与えたのは、新しい自社Webサイトが最も遅いという事実でした。そのことがきっかけとなり、パフォーマンスは重要視されるようになりました。</p>
<p>自社と競合他社を比較することは、モチベーションを高めるのに役立ちますが、言い訳もできなくなります。競合他社が高速なWebサイトを作成できるならば、我々も高速なWebサイトを作成できるはずです。顧客のWebサイトについて、複雑なAPIを使っている、あるいは画像が多いといった理由で、最適化はできないと言われたことは数えきれないほどあります。しかし、そのような場合も最適化できる可能性はあるのです。</p>
<h2>計測</h2>
<p>作成中のWebサイトに注意が必要であることを認識したら、次は現在の位置を理解し、さらに進捗を計測できるようにしなければなりません。信頼性の高い計測のために、私たちは一定の期間を設け、さまざまな環境でデータの標準的な指標（LCP、FMP、TBT、Page Load、Start Render）をテストしました。私はこの段階が極めて重要だったと考えています。なぜなら指標と、変更によって指標がどう反応するかを理解し、報告値に確信を持ちたいと考えていたためです。</p>
<p>私たちにとって優れた指標とは、安定的で、反応が良く、他の指標から独立しているものです。例えば、その指標が同じ状況下ではほとんど変化せず、Webサイトのパフォーマンス状態に応じて変化するものです。このことは、1つの指標がWebサイトのパフォーマンスの1要素に呼応していることを意味します。ですから、同じものを計測するのに複数の指標を使用すると、途端に分かりにくくなることがあります。とりわけ、指標がパフォーマンスの変化に応じて変化しない場合はなおさらです。</p>
<p>GoogleのCore Web Vitalsは出発点としては優れているのですが、私たちのケースではユーザーエクスペリエンスを完全には反映していませんでした。独自の指標を定義し、場合によって作成することは、開発者が計測対象を理解し、報告値を信頼するために役立ちました。計測対象の報告値が変動しやすいと、モチベーションは急速に失われてしまいます。一定の時間を置いた上で、指標が有効ではなくなった疑いが出てきた場合は、ただちに改善に取り組むか、新しい指標を探すようにしています。</p>
<h2>報告</h2>
<p>これらの指標については、開発環境を使用して、さまざまなシナリオ（新規ユーザー、リピートユーザー、cookieの使用に同意しないなど）とページで毎日計測を行いました。さらに、開発環境でのテストに加え、本番環境向けに実ユーザー指標（RUM）も設定しました。</p>
<p>これらの指標は常にダッシュボードの上位に表示され、計測値の時間的な変化を示すとともに、CI環境やソースコントロールと統合されていました。また指標が顕著に変化した場合は、各チームのSlackチャンネルへ直接報告されるようになっていました。これは導入後のパフォーマンスの向上や低下を明確にする上で有効であり、問題が発生した場合はチームが主体的に行動できるようにします。その結果、開発者は自らの作業の成果を熱心に追跡し、パフォーマンスに対して積極的なアプローチをとるようになりました。「このバンドルはパフォーマンスを低下させるだろうか？」「このモジュールは遅延読み込みにすべきだろうか？」こうした疑問は、以前は出てこなかったものです。</p>
<p>開発者がパフォーマンスに強い関心を持つようにすることは、技術的な面で前進するのに役立ちましたが、さらに技術に直接関係のないステークホルダーにもWebサイトのパフォーマンスの向上に注力してもらうことも重要でした。開発環境でのテストや細かい指標は、Webサイトのパフォーマンスがいつ、どこで変化したかを特定するのには有効です。しかし、経営幹部にとっては手に負えなかったり、重要ではなかったりするのかもしれません。そこで、RUMレポートから単一の数値やスコアを算出するための作業を行いました。ほとんどのユーザー（75パーセンタイル）のエクスペリエンスを表し、さまざまな指標を組み合わせた1つの数値です。</p>
<p>すべてのページとユーザーを1つにまとめ、シンプルな単独の数値として提示することの利点は、Webサイトに最も大きな影響を与える変化に応じてその数値も変化することです。この指標は新規とリピートユーザーの両方を合わせているため、例えばWebサイトの訪問者の大部分がリピートユーザーの場合、初めての訪問でのエクスペリエンスが改善しても事業にとっては小さな利益にしかならず、指標もわずかにしか改善しません。反対に、リピート訪問のエクスペリエンスが改善した場合、はるかに多くのユーザーに影響を与え、それに応じて指標も変化します。この指標はチームと経営陣へ2週間に1度報告されていました。</p>
<h2>現在の状況は？</h2>
<p>社内文化に変化を起こすのは簡単ではありませんが、すべてのステークホルダーを巻き込んだことで素晴らしい成果を挙げることができました。ほとんどの開発者は、自分の仕事がパフォーマンスにどのような影響を与えるかを意識し、パフォーマンスの向上に積極的に取り組んでいます。会社はWebサイトのパフォーマンスを来年の主要なKPIの1つに設定しています。</p>
<p><img src="https://calendar.perfplanet.com/images/2020/kevin/crux.png" alt="Largest Contentful Paint"></p>
<h2>肝心のWebサイトは？</h2>
<p>私たちは最近Webサイトを公開したばかりであり、やるべきことは依然として山ほどありますが、スタート地点から見れば非常に大きな進歩です。Webサイトは今までで一番速くなっており、今後も毎月継続的に改善される予定です。また、テストを実施したあらゆるユーザーセグメントに対して、業界の主要な競合他社との比較において読み込み時間が最も速くなりました。</p>
<p>そして、ケーススタディで得た教訓のとおり、顧客のフィードバックはポジティブな傾向へ変化し、コンバージョンは顕著に改善し続けています。</p>]]></content:encoded></item></channel></rss>