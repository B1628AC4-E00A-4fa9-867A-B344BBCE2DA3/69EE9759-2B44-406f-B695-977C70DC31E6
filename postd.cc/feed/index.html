<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア]]></title><description><![CDATA[POSTD は、ニジボックスが運営する、エンジニアに向けたキュレーションメディアです。ニジボックスはWebサービスの企画、制作、開発、運用を一貫して担うリクルートの100%子会社です。 リクルートグループのオンラインサービスをはじめ、様々な業種・業界・業態のサービス開発を行っております。]]></description><link>https://postd.cc</link><generator>GatsbyJS</generator><lastBuildDate>Fri, 26 Apr 2024 01:31:29 GMT</lastBuildDate><language>ja</language><atom:link href="https://postd.cc/feed/" rel="self" type="application/rss+xml"/><image><title>POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア</title><link>https://postd.cc</link></image><item><title><![CDATA[分析による思考の麻痺を脱し、自信を持って決断を下す方法]]></title><description><![CDATA[「決断の時における最善の選択は、正しいことをすること。最悪の選択は、何もしないことだ。」セオドア・ルーズベルトの言葉です。 人生を左右する可能性のある重要な決断を下すとき、結果が不確実であることや、…]]></description><link>https://postd.cc/how-to-stop-analysis-paralysis-and-make-more-confident-decisions/</link><guid isPermaLink="false">https://postd.cc/how-to-stop-analysis-paralysis-and-make-more-confident-decisions/</guid><category><![CDATA[スタートアップ]]></category><category><![CDATA[起業家精神]]></category><category><![CDATA[意思決定]]></category><category><![CDATA[クリティカルシンキング]]></category><pubDate>Fri, 26 Apr 2024 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>「決断の時における最善の選択は、正しいことをすること。最悪の選択は、何もしないことだ。」セオドア・ルーズベルトの言葉です。</p>
<p>人生を左右する可能性のある重要な決断を下すとき、結果が不確実であることや、未知の領域に踏み込むことへの不安から、ひたすらデータを集めては分析を繰り返し、必要以上に考え過ぎてしまう非生産的な悪循環に陥ってしまうことがあります。</p>
<p>想像が膨らんでしまい、最悪のシナリオを想定してそれが最善だと思い込んでしまうこともあれば、頭の中にストーリーを描き、良い選択肢があるにもかかわらず、より良い選択肢があるのではと考えて全て却下してしまうこともあります。
<em>こうした決断の例としては、引越し、退職と起業、転職、企業戦略の大転換などがあります。</em></p>
<p>恐怖心、完璧主義、怠惰、集中すべき目標の欠如など、理由はさまざまですが、分析ばかりに時間を費やして一向に行動を起こさないでいると、「analysis paralysis（分析による思考の麻痺）」と呼ばれる一種の思考停止状態に陥ってしまいます。完璧な決断を下そうと思うあまり、決断できなくなってしまうのです。ありもしない確実性を追求し続けるため、結論が出ずもがき苦しみます。何が最善の決断で、どうすれば望む結果が得られるのかなど、誰にも分からないのです。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>考え過ぎると、分析が逆に思考を麻痺させてしまいます。考え抜くことは大事ですが、考えることを行動を起こさないことの言い訳にしている人が多いように思います。
— ロバート・ハージャベック</p></div></div>
<p>完璧な決断を下すことはできませんが、より自信を持って決断を下すことは可能です。そのために実践できる4つの方法をご紹介します。</p>
<h2>実現したい結果を明確に定義する</h2>
<p>問題の定義が曖昧だったり、実現したい結果が不明確だったりする中で決断を下そうとすると、何時間もデータと睨めっこするだけで、いつまで経っても結論が出ないということになりかねません。</p>
<p>決断を下せない原因について、問題が複雑であることや、インプットが足りないこと、データポイントが少ないことなどを挙げるかもしれませんが、これらは全て真実から目を逸らすための言い訳に過ぎません。真実とはすなわち、自分が何を望んでいるのかが分からないということです。</p>
<p>問題を明確にし、成功の基準を定義することが、決断を下すために行うべき作業の半分です。これが、決断を下して望む結果を手にするための足がかりとなります。この作業を怠ると、残り半分の作業にいくら労力を割いても徒労に終わります。</p>
<p>前半の作業を行うにあたり、以下の問いについて考えてみるとよいでしょう。</p>
<ol>
<li>解決したい問題は何か？</li>
<li>解決するべき問題は本当にこれでいいのか？</li>
<li>どのような結果を実現したいのか？自分にとって最も重要なことは何か？</li>
<li>結果を実現できたかどうかはどう確認するのか？成功基準は何か？</li>
</ol>
<p>思考の麻痺は、成功基準が達成不可能な場合にも起こります。挙げた目標を全て100%確実に実現することを期待し、一切の妥協を認めない場合などです。</p>
<p>望む結果を単に羅列しただけでは優れた成功基準とは言えません。自分にとって最も重要なことを一つ特定する必要があります。それがあなたの北極星（道しるべ）になります。道しるべが分かっていると、決断を下すのも容易になります。道しるべにたどり着けそうな、有望な選択肢を見つけるだけでいいのです。</p>
<p>問題と実現したい結果を明確に定義することで、常に目標をしっかりと見据え、意思決定プロセスを容易にすることができます。</p>
<h2>必要十分で満足する</h2>
<p>何かを決断するとき、さまざまな選択肢や異なる視点、複数の情報源を考慮するのは良いことです。そうすることで、バイアスや思い込み、その他の状況的制約によって、決断と実現する結果が制限されるのを防ぐことができます。</p>
<p>選択肢があるのは良い一方で、選択肢が多過ぎるとかえって圧倒されてしまいます。選択肢が多ければ多いほど、決断を下すのは難しくなります。情報過多と多過ぎる選択肢は決断力の低下を招くのです。</p>
<p>解決策の調査に多くの時間を費やし、それぞれの欠点にばかり注目し、最善の選択肢を見つけようとひたすら時間と労力を注ぎ込むことになりかねません。しかし、決断を下して前に進むどころか、選択肢が多過ぎると不安が膨らむばかりです。</p>
<p>選択肢が多過ぎると思考能力が奪われ、決断を先送りにしがちです。</p>
<p>選択肢が増えると満足度が下り、自分の選択に自信が持てなくなって、後で決断を後悔する可能性が高まることを示す<a href="https://www.researchgate.net/publication/265170803_Choice_Overload_A_Conceptual_Review_and_Meta-Analysis?ref=hackernoon.com">研究結果</a>もあります。</p>
<p>心理学者のバリー・シュワルツは、人間は「マキシマイザー（利益最大化人間）」と「サティスファイサー（満足化人間）」の2種類に分けることができると言います。マキシマイザーは、最大の利益をもたらす選択をしようと努力し、最高の結果のみを求め、受け入れます。全ての選択肢をよく吟味しなければ選択できないため、絶えず情報を求めては他者と比較します。一方、サティスファイサーはより控えめな基準を用いて、受け入れ可能なレベルを超える選択肢を選びます。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>「サティスファイス（満足化）」するということは、十分なレベルで満足し、より良い選択肢があるかもしれない可能性については考えないということです。」
— バリー・シュワルツ</p></div></div>
<p>思考の麻痺に陥らないために、サティスファイサーになりましょう。それには以下のことを行う必要があります。</p>
<ol>
<li>調査範囲に境界を設けましょう。無制限に調査を行うことは避けてください。収集する情報量や考慮するインプットを制限し、期限を設けましょう。</li>
<li>決断にも期限を設けましょう。危機感を持つためにも、問題の規模や複雑さを踏まえた期限を設定してください。</li>
<li>それぞれの選択肢について良い点と悪い点を挙げ、その時点で際立って優れて見えるものを選びましょう。</li>
<li>決断を下したら、より良い選択肢の可能性については考えないようにします。自分の決断について後からあれこれ悩むことはせず、決断を実行に移していきましょう。</li>
</ol>
<p>必要十分で満足するということは、平凡な選択肢を受け入れるのとは違います。十分な検討と思慮に基づいて選択を行う必要はありますが、一定の制限を設けた上で行うのであり、より良い選択肢の可能性についてくよくよ悩むのではなく、決断を行動に移すことに時間と労力を費やすということです。</p>
<h2>直感でデータを組み合わせる</h2>
<p>思考が麻痺すると、決断を前に尻込みしてしまいます。合理的な選択をしたいがために行き詰まりを感じます。それ自体は自然なことですが、問題は、知らず知らずのうちに合理性の追求から過度な分析を行うようになり、その結果、意思決定を先送りしてしまうことです。</p>
<p>合理的アプローチには、慎重な思考が求められます。脳の前頭葉を働かせ、さまざまな選択肢を考慮し、妥協点を比較した上で選択を行います。直感的思考は、感情や経験、知識を動員して行います。このような思考は非論理的でも非合理的でもなく、生涯を通じて養ってきた知性です。</p>
<p>脳はパターンを認識するようにできており、直感的思考ではあなたが現在置かれている状況を過去のパターンに照らし合わせ、それをもとに決断を下します。直感が時に正しく、時に間違っているのはそのためです。</p>
<p>判断と意思決定にまつわる心理学や行動経済学の研究で知られる心理学者および経済学者のダニエル・カーネマンは、直感の働きは次の3つの条件に基づくと言います。</p>
<ol>
<li>傾向やパターンを認識するためには、一定の規則性が求められます。直感は、目まぐるしく変化する複雑な状況下では養うことも、適用することもできません。</li>
<li>直感を信じるためには、その分野について豊富な経験と練習が必要です。それがなければ、直感を働かせて万事うまくいったとしても、それは単に運が良かっただけであり、直感がもたらした結果ではありません。</li>
<li>直感が正しかったかどうかについて、即座に具体的なフィードバックが得られます。</li>
</ol>
<p>これらのうち該当しないものがある場合、問題についてもっと合理的に考え抜いた方がいいでしょう。</p>
<p>ほとんどの人は、意思決定を行う際に分析的思考と直感的思考のいずれかを使用します。これは、両者が共存できない相反する戦略だと考えているからです。しかし、研究ではそれとは異なる事実が明らかになっています。私たちの最良の決断は、分析的思考と直感的思考のいずれかを使用するのではなく、両方を組み合わせて使用したときに生まれるのです。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>パターン照合のみに頼った純粋に直感的な戦略は、パターン照合がもたらす選択肢が間違っていることがあるため、リスクが大き過ぎます。逆に、思索のみに頼った分析的な戦略だと時間がかかり過ぎます。
— ゲーリー・クライン</p></div></div>
<p>思考の麻痺に陥ったときは、データのみに頼るのではなく、過去の知識や経験も加味して決断を下すとよいでしょう。脳の理性をつかさどる部分を使ってさまざまな選択肢を考慮し、直感も交えて最終的な決断を下しましょう。</p>
<h2>決断を下すのに適切な時間帯を選ぶ</h2>
<p>1日を通して小さな決断を何度も下すことは、それ自体さほど精神的負担を強いるものではないため、一見無害に思えるかもしれません。しかし、エネルギーを消費し続けて1日の終わりを迎える頃には、決断を下す余力が失われてきます。</p>
<p>実際に感じることができてすぐに現れる身体的疲労とは異なり、繰り返し意思決定を行ってきたことによる精神的疲労は目に見えません。</p>
<p>心理学者が意思決定疲労と呼ぶこの状態は、意思決定の質の低下を招きます。いくつもの意思決定を行った後は、折り合いをつけることを渋り、簡単な選択肢に落ち着こうとし、自制心を働かせることさえ難しく感じられるかもしれません。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>一日中難しい決断を迫られるような仕事だと、気力もいつかは底をつき、エネルギーを節約する方法を探し始めます。例えば、決断を避けたり、先送りしたりする言い訳を探すようになるでしょう。また、最も楽で安全な選択肢を探すようになるでしょう。そしてその選択肢とは、多くの場合、現状を維持することです。
— ロイ・バウマイスター</p></div></div>
<p>良い決断を下すためには、さまざまな領域の知識を動員し、異なるアイデアをつなぎ合わせ、アイデアの深さと幅広さの適切なバランスを保ち、新たなつながりを生み出し、いくつかの有望な候補に焦点を定める必要があります。</p>
<p>疲労により頭の働きが鈍ってくると、雑音と信号を聞き分けることも難しくなります。その結果、考え過ぎてしまうようになり、具体的な方向性を示すこともできないまま、いくつものアイデアを行ったり来たりするようになります。</p>
<p>意思決定疲労は、存在すらしない問題について延々と考えたり、偏った結論を導いたり、より良い選択肢の可能性にとらわれ分析による思考の麻痺状態に陥ったりする原因になり得ます。その時の状況で最良の決断を下すのではなく、完璧な解決策を追求しようとしてしまうかもしれません。</p>
<p>重要な決断について思考の麻痺に陥らないようにするため、そうした決断は、頭の情報処理能力がピークの時間帯に下すようにしましょう。気力が充実しているタイミングに合わせて精神的負担が強いられる決断を下すことで、考え過ぎてしまう悪循環に落ちる可能性を減らせるでしょう。</p>
<p>決断を下す前に、以下の問いを自問してみてください。</p>
<ol>
<li>今がこの決断を下すのにベストな時間帯か？</li>
<li>この決断を下すにあたって、ベストコンディションにあると言えるか？</li>
<li>普段に比べて周りが慌ただしく感じられるか？</li>
</ol>
<p>その決断を下すのに自分がベストの状態にある時間帯を確保し、カレンダーに書き込みましょう。そしてその時間になったら、それ以上決断を遅らせないよう自分に言い聞かせ、目標に集中しましょう。</p>
<p>初めはばからしく感じられるかもしれませんが、実際に繰り返し行うことで、考え過ぎることなく決断を下せるようになってくるはずです。</p>
<p>最後はテリー・グッドカインドの以下の言葉で終わりたいと思います。筆者が思考の麻痺に陥ったときに、いつも助けてくれる言葉です。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>「何も選択しないより、間違った選択をした方がいい場合もあります。あなたに前に進む勇気があるのであれば、それは稀有なことです。岐路に立ち、進むべき方向を選べない人は、どこにもたどり着けません。」</p></div></div>
<h2>考えることをやめ、今すぐ行動しましょう。</h2>
<h3>まとめ</h3>
<ol>
<li>重要な決断は先送りするべきではありませんが、そうしてしまいがちです。完璧な決断を下そうとすると、思考が麻痺してかえって決断を下せなくなってしまい、行動を起こして前に進むことができなくなります。</li>
<li>問題や実現したい結果を明確に定義しないことが、思考の麻痺に陥る最大の原因の一つです。なかなか決断を下せず苦しんでいる場合、問題と成功基準を明確に定義しましょう。</li>
<li>最良の選択肢のみを追求するマキシマイザーになるのではなく、サティスファイサーになり、十分満足できる選択肢を特定して心配することをやめましょう。</li>
<li>直感を無視して合理的思考に重点を置き過ぎると、思考が麻痺します。考え過ぎによる悪循環を断ち切り、積極的に行動を起こすには、直感と合理的思考を組み合わせる戦略が効果的です。</li>
<li>意思決定疲労により疲れた頭は、決断を下すことを拒むようになります。この現象に対処する方法として、気力が充実している時間帯に決断を下すようにするとよいでしょう。</li>
</ol>
<p>この記事は以前<a href="https://www.techtello.com/analysis-paralysis/?ref=hackernoon.com">こちら</a>で公開されたものです。他の記事にも興味のある方は、<a href="https://www.linkedin.com/in/sagivini/?ref=hackernoon.com">LinkedIn</a>またはこちらをぜひフォローしてください。</p>]]></content:encoded></item><item><title><![CDATA[ChatGPTはプロのUI/UXデザイナーによるアプリ設計にどの程度役立つのか？]]></title><description><![CDATA[none «自動化できるものはすべて自動化されるだろう» - ロバート・キャノン、インターネット法・政策専門家 人工知能（AI）が今年のトレンドであることは紛れもない事実です。AI技術が台頭し、さま…]]></description><link>https://postd.cc/how-well-can-chatgpt-help-uiux-professionals-design-an-app/</link><guid isPermaLink="false">https://postd.cc/how-well-can-chatgpt-help-uiux-professionals-design-an-app/</guid><category><![CDATA[生成AI]]></category><pubDate>Fri, 29 Mar 2024 00:00:01 GMT</pubDate><content:encoded><![CDATA[<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>«自動化できるものはすべて自動化されるだろう» - ロバート・キャノン、インターネット法・政策専門家</p></div></div>
<p>人工知能（AI）が今年のトレンドであることは紛れもない事実です。AI技術が台頭し、さまざまな業界で急速に普及する中、UI/UXデザイナーやプロダクトデザイナーも当然その影響を受けています。ChatGPTやMidjourney、DALL-E 2（ダリ・ツー）、Stable Diffusionなどの製品はすでにかなり人気があり、筆者の同僚の中にも積極的なユーザーが多数います。</p>
<p>UI/UXデザイナーとして、筆者もChatGPTを作業プロセスに取り入れたことにより、より使いやすいインターフェースの開発能力が格段に向上したことをすでに実感しています。この記事では、ChatGPTの具体的な使い方を示しつつ、ChatGPTを利用することでどのようなメリットを享受でき、いかにして全体的な作業効率を高められるのかを説明します。では早速見ていきましょう！</p>
<h2>UI/UXデザイナーとプロダクトデザイナーの補助ツールとしてのChatGPT</h2>
<h3>リクエスト作成またはプロンプトエンジニアリング</h3>
<p>ChatGPTの可能性を最大限引き出せるかどうかは、効率的なクエリを作成する能力にかかっています。まずはリクエスト作成の基本をマスターし、さまざまなプロンプトスタイルを試してみましょう。</p>
<p>参考になりそうな例を以下にいくつか挙げましたので、ぜひご覧ください。</p>
<ul>
<li><a href="https://www.notion.so/642f21dc1ed94e2a8a6f719ff33ac540?ref=hackernoon.com">200+ ChatGPT UX Prompts</a></li>
<li><a href="https://drive.google.com/file/d/12Jj9A70GUaFuD1om_WbKYg9Ue9AWea9u/view?usp=sharing&#x26;ref=hackernoon.com">25 ChatGPT Use Cases for UX Designers</a></li>
<li><a href="https://drive.google.com/file/d/1O5-Ihv0pCOofr2oADZAVNJCi3dDUBFMn/view?usp=share_link&#x26;ref=hackernoon.com">45 ChatGPT Use Cases for Product Managers</a></li>
</ul>
<p><strong>完璧なリクエストの作成は、レシピを作る作業に似ています</strong>。期待する結果を得るためには、必要な材料をすべて適切な量加えて混ぜ合わせる必要があります。すべての工程を正しく行っても、完璧に仕上げるためには微調整が必要になるかもしれません。その要点についてこれからお話しします。
以下では、分かりやすい例として、数学を楽しく学べるモバイルアプリを開発しなければならないと仮定します。脳のトレーニングになるさまざまなテストやパズルを提供する数学クイズアプリを開発するとしましょう。</p>
<h3>要件とアイデアを集める</h3>
<p>ChatGPTは、ユーザーのリクエストを分析し、答えを生成することで、デザイナーが新しいプロジェクトの要件とアイデアを集める手助けをすることができます。コンセプトを考案し、主な機能やデザイン要件を決定する作業を含めることも可能です。</p>
<h3>では、実際にChatGPTがこの作業を行う上で助けになるのか見てみましょう。</h3>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-2ba3aye.jpeg">
<em>ChatGPTの会話</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>UX/UIデザイナーとして対応してください。主な目標は、製品やサービスのユーザーエクスペリエンスを可能な限りシームレスかつ直感的で、魅力的なものにすることです。デジタル製品やサービスのユーザーにとって、魅力的で楽しい体験を生み出します。あなたの仕事は、アプリ、ウェブサイト、その他のデジタル製品のユーザーエクスペリエンスを、創造的な方法で改善することです。結果はすべて英語で出力してください。最初のタスクは、iOS向けの数学クイズアプリのコンセプトを作成することです。</p><p><strong>タイトル：MathWiz</strong></p><p><strong>概要：</strong>
MathWizは、iOSデバイス向けに開発された対話型の数学クイズアプリであり、あらゆる年齢層のユーザーに、楽しく魅力的な教育体験を提供することを目指しています。このアプリは、各ユーザーに合わせた学習プロセスを通じて数学能力を高め、強化することに主眼を置いたさまざまなクイズや課題を提供します。</p><p><strong>特長：</strong></p><ol>
<li>カスタマイズされた学習パス：
MathWizは、ユーザーの習熟度と進捗に応じた学習パスを提供します。さまざまなクイズや課題におけるユーザーの成績を評価することで、ユーザーが効果的に力をつけられるよう最適なクイズや演習をアプリが提案します。</li>
<li>トピックの網羅性：
算数、代数、幾何学、三角法、微分積分など、幅広い数学トピックを網羅します。ユーザーは、自分の興味やレベルに応じてクイズを選択できます。</li>
<li>成績に応じた難易度設定：
MathWizは、ユーザーの成績に応じてクイズの難易度を変更する仕組みを使用します。これにより、ユーザーは常にやりがいのある問題に挑戦することができ、飽きたり不満を感じたりすることなく、関心を持って積極的に取り組むことができます。</li>
<li>ゲーム要素：
このアプリは、ポイント、バッジ、リーダーボードなどのゲーム要素を取り入れることで、学習プロセスを楽しく満足の得られるものにします。ユーザーは、クイズやチャレンジ問題をこなすとポイントやバッジを獲得します。これらはフレンドと共有したり、グローバルリーダーボードで成績を比較したりできます。</li>
<li>デイリークエスト：
日替わりのデイリークエストを実施すると、ユーザーは追加のポイントやバッジを獲得することができます。これらのクエストは、常にユーザーのモチベーションを高め、関心を引きつけ、アプリに戻ってくるよう促します。</li>
<li>進捗の管理と分析：
ユーザーが進捗を把握し、改善が必要な部分を確認できるよう、詳細な分析を行います。ユーザーはトピックやクイズ、チャレンジ問題ごとに成績を確認できるほか、進捗をフレンドと比べることもできます。</li>
<li>コラボレーションと交流：
MathWizは、クイズやチャレンジ問題、成果を共有しやすくすることで、ユーザー間のコラボレーションや競争を促します。また、チャット機能を取り入れることで、戦略を話し合ったり、助け合いながら複雑な問題に取り組んだりすることができます。</li>
<li>オフライン機能：
ユーザーは、オフラインでもクイズやチャレンジ問題に取り組むことができるため、インターネットに接続できない環境でも学習と練習を続けられます。</li>
<li>保護者機能：
保護者機能を搭載することで、保護者が子供の進捗を監督したり、目標を設定したり、特定のトピックスや機能へのアクセスを制限したりできるようにします。</li>
</ol><p><strong>デザインアプローチ：</strong></p><p>アプリはスムーズで直感的なユーザーエクスペリエンスの実現を優先したデザインとします。デザインの重要な要素は以下のとおりです。</p><ol>
<li>洗練されたモダンなUI：
MathWizは、無駄のないデザインと操作のしやすさに重点を置いた、洗練されたモダンなUIを搭載します。</li>
<li>魅力的なビジュアル：
アニメーションやイラスト、配色など、視覚的に魅力的なデザイン要素を取り入れることで、楽しく没入感のある学習環境を作り出します。</li>
<li>使いやすいナビゲーション：
アプリのナビゲーションは分かりやすく、使いやすいものにし、ユーザーはクイズやチャレンジ問題などの機能に迷うことなく簡単にアクセスできるようにします。</li>
<li>アクセシビリティ：
MathWizはアクセシビリティを念頭に置いてデザインします。ユーザーの能力や好みによらず、誰でも便利に使えるようにします。</li>
</ol><p>最後に、MathWizはカスタマイズされた学習プロセスを通じてユーザーが楽しみながら、興味を持って数学を学び、練習できる手段を提供することを目指します。トピックの網羅性、成績に応じた難易度設定、ゲーム要素、使いやすいデザインなどにより、年齢を問わずすべてのユーザーが楽しめるシームレスな体験を生み出します。</p></div></div>
</details>
<p>ご覧のとおり、ChatGPTはアプリのコンセプトをかなり詳細に記述しています。必要であれば、各機能についてさらに質問することも可能です。ChatGPTは明確な回答を提示し、さらには最も重要なポイントも示してくれます。</p>
<p>では、MathWizアプリをユーザーにとってより魅力的なデザインにするためのアイデアを尋ねてみましょう。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-n4b3a0s.jpeg">
<em>MathWizのデザイン案</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>MathWizアプリのデザイン案をいくつかリストアップしてください。</p><p>視覚的に魅力的で、ユーザーの興味を引き出すようなアプリにするためのデザイン案を以下にいくつか挙げます。</p><ol>
<li>カスタマイズ可能なアバター：ユーザーが自分のアバターを作成し、カスタマイズできるようにします。アバターは、プロフィール写真や、アプリ内での自分の分身として使用できます。こうしたパーソナライズ機能により、ユーザーエンゲージメントを高め、主体性を持たせることができます。</li>
<li>ゲーミフィケーション：ポイントやバッジ、リーダーボードなどのゲーム要素を取り入れることでモチベーションを高め、より楽しく学習できるようにします。クイズに答えるとポイントを獲得し、一定のマイルストーンに到達するとバッジが解放され、リーダーボードでフレンドや他のグローバルユーザーと成果を比べることができます。</li>
<li>進捗の可視化：視覚的に魅力的なチャートやグラフを使用して進捗を表示し、ユーザーが自分の向上過程を簡単に確認できるようにします。トピックごとの成績、合計獲得ポイント、集めたバッジを表示する進捗ダッシュボードを搭載します。</li>
<li>ダークモード：特に夜間や暗い場所での使用の際に目の疲れを軽減できるよう、ダークモードに切り替えられる機能を実装します。</li>
<li>アニメーションと画面遷移：ささやかなアニメーションやさりげない画面遷移により、スムーズでインタラクティブなユーザーエクスペリエンスを生み出します。正解や不正解の際のアニメーションや、画面の読み込み、アプリ内のセクション間のナビゲーションなどを含みます。</li>
<li>テーマに沿ったクイズ：人気のイベントや祝日、時事ネタなどをテーマにしたクイズを作成し、ユーザーの興味を引き出します。そうすることで目新しさを出し、ユーザーに新しいトピックやチャレンジ問題に挑戦するよう促すことができます。</li>
<li>共同学習：ソーシャル機能を組み込むことで、フレンドや他の学習者とつながったり、クイズやチャレンジ問題を送ったり、数学の問題について話し合ったり、成果を共有したりできるようにします。そうすることで、コミュニティとしての意識が芽生え、コラボレーションを通じた学習を促すことができます。</li>
<li>成績に応じた難易度設定：能力に合ったクイズや問題を提示することによる、ユーザーのスキルレベルに応じた難易度設定を可能にします。そうすることで、個別化された学習体験を生み出し、ユーザーを圧倒することなく、適度に難しい問題で興味を持続させます。</li>
<li>一貫した視覚言語：色やタイポグラフィ、アイコン、イラストなど、アプリ全体で一貫した視覚的言語を使用します。そうすることで、統一感のあるプロフェッショナルな外観になり、全体的なユーザーエクスペリエンス向上につながります。</li>
<li>マイクロインタラクション：ハプティックフィードバックや効果音、ビジュアルキューなどのマイクロインタラクションを取り入れることで、より興味を引きつけ、インタラクティブなアプリにします。例えば、ユーザーが答えを提出した際にハプティックフィードバックを使用したり、正解と不正解を効果音で知らせたりするといいでしょう。</li>
</ol><p>これらのデザイン案をMathWizアプリに取り入れることで、視覚的に魅力的で興味をかき立てられるような体験を生み出し、ユーザーに楽しみながら数学を学ぶよう促すことができます。</p></div></div>
</details>
<p>バーチャルアシスタントはポイントを10個挙げてくれました。どれもかなり的確で、これから開発するアプリのデザインコンセプトをまとめる手助けになりそうです。</p>
<h2>デザインの選択肢を出す</h2>
<p>ChatGPTを使うことで、要件を満たすさまざまなデザインの選択肢が得られます。その中から最も良いアイデアを選び、あまり有望でないものは除外します。</p>
<p>MathWizアプリについてはすでにアイデアが固まりましたので、情報アーキテクチャに関する詳細な説明を入手してみましょう。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-c8c3amj.jpeg"><br>
<em>デザインの選択肢を生成</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>次のタスクです。この数学クイズアプリに適した構造（情報アーキテクチャ）を作成してください。</p><p>MathWiz用にしっかりした情報アーキテクチャを作成するために、主要な画面とそれらの関係を概説します。この構造は、ユーザーとアプリのインタラクションを可能にする明確で直感的なナビゲーションシステムを提供します。</p><ol>
<li>スプラッシュスクリーン：<br>
・アプリのリソースを読み込む間、アプリのロゴ名前を表示<br></li>
<li>オンボーディング画面（新規ユーザー向けオプション）：<br>
・アプリの主な機能や利点をまとめた一連の紹介画面を表示し、新規登録やログインの方法を案内<br></li>
<li>ホーム画面：<br>
・個別化された推奨クイズやデイリークエスト、成果を含むユーザーの進捗概要。<br>
・以下のセクションへのアクセス：<br>
a. トピック<br>
b. デイリークエスト<br>
c. 成果<br>
d. プロフィール<br>
e. 設定<br></li>
<li>トピック画面：<br>
・利用可能な数学のトピック（算数、代数、幾何学、三角法、微分積分など）<br>
・トピックのフィルター・検索機能<br>
・各トピック内のサブトピックや関連するクイズへのアクセス<br></li>
<li>サブトピック画面：<br>
・選択したトピック内のサブトピックの一覧<br>
・各サブトピック内のクイズへのアクセス<br></li>
<li>クイズ画面：<br>
・選択されたクイズを、問題、答えの選択肢、タイマー（該当する場合）とともに表示<br>
・回答後、結果とともに正解、解説、獲得ポイントを表示<br></li>
<li>デイリークエスト画面：<br>
・実施できるデイリークエストの一覧<br>
・各クエストのステータス（実施済みかどうか）を、リワード（ポイントとバッジ）とともに表示<br></li>
<li>成果画面：<br>
・ユーザーが獲得したバッジや達成した成果の概要<br>
・リーダーボードを表示し、フレンドや他のグローバルユーザーと成果を比較する機能<br></li>
<li>プロフィール画面：<br>
・名前やプロフィール写真などのユーザーの個人情報や、進捗（ポイント、バッジ、完了したクイズ）の概要を表示<br>
・パフォーマンス分析やフレンドリストへのアクセス<br></li>
<li>パフォーマンス分析画面：<br>
・トピックごとの成績や強み、改善が必要な部分など、ユーザーの詳細なパフォーマンス分析を表示<br></li>
<li>フレンドリスト画面：<br>
・ユーザーのフレンドリストを、それぞれの成果とポイントとともに表示<br>
・フレンドを追加、削除、検索する機能<br>
・戦略を話し合ったり、複雑な問題について助け合ったりするためのチャット機能へのアクセス<br></li>
<li>設定画面：<br>
・通知やサウンド、アクセシビリティ（ユーザー補助）などの環境設定が可能<br>
・子供のアカウントを監視し、管理するための保護者設定<br></li>
<li>チャット画面：<br>
・フレンドと会話したり、クイズやチャレンジ問題を送ったり、数学の問題について話し合ったりすることが可能<br></li>
</ol><p>画面とそれらの関係をこのように整理することで、MathWizは十分に定義された情報アーキテクチャを持つことができ、使いやすくて楽しいユーザーエクスペリエンスを実現できます。<br></p></div></div>
</details>
<p>これはまだ製品の土台ではありませんが、この基本構造案をもとにユーザーとのインタラクションを開発し、この案をデザインの初期段階とすることができます。</p>
<p>悪くないではありませんか！</p>
<p>ChatGPTに製品の最適な配色を提案してもらうことはできるでしょうか？普段は<a href="http://colormind.io/?ref=hackernoon.com">Colormind</a>や<a href="https://colorhunt.co/?ref=hackernoon.com">Colorhunt</a>、<a href="https://coolors.co/?ref=hackernoon.com">Coolors</a>といった他のツールを使用していますが、今回はChatGPTの意見を聞いてみたいと思います。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-3wd3a1k.jpeg">
<em>ChatGPTの回答</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>それでは続けましょう。数学クイズアプリでは、色が重要な役割を果たす場合があります。次のタスクは、数学クイズアプリMathWizのブランドカラー、プライマリーカラー、セカンダリーカラーを含む、16進コード付きのカラーパレットを作成することです。</p><p>よく考えられたカラーパレットは、視覚的に魅力的で、やる気を起こさせる学習環境を生み出し、MathWizのユーザーエクスペリエンスを格段に向上させることができます。ここに挙げた色は、心地良く楽しい雰囲気を維持しつつ、興味をかき立て、やる気を引き出し、集中力を高める効果が期待できます。以下がブランドカラー、プライマリーカラー、セカンダリーカラーを含むMathWizのカラーパレット案になります。</p><ol>
<li>ブランドカラー：<br>
・ディープブルー（#274472）：この色は、信用、安定、信頼性を表します。これらは教育アプリに欠かせない要素です。ディープブルーはアプリのロゴ、ヘッダー、ナビゲーションの主要要素に使用します。</li>
<li>プライマリーカラー：<br>
・ライトブルー（#4B8BBE）：この色は気持ちを落ち着かせ、親近感を抱かせます。そのため、背景やボタン、インタラクティブ要素に適しています。<br>
・ティール（#009688）：この鮮やかな色は、アクセントに使用したり、CTAボタンや重要な情報などに注意を引き、行動を促したい場合にも使用できます。<br></li>
<li>セカンダリーカラー：<br>
・ソフトイエロー（#FFEB3B）：この色は暖かみとエネルギーを与え、進捗インジケータやバッジ、リワードのハイライトに使用できます。<br>
・ライトグレー（#F5F5F5）：この中立色は、背景色として適しています。また、強烈すぎる印象になったり、注意をそらせたりしないようにしつつ、コントラストを与えます。<br>
・ダークグレー（#616161）：この色は、テキストやアイコンに使用できます。クリーンでモダンな外観を保ちつつ、可読性を確保します。<br></li>
</ol><p>MathWizのカラーパレット案は、心地良くも興味をかき立てるような、視覚的に魅力的な環境を作り出し、ユーザーに学ぶことを促しつつ、アプリを楽しんでもらうことを意図しています。信頼できるブランドカラーを鮮やかなプライマリーカラーやセカンダリーカラーと組み合わせることで、MathWizはユーザーの注意を引き、長期間にわたる学習セッションを促します。</p></div></div>
</details>
<p>なかなか有望です！筆者は色の組み合わせの記述が詳細である点と、説明が簡潔にまとめられている点が特に気に入りました。このパレットを再現してみましたが、結果は概ね満足のいくものでした。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-5ke3a63.jpeg">
<em>カラーパレット</em></p>
<p>フォントはどうでしょうか？システムのSan FranciscoフォントとNew Yorkフォントは除外し、選択肢の多様化を図りたいと思います。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-gmf3a3t.jpeg">
<em>フォントの提案</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>見出しと本文のフォントの組み合わせを3つ提案してください。iOS向けのアプリであることを踏まえつつ、ネイティブのシステムフォント（San FranciscoとNew York）は除外してください。</p><p>MathWizのような数学クイズアプリに使用するフォントの最適な組み合わせを選ぶことは、可読性、ユーザーエンゲージメント、全体的な視覚的魅力を確保する上で極めて重要です。フォントはモダンで読みやすく、アプリのデザインを補完するものでなければなりません。MathWizに適した、見出しと本文のフォントの組み合わせを以下に3つ用意しました。</p><ol>
<li>見出し：Montserrat | 本文：Open Sans<br>
・Montserratはモダンで汎用性の高いサンセリフ体のフォントであり、見出しやタイトルの見栄えを良くします。独特な幾何学的構造を持ち、クリーンで現代的な雰囲気があります。<br>
・Open Sansは非常に読みやすく、汎用性の高いサンセリフ体のフォントであり、印刷用とデジタル用の両方に適しています。可読性に優れ、親しみやすくオープンな見た目であり、本文用として理想的です。<br></li>
<li>見出し：Roboto Slab | 本文：Roboto<br>
・Roboto Slabは現代的なスラブセリフ体のフォントであり、幾何学的な形状や親しみやすい曲線が特徴です。見出しに個性的なタッチを加えますが、過度に目を引くということもありません。<br>
・Robotoは人気のあるサンセリフ体のフォントであり、可読性と汎用性に定評があります。Roboto Slabと相性が良く、アプリ全体に統一感のあるモダンな外観を与えます。<br></li>
<li>見出し：Lato | 本文：Nunito<br>
・Latoはやや丸みを帯びたディテールが特徴で、親しみやすく暖かみのある外観のサンセリフ体のフォントです。見出しに適していて、クリーンでモダンな見た目を与えます。<br>
・Nunitoは丸みを帯びたサンセリフ体のフォントで、親しみやすさがあります。可読性に優れ、Latoとの相性も良く、調和のとれた視覚的に魅力的な組み合わせです。<br></li>
</ol><p>これらのフォントの組み合わせは、モダンなデザインと可読性のバランスが取れており、MathWizのユーザーにとってコンテンツを扱いやすくします。これらの内いずれかの組み合わせを選ぶことで、統一感の取れた視覚的に魅力的なデザインを生み出し、ユーザーエクスペリエンスを向上させることができます。</p></div></div>
</details>
<p>技術的な観点で言うと、回答はかなり正確ではありますが、一見すると面白味に欠けます。では、これらのフォントが実際どのように見えるのか確認してみましょう。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-xsg3a7m.jpeg">
<em>フォントの比較</em></p>
<h2>競合の一次分析</h2>
<p>競合アプリ（他の数学アプリ）に関する詳細な調査は、<a href="https://math-master.org/?ref=hackernoon.com">MathMaster</a>における筆者のデザインプロセスに欠かせない部分であり、AIが大いに役立っています。ChatGPTは、さまざまな情報源から大量のデータを自動的に集めて処理し、競合分析を手助けしてくれます。希望するデータの表示形式（表形式など）を指定するだけで、適切な分析結果が得られます。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-uwh3a2r.jpeg">
<em>MathWizの競合アプリ</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>同じタイプの競合するアプリをリストアップし、ステークホルダーに発表できるよう比較分析してください。比較分析結果は表にまとめてください。</p><p>MathWizの競合アプリを以下にリストアップし、比較分析結果を表にまとめました。この分析では、十分な情報をもとに意思決定を行い、MathWizのビジネスチャンスを見極められるよう、各アプリの主な機能、長所、短所、価格、対象ユーザーを比較しました。</p><table>
<thead>
<tr>
<th>競合アプリ</th>
<th>主な機能</th>
<th>長所</th>
<th>短所</th>
<th>価格</th>
<th>対象ユーザー</th>
</tr>
</thead>
<tbody>
<tr>
<td>Khan Academy</td>
<td>包括的なカリキュラム<br>個別化された学習パス<br>進捗管理<br>ゲーミフィケーション</td>
<td>確立されたブランド<br>充実したコンテンツ<br>年齢層を問わない</td>
<td>UIの情報量が多すぎる<br>ソーシャル機能がない</td>
<td>無料</td>
<td>生徒・学生<br>教員<br>保護者<br>独習者</td>
</tr>
<tr>
<td>Photomath</td>
<td>カメラベースの問題解答<br>ステップバイステップの解<br>複数の解答方法</td>
<td>画期的な問題解答のアプローチ<br>使いやすい</td>
<td>カメラを使った問題解答のみに対応、クイズや練習問題に重点を置いていない</td>
<td>無料<br>Photomath Plusのサブスクリプションは月額$9.99</td>
<td>生徒・学生<br>教員<br>保護者</td>
</tr>
<tr>
<td>Mathletics</td>
<td>アダプティブラーニング<br>ターゲットを絞った練習問題<br>リアルタイムの数学コンテスト<br>進捗管理</td>
<td>興味をそそるリアルタイムのコンテスト<br>強力なカリキュラム</td>
<td>サブスクリプションベース<br>気軽に学びたい人向けではない<br>社会人にあまり重点を置いていない</td>
<td>サブスクリプションベース<br>月額$12.99〜</td>
<td>幼稚園児から高校生<br>教員<br>保護者</td>
</tr>
<tr>
<td>Prodigy Math Game</td>
<td>カリキュラムに沿ったコンテンツ<br>アダプティブラーニング<br>ゲームベースの学習<br>進捗管理</td>
<td>興味をそそるゲーム要素<br>幼稚園児から中学生向け</td>
<td>幼稚園から中学校までのカリキュラムのみに対応<br>上級学習者や社会人向けではない</td>
<td>無料<br>オプションのPremiumサブスクリプションは月額$8.95</td>
<td>幼稚園児から中学生<br>教員<br>保護者</td>
</tr>
<tr>
<td>Brilliant</td>
<td>インタラクティブコース<br>問題解決型のアプローチ<br>クイズ<br>日替わりのチャレンジ問題</td>
<td>クリティカルシンキングと問題解決に重点<br>上級学習者向け</td>
<td>無料アクセスは制限あり<br>基本的な数学の知識にあまり重点を置いていない</td>
<td>制限付きで無料アクセス<br>Premiumサブスクリプションは月額$24.99</td>
<td>高校生<br>大学生<br>生涯学習者</td>
</tr>
</tbody>
</table><p>価格や対象ユーザーなどの情報も含めたこの詳細な比較分析表により、ステークホルダーは現在の市場状況に関する包括的な理解を得られるでしょう。MathWizのビジネスチャンスを見極め、ユーザーを獲得し、引きつける魅力的な製品を開発する上で、この情報が役立つはずです。</p></div></div>
</details>
<h2>モックアップやプロトタイプの作成プロセスを加速させる</h2>
<p>ChatGPTは、要素の説明を生成し、説明の配置やインタラクションを提案することで、モックアップの作成プロセスを一部自動化することができます。それにより、デザイナーは開発プロセスをスピードアップし、デザインのよりクリエイティブな部分に注力することができます。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-2qi3ayy.jpeg">
<em>モックアップの作成</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>MathWizアプリのフローとデザインを紹介するためにFigmaでプロトタイプを構築できるよう、プロトタイプのスクリプトを作成してください。</p><p>MathWizアプリの主な画面とインタラクションの概要を示すプロトタイプのスクリプトを以下に作成しました。このスクリプトを使用してFigmaでプロトタイプを構築し、アプリのフローとデザインを紹介できるでしょう。</p><ol>
<li>スプラッシュスクリーン：<br>
・MathWizのロゴと、その下にアプリの名前を表示<br>
・テキスト例：「MathWiz」<br></li>
<li>オンボーディング画面（新規ユーザー向けオプション）：<br>
・スライド1：「MathWizへようこそ！楽しいクイズやチャレンジ問題で数学をマスターしよう。」<br>
　・黒板に数学の問題を解いているキャラクターのイラストを入れる。<br>
・スライド2：「幅広い選択肢からトピックを選び、自分に合った学習体験を作ろう。」<br>
　・算数、代数、幾何学など、数学のさまざまなトピックを表すアイコンを表示<br>
・スライド3：「バッジを獲得し、デイリークエストを実施し、学習の進捗を管理しよう。」<br>
　・成果を表すバッジコレクションとプログレスバーを表示<br>
・スライド4：「準備はいいですか？新規登録またはログインして学習プロセスを始めましょう！」<br>
　・「新規登録」と「ログイン」のボタンを含める<br></li>
<li>ホーム画面：<br>
・ウェルカムメッセージと、一人ひとりに合わせたおすすめクイズを表示<br>
　・テキスト例：「[ユーザー名]さん、お帰りなさい！[ユーザー名]さんにおすすめのクイズをご案内します。」<br>
・水平スクロール可能なおすすめクイズリスト（画像、タイトル）を含める<br>
・画面下部に「トピック」「デイリークエスト」「プロフィール」に移動するためのアイコンを表示<br></li>
<li>トピック画面：<br>
・算数、代数、幾何学、三角法、微分積分など、数学のトピックの一覧を表示<br>
・画面上部にトピックを検索するための検索バーを含める<br>
　・難易度や学年に応じてトピックを絞り込むためのフィルターを追加する<br>
　・サブトピックやクイズにアクセスするため、各トピックを選択できるようにする<br></li>
<li>サブトピック画面：<br>
・選択したトピック内のサブトピックのリストを表示<br>
　・代数の例：線形方程式、二次方程式、多項式、連立方程式<br>
・クイズにアクセスするため、各トピックを選択できるようにする<br></li>
<li>クイズ画面：<br>
・選択式のクイズ問題とタイマー（該当する場合）を表示<br>
　・問題例：「次の方程式を解きなさい：2x + 3 = 11」<br>
　・多肢選択式解答：A) x = 4、B) x = 3、C) x = 2、D) x = 1<br>
・答えを送信、問題をスキップ、クイズを終了すためのボタンを含める<br>
　・ボタンテキスト：「送信」「スキップ」「終了」<br>
・クイズを終えたら、結果とともに正解、解説、獲得ポイントを表示<br>
　・テキスト例：「おめでとうございます！80ポイント獲得しました。以下の正解と解説を確認してください。」<br></li>
<li>デイリークエスト画面：<br>
・利用可能なデイリークエストとそれぞれのリワード（ポイント、バッジ）を表示<br>
　・クエスト例：「幾何学クイズを5問答えて50ポイントと幾何学マスターバッジを獲得しよう。」<br>
・プログレスバーで各クエストのステータス（実施済みかどうか）を表示<br>
　・テキスト例：進捗：5問中3問完了）<br>
・クエストの開始ボタンを含める<br>
　・ボタンテキスト：「クエスト開始」<br></li>
</ol><p>このスクリプトをもとに、MathWizアプリのフローとデザインを効果的に紹介するFigmaプロトタイプを作成することができます。それにより、ステークホルダーはユーザーエクスペリエンスを視覚化し、アプリの機能と外観についてフィードバックすることができます。</p></div></div>
</details>
<h2>テキストコンテンツの生成</h2>
<p>AIは、製品のランディングページやその他の部分に表示するさまざまなテキストを効率的に生成することができ、便利です。自動化により作業効率を向上させ、テキスト作成に要する時間を削減することができます。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-ncj3a0m.jpeg">
<em>テキストコンテンツの生成</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>MathWizアプリのランディングページ用のコピー文を作成してください。</p><p><strong>MathWiz – 楽しいクイズとチャレンジ問題で数学をマスターしよう</strong></p><p>思わず引き込まれてしまうクイズや、わくわくするチャレンジ問題を通じて、数学を学ぶ楽しさを発見してください。MathWizは、自分のペースで数学をマスターできる究極のアプリです。退屈な数学のレッスンにおさらばして、自分のレベルや目標に合わせた学習体験を始めましょう。</p><p><strong>特長：</strong></p><p>幅広いトピック</p><p>算数から代数、幾何学、微分積分に至るまで、MathWizは包括的なトピックとサブトピックを提供しており、年齢や能力を問わずあらゆる学習者にご利用いただけます。</p><p>アダプティブラーニング</p><p>独自のスマートアルゴリズムにより、ユーザーの成績に応じてクイズの難易度を調整し、真に個別化された学習体験を提供します。適度に難しい問題なので、圧倒されることもなく興味が続きます。</p><p>ゲーミフィケーションとリワード</p><p>クイズやデイリークエストをこなしてポイントを獲得し、バッジを解放し、リーダーボードの上位ランクインを目指しましょう。フレンドと競い合ったり、学習プロセスの新しいマイルストーン到達を目指して頑張りましょう。</p><p>パフォーマンスの追跡</p><p>自分の強みや改善が必要な部分、トピックごとの成績などを示した視覚的に魅力的なチャートや分析結果で、進捗を把握しましょう。</p><p>共同学習</p><p>インタラクティブな学習コミュニティを通じてフレンドとつながり、クイズやチャレンジ問題を送り、数学の問題について話し合い、成果を共有しましょう。</p><p>アクセシビリティと優れた操作性</p><p>iOS向けに開発されたMathWizは、直感的なインターフェース、カスタマイズ可能なアバター、そして誰もが楽しくシームレスな学習体験を味わうことを可能にするさまざまなアクセシビリティ機能を提供します。</p><p><strong>MathWizで内に秘めた数学のポテンシャルを解き放とう</strong></p><p>楽しさ満載の数学アドベンチャーに出発する用意はいいですか？今すぐMathWizをダウンロードして、やりがいを感じながら楽しく学べるクイズやチャレンジ問題を通じて数学をマスターしましょう。</p><p><strong>［App Storeでダウンロードボタン］</strong></p><p>［ユーザーの声をカルーセルで表示—満足したユーザーのコメントを表示し、アプリのメリットと有効性を強調する］</p><p>［フッター—SNS、プライバシーポリシー、利用規約、サポート／問い合わせ窓口情報を含める］</p></div></div>
</details>
<h2>デザインシステムのドキュメント作成の加速</h2>
<p>ChatGPTは、コンポーネントやその使用方法の説明を自動的に生成してくれるため、デザインシステムのドキュメント作成プロセスを容易にします。そのため、デザイナーはプロジェクトの重要な部分に注力でき、ドキュメントの一貫性や分かりやすさを確保することができます。</p>
<p>では、例としてAIが作成したカラーパレットの詳細な説明を見てみましょう。カラーパレットの説明にはデザイントークンも含まれ、その他にタイプスケールも作成してみました。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-m3k3aas.jpeg">
<em>カラーパレットの制作</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>先ほど提供した色情報を使用して、デザインシステムのカラーパレットを作成してください。名前、16進コード、デザイントークン名、色の使用目的を含め、表にまとめてください。</p><table>
<thead>
<tr>
<th>名前</th>
<th>16進コード</th>
<th>デザイントークン</th>
<th>使用目的</th>
</tr>
</thead>
<tbody>
<tr>
<td>ディープブルー</td>
<td>#274472</td>
<td>--color-brand</td>
<td>アプリのロゴ<br>ヘッダー<br>ナビゲーションの主要要素</td>
</tr>
<tr>
<td>ライトブルー</td>
<td>#4B8BBE</td>
<td>--color-primary-1</td>
<td>背景<br>ボタン<br>インタラクティブ要素</td>
</tr>
<tr>
<td>ティール</td>
<td>#009688</td>
<td>--color-primary-2</td>
<td>アクセント<br>CTAボタン<br>重要な情報</td>
</tr>
<tr>
<td>ソフトイエロー</td>
<td>#FFEB3B</td>
<td>--color-secondary-1</td>
<td>進捗インジケータ<br>バッジ<br>リワード</td>
</tr>
<tr>
<td>ライトグレー</td>
<td>#F5F5F5</td>
<td>--color-secondary-2</td>
<td>背景<br>コントラスト効果（強烈すぎず、注意をそらさない）</td>
</tr>
<tr>
<td>ダークグレー</td>
<td>#616161</td>
<td>--color-secondary-3</td>
<td>テキストとアイコン<br>クリーンでモダンな外観を保ちつつ可読性を確保</td>
</tr>
<tr>
<td>セカンダリーテキスト</td>
<td>#757575</td>
<td>--color-text-2</td>
<td>セカンダリーテキスト要素（キャプション、ラベル、重要性の低い情報など）</td>
</tr>
<tr>
<td>エラー</td>
<td>#D32F2F</td>
<td>--color-error</td>
<td>エラーメッセージ<br>アラート<br>問題やトラブルを知らせる通知</td>
</tr>
<tr>
<td>グレー1</td>
<td>#E0E0E0</td>
<td>--color-gray-1</td>
<td>淡い背景<br>境界線<br>セパレーター</td>
</tr>
<tr>
<td>グレー2</td>
<td>#BDBDBD</td>
<td>--color-gray-2</td>
<td>無効化された要素<br>無効なボタン<br>入力</td>
</tr>
<tr>
<td>グレー3</td>
<td>#9E9E9E</td>
<td>--color-gray-3</td>
<td>プレースホルダーテキスト<br>優先度の低い情報</td>
</tr>
</tbody>
</table><p>この表は、MathWizアプリのデザインシステム用のカラーパレットを表し、各色の名前、16進コード、デザイントークン名、使用目的を含みます。このような形で整理することで、アプリのビジュアルデザインを通して一貫性を保ち、デザイナーや開発者が適切な色を参照して適用しやすくなるでしょう。</p></div></div>
</details>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-axl3a6a.jpeg">
<em>デザインシステムの作成</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>iOS向けのアプリであることを踏まえ、MathWizデザインシステム用のタイプスケールを作成してください。</p><p>タイプスケールとは、フォントサイズ、フォントの太さ、行の高さを整理したものであり、デザインシステムにおいてタイポグラフィの視覚的階層を生み出します。以下はMathWizアプリのデザインシステム用のタイプスケールで、iOSのモバイルアプリ向けに作成されています。</p><table>
<thead>
<tr>
<th>レベル</th>
<th>フォントサイズ</th>
<th>行の高さ</th>
<th>フォントの太さ</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>ディスプレイ</td>
<td>32</td>
<td>40</td>
<td>ボールド</td>
<td>アプリのタイトル<br>オンボーディング画面の大見出し<br>特別プロモーション</td>
</tr>
<tr>
<td>見出し</td>
<td>28</td>
<td>36</td>
<td>ボールド</td>
<td>セクション見出し<br>ダッシュボードタイル</td>
</tr>
<tr>
<td>サブ見出し</td>
<td>24</td>
<td>32</td>
<td>セミボールド</td>
<td>サブセクション見出し<br>CTAボタン<br>クイズタイトル</td>
</tr>
<tr>
<td>本文</td>
<td>20</td>
<td>28</td>
<td>レギュラー</td>
<td>本文<br>クイズ問題<br>リスト項目<br>ラベル</td>
</tr>
<tr>
<td>キャプション</td>
<td>18</td>
<td>24</td>
<td>レギュラー</td>
<td>本文のセカンダリーテキスト<br>キャプション<br>ツールチップ</td>
</tr>
<tr>
<td>ラベル</td>
<td>16</td>
<td>22</td>
<td>レギュラー</td>
<td>小ラベル<br>入力欄<br>ナビゲーション項目</td>
</tr>
<tr>
<td>細字</td>
<td>14</td>
<td>20</td>
<td>レギュラー</td>
<td>細字<br>利用規約<br>プライバシーポリシー</td>
</tr>
</tbody>
</table><p>注：フォントサイズは、画面サイズや解像度が異なる場合でもアクセシビリティと一貫したユーザーエクスペリエンスを確保するため、sp（スケール非依存ピクセル）で指定します。</p><p>MathWizアプリデザインシステムでこのタイプスケールを使用することにより、一貫性のあるタイポグラフィ階層を維持し、可読性を高めるとともに、視覚的に魅力的なユーザーエクスペリエンスを創出することができます。前に提案したフォントペア（見出しはRoboto、本文はOpen Sans、など）を使用することで、アプリのデザインをより一層高めましょう。</p></div></div>
</details>
<h2>UXタスクの自動化</h2>
<p>ChatGPTを使用することで、ユーザー手順の分析やペルソナの特定、詳細な情報アーキテクチャの構築といったUX関連の複雑な作業を自動化できます。AIが詳細なデータ分析を行ってくれるので、よりインテリジェントで効果的なソリューションを作成できます。</p>
<p>例として、MathWizアプリのユーザーペルソナをいくつか作成したので見てみましょう。</p>
<p><img src="https://hackernoon.imgix.net/images/Hj6zDcAXL9SsFN0sThCgcr0SQva2-1zm3aip.jpeg">
<em>ユーザーペルソナ</em></p>
<details>
<summary><strong>画像内テキストの翻訳</strong></summary>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>UXペルソナとは、ユーザーベースを代表するユーザーに関する情報や知見を集約したものであり、主要なタイプと考えられるユーザー像（メインペルソナ）です。必要に応じて他にもいくつかのペルソナを作成します。MathWizアプリ用にUXペルソナを3つ生成してください。</p><p>ペルソナ1：<strong>メインペルソナ</strong></p><p><strong>名前</strong>：ソフィア<br>
<strong>年齢</strong>：14歳<br>
<strong>職業</strong>：生徒<br>
<strong>場所</strong>：米国ニューヨーク州<br>
<strong>略歴</strong>：ソフィアは勉強が大好きな高校生で、クラスでも良い成績を収めています。特に数学が好きで、数学コンテストに好んで参加しています。暇があればスマホでパズルゲームをして遊んでいます。<br></p><p><strong>目標</strong>：</p><ol>
<li>数学の力をつけて、数学コンテストで優位に立つ。</li>
<li>数学の練習問題を解ける、楽しくて夢中になれるアプリを見つける。</li>
<li>進捗を確認し、改善できる部分を見つける。</li>
</ol><p><strong>ペインポイント</strong>：</p><ol>
<li>彼女のレベルに合った難しい数学問題があまりない。</li>
<li>従来の数学の勉強方法ではモチベーションを保てない。</li>
<li>学校の勉強と課外活動、自由時間のバランスがをうまくとれない。</li>
</ol><p>ペルソナ2：<strong>セカンダリーペルソナ</strong></p><p><strong>名前</strong>：イーサン<br>
<strong>年齢</strong>：35歳<br>
<strong>職業</strong>：エンジニア<br>
<strong>場所</strong>：米国テキサス州オースティン<br>
<strong>略歴</strong>：イーサンは土木技師で、仕事で頻繁に数学を使用します。大学時代に比べて自分の数学の知識が少しサビついてきていると感じており、手軽に知識をリフレッシュして能力を維持できる方法を探しています。<br></p><p><strong>目標</strong>：</p><ol>
<li>数学の練習問題を定期的に解き、スキルの維持・向上を図る。</li>
<li>今の自分のレベルに合った、個別化された学習体験を提供するアプリを見つける</li>
<li>仕事の休憩時間や通勤時間にアプリを使う。</li>
</ol><p><strong>ペインポイント</strong>：</p><ol>
<li>数学のスキル向上に費やせる時間が限られている。</li>
<li>幅広い数学のトピックに対応したプラットフォームがなかなか見つからない。</li>
<li>柔軟なスケジュールで学べるアプリが必要。</li>
</ol><p>ペルソナ3：<strong>セカンダリーペルソナ</strong></p><p><strong>名前</strong>：グレイス<br>
<strong>年齢</strong>：27歳<br>
<strong>職業</strong>：小学校教師<br>
<strong>場所</strong>：米国カリフォルニア州ロサンゼルス<br>
<strong>略歴</strong>：グレイスは小学校の教師であり、生徒が算数の知識を身につける手助けをしたいと思っています。生徒や保護者に勧められる面白い教育アプリを常に探しています。<br></p><p><strong>目標</strong>：</p><ol>
<li>面白くて勉強になる、生徒に適した算数（数学）アプリを見つける。</li>
<li>生徒たちに学校以外の時間でも算数の練習をするよう促す。</li>
<li>生徒の進捗を確認し、アプリの有効性を評価する。</li>
</ol><p><strong>ペインポイント</strong>：</p><ol>
<li>さまざまなレベルに対応できて、年齢的にも相応しい算数（数学）アプリが見つからない。</li>
<li>生徒に安全でフレンドリーな環境を提供するアプリが必要。</li>
<li>生徒が飽きないよう、学びと楽しさのバランスが取れたアプリが必要。</li>
</ol></div></div>
</details>
<h2>ユーザー調査の実施</h2>
<p>ChatGPTはユーザーからのフィードバックを自動的に分析し、重要な問題やトレンドを示し、製品のさまざまな側面についての分かりやすさや有効性についてレポートを生成することができます。デザイナーはユーザーのニーズにより素早く対応し、製品に適切な変更を加えることができます。</p>
<h2>効果的なコミュニケーションの確保</h2>
<p>ChatGPTは、技術用語や複雑な概念を分かりやすく説明することで、デザイナーや開発者、その他のチームメンバーがコミュニケーションを取りやすくしてくれます。チーム全員がプロジェクトの目標や要件を理解し、連携を深め、より短時間で成果を出せるよう手助けしてくれます。</p>
<h2>ChatGPTを使って他にできること</h2>
<ul>
<li>ユーザーストーリー、シナリオ、ユーザージャーニーマップ、ユーザーフローの作成</li>
<li>デザインやテキストのABテストの選択肢作成</li>
<li>デザインスプリントの計画</li>
<li>ポートフォリオ用の独自ケース作成</li>
<li>記事や投稿、その他デザイン関連作業のアイデア出し</li>
<li>専門能力の開発</li>
<li>続く</li>
</ul>
<h2>結論の代わりに</h2>
<p>条件付きのMathWizアプリの例を用いて、UI/UXデザイナーやプロダクトデザイナーが仕事でChatGPTを使用する具体的な方法を説明しましたが、ご自身の仕事にも適用可能な有益な情報はありましたでしょうか。</p>
<p>最後に、ネット上で最も頻繁にされている質問の1つについて考えてみたいと思います。</p>
<p><strong>AIがデザイナーに取って代わり、その仕事を奪う日は来るのでしょうか？</strong></p>
<p>ドラムロール…
AIが近い将来デザインの仕事を完全に置き換える可能性は極めて低いと思います（ただし、反復作業や自動化できる作業は除きます）。なぜでしょうか。それは、あらゆるビジネスは個別化されたケースであり、ユーザーグループやその他さまざまな要素についても同じことが言えるからです。デザインは、視覚対象物の創出にとどまらず、共感性や創造性、人間中心のアプローチによる問題解決なども関わる仕事です。これらのスキルは、AIが容易に再現できるものではありません。</p>
<p>したがって、ChatGPTはAIのパーソナルアシスタントと見なすことができるでしょう。そのようなものであれば、誰もが欲しいと思うのではないでしょうか。現にこのようなツールがすでに存在するので、使い方を学ぼうではありませんか。</p>
<p>それでは最後のコメントです。<strong>AIがデザイナーに取って代わることはないでしょう。しかし、AIを利用しなければ、AIを使うデザイナーに淘汰されるかもしれません</strong>。</p>]]></content:encoded></item><item><title><![CDATA[テストピラミッド万歳]]></title><description><![CDATA[クイックサマリー：「テストピラミッド」は、自動テストをUI、サービス、ユニット単位に整理することで、開発に自動テストを組み込む方法を示すために作成されました。2012年に定義されて以降、このモデルは…]]></description><link>https://postd.cc/long-live-test-pyramid/</link><guid isPermaLink="false">https://postd.cc/long-live-test-pyramid/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[テスト]]></category><category><![CDATA[テストツール]]></category><pubDate>Wed, 28 Feb 2024 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p><strong>クイックサマリー</strong>：<a href="https://martinfowler.com/bliki/TestPyramid.html">「テストピラミッド」</a>は、自動テストをUI、サービス、ユニット単位に整理することで、開発に自動テストを組み込む方法を示すために作成されました。2012年に定義されて以降、このモデルは次第に使われなくなってきたように思いますが、本当に廃れてしまったのでしょうか。この記事では、最新のテスト戦略を紹介するとともに、今日のソフトウェア開発におけるテストピラミッドの関連性を検討します。</p>
<hr>
<p>筆者の同僚である<a href="http://www.jpietrzyk.de/">ジャン・フィリップ・ピエトルチェク</a>が、かつてコードを書く開発者の責任について、次のように述べました。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>「我々の仕事の成果を最終的に使用する人々は、（中略）我々がただ最善を尽くすだけでなく、実際に機能するものを作ることを期待しているのです。」</p><p>— ジャン・フィリップ・ピエトルチェク</p></div></div>
<p>彼の言葉は、私たちが書くコードをそれに依存する人々の観点からとらえている点で非常に印象に残りました。目まぐるしく変化するこの世界では、ユーザーは私たちが可能な限り最高のコードを記述し、開発したソフトウェアが実際に機能することを期待しています。このレベルの期待に応えるのは当然容易ではなく、だからこそ、開発スタックにおいてはテストが重要な要素になるのです。テストでは、仕事の質を評価し、さまざまなシナリオに照らして検証を行うことで、顕在化する前に問題を特定します。</p>
<p>テストピラミッドは数あるテスト戦略の内の一つです。2012年に紹介されて以降、おそらく10年近くは主要なテストモデルとして利用されてきましたが、最近は以前ほど参照されなくなっています。テストピラミッドは今でも定番のテスト手法なのでしょうか。それとも、他の手法も多数台頭してきている中、昨今の開発事情により適した最新のモデルの影に隠れ、埋もれてしまっているのでしょうか。</p>
<p>この記事ではその点を探っていきたいと思います。</p>
<h2>テスト戦略の目的 <a href="#テスト戦略の目的">#</a><a name="テスト戦略の目的"></a></h2>
<p>ユーザーの信頼を得るためには、書いたコードによって製品がユーザーの期待どおり確実に機能するよう、強固なテスト戦略が求められます。優れたテストコードを書くためには、まず何から始めればよいのでしょうか。テストコードはいくつ必要でしょうか。これまで多くの人がこれらの問いへの答えを見つけようと取り組んできました。しかし、求めていた気づきを私に与えてくれたのは、ケント・C・ドッズの次の一言でした。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>「最大の問題は、何をテストするのかということと、実装に関する詳細をテストすることで得られる偽りの自信ではなく、真の自信が得られるような方法でテストを行うにはどうすればよいかを見極めることです。」</p><p>— ケント・C・ドッズ</p></div></div>
<p>これが出発点です。<strong>テストの目標を決めることが、テスト戦略を策定する上で最も重要な作業になります</strong>。ネット上には誤った判断を揶揄したミームが溢れていますが、そうした判断の多くは、単にテストの目的や、いくつテストを行えば確信が得られるのかが不明であったことに起因します。テストには、コードを適切に検証し、コードが期待どおり機能することを確認するための「最適な比率」があります。</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">2 unit tests. 0 integration tests. <a href="https://t.co/K2MZKwr8JT">pic.twitter.com/K2MZKwr8JT</a></p>&mdash; DEV Community (@ThePracticalDev) <a href="https://twitter.com/ThePracticalDev/status/892788721350836225?ref_src=twsrc%5Etfw">August 2, 2017</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><em>2つの単体テスト統合テストなし</em></p>
<p>問題は、さまざまなユニットを結合してどう連動させるのかについての戦略を持たず、1種類のテスト（多くの場合は単体テスト）にのみ重点を置く開発者が多いことです。例えば、洗面台のテストを行う際、蛇口と排水口を別々にテストしても、両者が正常に連動するのかは分かりません。単体テストでは蛇口が問題なく機能していても、排水口が詰まっているにも関わらず蛇口から水が流れ続ければ、洗面台として正常に機能しているとは言えません。</p>
<p>テスト手法について説明する際、ピラミッドモデルの例のようにしばしば「形」が用いられます。この記事では、筆者が見てきた形をいくつか紹介し、それぞれの形を実際のテストに当てはめるとどうなのか、結論としてどのテスト戦略が、筆者の考える今日の開発に適した包括的テストの基準を満たすのかを考察したいと思います。</p>
<h2>基本に戻る <a href="#基本に戻る">#</a><a name="基本に戻る"></a></h2>
<p>その前に、各種テストの一般的な定義をおさらいしましょう。</p>
<h3>手動テスト</h3>
<ul>
<li>人の手によって行われるテストです。実際のユーザーがユースケースに従ってアプリ内をクリックして回り、場合によってはユースケースに記述されていない方法で予期しないシナリオでのアプリの動作を検証します。多くの場合、このテストは製品チームが観察する中、ユーザーとのリアルタイムでの対面もしくはリモートインタビューの形式で行われます。</li>
</ul>
<h3>単体テスト</h3>
<ul>
<li>このタイプのテストでは、アプリを「ユニット」と呼ばれるテスト可能で独立した小さな構成要素に分け、各ユニットを個別にテストし、正常に動作することを確認します。</li>
</ul>
<h3>統合テスト</h3>
<ul>
<li>コンポーネントまたはシステム間の連携に重点を置いたテストです。各ユニットを組み合わせてテストし、統合された状態で全体として正常に機能することを確認します。</li>
</ul>
<h3>E2E（エンドツーエンド）テスト</h3>
<ul>
<li>このタイプのテストでは、コンピューターが実際のユーザーとのやり取りをシミュレーションします。一定の手順に従うことが求められる作業をユーザーが完遂できるのか、期待する結果が得られるのかなど、ユーザーの視点に立って検証を行うためのテストと考えてください。インプットに対して適切なアウトプットが得られるのか確認することで、ユーザー体験全体を検証します。</li>
</ul>
<p>では、これらのテストをどう組み合わせればよいでしょうか。従来アプリケーションを問わず定番として用いられてきたのが、各テストを包括的なテストスイートとしてまとめたテストピラミッドです。</p>
<h2>偉大なるテストピラミッド万歳 <a href="#偉大なるテストピラミッド万歳">#</a><a name="偉大なるテストピラミッド万歳"></a></h2>
<p>マイク・コーンが著書<a href="https://www.mountaingoatsoftware.com/books/succeeding-with-agile-software-development-using-scrum">『Succeeding with Agile』</a>で最初に紹介し、マーチン・ファウラーが<a href="https://martinfowler.com/articles/practical-test-pyramid.html">「実用的なテストピラミッド」</a>という記事でさらに発展させたテストピラミッドは、パフォーマンスとコストに基づいてテストを優先順位付けしています。異なる粒度のテストを記述し、高位レベルのテストは少なく、素早く安価で実施できる信頼性の高い単体テストは多くするよう推奨しています。テストの順序としては、素早く低コストで実施できるものから、時間とコストのかかるものの順に行うよう推奨しています。ピラミッドの最下部には多くの単体テストが位置し、次にサービス（統合テスト）が真ん中に来ます。そして最上部に、E2Eテストを含むより具体的で少数のUIテストが位置します。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://files.smashing.media/articles/long-live-test-pyramid/test-pyramid.jpg">
<em>3層に分かれたピラミッドの手書きイラスト</em>（<a href="https://www.smashingmagazine.com/2023/09/long-live-test-pyramid/#:~:text=into%20three%20tiers.%20(-,Large%20preview,-)">拡大プレビュー</a>）</p>
<p>関係者の間では、テストピラミッドはテスト構造のあるべき姿を単純化しすぎているとの声が高まっています。約10年前にテストピラミッドについての記事を執筆したマーチン・ファウラーは、<a href="https://martinfowler.com/articles/2021-test-shapes.html">この問題について最近ブログ記事を書いています</a>。筆者のチームでは、このモデルは私たちの仕事をエンドユーザーに近づけるものなのか、それとも遠ざけるものなのかという問いも出ています。ピラミッドの高位層は単体テストの信頼性を高め、より優れた価値をもたらしますが、各構成要素がどう連動するのかという大局的な視点に欠けるように思われます。少なくとも私たちには、テストピラミッドが時代遅れになりつつあるように感じられました。</p>
<h2>ピラミッドからダイヤモンドへ <a href="#ピラミッドからダイヤモンドへ">#</a><a name="ピラミッドからダイヤモンドへ"></a></h2>
<p>筆者のチーム内で議論された論点の1つが、ピラミッドが<strong>単体テストに重点を置きすぎている</strong>ということです。ピラミッドは、単体テストの性質と対象範囲を説明する形としては非常に優れています。しかし、単体テストとは何かと4人に問えば、おそらく4通りの回答が返ってくるでしょう。明確化のため、ピラミッドの形を少し変える必要があるかもしれません。</p>
<p>筆者のチームが最も明確化する必要があったのは、単体テストを「いつ」「どこで」で止めるかということです。ピラミッドの形は、単体テストがテストプロセスの大部分を占めることを示唆しますが、私たちはそれが間違っているように感じました。結局のところ、単体テストをまとめるのは統合テストなので。</p>
<p>したがって、テスト戦略を表すピラミッドの見方を変えてみると、ダイヤモンドの形に変化します。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://files.smashing.media/articles/long-live-test-pyramid/testing-diamond-illustration.png">
<em>4層に分かれたピラミッドの手書きイラスト</em>（<a href="https://www.smashingmagazine.com/2023/09/long-live-test-pyramid/#:~:text=pyramid%20split%20into%20four%20tiers.%20(-,Large%20preview,-)">拡大プレビュー</a>）</p>
<p>統合テストは、単体テストには複雑すぎる場合があるため、テストピラミッドの「忘れられた層」と呼ばれることがあります。しかし、テストダイヤモンド（しばしば2つの特定の層に分けられる）ではより重視されます。</p>
<ol>
<li><strong>統合テスト層</strong>
この層は、テストピラミッドの場合とほぼ同じですが、「単体テストとして行うには規模が大きすぎる」と見なされるテストが割り当てられます。つまり、単体テストの層と統合テストの層の中間に位置します。この層には、特定のコンポーネントなどのテストが適しています。</li>
<li><strong>システム統合テスト層</strong>
この層は、APIから取得したデータなどの「実際の」統合テストを中心に扱います。</li>
</ol>
<p>したがって、ダイヤモンドの形は統合テストを行った直後に単体テストを行うプロセスを示唆しますが、それらの単体テストはピラミッドモデルの場合ほど重視されません。そのため、単体テストが重視されなくなった分、統合テスト層に相応の予算が割り当てられます。</p>
<h2>手動テストの位置付けは？ <a href="#自動テストの位置づけは？">#</a><a name="自動テストの位置づけは？"></a></h2>
<p>テスト戦略が「ピラミッド型」であれ「ダイヤモンド型」であれ、重要な手動テストが依然としてプロセスに欠けています。自動テストは確かに重要ですが、手動テストが不要になるほどではありません。</p>
<p>自動テストと手動テストは互いに欠かせないものだと思います。自動テストは定型的な共通作業を不要にし、人間がより注力すべき部分にテスターが集中できるようにする必要があります。自動化は手動テストを置き換えるのではなく、補完すべきなのです。</p>
<p>この点を加味した場合、ダイヤモンドやピラミッドの形はどうなるでしょうか。手動テストはどの層にも含まれていませんが、どこかに入れるべきです。自動テストは効率的にバグを検出してくれますが、より包括的なテストを行うためには手動テストが必要です。とは言え、主に自動テストに重点を置いたテスト戦略が理想的であるのも事実です。</p>
<p>これをテスト戦略の形に当てはめると、ピラミッドやダイヤモンドというよりアイスクリームコーンのような形になります。</p>
<p><img src="https://files.smashing.media/articles/long-live-test-pyramid/testing-ice-cream-cone.png">
<em>4層に分かれた、アイスクリームコーンに似た逆ピラミッドの手書きイラスト</em>（<a href="https://files.smashing.media/articles/long-live-test-pyramid/testing-ice-cream-cone.png">拡大プレビュー</a>）</p>
<p>これは実際に「アイスクリームコーン」と呼ばれる手法です。実装までの時間は長くかかりますが、より確かな自信が得られ、より多くのバグを検出できます。2015年に発表された記事で、<a href="https://saeedgatson.com/the-software-testing-ice-cream-cone/">サイード・ガトソンが簡潔に説明しています</a>。</p>
<p>しかし、ピザのような形で実際にテストの内容を説明しきれるのでしょうか。この概念はグレブ・バームトフによって突き詰められ、彼が<a href="https://changelog.com/posts/the-testing-pyramid-should-look-more-like-a-crab">「Testing crab（蟹）」</a>モデルと呼ぶ形に集約されました。この手法では、スクリーンショットを比較し、人間が差異を検証します。目視テストと機能テストは蟹の胴体部分を構成し、その他のテストは蟹の手足を構成します。テストの際に実装前と実装後のスナップショットを撮影できるツールがあり、撮影したスナップショットを重ね合わせることで、視覚的なリグレッションを確認できます。</p>
<h2>テストトロフィー <a href="#テストトロフィー">#</a><a name="テストトロフィー"></a></h2>
<p>どのテスト手法もコストがかさみますが、テストピラミッドはその点を適切に表しています。ただ、その形自体が現実的ではないか、テストの内容全体と、各テスト層に置かれた重点を考慮するのに効果的ではない可能性があります。したがって、各テスト層と、それぞれどの程度重視すべきかを正確に表した<strong>これらすべての手法の間に妥協点を見つける</strong>必要があります。</p>
<p>ギレルモ・ローチが2016年にこの点を簡潔に表現した次の言葉を筆者は気に入っています。</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Write tests. Not too many. Mostly integration.</p>&mdash; Guillermo Rauch (@rauchg) <a href="https://twitter.com/rauchg/status/807626710350839808?ref_src=twsrc%5Etfw">December 10, 2016</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><em>テストを書こう。ただし書きすぎないこと。主に統合テスト。</em></p>
<p>少し掘り下げてみましょう。</p>
<ul>
<li><strong>テストを書こう</strong>
信頼を築くためだけではなく、メンテナンス時間を節約できるため。</li>
<li><strong>書きすぎないこと</strong>
100%の網羅率は、聞こえは良いですが必ずしも得策ではありません。アプリの詳細をすべて漏れなくテストした場合、少なくとも一部のテストはエンドユーザー体験にとって重要ではなく、テストを実行することが目的化しており、維持コストが増えることを意味します。</li>
<li><strong>主に統合テスト</strong>
統合テストに重点が置かれています。合理的な実行時間を維持しつつ、高いレベルの確信が得られるため、最も事業価値のあるテストです。</li>
</ul>
<p>ケント・C・ドッズの記事を読んでいる人ならば、以下の概念をご存知かもしれません。彼が提唱する<a href="https://kentcdodds.com/blog/the-testing-trophy-and-testing-classifications">「テストトロフィー」</a>手法では、統合テストの優先度が従来のテストピラミッドよりも高く設定されており、ギレルモ・ローチの主張とも完全に一致しています。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://files.smashing.media/articles/long-live-test-pyramid/testing-trophy-illustration.png">
<em>4つの層に分かれた薄い金色のトロフィーの手書きイラスト</em>（<a href="https://files.smashing.media/articles/long-live-test-pyramid/testing-trophy-illustration.png">拡大プレビュー</a>）</p>
<p>ケントは、包括的なテストが製品の成功において果たす重要な役割について説明しています。彼は、単体テストよりも、<strong>製品のコア機能と評価される挙動について理解を深められる統合テストの価値を重視</strong>しています。また、彼はモックアップテストの数を減らし、統合テストの数を増やすことを提案しています。テストトロフィーは、テストの粒度を従来とは少し異なる方法で表した比喩であり、テストを以下の種類に分類しています。</p>
<ol>
<li><strong>静的分析</strong>：これらのテストはデバッグの手順を実行することで、素早くタイプミスを特定します。</li>
<li><strong>単体テスト</strong>：テストトロフィーでは、テストピラミッドほど重視されません。</li>
<li><strong>統合テスト</strong>：テストトロフィーで最も重視されるテストです。</li>
<li><strong>ユーザーインタフェース（UI）</strong>：E2Eテストや目視テストを含み、テストピラミッドと同様にテストトロフィーでも重要な役割を担います。</li>
</ol>
<p>「テストトロフィー」はユーザーの視点を重視しており、費用対効果に優れています。では、テストトロフィーが最も推奨される手法なのでしょうか。テスト戦略としては最も理にかなっていますが、問題もあります。単体テストには依然として有益な利点がありますが、統合テストやE2Eテストには、ランタイムが長いことや信頼性が低いことなどの欠点があります。単体テストの利点は妥当であり、筆者は今でも好んで使用しています。</p>
<h2>テストピラミッドは古いのか？<a href="#テストピラミッドは古いのか？">#</a><a name="テストピラミッドは古いのか？"></a></h2>
<p>テストピラミッドは、ソフトウェア開発においてアプリケーションが正常に機能することを確認するのに役立つテストモデルとして、今でも人気があります。しかし、どんなモデルでもそうであるように、欠点もあります。最大の問題は、単体テストの定義を明確化しなくてはならないことです。</p>
<p>筆者のチームは、テストパイプラインでダイヤモンドの形に改良を加えたものを使用しました。その結果、完全に間違ってはおらず、単に不完全なだけであることが判明しました。特に各種テストの優先順位を決める上で、今でも貴重な知見を得ています。</p>
<p>ジャスティン・サールズがうまく言い表しているように、開発チームが教科書通りのテストパターンに従うことはほとんどありません。</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">People love debating what percentage of which type of tests to write, but it&#39;s a distraction. Nearly zero teams write expressive tests that establish clear boundaries, run quickly &amp; reliably, and only fail for useful reasons. Focus on that instead.<a href="https://t.co/xLceALKrWe">https://t.co/xLceALKrWe</a></p>&mdash; Justin Searls (@searls) <a href="https://twitter.com/searls/status/1393385209089990659?ref_src=twsrc%5Etfw">May 15, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><em>どのタイプのテストを何割書くかということについて盛んに議論されていますが、本質からずれていると思います。境界を明確に定め、素早く確実に実行され、失敗する際には必ず有益な理由がある表現豊かなテストを書いているチームはほとんどありません。重視すべきはそちらでしょう。</em></p>
<p><em>@MartinFowlerのテストピラミッドはもう古い。
統合テスト＞単体テストが新常識でしょう</em></p>
<p><em>フロントエンドでは、@rauchgと@kentcdoddsが提唱する「テストトロフィー」があります</em></p>
<p><em>バックエンドでは、@theburningmonkのコースで@SpotifyEngの「テストハニカム」が提唱されています</em></p>
<p>これは、筆者のチームの経験上でも言えることで、テストを切り分けたり定義したりするのは難しい場合が多いです。それは別に悪いことではありません。マーチン・ファウラーでさえ、異なるテストモデルがテストの対象範囲に対する見方にプラスの影響を与えていることを強調しています。</p>
<p>したがって、テストピラミッドが古いとは決して考えません。むしろ、今も昔と変わらず知っておくべきものだと思います。しかし、ポイントはテストモデルの「形」にこだわりすぎないことです。覚えておくべき最も重要なことは、<strong>テストは素早く確実に実行されるべきであり、実際に問題があるとき以外は失敗してはいけない</strong>ということです。単に網羅的なテストを目指すのではなく、ユーザーの役に立つことが重要です。最も重要な作業は、テストの設計段階でこれらの要素の優先順位を決めた際にすでに終えているのです。</p>
<h2>参考文献 <a href="#参考文献">#</a><a name="参考文献"></a></h2>
<ul>
<li>“<a href="https://martinfowler.com/articles/practical-test-pyramid.html">The Practical Test Pyramid</a>,” Ham Vocke</li>
<li>“<a href="https://martinfowler.com/articles/2021-test-shapes.html">On the Diverse And Fantastical Shapes of Testing,</a>” Martin Fowler</li>
<li>“<a href="https://changelog.com/posts/the-testing-pyramid-should-look-more-like-a-crab">The Testing Pyramid Should Look More Like A Crab,</a>” Gleb Bahmutov</li>
<li>“<a href="https://saeedgatson.com/the-software-testing-ice-cream-cone/">The Software Testing Ice Cream Cone,</a>” Saeed Gatson</li>
<li>“<a href="https://kentcdodds.com/blog/write-tests">Write tests. Not too many. Mostly integration,</a>” Kent C. Dodds</li>
<li>“<a href="https://kentcdodds.com/blog/the-testing-trophy-and-testing-classifications">The Testing Trophy and Testing Classifications,</a>” Kent C. Dodds</li>
<li>“<a href="https://kentcdodds.com/blog/static-vs-unit-vs-integration-vs-e2e-tests">Static vs Unit vs Integration vs E2E Testing for Frontend Apps,</a>” Kent C. Dodds</li>
</ul>]]></content:encoded></item><item><title><![CDATA[React Server Componentsを理解する]]></title><description><![CDATA[私も年を取ったと感じるのは、今年Reactが10年目を迎えたからです。 混乱していた開発コミュニティにReactが初めて紹介されてから10年、以来いくつもの進化を遂げてきました。Reactチームは、…]]></description><link>https://postd.cc/server-components/</link><guid isPermaLink="false">https://postd.cc/server-components/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><pubDate>Mon, 29 Jan 2024 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>私も年を取ったと感じるのは、今年Reactが10年目を迎えたからです。</p>
<p>混乱していた開発コミュニティにReactが初めて紹介されてから10年、以来いくつもの進化を遂げてきました。Reactチームは、急進的な改革ということに関しては躊躇しませんでした。問題に対して、より良い解決策が見つかれば、それを実行してきました。</p>
<p>数か月前、Reactチームは最新のパラダイム・シフトであるReact Server Componentsを発表しました。史上初めて、Reactコンポーネントがサーバーでのみ実行できるようになったのです。</p>
<p>このことに関連してオンライン上では、<em>きわめて大きな混乱</em>が起きています。それが何なのか、どのように機能するのか、利点は何か、そしてSSR（Server Side Rendering）などとどのように連携するのか、多くの人が多くの疑問を抱いています。</p>
<p>私はReact Server Componentsに関する数多くの実験を行ってきており、私自身が持っていた多くの疑問に対する回答を得てきました。正直に言うと、この技術に関して私は予想していたよりもはるかに興奮しています。<em>本当に素晴らしい技術です！</em></p>
<p>そこで今日の私の目標は、このことを分かりやすく解説し、React Server Componentsについて皆さんが持っている多くの疑問に答えることです。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>対象読者</h3><p>このチュートリアルは主として、すでにReactを使用していて、React Server Componentsに関心がある開発者の方々を対象として書かれています。Reactの専門家である必要はありませんが、Reactを使い始めたばかりの場合はだいぶ混乱するかもしれません。</p></div></div>
<h2>Server Side Renderingの簡単解説</h2>
<p>React Server Componentsを理解するうえで、SSRがどのように機能するかを理解することが役立ちます。すでにSSRについて理解している場合は、次の見出しに進んでください。
私が2015年にReactを使い始めたとき、ほとんどのReactセットアップでClient Side Rendering（CSR）戦略が用いられていました。ユーザーが受け取るのは次のようなHTMLファイルでした。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/js/bundle.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この<code class="language-text">bundle.js</code>スクリプトには、Reactや他のサードパーティの依存関係、自分たちが作成したすべてのコードなど、アプリケーションをマウントして実行するために必要なものがすべて含まれています。</p>
<p>JSがダウンロードされて解析されると、Reactが動作し始め、アプリケーション全体のすべてのDOMノードを呼び出し、それを空の<code class="language-text">&lt;div id=&quot;root&quot;&gt;</code>に格納します。</p>
<p>このアプローチの問題点は、すべての作業を実行するのに時間がかかることです。しかもその作業中、ユーザーは何も表示されていない白い画面を見つめ続けることになります。この問題は時間の経過につれて悪化する傾向があります。新しい機能がリリースされるたびに、JavaScriptバンドルに新たに多くのキロバイトが追加され、ユーザーが座って待つ時間が長くなっていきます。<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup></p>
<p>サーバー・サイド・レンダリングは、こうした状況を改善するために設計されました。空のHTMLファイルを送信する代わりに、サーバーはアプリケーションをレンダリングして実際のHTMLを生成します。ユーザーは完全に形成されたHTMLドキュメントを受け取ることになります。</p>
<p>双方向性の処理には、引き続きクライアント上でReactが動作することが必要なため、そのHTMLファイルには従来通り<code class="language-text">&lt;script&gt;</code>タグが含まれています。ただし、ブラウザ内で若干異なる動作をするようReactを構成します。最初からすべてのDOMノードを呼び出す代わりに、既存のHTMLを採用するのです。このプロセスは<em>ハイドレーション</em>と呼ばれています。</p>
<p>このことに関しては、ReactのコアチームメンバーであるDan Abramovによる次の説明が気に入っています。</p>
<blockquote>
<p><em>Hydration is like watering the “dry” HTML with the “water” of interactivity and event handlers.（ハイドレーションとは、「乾いた」HTMLに双方向性とイベント・ハンドラーの「水」を注ぐようなものである。）</em></p>
</blockquote>
<p>JSバンドルがダウンロードされると、Reactはアプリケーション全体を素早く実行して、UIの仮想スケッチを構築し、それを実際のDOMに「フィット」させ、イベント・ハンドラーをアタッチし、エフェクトを発火させるなどの機能を実行します。</p>
<p>それが、つまりSSRです。サーバーが最初のHTMLを生成するため、JSバンドルがダウンロードされ解析されている間、ユーザーは真っ白なページを見つめている必要がなくなります。次に、サーバー・サイドのReactが中断したところからクライアントサイドのReactが引き継ぎ、DOMを採用し、双方向性を散りばめます。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>包括的な用語</h3><p>サーバー・サイド・レンダリングについて話しをするとき、私たちは通常、次のようなフローを想像します。</p><ol>
<li>ユーザーが<em>myWebsite.com</em>にアクセスする。</li>
<li>Node.jsサーバーがリクエストを受け取り、すぐにReactアプリケーションをレンダリングして、HTMLを生成する。</li>
<li>その生成されたばかりのHTMLがクライアントに送信される。</li>
</ol><p>これはサーバー・サイド・レンダリングを実装することを可能にする<em>1つ</em>の方法ですが、これが唯一の方法ではありません。もう1つのオプションとして、<em>アプリケーションの構築時</em>にHTMLを生成する方法があります。</p><p>通常、Reactアプリケーションはコンパイルして、JSXをプレーンでなじみのあるJavaScriptに変換し、すべてのモジュールをバンドルする必要があります。同じプロセス中に、異なるルートのすべてでHTMLを全部「事前レンダリング」した場合はどうなるでしょうか？</p><p>これが一般に、「静的サイト生成（SSG）」として知られているものです。これはサーバー・サイド・レンダリングの派生型です。</p><p>私の考えでは、「サーバー・サイド・レンダリング」は、いくつかの異なるレンダリング戦略を含む包括的な用語です。これらのすべてには、1つの共通点があります。それは、最初のレンダリングが<code class="language-text">ReactDOMServer</code> APIを使用して、Node.jsなどのサーバーランタイムで行われることです。実際には、これが<em>いつ</em>発生するのか、オンデマンドなのかコンパイル時点なのかは問題になりません。いずれにせよ、それはサーバー・サイド・レンダリングなのです。</p></div></div>
<h2>前後に跳ねる</h2>
<p>Reactでのデータフェッチについてお話ししましょう。通常、ネットワーク経由で通信するアプリケーションには次の2種類があります。</p>
<ul>
<li>クライアント側のReactアプリ</li>
<li>サーバー側のREST API</li>
</ul>
<p>React QueryやSWR、Apolloなどを使用して、クライアントはバックエンドにネットワーク・リクエストを送信し、バックエンドはデータベースからデータを取得し、そのデータをネットワーク経由で送り返します。</p>
<p>そのフローは、グラフを使って可視化できます。</p>
<p><img src="/article-assets/server-components/server-components01.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>グラフに関する注記</h3><p>このブログ記事には、こうした「ネットワーク・リクエスト・グラフ」がいくつか含まれています。これらは、いくつかの異なるレンダリング戦略において、クライアント（ブラウザ）とサーバー（バックエンドAPI）の間でデータがどのように移動されるのかを可視化するためのものです。</p><p>下辺の数字は、仮想の時間単位を表しています。分でも秒でもありません。実際には、数値はさまざまな要因により、大きく変化します。このブログで取り上げているグラフは、概念の概要を理解することを目的としたもので、実際のデータをモデル化したものではありません。</p></div></div>
<p>この最初のグラフは、CSR戦略を使用したフローを表しています。始まりはクライアントによるHTMLファイルの受信です。このファイルにはコンテンツはありませんが、1つ以上の<code class="language-text">&lt;script&gt;</code>タグがあります。</p>
<p>JSがダウンロードされ、解析されると、Reactアプリが起動し、数多くのDOMノードが作成され、UIが構築されます。ただし、最初は実際のデータがないため、読み込み状態でシェル（ヘッダー、フッター、一般的なレイアウト）をレンダリングすることしかできません。</p>
<p>このようなパターンは、これまでにたくさん見たことがあるのではないでしょうか。たとえば、UberEatsではシェルのレンダリングから始まり、実際のレストランを表示するために必要なデータをフェッチします。</p>
<p><video autoplay="" loop="" muted="" playsinline="" src="https://www.joshwcomeau.com/images/server-components/ubereats-loading.mp4"></video></p>
<p>ネットワーク・リクエストが解決され、Reactが再レンダリングを実行し、読み込み中のUIが実際のコンテンツに置き換えられるまで、この読み込み状態が表示され続けます。</p>
<p><strong>別の構築方法を見てみましょう。</strong>次のグラフは、同じ一般的なデータ・フェッチ・パターンを維持していますが、CSRではなく<em>サーバー</em>・サイド・レンダリングを使用しています。</p>
<p><img src="/article-assets/server-components/server-components02.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<p>この新しいフローでは、最初のレンダリングはサーバー上で実行されます。それは、ユーザーが受け取るのは完全には空でないHTMLファイルであることを意味します。</p>
<p>（白紙のページよりもシェルの方が優れているという意味で）これは進歩ですが、結局のところ、目立って大きな変化を引き起こすものではありません。ユーザーは読み込み画面を見るためにアプリにアクセスしているのではなく、コンテンツ（レストラン、ホテルのリスト、検索結果、メッセージなど）を見るためにアクセスしているのです。</p>
<p>ユーザー・エクスペリエンスの違いを真に理解するため、いくつかのWeb性能測定基準をグラフに追加してみることにしましょう。この2つのフローを交互に切り替えて、フラグに何が起こるかを注意して見ていてください。</p>
<p><img src="/article-assets/server-components/server-components03.png">
<img src="/article-assets/server-components/server-components04.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<p>これらのフラグはそれぞれが、一般的に使用されているWeb性能測定基準を表します。以下がその説明です。</p>
<ul>
<li><strong>ファースト・ペイント</strong>—ユーザーは、何も映っていない真っ白な画面を見つめる必要がなくなります。全体的なレイアウトはレンダリングされましたが、コンテンツはまだ表示されません。FCP（First Contentful Paint）とも呼ばれています。</li>
<li><strong>ページ・インタラクティブ</strong>— Reactがダウンロードされ、アプリケーションがレンダリングされ、ハイドレーションが行われました。インタラクティブな要素は完全に応答するようになっています。TTI（Time To Interactive）とも呼ばれています。</li>
<li><strong>コンテンツ・ペイント</strong>—ページに、ユーザーが関心のあるコンテンツが含まれるようになっています。データベースからデータを取得し、UIにレンダリングしました。LCP（Largest Contentful Paint）とも呼ばれています。</li>
</ul>
<p>サーバー上で最初のレンダリングを行うことで、最初の「シェル」をより素早く描画することが可能になります。そのため、前に進んでいる感覚が得られ、読み込みエクスペリエンスが多少速く感じられるようになります。</p>
<p>また状況によっては、これは有意義な改善になります。たとえばユーザーが、ナビゲーション・リンクをクリックできるよう、ヘッダーが読み込まれるのを待っているだけということがあるでしょう。</p>
<p><strong>しかし、この流れは少々バカげていると思えませんか</strong>？SSRのグラフを見れば、リクエストがサーバー上で始まっていることは一目瞭然です。2つ目のラウンドトリップ・ネットワーク・リクエストを求める代わりに、<em>最初のリクエスト中</em>にデータベース作業を実行してみてはどうでしょうか。</p>
<p>つまり、<strong>次のようなことをしてみるのはどうでしょう</strong>ということです。</p>
<p><img src="/article-assets/server-components/server-components05.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<p>クライアントとサーバーの間を行ったり来たりする代わりに、最初のリクエストの一部としてデータベース・クエリーを実行し、完全に構築されたUIをユーザーに直接送信します。</p>
<p>しかし、うーん、厳密にはどうすればいいのでしょう？</p>
<p>これが機能するためには、データベース・クエリーを実行するために、サーバー上で排他的に実行される大量のコードをReactに提供できなければなりません。しかし、Reactではそれを選択することができませんでした。サーバー・サイド・レンダリングの場合でも、コンポーネントのすべてがサーバーとクライアントの両方でレンダリングされることになります。</p>
<p><strong>エコシステムは、この問題に対する数多くの解決策を考え出しました</strong>。Next.jsやGatsbyなどのメタフレームワーク <sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup> では、サーバー上でのみコードを実行する独自の方法を編み出しました。</p>
<p>たとえば、（従来の「Pages」ルーターを使用する）Next.jsを使用する場合は次のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> db <span class="token keyword">from</span> <span class="token string">'imaginary-db'</span><span class="token punctuation">;</span>
<span class="token comment">// This code only runs on the server:</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getServerSideProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> link <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token string">'passw0rd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">'SELECT * FROM products'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// This code runs on the server + on the client</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Homepage</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Trending Products</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>article</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>article</span><span class="token punctuation">></span></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><strong>これを分析してみましょう</strong>。サーバーがリクエストを受け取ると、<code class="language-text">getServerSideProps</code>関数が呼び出されます。それが、propsオブジェクトを返します。これらのpropsはコンポーネントに取り込まれ、そのコンポーネントが最初にサーバー上でレンダリングされ、次にクライアント上でハイドレーションされます。</p>
<p>ここで、優れている点は、<code class="language-text">getServerSideProps</code>がクライアント上で再実行されないことです。実際、この関数はJavaScriptバンドルにも含まれません。</p>
<p>このアプローチは時代のはるか先をいくものでした。正直に言って、それは驚くほどすごいことでした。ただし、これにはいくつかの問題点があります。</p>
<ol>
<li>この戦略は、ツリーの最上位にあるコンポーネントに関して、ルート・レベルでしか機能しません。どんなコンポーネントでも行うことができるものではないのです。</li>
<li>各メタフレームワークには独自のアプローチがあります。Next.jsには1つのアプローチがあり、Gatsbyには別のアプローチがあり、Remixにはさらに別のアプローチがあります。これまでのところ、標準化されていません。</li>
<li>すべてのReactコンポーネントは、たとえ不要な場合でも、クライアント上で<em>常に</em>ハイドレーションを行います。</li>
</ol>
<p>何年もの間、Reactチームは正式な解決方法を考案するために、この問題に密かに取り組んできました。その解決策こそ、今<strong>React Server Components</strong>と呼ばれているものです。</p>
<h2>React Server Componentsの紹介</h2>
<p>高いレベルでは、<em>React Server Components</em>はまったく新しいパラダイムの名称です。その新しい世界では、<em>サーバー上で排他的に実行される</em>コンポーネントを作成できます。そのため、Reactコンポーネント内でデータベース・クエリーを直接記述することが可能になります！</p>
<p>次に、「サーバー・コンポーネント」の簡単な例を示します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> db <span class="token keyword">from</span> <span class="token string">'imaginary-db'</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Homepage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> link <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token string">'passw0rd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token string">'SELECT * FROM products'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Trending Products</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>article</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>article</span><span class="token punctuation">></span></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Homepage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>長年Reactを使用してきた私には、最初このコードは<em>きわめて突飛なもの</em>に思えました。😅</p>
<p>「ちょっと待て！」と本能が叫びました。「関数コンポーネントは非同期になることはできないぞ！そして、そのようなレンダリングで直接副作用を発生させることは許されない！」</p>
<p><strong>キーとなるのは、次のことを理解することです</strong>。サーバー・コンポーネントが再レンダリングされることは決してありません。サーバー・コンポーネントはサーバー上で1回だけ実行され、UIを生成します。レンダリングされた値はクライアントに送信され、所定の場所にロックされます。Reactに関しては、この出力は変更不能であり、決して変わりません <sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup>。</p>
<p>つまり、ReactのAPIの<em>大部分</em>は、サーバー・コンポーネントと互換性がないことを意味します。たとえば、stateは変化する可能性がありますが、サーバー・コンポーネントは再レンダリングできないため、stateは使用できません。また、effectはクライアント上でレンダリング後にのみ実行され、サーバー・コンポーネントがクライアントに到達することはないため、effectを使用することはできません。</p>
<p>これはまた、ルールに関してもう少し柔軟性があることも意味しています。たとえば、従来のReactでは、レンダリングのたびに副作用が繰り返されることがないよう、<code class="language-text">useEffect</code>コールバックやイベント・ハンドラーなどの中に副作用を配置する必要がありました。しかし、コンポーネントが<em>1回</em>しか実行されないのであれば、そのことについて心配する必要はなくなります。</p>
<p>サーバー・コンポーネント自体は驚くほど単純ですが、「React Server Components」パラダイムは非常に複雑です。その理由は、通常の古いコンポーネントが<em>まだ残っていて</em>、それらを組み合わせる方法が非常に入り組んだものである可能性があるためです。</p>
<p>この新しいパラダイムでは、私たちがよく知っている「従来の」Reactコンポーネントは<em>クライアント・コンポーネント</em>（Client Component）と呼ばれています。率直に言って、私はこの名称が好きではありません。😅</p>
<p>「クライアント・コンポーネント」という名称は、これらのコンポーネントがクライアント上でのみレンダリングされるかのような意味に取れますが、実際にはそうではありません。クライアント・コンポーネントは<strong>クライアントとサーバーの<em>両方</em>でレンダリングできます</strong>。</p>
<p><img src="/article-assets/server-components/server-components06.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<p>これらの用語は非常に分かりにくいので、次のように要約してみました。</p>
<ul>
<li><em>React Server Components</em>とは、この新しいパラダイムの名称です。</li>
<li>この新しいパラダイムでは、私たちがよく知っていて好んで使用してきた「標準」Reactコンポーネントが、<em>クライアント・コンポーネント</em>へと名称変更されました。古いものに新しい名前が付けられたのです。</li>
<li>この新しいパラダイムでは、<em>サーバー・コンポーネント</em>という新しいタイプのコンポーネントが導入されました。この新しいコンポーネントはサーバー上でのみレンダリングされます。サーバー・コンポーネントのコードは、JSバンドルに含まれていないため、ハイドレーションや再レンダリングが行われることはありません。</li>
</ul>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>React Server Components vs.サーバー・サイド・レンダリング</h3><p>もう1つ別の一般的な混乱を解消しましょう。React Server Componentsはサーバー・サイド・レンダリングに代わるものでは<em>ありません</em>。React Server Componentsを「SSRバージョン2.0」とは考えないでください。</p><p>代わりに、私はこれを完全に一致する2つのパズル・ピース、または互いに補完し合う2つのフレーバーだと考えたいのです。</p><p>依然、最初のHTMLの生成にはサーバー・サイド・レンダリングが必要です。React Server Componentsはその上に構築されるため、クライアント側のJavaScriptバンドルから特定のコンポーネントを除外し、それらのコンポーネントがサーバー上でのみ実行されるようにできます。</p><p>確かに、React Server Componentsは、サーバー・サイド・レンダリング<em>なし</em>に使うことは可能ですが、実際は両方を一緒に使用するとより良い結果が得られます。ReactチームがSSRを使用しない<a href="https://github.com/reactjs/server-components-demo">最小限のRSCデモ</a>を作成していますので、こちらでその例を見ることができます。</p></div></div>
<h2>互換性のある環境</h2>
<p>したがって通常は、新しいReact機能が出てきた場合、Reactの依存関係を最新バージョンに更新することで、既存のプロジェクトでその機能を使い始めることが可能になります。迅速な<code class="language-text">npm install react@latest</code>によって、すぐに開始できます。</p>
<p>残念ながら、React Server Componentsはそのようには機能しません。</p>
<p>私が理解しているところでは、React Server Componentsは、バンドラーやサーバー、ルーターなど、Reactの外部にある多くのものと緊密に統合する必要があります。</p>
<p>この文を書いている時点で、React Server Componentsの使用を開始する方法は1つだけであり、それはNext.js 13.4以降で、最新の再設計された「App Router」を使用することです。</p>
<p>願わくは今後、より多くのReactベースのフレームワークに、React Server Componentsが組み込まれることを期待しています。Reactのコア機能が特定の1つのツールでしか利用できないことについては抵抗を感じます。Reactドキュメントには<a href="https://react.dev/learn/start-a-new-react-project#bleeding-edge-react-frameworks">「最先端のフレームワーク」セクション</a>があり、React Server Componentsをサポートするフレームワークがリストされています。新しいオプションが利用可能になったかどうかを確認するため、このページを時々チェックする予定です。</p>
<h2>クライアント・コンポーネントの指定</h2>
<p>この新しい「React Server Components」パラダイムでは、<strong>すべてのコンポーネントが、デフォルトで、サーバー・コンポーネントとみなされます</strong>。クライアント・コンポーネントについては、「オプトイン」する必要があります。</p>
<p>それを行うために、まったく新しい<em>ディレクティブ</em>を指定します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token string">'use client'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      Current value: </span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Counter<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>先頭の<code class="language-text">&#39;use client&#39;</code>ディレクティブは、このファイル内のコンポーネントがクライアント・コンポーネントであることや、クライアントで再レンダリングできるようJSバンドルに含める必要があることをReactに知らせます。</p>
<p>これは、作成しているコンポーネントのタイプを指定する方法として非常に奇妙に<em>見える</em>かもしれませんが、これには前例があります。それは、JavaScriptで「Strict Mode」を選択する<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode">"use strict"</a>ディレクティブです。</p>
<p>サーバー・コンポーネントでは、<code class="language-text">&#39;use server&#39;</code>ディレクティブを指定しません。React Server Componentsパラダイムでは、コンポーネントは、デフォルトで、サーバー・コンポーネントとして扱われます。事実、<code class="language-text">&#39;use server&#39;</code>はサーバー・アクションに使用されますが、それはまったく異なる機能であり、このブログ記事の範囲を外れています。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>クライアント・コンポーネントにすべきコンポーネントはどれでしょうか？</h3><p>「特定のコンポーネントをサーバー・コンポーネントにするかクライアント・コンポーネントにするかをどのように決定すればよいのか？」と疑問に思われるかもしれません。</p><p>一般則としては、コンポーネントがサーバー・コンポーネントになれるのであれば、サーバー・コンポーネントにするべきです。サーバー・コンポーネントはよりシンプルであり、推測が容易になる傾向があります。パフォーマンス上の利点もあります。サーバー・コンポーネントはクライアント上では実行されないため、そのコードはJavaScriptバンドルに含まれません。React Server Componentsパラダイムの利点の1つは、<em>ページ・インタラクティブ</em>（TTI）メトリックを改善できる可能性があることです。</p><p>とはいえ、できるだけ多くのクライアント・コンポーネントを排除することを目指すべきではありません。最も少ない数のクライアント・コンポーネントに合わせて最適化を試みるべきではありません。これまでは、<em>すべて</em>のReactアプリのすべてのReactコンポーネントがクライアント・コンポーネントであったことは覚えておくべきです。</p><p>React Server Componentsを使い始めれば、それが非常に直感的なものであることが分かるでしょう。一部のコンポーネントはstate変数またはeffectを使用することから、クライアント上で実行する必要があります。そうしたコンポーネントでは、<code class="language-text">&#39;use client&#39;</code>ディレクティブを実行できます。それ以外の場合は、サーバー・コンポーネントのままにしておくことができます。</p></div></div>
<h2>クライアント・バウンダリ</h2>
<p>React Server Componentsに慣れ始めた頃、私が最初に抱いた疑問の1つが、<strong><em>propsが変更されるとどうなるのか</em></strong>？というものでした。</p>
<p>たとえば、次のようなサーバー・コンポーネントがあったとします。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">HitCounter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> hits <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      Number of hits: </span><span class="token punctuation">{</span>hits<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>最初のサーバー・サイド・レンダリングで、<code class="language-text">hits</code>が<code class="language-text">0</code>だったと仮定します。このコンポーネントは次に、以下のマークアップを生成します。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
  Number of hits: 0
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>しかし、<code class="language-text">hits</code>の値が変化したらどうなるでしょうか？これがstate変数で、<code class="language-text">0</code>から<code class="language-text">1</code>に変化するとします。<code class="language-text">HitCounter</code>は再レンダリングする必要がありますが、サーバー・コンポーネントであるため再レンダリングは<em>できません</em>。</p>
<p><strong>問題は、サーバー・コンポーネントは単独では、事実上意味がないということです</strong>。より全体的なビューを取り上げ、アプリケーションの構造を検討するには、ズームアウトする必要があります。</p>
<p>仮に、次のようなコンポーネント・ツリーを考えてみましょう。</p>
<p><img src="/article-assets/server-components/server-components07.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<p>これらのコンポーネントがすべてサーバー・コンポーネントであれば、完全に意味が通じます。いずれのコンポーネントも再レンダリングされないため、どのpropsも変化しません。</p>
<p>ただし、<code class="language-text">Article</code>コンポーネントが<code class="language-text">hits</code>というstate変数を持っていると仮定します。stateを使用するには、それをクライアント・コンポーネントに変換する必要があります。</p>
<p><img src="/article-assets/server-components/server-components08.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<p>ここでの問題が分かりましたか？<code class="language-text">Article</code>が再レンダリングされると、<code class="language-text">HitCounter</code>や<code class="language-text">Discussion</code>など、所有していたコンポーネントも再レンダリングされます。ところが、これがサーバー・コンポーネントの場合には、再レンダリング<em>できません</em>。</p>
<p>このあり得ない状況を防ぐために、Reactチームは次のルールを追加しました。<strong>クライアント・コンポーネントがインポートできるのは他のクライアント・コンポーネントのみである</strong>。その<code class="language-text">&#39;use client&#39;</code>ディレクティブは、<code class="language-text">HitCounter</code>や<code class="language-text">Discussion</code>のインスタンスがクライアント・コンポーネントにならなければならないことを意味します。</p>
<p>React Server Componentsに関連して私が経験した最大の「なるほど」の瞬間の1つは、この新しいパラダイムは<em>クライアント・バウンダリ</em>の作成に関するものであると認識したときでした。実際には、次のようになります。</p>
<p><img src="/article-assets/server-components/server-components09.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<p><code class="language-text">&#39;use client&#39;</code>ディレクティブを<code class="language-text">Article</code>コンポーネントに追加すると、「クライアント・バウンダリ」が作成されます。このバウンダリ内のコンポーネントはすべて、<em>暗黙的</em>にクライアント・コンポーネントに変換されます。<code class="language-text">HitCounter</code>などのコンポーネントには<code class="language-text">&#39;use client&#39;</code>ディレクティブがありませんが、この特定の状況ではクライアント上でハイドレーション/レンダリングが行われます <sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup>。</p>
<p>つまり、クライアント上で実行する必要があるすべてのファイルに<code class="language-text">&#39;use client&#39;</code>を追加する必要はないということです。実際に、追加する必要があるのは、新しいクライアント・バウンダリを作成する場合だけです。</p>
<h2>対処法</h2>
<p>クライアント・コンポーネントはサーバー・コンポーネントをレンダリングできないということを初めて知ったとき、私はかなり制約がきついなと感じました。アプリケーションの上の方でstateを使用しなければならない場合、どうすればよいのでしょうか？それは、<em>すべて</em>がクライアント・コンポーネントになる必要があるということでしょうか？？</p>
<p>多くの場合において、アプリケーションを再構築して、レンダリング<em>元</em>となるコンポーネントを工夫することで、この制約を回避できることが分かりました。</p>
<p>これを説明するのは難しいので、例を使って説明します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token string">'use client'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DARK_COLORS</span><span class="token punctuation">,</span> <span class="token constant">LIGHT_COLORS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/constants.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Header <span class="token keyword">from</span> <span class="token string">'./Header'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> MainContent <span class="token keyword">from</span> <span class="token string">'./MainContent'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Homepage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>colorTheme<span class="token punctuation">,</span> setColorTheme<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'light'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> colorVariables <span class="token operator">=</span> colorTheme <span class="token operator">===</span> <span class="token string">'light'</span>
    <span class="token operator">?</span> <span class="token constant">LIGHT_COLORS</span>
    <span class="token operator">:</span> <span class="token constant">DARK_COLORS</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>colorVariables<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Header</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MainContent</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この設定では、React stateを使用して、ユーザーがダーク・モードとライト・モードを切り替えられるようにする必要があります。このことは、CSS変数トークンを<code class="language-text">&lt;body&gt;</code>タグに適用できるようにするため、アプリケーション・ツリーの上部で行う必要があります。</p>
<p>stateを使用するには、<code class="language-text">Homepage</code>をクライアント・コンポーネントにする必要があります。これはアプリケーションの最上部にあるため、他のすべてのコンポーネント（<code class="language-text">Header</code>および<code class="language-text">MainContent</code>）も暗黙的にクライアント・コンポーネントになることを意味します。</p>
<p>これを修正するには、カラー管理要素を独自のコンポーネントに引き込み、独自のファイルに移します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// /components/ColorProvider.js</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DARK_COLORS</span><span class="token punctuation">,</span> <span class="token constant">LIGHT_COLORS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/constants.js'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">ColorProvider</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>colorTheme<span class="token punctuation">,</span> setColorTheme<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'light'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> colorVariables <span class="token operator">=</span> colorTheme <span class="token operator">===</span> <span class="token string">'light'</span>
    <span class="token operator">?</span> <span class="token constant">LIGHT_COLORS</span>
    <span class="token operator">:</span> <span class="token constant">DARK_COLORS</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>colorVariables<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">Homepage</code>に戻り、この新しいコンポーネントを次のように使用します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// /components/Homepage.js</span>
<span class="token keyword">import</span> Header <span class="token keyword">from</span> <span class="token string">'./Header'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> MainContent <span class="token keyword">from</span> <span class="token string">'./MainContent'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ColorProvider <span class="token keyword">from</span> <span class="token string">'./ColorProvider'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Homepage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ColorProvider</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Header</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MainContent</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ColorProvider</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">&#39;use client&#39;</code>ディレクティブは、stateやその他のクライアント側React機能を使用しなくなることから、<code class="language-text">Homepage</code>から削除できます。これは、<code class="language-text">Header</code>と<code class="language-text">MainConten</code>tが暗黙的にクライアント・コンポーネントに変換されなくなることを意味します。</p>
<p><strong>しかし、ちょっと待ってください</strong>。クライアント・コンポーネントである<code class="language-text">ColorProvider</code>は、HeaderとMainContentの<em>親</em>です。いずれにせよ、まだツリーでは上位にありますね。</p>
<p>ただし、クライアント・バウンダリに関しては、親子関係は重要ではありません。<code class="language-text">Homepage</code>は、<code class="language-text">Header</code>と<code class="language-text">MainContent</code>をインポートし、レンダリングするものです。これは、<code class="language-text">Homepage</code>が、これらのコンポーネントの<em>propsが何であるか</em>を決定することを意味します。</p>
<p>覚えておいてください。私たちが解決しようとしている問題は、サーバー・コンポーネントは再レンダリングができないため、どのpropsにも新しい値を与えることができないということです。この新しい設定では、<code class="language-text">Homepage</code>が、<code class="language-text">Header</code>と<code class="language-text">MainContent</code>のpropsを決定し、また<code class="language-text">Homepage</code>はサーバー・コンポーネントであることから、問題はありません。</p>
<p>これは頭を悩ませる事柄です。何年もReactを経験した後の今でも、このことはきわめて分かりにくいと思っています😅。これに対する直感を養うためには、かなりの練習を必要としました。</p>
<p>より正確に言えば、<code class="language-text">&#39;use client&#39;</code>ディレクティブはファイル/モジュール・レベルで機能します。クライアント・コンポーネント・ファイルに<em>インポート</em>されたモジュールもクライアント・コンポーネントでなければなりません。結局のところ、バンドラーがコードをバンドルすると、これらのインポートに追随することになります。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>カラー・テーマを変更するか？</h3><p>上記の例には、カラー・テーマを変更する方法がないことに気付いたかもしれません。<code class="language-text">setColorTheme</code>が呼び出されることは決してありません。
可能な限り最小限度に留めたかったので、いくつか省略したものがあります。完全な形の例では、Reactコンテキストを使用して、任意の子孫がsetter関数を使用できるようにします。コンテキストを使用するコンポーネントがクライアント・コンポーネントである限り、すべてうまくいきます。</p></div></div>
<h2>内部で何が起きているのか</h2>
<p>これを、もう少し深く見てみましょう。サーバー・コンポーネントを使用する場合、その出力はどのようなものになるでしょうか？実際に生成されるのは何でしょうか？</p>
<p>ここで、超シンプルなReactアプリケーションから始めることにしましょう。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Homepage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
      Hello world!
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>React Server Componentsパラダイムでは、デフォルトですべてのコンポーネントがサーバー・コンポーネントです。このコンポーネントをクライアント・コンポーネントとして明示的にマーク付けしていないため（またはクライアント・バウンダリ内でレンダリングしていないため）、サーバー上でのみレンダリングされます。</p>
<p>ブラウザでこのアプリにアクセスすると、次のようなHTMLドキュメントを受け取ることになります。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Hello world!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/static/js/bundle.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      self<span class="token punctuation">.</span>__next<span class="token punctuation">[</span><span class="token string">'$Homepage-1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span>
        props<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        children<span class="token operator">:</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>勝手な変更</h3><p>分かりやすくするため、ここであえて再構成を実施しました。たとえば、RSCコンテキストで生成された真のJSは、このHTMLドキュメントのファイル・サイズを削減するための最適化として、文字列化されたJSON配列を使用します。</p><p>また、HTMLの重要でない部分（<code class="language-text">&lt;head&gt;</code>など）もすべて削除しました。</p></div></div>
<p>HTMLドキュメントには、Reactアプリケーションによって生成されたUI、「Hello world!」パラグラフが含まれていることが分かります。これはサーバー・サイド・レンダリングのおかげであり、React Server Componentsに直接起因するものではありません。</p>
<p>その下には、JSバンドルをロードする<code class="language-text">&lt;script&gt;</code>タグがあります。このバンドルには、Reactなどの依存関係と、アプリケーションで使用されるクライアント・コンポーネントが含まれています。また、<code class="language-text">Homepage</code>コンポーネントはサーバー・コンポーネントであるため、そのコンポーネントのコードはこのバンドルには含まれていません。</p>
<p>最後に、いくつかのインラインJSを含む2番目の<code class="language-text">&lt;script&gt;</code>タグがあります。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js">self<span class="token punctuation">.</span>__next<span class="token punctuation">[</span><span class="token string">'$Homepage-1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'p'</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これは本当に興味深い点です。本質的には、ここで行っているのは、Reactに対して、「<code class="language-text">Homepage</code>コンポーネント・コードが足りないことは分かっていますが、心配しないでください。ここにレンダリングされたものがあります」と伝えることです。</p>
<p>通常、Reactがクライアント上でハイドレーションを行うと、すべてのコンポーネントが素早くレンダリングされ、アプリケーションの仮想DOMが構築されます。サーバー・コンポーネントの場合、コードがJSバンドルに含まれていないため、これを行うことができません。</p>
<p>したがって、レンダリングされた値と共に、サーバーによって生成された仮想DOMを送信します。Reactがクライアントにロードされると、そのディスクリプションを再生成する代わりに再利用します。</p>
<p>これにより、上記の<code class="language-text">ColorProvider</code>の例が機能するようになります。<code class="language-text">Header</code>と<code class="language-text">MainContent</code>からの出力は、<code class="language-text">children</code>というpropsを通じて<code class="language-text">ColorProvider</code>コンポーネントに送られます。<code class="language-text">ColorProvider</code>は必要なだけ再レンダリングを行えますが、このデータは静的であり、サーバーによってロックされています。</p>
<p>サーバー・コンポーネントがどのようにシリアル化され、ネットワーク経由で送信されるかの現実的表現を見たい場合は、開発者であるAlvar Lagerlöfによる<a href="https://www.alvar.dev/blog/creating-devtools-for-react-server-components">RSC Devtools</a>をチェックしてください。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>サーバー・コンポーネントはサーバーを必要としない</h3><p>この記事の始めで、サーバー・サイド・レンダリングは、次のようなさまざまなレンダリング戦略についての「包括的な用語」であると述べました。</p><ul>
<li><strong>静的</strong>：HTMLは、展開プロセス中に、アプリケーションのビルド時に生成されます。</li>
<li><strong>動的</strong>：ユーザーがページをリクエストすると、HTMLは「オンデマンド」で生成されます。</li>
</ul><p><strong>React Server Componentsは、これらのレンダリング戦略のいずれとも互換性があります</strong>。サーバー・コンポーネントがNode.jsランタイム中にレンダリングされると、それらが返すJavaScriptオブジェクトが作成されます。それは、オンデマンドまたはビルド中のいずれかで発生する可能性があります。</p><p>つまり、React Server Componentsをサーバーなしで使用できるということです。大量の静的HTMLファイルを生成し、必要な場所にホストすることができます。事実、これがNext.jsのApp Routerにおいて、<em>デフォルト</em>で行われることです。本当に「オンデマンド」で行う必要がない場合、この作業はすべて事前に、ビルド中に実行されます。</p></div></div>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h3>Reactがまったくない場合？</h3><p>アプリケーションにクライアント・コンポーネントを含めない場合、本当にReactをダウンロードすることが必要なのかという疑問を持つかもしれません。React Server Componentsを使用して、<em>真に</em>静的な非JSウェブサイトを構築できるでしょうか？</p><p>問題は、React Server ComponentsはNext.jsフレームワーク内でのみ利用可能であり、そのフレームワークにはルーティングなどを管理するためにクライアント上で実行する必要のあるコードが多数含まれていることです。</p><p>ただし直感とは逆に、このことで実際には<em>より良い</em>ユーザー・エクスペリエンスが実現する傾向があります。たとえば、Nextのルーターは、新しいHTMLドキュメント全体を読み込む必要がないため、典型的な<code class="language-text">&lt;a&gt;</code>タグよりも速くリンク・クリックを処理できます。</p><p>適切に構造化されたNext.jsアプリケーションは、JSのダウンロード中も動作しますが、JSが読み込まれるとさらに速く/良くなります。</p></div></div>
<h2>利点</h2>
<p>React Server Componentsは、Reactでサーバー専用コードを実行することを目的とした最初の「公式」ツールです。ただし、すでに述べたように、より広範なReactエコシステムにおいては、これは<em>決して</em>新しいことではありません。2016年から、Next.jsではサーバー専用コードを実行できるようになっていました。</p>
<p>大きく異なるのは、これまで<em>コンポーネント内</em>でサーバー専用コードを実行する手段がなかった点です。</p>
<p>最も明白な利点はパフォーマンスです。JSバンドルにはサーバー・コンポーネントが含まれていないため、ダウンロードすべきJavaScriptの量と、ハイドレーションを必要とするコンポーネントの数が減ることになります。</p>
<p><img src="/article-assets/server-components/server-components10.png">
<img src="/article-assets/server-components/server-components11.png">
<em>（訳注：イメージは原文サイトの表示のキャプチャー画像です）</em></p>
<p>ただし、このことは私にとっては最も興味を感じられないものかもしれません。正直なところ、「ページ・インタラクティブ」のタイミングに関しては、ほとんどのNext.jsアプリが<em>すでに</em>十分な高速度を実現しています。</p>
<p>セマンティックHTMLの原則に従えば、Reactのハイドレーション前でも大半のアプリが動作するはずです。リンクをたどったり、フォームを送信したり、（<code class="language-text">&lt;details&gt;</code>や<code class="language-text">&lt;summary&gt;</code>を使用して）アコーディオンを展開したり折りたたんだりできます。ほとんどのプロジェクトで、Reactのハイドレーションに数秒かかっても、問題はありません。</p>
<p><strong>ただし、私が本当にすごいと思うのは</strong>、機能とバンドル・サイズという点で、同じ妥協をする必要がなくなったことです。</p>
<p>たとえば、ほとんどの技術系ブログでは、ある種のシンタックス・ハイライティング・ライブラリが必要となります。このブログでは、Prismを使用します。コード・スニペットは次のようになります。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">exampleJavaScriptFunction</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">"Hello world!"</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>一般的なプログラミング言語のすべてをサポートする適切なシンタックス・ハイライティング・ライブラリは数メガバイトになり、JSバンドルに組み込むには大きすぎます。そのため、ミッションクリティカルでない言語や機能を削除するという妥協が必要になります。</p>
<p>ただし、シンタックス・ハイライティングを行うのは<em>サーバー・コンポーネントにおいて</em>であると仮定しています。その場合、実際にはライブラリ・コードはJSバンドルに含まれません。その結果、妥協する必要が一切なくなり、オプション機能のすべてを利用できるようになります。</p>
<p>これが、React Server Componentsで動作するよう設計された最新のシンタックス・ハイライティング・パッケージである<a href="https://bright.codehike.org/">Bright</a>の背後にある卓越したアイデアです。</p>
<p><img src="https://www.joshwcomeau.com/images/server-components/bright.png"></p>
<p>これこそが、React Server Componentsについて私が興味をそそられる点です。JSバンドルに含めるにはコストがかかりすぎることが、サーバー上で、<em>無料で</em>実行できるようになり、バンドルに追加される容量は0キロバイトで、これまで以上に優れたユーザー・エクスペリエンスを得ることができます。</p>
<p>単にパフォーマンスの問題でもUXの問題でもありません。RSCをしばらく使ったことで、私はサーバー・コンポーネントがどれほど簡単であるかを真に理解するようになりました。ディペンデンシー・アレイ、古くなったクロージャ、メモ化、<em>状況の変化</em>によって引き起こされるその他の複雑な事柄について心配する必要はありません。</p>
<p>結局のところ、それはまだきわめて初期の段階にあります。React Server Componentsは数か月前に、ベータ版が完了して正式リリースになったばかりです。コミュニティがこの新しいパラダイムを活用して、Brightなどの新しいソリューションのイノベーションを続けていることから、今後数年間でどのように進化するかを見るのが本当に楽しみです。React開発者にとって今は、エキサイティングな時です。</p>
<h2>全体像</h2>
<p>React Server Componentsはエキサイティングな発展ですが、実際には「Modern React」パズルの一部にすぎません。</p>
<p>事態が<em>真に</em>興味深いものになるのは、React Server ComponentsをSuspenseや新しいStreaming SSRアーキテクチャと組み合わせたときです。その結果、次のような驚くべきことが可能になります。</p>
<p><img src="/article-assets/server-components/server-components12.png"></p>
<p>このチュートリアルの対象範囲を超えていますが、このアーキテクチャの詳細については、<a href="https://github.com/reactwg/react-18/discussions/37">Githubで</a>確認することができます。</p>
<p>また、私の新しいコース<a href="https://joyofreact.com/">The Joy of React</a>でも詳しく取り上げます。よろしければ、もう少し詳しく説明させていただきたいと思います！❤️</p>
<p>The Joy of Reactは初心者向けのインタラクティブ・コースで、Reactがどのように機能するかについての知識を得られる設定になっています。初歩段階からスタートし（Reactの経験は必要ありません）、Reactの悪名の高いトリッキーな側面を取り上げていきます。</p>
<p>これは私が約2年間、フルタイムで取り組んできたコースであり、8年以上の経験の中でReactについて学んだ最も重要な事柄のすべてが含まれています。</p>
<p>お伝えたしたいことが満載のコースです。React本体と、このブログ記事で暗に取り上げた最先端の機能に加えて、Reactエコシステムの中で私が気に入っている部分についても学ぶことができます。たとえば、Framer Motionを使用して、次のレベルのレイアウト・アニメーションを作成する方法を学べます。</p>
<p><video autoplay="" loop="" muted="" playsinline="" src="https://www.joshwcomeau.com/images/server-components/reading-list-blog-demo.mp4"></video></p>
<p>このコースについてさらに詳しく学び、Reactを使ったビルドの楽しさを発見してください。</p>
<ul>
<li><a href="https://joyofreact.com/">The Joy of React</a></li>
</ul>
<hr>
<p>React Server Componentsは重要なパラダイム・シフトです。個人的には、Reactエコシステムにおいて、サーバー・コンポーネントを利用するBrightのようなツールがさらに構築されるにつれて、今後数年間で状況がどのように展開していくかに関してきわめて強い関心があります。</p>
<p>Reactでの構築がさらにすごいことになると感じています。😄</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">
<p><em>特定のモジュールをレイジーロードしたり、ルートに基づいて分割したりするような最適化もありますが、一般的なルールとして、JSバンドルはどんどん大きくなる傾向があります</em></p>
<a href="#fnref-1" class="footnote-backref">↩</a>
</li>
<li id="fn-2">
<p><em>メタフレームワークとは、Reactの上に構築し、ルーティングやデータ管理のような機能を追加するフレームワークを意味する</em></p>
<a href="#fnref-2" class="footnote-backref">↩</a>
</li>
<li id="fn-3">
<p><em>少なくとも、新しいページに移動するなど、ルーター上で何かが起こるまでは</em></p>
<a href="#fnref-3" class="footnote-backref">↩</a>
</li>
<li id="fn-4">
<p><em>HitCounterコンポーネント自体は、サーバー・コンポーネントにより他の場所にインポートされた場合、サーバー・コンポーネントとしてレンダリングされる可能性があります</em></p>
<a href="#fnref-4" class="footnote-backref">↩</a>
</li>
</ol>
</div>]]></content:encoded></item><item><title><![CDATA[Next.jsを4年間使用してたどりついた、エンタープライズアプリケーションのフロントエンド開発・構築手法]]></title><description><![CDATA[はじめに 目まぐるしく進化するフロントエンド開発の世界では、常に最新の知識や技術をいち早く取り入れることが、エンタープライズアプリケーションの開発を成功させる上で欠かせません。Tailwind CS…]]></description><link>https://postd.cc/how-i-approach-and-structure-enterprise-frontend-applications-after-4-years-of-using-nextjs/</link><guid isPermaLink="false">https://postd.cc/how-i-approach-and-structure-enterprise-frontend-applications-after-4-years-of-using-nextjs/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[Next.js]]></category><category><![CDATA[TypeScript]]></category><category><![CDATA[JavaScript]]></category><category><![CDATA[React]]></category><pubDate>Mon, 25 Dec 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<h2>はじめに</h2>
<p>目まぐるしく進化するフロントエンド開発の世界では、常に最新の知識や技術をいち早く取り入れることが、エンタープライズアプリケーションの開発を成功させる上で欠かせません。Tailwind CSS、TypeScript、Turborepo、ESLint、React Queryなどを含む強力なツールキットとNext.jsを<strong>4</strong>年間使用してきた結果、開発に役立つさまざまな知見やベストプラクティスが得られました。この記事では、大企業向けフロントエンドアプリケーションのパフォーマンス、保守性、拡張性を最大限に高める設計・構築手法を紹介したいと思います。</p>
<p><strong>注記</strong>：ここに記載する内容はあくまでも個人的な見解であり、筆者が推奨する手法が必ずしも適さない場合もあります。</p>
<h2>効果的なエンタープライズ向けフロントエンドアーキテクチャの基本原則</h2>
<p>エンタープライズ規模のアプリケーション向けにフロントエンドソリューションを設計する場合、基本原則を明確に定めておくことで開発作業の方向性を示すことができます。このセクションでは、エンタープライズ環境において筆者が実際にNext.jsを使用してきた経験を踏まえた基本原則を紹介します。</p>
<h3>モジュール性とコンポーネント化</h3>
<p><em>原則：分割統治</em></p>
<p>大規模なエンタープライズアプリケーションでは、コードはすぐに肥大化し、手に負えなくなってしまいます。モジュール性を備えたフロントエンド設計により、コードを扱いやすい大きさのコンポーネントに分割しましょう。コンポーネントはブロック玩具のように、それぞれ特定の役割を担います。そのため、コンポーネント化することでコードを再利用しやすくなるだけでなく、保守や開発チーム内での連携が容易になります。また、アプリケーションを小さなコンポーネントに分割するだけでなく、独立した小さなアプリケーションに分割できないか検討しましょう。それには、Turborepoなどのツールが役立ちます。</p>
<h3>関心の分離（SOC）</h3>
<p><em>原則：コードベースを整理する</em></p>
<p>コードの健全性を保つため、関心の分離（SoC）の原則に従いましょう。UIのレンダリング、ビジネスロジックの処理、状態（ステート）の管理といった各コンポーネントの役割を、それぞれ明確に分離します。そうすることで、コードが分かりやすくなるだけでなく、テストやデバッグを行いやすくなります。</p>
<h3>スケーラブルな設計</h3>
<p><em>原則：拡張に備える</em></p>
<p>エンタープライズアプリケーションは静的ではなく、進化します。スケーラビリティを念頭に置きながらフロントエンドアーキテクチャを設計しましょう。これはつまり、トラフィックやデータ量の増大、機能の複雑化に対応できるパターンやツールを選ぶということです。Next.jsはスケーラビリティに対応可能な設計になっているため、その点においても有益です。</p>
<h3>保守性とコード品質</h3>
<p><em>原則：丁寧にコーディングする</em></p>
<p>コードは製品の土台です。最初から保守性とコード品質を重視し、コーディング規約を定め、コードレビューを実施し、テスト自動化に投資しましょう。管理の行き届いたコードベースは作業しやすいだけでなく、バグやリグレッションが発生しにくくなります。筆者は最近、フロントエンドアプリケーションのコーディング規約を順守させるため、<a href="https://ui.fin.africa/?path=/docs/foundations-guidelines--docs">コンポーネントライブラリと簡単なスタイルガイド</a>を作成しました。ドキュメントはまだ完成していないので、あしからず😂.</p>
<h2>アクセシビリティの標準化</h2>
<p><em>原則：最初からインクルーシブデザイン</em></p>
<p>モダンWeb開発において、アクセシビリティは絶対条件です。最初からアクセシビリティの高いWeb開発を実践しましょう。障がいの有無にかかわらず、誰もがアプリケーションを利用できるようにします。アクセシビリティの基準や、インクルーシブなユーザーエクスペリエンスを生み出すためのツールについては、Next.jsのサポートが役立ちます。筆者は、タブやドロップダウンなどアクセシビリティへの配慮が必要なコンポーネントには、<a href="https://www.radix-ui.com/">Radix UI</a>などのツールを使用します。</p>
<h3>パフォーマンス重視の開発</h3>
<p><em>原則：スピードは重要</em></p>
<p>エンタープライズユーザーはスピードを求めています。あらゆる場面でパフォーマンスを重視しましょう。アセットを最適化し、不要なリクエストを最小限に減らし、自動コード分割、Suspenseを使ったストリーミング、画像最適化といったNext.jsのパフォーマンス機能を活用します。素早く動くアプリケーションはユーザーの満足度が高いだけでなく、SEOにも好影響を与えます。</p>
<h3>セキュリティ第一</h3>
<p><em>原則：城を守る</em></p>
<p>フロントエンドアーキテクチャの構造の中にセキュリティを組み込み、クロスサイトスクリプティング（XSS）やクロスサイトリクエストフォージェリ（CSRF）などの一般的な脆弱性から守りましょう。セキュリティアップデートやベストプラクティスの実践を怠らず、Next.jsに組み込まれたセキュリティ機能は予備的な防御層とみなします。</p>
<h3>国際化（i18n）と地域化（l10n）</h3>
<p><em>原則：グローバルな視点で考える</em></p>
<p>つながりあったこの世界では、グローバルな視点で考えることが不可欠です。多様なユーザーに対応するため、最初から国際化（i18n）と地域化（l10n）を実施しましょう。Next.jsはこれらの機能のサポートが充実しているため、多言語アプリケーションの作成を容易にします。</p>
<p>これらの基本原則は、Next.jsを使用して効果的なエンタープライズ向けフロントエンドアーキテクチャを構築する上での土台を形成します。大規模アプリケーションの要求に沿って開発作業を進め、強固で保守性に優れ、使いやすいアプリケーションを開発できるよう、羅針盤の役割を果たします。以下のセクションでは、これらの原則を実践的な戦略やベストプラクティスに落とし込む方法を詳しく見ていきます。</p>
<h2>フォルダとファイル構造</h2>
<p>Reactでは、綿密に考えられたフォルダ構造によってプロジェクトを整理することが、保守性とスケーラビリティを実現する上で重要です。アプローチとしては、機能や目的に応じてファイルを整理する方法が一般的です。筆者が自分のアプリケーションでよく使用するフォルダ構造をサンプルとして紹介します。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">├─ src/
│ ├─ components/
│ │ ├─ ui/
│ │ │ ├─ Button/
│ │ │ ├─ Input/
│ │ │ ├─ ...
│ │ │ └─ index.tsx
│ │ ├─ shared/
│ │ │ ├─ Navbar/
│ │ └─ charts/
│ │ │ ├─ Bar/
│ ├─ modules/
│ │ ├─ HomePage/
│ │ ├─ ProductAddPage/
│ │ ├─ ProductPage/
│ │ ├─ ProductsPage/
│ │ │ ├─ api/
│ │ │ │ └─ useGetProducts/
│ │ │ ├─ components/
│ │ │ │ ├─ ProductItem/
│ │ │ │ ├─ ProductsStatistics/
│ │ │ │ └─ ...
│ │ │ ├─ utils/
│ │ │ │ └─ filterProductsByType/
│ │ │ └─ index.tsx
│ │ ├─ hooks/
│ │ ├─ consts/
│ │ └─ types/
│ │ └─ lib/
| | └─ styles/
│ │ │ ├─ global.css
│ │ └─ ...
│ ├─ public/
│ │ ├─ ...
│ │ └─ index.tsx
│ ├─ eslintrc.js
│ ├─ package.json
│ └─ tsconfig.json
└─ ...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li><strong>src/components</strong>: このディレクトリにはUIコンポーネントを格納します。さらに、一般的なUIコンポーネントを格納する<code class="language-text">ui</code>と、アプリケーションの他の部分で再利用する可能性のあるコンポーネントを格納する<code class="language-text">shared</code>に分かれています。</li>
<li><strong>src/modules</strong>: このディレクトリには、アプリケーションのさまざまなモジュールやページを格納します。モジュールごとにフォルダが分かれ、APIコール、コンポーネント、ユーティリティ機能のためのサブディレクトリが含まれる場合があります。</li>
<li><strong>src/pages</strong>: Next.jsを使用している場合、このフォルダはアプリケーションのエントリーポイントとしてのみ使用します。ここにはビジネスロジックは格納しません。pagesフォルダに格納されたコンポーネントは、必ずmodulesフォルダからページをレンダリングします。</li>
<li><strong>src/modules/ProductsPage</strong>: このモジュールは製品に関連し、APIコール、コンポーネント（<code class="language-text">ProductItem</code>や<code class="language-text">ProductsStatistics</code>など）、ユーティリティ機能（<code class="language-text">filterProductsByType</code>）のサブディレクトリが含まれます。</li>
<li><strong>src/lib</strong>: このフォルダには、後でパッケージに変換し、複数のアプリケーションで使用することができるユーティリティ機能を格納します。後でパッケージに変換することのないユーティリティ機能を格納する<strong>src/utils</strong>とは異なります。</li>
<li><strong>src/styles</strong>: このディレクトリには、グローバルスタイル（<code class="language-text">global.css</code>）や、スタイルに関連するその他のファイルを格納します。</li>
<li><strong>src/public</strong>: このフォルダには、ビルドプロセスで使用しない画像、フォント、<code class="language-text">index.html</code>ファイルなどの静的アセットを格納します。</li>
<li><strong>src/consts, src/types</strong>: これらのディレクトリには、それぞれ定数とTypeScriptの型定義を格納します。</li>
<li><strong>src/hooks</strong>: このディレクトリには、アプリケーション全体で使用するカスタムフックを格納します。</li>
<li><strong>eslintrc.js</strong>: これは、よく知られたJavaScript用構文チェックツールであるESLintの設定ファイルです。コーディング規約を適用し、コードの間違いを見つけるために使用します。</li>
</ul>
<p><code class="language-text">tsconfig</code>ファイルは、例えば<code class="language-text">Button</code>コンポーネントをインポートしたい場合、<code class="language-text">import { Button } from &#39;@/components/ui&#39;</code>のように指定してインポートできるよう設定されています。これを<code class="language-text">tsconfig.json</code>から設定するためのコードスニペットを以下に示します。</p>
<div class="gatsby-highlight" data-language="jsonc"><pre style="counter-reset: linenumber NaN" class="language-jsonc line-numbers"><code class="language-jsonc">{
  ...
  &quot;compilerOptions&quot;: {
    &quot;baseUrl&quot;: &quot;.&quot;,
    &quot;paths&quot;: {
      &quot;@/*&quot;: [&quot;./src/*&quot;]
    }
  }
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>TypeScriptのコーディング規約</h2>
<p>筆者が使用する規約は<a href="https://mkosir.github.io/typescript-style-guide/">こちら</a>のガイドに基づいています。ぜひ一読してみてください。以下のコードスニペットはこのガイドからの抜粋です。</p>
<h4>型は全て型エイリアスで定義する</h4>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token comment">// ❌ Avoid interface definitions unless you need to extend or implement them</span>

<span class="token keyword">interface</span> <span class="token class-name">UserRole</span> <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">|</span> <span class="token string">'guest'</span><span class="token punctuation">;</span> <span class="token comment">// invalid - interface can't define (commonly used) type unions</span>

<span class="token keyword">interface</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  role<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token operator">|</span> <span class="token string">'guest'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ✅ Use type definition</span>
<span class="token keyword">type</span> <span class="token class-name">UserRole</span> <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">|</span> <span class="token string">'guest'</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">UserInfo</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  role<span class="token operator">:</span> UserRole<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>複数の引数の使用を避ける</h4>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token comment">// ❌ Avoid having multiple arguments</span>
<span class="token function">transformUserInput</span><span class="token punctuation">(</span><span class="token string">'client'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ✅ Use options object as argument</span>
<span class="token function">transformUserInput</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'client'</span><span class="token punctuation">,</span>
  isValidated<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  minLines<span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
  maxLines<span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
  defaultInput<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  shouldLog<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  timeout<span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>命名規則</h4>
<p>最適な名前を決めるのは難しいものですが、既定の規則に従い、今後作業する開発者のためにコードの可読性を高め、一貫性を保つよう努めましょう。</p>
<h4>変数・定数</h4>
<ul>
<li><strong>ローカル変数</strong>　<code class="language-text">products</code>をキャメルケースで記述する（<code class="language-text">productsFiltered</code>）</li>
<li><strong>ブール型変数</strong>　<code class="language-text">is</code>や<code class="language-text">has</code>などの接頭辞を先頭に付ける（<code class="language-text">isDisabled</code>、<code class="language-text">hasProduct</code>）</li>
<li><strong>定数</strong>　大文字で記述（<code class="language-text">PRODUCT_ID</code>）</li>
<li><strong>オブジェクト型の定数</strong></li>
</ul>
<p>単数形を使用し、大文字で記述します。constアサーション（as const）を使用し、任意でsatisfies演算子を使用して型（その型が存在する場合）にマッチするかチェックします。</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript">  <span class="token keyword">const</span> <span class="token constant">ORDER_STATUS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    pending<span class="token operator">:</span> <span class="token string">'pending'</span><span class="token punctuation">,</span>
    fulfilled<span class="token operator">:</span> <span class="token string">'fulfilled'</span><span class="token punctuation">,</span>
    error<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span> satisfies OrderStatus<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>関数</h4>
<p>キャメルケース</p>
<p><code class="language-text">filterProductsByType</code>, <code class="language-text">formatCurrency</code></p>
<h4>ジェネリクス</h4>
<p><code class="language-text">TRequest</code>、<code class="language-text">TFooBar</code>のように先頭に大文字のTが付きます（<a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.dictionary-2?view=net-5.0">.Netの内部</a>実装と同様)。</p>
<p>よく使われる規約ではありますが、ジェネリクスを<code class="language-text">T</code>や<code class="language-text">K</code>など1文字で命名するのは避けましょう。変数が増えれば増えるほど、間違いやすくなります。</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token comment">// ❌ Avoid naming generics with one character</span>
<span class="token keyword">const</span> createPair <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">K</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span><span class="token operator">></span><span class="token punctuation">(</span>first<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> second<span class="token operator">:</span> <span class="token constant">K</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">K</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> second<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pair <span class="token operator">=</span> <span class="token function">createPair</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ✅ Name starts with the capital letter T</span>
<span class="token keyword">const</span> createPair <span class="token operator">=</span> <span class="token operator">&lt;</span>TFirst<span class="token punctuation">,</span> TSecond <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span><span class="token operator">></span><span class="token punctuation">(</span>
  first<span class="token operator">:</span> TFirst<span class="token punctuation">,</span>
  second<span class="token operator">:</span> TSecond
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span>TFirst<span class="token punctuation">,</span> TSecond<span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> second<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pair <span class="token operator">=</span> <span class="token function">createPair</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>パッケージとツール</h2>
<p>アプリケーションの開発では、作業の不要な重複を避けるため、一般的にサードパーティツールを活用します。筆者がスケーラブルなアプリケーションをビルドする際に使用するパッケージをいくつか紹介します。</p>
<h4>React Query/TanStack Query</h4>
<p>React Queryは、複雑なエンタープライズアプリケーションにおけるデータフェッチや同期化を管理するのに非常に便利です。APIからのデータフェッチやキャッシング、ミューテーション関数の処理へのアプローチを統一できます。エンタープライズ環境では、アプリケーションは複数のAPIやサービスと連携しなくてはならない場合が多くあります。React Queryは、データ管理を一元化し、ボイラープレートコードを減らすことで、このプロセスを効率化できます。</p>
<h4>React Context</h4>
<p>React Contextは、propsのバケツリレーを行うことなく、複数のコンポーネントにまたがるグローバルステートを管理するのに役立ちます。これは、アプリケーション全体でユーザー認証や環境設定などの共有ステートにアクセスする必要があるエンタープライズアプリケーションでは特に有益です。</p>
<p>通常、筆者はReact Contextなどの状態管理ツールの使用は最後の手段として取っておきます。グローバルステートに頼るのは必要最低限にとどめておくのがよいでしょう。その代わり、ステートはなるべく必要な場所の近くに置いておきましょう。</p>
<h4>Cypress</h4>
<p>Cypressは、E2Eのテストに非常に役立つツールです。エンタープライズアプリケーションでは、重要なワークフローや機能が異なる画面やコンポーネント上で正常に機能するようにすることが何よりも重要です。Cypressはダントツで筆者が一番気に入っているツールです。テストに合格すれば、新たに導入したコードがアプリケーションに不具合をもたらすことはないと確信できます。エンタープライズアプリケーションが進化していく中で、コードに新たな変更を加えた際にリグレッションテストを実施し、意図せぬ副作用が生じていないか確認することが重要です。Cypressは、テストプロセスを自動化することで、この確認作業を容易にします。</p>
<h4>React Testing Library:</h4>
<p>React Testing Libraryは、Reactコンポーネントの単体テストと統合テストに欠かせません。エンタープライズアプリケーションでは、個々のコンポーネントが期待どおり動作するか検証することが、強固なアプリケーションを作る上で重要です。React Testing Libraryは、各コンポーネントを単体で、さらに他のコンポーネントと組み合わせて、入念にテストすることを可能にします。</p>
<h4>NextAuth.js:</h4>
<p>NextAuth.jsは、Next.jsアプリケーションにおける認証と認可の実装を容易にします。エンタープライズ環境では、ユーザー管理のセキュリティは絶対条件です。企業の間では、複数のアプリケーションをまたいだユーザー認証を効率化するためにシングルサインオン（SSO）ソリューションがしばしば採用されます。NextAuth.jsはさまざまなSSOプロバイダーに対応しているため、エンタープライズ認証のニーズに最適なツールです。また、NextAuth.jsではカスタム認証フローを柔軟に実装することもできます。</p>
<p>NextAuth.jsでTypeScriptによるモジュール拡張を使用してデフォルトの<code class="language-text">User</code>モデルをカスタマイズする方法を説明した筆者の<a href="https://josemukorivo.com/blog/unlock-next-level-authentication-in-nextjs-with-next-auth-and-typescript-module-augmentation-1689">ブログ記事</a>もご覧ください。</p>
<h4>Turborepo</h4>
<p>これも筆者が気に入っているツールの1つです。Turborepoはモノレポの管理に役立ちます。大規模なエンタープライズアプリケーションでは、さまざまなモジュールやサービス、共有コードによりコードベースが膨大になる場合があります。Turborepoは、肥大化したコードベースを効率的に整理し、バージョン管理やデプロイメントを行いやすくします。エンタープライズ環境では、複数のチームやプロジェクトでコードを共有するのは一般的です。Turborepoは、効果的なコード共有を可能にし、共有ライブラリやコンポーネントを使用したチームコラボレーションをサポートします。</p>
<h3>Storybook</h3>
<p>Storybookを使用することで、開発者はUIコンポーネントを切り離し、制御された環境で動かすことができます。そのため、アプリケーション全体を操作することなく、個々のコンポーネントの外観や動作のデモを簡単に実施できます。大規模なエンタープライズアプリケーションでは、複数の開発者やチームがそれぞれUIの異なる部分を担当している場合があります。Storybookは、UIコンポーネントを披露して議論を交わすための一元的なプラットフォームを提供することで、コラボレーションの効率化を促し、デザイン言語の一貫性を確保します。<a href="https://ui.fin.africa/">こちら</a>は筆者がStorybookを使用して開発し、文書化したコンポーネントライブラリのサンプルです（まだ未完成ですが）。</p>
<p><em>エンタープライズ環境では、これらのツールを組み合わせることで、大規模アプリケーションを構築、テスト、維持管理し、データ管理、状態管理、テスト、認証、コード整理などの重要な課題に対処できます。</em></p>
<h2>再利用可能なコンポーネントのコーディングスタイル</h2>
<p>筆者が入力やダイアログなどの再利用可能なコンポーネントを開発する際には、なるべくベストプラクティスに沿って作業するようにしています。</p>
<p>では、<code class="language-text">Button</code>コンポーネントの開発を例にいくつかのベストプラクティスを紹介したいと思います。ベストプラクティスがビジュアルデザインだけにとどまらないことがお分かりいただけるかと思います。</p>
<h4>コンポーネントの再利用性</h4>
<p>ボタンコンポーネントはアプリケーションのさまざまな場所で再利用できるよう設計しましょう。さまざまなユースケースに対応可能な柔軟性が必要です。</p>
<h4>カスタマイズのためのPROPS</h4>
<p>サイズ、色、バリアント（1次、2次など）、無効化状態などの一般的なカスタマイズを行うためのpropsを用意しましょう。そうすることで、開発者はさまざまなUIコンテキストに合わせて容易にボタンを調整できます。</p>
<h4>アクセシビリティへの配慮</h4>
<p>aria-label属性やaria-disabled属性、フォーカス管理などの適切なアクセシビリティ機能を実装しましょう。そうすることで、アシスティブテクノロジー（支援技術）の利用者も効果的にボタンを使用できます。</p>
<h4>セマンティックHTML</h4>
<p>ボタンコンポーネントにセマンティックHTMLの要素を使用しましょう。そうすることで、アクセシビリティとSEOが向上し、異なるデバイス上でも適切な動作を確保できます。</p>
<h4>ボタンのネイティブ要素の模倣</h4>
<p>これらのベストプラクティスは全て、予測可能なコードを記述することにつながります。カスタムボタンコンポーネントを開発する場合、ボタンとして機能し、動作するようにしましょう。後述するコンポーネントの例では、ボタンのネイティブ要素を拡張することで、ボタンに追加できるあらゆるpropsを含めています。</p>
<h4>エラーハンドリング</h4>
<p>ボタンがエラー状態（フォームの送信など）につながる可能性がある場合、エラーを処理し、ユーザーに伝える方法を用意しましょう。</p>
<h4>テスト</h4>
<p>さまざまなシナリオでボタンコンポーネントが期待どおり動作することを検証するための単体テストを作成しましょう。テストケースはさまざまなpropsやイベントハンドラを網羅する必要があります。</p>
<h4>ドキュメント化</h4>
<p>利用可能なprops、イベントハンドラ、特定のユースケースなども含め、ボタンコンポーネントの使用方法をドキュメント化しましょう。開発者の参考になるような例やコードスニペットも記載します。これにはStorybookが役立ちます。</p>
<h4>クロスブラウザ互換性:</h4>
<p>異なるブラウザでボタンコンポーネントをテストし、動作や外観が一貫しているか確認しましょう。</p>
<h4>バージョン管理と変更履歴</h4>
<p>ボタンコンポーネントが共有ライブラリの一部である場合、バージョン管理を実施し、変更履歴を残すことで開発者に更新や変更について知らせましょう。</p>
<h3>コーディング</h3>
<p>筆者のコンポーネントには、大抵<code class="language-text">Button.tsx</code>、<code class="language-text">Button.stories.tsx</code>、<code class="language-text">Docs.mdx</code>、<code class="language-text">Button.test.ts</code>といったファイルが含まれます。CSSを使用している場合、<code class="language-text">Button.module.css</code>のようなファイルがあるかもしれません。</p>
<p><code class="language-text">components/ui/Button.tsx</code></p>
<p>これがメインのコンポーネントであり、<code class="language-text">cn</code>関数でクラスをマージし、コンフリクトに対処します。<code class="language-text">tw-merge</code>ライブラリのラッパーです。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  forwardRef<span class="token punctuation">,</span>
  <span class="token keyword">type</span> <span class="token class-name">ButtonHTMLAttributes</span><span class="token punctuation">,</span>
  <span class="token keyword">type</span> <span class="token class-name">JSXElementConstructor</span><span class="token punctuation">,</span>
  <span class="token keyword">type</span> <span class="token class-name">ReactElement</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AiOutlineLoading3Quarters <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-icons/ai'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> VariantProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'cva'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cva <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'cva'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">'next/link'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/lib'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> button <span class="token operator">=</span> <span class="token function">cva</span><span class="token punctuation">(</span>
  <span class="token string">'flex w-max items-center border-[1.5px] gap-2 transition duration-200 ease-linear focus:outline-0 focus:ring ring-offset-1 dark:ring-offset-blue-dark'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    variants<span class="token operator">:</span> <span class="token punctuation">{</span>
      variant<span class="token operator">:</span> <span class="token punctuation">{</span>
        outline<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        solid<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        naked<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      rounded<span class="token operator">:</span> <span class="token punctuation">{</span>
        none<span class="token operator">:</span> <span class="token string">'rounded-none'</span><span class="token punctuation">,</span>
        sm<span class="token operator">:</span> <span class="token string">'rounded'</span><span class="token punctuation">,</span>
        md<span class="token operator">:</span> <span class="token string">'rounded-lg'</span><span class="token punctuation">,</span>
        lg<span class="token operator">:</span> <span class="token string">'rounded-xl'</span><span class="token punctuation">,</span>
        full<span class="token operator">:</span> <span class="token string">'rounded-full'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      color<span class="token operator">:</span> <span class="token punctuation">{</span>
        primary<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        danger<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        info<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        warning<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        light<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        secondary<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      size<span class="token operator">:</span> <span class="token punctuation">{</span>
        xs<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        sm<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        md<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        lg<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      disabled<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      active<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      loading<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      fullWidth<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      align<span class="token operator">:</span> <span class="token punctuation">{</span>
        center<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        left<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        right<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        between<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    compoundVariants<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'solid'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'solid'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'primary'</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'outline'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'outline'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'light'</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span>
          <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'naked'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span>
          <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        disabled<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        variant<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'solid'</span><span class="token punctuation">,</span> <span class="token string">'outline'</span><span class="token punctuation">,</span> <span class="token string">'naked'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'light'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'outline'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'light'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'naked'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'primary'</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    defaultVariants<span class="token operator">:</span> <span class="token punctuation">{</span>
      size<span class="token operator">:</span> <span class="token string">'md'</span><span class="token punctuation">,</span>
      variant<span class="token operator">:</span> <span class="token string">'solid'</span><span class="token punctuation">,</span>
      color<span class="token operator">:</span> <span class="token string">'primary'</span><span class="token punctuation">,</span>
      rounded<span class="token operator">:</span> <span class="token string">'lg'</span><span class="token punctuation">,</span>
      align<span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">BaseProps</span>
  <span class="token keyword">extends</span> <span class="token class-name">Omit<span class="token operator">&lt;</span>
      ButtonHTMLAttributes<span class="token operator">&lt;</span>HTMLButtonElement<span class="token operator">></span><span class="token punctuation">,</span>
      <span class="token string">'color'</span> <span class="token operator">|</span> <span class="token string">'disabled'</span> <span class="token operator">|</span> <span class="token string">'active'</span>
    <span class="token operator">></span></span><span class="token punctuation">,</span>
    VariantProps<span class="token operator">&lt;</span><span class="token keyword">typeof</span> button<span class="token operator">></span> <span class="token punctuation">{</span>
  href<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  loadingText<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  target<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'_blank'</span> <span class="token operator">|</span> <span class="token string">'_self'</span> <span class="token operator">|</span> <span class="token string">'_parent'</span> <span class="token operator">|</span> <span class="token string">'_top'</span><span class="token punctuation">;</span>
  <span class="token keyword">as</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'button'</span> <span class="token operator">|</span> <span class="token string">'a'</span> <span class="token operator">|</span> JSXElementConstructor<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ButtonProps</span> <span class="token operator">=</span> BaseProps <span class="token operator">&amp;</span>
  <span class="token punctuation">(</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        rightIcon<span class="token operator">?</span><span class="token operator">:</span> ReactElement<span class="token punctuation">;</span>
        leftIcon<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        rightIcon<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
        leftIcon<span class="token operator">?</span><span class="token operator">:</span> ReactElement<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Button <span class="token operator">=</span> <span class="token generic-function"><span class="token function">forwardRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLButtonElement<span class="token punctuation">,</span> ButtonProps<span class="token operator">></span></span></span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token operator">:</span> Tag <span class="token operator">=</span> <span class="token string">'button'</span><span class="token punctuation">,</span>
      variant<span class="token punctuation">,</span>
      color<span class="token punctuation">,</span>
      rounded<span class="token punctuation">,</span>
      size<span class="token punctuation">,</span>
      target <span class="token operator">=</span> <span class="token string">'_self'</span><span class="token punctuation">,</span>
      loading<span class="token punctuation">,</span>
      fullWidth<span class="token punctuation">,</span>
      align<span class="token punctuation">,</span>
      loadingText<span class="token punctuation">,</span>
      href<span class="token punctuation">,</span>
      active<span class="token punctuation">,</span>
      rightIcon<span class="token punctuation">,</span>
      leftIcon<span class="token punctuation">,</span>
      className<span class="token punctuation">,</span>
      disabled<span class="token punctuation">,</span>
      children<span class="token punctuation">,</span>
      <span class="token operator">...</span>rest
    <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>

    <span class="token keyword">const</span> classes <span class="token operator">=</span> <span class="token function">cn</span><span class="token punctuation">(</span>
      <span class="token function">button</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        variant<span class="token punctuation">,</span>
        color<span class="token punctuation">,</span>
        size<span class="token punctuation">,</span>
        disabled<span class="token punctuation">,</span>
        loading<span class="token punctuation">,</span>
        active<span class="token punctuation">,</span>
        rounded<span class="token punctuation">,</span>
        fullWidth<span class="token punctuation">,</span>
        align<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      className
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>href <span class="token operator">?</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>classes<span class="token punctuation">}</span></span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>href<span class="token punctuation">}</span></span> <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>target<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span>leftIcon<span class="token punctuation">}</span><span class="token plain-text">
            </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
            </span><span class="token punctuation">{</span>rightIcon<span class="token punctuation">}</span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tag</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>classes<span class="token punctuation">}</span></span> <span class="token attr-name">disabled</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>disabled<span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span>loading <span class="token operator">?</span> <span class="token punctuation">(</span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AiOutlineLoading3Quarters</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>animate-spin<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
                </span><span class="token punctuation">{</span>loadingText <span class="token operator">||</span> <span class="token string">'Loading...'</span><span class="token punctuation">}</span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
            <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                </span><span class="token punctuation">{</span>leftIcon<span class="token punctuation">}</span><span class="token plain-text">
                </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
                </span><span class="token punctuation">{</span>rightIcon<span class="token punctuation">}</span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
            <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tag</span></span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

Button<span class="token punctuation">.</span>displayName <span class="token operator">=</span> <span class="token string">'Button'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">components/ui/Button.stories.tsx</code></p>
<p>このファイルには、Storybook向けのボタンのストーリーが含まれます。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> Meta<span class="token punctuation">,</span> StoryObj <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@storybook/react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FaRegSmileWink<span class="token punctuation">,</span> FaThumbsUp<span class="token punctuation">,</span> FaYinYang <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-icons/fa'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FiArrowUpRight <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-icons/fi'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./Button'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token string">'Components/Button'</span><span class="token punctuation">,</span>
  component<span class="token operator">:</span> Button<span class="token punctuation">,</span>
  parameters<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    children<span class="token operator">:</span> <span class="token string">'Click me!'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  argTypes<span class="token operator">:</span> <span class="token punctuation">{</span>
    children<span class="token operator">:</span> <span class="token punctuation">{</span>
      description<span class="token operator">:</span> <span class="token string">'This is the text of the button, can be a node.'</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    color<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'light'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'select'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'This controls the color scheme of the button'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'primary'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    variant<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'solid'</span><span class="token punctuation">,</span> <span class="token string">'outline'</span><span class="token punctuation">,</span> <span class="token string">'naked'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'select'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'This controls the variant of the button'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'solid'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    size<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'sm'</span><span class="token punctuation">,</span> <span class="token string">'md'</span><span class="token punctuation">,</span> <span class="token string">'lg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'radio'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'This controls the size of the button'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'md'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loading<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'boolean'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'This controls the loading state of the button'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    href<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If this is set, the button will be rendered as an anchor tag.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    className<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'Classes to be applied to the button'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    disabled<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'boolean'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'If true, the button will be disabled'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    rightIcon<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Smile'</span><span class="token punctuation">,</span> <span class="token string">'ThumbsUp'</span><span class="token punctuation">,</span> <span class="token string">'YinYang'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      mapping<span class="token operator">:</span> <span class="token punctuation">{</span>
        Smile<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaRegSmileWink</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
        ThumbsUp<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaThumbsUp</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
        YinYang<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaYinYang</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the icon will be rendered on the right side of the button'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    leftIcon<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Smile'</span><span class="token punctuation">,</span> <span class="token string">'ThumbsUp'</span><span class="token punctuation">,</span> <span class="token string">'YinYang'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      mapping<span class="token operator">:</span> <span class="token punctuation">{</span>
        Smile<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaRegSmileWink</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
        ThumbsUp<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaThumbsUp</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
        YinYang<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaYinYang</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the icon will be rendered on the left side of the button'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loadingText<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the text will be rendered while the button is in the loading state'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the target will be rendered as an attribute on the anchor tag'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'_self'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'select'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the button will be rendered as the specified element'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'button'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">as</span> Meta<span class="token operator">&lt;</span><span class="token keyword">typeof</span> Button<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Story</span> <span class="token operator">=</span> StoryObj<span class="token operator">&lt;</span><span class="token keyword">typeof</span> Button<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Primary<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Secondary<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Danger<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'danger'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Warning<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Light<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'light'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Info<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'info'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Custom<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    className<span class="token operator">:</span> <span class="token string">'bg-[yellow] text-[black] border-[orange]'</span><span class="token punctuation">,</span>
    style<span class="token operator">:</span> <span class="token punctuation">{</span> borderRadius<span class="token operator">:</span> <span class="token string">'3.5rem'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> WithRightIcon<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    rightIcon<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FiArrowUpRight</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>h-5 w-auto<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> WithLeftIcon<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    leftIcon<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FiArrowUpRight</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>h-5 w-auto<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Disabled<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    disabled<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> OutlineVariant<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    variant<span class="token operator">:</span> <span class="token string">'outline'</span><span class="token punctuation">,</span>
    color<span class="token operator">:</span> <span class="token string">'danger'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> NakedVariant<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    variant<span class="token operator">:</span> <span class="token string">'naked'</span><span class="token punctuation">,</span>
    color<span class="token operator">:</span> <span class="token string">'danger'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Loading<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> CustomLoadingText<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    loadingText<span class="token operator">:</span> <span class="token string">'Processing...'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> AsLink<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    href<span class="token operator">:</span> <span class="token string">'https://fin.africa'</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token string">'Visit fin website'</span><span class="token punctuation">,</span>
    rightIcon<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FiArrowUpRight</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>h-5 w-auto<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> FullWidth<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    fullWidth<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token string">'Visit fin website'</span><span class="token punctuation">,</span>
    rightIcon<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FiArrowUpRight</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>h-5 w-auto<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">components/ui/Docs.mdx</code></p>
<p>コンポーネントの仕組みをドキュメント化するのにストーリーファイルを使用することもできますが、Markdownファイルのほうがより詳細なドキュメント化が可能です。</p>
<p><code class="language-text">Button</code>コンポーネントの開発に使用した規約は、筆者が全てのコンポーネントで実践している規約と同じものです。</p>
<h2>重要なポイント</h2>
<ul>
<li>オープンソースソリューションであれ、自ら開発したものであれ、何らかのデザインシステムを用意しましょう。</li>
<li>TypeScriptと仲良くなりましょう。TypeScriptをうまく活用し、コンポーネントの使い方を規定しましょう。ボタンコンポーネントが良い例です。<code class="language-text">leftIcon</code>と<code class="language-text">rightIcon</code>という2つのpropsがありますが、この記事ではTypeScriptを使用することでいずれか一方のみが設定されるようにし、両方設定された場合はエラーを返すようにしました。</li>
</ul>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ButtonProps</span> <span class="token operator">=</span> BaseProps <span class="token operator">&amp;</span>
  <span class="token punctuation">(</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        rightIcon<span class="token operator">?</span><span class="token operator">:</span> ReactElement<span class="token punctuation">;</span>
        leftIcon<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        rightIcon<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
        leftIcon<span class="token operator">?</span><span class="token operator">:</span> ReactElement<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>コードとコンポーネントをドキュメント化しましょう。Storybookなどのツールを使用するとよいでしょう。</li>
<li>何らかのスタイルガイドを用意し、チームと共通のデザイン言語を使用しましょう。</li>
<li>分かりやすいコードを書きましょう。コードベースは簡単で分かりやすいものにし、焦点を絞ります。それぞれのコードには単一の明確な目的が必要です。</li>
<li>内部の仕組みを理解しましょう。Reactがどのようにして2つの値が同一であるかを確認するのかについて、筆者が調べた内容をこちらの記事にまとめています。</li>
</ul>
<h2>おわりに</h2>
<p>この記事では、筆者が使用している手法やツールの一部を紹介しました。手元にあるツールを全て網羅してはいませんが、ご自身のニーズに合ったものが見つかると幸いです。全く新しいものを採用するよりも、熟知している技術を使い続けるのが賢明でしょう。</p>
<p>つまるところ、クライアントが最も重視するのは最終製品であって、どのような技術を使用したかではないのです。Reactであれ、Vueであれ、あるいはその他のツールであれ、素早くデプロイでき、ユーザーにメリットがあるようなツールやワークフローを優先的に使用しましょう。</p>
<h2>Resources</h2>
<ul>
<li><a href="https://mkosir.github.io/typescript-style-guide/">TypeScript Style Guide</a></li>
<li><a href="https://turbo.build/">Turborepo</a></li>
<li><a href="https://nextjs.org/">Next.js</a></li>
<li><a href="https://tailwindcss.com/">Tailwind CSS</a></li>
<li><a href="https://prettier.io/">Prettier</a></li>
<li><a href="https://josemukorivo.com/">My website</a></li>
</ul>]]></content:encoded></item><item><title><![CDATA[First Important Paint−カスタム指標の開発]]></title><description><![CDATA[2020年5月、GoogleがWebサイトのパフォーマンス測定を目的としたユーザー中心の指標を発表しました。コアウェブバイタル（CWV）と呼ばれるこの一連の指標には、以下が含まれます。 LCP (L…]]></description><link>https://postd.cc/custom-metrics/</link><guid isPermaLink="false">https://postd.cc/custom-metrics/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[LCP]]></category><category><![CDATA[ブラウザ]]></category><pubDate>Mon, 27 Nov 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>2020年5月、GoogleがWebサイトのパフォーマンス測定を目的とした<a href="https://web.dev/user-centric-performance-metrics/">ユーザー中心</a>の指標を発表しました。<a href="https://web.dev/articles/vitals">コアウェブバイタル（CWV）</a>と呼ばれるこの一連の指標には、以下が含まれます。</p>
<ul>
<li><a href="https://web.dev/lcp">LCP (Largest Contentful Paint)</a>：ビューポート内で最大の要素が表示されるまでの時間。</li>
<li><a href="https://web.dev/fid">FID (First Input Delay)</a>：ユーザーの最初の入力に応答するまでの遅延時間。近々INP (Interaction to Next Paint)に置き換わる予定。</li>
<li><a href="https://web.dev/cls">CLS (Cumulative Layout Shift)</a>：ページのコンテンツがどれだけ移動したかを表す指標。-</li>
</ul>
<p>CWVの狙いは、世の中にあふれるさまざまなパフォーマンス指標を簡素化し、最も重要な指標に優先的に取り組めるようにすることです。この取り組みは好影響をもたらしています。CWVの発表以降、多くのWebオーナーやサービスプロバイダがWebサイトのパフォーマンスに力を注いでおり、Web全体でユーザー体験が向上しています。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-cwv-tech-report.png">
<a href="https://cwvtech.report/">cwvtech.report</a>から引用した上のグラフが示すように、<a href="https://lookerstudio.google.com/u/0/reporting/55bc8fad-44c2-4280-aa0b-5f3f0cd3d2be/page/M6ZPC?params=%7B%22df44%22:%22include%25EE%2580%25800%25EE%2580%2580IN%25EE%2580%2580ALL%22%7D">CWVのしきい値を満たすWebサイトの割合が22%から40%に増えています</a>。</p>
<h2>カスタム指標の役割</h2>
<p>ブラウザにあらかじめ用意されているデフォルト指標に独自のカスタム指標を追加することで、Webサイトのユーザー体験をより正確に測定できる場合があります。例えば、LCPは最も大きな要素が最も重要であると想定します。その通りの場合もありますが、そうではない場合もあります。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-demo.png">
上の画像群では、赤枠で囲まれたフレームの、青のグラデーションの背景画像がLCP要素です。一方、最も重要な要素は、その次のフレームでレンダリングされる「Lorem」というページタイトルでしょう。これは極端な例かもしれませんが、重要な要素がグリッドまたはテーブルの場合や、背景が<code class="language-text">poster</code>画像を含む<code class="language-text">&lt;video&gt;</code>要素の場合にも同じ問題が生じます。</p>
<h3>Element Timing API</h3>
<p>LCPと同様に、<a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceElementTiming">Element Timing API</a>を使用することで、ページ上でDOM要素がレンダリングされるタイミングを測定することができます。しかし、LCPと異なるのは、測定する要素を開発者が選べることです。Element Timing API は、<code class="language-text">elementtiming</code>属性を要素に追加することで設定できます。
Element Timing API の最大の制約は、<a href="https://caniuse.com/mdn-api_element_elementtiming">Chromiumベースのブラウザしか対応していない</a>ことです。また、<a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceElementTiming#description">一部の要素</a>しか対応していません。</p>
<h3>User Timing API</h3>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance_API/User_timing">User Timing API</a>を使用することで、特定のタイミングにマークや指標を設定することができます。例えば、ページ上に要素が描画されたタイミングや、重要なタスクが実行されたタイミングなどに設定できます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// タスク開始時の時間を記録する</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'doSomething:start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// タスク終了時の時間を記録する</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'doSomething:end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// :startと:endの時間差を測定する</span>
performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'doSomething'</span><span class="token punctuation">,</span> <span class="token string">'doSomething:start'</span><span class="token punctuation">,</span> <span class="token string">'doSomething:end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>実ユーザー指標とラボテスト</h2>
<p>カスタム指標を開発するに当たって最初に問うべきことは、この指標を実際のユーザーとデバイスで測定したいのか、それともラボテスト（※）でのみ測定したいのかということです。どちらの指標も有益ですが、それぞれに異なる利点があります。
（※訳注：ユーザーではなく、開発者がツール等を使って行うテストをラボテストと呼称しています）
実ユーザー指標（Real user metrics, RUM）は、ユーザー体験を全面的に測定することができます。単一のスコアではなく、異なるユーザーや体験を反映したさまざまな値が得られます。例えば、90パーセンタイルのユーザーは散々な体験をするかもしれませんが、平均的なユーザーは良い体験をします。指標に影響を及ぼすさまざまな要因（地理的な場所、ブラウザ、デバイス）を理解することで、自分のユーザーのためにWebサイトを最適化することができます。マイナス面としては、RUMソリューションの実装は複雑で、費用がかさむ場合があることです。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-rum.png"></p>
<p>上のスクリーンショットは<a href="https://speedcurve.com/">SpeedCurve</a>から引用したもので、異なるユーザー体験の分布を示しています。</p>
<p>ラボテストは管理された環境で行われます。接続速度、デバイス、テストを実行する場所などいくつかのパラメータは設定できるかもしれません。テスト結果のレポートには、ページ上で測定したさまざまな指標について詳しく記載されます。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-wpt.png"></p>
<p>ラボテストはデバッグに極めて有効です。一定の間隔でラボテストを行うことにより、長期間にわたってページのパフォーマンスを比較し、不具合を特定することができます。筆者がラボテストを行う際には、<a href="https://webpagetest.org/">WebPageTest</a>というツールを愛用しています。</p>
<h2>優れた指標の特徴</h2>
<p><a href="https://www.youtube.com/watch?v=diAc65p15ag">ポール・アイリッシュ</a>が2020年にLCPについて紹介した際、優れた指標が持つべき8つの特徴について説明しました。これを少しアレンジしたものが、<a href="https://chromium.googlesource.com/chromium/src/+/lkgr/docs/speed/good_toplevel_metrics.md">Chromiumのソースコードに関するドキュメント</a>の中にもあります。</p>
<ul>
<li>代表性：ユーザー体験および事業価値と相関する。</li>
<li>解釈可能性：指標およびその価値が理解しやすい。</li>
<li>正確性：測定すべき内容を正確に測定できているか。</li>
<li>単純性：計算方法が複雑でない。</li>
<li>直交性：測定する内容が他の指標と重複しない。</li>
<li>安定性：測定にばらつきが少ない。</li>
<li>弾力性：入力に小さな変化があると、指標にも小さな変化が表れる。</li>
<li>相関性：他の指標との相関性や、ラボテストとフィールドテストの間の相関性がある。</li>
</ul>
<h3>観察者効果</h3>
<p>優れた指標の重要な特徴としてもう一つ挙げられるのが、テストそのものに影響を及ぼさないということです。科学用語では、観察する行為がテストに影響を与えることを<a href="https://en.wikipedia.org/wiki/Observer_effect_(physics)">観察者効果</a>と呼びます。カスタム指標の測定によりページの表示速度が明らかに低下する場合、それは良い指標とは言えません。</p>
<h2>FIP (First Important Paint)</h2>
<p><a href="https://github.com/kevinfarrugia/first-important-paint">First Important Paint</a>は、最初の注釈付きHTML要素がページ上に表示されるまでの時間を測定するために開発されたカスタム指標です。</p>
<p>この指標が必要になったのは、LCP要素がユーザー体験と一致しない場合があったためです。さらに、ページを構成するさまざまなコンポーネントが、異なるチームの開発者によって作成されることも多くありました。ページではなく要素に注釈を付けることで、自動的にFIP候補として扱われるため、開発者はコンポーネントがどのページで使用されるのか知る必要がありません。</p>
<p>（それに、3文字の略称も付いているため正規のものに見えますよね😛）</p>
<h3>FIPは優れた指標か？</h3>
<p>First Important Paintは、ユーザーが実際に使う環境でのテストでも<a href="https://www.webpagetest.org/result/230609_BiDc8Q_1d6bbfd5da548a2bb04076a5c6bf1438/2/details/">ラボテスト</a>でも測定できます。FIPが優れた指標かどうかを判断するため、マーケットの異なる2つの本番サイトでいくつかのラボテストを実施し、データを収集しました。</p>
<h3>代表性</h3>
<p>FIPの代表性を検証するため、異なるページのスクリーンショットと異なるデバイスを使用したラボテストをいくつか用意し、この指標について何も知らない同僚数名に最も重要な要素が描画されていると思うフレームを選んでもらいました。このデータをもとに、重要な要素として扱うべきコンポーネントを判断し、LCPがすでにこの情報を示していたかどうかを評価しました。</p>
<h3>解釈可能性</h3>
<p>FIPは分かりやすく、ミリ秒単位で測定されます。</p>
<h3>正確性</h3>
<p>カスタム指標の正確性を測定するため、FIP要素がLCP要素でもあるラボテストをいくつか実施しました。これはつまり、FIPとLCPの値が同等であることが望ましいということです。テキスト要素には、LCPの代わりにElement Timing APIを使用しました。</p>
<p>テストは<a href="https://docs.google.com/spreadsheets/d/1ola_2GGd1NWOqeVJ_Ea1CGbLn2DvcGNHDI2P43xgtjg/edit?usp=sharing#gid=1072306481">画像</a>要素と<a href="https://docs.google.com/spreadsheets/d/1ola_2GGd1NWOqeVJ_Ea1CGbLn2DvcGNHDI2P43xgtjg/edit?usp=sharing#gid=2063136168">テキスト</a>要素を対象とし、接続速度の異なる3つの回線を使用して行いました。ネイティブ回線では、FIPとLCPの差は50ミリ秒でした。Regular 4G回線とRegular 3G回線では、それぞれ200ミリ秒と1000ミリ秒に差が広がりました。</p>
<p>これらの結果は期待外れに見えるかもしれませんが、測定結果は一貫しており、LCPまたはElement Timing API とFIPの差はテストによって大きく違いませんでした。例えば、あるテストではLCPよりFIPの方が50ミリ秒速く、次のテストでは50ミリ秒遅かった方が問題です。</p>
<p>正確性に欠ける理由はさまざまであり、指標の計算方法の限界でもあります。</p>
<h3>単純性</h3>
<p><a href="https://github.com/kevinfarrugia/first-important-paint">FIPを測定、計算するためのコード</a>は単純で、デバッグや変更も必要に応じて簡単に行えます。</p>
<h3>直交性</h3>
<p>FIPは、ページ上で最も重要な要素を測定するためのカスタム指標です。最も重要な要素が最も大きな要素でもある場合があり、その場合はFIPとLCPが重複することになります。</p>
<h3>安定性</h3>
<p>FIPの安定性を測定するため、接続速度の異なる3つの回線でラボテストを行いました。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-stable.png"></p>
<p>上のグラフが示すように、どの回線でもテストによるばらつきはほとんどありませんでした。</p>
<h3>弾力性</h3>
<p>ユーザー体験の変化に比例した変化が指標に見られる場合、その指標は弾力性があるとみなされます。FIPに弾力性があるかどうかをテストするため、基準となるデモページと、これに変更を加え、フォントファイルをセルフホストしてあらかじめ読み込むようにしたページを作成しました。タイトルのレンダリングが早くなるため、ユーザー体験が改善されることが期待され、それに伴いFIPも改善するはずです。</p>
<p><a href="https://www.webpagetest.org/result/230609_BiDc6F_4f0c2f5d8d52b79857b016b539cc2ebe/3/details/">FIPの古いバージョンの中に、この変更による改善が一切見られないものがありました</a>。そのおかげで、指標に不備があったことが判明しました。FIPはテキスト要素がDOMに追加された時間を記録していたのですが、Webフォントがまだダウンロードされていないケースを考慮していなかったのです。</p>
<p>この問題を解決してからは、ユーザー体験の向上に<a href="https://www.webpagetest.org/video/compare.php?tests=230609_BiDc8Q_1d6bbfd5da548a2bb04076a5c6bf1438-l:Original,230609_AiDcZW_f90f83a17cae800f8fc845dea6c8fd38-l:Optimized-e:filmstrip">比例した小さな改善がFIPに見られるようになりました</a>。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-elastic.png"></p>
<p>上の比較をご覧ください。<a href="https://www.webpagetest.org/result/230609_BiDc8Q_1d6bbfd5da548a2bb04076a5c6bf1438/2/details/#waterfall_view_step1">元ページのテスト</a>では、LCPが1.315秒で、FIPが1.470秒でした。上記の修正を加えた<a href="https://www.webpagetest.org/result/230609_AiDcZW_f90f83a17cae800f8fc845dea6c8fd38/1/details/">最適化ページのテスト</a>では、LCPが1.305秒で、FIPは1.188秒に改善されました。この改善はユーザー体験とも一致しており、2回目のテストではユーザー体験が大幅に改善されています。</p>
<h3>相関性</h3>
<p>FIPと他の指標の相関性を確認するため、正確性の説明で述べたのと同じテストを使用しました。散布図にFIPとLCPの測定結果を記入し、<a href="https://en.wikipedia.org/wiki/Coefficient_of_determination">決定係数</a>を計算しました。2つの指標が相関するためには、両者の値が一致する必要はありませんが、LCPが増えたらそれに比例してFIPも増え、FIPが増えたら同様にLCPも増える必要があります。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-correlates-lcp.png"></p>
<p>テキスト要素の場合、Regular 4G回線で強い相関が見られたものの、Regular 3G回線では同等の強い相関が見られませんでした。</p>
<p>SpeedCurveで入手可能な実ユーザーデータを使用し、FIPとビジネス指標の相関性を見ることもできます。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-correlates-bounce-rate.png"></p>
<p>上のグラフはSpeedCurveから引用したものですが、FIPが増えるとページの直帰率（青い線）も増えており、両者の間には正の相関関係が見られます。</p>
<h3>観察者効果</h3>
<p>最後に、この指標はテスト対象のページのパフォーマンスに影響を及ぼさないことを確認したいと思います。指標を含むページと、指標の代わりに同等のサイズのレンダーブロッキングとなるスクリプトを含むページで同じテストを実施しました。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-observer-effect.png">
上のグラフが示すように、LCP要素は両者のテスト間でほとんど変わりませんでした。将来的には、LCPの他にJavaScriptの<a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceLongTaskTiming">ロングタスク</a>も含めたテストを行ってみたいと思います。</p>
<h2>まとめ</h2>
<p>この記事の狙いは、社内で指標のレビューを行うきっかけになることです。<a href="https://web.dev/articles/vitals">CWV</a>の対象範囲と優れたカスタム指標の条件を理解することで、自分が使用している指標を評価し、改善することができます。</p>
<p>First Important Paintは優れた指標でしょうか？限界もありますし、有用性もケースバイケースでしょう。しかし、我々にとっては現時点で重要な役割を果たしています。さらに改善を加え、ユーザー体験の他の側面を測定する新たなカスタム指標を追加していきたいと思っています。</p>
<p>最後までお読みいただきありがとうございました。ご意見やご質問のある方はぜひご連絡ください。</p>]]></content:encoded></item><item><title><![CDATA[fetchPriorityと、LCPの最適化]]></title><description><![CDATA[fetchPriority APIは、リソースの相対的な優先度をブラウザに示すために使用します。fetchpriority属性を、、、の各要素に追加するか、Fetch API上で属性を使用することで…]]></description><link>https://postd.cc/fetchpriority-opportunity/</link><guid isPermaLink="false">https://postd.cc/fetchpriority-opportunity/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[LCP]]></category><category><![CDATA[ブラウザ]]></category><pubDate>Mon, 30 Oct 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>fetchPriority APIは、リソースの相対的な優先度をブラウザに示すために使用します。fetchpriority属性を<code class="language-text">&lt;img&gt;</code>、<code class="language-text">&lt;link&gt;</code>、<code class="language-text">&lt;script&gt;</code>、<code class="language-text">&lt;iframe&gt;</code>の各要素に追加するか、Fetch <a href="https://fetch.spec.whatwg.org/#fetch-method">API</a>上で<code class="language-text">priority</code>属性を使用することで優先度を設定できます。</p>
<p>ブラウザのロードプロセスは複雑です。ブラウザは、主にリクエストの種類や、ドキュメントのマークアップ内におけるリクエストの位置によってその優先度を判断します。例えば、ドキュメントの<code class="language-text">&lt;head&gt;</code>内で要求されたCSSファイルの優先度は<code class="language-text">Highest</code>となり、<code class="language-text">defer</code>属性が設定された<code class="language-text">&lt;script&gt;</code>要素の優先度は<code class="language-text">Low</code>となります。ブラウザは、同じ優先度が割り当てられたリソースを、検出した順にダウンロードします。</p>
<h2>fetchpriority</h2>
<p><a href="https://wicg.github.io/priority-hints/#definitions">fetchpriority</a>属性を使用することで、要求されたリソースの優先度を高くしたり低くしたりするようブラウザに指示できます。これは列挙型の属性であり、以下の3つの内いずれかの値を指定できます。</p>
<ul>
<li>high – リソースの優先度がデフォルトの優先度よりも高い</li>
<li>low – リソースの優先度がデフォルトの優先度よりも低い</li>
<li>auto – デフォルト値</li>
</ul>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lcp.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>A dog<span class="token punctuation">"</span></span> <span class="token attr-name">fetchpriority</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>high<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>上の例では、<code class="language-text">&lt;img&gt;</code>の優先度がデフォルトの優先度よりも高いことをブラウザに示しています。</p>
<p><code class="language-text">fetch</code>メソッドの<a href="https://fetch.spec.whatwg.org/#dom-requestinit-priority">priority</a>属性でも同じ値を指定できます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/api/data.json"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> priority<span class="token operator">:</span> <span class="token string">'high'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>上の[fetch]リクエストでは、リクエストの優先度がデフォルトの優先度よりも高いことをブラウザに示しています。</p>
<h2>デフォルトの優先度</h2>
<p>fetchPriority APIを使用することで、デフォルトの優先度に対してリソースの優先度を高くしたり低くしたりすることができます。例えば、画像のデフォルトの優先度は<code class="language-text">Low</code>ですが、<code class="language-text">fetchpriority=&quot;high&quot;</code>と指定することで優先度を<code class="language-text">High</code>に変更できます。一方、レンダーブロッキングとなるスタイルシートのデフォルトの優先度は<code class="language-text">Highest</code>です。<code class="language-text">fetchpriority=&quot;low&quot;</code>と指定すると、優先度は<code class="language-text">Low</code>ではなく<code class="language-text">High</code>に変更されます。<code class="language-text">fetchpriority</code>は、値を明示的に設定するのではなく、デフォルトを基準としてリソースの優先度を調整するために使用します。</p>
<p><a href="https://docs.google.com/document/d/1bCDuq9H1ih9iNjgzyAL0gpwNFiEP4TZS-YLRp_RuMlc/edit">influence of Fetch Priority on resource prioritization in Chromiumという文書</a>には、各種リソースタイプ、デフォルトの優先度（◉）、<code class="language-text">fetchpriority=&quot;high&quot;</code>（⬆）および<code class="language-text">fetchpriority=&quot;low&quot;</code>（⬇）を使用した場合の優先度が記されています。</p>
<p><em>ビューポート内にあることが判明した画像の優先度はHighに引き上げられます。しかし、その時点ではロードプロセスがかなり進んでいる可能性もあり、すでにリクエストを送信済みの場合はほとんど影響がないか、まったく影響がない可能性もあります。fetchpriority="high"を使用することで、画像がビューポート内にあるかどうかをブラウザが判断するまで待つのではなく、最初から優先度をHighに指定することができます。</em></p>
<h2>「タイトモード」</h2>
<p>ほとんどのブラウザは、2つのフェーズに分けてリソースをダウンロードします。初期フェーズ（Chromiumでは「タイトモード」とも呼ばれます）では、実行中のリクエストの数が2つ未満の場合を除き、優先度が<code class="language-text">Low</code>のリソースはダウンロードされません。</p>
<p><img src="/article-assets/fetchpriority-opportunity/tight-mode.png"></p>
<p>上のウォーターフォールチャートを見ると、リソース<code class="language-text">image-1.jpg</code>のダウンロードは、直ちに検出されたとしても<code class="language-text">style-2.css</code>のダウンロードが完了するまで開始されないことが分かります。この時点でダウンロード中のリソースは<code class="language-text">script.js</code>のみのため、優先度が<code class="language-text">Low</code>の画像のダウンロードが開始されます。</p>
<p>初期フェーズは、<code class="language-text">&lt;head&gt;</code>内のブロッキングスクリプトが全てダウンロードされ、実行された時点で完了します（<code class="language-text">async</code>または<code class="language-text">defer</code>が設定されたスクリプトはレンダーブロッキングではありません）。それ以降は、実行中のリクエストの数が2つ以上ある場合でも、残りのリソースの優先度とマークアップ内における順序に基づいてダウンロードが行われます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/interactive.png"></p>
<p>上のチャートでは、レンダーブロッキングとなるJavaScriptがダウンロードされ、実行（ピンク色のバー）された時点で、2つのCSSファイルのダウンロードがまだ進行中であるものの、画像のダウンロードが開始します。黄色の縦線は、<code class="language-text">readystatechange</code>イベントが発生したタイミング、すなわちDOMインタラクティブを示しています。</p>
<h2>preconnect</h2>
<p>画像が別のドメイン上に存在する場合、ブラウザはファイルをダウンロードする前にドメインへの接続を開く必要があります。</p>
<p><img src="/article-assets/fetchpriority-opportunity/crossorigin-images.png"></p>
<p>これは、WebPageTestチャート上でダウンロードの前にある緑色、オレンジ色、赤紫色のバーによって示されています。<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Link_types/preconnect">preconnect</a>リソースヒントを使用することで、画像のダウンロード開始を早めることができます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/preconnect.png"></p>
<p>上のチャートでは、ブラウザがファイルのダウンロードを開始できる前に、初期フェーズで<code class="language-text">cdn.glitch.global</code>ドメインへの接続が開かれています。初期フェーズが終了した時点（黄色の縦線）で、直ちに画像のダウンロードが開始されます。これにより、約350ミリ秒の節約になります。</p>
<h2>preload</h2>
<p><code class="language-text">preconnect</code>リソースヒントを使用してダウンロード時間を短縮できるのであれば、<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Link_types/preload">preload</a>ディレクティブを使用することでさらに短縮できるのでしょうか。結論から言うとできません。preloadディレクティブは、「遅れて検出」される重要なリソースについて、ブラウザに情報を伝えるために使用できます。これは、スタイルシートやスクリプトに組み込まれた背景画像やフォントなどのリソースを読み込む際に特に役立ちます。ここで紹介する例では、画像はマークアップ内で宣言され、早い段階で検出されるため、プリロードを行ってもほとんど影響がありません。</p>
<p><img src="/article-assets/fetchpriority-opportunity/preload.png"></p>
<p>上のチャートでは、<code class="language-text">preconnect</code>ヒントを以下に置き換えました。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span>
  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span>
  <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image<span class="token punctuation">"</span></span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.glitch.global/.../image-1.jpg<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>プリロードを行ったにもかかわらず、処理中のリクエストの数が2つ未満になるまで画像のダウンロードは開始されません。</p>
<h2>fetchpriority</h2>
<p>以下のように、fetchPriorityを使用することで、<code class="language-text">image-1.jpg</code>がデフォルトの優先度よりも重要であることをブラウザに示すことができます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.glitch.global/.../image-1.jpg<span class="token punctuation">"</span></span>
  <span class="token attr-name">fetchpriority</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>high<span class="token punctuation">"</span></span>
  <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これにより、最初から画像の優先度を<code class="language-text">Low</code>から<code class="language-text">High</code>に高め、初期フェーズで画像を読み込ませることができます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/fetchpriority.png"></p>
<p>上のウォーターフォールチャートでは、<code class="language-text">image-1.jpg</code>が他の重要なリソースと並行して初期フェーズで読み込まれています。これにより、ここまでで最も大きな改善が得られます。</p>
<h2>Firefox</h2>
<p>Firefoxも、同様の方法を用いて初期フェーズで読み込むリソースを判断しています。しかし、Chromiumベースのブラウザとは異なり、<code class="language-text">&lt;head&gt;</code>内のJavaScriptが全てダウンロードされ、実行されるまで、優先度が<code class="language-text">Low</code>のリソースのダウンロードは開始されません。これは、優先度が<code class="language-text">High</code>のリクエストが1つしか進行していない場合でも同じです。</p>
<p><img src="/article-assets/fetchpriority-opportunity/firefox-tight-mode.png"></p>
<p>上はFirefox Webデベロッパーツールのスクリーンショットです。これによると、画像リソース（5行目〜8行目）はスクリプト（2行目）のダウンロードと実行が完了し、ページが<code class="language-text">interactive</code>（青い縦線）になってから取得されることが分かります。</p>
<p><em>Chromeは<code class="language-text">&lt;head&gt;</code>内で宣言されたJavaScriptがダウンロードされ、実行されるまで待ちますが、Firefoxは、<code class="language-text">&lt;head&gt;</code>内で宣言されたものでなくても、画像要素より前に宣言された全てのレンダーブロッキングとなるJavaScriptがダウンロードされ、実行されるまで待ちます。</em></p>
<p>Firefoxはまだ<a href="https://github.com/whatwg/html/issues/7150#issuecomment-1299923593">fetchpriorityに対応</a>していませんが、<code class="language-text">preload</code>ディレクティブを使用することで<code class="language-text">image-1.jpg</code>の優先度を高めることができます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/firefox-preload-and-fetchpriority.png"></p>
<p>上のスクリーンショットでは、他のリソースと並行して<code class="language-text">image-1.jpg</code>ファイルを取得しています。これは、Google Chromeで<code class="language-text">fetchpriority=&quot;high&quot;</code>を追加した際に見た挙動と似ています。</p>
<h2>Safari</h2>
<p>iOSやmacOS上で動作するSafariにも初期フェーズはありますが、ChromeやFirefoxとは挙動が異なります。</p>
<p>優先度が<code class="language-text">Low</code>のリソースは、処理中のリクエストの数が2つ未満になると取得を開始します。<code class="language-text">readystatechange</code>イベントに依存せず、レンダーブロッキングとなるJavaScriptがないページでも、処理中のリクエストが1つになるまで待ちます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/safari-tight-mode.png"></p>
<p>上はSafariのWebインスペクタのスクリーンショットです。ここでは、<code class="language-text">style-1.css</code>のダウンロードが完了し、処理中のリクエストの数が2つ未満になるまで画像のダウンロードは開始していません。</p>
<p>Safariでは、初期フェーズは同じドメイン上にあるリソースにしか適用されません。優先度が<code class="language-text">Low</code>のリソースが別のドメインから読み込まれる場合、検出された時点で取得されます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/safari-crossorigin.png"></p>
<p>上のスクリーンショットでは、優先度が<code class="language-text">High</code>のリソースのダウンロードが終わるまで待つことなく、crossorigin属性の画像が直ちに取得されています。</p>
<p><code class="language-text">preload</code>ディレクティブはリソースの優先度に影響しませんが、検出された時点で処理中のリクエストの数が2つ未満なので、優先度が<code class="language-text">High</code>のリクエストの前に<code class="language-text">&lt;link rel=&quot;preload&quot;&gt;</code>ディレクティブを入れることでダウンロードを早めることができます。この挙動は他のブラウザと同じですが、レンダーブロッキングとなるCSSが優先されるべきなので、ほとんどの場合、優先度が<code class="language-text">High</code>のリソースの上に<code class="language-text">preload</code>ディレクティブを入れることは推奨しません。</p>
<p><img src="/article-assets/fetchpriority-opportunity/safari-preload.png"></p>
<p>このスクリーンショットでは、ドキュメントのマークアップ内で<code class="language-text">&lt;link rel=&quot;preload&quot;&gt;</code>が上に挿入されているため、優先度が<code class="language-text">Low</code>の<code class="language-text">image-1.jpg</code>ファイルのほうが、優先度が<code class="language-text">High</code>の<code class="language-text">style-1.css</code>ファイルより先にダウンロードを開始しています。</p>
<h2>preloadとfetchpriorityを組み合わせる</h2>
<p>現時点でfetchPriorityに<a href="https://caniuse.com/?search=fetchpriority">対応しているのはChromiumベースのブラウザ</a>だけですが、
fetchpriority属性を認識しない未対応ブラウザでも、機能はしないものの大きな支障は来しません。したがって、<code class="language-text">fetchPriority</code>と<code class="language-text">preload</code>ディレクティブを組み合わせて使用することができます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span>
  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span>
  <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image<span class="token punctuation">"</span></span>
  <span class="token attr-name">fetchpriority</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>high<span class="token punctuation">"</span></span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.glitch.global/.../image-1.jpg<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>FetchPriorityに対応したブラウザは、割り当てられた<code class="language-text">fetchpriority</code>属性を使用してリソースをプリロードし、未対応のブラウザは<code class="language-text">preload</code>ディレクティブを使用します。</p>
<p><img src="/article-assets/fetchpriority-opportunity/preload-and-fetchpriority.png"></p>
<p>上のチャートは、<code class="language-text">&lt;img&gt;</code>要素にfetchpriority属性を含んだ前述の例と似た結果を示しています。この方法の利点は、<code class="language-text">fetchPriority</code>に対応したブラウザと未対応のブラウザ上のリソースを優先順位付けするアプローチを統一できることにあります。</p>
<h2>fetchpriorityに関するさまざまな考察</h2>
<p>このセクションでは、<code class="language-text">fetchpriority</code>を使用する潜在的な利点について見ていきます。データは全て<a href="https://httparchive.org/">HTTP Archive</a>から取得したものであり、HTTP/2またはHTTP/3を使用し、LCP（<a href="https://web.dev/lcp">Largest Contentful Paint</a>）要素が画像のページについてのみ検討します。<a href="https://github.com/kevinfarrugia/fetchpriority-opportunity">クエリ</a>と<a href="https://docs.google.com/spreadsheets/d/11QwVrr1zcFGBhOMNe25uFBD9VUfg4JP3AUkhWjod9RY/edit?usp=sharing">結果</a>は全て公開されています。</p>
<p><em>注記：HTTP Archiveのデータは、Chrome上でWebPageTestのプライベートインスタンスを使用して収集したものです。<a href="https://httparchive.org/faq#how-is-the-data-gathered">データの収集方法に関する詳細はこちらをご覧ください</a>。</em></p>
<p><img src="/article-assets/fetchpriority-opportunity/opportunity.png"></p>
<p><code class="language-text">fetchpriority</code>の利点は、リソースが検出されてからダウンロードが開始されるまでの時間差にあると考えられます。筆者はこれをopportunityと呼んでいます。したがって、早い段階でリソースが検出されたものの、ダウンロードが始まるのが遅い場合、その分opportunityは大きくなります。</p>
<p><em>注記：画像が異なるドメインからダウンロードされる場合、接続を開くための時間もopportunityの中に含めています。</em></p>
<p><img src="/article-assets/fetchpriority-opportunity/opportunity-vs-largest-contentful-paint.png"></p>
<p>上のチャートでは、LCPに対するopportunity（ミリ秒単位）を図示しています。opportunityは100ミリ秒単位のバケットに分け、1,000ミリ秒超のopportunityは1つのバケットにまとめています。チャートはopportunityとLCPの間に強い相関関係を示しており、opportunityが大きいほどLCPが悪化しています。</p>
<p><img src="/article-assets/fetchpriority-opportunity/opportunity-by-initial-priority.png"></p>
<p>上のチャートは、優先度が<code class="language-text">Low</code>と<code class="language-text">High</code>のリソースについて、モバイル端末のopportunityの分布を示しています。中央値では、優先度が<code class="language-text">High</code>のLCP画像は検出された21ミリ秒後にダウンロードが始まっていますが、優先度が<code class="language-text">Low</code>のLCP画像は102ミリ秒後にダウンロードされています。75パーセンタイルや90パーセンタイルになるとその差はさらに開きます。</p>
<p><em>fetchpriority="High"の他にも、画像の検出が遅い場合（CSS background-imageを使用する場合やJavaScriptを使用して画像を追加する場合）には優先度の初期設定がHighになっている可能性があります。その場合は、リクエストの優先度がすでにHighに設定されているため、fetchpriorityは役に立ちません。</em></p>
<p>結論としては、LCP画像の優先順位付けを行うことには明確な利点があります。opportunityはページの構成によって異なります。優先度がLowのリソースは、レンダーブロッキングとなるスクリプトが1つ以上、処理中のリクエストが2つ以上ある場合、すぐに取得されないことは前述の通りです。</p>
<p><img src="/article-assets/fetchpriority-opportunity/no-of-render-blocking-resources-vs-median-opportunity.png"></p>
<p>上のチャートは、opportunity（ミリ秒単位）に対するレンダーブロッキングとなるリソースの数を図示しています。ページ上にあるレンダーブロッキングとなるリソースの数が多いほど、LCP画像のダウンロードが遅れることが直感的に分かります。</p>
<h2>まとめ</h2>
<p>リソースヒントやfetchPriorityを使用することで、LCP画像の優先順位付けを行う大きなチャンスがあります。メインドキュメント上ですぐに検出できる場合でも、LCP要素がキューで待機中のページは少なくありません。</p>
<p><img src="/article-assets/fetchpriority-opportunity/distribution-of-opportunity.png"></p>
<p>上のチャートを見ると、中央値のモバイルサイトではLCP画像のダウンロードが開始されるまで98ミリ秒の待機時間があります。90パーセンタイルでは810ミリ秒です。fetchPriorityを使用すれば、LCP画像の優先度を高め、待機時間を減らすことができます。</p>
<p>また、LCP画像に<code class="language-text">fetchpriority=&quot;high&quot;</code>を追加するとLCP（<a href="https://web.dev/lcp">Largest Contentful Paint</a>）が改善することを示す事例もあります。<a href="https://www.etsy.com/codeascraft/priority-hints-what-your-browser-doesnt-know-yet">Etsyは4%の改善を報告しており</a>、20〜30%の改善を報告している企業もあります。</p>
<p>あるリソースの優先度を高めると、大抵は別のリソースにしわ寄せが来るため、fetchPriorityは控えめに使用するべきでしょう。しかし、ブラウザがLCP画像をキューに入れているようであれば、fetchPriorityを使用することで待機時間を減らし、LCPを改善できるか試してみることをお勧めします。</p>
<p>以下にポイントをまとめます。</p>
<ul>
<li>LCP画像はHTMLドキュメントと同じドメイン上にホスティングする。それが難しい場合、<code class="language-text">preconnect</code>を使用して早い段階で接続を開く。</li>
<li>LCP画像はドキュメントのマークアップの一部を構成することが望ましい。それが難しい場合、<code class="language-text">preload</code>を使用し、リクエストされる前に画像をダウンロードするようブラウザに指示する。</li>
<li>リソースは極力ブロックしないこと。優先度が<code class="language-text">Low</code>のLCP画像をダウンロードする場合、<code class="language-text">fetchpriority</code>を使用してダウンロードを早めるようブラウザに指示する。</li>
<li>Firefoxでは、<code class="language-text">fetchpriority</code>に対応するまでは<code class="language-text">preload</code>を使用してLCP画像の優先度を高めることができる。Safariでは、<code class="language-text">preload</code>ディレクティブを使用しても画像のダウンロードは早くならない。</li>
</ul>
<p>本稿に関するご意見やご感想をぜひお聞かせください。</p>
<h2>おすすめリンク</h2>
<ul>
<li><a href="https://fetchpriority-opportunity.glitch.me/">Demos</a></li>
<li><a href="https://github.com/kevinfarrugia/fetchpriority-opportunity">Queries</a> &#x26; <a href="https://docs.google.com/spreadsheets/d/11QwVrr1zcFGBhOMNe25uFBD9VUfg4JP3AUkhWjod9RY/edit?usp=sharing">Results</a></li>
<li><a href="https://web.dev/priority-hints/">Optimizing resource loading with Priority Hints</a> (web.dev)</li>
<li><a href="https://www.debugbear.com/blog/priority-hints">Prioritizing Important Page Resources With Priority Hints</a> (<a href="http://debugbear.com/">debugbear.com</a>)</li>
</ul>
<h2>謝辞</h2>
<p>本稿の執筆にあたり、貴重なフィードバックとアドバイスをいただいた<a href="https://webperf.social/@tunetheweb">バリー・ポラード氏</a>に心より感謝申し上げます。</p>
<h2>注記</h2>
<ul>
<li>この機能は当初Priority Hintsと呼ばれていましたが、標準化後はFetch Priorityに名称が変更されました。</li>
</ul>]]></content:encoded></item><item><title><![CDATA[UIのチラつきを撲滅する：useLayoutEffect、ペインティング、ブラウザについて]]></title><description><![CDATA[この記事では、DOMの測定結果に基づいて要素を変更する方法、useEffectの問題点とuseLayoutEffectによる解決法、ブラウザペインティングとは何か、SSRの役割について説明します。
…]]></description><link>https://postd.cc/no-more-flickering-ui/</link><guid isPermaLink="false">https://postd.cc/no-more-flickering-ui/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><pubDate>Fri, 29 Sep 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>この記事では、DOMの測定結果に基づいて要素を変更する方法、useEffectの問題点とuseLayoutEffectによる解決法、ブラウザペインティングとは何か、SSRの役割について説明します。
この記事と同じ内容を扱ったYouTube動画も公開していますので、活字媒体よりも動画視聴を好まれる方はそちらをご覧ください。文字ではなく、アニメーションと音声で同じ概念を解説しています。
<a href="https://www.youtube.com/watch?v=__tm1dyMi4A">この記事は動画形式でも公開しています。</a></p>
<h2>目次</h2>
<ul>
<li><a href="#01">useEffectの問題点とは？</a></li>
<li><a href="#02">useLayoutEffectでチラつきを解決する</a></li>
<li><a href="#03">解決策が有効な理由：レンダリング、ペインティング、ブラウザ</a></li>
<li><a href="#04">Next.jsやその他のSSRフレームワークでuseLayoutEffectを実行する</a></li>
</ul>
<p>ReactにおけるDOMアクセスについてもう少しお話ししましょう。<a href="/refs-from-dom-to-api/">"前回の記事 ReactにおけるRef：DOMへのアクセスから命令型APIまで"</a>では、Refを使用してDOMにアクセスする方法について説明し、Refに関することは全て網羅しました。しかし、DOMの使用方法については、あまり語られることはないものの非常に重要なトピックがもう1つあります。それは、要素のサイズや位置といったDOMの実際の測定結果に基づいた要素の変更です。
では、具体的な問題点は何であり、「通常」の方法では不十分な理由は何でしょうか。実際に少しコーディングを行いながら解明していきましょう。このプロセスを通じて、<code class="language-text">useLayoutEffect</code>について知るべきあらゆること、<code class="language-text">useEffect</code>ではなく<code class="language-text">useLayoutEffect</code>を使用すべきときとその理由、Reactコードがブラウザによってどのようにレンダリングされるのか、ペインティングとは何か、これらがなぜ重要で、SSRがどのような役割を果たすのかが分かると思います。</p>
<h2>useEffectの問題点とは？ <a name="01"></a></h2>
<p>では実際にコーディングしてみましょう。今日は少し凝ったことがしたいので、レスポンシブ対応のナビゲーションコンポーネントを作ってみます。このコンポーネントは、1列に並んだリンクをレンダリングし、コンテナのサイズに応じてリンクの数を調整することができます。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/menu-full-screen.png"></p>
<p>コンテナに収まりきらないリンクがある場合は「もっと見る」ボタンを表示し、これをクリックするとドロップダウンメニューに残りのリンクが表示されるようにします。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/menu-collapsed.png"></p>
<p>次はコンポーネント本体です。作るのは、データ配列を受け取り、適切なリンクをレンダリングするコンポーネントのみです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navigation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>href<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>では、これをレスポンシブ化するにはどうすればよいでしょうか。問題は、与えられたスペースに入るアイテムの数を計算しなくてはならないことです。そのためには、レンダリングが行われるコンテナの幅と、各アイテムのサイズが分からなくてはなりません。文字数を数えるなどして、事前に仮定することはできません。ブラウザ上でのテキストのレンダリングは、使用するフォントや言語、ブラウザによって異なります。ひょっとすると、月の満ち欠けの影響も受けるかもしれません。
実際のサイズを取得する唯一の方法は、ブラウザにそれらのアイテムをレンダリングさせた上で、<code class="language-text">getBoundingClientRect</code>というJavaScriptのネイティブAPI経由でサイズを抽出するやり方です。
これを行うにはいくつかの手順を踏む必要があります。まず、要素にアクセスします。Refを作成し、対象となるアイテムをラップするdivに代入することができます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navigation<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Refの使い方や、Refを使ったDOMの操作に自信がない方は、<a href="/refs-from-dom-to-api/">"ReactにおけるRef：DOMへのアクセスから命令型APIまで"</a>をお読みください。
次に、useEffectでdiv要素を取得し、そのサイズを確認します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> div <span class="token operator">=</span> ref<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> width <span class="token punctuation">}</span> <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>それからdivの子要素を反復処理し、幅を配列の中に抽出します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// same code as before</span>


    <span class="token comment">// convert div's children into an array</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>div<span class="token punctuation">.</span>childNodes<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// all the widths</span>
    <span class="token keyword">const</span> childrenWidths <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=></span> child<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>後はこの配列を反復処理し、子要素の幅を合計し、その合計を親要素のdivと比較すれば、最終的に表示されるアイテムが分かります。
ただ、1つ忘れているものがあります。「もっと見る」ボタンです。このボタンの幅も考慮に入れなくてはいけません。そうしなければ、いくつかのアイテムは表示されるものの、「もっと見る」ボタンが入りきらないという状況になりかねません。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/more-button-should-fit.png"></p>
<p>「もっと見る」ボタンの場合も同様に、ブラウザ上でレンダリングしなければ幅は分かりません。したがって、最初のレンダリング時に明示的にボタンを追加する必要があります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navigation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>href<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      &lt;!-- add the "more" button after the links explicitly -->
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>more<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>抽象化によって幅計算のロジックを全て関数にまとめるならば、useEffectの中は次のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> itemIndex <span class="token operator">=</span> <span class="token function">getLastVisibleItem</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>ここでは、<code class="language-text">getLastVisibleItem</code>関数が、全ての計算を行い、1つの数字を返してくれます。この数字が、与えられたスペースに入る最後のリンクのインデックスです。今回はロジック自体については詳しく説明しません。やり方は無数にあり、後で紹介する最終コードの中で例をお見せします。
ここで重要なのは、この数字を得たことです。Reactの観点から次に行うべきことは何でしょうか。このままだと、全てのリンクと「もっと見る」ボタンが表示されてしまいます。解決策は1つしかありません。コンポーネントの更新をトリガーし、表示されるべきでないアイテムを取り除く必要があります。
これがほぼ唯一の方法です。数字は取得したときのステートで保存する必要があります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// set the initial value to -1, to indicate that we haven't run the calculations yet</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>lastVisibleMenuItem<span class="token punctuation">,</span> setLastVisibleMenuItem<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> itemIndex <span class="token operator">=</span> <span class="token function">getLastVisibleItem</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// update state with the actual number</span>
      <span class="token function">setLastVisibleMenuItem</span><span class="token punctuation">(</span>itemIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>そして、メニューをレンダリングする際に、それを考慮に入れます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>


  <span class="token comment">// render everything if it's the first pass and the value is still the default</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastVisibleMenuItem <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render all of them here, same as before</span>
    <span class="token keyword">return</span> <span class="token operator">...</span>
  <span class="token punctuation">}</span>


  <span class="token comment">// show "more" button if the last visible item is not the last one in the array</span>
  <span class="token keyword">const</span> isMoreVisible <span class="token operator">=</span> lastVisibleMenuItem <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>


  <span class="token comment">// filter out those items which index is more than the last visible</span>
  <span class="token keyword">const</span> filteredItems <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> index <span class="token operator">&lt;=</span> lastVisibleMenuItem<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navigation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      &lt;!-- render only visible items -->
      </span><span class="token punctuation">{</span>filteredItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>href<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      &lt;!-- render "more" conditionally -->
      </span><span class="token punctuation">{</span>isMoreVisible <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>more<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これだけです。実際の数字でステートを更新すると、ナビゲーションのリレンダリングがトリガーされ、Reactがアイテムを再びレンダリングし、表示されないものを取り除きます。「適切」なレスポンシブ体験を作り出すためには、リサイズイベントを拾い、数字を再計算する必要もありますが、その実装については読者に委ねたいと思います。
完全に機能する例を下のCodeSandboxで公開しているのでご覧ください。リサイズにも対応しています😊。でも喜ぶのはまだ早いです。ユーザーエクスペリエンスに重大な欠陥が1つあります。</p>
<iframe src="https://codesandbox.io/embed/simple-responsive-menu-example-ltdx5r?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="simple-responsive-menu-example"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<p>何度かリフレッシュしてみてください。特に、CPUがスローダウンしている状態で試してみてください。残念なことに、コンテンツのチラつきがかなりひどいことが分かると思います。メニューの全てのアイテムと「もっと見る」ボタンが表示される最初のレンダリング結果は、はっきりと見えなくてはいけません。本番公開までに確実に修正する必要があります。</p>
<h2>useLayoutEffectでチラつきを解決する <a name="02"></a></h2>
<p>画面のチラつきの原因は明らかです。不要なアイテムを除外する前にアイテムをレンダリングして表示させてしまうので、チラつきが発生します。また、レスポンシブデザインが機能するためには最初にレンダリングを行う必要があります。したがって、この問題を解決する方法としては、最初のレンダリングはそのまま実行しますが、opacityを0に設定して行うか、表示領域外のdivの中で見えないように行う方法が考えられます。そして、サイズとマジックナンバーを抽出してから表示させるのです。以前は、このようなケースにはこの方法で対応していました。
しかし、フックが導入されたReact 16.8以降は、<code class="language-text">useEffect</code>フックを<code class="language-text">useLayoutEffect</code>に置き換えるだけで解決できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// everything is exactly the same, only the hook name is different</span>
    <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// the code is still the same</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これだけで、まるで魔法のように最初のチラつきがなくなります。実際にご覧ください。</p>
<iframe src="https://codesandbox.io/embed/simple-responsive-menu-example-fixed-hx1dxc?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="simple-responsive-menu-example-fixed"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<p>しかし、これは安全な方法なのでしょうか。もしそうであるならば、<code class="language-text">useEffect</code>を全てこれに置き換えればよいのではないでしょうか。ドキュメントには、<code class="language-text">useLayoutEffect</code>は<a href="https://react.dev/reference/react/useLayoutEffect">パフォーマンスに悪影響を及ぼす可能性がある</a>ため、使用を避けるべきであるとはっきりと記載されています。なぜでしょうか。ドキュメントには、<code class="language-text">useLayoutEffect</code>は「ブラウザが画面をリペイントする前」に発火するとも書かれています。これはつまり、<code class="language-text">useEffect</code>は画面がリペイントされた後で発火することを暗に示しています。しかし、これは実用面では具体的にどのような意味を持つのでしょうか。単純なドロップダウンを記述する際にブラウザペインティングのような低レイヤーの概念について考える必要があるのでしょうか🤯。
これらの問いに答えるためには、少しReactから離れてブラウザとJavaScriptについて話す必要があります。</p>
<h2>解決策が有効な理由：レンダリング、ペインティング、ブラウザ <a name="03"></a></h2>
<p>ここでまず必要なのは、「ブラウザレンダリング」です。Reactの世界では、Reactにおけるレンダリングと区別するために「ペインティング」とも呼ばれています。Reactにおけるレンダリングとペインティングは全くの別物です。考え方としては比較的単純です。ブラウザは、画面上にリアルタイムで表示する必要があるものを全て継続的に更新するわけではありません。例えば、ホワイトボードに線を描き、線を消し、文字を書き、あるいはフクロウのスケッチを描いたりするのとは違います。
それよりも、スライドを切り替えながら表示するのに似ています。あるスライドを表示して、見ている人がその内容を理解したら次のスライドに移るという要領です。
非常に遅いブラウザにフクロウの描き方を聞いたならば、おそらく以下の絵のようなひどい指示が返ってくるでしょう。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/owl.png"></p>
<p>ただし、ブラウザが描くスピードは非常に速いです。通常、モダンなブラウザは60fps（毎秒60フレーム）のフレームレートを維持しようとします。約13ミリ秒ごとにスライドが切り替わるイメージです。Reactで「ペインティング」と呼ぶのはこの処理のことです。
スライドを更新する情報は複数の「タスク」に分割されます。タスクはキューに入れられます。ブラウザはキューからタスクを取得して実行します。時間に余裕があれば、約13ミリ秒の中で時間がなくなるまで次のタスクを実行していき、最後に画面をリフレッシュします。これを休むことなく続けます。私たちがこうした処理を意識せずにTwitter（X）でドゥームスクローリングを行ったりできるのはそのおかげです。
「タスク」とは何でしょうか。通常のJavaScriptの場合、scriptタグに入れて同時に実行するもの全てをタスクと呼びます。次のコードをご覧ください。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> child <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"&lt;h1>Heyo!&lt;/h1>"</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>


child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 10px solid red"</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 20px solid green"</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 30px solid black"</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>IDを使用して要素を取得し、<code class="language-text">app</code>変数に入れ、<code class="language-text">div</code>を作成します。次に、HTMLを更新してdivをappに付加し、divのborderを3回変更します。ブラウザにとっては、この一連の処理が全て1つのタスクとして認識されます。したがって、全ての行を実行してから、最終結果である黒いborderのdivを描画します。
画面上では、赤→緑→黒の遷移は見えません。
1つの「タスク」に13ミリ秒以上かかる場合はどうなるでしょうか。まあ、残念だと言うしかありません 🤷🏻‍♀️。ブラウザは、タスクを停止することも分割することもできません。完了するまで処理を続けてから、最終結果をペイントします。borderの更新間に1秒間のブロッキング（原文では synchronous delays）を追加した場合、次のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">waitSync</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    now <span class="token operator">=</span> start<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> start <span class="token operator">&lt;</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 10px solid red"</span><span class="token punctuation">;</span>
<span class="token function">waitSync</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 20px solid green"</span><span class="token punctuation">;</span>
<span class="token function">waitSync</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 30px solid black"</span><span class="token punctuation">;</span>
<span class="token function">waitSync</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>その場合でも、「中間」の結果は見えません。ブラウザが処理を行う間は何もない画面が表示されるだけで、最後に黒いborderが表示されます。これを「ブロッキングレンダー」あるいは「ブロッキングペインティング」コードと呼びます。
<a href="https://codesandbox.io/s/understanding-painting-sync-example-m76lzh">CodesSandboxで例をご覧ください</a>。
Reactは単なるJavaScriptですが、もちろん単一のタスクとして実行されるわけではありません。もしそうであるならば、インターネットは耐えがたいものになるでしょう。そうなれば私たちは皆外に出て遊び、直接人と関わることを余儀なくされるでしょう。そんなことを誰が望むでしょうか。アプリ全体をレンダリングするような巨大なタスクを小さなタスクに「分割」するには、コールバック、イベントハンドラー、プロミスなどさまざまな「非同期」メソッドを使用する必要があります。
これらのスタイル調整を、遅延0で<code class="language-text">setTimeout</code>にラップしたとします。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 10px solid red"</span><span class="token punctuation">;</span>
  <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 20px solid green"</span><span class="token punctuation">;</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 30px solid black"</span><span class="token punctuation">;</span>
      <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>その場合、全てのタイムアウトが新しい「タスク」と見なされます。したがって、ブラウザは1つのタスクを終え、次のタスクを開始する前に、画面をリペイントできます。そして、何もない白い画面を3秒間ぼーっと眺める代わりに、赤から緑へ、そして黒へと、ゆっくりとではあるものの美しく移り変わる様子を見ることができます。
<a href="https://codesandbox.io/embed/understanding-painting-sync-example-m76lzh?fontsize=14&#x26;hidenavigation=1&#x26;theme=dark">コード付きのCodeSandboxはこちらをご覧ください</a>。
Reactはこのようなことを行ってくれます。一言で言えば、Reactはコーディングによって作られた何百ものnpmの依存関係で構成される巨大な塊を、ブラウザが（理想的には）13ミリ秒以内で処理できる最小限の塊に分割してくれる、極めて複雑で効率的なエンジンです。
これは非常にかいつまんだ短い紹介です。きちんと説明しようと思えば1冊の本になってしまいます。<a href="https://blog.xnim.me/event-loop-and-render-queue">"Browser Event loop: micro and macro tasks, call stack, render queue: layout, paint, composite"</a>は、ブラウザのイベントループとクエリに関する極めて秀逸な総合ガイドです。</p>
<h3>useEffectとuseLayoutEffectの比較に戻る <a name="031"></a></h3>
<p>では、<code class="language-text">useEffect</code>と<code class="language-text">useLayoutEffect</code>の比較に戻り、最初に挙げたいくつかの問いについて検討したいと思います。
<code class="language-text">useLayoutEffect</code>は、コンポーネントの更新時にReactが同時に実行するものです。次のコードをご覧ください。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>コンポーネントの中で何かをレンダリングすると、必ず<code class="language-text">useLayoutEffect</code>が同じ「タスク」として実行されます。Reactがそれを保証します。たとえ<code class="language-text">useLayoutEffect</code>の中でステートを更新しても、通常ステートは非同期タスクと見なされますが、Reactはそれでも全体のフローが同時に実行されるようにします。
最初に実装した「ナビゲーション」の例に戻りましょう。ブラウザの観点から言うと、これは1つの「タスク」に過ぎません。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/use-layout-flow.png"></p>
<p>この状況は、見ることができなかった赤→緑→黒のborder線の遷移と全く同じです。
一方、<code class="language-text">useEffect</code>の場合、フローが2つのタスクに分割されます。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/use-effect-flow.png"></p>
<p>1つ目のタスクでは、全てのボタンを含むナビゲーションの「最初」のレンダリングをし、2つ目のタスクでは、不要な子要素を除外します。そして、2つのタスクの間に画面のリペインティングが行われます。タイムアウト間のborderと全く同じ状況です。
では、最初の問いに答えましょう。<code class="language-text">useLayoutEffect</code>を使うのは安全でしょうか。はい、安全です。パフォーマンスに悪影響を及ぼす可能性はあるでしょうか。もちろんです。Reactのアプリ全体が同時に実行される1つの巨大な「タスク」になってしまうのは望ましくありません。
<code class="language-text">useLayoutEffect</code> の使用は、要素の実際のサイズに従ってUIを調整する必要があり、それによって引き起こされる視覚的な「乱れ」を取り除く必要がある場合のみにしてください。それ以外は<code class="language-text">useEffect</code>を使うのが正解です。<a href="https://react.dev/learn/you-might-not-need-an-effect">"You Might Not Need an Effect – React"</a>によると、それさえも必要ないかもしれません。</p>
<h3>useEffectについてもう少し <a name="032"></a></h3>
<p><code class="language-text">setTimeout</code>の中で<code class="language-text">useEffect</code>を実行するメンタルモデルは違いを理解するのには便利ですが、厳密には正確ではありません。まず、実装の詳細を明確にすると、Reactはこのモデルではなく、<code class="language-text">postMessage</code>を<code class="language-text">requestAnimationFrame</code>のトリックと組み合わせて使用します。このトリックについては私も知りませんでした。詳しく知りたい方は、<a href="https://stackoverflow.com/questions/56727477/react-how-does-react-make-sure-that-useeffect-is-called-after-the-browser-has-h/56727837#56727837">"React: How does React make sure that useEffect is called after the browser has had a chance to paint?"</a>で説明されているのでぜひご覧ください。
また、非同期に実行されることは実際には保証されていません。Reactは可能な限り最適化しようとしますが、ブラウザペイントの前に実行され、結果的にブロックされるケースもあります。そのようなケースの1つが、一連の更新のどこかに<code class="language-text">useLayoutEffect</code>がすでに存在する場合です。理屈と仕組みを理解したい場合は、<a href="https://blog.thoughtspile.tech/2021/11/15/unintentional-layout-effect/">"useEffect sometimes fires before paint"</a>をご覧ください。こちらの記事にとても優れた調査結果が詳しくまとめられています。</p>
<h2>Next.jsやその他のSSRフレームワークでuseLayoutEffectを実行する <a name="04"></a></h2>
<p>低レイヤーJavaScriptやブラウザについてはこれくらいにして、本番コードに戻りたいと思います。というのも、「現実世界」では、これらはさほど頻繁に考える必要のないことだからです。「現実世界」では、Next.js（Next.jsの宣伝記事ではないので、もちろん他のフレームワークでも構いません😅​​​​）のようなフレームワーク上で、美しいレスポンシブナビゲーションをコーディングし、優れたユーザーエクスペリエンスを構築できればよいのです。
実際にやってみると、全くうまくいかないことにまず気づきます。チラつきはなくなっておらず、魔法はもう消えています。<a href="https://codesandbox.io/p/sandbox/simple-nextjs-uselayout-example-6sflsg?file=%2FREADME.md">こちらの例を開いて</a>何度かページをリフレッシュしてみてください。もしくは、Next.jsアプリをお持ちでしたら、前に修正したナビゲーションをコピペしてみてください。
何が起きているのでしょうか？🤨
SSR、つまりサーバーサイドレンダリングです。一部のフレームワークがデフォルトでサポートしている素晴らしい機能ですが、このようなケースでは極めて厄介な代物です。
SSRが有効になっていると、Reactコンポーネントの最初のレンダリングと全てのライフサイクルイベントの呼び出しは、コードがブラウザに届く前にサーバー上で行われます。SSRの仕組みに詳しくない人のために説明すると、これは単にバックエンドのどこかで何らかのメソッドが<code class="language-text">React.renderToString(&lt;App /&gt;)</code>のようなものを呼び出すということを意味します。そうすると、Reactは次にアプリ内の全てのコンポーネントを処理して「レンダリング」（単に関数を呼び出すということです。コンポーネントはただの関数なので）し、各コンポーネントが表すHTMLを生成します。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/react-to-html-ssr.png"></p>
<p>次に、このHTMLがブラウザに送られるページ内に注入され、ページが送信されます。これは、全てがサーバー上で生成され、メニューを開くためだけにJavaScriptを使用していた昔と同じやり方です。その後、ブラウザがページをダウンロードして表示し、（Reactを含む）全てのスクリプトをダウンロードして（Reactも含めて）実行します。Reactはあらかじめ生成されたHTMLを処理し、多少のインタラクティブ要素を組み込みます。これで再びページが使える状態になります。
問題は、最初のHTMLを生成した時点では、まだブラウザがないということです。したがって、要素の実際のサイズ計算（<code class="language-text">useLayoutEffect</code>で行うような）を必要とする処理は、サーバー上では単純にうまくいきません。サイズのある要素はまだ存在せず、あるのは文字列だけなので。<code class="language-text">useLayoutEffect</code>の目的そのものが要素のサイズを取得することなので、サーバー上で実行してもあまり意味はありません。Reactはサーバー上で実行しません。
その結果、ブラウザが最初に読み込む、まだインタラクティブ要素のないページに表示されるのは、コンポーネントの「最初」のステージでレンダリングされた内容です。すなわち、「もっと見る」ボタンを含む全てのボタンの列です。ブラウザが全ての処理を実行し、Reactが機能する状態になったら、ようやく<code class="language-text">useLayoutEffect</code>を実行できるようになり、ボタンが隠れます。しかし、画面のチラつきはあります。
これをどう修正するかはユーザーエクスペリエンスの問題であり、ユーザーに「デフォルトで」何を表示したいかによります。メニューの代わりに「読み込み中」の状態を表示したり、最も重要なメニュー項目を1つか2つ表示したり、項目を完全に非表示にしてクライアント上でのみレンダリングすることもできるでしょう。どうするかはあなた次第です。
1つの方法としては、shouldRenderというステート変数を導入し、<code class="language-text">useEffect</code>の中でtrueに切り替えます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shouldRender<span class="token punctuation">,</span> setShouldRender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setShouldRender</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldRender<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SomeNavigationSubstitude</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Navigation</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">useEffect</code>はクライアント上でのみ実行されるため、初回のSSRでは代替コンポーネントが表示されます。次に、クライアントコードが作動し、<code class="language-text">useEffect</code>が実行され、ステートが変わり、Reactがそれを通常のレスポンシブナビゲーションに置き換えます。
ここでステートを導入することを恐れる必要はありません。また、次のような条件付きのレンダリングを実行しようとしないでください。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Detecting SSR by checking whether window is there</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> ‘<span class="token keyword">undefined</span>’<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SomeNavigationSubstitude</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Navigation</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>厳密には、typeof window === ‘undefined’はSSR環境を示しますが（サーバー上にウィンドウはありません）、私たちのユースケースでは役に立ちません。Reactでは、SSRから受け取ったHTMLと、クライアント上で初回にレンダリングされたHTMLが完全に一致する必要があります。これらが一致しない場合、アプリは正常に機能しません。さらに詳しく知りたい人は、<a href="https://www.joshwcomeau.com/react/the-perils-of-rehydration/">The Perils of Rehydration</a>という記事がこのテーマについて優れた考察を行っていますので、そちらをご覧ください。</p>
<hr>
<p>手軽で便利なトリックについて簡単に説明するだけのつもりが、レンダリングについてかなり突っ込んだ議論になってしまいました。途中で脱落された方がいないことを願います​​😅
この調査で参考にしたリソースを以下にご紹介します。さらに詳しく学びたい方は、ぜひご覧ください。</p>
<ul>
<li><a href="https://overreacted.io/react-as-a-ui-runtime/">React as a UI Runtime</a>　Dan Abramov氏によるこちらの記事は読み応えがあるので、一晩かけて読むことをお勧めします。</li>
<li><a href="https://github.com/acdlite/react-fiber-architecture">GitHub - acdlite/react-fiber-architecture</a>　Reactの新しいコアアルゴリズムであるReact Fiberについて説明した記事です。</li>
<li><a href="https://blog.xnim.me/event-loop-and-render-queue">Browser Event loop: micro and macro tasks, call stack, render queue: layout, paint, composite</a></li>
<li><a href="https://web.dev/rendering-performance/">Rendering Performance</a></li>
<li><a href="https://www.joshwcomeau.com/react/the-perils-of-rehydration/">The Perils of Rehydration</a></li>
<li><a href="https://blog.thoughtspile.tech/2021/11/15/unintentional-layout-effect/">useEffect sometimes fires before paint</a></li>
<li><a href="https://react.dev/learn/you-might-not-need-an-effect">You Might Not Need an Effect – React</a></li>
<li><a href="https://react.dev/learn/render-and-commit">Render and Commit – React</a></li>
</ul>
<p>さらに理解を深めていただくために、YouTube動画もぜひご覧ください。概念によっては、2パラグラフ分の文章よりも3秒のアニメーションの方が伝わりやすい場合もあります。</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/__tm1dyMi4A?si=5OyDZC2bnkehUXLR" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
<p>ではまた次回お会いしましょう。</p>]]></content:encoded></item><item><title><![CDATA[ReactにおけるRef：DOMへのアクセスから命令的APIまで]]></title><description><![CDATA[この記事では、ReactにおいてDOMへのアクセスが必要な理由と、その際にRefがどう役立つのかを見ていきます。また、useRef、forwardRef、useImperativeHandleという…]]></description><link>https://postd.cc/refs-from-dom-to-api/</link><guid isPermaLink="false">https://postd.cc/refs-from-dom-to-api/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><pubDate>Wed, 30 Aug 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>この記事では、ReactにおいてDOMへのアクセスが必要な理由と、その際にRefがどう役立つのかを見ていきます。また、useRef、forwardRef、useImperativeHandleという3つのフックについて説明し、これらを適切に使用する方法を紹介したいと思います。
この記事と同じ内容を扱ったYouTube動画も公開していますので、活字媒体よりも動画視聴を好まれる方はそちらをご覧ください。文字ではなく、アニメーションと音声で同じ概念を解説しています。
<a href="https://youtu.be/H9KhRiO1UeU">この記事は動画形式でも公開しています。</a></p>
<h2>目次</h2>
<ul>
<li><a href="#01">useRefを使用してReactでDOMにアクセスする</a></li>
<li><a href="#02">親から子にRefをpropとして渡す</a></li>
<li><a href="#03">forwardRefを使用して親から子にRefを渡す</a></li>
<li><a href="#04">useImperativeHandleを使用した命令型API</a></li>
<li><a href="#05">useImperativeHandleを使用しない命令型API</a></li>
</ul>
<p>Reactには素晴らしい点が多数ありますが、その1つは実際のDOMを抽象化することでその複雑性を取り除いてくれることです。手動でクエリを実行して要素を取得したり、取得した要素にどのようにしてクラスを追加するか頭を悩ませたり、ブラウザの不整合に手を焼いたりすることがなく、コンポーネントを記述するだけでよいので、ユーザーエクスペリエンスにフォーカスすることができます。しかし、極めてまれではありますが、実際のDOMにアクセスしなくてはならないケースもあります。
実際のDOMに関しては、RefとRefに関連するあらゆることを理解し、その適切な使用方法を学ぶことが何よりも重要です。したがって、今日はそもそもなぜDOMにアクセスする必要があるのか、その際にRefがどう役立つのかを説明し、<code class="language-text">useRef</code>、<code class="language-text">forwardRef</code>、<code class="language-text">useImperativeHandle</code>の特徴とその適切な使用方法について見ていきたいと思います。また、<code class="language-text">forwardRef</code>と<code class="language-text">useImperativeHandle</code>の使用を避けつつ、その恩恵を受ける方法についても詳しく話します。これらのフックの仕組みについて調べてみたことのある人なら、なぜそうすることが望ましいのかお分かりいただけるでしょう。
さらに、Reactで命令的APIを実装する方法についても紹介します。</p>
<h2>useRefを使用してReactでDOMにアクセスする <a name="01"></a></h2>
<p>自分が主催する会議の登録フォームを実装するとします。参加者に詳細を送れるように、氏名とメールアドレス、Twitter（現在は「X」に名称変更）ハンドルネームを知らせてもらう必要があり、「氏名」と「メールアドレス」の入力欄は必須項目にしたいと思っています。ただし、空欄のまま送信ボタンが押されても、ただ赤枠を表示するだけでは面白くないので、空欄にフォーカスし、入力欄が揺れるようにすることで入力を促します。
Reactには多くの機能が備わっていますが、必要なものが全てそろっているわけではありません。例えば、「手動で要素にフォーカスする」といった機能は提供されていません。したがって、この機能を実装するにはJavaScriptのネイティブAPIを利用しなくてはならず、そのためには実際のDOM要素にアクセスする必要があります。
Reactが存在しない世界では、まず次のような処理を実行します。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"bla"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>次に、要素にフォーカスします。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>もしくは、その要素までスクロールします。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">element<span class="token punctuation">.</span><span class="token function">scrollIntoView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>他にもやり方はあるでしょう。Reactの世界でネイティブのDOM APIを使用する場合、以下のようなユースケースが一般的です。</p>
<ul>
<li>フォームの入力欄のように、要素をレンダリングした後、手動で<strong>要素にフォーカスする</strong></li>
<li>ポップアップのような要素を表示する際、<strong>コンポーネントの外のクリック</strong>を検知する</li>
<li>画面上に要素が表示された後、手動で<strong>要素までスクロールする</strong></li>
<li>ツールチップのようなものを正しい位置に表示するために、コンポーネントの<strong>サイズと境界を計算する</strong></li>
</ul>
<p>厳密には、今でも<code class="language-text">getElementById</code>メソッドを使おうと思えば使えますが、Reactではより強力な方法で指定要素にアクセスすることができます。その方法を使えば、至るところにIDを設定する必要がなく、DOMの基本構造を意識する必要もありません。その方法というのが<a href="https://react.dev/reference/react/useRef#manipulating-the-dom-with-a-ref">Ref</a>です。
Refは単なるミュータブルなオブジェクトであり、Refへの参照は再レンダリングをまたいでReactが保持します。Refは再レンダリングをトリガーしないため、ステートの代わりにはなりません。したがって、ステートをRefで代用しようとするのは避けてください。両者の違いに関する詳細は、<a href="https://react.dev/learn/referencing-values-with-refs#differences-between-refs-and-state">ドキュメントをご覧ください</a>。
Refは、<code class="language-text">useRef</code>フックを使用して作成します。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// create a ref with default value null</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Refに格納された値は、currentという（唯一の）プロパティの中にあります。この中には何でも格納できます。例えば、ステートから取得した値をオブジェクトに格納することもできます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// re-write ref's default value with new object</span>
    ref<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">someFunc</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      someValue<span class="token operator">:</span> stateValue<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>stateValue<span class="token punctuation">]</span><span class="token punctuation">)</span>




  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>あるいは、ここでお話しするユースケースにとってより重要な例を挙げると、Refは任意のDOM要素と一部のReactコンポーネントに代入できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// assign ref to an input element</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">useEffect</code>（コンポーネントがレンダリングされた後のみ利用可能）の中で<code class="language-text">ref.current</code>をログ出力すると、その入力に対して<code class="language-text">getElementById</code>を実行した場合と全く同じ要素が得られます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// this will be a reference to input DOM element!</span>
    <span class="token comment">// exactly the same as if I did getElementById for it</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>そして、登録フォームを1つの巨大なコンポーネントとして実装するならば、次のような処理を実行できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">const</span> <span class="token function-variable function">onSubmitClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// focus the input field if someone tries to submit empty name</span>
      ref<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// submit the data here!</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setName</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSubmitClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Submit the form!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>入力された値をステートに保存し、全ての入力に対してRefを作成し、「送信」ボタンがクリックされたら値が空ではないか確認し、空であれば必要な入力欄にフォーカスします。
このフォームの実装をCodeSandboxで公開していますのでご覧ください。</p>
<iframe src="https://codesandbox.io/embed/giant-form-ref-example-23z9vf?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="giant-form-ref-example"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<h2>親から子にRefをpropとして渡す <a name="02"></a></h2>
<p>もちろん、実際に全てを1つの巨大なコンポーネントとして実装することはありません。どちらかといえば、入力は複数のフォームで再利用し、独自のスタイルをカプセル化して制御できるよう、固有のコンポーネントに抽出したいと思います。そうすることで、上部にラベルを表示したり、右側にアイコンを表示したりといった機能を追加することもできます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onChange<span class="token punctuation">,</span> label <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span>label<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>
しかし、エラーハンドリングと送信機能はinputではなく、依然としてFormの中にあります。
<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">const</span> <span class="token function-variable function">onSubmitClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// deal with empty name</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// submit the data here!</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setName<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSubmitClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Submit the form!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>入力に対し、<code class="language-text">Form</code>のコンポーネントから「自らにフォーカスする」ように指示するにはどうすればよいでしょうか。通常、Reactにおいてデータと挙動を制御するには、コンポーネントにpropを渡し、コールバックを監視します。「focusItself」というpropを<code class="language-text">InputField</code>に渡し、これを<code class="language-text">false</code>から<code class="language-text">true</code>に切り替えることもできますが、これがうまくいくのは1回だけです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// don't do this! just to demonstate how it could work in theory</span>
<span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onChange<span class="token punctuation">,</span> focusItself <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>focusItself<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// focus input if the focusItself prop changes</span>
      <span class="token comment">// will work only once, when false changes to true</span>
      ref<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>focusItself<span class="token punctuation">]</span><span class="token punctuation">)</span>


  <span class="token comment">// the rest is the same here</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>「onBlur」というコールバックを追加して、入力がフォーカスを失ったら<code class="language-text">focusItself</code>propをリセットして<code class="language-text">false</code>に戻したり、ブール値の代わりに乱数値に変更したりすることもできます。あるいは、その他の工夫を考案することもできるかもしれません。</p>
<p>おそらく、他にもやり方はあるでしょう。propをいじるのではなく、単にあるコンポーネント（<code class="language-text">Form</code>）の中にRefを作成し、これを別のコンポーネント（<code class="language-text">InputField</code>）に渡して、そこで基本構造のDOM要素に接続することもできるでしょう。結局のところ、Refはただのミュータブルなオブジェクトなので。</p>
<p>次に、<code class="language-text">Form</code>が今までと同じくRefを作成します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// create the Ref in Form component</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">InputField</code>コンポーネントには、今までと同じくRefを受け取るためのpropと<code class="language-text">input</code>フィールドがあります。違うのは、Refが<code class="language-text">InputField</code>の中で作成されるのではなく、propから渡されるということです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> inputRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// the rest of the code is the same</span>


  <span class="token comment">// pass ref from prop to the internal input component</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Refはミュータブルなオブジェクトであり、そのように設計されています。Refを要素に渡すと、その下にあるReactがRefに変更を加えます。そして、変更されるオブジェクトは<code class="language-text">Form</code>コンポーネントの中で宣言されます。したがって、<code class="language-text">InputField</code>がレンダリングされると、Refオブジェクトはすぐに変更され、<code class="language-text">Form</code>は<code class="language-text">inputRef.current</code>内の<code class="language-text">input</code> DOM要素にアクセスすることができます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// create the Ref in Form component</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// the "input" element, that is rendered inside InputField, will be here</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>inputRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* Pass ref as prop to the input field component */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">inputRef</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>あるいは、submitコールバックの中で、前と全く同じコードであるinputRef.current.focus()を呼び出すことができます。
こちらの例をご覧ください。</p>
<iframe src="https://codesandbox.io/embed/example2-pass-ref-as-prop-5i03u9?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="example2: pass ref as prop"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<h2>forwardRefを使用して親から子にRefを渡す <a name="03"></a></h2>
<p>propの名前を単に<code class="language-text">ref</code>ではなく、<code class="language-text">inputRef</code>としたのはなぜだろうと不思議に思う人もいるかもしれませんが、実際はそれほど単純なことではありません。<code class="language-text">ref</code>は実際にはpropではなく、予約語のようなものです。昔、まだクラスコンポーネントを記述していた頃は、Refをクラスコンポーネントに渡すと、このコンポーネントのインスタンスはそのRefの<code class="language-text">.current</code>値になっていました。
しかし、関数コンポーネントにインスタンスはないため、コンソール上に次のような警告が表示されます。「Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use React.forwardRef()?」</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// if we just do this, we'll get a warning in console</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これが機能するためには、Reactにこの<code class="language-text">ref</code>が実際に意図したものであり、これを使ってやりたいことがあると伝える必要があります。それには、<code class="language-text">forwardRef</code>関数の助けを借ります。この関数は、コンポーネントを受け入れ、コンポーネントの関数の第2引数として<code class="language-text">ref</code>属性からRefを挿入します。挿入位置はpropのすぐ後ろです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// normally, we'd have only props there</span>
<span class="token comment">// but we wrapped the component's function with forwardRef</span>
<span class="token comment">// which injects the second argument - ref</span>
<span class="token comment">// if it's passed to this component by its consumer</span>
<span class="token keyword">const</span> InputField <span class="token operator">=</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// the rest of the code is the same</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>上のコードを2つの変数に分けることで、可読性を向上させることもできます。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">InputFieldWithRef</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// the rest is the same</span>
<span class="token punctuation">}</span>

<span class="token comment">// this one will be used by the form</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> InputField <span class="token operator">=</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span>InputFieldWithRef<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで、<code class="language-text">Form</code>は通常のDOM要素と同様にRefをInputFieldコンポーネントに渡すことができます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p><code class="language-text">forwardRef</code>を使用するか、Refをpropとして渡すかは、単なる好みの問題であり、最終結果は同じです。
こちらの実例をご覧ください。</p>
<iframe src="https://codesandbox.io/embed/example3-pass-ref-with-forwardref-eg30h5?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="example3: pass ref with forwardRef"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<h2>useImperativeHandleを使用した命令的API <a name="04"></a></h2>
<p><code class="language-text">Form</code>コンポーネントから入力欄にフォーカスする方法については大体お分かりいただけたかと思いますが、目指しているフォームはまだ完成ではありません。エラーが発生した場合、フォーカスするだけでなく入力欄が揺れるようにしたいとお話ししたと思います。JavaScriptのネイティブAPIに<code class="language-text">element.shake()</code>のようなものはありませんので、ここではDOM要素にアクセスしても役に立ちません。
しかし、CSSアニメーションとして簡単にこの機能を実装できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// store whether we should shake or not in state</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shouldShake<span class="token punctuation">,</span> setShouldShake<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// just add the classname when it's time to shake it - css will handle it</span>
  <span class="token keyword">const</span> className <span class="token operator">=</span> shouldShake <span class="token operator">?</span> <span class="token string">"shake-animation"</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>


  <span class="token comment">// when animation is done - transition state back to false, so we can start again if needed</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span> <span class="token attr-name">onAnimationEnd</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setShouldShake</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>では、アニメーションをトリガーするにはどうすればよいでしょうか。この場合も、フォーカスのときと要領は同じです。propを使って何かしら工夫を考案することはできるかもしれませんが、見た目が不自然であるだけでなく、かなり複雑なフォームになってしまいます。特に、Refを使用してフォーカスを実現していることを考えると、全く同じ問題に対して2つのソリューションを用いることになります。<code class="language-text">InputField.shake()</code>と<code class="language-text">InputField.focus()</code>のようなことができたら良いのですが。
フォーカスについて言うと、これをトリガーするために<code class="language-text">Form</code>コンポーネントがいまだにネイティブのDOM APIに頼る必要があるのはなぜでしょうか。こうした複雑性を抽象化によって取り除くのが、<code class="language-text">InputField</code>のそもそもの目的であり、担うべき役割ではないのでしょうか。フォームが基本構造のDOM要素にアクセスできるのもおかしな話です。これによって、実装に関する内部の詳細が漏れてしまいます。どのDOM要素を使用しているのか、そもそもDOM要素を使用しているのか、あるいは別のものを使用しているのかは、<code class="language-text">Form</code>コンポーネントの関心事であるべきではないのです。関心の分離の原則があるので。
<code class="language-text">InputField</code>コンポーネントに適切な命令的APIを実装するべきときが来たようです。現状、Reactは宣言的であり、それに従ってコードを記述することが求められています。しかし、命令によって何かをトリガーする方法が必要なこともあります。Reactには、そのようなときのためのescape hatchが用意されています。それが<a href="https://react.dev/reference/react/useImperativeHandle">useImperativeHandle</a>フックです。
このフックは理解するのが少し難しく、筆者もドキュメントを2回読み、何度か自分で試し、実際のReactコードに実装してみてようやくその仕組みを理解できました。しかし必要なものは、基本的に命令的APIの形を決めることと、それを接続するRefの2つだけです。入力はシンプルです。<code class="language-text">.focus()</code>と<code class="language-text">.shake()</code>の関数がAPIとして必要なだけであり、Refについてはすでに分かっています。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// this is how our API could look like</span>
<span class="token keyword">const</span> InputFieldAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// do the focus here magic</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// trigger shake here</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この<code class="language-text">useImperativeHandle</code>フックは、このオブジェクトをRefオブジェクトのcurrentプロパティに接続するだけです。その方法は以下の通りです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>


  <span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>someRef<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>第1引数はRefであり、コンポーネント自体の中で作成されるか、propから、もしくはforwardRefを通して渡されます。第2引数はオブジェクトを返す関数であり、このオブジェクトは<code class="language-text">inputRef.current</code>として利用できます。第3引数は依存配列であり、他のReactフックと同様です。
ここでのコンポーネントには、Refを<code class="language-text">apiRef</code> propとして明示的に渡します。後は、実際のAPIを実装するだけです。そのためには別のRefが必要になります。こちらは<code class="language-text">InputField</code>内のRefであり、通常通り<code class="language-text">input</code> DOM要素に接続してフォーカスをトリガーできます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// pass the Ref that we'll use as our imperative API as a prop</span>
<span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> apiRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// create another ref - internal to Input component</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// "merge" our API into the apiRef</span>
  <span class="token comment">// the returned object will be available for use as apiRef.current</span>
  <span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>apiRef<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// just trigger focus on internal ref that is attached to the DOM object</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>「揺れる」動きについては、ステートの更新をトリガーします。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// pass the Ref that we'll use as our imperative API as a prop</span>
<span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> apiRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// remember our state for shaking?</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shouldShake<span class="token punctuation">,</span> setShouldShake<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>apiRef<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// trigger state update here</span>
      <span class="token function">setShouldShake</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで、Formはrefを作成し、InputFieldに渡し、内部の実装について心配することなく、簡単なinputRef.current.focus()とinputRef.current.shake()を実行できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">const</span> <span class="token function-variable function">onSubmitClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// focus the input if the name is empty</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// and shake it off!</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">shake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// submit the data here!</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setName<span class="token punctuation">}</span></span> <span class="token attr-name">apiRef</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSubmitClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Submit the form!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>完全に機能するフォームのサンプルを実際に使ってみてください。</p>
<h2>useImperativeHandleを使用しない命令的API <a name="05"></a></h2>
<p><code class="language-text">useImperativeHandle</code>フックは目がけいれんを起こしそうだという人もいるかもしれません。実は、私もその1人です。今お話しした機能は、このフックを実際に使わなくても実装できます。Refの仕組みと、Refが変更可能であることはすでに分かっています。したがって、必要なRefの<code class="language-text">ref.current</code>にAPIオブジェクトを代入するだけでいいのです。以下に例を挙げます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> apiRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    apiRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>apiRef<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これは、<code class="language-text">useImperativeHandle</code>がバックグラウンドで実行する処理とほぼ同じです。実際の動作は以前と全く同じです。
実際には、<code class="language-text">useLayoutEffect</code>の方がもっと良いかもしれませんが、これについてはまた別の記事でお話ししたいと思います。今回は、従来通り<code class="language-text">useEffect</code>を使用します。
最後の例をご覧ください。</p>
<iframe src="https://codesandbox.io/embed/example5-imperative-api-without-useimperativehandle-yjyxd0?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="example5: imperative api without useImperativeHandle"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<p>揺れる動作が実装されたすてきなフォームの完成です。ReactにおけるRefの謎は解明され、命令的APIも使えるようになりました。実に素晴らしい。
次の点を覚えておいてください。Refはいわば「escape hatch」のようなもので、propやコールバックを使用したReactの通常のデータフローやステートの代わりになるものではありません。「通常の」代替策がない場合のみ使用してください。命令的に何かをトリガーするのも同様です。どちらかといえば、propやコールバックを使用した通常のフローの方が望ましいので。
さらに理解を深めていただくために、YouTube動画もぜひご覧ください。概念によっては、2段落分の文章よりも3秒のアニメーションの方が伝わりやすい場合もあります。</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/H9KhRiO1UeU?si=o5H0wzWfvB2Riyy3" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>]]></content:encoded></item><item><title><![CDATA[フロントエンドパフォーマンスのチェックリスト2021年版（PDF、Apple Pages、MS Word）-後編]]></title><description><![CDATA[目次＃ 前編 準備段階：計画と指標
パフォーマンスを重視する文化、Core Web Vitals、パフォーマンスのプロファイル、CrUX、Lighthouse、FID、TTI、CLS、端末。 現実的…]]></description><link>https://postd.cc/front-end-performance-2021-checklist-3/</link><guid isPermaLink="false">https://postd.cc/front-end-performance-2021-checklist-3/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[パフォーマンス]]></category><pubDate>Mon, 24 Jul 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<h2>目次<a href="#00">＃</a></h2>
<p><strong>前編</strong></p>
<ul>
<li><a href="/front-end-performance-2021-checklist-1/#01">準備段階：計画と指標</a><br>
パフォーマンスを重視する文化、Core Web Vitals、パフォーマンスのプロファイル、CrUX、Lighthouse、FID、TTI、CLS、端末。</li>
<li><a href="/front-end-performance-2021-checklist-1/#02">現実的な目標の設定</a><br>
パフォーマンスバジェット、パフォーマンス目標、RAILフレームワーク、170KB/30KBバジェット。</li>
<li><a href="/front-end-performance-2021-checklist-1/#03">環境の定義</a><br>
フレームワークの選択、パフォーマンスコストの基準設定、Webpack、依存関係、CDN、フロントエンドアーキテクチャ、CSR、SSR、CSR + SSR、静的レンダリング、プリレンダリング、PRPLパターン。</li>
</ul>
<p><strong>中編</strong></p>
<ul>
<li><a href="/front-end-performance-2021-checklist-2/#04">アセットの最適化</a><br>
Brotli、AVIF、WebP、レスポンシブ画像、AV1、アダプティブメディア読み込み、動画圧縮、Webフォント、Googleフォント。</li>
<li><a href="/front-end-performance-2021-checklist-2/#05">ビルドの最適化</a><br>
JavaScriptモジュール、モジュール/ノーモジュールのパターン、ツリーシェイキング、コード分割、スコープホイスティング、Webpack、デファレンシャルサービング、Webワーカー、WebAssembly、JavaScriptバンドル、React、SPA、パーシャルハイドレーション、インポート・オン・インタラクション、サードパーティ、キャッシュ</li>
</ul>
<p><strong>後編</strong></p>
<ul>
<li><a href="#06">デリバリの最適化</a><br>
遅延読み込み、インターセクションオブザーバー、遅延レンダリングとデコーディング、クリティカルCSS、ストリーミング、リソースヒント、レイアウトシフト、サービスワーカー。</li>
<li><a href="#07">ネットワーク接続、HTTP/2、HTTP/3</a><br>
OCSPステープリング、EV/DV証明書、パッケージング、IPv6、QUIC、HTTP/3。</li>
<li><a href="#08">テストとモニタリング</a><br>
監査ワークフロー、プロキシブラウザ、404ページ、GDPRに基づくcookie同意プロンプト、パフォーマンス診断CSS、アクセシビリティ。</li>
<li><a href="#09">手軽に成果を上げる</a><br></li>
<li><a href="#10">チェックリストのダウンロード（PDF、Apple Pages、MS Word）</a><br></li>
<li><a href="#11">さあ、始めよう！</a><br></li>
</ul>
<p>（<a href="https://www.dropbox.com/s/34noajrbm324iai/performance-checklist-1.4.pdf?dl=0">チェックリストのPDFファイル</a>（166KB）、<a href="https://www.dropbox.com/s/ikuk5ikcxxv39uu/performance-checklist-1.4.pages?dl=0">編集可能なApple Pagesファイル</a>（275KB）、<a href="https://www.dropbox.com/scl/fi/s7ctdj89zd5zlvtt7dkhi/performance-checklist-1.4.docx?dl=0&#x26;rlkey=2xzs55e3kdg1jcraw5u1tnpl8">.docxファイル</a>（151KB）も自由にダウンロードできます。皆さんが最適化を楽しめますように！）</p>
<h2>デリバリの最適化 <a href="#06">#</a><a name="06"></a></h2>
<h3>45. クリティカルなJavaScriptの非同期読み込みにdeferを使用するか？</h3>
<p>ユーザがページをリクエストするとき、ブラウザはHTMLを取得し、DOMを構築し、それからCSSを取得してCSSOMを構築し、さらにDOMとCSSOMを照合することによってレンダリングツリーを生成します。JavaScriptを解決する必要がある場合、ブラウザは解読が終わるまで<code class="language-text">ページのレンダリングを開始しない</code>ため、レンダリングが遅延します。開発者はブラウザに対して、待機せずにページのレンダリングを開始するよう明確に指示する必要があります。これをスクリプト向けに実現する方法は、HTMLの<code class="language-text">defer</code>と<code class="language-text">async</code>属性を使用することです。</p>
<p>実際には、<a href="https://calendar.perfplanet.com/2016/prefer-defer-over-async/"><code class="language-text">async</code>ではなく<code class="language-text">defer</code>を使用するほう</a>が良いことが分かっています。それでは、<strong>両者の違い</strong>とは何でしょうか。<a href="https://youtu.be/RwSlubTBnew?t=1034">Steve Souders</a>によれば、<code class="language-text">async</code>スクリプトが登場すると、スクリプトは準備ができた段階ですぐに実行されます。このスクリプトがとても速く実行される場合、例えばスクリプトがキャッシュにすでに存在する場合は、実際にはスクリプトがHTMLパーサをブロックする可能性があります。<code class="language-text">defer</code>では、ブラウザはHTMLがパースされるまでスクリプトを実行しません。ですから、レンダリングの開始前にJavaScriptを実行する必要がなければ、<code class="language-text">defer</code>を使用するほうが良いでしょう。また、複数の非同期ファイルが実行される順番は確定的ではありません。</p>
<p>注目すべき点として、<a href="https://twitter.com/csswizardry/status/1346137189009264640"><code class="language-text">async</code>と<code class="language-text">defer</code>はいくつかの面で誤解されています</a>。最も重要なのは、<code class="language-text">async</code>とは、スクリプトの準備ができた時点でいつでもコードを実行するという意味ではないということです。asyncが意味するのは、スクリプトの準備ができており、なおかつ先行する同期作業が全て終了した時点で、いつでもスクリプトを実行するということです。Harry Robertsの言葉を借りれば、「<code class="language-text">async</code>スクリプトを同期スクリプトの後に設定した場合、<code class="language-text">async</code>スクリプトは、最も遅い同期スクリプトと同じ速さにしかなりません」。</p>
<p>また、<a href="https://twitter.com/csswizardry/status/1331721659498319873"><code class="language-text">async</code>と<code class="language-text">defer</code>を両方使用することは推奨されません</a>。モダンなブラウザはどちらもサポートしていますが、いずれの属性も使用されている場合、いつでも<code class="language-text">async</code>が優先されます。</p>
<p>このテーマについてもっと詳しく知りたいならば、Milica Mihajlijaが執筆した<a href="https://hacks.mozilla.org/2017/09/building-the-dom-faster-speculative-parsing-async-defer-and-preload/">Building the DOM faster</a>をご覧ください。このとても詳しいガイドは、投機的パーシング、async、deferの詳細について取り上げています。</p>
<h3>46. コストが大きいコンポーネントをインターセクションオブザーバーとプライオリティヒントで遅延読み込みする。</h3>
<p>一般に、重いJavaScript、動画、iframe、ウィジェット、場合によっては画像など、コストが大きいコンポーネントは全て遅延読み込みすることが推奨されます。画像とiframeの<a href="https://web.dev/native-lazy-loading/">ネイティブ遅延読み込み</a>は、すでに<code class="language-text">loading</code>属性によって利用可能となっています（Chromiumのみ）。この属性は、リソースがビューポートからの<a href="https://web.dev/browser-level-image-lazy-loading/#distance-from-viewport-thresholds">計算上の距離</a>に達するまで、そのリソースの読み込みを内部で遅延させます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Lazy loading for images, iframes, scripts.
Probably for images outside of the viewport. --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>

<span class="token comment">&lt;!-- Prompt an early download of an asset.For critical images, e.g. hero images. --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>eager<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>eager<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この基準となる距離は、取得される画像リソースの種類や有効な接続のタイプなど、いくつかの項目に依存します。しかし、ChromeのAndroid版を使用して行われた実験は、4G接続の場合、遅延読み込みされる画面外の画像の97.5％が<a href="https://web.dev/browser-level-image-lazy-loading/#distance-from-viewport-thresholds">表示後10ミリ秒以内に完全に読み込まれた</a>ことを示しているため、問題はないでしょう。</p>
<p>また、<code class="language-text">&lt;script&gt;</code>、<code class="language-text">&lt;img&gt;</code>、<code class="language-text">&lt;link&gt;</code>要素の<a href="https://developers.google.com/web/updates/2019/02/priority-hints#using_priority_hints">importance属性</a>（<code class="language-text">high</code>または<code class="language-text">low</code>）を使用することもできます（Blinkのみ）。実際、これはカルーセルの<strong>画像の優先順位を下げたり</strong>、スクリプトの優先順位をつけ直したりするための優れた手段となります。しかし、場合によっては、もっときめ細かいコントロールが必要になるでしょう。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!--
When the browser assigns "High" priority to an image,
but we don’t actually want that.
--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>less-important-image.svg<span class="token punctuation">"</span></span> <span class="token attr-name">importance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>low<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>

<span class="token comment">&lt;!--
We want to initiate an early fetch for a resource,
but also deprioritize it.
--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">importance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>low<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/script.js<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>もう少し洗練された遅延読み込みの方法のなかで、最もパフォーマンスが高いのは、<a href="https://www.telerik.com/blogs/intersection-observer-api-makes-lazy-loading-a-snap">インターセクションオブザーバーAPIを使用する</a>ことです。このAPIは、ターゲットとする要素と、その祖先要素または最上位ドキュメントのビューポートとの交差点における<strong>変化を非同期的に監視する</strong>方法を提供します。基本的に、新しい<code class="language-text">IntersectionObserver</code>オブジェクトを作成する必要があり、それがコールバック関数と一連のオプションを受け取ります。その後、観測対象のターゲットを追加します。</p>
<p>コールバック関数は、<strong>ターゲットが表示される</strong>ときか非表示となるときに実行されます。そのため、関数がビューポートに割り込むときに、要素が表示される前に何らかの行動を開始することができます。実際、<code class="language-text">rootMargin</code>（ルート周辺の余白）と<code class="language-text">threshold</code>（目標とするターゲットの表示割合を示す数字やその範囲）を使用することで、オブザーバのコールバックをいつ呼び出すかを細かくコントロールすることが可能です。</p>
<p>Alejandro Garcia Angladaは、インターセクションオブザーバーを実際に導入する方法に関する<a href="https://medium.com/%40aganglada/intersection-observer-in-action-efc118062366">便利なチュートリアル</a>を公表しています。Rahul Nanwaniは、<a href="https://css-tricks.com/the-complete-guide-to-lazy-loading-images/">前景と背景の画像の遅延読み込み</a>に関して詳しい記事を執筆しています。Google Fundamentalsも、<a href="https://developers.google.com/web/fundamentals/performance/lazy-loading-guidance/images-and-video/">インターセクションオブザーバーによる画像と動画の遅延読み込みに関する詳細なチュートリアル</a>を提供しています。</p>
<p>皆さんはアート主体のストーリーテリングを覚えているでしょうか。この形式のストーリーテリングは長大で、オブジェクトは移動するものもあれば、固定されているものもあります。<a href="https://github.com/russellgoldenberg/scrollama">インターセクションオブザーバーでは、高パフォーマンスのスクローリーテリング（スクロールと連動したストーリーテリング）</a>を実装することもできます。</p>
<p>他にも遅延読み込みが可能なものはないか、再度チェックしましょう。<strong>翻訳文字列や絵文字の遅延読み込み</strong>も助けになるかもしれません。Mobile Twitterは、これによって、新たなインターナショナリゼーションパイプラインのJavaScript実行時間を80％高速化しました。</p>
<p>ただし、注意すべき点もあります。<a href="https://twitter.com/csswizardry/status/1326504788360638466">遅延読み込みは、原則というよりは例外であるべき</a>です。実際にはすぐに表示したいものを遅延読み込みするのは、おそらく<a href="https://twitter.com/tunetheweb/status/1346556743308992512?s=20">合理的ではない</a>でしょう。例えば、製品ページの画像、ヒーロー画像、メインナビゲーションをインタラクティブにするために必要なスクリプトなどが挙げられます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a9620dcb-d5c1-449f-872a-552130a1ecd6/old-new-better-thresholds.png">
距離の基準値は最近、高速な接続（4Gなど）では3000pxから1250pxに、低速な接続（3Gなど）では4000pxから2500pxに縮小しました。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a9620dcb-d5c1-449f-872a-552130a1ecd6/old-new-better-thresholds.png">プレビューを拡大</a>）</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d4d6866d-7897-48bd-bc0c-c62a108e3c48/01-internationalization-front-end-performance-checklist-2020.png">
翻訳文字列の遅延読み込みによって、Mobile Twitterは新たなインターナショナリゼーションパイプラインのJavaScript実行時間を80％高速化しました。（画像の出典：<a href="https://twitter.com/addyosmani">Addy Osmani</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d4d6866d-7897-48bd-bc0c-c62a108e3c48/01-internationalization-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</p>
<h3>47. 画像を段階的に読み込む。</h3>
<p><a href="https://calendar.perfplanet.com/2017/progressive-image-loading-using-intersection-observer-and-sqip/">画像の段階的な読み込み</a>をページに追加することで、遅延読み込みをさらに一段上のレベルに引き上げられるかもしれません。Facebook、Pinterest、Medium、Woltと同様に、最初は低品質な画像やぼやけた画像を読み込み、ページの読み込みが進むにつれて、<a href="https://blurha.sh/">BlurHashテクニック</a>や<a href="https://www.guypo.com/introducing-lqip-low-quality-image-placeholders">LQIP（Low Quality Image Placeholders）テクニック</a>を使用して当初の画像を完全な品質のバージョンに置き換えることができます。</p>
<p>こうしたテクニックがユーザ体験を改善するかどうかについての意見はさまざまですが、First Contentful Paintを改善するのは間違いありません。また、SVGプレースホルダとして画像の低品質バージョンを作成する<a href="https://github.com/technopagan/sqip">SQIP</a>や、CSS線形勾配を持つ<a href="https://calendar.perfplanet.com/2018/gradient-image-placeholders/">Gradient Image Placeholders</a>の使用によって、上記を自動化することも可能です。</p>
<p>これらのプレースホルダは、テキストと同様の圧縮方法によって自然と十分に圧縮されるため、HTMLに埋め込むことができます。Dean Humeの記事では、このテクニックをインターセクションオブザーバーによって実装する方法が<a href="https://calendar.perfplanet.com/2017/progressive-image-loading-using-intersection-observer-and-sqip/">解説</a>されています。</p>
<p>フォールバックはどうすべきでしょうか。ブラウザがインターセクションオブザーバーをサポートしていない場合でも、<a href="https://github.com/jeremenichelli/intersection-observer-polyfill">ポリフィル</a>を<a href="https://medium.com/%40aganglada/intersection-observer-in-action-efc118062366">遅延読み込み</a>したり、画像を即座に読み込んだりすることができます。そのための<a href="https://github.com/ApoorvSaxena/lozad.js">ライブラリ</a>もあります。</p>
<p>もっとしゃれたテクニックが好きな方には、こんな方法もあります。<a href="https://jmperezperez.com/svg-placeholders/">画像をトレース</a>し、単純な図形と線を使用して軽いSVGプレースホルダを作成し、それを最初に読み込んだ後、プレースホルダのベクター画像から（読み込み済みの）ビットマップ画像に移行するのです。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f7f56052-6abb-4d18-a5aa-8d84102d812e/jmperez-composition-primitive-full.jpg">
<a href="https://jmperezperez.com/svg-placeholders/">José M. Pérez</a>によるSVG遅延読み込みのテクニック。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f7f56052-6abb-4d18-a5aa-8d84102d812e/jmperez-composition-primitive-full.jpg">プレビューを拡大</a>）</p>
<h3>48. <code class="language-text">content-visibility</code>でレンダリングを遅延させているか？</h3>
<p>大量のコンテンツブロック、画像、動画が含まれる複雑なレイアウトでは、データのデコードとピクセルのレンダリングはコストがとても大きい作業であるかもしれません。特にローエンドの端末ではなおさらです。<a href="https://web.dev/content-visibility/"><code class="language-text">content-visibility: auto</code></a>を使用すると、コンテナがビューポートの外にある間は、ブラウザに子のレイアウトをスキップさせることができます。</p>
<p>例えば、最初の読み込みでは、フッタや後半のセクションのレンダリングはスキップしたほうが良いかもしれません。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">footer</span> <span class="token punctuation">{</span>
  <span class="token property">content-visibility</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
  <span class="token property">contain-intrinsic-size</span><span class="token punctuation">:</span> 1000px<span class="token punctuation">;</span>
  <span class="token comment">/* 1000px is an estimated height for sections that are not rendered yet. */</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://www.terluinwebdesign.nl/en/css/calculating-contain-intrinsic-size-for-content-visibility/"><code class="language-text">content-visibility: auto;の挙動はoverflow: hidden;と似ています</code></a>が、デフォルトの<code class="language-text">margin-left: auto;</code>、<code class="language-text">margin-right: auto;</code>、widthの宣言の代わりに<code class="language-text">padding-left</code>と<code class="language-text">padding-right</code>を適用すれば修正できます。パディングは基本的に、要素がコンテンツボックスからあふれても、全体がボックスモデルの外に出たり、切り取られたりすることなく、パディングボックスに入るようにすることを可能にします。</p>
<p>新たなコンテンツが最終的にレンダリングされたときは、一定のCumulative Layout Shift（CLS）が発生している可能性に注意しましょう。ですから、 <a href="https://twitter.com/Una/status/1291012585807110144">適切なサイズのプレースホルダ</a>と<code class="language-text">contain-intrinsic-size</code>を使用するのは良いアイデアと言えます（Unaに感謝します）。</p>
<p>Thijs Terluinは、<a href="https://www.terluinwebdesign.nl/en/css/calculating-contain-intrinsic-size-for-content-visibility/">上記の2つのプロパティに関するはるかに詳しい内容</a>や、<code class="language-text">contain-intrinsic-size</code>がブラウザによってどのように計算されるかに関する記事を公表しています。Malte Ublは、<a href="https://www.industrialempathy.com/posts/image-optimizations/">読者の方にも可能な計算方法</a>を解説しています。JakeとSurmaによる短い解説動画では<a href="https://www.youtube.com/watch?v=FFA-v-CIxJQ">プロパティの仕組みを説明</a>しています。</p>
<p>もう少し細かい対応が必要なら、<a href="https://developers.google.com/web/updates/2016/06/css-containment">CSS Containment</a>を利用しましょう。これにより、他の要素のサイズ、位置調整や計算済みのスタイルのみが必要である場合、あるいは要素が現在オフキャンバスである場合に、DOMノードの子孫のレイアウト、スタイル、描画作業を手動でスキップできます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/640ed03b-3b1d-40be-84a8-6000698397aa/baseline-chunks-content-visibility-auto.jpg">
デモでは、チャンク化したコンテンツエリアに<code class="language-text">content-visibility: auto</code>を適用することで、最初の読み込みのレンダリングのパフォーマンスが7倍改善されています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/640ed03b-3b1d-40be-84a8-6000698397aa/baseline-chunks-content-visibility-auto.jpg">プレビューを拡大</a>）</p>
<h3>49. decoding="async"でデコードを遅延させているか？</h3>
<p>コンテンツが画面外で表示されていても、顧客が必要なときは利用できるようにしたい場合もあります。クリティカルパス上のどんなものもブロックせず、非同期でデコードやレンダリングが行われるのが理想です。<a href="https://html.spec.whatwg.org/multipage/images.html#decoding-images"><code class="language-text">decoding=&quot;async&quot;</code></a>を使用すれば、ブラウザが画像をメインスレッド外でデコードする許可を与えることができます。これにより、画像のデコードによるCPU使用時間に関して、ユーザへの影響を回避することが可能です（<a href="https://www.industrialempathy.com/posts/image-optimizations/">Malte Ubl</a>より）。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">&lt;img decoding=&quot;async&quot; … /&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>別の選択肢として、画面外の画像については、最初にプレースホルダを表示し、その画像がビューポート内に表示されたときに、インターセクションオブザーバーを使用して画像がバックグラウンドでダウンロードされるようにネットワーク呼び出しをトリガーするという方法もあります。また、<a href="https://youtu.be/YJGCZCaIZkQ?t=570">img.decode()によってデコードまでレンダリングを遅延させる</a>ことや、<a href="https://medium.com/dailyjs/image-loading-with-image-decode-b03652e7d2d2">Image Decode API</a>が利用できない場合は画像をダウンロードすることが可能です。</p>
<p>画像をレンダリングするときは、例えばフェードインアニメーションを使用することができます。Katie HempeniusとAddy Osmaniは、<a href="https://youtu.be/YJGCZCaIZkQ?t=436">Speed at Scale: Web Performance Tips and Tricks from the Trenches</a>という講演で、さらなる知見を共有しています。</p>
<h3>50. クリティカルCSSを生成・提供しているか？</h3>
<p>ブラウザに可能な限り早くページのレンダリングを開始させるには、ページの最初に表示される部分のレンダリング開始に必要な全てのCSS（通称「クリティカルCSS」や「アバブ・ザ・フォールドCSS」）を収集し、それをページの<code class="language-text">&lt;head&gt;</code>内に埋め込むことにより、ラウンドトリップを減らすのが<a href="https://www.smashingmagazine.com/2015/08/understanding-critical-css/">一般的な方法</a>となっています。スロースタートフェーズではやり取りできるパッケージの容量が限られているため、クリティカルCSSのバジェットは約14KBとなります。</p>
<p>それ以上の容量を求めるなら、ブラウザが取得するスタイルを増やすための追加的なラウンドトリップが必要です。<a href="https://github.com/filamentgroup/criticalCSS">CriticalCSS</a>と<a href="https://github.com/addyosmani/critical">Critical</a>は、使用するあらゆるテンプレートのクリティカルCSSの出力を可能にします。しかし、私たちの経験では、過去のどんな自動システムも、全てのテンプレートのクリティカルCSSを手作業で収集することに負けています。実際、私たちは最近、手作業によるアプローチに回帰しました。</p>
<p>収集後は<a href="https://github.com/GoogleChromeLabs/critters">Webpackプラグインのcritters</a>を使用して、クリティカルCSSを埋め込み、残りを遅延読み込みします。可能であれば、Filament Groupが採用している<a href="https://www.filamentgroup.com/lab/modernizing-delivery.html">条件付きの埋め込みアプローチ</a>の使用を検討しましょう。あるいは、<a href="https://www.smashingmagazine.com/2018/11/pitfalls-automatically-inlined-code/">埋め込みコードを静的アセットにオンザフライで変換</a>しましょう。</p>
<p><a href="https://github.com/filamentgroup/loadCSS">loadCSS</a>などのライブラリで<strong>CSS全体を非同期で読み込む</strong>ことは、実際には必要ありません。<code class="language-text">media=&quot;print&quot;</code>を使用することで、<a href="https://www.filamentgroup.com/lab/load-css-simpler/">ブラウザをだましてCSSを非同期で取得</a>させつつ、読み込み後のCSSを画面環境に適用することができます（Scottに感謝します）。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Via Scott Jehl. https://www.filamentgroup.com/lab/load-css-simpler/ --></span>
<span class="token comment">&lt;!-- Load CSS asynchronously, with low priority --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>full.css<span class="token punctuation">"</span></span>
  <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>print<span class="token punctuation">"</span></span>
  <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>this.media=<span class="token punctuation">'</span>all<span class="token punctuation">'</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>各テンプレートの全てのクリティカルCSSを収集するときは、「アバブ・ザ・フォールド」（スクロールしなくても見える範囲）のみを探索するのが一般的です。しかし、複雑なレイアウトでは、レイアウトの土台の部分を探索に含めるのが良いかもしれません。また、Core Web Vitalsスコアが低下しないように、<strong>膨大な再計算と再描画のコストを回避する</strong>のも賢明でしょう。</p>
<p>ユーザがページの中ほどに直接リンクするURLを取得したが、CSSがまだダウンロードされていなかった場合はどうなるでしょうか。この場合、例えば埋め込みCSSでは<code class="language-text">opacity:0;</code>、完全なCSSファイルでは<code class="language-text">opacity:1</code>を使用して、クリティカルではないコンテンツを隠し、CSSが利用可能になった時点で表示するのが一般的です。しかし、この方法の<strong>大きなデメリット</strong>として、接続が遅いユーザはページのコンテンツをまったく読めない可能性があります。そのため、たとえ適切なスタイルではないとしても、コンテンツを常に表示し続けるほうが良いと言えます。</p>
<p>クリティカルCSS（と<a href="https://csswizardry.com/2019/05/self-host-your-static-assets/">他の重要なアセット</a>）をルートドメインの別個のファイルに設定することには、場合によっては埋め込みよりも、キャッシングの面で<a href="https://www.jonathanklein.net/2014/02/revisiting-cookieless-domain.html">メリットがあります</a>。Chromeはページをリクエストするときにルートドメインへの第2のHTTP接続を投機的に開くので、このCSSを取得するためのTCP接続の必要がなくなります。これは、一連のクリティカルCSSファイル（critical-homepage.css、critical-product-page.cssなど）を作成し、それを埋め込むことなくルートから提供できることを意味します（Philipに感謝します）。</p>
<p>注意すべき点もあります。HTTP/2では、クリティカルCSSは個別のCSSファイルに保存され、HTMLを膨張させることなくサーバプッシュ経由で提供できます。問題は、サーバプッシュには多くの落とし穴と複数のブラウザの競合条件があり、厄介だということです。サーバプッシュが一貫してサポートされていたことはなく、キャッシングに関する問題もありました（Hooman Beheshtiのプレゼンテーションのスライド114以降を参照）。</p>
<p>サーバプッシュの影響は、実際にはマイナスとなり、ネットワークのバッファが膨張することでドキュメントの真のフレームの提供が妨げられる可能性があったのです。ですから、Chromeがここ最近、<a href="https://www.filamentgroup.com/lab/modernizing-delivery.html">サーバプッシュ</a>をサポート対象から除外することを計画しているのは、あまり驚きではありませんでした。</p>
<h3>51. CSSルールの再グループ化を試す。</h3>
<p>私たちはクリティカルCSSに慣れ親しんでいますが、それを超える可能性がある最適化も存在します。Harry Robertsが実施した<a href="https://csswizardry.com/2018/11/css-and-network-performance/">素晴らしい調査</a>は、とても驚くべき結果を明らかにしました。例えば、<strong>メインCSSファイルを個別のメディアクエリに分割する</strong>のは良いアイデアかもしれません。これにより、ブラウザは優先順位の高いクリティカルCSSを取得し、それ以外の優先順位が低いものは全てクリティカルパスから完全に除外されます。</p>
<p>また、<code class="language-text">async</code>スニペットの前に<code class="language-text">&lt;link rel=&quot;stylesheet&quot; /&gt;</code>を設置しないようにしましょう。スクリプトがスタイルシートに依存しない場合、ブロックとなるスタイルの上に、ブロックとなるスクリプトを設置することを検討しましょう。依存する場合は、そのJavaScriptを2つに分割し、CSSの両側で読み込みます。</p>
<p>Scott Jehlは、<a href="https://www.filamentgroup.com/lab/inlining-cache.html">埋め込まれたCSSファイルをサービスワーカーでキャッシュする</a>ことにより、別の興味深い問題を解決しました。この問題は、クリティカルCSSを使用している人にとっては共通のよくある問題です。その解決策とは、基本的には<code class="language-text">style</code>要素にID属性を追加し、JavaScriptを使用して要素を発見しやすくすることです。その後、小規模なJavaScriptがそのCSSを発見し、Cache APIを使用してCSSをローカルブラウザのキャッシュに保存し（コンテンツタイプは<code class="language-text">text/css</code>）、その後のページで使えるようにします。その後のページでの埋め込みを避け、代わりにキャッシュされたアセットを外部から参照するために、サイトへの最初のアクセス時にcookieを設定します。これで完成です。</p>
<p>注目すべき点として、<a href="https://calendar.perfplanet.com/2019/the-unseen-performance-costs-of-css-in-js-in-react-apps/">動的なスタイル設定はコストが大きくなる可能性があります</a>が、それは通常、何百もの合成コンポーネントを同時にレンダリングし、そのコンポーネントに依存する場合に限られます。ですから、CSS-in-JSを使用している場合は、CSSがテーマやプロップに依存していないときに、そのCSS-in-JSライブラリが実行を最適化するようにしましょう。また、<strong>styled-components</strong>を合成し過ぎないようにすべきです。Aggelos Arvanitakisは、<a href="https://calendar.perfplanet.com/2019/the-unseen-performance-costs-of-css-in-js-in-react-apps/">CSS-in-JSのパフォーマンスコストに関してさらなる知見を紹介しています</a>。</p>
<h3>52. 応答をストリームするか？</h3>
<p>これは忘れられたり、無視されたりしていることが多いのですが、<a href="https://streams.spec.whatwg.org/">ストリーム</a>は非同期のデータのチャンクを読んだり書き込んだりするためのインタフェースを提供します。こうしたチャンクのうち、任意の時点にメモリ内で利用できるのは一部に限られる可能性があります。これらは基本的に、当初のリクエストを実施したページが、最初のチャンクが利用可能となった時点ですぐに応答の処理を開始できるようにするものです。また、ストリーミングに最適化されたパーサを使用して、コンテンツを段階的に表示できます。</p>
<p>複数のソースから1つのストリームを作成することが可能です。例えば、空のUIシェルを提供してJavaScriptでデータを入力する代わりに、シェルをキャッシュから、本文をネットワークから提供し、サービスワーカーに<strong>ストリームを構築させる</strong>ことができます。Jeff Posnickが<a href="https://developers.google.com/web/updates/2016/06/sw-readablestreams">述べている</a>ように、CMSが部分的なテンプレートをまとめることでHTMLをサーバレンダリングし、それによってWebアプリケーションが動いている場合、そのモデルは応答のストリーミングを使用するモデルへ直接転換することが可能です。このケースでは、テンプレートのロジックはサーバではなくサービスワーカーで再現されます。Jake Archibaldの<a href="https://jakearchibald.com/2016/streams-ftw/">The Year of Web Streams</a>という記事は、この仕組みを構築するための厳密な方法を明らかにしています。これはパフォーマンスの向上に<a href="https://www.youtube.com/watch?v=Cjo9iq8k-bc">とても顕著な効果があります</a>。</p>
<p>HTML応答を全てストリーミングすることの重要な強みの1つは、最初のナビゲーションリクエストの間にレンダリングされたHTMLが、ブラウザのストリーミングHTMLパーサのメリットをフル活用できることです。ページの読み込み後にドキュメントに挿入されるHTMLのチャンクは、（JavaScriptを通じて読み込まれるコンテンツと同様に）この最適化によるメリットを活用できません。</p>
<p>ブラウザのサポート状況はどうでしょうか。<a href="https://caniuse.com/#feat=streams">現在はまだ道半ば</a>で、Chrome、Firefox、Safari、EdgeはこのAPIを部分的にのみサポートしています。一方、サービスワーカーは<a href="https://caniuse.com/#feat=serviceworkers">全てのモダンなブラウザでサポートされています</a>。大胆なことがしたくなったら、ストリーミング応答の試験的な実装をチェックしてみても良いでしょう。これは、まだ本文を生成している間にリクエスト送信を開始することを可能にします。この機能はChrome 85で利用可能です。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d0d3b406-93e8-4ef4-a407-c2453651a02a/save-data-usage-android-chrome.jpg">
<a href="https://twitter.com/colinbendell/status/1265675813204172810">Cloudinaryの調査</a>によれば、世界のAndroid Chromeユーザの18％はライトモード（省データモード）を有効にしています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d0d3b406-93e8-4ef4-a407-c2453651a02a/save-data-usage-android-chrome.jpg">プレビューを拡大</a>）</p>
<h3>53. 接続状況に対応したコンポーネントの導入を検討する。</h3>
<p>データのコストは<a href="https://whatdoesmysitecost.com/">重くなる</a>ことがあります。ペイロードが大きくなるにつれて、サイトやアプリケーションにアクセスする際に省データモードを選択するユーザに配慮する必要が出てきます。<a href="https://simonhearne.com/2020/save-data/">省データクライアントヒントのリクエストヘッダ</a>は、コストやパフォーマンスの制約があるユーザに合わせて、アプリケーションとペイロードをカスタマイズすることを可能にします。</p>
<p>実際、<a href="https://css-tricks.com/help-users-save-data/">高DPI画像を低DPI画像にするためのリクエストの書き換え</a>、Webフォントの削除、手の込んだパララックス効果の削除、サムネイルと無限スクロールのプレビュー、動画の自動再生の停止、サーバプッシュ、表示項目の数の削減、画像の品質の引き下げに加え、<a href="https://dev.to/addyosmani/adaptive-serving-using-javascript-and-the-network-information-api-331p">マークアップを提供する</a>方法の変更さえ可能です。Tim Vereeckeは、<a href="https://calendar.perfplanet.com/2018/data-shaver-strategies/">データを節約（削減）する戦略</a>についてのとても詳しい記事を公開し、省データのための数多くの選択肢を紹介しています。</p>
<p>誰が<code class="language-text">save-data</code>を使用しているのだろうと思う読者もいるかもしれません。<a href="https://twitter.com/colinbendell/status/1265675813204172810">世界のAndroid Chromeユーザの18％はライトモードを有効にしており</a>（つまり<code class="language-text">Save-Data</code>をオンにしており）、さらに実際の人数は<a href="https://twitter.com/addyosmani/status/1265677876608655361">これを上回る可能性が高い</a>と言えます。Simon Hearneの<a href="https://simonhearne.com/2020/save-data/">調査</a>によれば、ライトモードの選択率が最も高いのは比較的安い端末ですが、多くの例外が存在します。例えば、カナダのユーザの選択率は34％超（米国では約7％）で、Samsungの最新の旗艦モデルのユーザによる選択率は世界全体で約18％となっています。</p>
<p><code class="language-text">Save-Data</code>モードがオンになっていると、Chrome Mobileはユーザ体験を最適化して提供します。つまり、<code class="language-text">font-display: swap</code>と遅延読み込みを強制的に適用し、<strong>遅延スクリプトを使用した代替的なWeb体験</strong>です。こうしたブラウザの最適化に頼るよりも、自分でユーザ体験を構築するほうが理にかなっています。</p>
<p>このヘッダは現在Chromiumのみでサポートされており、ChromeのAndroid版か、デスクトップ端末のData Saver拡張機能を通じて提供されています。最後に、ネットワークの種類に応じて、<a href="https://umaar.com/dev-tips/242-considerate-javascript/">コストが大きいJavaScriptモジュール</a>や高解像度の画像と動画を提供するには、<a href="https://googlechrome.github.io/samples/network-information/">Network Information API</a>も使用することができます。Network Information API、特に<code class="language-text">navigator.connection.effectiveType</code>は、<code class="language-text">RTT</code>、<code class="language-text">downlink、effectiveType</code>の値（と<a href="https://wicg.github.io/netinfo/">その他</a>の少数の項目）を使用して、ユーザが処理できる接続とデータを表示します。</p>
<p>これに関連して、Max Böckは<a href="https://mxb.at/blog/connection-aware-components/">接続状況に対応したコンポーネント</a>について、Addy Osmaniは<a href="https://youtu.be/puUPpVrIRkc?t=975">アダプティブなモジュール提供</a>について語っています。例えばReactでは、異なる接続の種類に応じて、異なる方式でレンダリングされるコンポーネントを書くことができます。Maxが示しているとおり、ニュース記事の<Media />コンポーネントは以下のように出力されるでしょう。</p>
<ul>
<li><code class="language-text">Offline</code>：<code class="language-text">alt</code>テキスト付きのプレースホルダ</li>
<li><code class="language-text">2G / save-dataモード</code>：低解像度の画像</li>
<li>Retinaではないディスプレイの<code class="language-text">3G</code>：中解像度の画像</li>
<li>Retinaディスプレイの<code class="language-text">3G</code>：高解像度のRetina画像</li>
<li><code class="language-text">4G</code>：HD動画</li>
</ul>
<p>Dean Humeは、サービスワーカーを使用した<a href="https://deanhume.com/dynamic-resources-using-the-network-information-api-and-service-workers/">同様のロジックの現実的な実装方法</a>を解説しています。動画については、デフォルトでは動画ポスターを表示し、接続が良い場合は「再生」アイコン、動画プレーヤのシェル、動画のメタデータなどを表示することができます。上記をサポートしていないブラウザ向けのフォールバックとして、<a href="https://benrobertson.io/front-end/lazy-load-connection-speed"><code class="language-text">canplaythrough</code>イベントをリッスンし</a>、<code class="language-text">Promise.race()</code>を使用することで、<code class="language-text">canplaythrough</code>イベントが2秒以内に発生しない場合にソース読み込みをタイムアウトすることが可能です。</p>
<p>もう少し詳しく知りたい方向けに、スタートに適したリソースをいくつか紹介します。</p>
<ul>
<li>Addy Osmaniは<a href="https://www.youtube.com/watch?v=puUPpVrIRkc&#x26;t=488s">Reactでアダプティブなデータ提供を実装する方法</a>を示しています。</li>
<li><a href="https://github.com/GoogleChromeLabs/react-adaptive-hooks">React Adaptive Loading Hooks &#x26; Utilities</a>はReact向けのコードスニペットを提供します。</li>
<li>Netanel Basalは<a href="https://netbasal.com/connection-aware-components-in-angular-3a66bb0bab6f">Angularにおける接続状況に対応したコンポーネント</a>について追求しています。</li>
<li>Theodore Vorillasは<a href="https://dev.to/vorillaz/serving-adaptive-components-using-the-network-information-api-lbo">VueでNetwork Information APIを使用してアダプティブコンポーネントを提供する</a>仕組みについて解説しています。</li>
<li>Umar Hansaは<a href="https://umaar.com/dev-tips/242-considerate-javascript/">コストが大きいJavaScriptを選択的にダウンロード/実行する方法</a>を説明しています。</li>
</ul>
<h3>54. 端末のメモリに対応したコンポーネントの導入を検討する。</h3>
<p>しかし、ネットワークの接続からユーザについて知ることができる情報はほんの一面に過ぎません。一歩踏み込んで、<a href="https://developers.google.com/web/updates/2017/12/device-memory">Device Memory API</a>で、<a href="https://calendar.perfplanet.com/2018/dynamic-resources-browser-network-device-memory/">利用できる端末メモリに基づいてリソースを動的に調整する</a>ことも可能です。<code class="language-text">navigator.deviceMemory</code>は、端末のRAMをギガバイト単位（2のべき乗未満は切り捨て）で返します。このAPIには、同じ値を報告する<code class="language-text">Device-Memory</code>というクライアントヒントヘッダも搭載されています。</p>
<p><strong>おまけ</strong>：<em>Umar Hansaは、動的インポートによって<a href="https://twitter.com/umaar/status/1206707408506105858">コストが大きいスクリプトを遅延させる方法</a>を解説しています。これにより、端末のメモリ、ネットワークの接続性、<a href="https://developer.mozilla.org/en-US/docs/Web/API/NavigatorConcurrentHardware/hardwareConcurrency">ハードウエアの並行処理能力</a>に基づいてユーザ体験を変えることが可能になります</em>。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f2dbec5f-c859-4aa6-b10b-f017be63fc3b/resources-in-chrome.jpeg">
Chrome 46以降のBlinkにおけるさまざまなリソースの優先順位の内訳。（画像の出典：<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">Addy Osmani</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f2dbec5f-c859-4aa6-b10b-f017be63fc3b/resources-in-chrome.jpeg">プレビューを拡大</a>）</p>
<h3>55. デリバリを高速化するために接続をウォームアップする。</h3>
<p><a href="https://w3c.github.io/resource-hints">リソースヒント</a>を使用して時間を節約しましょう。例えば、<a href="https://caniuse.com/#search=dns-prefetch"><code class="language-text">dns-prefetch</code></a>（バックグラウンドでDNSルックアップを実行する）、<a href="https://www.caniuse.com/#search=preconnect"><code class="language-text">preconnect</code></a>（ブラウザに対してバックグラウンドで接続のためのハンドシェイク（DNS、TCP、TLS）を開始するように要求する）、<a href="https://caniuse.com/#search=prefetch"><code class="language-text">prefetch</code></a>（ブラウザに対してリソースをリクエストするように要求する）、<a href="https://www.smashingmagazine.com/2016/02/preload-what-is-it-good-for/"><code class="language-text">preload</code></a>（リソースを実行することなく先読みするなど）といったリソースヒントがあります。モダンなブラウザの<a href="https://caniuse.com/?search=preload">サポートも充実</a>しており、<a href="https://twitter.com/__jakub_g/status/1333711930004025346">間もなくFirefoxでもサポートされる見込み</a>です。</p>
<p>皆さんは<a href="https://www.w3.org/TR/resource-hints/#dfn-prerender"><code class="language-text">prerender</code></a>を覚えていますか。これは、次のナビゲーションのために、ブラウザにバックグラウンドでページ全体をビルドさせるのに使用されていたリソースヒントです。その実装には、膨大なメモリフットプリントと帯域幅の使用から、アナリティクスヒットと広告インプレッションが複数回カウントされることに至るまで、<a href="https://vimeo.com/356819848#t=1632s">大きな問題がありました</a>。</p>
<p>当然、非推奨となりましたが、Chromeチームはこれを<a href="https://developers.google.com/web/updates/2018/07/nostate-prefetch">NoState Prefetchの仕組み</a>として復活させました。実際、Chromeは<code class="language-text">prerender</code>ヒントをNoState Prefetchの代わりとして扱っているため、現在もまだ使用することができます。Katie Hempeniusが上記の記事で説明しているとおり、「prerenderingと同様に、<strong>NoState Prefetchはリソースを事前に取得します</strong>。ただし、prerenderingとは異なり、事前に<strong>JavaScriptを実行することや、ページの一部をレンダリングすることはありません</strong>」。</p>
<p>NoState Prefetchは約45MiBのメモリしか使用せず、取得されるサブリソースの取得時のネットプライオリティは<code class="language-text">IDLE</code>となります。Chrome 69以降、NoState Prefetchは全てのリクエストにPurpose: Prefetchヘッダを追加しています。これは全てのリクエストを通常のブラウジングから区別するためのものです。</p>
<p><a href="https://github.com/jeremyroman/alternate-loading-modes">プリレンダリングの別の選択肢</a>と<a href="https://github.com/WICG/portals/blob/master/README.md">portals</a>にも注目しましょう。portalsはプライバシーに配慮したプリレンダリングの新たな取り組みで、シームレスなナビゲーションのためにコンテンツのinsetの<code class="language-text">preview</code>を提供します。</p>
<p>リソースヒントの使用は、<strong>パフォーマンスを向上させる最も簡単な方法</strong>でしょう。<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">実際、リソースヒントは有効です</a>。それでは、何をいつ使用すれば良いのでしょうか。Addy Osmaniが<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">説明</a>しているとおり、現在のページや、複数のナビゲーションの境界をまたいで将来のナビゲーションに利用される可能性が非常に高いことが分かっている場合（ユーザがまだアクセスしていないページに必要なWebpackバンドルなど）は、リソースを先読みするのが合理的です。</p>
<p>Addyの<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">Chromeの読み込みの優先順位</a>に関する記事では、Chromeがリソースヒントを解釈する厳密な仕組みが説明されています。そのため、どのアセットがレンダリングにとってクリティカルであるかを決めれば、それに高い優先順位を割り当てることができます。リクエストがどのように優先順位づけされているかを確認するには、Chrome DevToolsのネットワークリクエスト表の「priority」欄を有効化します（Safariでも同様です）。</p>
<p>現在では、大体の場合は<strong>少なくとも</strong><code class="language-text">preconnect</code>と<code class="language-text">dns-prefetch</code>を使用することになるでしょう。<code class="language-text">prefetch</code>、<code class="language-text">preload</code>、<code class="language-text">prerender</code>を使用するときは注意しなければなりません。気をつけるべき点として、<code class="language-text">preconnect</code>と<code class="language-text">dns-prefetch</code>を使用しても、ブラウザが並行的にルックアップ/接続できるホストの数には限界があります。ですから、優先順位に基づいて指示を行うのが賢明です（Philip Tellisに感謝します）。</p>
<p><strong>フォント</strong>は通常、ページの重要なアセットであるため、場合によっては<a href="https://css-tricks.com/the-critical-request/#article-header-id-2">ブラウザに対して<code class="language-text">preload</code>でクリティカルなフォントをダウンロードすることを要求する</a>のが良いアイデアとなります。ただし、<a href="https://andydavies.me/blog/2019/02/12/preloading-fonts-and-the-puzzle-of-priorities/">フォントの先読みの優先順位は複雑である</a>ため、実際にパフォーマンスに貢献しているかをダブルチェックすることが必要です。<code class="language-text">preload</code>は優先順位が高いとみなされるので、クリティカルCSSなどのさらに重要なリソースよりも優先される場合があります（Barryに感謝します）。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Loading two rendering-critical fonts, but not all their weights. --></span>
<span class="token comment">&lt;!--
crossorigin="anonymous" is required due to CORS.
Without it, preloaded fonts will be ignored.
https://github.com/w3c/preload/issues/32
via https://twitter.com/iamakulov/status/1275790151642423303
--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font<span class="token punctuation">"</span></span>
      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Elena-Regular.woff2<span class="token punctuation">"</span></span>
      <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font/woff2<span class="token punctuation">"</span></span>
      <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span>
      <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>only screen and (min-width: 48rem)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font<span class="token punctuation">"</span></span>
      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Mija-Bold.woff2<span class="token punctuation">"</span></span>
      <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font/woff2<span class="token punctuation">"</span></span>
      <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span>
      <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>only screen and (min-width: 48rem)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">&lt;link rel=&quot;preload&quot;&gt;</code>は<code class="language-text">media</code>属性を許容するため、上記のように、<code class="language-text">@media</code>クエリのルールに基づいて<a href="https://css-tricks.com/the-critical-request/#article-header-id-3">リソースを選択的にダウンロードする</a>ことを選べます。
さらに、<code class="language-text">imagesrcset</code>属性と<code class="language-text">imagesizes</code>属性を使用して、<a href="https://addyosmani.com/blog/preload-hero-images/">発見されるのが遅いヒーロー画像</a>や、JavaScriptを通じて読み込まれる画像（動画ポスターなど）の先読みを高速化することができます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Addy Osmani. https://addyosmani.com/blog/preload-hero-images/ --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image<span class="token punctuation">"</span></span>
     <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>poster.jpg<span class="token punctuation">"</span></span>
     <span class="token attr-name">imagesrcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
        poster_400px.jpg 400w,
        poster_800px.jpg 800w,
        poster_1600px.jpg 1600w<span class="token punctuation">"</span></span>
    <span class="token attr-name">imagesizes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50vw<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>また、<strong>JSONをfetchとして先読み</strong>し、JavaScriptがリクエストを開始する前に発見することも可能です。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Addy Osmani. https://addyosmani.com/blog/preload-hero-images/ --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo.com/api/movies.json<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>さらに、スクリプトの実行を実質的に遅延させるために、<a href="https://www.smashingmagazine.com/2016/02/preload-what-is-it-good-for/#dynamic-loading-without-execution">JavaScriptを動的に読み込む</a>こともできます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">/* Adding a preload hint to the head */</span>
<span class="token keyword">var</span> preload <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"link"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
link<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">"myscript.js"</span><span class="token punctuation">;</span>
link<span class="token punctuation">.</span>rel <span class="token operator">=</span> <span class="token string">"preload"</span><span class="token punctuation">;</span>
link<span class="token punctuation">.</span>as <span class="token operator">=</span> <span class="token string">"script"</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Injecting a script when we want it to execute */</span>
<span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"myscript.js"</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://dexecure.com/blog/http2-push-vs-http-preload/">注意すべき落とし穴</a>もあります。<code class="language-text">preload</code>は<a href="https://www.youtube.com/watch?v=RWLzUnESylc">アセットのダウンロード開始時間を当初のリクエストに近づける</a>のに適していますが、先読みされたアセットは、リクエストを実施したページとひもづいた<strong>メモリキャッシュ</strong>に保存されます。<code class="language-text">preload</code>はHTTPキャッシュと相性が良く、アイテムがHTTPキャッシュにすでに存在する場合はネットワークリクエストが送信されません。</p>
<p>したがって、発見が遅いリソース、<code class="language-text">background-image</code>を通じて読み込まれるヒーロー画像、クリティカルなCSS（やJavaScript）の埋め込み、残りのCSS（やJavaScript）の先読みに便利です。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/354f16f7-95de-4aa8-accb-83538a5049ed/preload-late-images-js.jpg">
重要な画像を早く先読みしましょう。JavaScriptによる発見を待つ必要はありません。（画像の出典：“<a href="https://addyosmani.com/blog/preload-hero-images/">Preload Late-Discovered Hero Images Faster</a>”（Addy Osmani著））（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/354f16f7-95de-4aa8-accb-83538a5049ed/preload-late-images-js.jpg">プレビューを拡大</a>）</p>
<p><code class="language-text">preload</code>タグは、ブラウザがサーバからHTMLを受け取り、先読みパーサが<code class="language-text">preload</code>タグを発見した後にのみ、先読みを開始することができます。HTTPヘッダを通じた先読みは、ブラウザがリクエストを開始するためにHTMLをパースするのを待つ必要がないため、少し速くなる可能性があります（ただし、これは<a href="https://twitter.com/yoavweiss/status/1151586733177352192?s=20">議論の対象となっています</a>）。</p>
<p><a href="https://www.fastly.com/blog/faster-websites-early-priority-hints">Early Hints</a>はもっと役に立つでしょう。これはHTMLの応答ヘッダが送信される前から、先読みを開始することを可能にします（<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=671310">Chromium</a>と<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1407355">Firefox</a>のロードマップに掲載されています）。さらに、<a href="https://github.com/WICG/priority-hints">Priority Hints</a>はスクリプト読み込みの優先順位を示すのに役立ちます。</p>
<p><strong>注意</strong>：<code class="language-text">preload</code>を使用する場合、<code class="language-text">as</code>を<strong>必ず</strong>定義しなければなりません。さもないと<a href="https://twitter.com/yoavweiss/status/873077451143774209">何も読み込まれない</a>ことになります。さらに、<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf"><code class="language-text">crossorigin</code>属性なしでフォントを先読みすると、フォントが二重に取得されます</a>。<code class="language-text">prefetch</code>を使用している場合、<a href="https://timkadlec.com/remembers/2020-06-17-prefetching-at-this-age/">Firefoxの<code class="language-text">Age</code>ヘッダの問題</a>に気をつけましょう。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/80b8c02e-701b-4700-8bcf-f88240a78a49/fcp-histogram-by-sw-status-1400w-57a170dca9.png">
サービスワーカーを使用すれば、必要最低限のデータのみをリクエストし、そのデータを完全なHTML文書に変換してFCPを改善することができます。（<a href="https://philipwalton.com/articles/smaller-html-payloads-with-service-workers/">Phil Walton</a>より）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/80b8c02e-701b-4700-8bcf-f88240a78a49/fcp-histogram-by-sw-status-1400w-57a170dca9.png">プレビューを拡大</a>）</p>
<h3>56. キャッシングとネットワークのフォールバックとしてサービスワーカーを使用する。</h3>
<p>どんなネットワーク上のパフォーマンス最適化も、ユーザのマシンにキャッシュをローカル保存するより速くはなりません（ただし、<a href="https://simonhearne.com/2020/network-faster-than-cache/">例外</a>もあります）。WebサイトがHTTPS通信を利用している場合、<a href="https://github.com/lyzadanger/pragmatist-service-worker">サービスワーカーのキャッシュに静的アセットをキャッシング</a>し、オフラインのフォールバックを（あるいはオフラインのページも）保存すれば、ネットワークに接続することなくこれらをユーザのマシンから取得できます。</p>
<p>Phil Waltonが提案するとおり、サービスワーカーでは、応答をプログラムで生成することによって、<a href="https://philipwalton.com/articles/smaller-html-payloads-with-service-workers/">より小さいHTMLペイロード</a>を送信できます。サービスワーカーは、サーバから必要最低限のデータ（HTMLコンテンツの一部、マークダウンファイル、JSONデータなど）のみをリクエストし、そのデータを<strong>プログラムで完全なHTML文書へ変換</strong>することが可能です。ユーザがサイトを1度訪問し、サービスワーカーがインストールされれば、ユーザは二度とHTMLページ全体をリクエストする必要がありません。<a href="https://philipwalton.com/articles/smaller-html-payloads-with-service-workers/">これはパフォーマンスに素晴らしい影響を与える可能性があります</a>。</p>
<p>ブラウザのサポート状況はどうでしょうか。<a href="https://caniuse.com/#search=serviceworker">サービスワーカーは広くサポートされており</a>、どちらにせよネットワークがフォールバックとなります。サービスワーカーは<strong>パフォーマンスの改善</strong>に<a href="https://developers.google.com/web/showcase/2016/service-worker-perf">確かに貢献します</a>。さらに、その貢献度は高まっています。例えば、Background Fetchでは、サービスワーカーを通じたバックグラウンドでのアップロード/ダウンロードも可能です。</p>
<p>サービスワーカーにはいくつもの用途があります。例えば、<a href="https://una.im/save-offline/#%F0%9F%92%81">「オフライン用に保存」機能を実装する</a>、<a href="https://bitsofco.de/handling-broken-images-with-service-worker/">壊れた画像を処理する</a>、タブ間のメッセージングを導入する、あるいは<a href="https://medium.com/dev-channel/service-worker-caching-strategies-based-on-request-types-57411dd7652c">リクエストの種類によって異なるキャッシング戦略を提供する</a>といった使い方が可能です。一般によく見られる信頼性が高い戦略は、少数のクリティカルなページ（オフラインページ、フロントページ、その他の各ケースで重要なページなど）とともに、アプリケーションのシェルをサービスワーカーのキャッシュに保存するというものです。</p>
<p>ただし、注意すべき落とし穴もあります。サービスワーカーを導入している場合、<a href="https://philna.sh/blog/2018/10/23/service-workers-beware-safaris-range-request/">Safariのレンジリクエストに気をつけなければなりません</a>（Workboxをサービスワーカー向けに使用している場合、<a href="https://developers.google.com/web/tools/workbox/modules/workbox-range-requests">Workboxにはレンジリクエストモジュールが存在します</a>）。ブラウザコンソールの<code class="language-text">DOMException: Quota exceeded.</code>エラーにつまずいたことがあるなら、<a href="https://cloudfour.com/thinks/when-7-kb-equals-7-mb/">GerardoのWhen 7KB equals 7MB</a>という記事を見てみましょう。</p>
<p>Gerardoが書いているとおり、「プログレッシブなWebアプリケーションを開発していて、サービスワーカーがCDNから提供された静的アセットをキャッシュすることでキャッシュストレージが膨張しているなら、クロスオリジンのリソース向けに<a href="https://cloudfour.com/thinks/when-7-kb-equals-7-mb/#opaque-responses">適切なCORS応答ヘッダが存在する</a>ようにすること、サービスワーカーで意図せず<a href="https://cloudfour.com/thinks/when-7-kb-equals-7-mb/#should-opaque-responses-be-cached-at-all">不透明な応答をキャッシュしない</a>ようにすること、<code class="language-text">crossorigin</code>属性を<code class="language-text">&lt;img&gt;</code>タグに追加して<a href="https://cloudfour.com/thinks/when-7-kb-equals-7-mb/#opt-in-to-cors-mode">クロスオリジンの画像アセットをCORSモードにオプトインすること</a>を確実にしましょう」。</p>
<p>サービスワーカーを導入するための<strong>素晴らしいリソース</strong>は数多く存在します。</p>
<ul>
<li><a href="https://web.dev/service-worker-mindset/">Service Worker Mindset</a>は、サービスワーカーが水面下で機能する仕組みや、サービスワーカーを構築するときに知っておくべきことを理解するのに役立ちます。</li>
<li>Chris Ferdinandiは、<a href="https://gomakethings.com/series/service-workers/">サービスワーカーに関する素晴らしいシリーズ記事</a>を提供しています。この記事は、オフラインのアプリケーションを作成する方法を説明するとともに、最近閲覧したページのオフライン保存から、サービスワーカーでキャッシュ内の項目の有効期限を設定する方法まで、さまざまなシナリオをカバーしています。</li>
<li><a href="https://www.thecodeship.com/web-development/guide-service-worker-pitfalls-best-practices/">Service Worker Pitfalls and Best Practices</a>という記事では、サービスワーカーの落とし穴とベストプラクティスに加え、サービスワーカーの適用範囲、登録の遅延、キャッシングについてのヒントを紹介しています。</li>
<li>Ire Aderinokunの<a href="https://bitsofco.de/bitsofcode-pwa-part-1-offline-first-with-service-worker/">"Offline First" with Service Worker</a>という素晴らしいシリーズ記事では、アプリケーションのシェルの事前キャッシングに関する戦略を説明しています。</li>
<li><a href="https://developers.google.com/web/fundamentals/primers/service-workers">Service Worker: An Introduction</a>は、リッチなオフライン体験、定期的なバックグラウンド同期、プッシュ通知にサービスワーカーを使用する方法に関する実用的なヒントを提供します。</li>
<li>Jake Archibaldによる<a href="https://jakearchibald.com/2014/offline-cookbook/">Offline Cookbook</a>は昔ながらの記事ですが、いつでも参考に値します。この記事では、自分でサービスワーカーを作るためのレシピが紹介されています。</li>
<li><a href="https://developers.google.com/web/tools/workbox/">Workbox</a>は、特にプログレッシブなWebアプリケーションを構築するために開発されたサービスワーカーのライブラリです。</li>
</ul>
<h3>57. サーバワーカーをA/BテストなどのためにCDN/エッジで実行しているか？</h3>
<p>現在、私たちはサービスワーカーをクライアント側で実行することにすっかり慣れています。しかし、<a href="https://blog.cloudflare.com/introducing-cloudflare-workers/">CDNがサービスワーカーをサーバに実装する</a>ことで、エッジでもパフォーマンスを微調整するためにサービスワーカーを使用できる可能性があります。
例えば、A/Bテストにおいて、HTMLが異なるユーザ向けにコンテンツを変更する必要があるときに、<a href="https://www.filamentgroup.com/lab/servers-workers.html">CDNサーバでサービスワーカーを使用する</a>ことでロジックを処理できるでしょう。また、HTML書き換えのストリームによって、Google Fontsを使用するサイトを高速化できます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4161d64c-521d-41fc-9eec-300dc766a412/pwa-timeseries-of-service-worker-installations-opt.png">
サービスワーカ導入の時系列。<a href="https://almanac.httparchive.org/en/2020/pwa">Web Almanac</a>によれば、サービスワーカを登録しているページは全てのデスクトップページの0.87％にとどまっています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4161d64c-521d-41fc-9eec-300dc766a412/pwa-timeseries-of-service-worker-installations-opt.png">プレビューを拡大</a>）</p>
<h3>58. レンダリングのパフォーマンスを最適化する。</h3>
<p>アプリケーションが重いと、すぐに気づかれてしまいます。ですから、ページをスクロールするときや要素のアニメーションが動くときにラグが生じないようにし、1秒当たり60フレームのフレームレートを常に守らなければなりません。それが不可能な場合は、少なくとも1秒当たりのフレーム数を15～60の範囲内で一定にすることが望ましいと言えます。どの要素やプロパティが変化するかをブラウザに伝えるには、CSSのwill-changeを使用しましょう。</p>
<p>ユーザ体験を確認するときは、DevToolsで<strong>不必要な再描画をデバッグ</strong>するようにします。</p>
<ul>
<li><a href="https://aerotwist.com/blog/my-performance-audit-workflow/#runtime-performance">ランタイムのレンダリングパフォーマンスを測定</a>しましょう。測定結果を理解するための便利なヒントもチェックしてみてください。</li>
<li>出発点として、Paul Lewisによる<a href="https://www.udacity.com/course/browser-rendering-optimization--ud860">ブラウザレンダリングの最適化に関するUdacityの無料講義</a>と、Georgy Marchukによる<a href="https://css-tricks.com/browser-painting-and-considerations-for-web-performance/">Browser painting and considerations for web performance</a>という記事をチェックしてみてください。</li>
<li>Firefox DevToolsで"More tools → Rendering → Paint Flashing"を選択し、<a href="https://twitter.com/iamakulov/status/1275782035655753729">Paint Flashing</a>を有効にしましょう。</li>
<li>React DevToolsでは、<a href="https://twitter.com/iamakulov/status/1275783591293857792">"Highlight updates"にチェックをつけ</a>、<a href="https://twitter.com/iamakulov/status/1275863444944756738">"Record why each component rendered"を有効にしましょう</a>。</li>
<li><a href="https://github.com/welldone-software/why-did-you-render">Why Did You Render</a>を使用すると、コンポーネントが再レンダリングされたときに変更を素早く通知してくれます。</li>
</ul>
<p>Masonryレイアウトを使用している場合は、<a href="https://www.bram.us/2020/05/04/css-grid-layout-module-level-2-masonry-layout/">かなり近いうちにCSSグリッドのみでMasonryレイアウトを構築できるようになる</a>可能性があることを覚えておきましょう。</p>
<p>このテーマについてもっと詳しく知りたいならば、Nolan Lawsonが記事で<a href="https://nolanlawson.com/2018/09/25/accurately-measuring-layout-on-the-web/">レイアウトのパフォーマンスを正確に測定するための技</a>を紹介しており、Jason Millerも<a href="https://twitter.com/_developit/status/1081682550865752064">代わりとなるテクニックを提案</a>しています。Sergey Chikuyonokも、<a href="https://www.smashingmagazine.com/2016/12/gpu-animation-doing-it-right/">適切なGPUアニメーション</a>を作成するための短い記事を執筆しています。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9c4093df-2d79-4a00-82ca-e19e0c439254/high-performance-animations.jpg">
ブラウザは、あまりコストをかけずに変形や透明度に関するアニメーションをつけることができます。<a href="https://csstriggers.com/">CSS Triggers</a>は、CSSが再レイアウトやリフローのきっかけになるかをチェックするのに便利です。（画像の出典：<a href="https://twitter.com/addyosmani/status/1223916476610097154">Addy Osmani</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9c4093df-2d79-4a00-82ca-e19e0c439254/high-performance-animations.jpg">プレビューを拡大</a>）</p>
<p><strong>注記</strong>：GPU合成レイヤの変更は<a href="https://blog.algolia.com/performant-web-animations/">コストがとても小さくなります</a>。そのため、<code class="language-text">opacity</code>と<code class="language-text">transform</code>による合成をトリガーするだけで済むなら、それで問題ありません。Anna Migasは、<a href="https://vimeo.com/302791098">UIのレンダリングパフォーマンスのデバッグ</a>に関する講演で数多くの実用的なアドバイスを提供しています。DevToolsで描画のパフォーマンスをデバッグする方法を知るには、<a href="https://www.youtube.com/watch?v=8-pkB2vGUKk">Umarの描画パフォーマンス監査に関する動画</a>をチェックしましょう。</p>
<h3>59. 体感的なパフォーマンスを最適化しているか？</h3>
<p>コンポーネントがページに表示される順番や、どのようにアセットをブラウザに提供するかという戦略は重要ですが、<a href="https://www.smashingmagazine.com/2015/09/why-performance-matters-the-perception-of-time/">体感的なパフォーマンス</a>の役割も過小評価すべきではありません。この考え方は待つことの心理的な側面に着目したものです。基本的には、顧客に別のことをさせたり、顧客の注意を引きつけたりしている間に、他の処理を済ませるという手法を採用します。<a href="https://www.smashingmagazine.com/2015/11/why-performance-matters-part-2-perception-management/">体感マネジメント</a>、<a href="https://www.smashingmagazine.com/2015/11/why-performance-matters-part-2-perception-management/#preemptive-start">割り込みスタート</a>、<a href="https://www.smashingmagazine.com/2015/11/why-performance-matters-part-2-perception-management/#early-completion">早期完了</a>、<a href="https://www.smashingmagazine.com/2015/12/performance-matters-part-3-tolerance-management/">許容度マネジメント</a>といった要素が重要になります。</p>
<p>これらは何を意味するのでしょうか。アセットを読み込む間、常に顧客の一歩先を行くことを目指しましょう。それによって、水面下では多くのことが起こっていても、スムーズに感じられるユーザ体験を提供できるのです。顧客の注意を引きつけ続けるために、読み込みインジケータの代わりに<a href="https://twitter.com/lukew/status/665288063195594752">スケルトンスクリーン</a>（<a href="https://twitter.com/razvancaliman/status/734088764960690176">実装デモ</a>）を試したり、トランジション/アニメーションを追加したりすることができます。これ以上最適化するものがない場合は、基本的に<a href="https://blog.stephaniewalter.fr/en/cheating-ux-perceived-performance-and-user-experience/">ユーザ体験を実際より良く見せる</a>という手もあります。</p>
<p>Kumar McMillanは、<a href="http://farmdev.com/thoughts/108/the-art-of-ui-skeletons/">The Art of UI Skeletons</a>というケーススタディで、動的リスト、テキスト、最終画面をシミュレーションする方法や、Reactで「Skeleton思考」について検討する方法について、アイデアとテクニックを提供しています。</p>
<p>ただし、スケルトンスクリーンは実装前にテストすべきです。なぜなら、<a href="https://www.viget.com/articles/a-bone-to-pick-with-skeleton-screens/">一部のテストは、スケルトンスクリーンのパフォーマンスが全ての指標で最低となる可能性がある</a>ことを示しているからです。</p>
<h3>60. レイアウトのシフトと再描画を防止しているか？</h3>
<p>体感的なパフォーマンスに関して、特にうっとうしいと感じられるものの1つは<strong>レイアウトシフト</strong>（リフロー）でしょう。これは、画像と動画の寸法の変化、Webフォント、広告の挿入、あるいは発見されるのが遅いスクリプトによってコンポーネントに実際のコンテンツが読み込まれることが原因で発生します。その結果、顧客が記事を読み始めているにもかかわらず、読んでいる場所より上のレイアウトが移動することで邪魔されかねません。こうした体験は突然で、どこを読んでいるかまったく分からなくなることが多いものです。このような場合、読み込みの優先順位を検討し直す必要があるでしょう。</p>
<p>コミュニティでは、リフローを回避するためのテクニックや代替策が開発されています。一般的に、ユーザとのインタラクションによる応答以外では、<strong>既存のコンテンツの上に新しいコンテンツを挿入するのは避ける</strong>べきです。画像には常に[width属性とheight属性]を設定することで、モダンなブラウザがデフォルトでボックスを割り当て、スペースを確保できるようにしましょう（Firefox、Chrome）。</p>
<p>画像と動画の両方について、メディアが表示されるディスプレイボックスを確保するために<a href="https://css-tricks.com/preventing-content-reflow-from-lazy-loaded-images/">SVGプレースホルダ</a>を使用できます。これは、アスペクト比を維持する必要があるときも、その領域が適切に確保されることを意味します。また、レイアウトのスロットを事前に割り当てたり、広告や動的コンテンツのプレースホルダ（フォールバック画像）を使用したりすることも可能です。</p>
<p>外部スクリプトで画像を遅延読み込みする代わりに、ネイティブ遅延読み込みの使用を検討しましょう。<a href="https://web.dev/native-lazy-loading/">ネイティブ遅延読み込み</a>がサポートされていない場合に限り、外部スクリプトの読み込みに<a href="https://www.smashingmagazine.com/2019/05/hybrid-lazy-loading-progressive-migration-native/">ハイブリッド遅延読み込み</a>を使用することも考えてみましょう。</p>
<p>すでに述べたとおり、<a href="https://www.zachleat.com/web/comprehensive-webfonts/#fout-class">Webフォントの再描画は常にグループ化し</a>、全てのフォールバックフォントから全てのWebフォントへ一斉に移行しましょう。移行が唐突過ぎると感じさせないように、<a href="https://meowni.ca/font-style-matcher/">font-style-matcher</a>を使用して、行の高さと間隔をフォント間で調整してください。</p>
<p>フォールバックフォントでWebフォントをエミュレートするために<strong>フォントメトリックを上書きする</strong>には、<a href="https://docs.google.com/document/d/1PW-5ML5hOZw7GczOargelPo6_8Zkuk2DXtgfOtJ59Eo/edit">@font-face記述子を使用できます</a>（<a href="https://jsfiddle.net/wpnjav2k/">デモ</a>、Chrome 87で有効）（ただし、複雑なフォントスタックでは複雑な調整が必要であることにご注意ください）。</p>
<p>CSSが遅い場合は、各テンプレートのヘッダに、<strong>レイアウトにとってクリティカルなCSSを埋め込みましょう</strong>。さらに、長いページの場合、縦のスクロールバーを追加すると<a href="https://twitter.com/paul_irish/status/1239586279924236288">メインコンテンツが16ピクセル左に移動します</a>。スクロールバーを早く表示するには、<a href="https://twitter.com/TimVereecke/status/1239454788116533248"><code class="language-text">html</code>に<code class="language-text">overflow-y: scroll</code>を追加する</a>ことで、スクロールバーを強制的に最初に描画できます。このテクニックが役立つ理由は、幅が変更され、アバブ・ザ・フォールドのコンテンツのリフローが生じると、<a href="https://twitter.com/addyosmani/status/1239592160141307905">スクロールバーが大きなレイアウトシフトを引き起こす可能性がある</a>ためです。ただし、このような事態が起きるのは、ほとんどはWindowsのようにオーバーレイではないスクロールバーを導入しているプラットフォームに限られます。なお、上記の仕組みはposition: stickyを無効にしてしまいます。なぜなら、これらの要素は<a href="https://twitter.com/lfredolo/status/1240301405325361152">スクロールによってコンテナの外に出ることがない</a>ためです。</p>
<p>スクロールページの上部に<a href="https://twitter.com/rick_viscomi/status/1311853000542040066">固定されているヘッダや、スティッキーなヘッダを扱う</a>場合は、プレースホルダ要素やコンテンツの <code class="language-text">margin-top</code>などによって、そのヘッダを固定するためのスペースを確保しましょう。cookie同意バナーは例外で、<a href="https://twitter.com/g33konaut/status/1311709596847927296">CLSに影響しないはず</a>ですが、実装によっては影響を与えることがあります。このTwitterスレッドでは興味深い戦略とポイントが紹介されています。</p>
<p>さまざまな量のテキストが含まれる可能性があるタブコンポーネントについては、<a href="https://www.hsablonniere.com/prevent-layout-shifts-with-css-grid-stacks--qcj5jo/">CSSグリッドのスタックによってレイアウトシフトを防ぐ</a>ことができます。各タブのコンテンツを同じグリッドエリアに配置し、それらを一度に1つずつ隠すことで、コンテナが常により大きい要素の高さを取得し、レイアウトシフトが起こらないようにします。</p>
<p>もちろん、リストの下（フッタなど）にコンテンツがある場合は、<a href="https://addyosmani.com/blog/infinite-scroll-without-layout-shifts/">無限のスクロールと「さらに読み込む」もレイアウトシフトを起こす可能性があります</a>。CLSを改善するには、コンテンツを読み込むための十分なスペースを、ユーザがページのその部分までスクロールする前に確保しましょう。また、コンテンツの読み込みによって押し下げられる可能性があるページ下部のフッタやDOM要素を削除しましょう。さらに、画面外のコンテンツ向けのデータと画像を先読みし、ユーザがそこまでスクロールしたときにはすでにコンテンツが表示されているようにしてください。長いリストを最適化するには、<a href="https://github.com/bvaughn/react-window">react-window</a>などのリスト仮想化ライブラリを使用できます（Addy Osmaniに感謝します）。</p>
<p>リフローの影響を確実に抑えるために、<a href="https://wicg.github.io/layout-instability/">Layout Instability API</a>でレイアウトの安定性を測定しましょう。このAPIでは、<a href="https://web.dev/cls/">Cumulative Layout Shift</a>（CLS）スコアを計算し、それをテストの要件に含めることができます。そのため、スコアが悪化したときはいつでも追跡と修正が可能です。</p>
<p>ブラウザはレイアウトシフトのスコアを計算するうえで、ビューポートのサイズに加え、ビューポート内の不安定な要素が2つのレンダリングされたフレーム間でどれだけ移動したかに着目します。スコアは<code class="language-text">0</code>に近いのが理想です。Milica MihajlijaとPhilip Waltonは、<a href="https://web.dev/cls">CLSとその測定方法</a>に関する素晴らしいガイドを公表しています。これは、特にビジネスに必要不可欠なタスクに関して、体感的なパフォーマンスを測定・維持し、混乱を回避するための良い出発点になります。</p>
<p><strong>簡単なtips</strong>：何がレイアウトシフトの原因になっているかをDevToolsで発見するには、パフォーマンスパネルの"Experience"で<a href="https://youtu.be/AQqFZ5t8uNc?t=454">レイアウトシフトについて調べてみましょう</a>。</p>
<p><strong>おまけ</strong>：リフローと再描画を減らしたいなら、Charis Theodoulouの<a href="https://medium.com/better-programming/web-performance-dom-reflow-76ac7c4d2d4f">DOMのリフロー/レイアウトスラッシングを最小限にする</a>ためのガイド、Paul Irishの<a href="https://gist.github.com/paulirish/5d52fb081b3570c81e3a">レイアウト/リフローの要因</a>のリスト、<a href="https://csstriggers.com/">CSSTriggers.com</a>（レイアウト、描画、合成をトリガーするCSSプロパティの参照表）をチェックしてみましょう。</p>
<h2>ネットワーク接続とHTTP/2 <a href="#07">#</a><a name="07"></a></h2>
<h3>61. OCSPステープリングは有効化されているか？</h3>
<p><a href="https://www.digicert.com/enabling-ocsp-stapling.htm">サーバのOCSPステープリングを有効化する</a>ことでTLSハンドシェイクを高速化できます。オンライン証明書状態プロトコル（OCSP）は証明書失効リスト（CRL）プロトコルの代わりとして開発されました。いずれのプロトコルもSSL証明書が失効していないかを確認するために使用されます。</p>
<p>しかし、OCSPプロトコルはブラウザがリストをダウンロードして証明書情報を検索するのに時間を費やす必要がないため、ハンドシェイクに必要な時間が削減されます。</p>
<h3>62. SSL証明書失効の影響を軽減しているか？</h3>
<p>Simon Hearneは、<a href="https://simonhearne.com/2020/drop-ev-certs/">"The Performance Cost of EV Certificates"</a>という記事で、よく使われる証明書の概要に関する素晴らしい説明と、証明書の選択が全体的なパフォーマンスに及ぼす可能性がある影響に関する情報を提供しています。</p>
<p>Simonが書いているとおり、HTTPSの世界では、トラフィックの安全を確保するために複数の種類の証明書認証レベルが使用されています。</p>
<ul>
<li>ドメイン認証（DV）は、証明書の要求者がドメインを所有していることを認証します。</li>
<li>組織認証（OV）は、組織がドメインを所有していることを認証します。</li>
<li>EV認証（EV）は、厳格な認証によって、組織がドメインを所有していることを認証します。</li>
</ul>
<p>重要なのは、これらの証明書が<a href="https://nooshu.github.io/blog/2020/01/26/the-impact-of-ssl-certificate-revocation-on-web-performance/">全てテクノロジーの面では同一</a>であるということです。違うのは証明書で提供される情報と属性だけです。</p>
<p><strong>EV証明書は、人間が証明書をレビューし、その正当性を確認する必要があるため、高価で時間がかかります</strong>。一方、DV証明書は通常、無料で提供されます。例えば<a href="https://letsencrypt.org/how-it-works/">Let’s Encrypt</a>はオープンで自動化された証明書認証機関で、多くのホスティングプロバイダやCDNにうまく統合されています。実際、この記事の執筆時点で、Let’s Encryptは<a href="https://www.abetterinternet.org/documents/2020-ISRG-Annual-Report.pdf">2億2500万件以上のWebサイト</a>（PDF）に対応しています。ただし、これは<a href="https://telemetry.mozilla.org/new-pipeline/dist.html#!cumulative=0&#x26;end_date=2020-01-03&#x26;include_spill=0&#x26;keys=__none__!__none__!__none__&#x26;max_channel_version=beta%252F72&#x26;measure=CERT_EV_STATUS&#x26;min_channel_version=beta%252F71&#x26;processType=*&#x26;product=Firefox&#x26;sanitize=1&#x26;sort_">ページの2.69％</a>(※訳注：現在原文で意図された期間の参照不可)を占めるに過ぎません（Firefoxで開いた場合）。</p>
<p>それでは、どのような問題があるのでしょうか。問題は、<strong>EV証明書は上記のOCSPステープリングを完全にはサポートしていない</strong>ということです。ステープリングは、サーバが、証明書が失効していないことを証明書認証機関に確認し、その情報を証明書に追加（「ステープル」）することを可能にします。ステープリングがなければ、クライアントが全ての作業を実施しなければならず、TLSネゴシエーションの間に不必要なリクエストが生じます。接続状況が良くない場合、これは大きなパフォーマンスコスト（1000ミリ秒以上）を生み出す可能性があります。</p>
<p>EV証明書はWebパフォーマンスの面から見て優れた選択肢ではなく、DV証明書よりもはるかに大きな影響をパフォーマンスに与える可能性があります。最適なWebパフォーマンスのためには、<a href="https://www.aaronpeters.nl/blog/ev-certificates-make-the-web-slow-and-unreliable/">OCSPステープリングに対応したDV証明書を常に提供しましょう</a>。また、EV証明書に比べて大幅に安く、取得するのに労力もあまりかかりません。少なくとも、<a href="https://blog.mozilla.org/security/2020/01/09/crlite-part-1-all-web-pki-revocations-compressed/">CRLite</a>が利用できるようになるまではそうでしょう。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/26ff04ce-929d-49c3-bbf8-08ca71dd2d88/number-quic-handshakes.png">
圧縮が重要：圧縮されていない証明書チェーンの40～43％はサイズが大き過ぎて、1回のQUICフライトにおける3 UDPデータグラムの範囲に収まりません。（画像の出典：<a href="https://www.fastly.com/blog/quic-handshake-tls-compression-certificates-extension-study">Fastly</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/26ff04ce-929d-49c3-bbf8-08ca71dd2d88/number-quic-handshakes.png">プレビューを拡大</a>）</p>
<p><strong>注記</strong>：QUICやHTTP/3の実用化が進むなかで、<a href="https://www.fastly.com/blog/quic-handshake-tls-compression-certificates-extension-study">TLS証明書チェーンがQUICハンドシェイクのバイト容量の大きな部分を占める可変サイズのコンテンツ</a>であることは注目に値します。サイズは数百バイトから10KB超まで変動します。</p>
<p><a href="https://www.fastly.com/blog/quic-handshake-tls-compression-certificates-extension-study">サイズが大きい証明書は複数回のハンドシェイクを発生させる</a>ので、TLS証明書のサイズを小さく保つことは<a href="https://twitter.com/programmingart/status/1229685029468561409">QUICやHTTP/3ではとても重要</a>です。また<a href="https://twitter.com/mcmanusducksong/status/1262452391208792066">証明書は確実に圧縮する</a>必要があります。さもなければ、証明書チェーンのサイズが大き過ぎて1回のQUICフライトに収まらなくなってしまいます。</p>
<p>この問題と解決策については、はるかに詳しい情報やアドバイスが以下で紹介されています。</p>
<ul>
<li><a href="https://www.aaronpeters.nl/blog/ev-certificates-make-the-web-slow-and-unreliable/">EV Certificates Make The Web Slow and Unreliable</a>（Aaron Peters著）</li>
<li><a href="https://nooshu.github.io/blog/2020/01/26/the-impact-of-ssl-certificate-revocation-on-web-performance/">The impact of SSL certificate revocation on web performance</a>（Matt Hobbs著）</li>
<li><a href="https://simonhearne.com/2020/drop-ev-certs/">The Performance Cost of EV Certificates</a>（Simon Hearne著）</li>
<li><a href="https://www.fastly.com/blog/quic-handshake-tls-compression-certificates-extension-study">Does the QUIC handshake require compression to be fast?</a>（Patrick McManus著）</li>
</ul>
<h3>63. IPv6をすでに導入しているか？</h3>
<p><a href="https://en.wikipedia.org/wiki/IPv4_address_exhaustion">IPv4アドレスは枯渇しつつあり</a>、大規模なモバイルネットワークはIPv6を急速に導入しています（米国ではIPv6の導入率が50％の節目に<a href="https://www.google.com/intl/en/ipv6/statistics.html#tab=ipv6-adoption&#x26;tab=ipv6-adoption">ほとんど到達しました</a>）。そのため、将来に向けて万全に備えるために、DNSをIPv6にアップデートするのが賢明でしょう。ただし、ネットワーク全体でデュアルスタックがサポートされるようにしてください。デュアルスタックでは、IPv6とIPv4をお互いに共存させ、これらを同時に実行できます。結局、IPv6には後方互換性がないのです。また、調査によれば、IPv6は近隣探索プロトコル（NDP）と経路最適化によってWebサイトを10～15％高速化します。</p>
<h3>64. 全てのアセットがHTTP/2（またはHTTP/3）で実行されるようにする。</h3>
<p>Googleが過去数年間で<a href="https://security.googleblog.com/2016/09/moving-towards-more-secure-web.html">より安全なHTTPS Webを推進</a>していることを考えると、<a href="https://http2.github.io/faq/">HTTP/2環境</a>への移行に投資するのは間違いなく賢明です。実際、Web Almanacによれば、<a href="https://almanac.httparchive.org/en/2020/http2">リクエスト全体の64％はすでにHTTP/2で実行されています</a>。</p>
<p><a href="https://www.lucidchart.com/techblog/2019/04/10/why-turning-on-http2-was-a-mistake/">HTTP/2が完璧ではなく</a>、<a href="https://github.com/andydavies/http2-prioritization-issues">優先順位づけに問題がある</a>ことを理解するのは重要です。しかし、HTTP/2は<a href="https://caniuse.com/#search=http2">とても広くサポートされており</a>、ほとんどの場合でHTTP/2の導入は改善につながります。</p>
<p>注意すべき点もあります。<a href="https://groups.google.com/a/chromium.org/g/blink-dev/c/K3rYLvmQUBY/m/vOWBKZGoAQAJ">HTTP/2サーバプッシュはChromeから削除される予定</a>であるため、実装がサーバプッシュに依存している場合は見直す必要があるでしょう。その代わりに、<a href="https://www.fastly.com/blog/beyond-server-push-experimenting-with-the-103-early-hints-status-code">Early Hints</a>を導入すると良いかもしれません。Early Hintsは試験的機能としてすでにFastlyに統合されています。</p>
<p>まだHTTPを利用している場合、最も時間がかかるタスクは、<a href="https://https.cio.gov/faq/">まずHTTPSに移行</a>し、それからHTTP/2の多重化と並列化に合わせてビルドプロセスを調整することでしょう。<a href="https://ldnwebperf.org/sessions/bringing-http-2-to-gov-uk/">Bringing HTTP/2 to Gov.uk</a>は、まさにこれを実現した素晴らしいケーススタディで、実現までの過程でCORS、SRI、WPTの課題を解決しています。本記事では今後、読者の皆さんがHTTP/2に移行中か、すでに移行しているという前提で話を進めます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0005ffe6-5517-4f75-b770-5a547059515c/http2-h2-usage-opt.png">
Web Almanacによれば、HTTP/2の正式な標準化からわずか4年で、2020年終わりにHTTP/2で送信されたリクエストの割合は全体の64％となりました。（画像の出典：<a href="https://almanac.httparchive.org/en/2020/http2">Web Almanac</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0005ffe6-5517-4f75-b770-5a547059515c/http2-h2-usage-opt.png">プレビューを拡大</a>）</p>
<h3>65. HTTP/2を適切に導入する。</h3>
<p>繰り返しになりますが、<a href="https://www.youtube.com/watch?v=yURLTwZ3ehk">アセットをHTTP/2で提供する</a>場合、これまでのアセットの提供方法を部分的に見直すことでメリットを得られる可能性があります。モジュールのパッケージ化と、多くの小さなモジュールの読み込みを並行し、両者のバランスをうまく保つことが必要です。しかし、結局は依然として<a href="https://alistapart.com/article/the-best-request-is-no-request-revisited">リクエストがまったくないことが最善</a>であり、アセットの高速な初期デリバリとキャッシングの間でうまくバランスを取ることが目標になります。</p>
<p>一方、全てのアセットを連結するのは避け、代わりにインタフェース全体を多くの小さなモジュールに分割し、それをビルドプロセスの一環として圧縮し、並行して読み込みたい場合もあるかもしれません。それならば、1つのファイルを変更しても、スタイルシート全体やJavaScriptを再びダウンロードする必要はありません。<a href="https://css-tricks.com/musings-on-http2-and-bundling/">パースにかかる時間も最小限となり</a>、個々のページのペイロードを抑えられます。</p>
<p>一方、<a href="https://engineering.khanacademy.org/posts/js-packaging-http2.htm">パッケージ化も依然として重要です</a>。多くの小さいスクリプトを使用すると、<strong>全体的な圧縮にとって悪影響</strong>となり、<a href="https://simonhearne.com/2020/network-faster-than-cache/">キャッシュからオブジェクトを取得するコストが増加します</a>。大きなパッケージを圧縮すると、ディクショナリを再利用できるというメリットがありますが、小さな個別のパッケージにはそのメリットがありません。この問題に対処するための標準化作業も行われていますが、今のところ実用化は遠い先になりそうです。第2に、ブラウザはこうしたワークフローについて<strong>まだ最適化されていません</strong>。例えば、Chromeはリソースの数に応じて<a href="https://www.chromium.org/developers/design-documents/inter-process-communication">プロセス間通信</a>（IPC）をトリガーするため、何百ものリソースを利用するとブラウザのランタイムコストが生じます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- HTTP/2 push this resource, or inline it, whichever's faster --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/site-header.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/article.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/comment.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>comments<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/about-me.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>about-me<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/site-footer.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>HTTP/2で最善の結果を達成するには、ChromeのJake Archibaldが提案しているとおり、<a href="https://jakearchibald.com/2016/link-in-body/">CSSを段階的に読み込む</a>ことを検討しましょう。</p>
<p>それでも、<a href="https://jakearchibald.com/2016/link-in-body/">CSSの段階的な読み込み</a>を目指すことはできます。実際、bodyタグ内のCSSは、<a href="https://twitter.com/patmeenan/status/1037027969842208777">現在はChromeのレンダリングをブロックしません</a>。ただし、<a href="https://twitter.com/csswizardry/status/1133867804380270592">優先順位づけに関する問題がある</a>ため、それほど単純ではありませんが、試してみる価値はあります。</p>
<p><a href="https://daniel.haxx.se/blog/2016/08/18/http2-connection-coalescing/">HTTP/2接続の集約</a>も有効かもしれません。これにより、HTTP/2のメリットを享受しつつ、ドメインシャーディングを行うことが可能です。ただし、現実に実行するのは困難で、一般的には優れた方法とは考えられていません。また、<a href="https://nooshu.github.io/blog/2019/12/17/http2-and-sri-dont-always-get-on/">HTTP/2とサブリソース完全性は必ずしも相性が良くありません</a>。</p>
<p>それでは、どうすれば良いのでしょうか。HTTP/2を利用しているなら、送信する<a href="https://nooshu.github.io/blog/2019/12/17/http2-and-sri-dont-always-get-on/">パッケージを6～10個ほどにする</a>のがまずまずの妥協点であると思われます（古いブラウザから見ても悪くありません）。実験と測定によって、自社のWebサイトにとってちょうど良いバランスを見つけましょう。</p>
<h3>66. 全てのアセットを1回のHTTP/2接続で送信しているか？</h3>
<p>HTTP/2の主な利点の1つは、1回の接続でアセットを送信できることです。しかし、例えばCORSに問題がある、<code class="language-text">crossorigin</code>属性を誤って設定するなどの失敗により、ブラウザが新たな接続を開始しなければならない場合もあります。</p>
<p>全てのリクエストを1回のHTTP/2接続で送信できているか、あるいは何かを誤って設定しているかを確認するには、DevTools → Networkで"Connection ID"欄を有効化しましょう。例えば、以下の図ではmanifest.jsonのみが個別の接続（451）を開始しており、それ以外の全てのリクエストは同じ接続（286）を共有しています。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0bc3d810-23d9-49be-b508-f35977a7143c/devtools-3perf.jpg">
manifest.jsonのみが個別の接続（451）を開始しており、それ以外の全てのリクエストは同じHTTP/2接続（286）を共有しています。<a href="https://twitter.com/iamakulov/status/1275849544341901319">iamakulovより</a>。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0bc3d810-23d9-49be-b508-f35977a7143c/devtools-3perf.jpg">プレビューを拡大</a>）</p>
<h3>67. サーバとCDNはHTTP/2をサポートしているか？</h3>
<p>サーバやCDNによって、（依然として）HTTP/2のサポート状況は異なっています。選択肢をチェックするには<a href="https://cdncomparison.com/">CDN Comparison</a>を使用しましょう。このサイトでは、サーバのパフォーマンスや、サポートが予想される機能をすぐに調べることができます。</p>
<p>Pat Meenanによる<a href="https://blog.cloudflare.com/http-2-prioritization-with-nginx/">HTTP/2の優先順位に関する素晴らしい調査</a>（<a href="https://www.youtube.com/watch?v=ct5MvtmL1NM">動画</a>）を参照し、<a href="https://github.com/pmeenan/http2priorities">サーバがHTTP/2の優先順位づけをサポートしているかテストしましょう</a>。Patによれば、Linux 4.9以降のカーネルでHTTP/2の優先順位づけが高い信頼性で機能するには、BBR輻輳制御を有効化し、<code class="language-text">tcp_notsent_lowat</code>を16KBに設定することが推奨されます（Yoavに感謝します）。Andy Daviesは、複数のブラウザ、<a href="https://github.com/andydavies/http2-prioritization-issues#cdns--cloud-hosting-services">CDN、クラウドホスティングサービス</a>でHTTP/2の優先順位づけに関する同様の調査を実施しました。</p>
<p>一方で、カーネルがTCP BBRをサポートしているかダブルチェックし、可能であれば有効化しましょう。TCP BBRは現在、Google Cloud Platform、<a href="https://aws.amazon.com/blogs/networking-and-content-delivery/tcp-bbr-congestion-control-with-amazon-cloudfront/">Amazon Cloudfront</a>、<a href="https://www.techrepublic.com/article/how-to-enable-tcp-bbr-to-improve-network-speed-on-linux/">Linux</a>（<a href="https://www.linuxbabe.com/ubuntu/enable-google-tcp-bbr-ubuntu">Ubuntu</a>など）で使用されています。</p>
<h3>68. HPACK圧縮を利用しているか？</h3>
<p>HTTP/2を使用している場合、不要なオーバーヘッドを削減できるように、サーバがHTTP応答ヘッダの<a href="https://blog.cloudflare.com/hpack-the-silent-killer-feature-of-http-2/">HPACK圧縮を実装</a>しているかをダブルチェックしましょう。一部のHTTP/2サーバはこうした仕様を完全にサポートしていないケースがあり、HPACKがその例となっています。<a href="https://github.com/summerwind/h2spec">H2spec</a>は（技術的にとても細かい内容であるものの）<a href="https://twitter.com/tunetheweb/status/988196156697169920?s=20">サポート状況をチェックするための素晴らしいツールです</a>。HPACKの圧縮アルゴリズムはとても<a href="https://www.mnot.net/blog/2018/11/27/header_compression">優れており</a>、しかも<a href="https://www.keycdn.com/blog/http2-hpack-compression/">有効</a>です。</p>
<h3>69. サーバのセキュリティーが盤石であることを確認する。</h3>
<p>全てのブラウザによるHTTP/2の実装はTLSを利用しています。そのため、セキュリティー上の警告や、ページの一部の要素が機能しない状況は避けたい場合が多いでしょう。<a href="https://securityheaders.io/">セキュリティヘッダが適切に設定されていること</a>をダブルチェックし、<a href="https://www.smashingmagazine.com/2016/01/eliminating-known-security-vulnerabilities-with-snyk/">既知の脆弱性を排除</a>し、<a href="https://www.ssllabs.com/ssltest/">HTTPS設定を確認</a>しましょう。</p>
<p>また、全ての外部プラグインと追跡スクリプトがHTTPSを通じて読み込まれていること、クロスサイトスクリプティングが不可能であること、<a href="https://www.owasp.org/index.php/HTTP_Strict_Transport_Security_Cheat_Sheet">HTTP Strict Transport Securityヘッダ</a>と<a href="https://content-security-policy.com/">Content Security Policyヘッダ</a>の両方が適切に設定されていることを確かめてください。</p>
<h3>70. サーバとCDNはHTTP/3をサポートしているか？</h3>
<p>HTTP/2はいくつもの面でWebのパフォーマンスに重要な改善をもたらしましたが、まだ大きな改善の余地は残っています。特に<a href="https://youtu.be/SuSpghHP0uI?t=290">TCPのヘッドオブラインブロッキング</a>は、低速なネットワークでは顕著で、大きなパケットロスを生みます。<a href="https://youtu.be/SuSpghHP0uI?t=290">HTTP/3はこうした問題を完全に解決しつつあります</a>（<a href="https://calendar.perfplanet.com/2020/head-of-line-blocking-in-quic-and-http-3-the-details/">記事</a>）。</p>
<p>HTTP/2の問題に対処するために、IETFはGoogle、Akamaiなどとともに新たなプロトコルに取り組んでおり、その成果は<a href="https://tools.ietf.org/html/draft-ietf-quic-http">最近、HTTP/3として標準化されました</a>。</p>
<p>Robin Marxは<a href="https://www.youtube.com/watch?v=SuSpghHP0uI&#x26;feature=youtu.be">HTTP/3について素晴らしい解説</a>をしており、以下の説明は彼の解説に基づくものです。HTTP/3の本質は、機能の面では<strong>HTTP/2にとてもよく似ています</strong>が、内部の仕組みは大きく異なっています。<a href="https://blog.cloudflare.com/http3-the-past-present-and-future/">HTTP/3はいくつもの面で改善されています</a>。ハンドシェイクは高速化し、暗号化は改善され、独立したストリームの信頼性は向上し、暗号化とフローの制御も進歩しています。特に目立つ違いは、HTTP/3がトランスポート層としてQUICを使用しており、TCPではなくQUICパケットがUDPダイアグラムの上部に埋め込まれることです。</p>
<p>QUICはTLS 1.3をプロトコルに完全に統合しています。一方、TCPでは、TLS 1.3はプロトコルに上乗せされます。通常のTCPスタックでは、TCPとTLSがそれぞれ別個にハンドシェイクを行う必要があるため、数回分のラウンドトリップのオーバーヘッドが発生します。しかし、QUICでは<strong>両者を結合し、1回のみのラウンドトリップで完了する</strong>ことができます。TLS 1.3では今後の接続のための暗号化キーを設定できるため、2回目の接続以降は最初のラウンドトリップからすでにアプリケーション層のデータを送受信することができます。これは「0-RTT」と呼ばれます。</p>
<p>また、HTTP/2のヘッダ圧縮アルゴリズムは、優先順位づけのシステムとともに完全に書き直されました。さらにQUICは、各QUICパケットのヘッダの接続IDを通じて、Wi-Fiからセルラーネットワークへの<strong>接続のマイグレーション</strong>をサポートしています。ほとんどの実装は（TCPと同様に）カーネル空間ではなくユーザ空間で行われるため、プロトコルは今後、変化していくでしょう。</p>
<p>これらは全て大きな変化をもたらすのでしょうか。<a href="https://twitter.com/FredKSchott/status/1313913507583193088">その答えはおそらくイエスです</a>。特にモバイルの読み込み時間に影響をもたらすと思われますが、それだけではなく、エンドユーザへのアセットの提供方法にも影響する見込みです。HTTP/2では複数のリクエストが接続を共有しますが、HTTP/3のリクエストは接続を共有するだけでなく独立してストリームを送信するため、脱落したパケットが全てのリクエストに影響することはなくなり、1つのストリームのみに影響するようになります。</p>
<p>これは、1つの大きなJavaScriptバンドルでは、1つのストリームが停止したときにアセットの処理が減速しますが、複数のファイルストリームが並行的に送信される場合（HTTP/3）は影響が軽減されることを意味しています。そのため、<strong>パッケージ化は今も重要です</strong>。</p>
<p>HTTP/3への取り組みは<a href="https://twitter.com/programmingart/status/1311656119450972161">依然として進行中です</a>。Chrome、Firefox、Safariには<a href="https://caniuse.com/http3">すでに実装されています</a>。一部の<a href="https://twitter.com/RobertHoeijmak1/status/1313936281039241216">CDNもQUICとHTTP/3をすでにサポートしています</a>。2020年の終わりに、<a href="https://twitter.com/FredKSchott/status/1313910775199612929">ChromeはHTTP/3とIETF QUICの導入を開始しました</a>。実際、Googleの全てのサービス（Google Analytics、YouTubeなど）はすでにHTTP/3を利用しています。<a href="https://www.litespeedtech.com/products/litespeed-web-server">LiteSpeed Web Server</a>はHTTP/3をサポートしていますが、Apache、NGINX、IISはいずれもHTTP/3をまだサポートしていません。しかし、2021年にはこの状況が急速に変化するでしょう。</p>
<p><strong>結論</strong>：サーバとCDNでHTTP/3を使用するという選択肢があるなら、おそらくそれを選ぶのが非常に賢明でしょう。主なメリットは、特にレイテンシが大きい接続において、複数のオブジェクトを同時に取得できることです。この分野ではあまり調査が行われていないため、確定的なことは分かりませんが、<a href="https://blog.cloudflare.com/http-3-vs-http-2/">最初の調査は大きな期待が持てる結果となっています</a>。</p>
<p>このプロトコルの仕様とメリットについてもっと詳しく知りたい方向けに、優れた出発点としてチェックすべき資料を紹介します。</p>
<ul>
<li><a href="https://http3-explained.haxx.se/">HTTP/3 Explained</a>は、HTTP/3とQUICプロトコルの文書化に向けた共同の取り組みの成果です。さまざまな言語で提供されており、PDFでも利用できます。</li>
<li>Daniel Stenbergは<a href="https://cloudflare.tv/event/2EyYvt1zPHViDAxHMjpIdq">Leveling Up Web Performance With HTTP/3</a>という動画を提供しています。</li>
<li>Robin Marxの<a href="https://www.youtube.com/watch?v=SuSpghHP0uI&#x26;feature=youtu.be">An Academic’s Guide to QUIC</a>という講演では、QUICとHTTP/3プロトコルの基本的な概念を紹介し、HTTP/3がヘッドオブラインブロッキングと接続マイグレーションを処理する方法や、HTTP/3が有用性を保つためにどのように設計されているかについて説明しています（<a href="https://twitter.com/simonhearne/status/1330059997213052932">Simon</a>に感謝します）。</li>
<li>サーバがHTTP/3を利用しているかどうかは<a href="https://http3check.net/">HTTP3Check.net</a>で確認できます。</li>
</ul>
<h2>テストとモニタリング <a href="#08">#</a><a name="08"></a></h2>
<h3>71. 監査ワークフローを最適化しているか？</h3>
<p>適切な設定をすぐ利用できるように準備しておくことは、重要には思えないかもしれませんが、テストの時間をかなり削減できる可能性があります。WebPageTestのパブリックインスタンスにテストを送信するために、Tim Kadlecの<a href="https://github.com/tkadlec/webpagetest-alfred-workflow">WebPageTest向けAlfred Workflow</a>の使用を検討しましょう。実際、WebPageTestにはよく知られていない機能が数多くあります。ですから、<a href="https://nooshu.github.io/blog/2019/10/02/how-to-read-a-wpt-waterfall-chart/">時間を取ってWebPageTestのWaterfall Viewチャートを読む方法</a>と<a href="https://nooshu.github.io/blog/2019/12/30/how-to-read-a-wpt-connection-view-chart/">WebPageTestのConnection Viewチャートを読む方法</a>を学習し、パフォーマンスに関する問題を素早く診断・解決できるようにしましょう。</p>
<p>また、<a href="https://calendar.perfplanet.com/2014/driving-webpagetest-from-a-google-docs-spreadsheet/">WebPageTestをGoogle Spreadsheetから実行する</a>ことや、<a href="https://web.dev/fast/using-lighthouse-ci-to-set-a-performance-budget">アクセシビリティ、パフォーマンス、SEOスコアをLighthouse CIでTravisの設定に組み込む</a>こと、あるいはこれらを<a href="https://twitter.com/addyosmani/statuses/1017655423099289600">Webpackに直接組み込む</a>ことも可能です。</p>
<p>最近リリースされた<a href="https://web.dev/autowebperf/">AutoWebPerf</a>にも注目しましょう。これは複数のソースからパフォーマンスデータを自動的に収集できるモジュラーツールです。例えば、クリティカルなページ上に毎日実行されるテストを設定し、CrUX APIからフィールドデータを、PageSpeed InsightsのLighthouseレポートからラボデータを取得できます。</p>
<p>また、何らかのデバッグを素早く実施する必要があるが、ビルドプロセスがとても遅く感じられる場合は、以下のことに気をつけましょう。「ほとんどのJavaScriptコードの軽量化では、手の込んだコード変換ではなく、<a href="https://slack.engineering/keep-webpack-fast-a-field-guide-for-better-build-performance-f56a5995e8f1">ホワイトスペースの削除とシンボル修飾がサイズ削減の95％を占めています</a>。圧縮を無効化するだけでUglifyのビルドを3～4倍高速化できます」。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/705ed9b1-cd4d-4231-b808-ce8c2e72e070/review-required-checks-pr.png">
Lighthouse CIでTravisの設定に<a href="https://web.dev/fast/using-lighthouse-ci-to-set-a-performance-budget">アクセシビリティ、パフォーマンス、SEOスコア</a>を統合することで、プロジェクトに関与している全ての開発者に新たな機能がどのようなパフォーマンス上の影響を与えるかを明らかにすることができます。（<a href="https://cdn-images-1.medium.com/max/1600/1*Y-1sdlIzFBRfEQPprzLnbA.png">画像の出典</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/705ed9b1-cd4d-4231-b808-ce8c2e72e070/review-required-checks-pr.png">プレビューを拡大</a>）</p>
<h3>72. プロキシブラウザと古いブラウザでテストを実施しているか？</h3>
<p>ChromeとFirefoxでテストをするだけでは不十分です。プロキシブラウザと古いブラウザでWebサイトがどのように動作するかも調べましょう。例えば、UC BrowserとOpera Miniは<a href="https://gs.statcounter.com/#mobile_browser-as-monthly-201511-201611">アジアで大きな市場シェアを獲得しています</a>（アジアで最大35％）。今後、予想外の大きな問題が起きるのを避けるため、ターゲットとする国の平均的なインターネット速度を測定しましょう。ネットワークスロットリングを使用してテストを実施し、高DPIの端末をエミュレートしましょう。<a href="https://www.browserstack.com/">BrowserStack</a>はリモートで実物の端末をテストするための素晴らしいツールです。オフィスで少なくとも数台の実物の端末をテストすることで、BrowserStackのテスト結果を補完することには価値があります。</p>
<h3>73. 404ページのパフォーマンスをテストしているか？</h3>
<p>通常、404ページについてよく考えることはありません。クライアントがサーバに存在しないページをリクエストしたとき、サーバは404ステータスコードと、関連する404ページを返します。それだけのことではないのでしょうか。</p>
<p>404応答において重要なのは、ブラウザに送信される実際の<strong>応答の本文サイズ</strong>です。<a href="https://nooshu.github.io/blog/2020/08/25/you-should-be-testing-your-404-pages-web-performance/">Matt Hobbsの404ページの調査</a>によると、404応答の大部分は、失われたファビコン、WordPressのアップロードリクエスト、壊れたJavaScriptリクエスト、マニフェストファイル、CSSとフォントファイルに由来します。クライアントは、存在しないアセットをリクエストするたびに404応答を受け取ります。その応答のサイズはとても大きいことが多いのです。</p>
<p>404ページの<strong>キャッシング戦略</strong>を確実に検証し、最適化しましょう。目標は、ブラウザがHTML応答を予期しているときにのみHTMLをブラウザに提供し、その他の全ての応答には小規模なエラーのペイロードを返すことです。Mattによれば、「CDNをオリジンの前に配置した場合、CDN上に404ページ応答をキャッシュできる可能性があります。これは便利だと言えます。なぜなら、そうしなければ、404ページへのアクセスが、オリジンサーバを全ての404リクエストに応答させることによるDoS攻撃の経路として利用される可能性があるからです。この攻撃には、オリジンサーバの代わりに、CDNがキャッシュ済みのバージョンによって応答することで対応できます」。</p>
<p>404エラーはパフォーマンスに悪影響を及ぼすだけでなく、トラフィックのコストを大きくします。ですから、Lighthouseのテストに404エラーページを含め、そのスコアを時系列で追跡するのは良いアイデアだと言えます。</p>
<h2>74. GDPR同意プロンプトのパフォーマンスをテストしているか？</h2>
<p>現在は一般データ保護規則（GDPR）とカリフォルニア州消費者プライバシー法（CCPA）の時代であり、EUの顧客向けにトラッキングのオプトインとオプトアウトの選択肢を提供するためにサードパーティを利用することが一般的となりました。しかし、他のあらゆるサードパーティスクリプトと同様に、GDPRに関するサードパーティのパフォーマンスは、パフォーマンス向上のための取り組み全体にとても破壊的な影響をもたらす可能性があります。</p>
<p>もちろん、実際に顧客が同意するかどうかによって、スクリプトがパフォーマンス全体にもたらす影響は変わるでしょう。そこで、<a href="https://twitter.com/boostmarks/status/1255867669255000064">Boris Schapira</a>が述べているとおり、以下のさまざまなケースのWebパフォーマンスを調べるのが良いかもしれません。</p>
<ul>
<li>同意が完全に拒否された場合</li>
<li>同意が部分的に拒否された場合</li>
<li>完全な同意が得られた場合</li>
<li>ユーザが同意プロンプトに反応しなかった場合（またはプロンプトがコンテンツブロッカによってブロックされた場合）</li>
</ul>
<p>通常、cookie同意プロンプトは<a href="https://twitter.com/g33konaut/status/1311709596847927296">CLSに影響を与えないはず</a>ですが、<a href="https://twitter.com/rnebhwani/status/1315016813651128320">場合によっては影響を与えます</a>。ですから、無料のオープンソースオプションである<a href="https://www.osano.com/cookieconsent">Osano</a>や<a href="https://github.com/adriandmitroca/cookie-consent-box">cookie-consent-box</a>の使用を検討しましょう。</p>
<p>一般的に、<strong>ポップアップのパフォーマンス</strong>は検討に値します。マウスイベントの縦や横のオフセットを決定したり、ポップアップをアンカーに対して適切に設置したりする必要があるからです。Noam Rosenthalは、<a href="https://techblog.wikimedia.org/2020/11/23/web-performance-case-study-wikipedia-page-previews/">Web performance case study: Wikipedia page previews</a>という記事でWikimediaチームの教訓を共有しています（<a href="https://www.youtube.com/watch?v=sKvK3x9zdt0&#x26;feature=youtu.be">動画</a>と<a href="https://docs.google.com/document/d/e/2PACX-1vR3QYysQvaeXyVD4ObCjqbhGq-yFnBXfBQAiWQrTImKOF2pnGuwLumqYMvmrPaWPHnGP9ENjwlcVNNT/pub">議事録</a>も提供されています）。</p>
<h3>75. パフォーマンス診断CSSを保持しているか？</h3>
<p>パフォーマンスが悪いコードが導入されていないかを調べるには、あらゆる種類のチェック方法を採用することができます。簡単に解決できて、すぐに一定の成果を上げられる問題を手早く知れれば、役に立つことが多いはずです。これに関しては、Tim Kadlecの素晴らしい<a href="https://gist.github.com/tkadlec/683b26344cde774170b94c0fcf0088b4">Performance Diagnostics CSS</a>（<a href="https://twitter.com/csswizardry/status/1346477682544951296">Harry Robertsのスニペット</a>にインスパイアされたものです）を使用できます。これは、読み込みが遅い画像、寸法が合っていない画像、古い形式の画像、同期スクリプトを明らかにするものです。</p>
<p>例えば、<a href="https://twitter.com/csswizardry/status/1346477682544951296">アバブ・ザ・フォールドのどの画像の読み込みも遅延しないようにしたい</a>とします。この場合、使われていないWebフォントをハイライトする、アイコンのフォントを検知するなど、ニーズに合わせてスニペットをカスタマイズすることが可能です。この小規模なツールは、デバッグの間にミスを可視化したり、単純に現在のプロジェクトをとても高速に監査したりできる素晴らしい存在です。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* Performance Diagnostics CSS */</span>
<span class="token comment">/* via Harry Roberts. https://twitter.com/csswizardry/status/1346477682544951296 */</span>
<span class="token selector">img[loading=lazy]</span> <span class="token punctuation">{</span>
  <span class="token property">outline</span><span class="token punctuation">:</span> 10px solid red<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>76. アクセシビリティへの影響をテストしているか？</h3>
<p>ブラウザはページの読み込みを開始するときにDOMを構築します。スクリーンリーダが実行中であるなど、ユーザ援助技術が存在する場合は、アクセシビリティツリーも作成します。スクリーンリーダは、アクセシビリティツリーに対するクエリを行って情報を取得し、それをユーザに提供します。情報提供はデフォルトで行われたり、要求に応じて行われたりします。これには時間がかかることがあります。</p>
<p>Time to Interactiveの速さは通常、ユーザがリンクやボタンをクリックしたり、タップしたりすることによって、どれだけ速くページとのインタラクションができるかという指標を意味します。スクリーンリーダの場合、意味は少し変わります。この場合、Time to Interactiveの速さは、スクリーンリーダが任意のページの<strong>ナビゲーションを読み上げ</strong>、ユーザがインタラクションのために実際にキーボードを打てるまでにどれだけの時間が経過するかを意味します。</p>
<p>Léonie Watsonは、<a href="https://www.youtube.com/watch?v=n1sXj9oAXFU">アクセシビリティのパフォーマンス</a>、特に読み込みの遅さがスクリーンリーダの読み上げの遅延に与える影響について、驚くべき講演を実施しています。スクリーンリーダは、速いペースの読み上げや高速なナビゲーションに慣れているため、視力があるユーザよりもせっかちな可能性さえあります。</p>
<p>JavaScriptによるサイズが大きいページやDOMの操作は、スクリーンリーダの読み上げが遅延する原因となります。この分野はまだまだ未開拓ですが、スクリーンリーダはほとんどのプラットフォームで利用できるため（Jaws、NVDA、Voiceover、Narrator、Orca）、ある程度の注意を払い、テストを行うことが必要でしょう。</p>
<h3>77. 継続的モニタリングを設定しているか？</h3>
<p><a href="https://www.webpagetest.org/">WebPageTest</a>のプライベートインスタンスの設定は、高速で制約がないテストを実現するうえで常にメリットがあります。しかし、<a href="https://www.sitespeed.io/">Sitespeed</a>、<a href="https://calibreapp.com/">Calibre</a>、[SpeedCurve][https://speedcurve.com/]などの継続的モニタリングツールと自動アラートならば、パフォーマンスの全体像をもっと詳しく知ることができます。独自のUser Timingの測定ポイントを設定し、自社のビジネスに固有の指標を測定・モニタリングしましょう。また、時系列の変化をモニタリングするため、<a href="https://calendar.perfplanet.com/2017/automating-web-performance-regression-alerts/">自動化されたパフォーマンス悪化アラート</a>の追加を検討しましょう。</p>
<p>時系列のパフォーマンスの変化をモニタリングするため、RUMソリューションの使用を検討してみてください。ユニットテストと同様の読み込みテストを自動化するツールとして、<a href="https://github.com/loadimpact/k6">k6</a>とそのスクリプティングAPIが使用できます。<a href="https://speedtracker.org/">SpeedTracker</a>、<a href="https://github.com/GoogleChrome/lighthouse">Lighthouse</a>、<a href="https://calibreapp.com/">Calibre</a>もチェックしてみましょう。</p>
<h2>手軽に成果を上げる <a href="#09">#</a><a name="09"></a></h2>
<p>このリストはとても包括的なので、全ての最適化を完了するにはかなりの時間がかかるかもしれません。もし1時間だけで大きな改善を実現する必要があるとしたら、何をすべきでしょうか。そこで、リスト全体を<strong>17の手軽に達成できる項目</strong>にまとめてみました。もちろん、最適化の開始前と終了後に結果を測定するようにしてください。測定対象には3G接続と有線接続のLargest Contentful PaintとTime to Interactiveが含まれます。</p>
<ol>
<li>現実世界のユーザ体験を測定し、適切な目標を設定する。最も速い競合サイトよりも20％以上速くなることを目指す。低速な3GでLargest Contentful Paint ＜ 2.5秒、First Input Delay ＜ 100ミリ秒、Time to Interactive ＜ 5秒、リピート訪問の場合はTTI ＜ 2秒を維持する。少なくともFirst Contentful PaintとTime To Interactiveを最適化する。</li>
<li><a href="https://squoosh.app/">Squoosh</a>、<a href="https://github.com/mozilla/mozjpeg">mozjpeg</a>、<a href="https://github.com/google/guetzli">guetzli</a>、<a href="https://css-ig.net/pingo">pingo</a>、<a href="https://jakearchibald.github.io/svgomg/">SVGOMG</a>で画像を最適化し、画像CDNでAVIF/WebPを提供する。</li>
<li>主要なテンプレート向けのクリティカルCSSを準備し、それを各テンプレートの<code class="language-text">&lt;head&gt;</code>に埋め込む。CSS/JSについては、クリティカルなファイルの容量を、<a href="https://infrequently.org/2017/10/can-you-afford-it-real-world-web-performance-budgets/">gzip形式の圧縮後で最大170KBのバジェットに収める</a>（解凍すると0.7MB）。</li>
<li>スクリプトの縮小、最適化、遅延、遅延読み込みを行う。バンドラの設定に注力し、冗長性を削除し、別の軽い選択肢を探す。</li>
<li>いつでも静的アセットをセルフホストし、サードパーティアセットをなるべくセルフホストする。サードパーティのスクリプトの影響を抑える。ファサードを使用し、インタラクション時にウィジェットを読み込む。ちらつきを防ぐためのスニペットに気をつける。</li>
<li>フレームワークを選択するときは対象を絞り込む。シングルページアプリケーションについては、クリティカルなページを特定し、それを静的に提供する、あるいは少なくともプリレンダリングする。さらに、コンポーネントのレベルでプログレッシブハイドレーションを使用し、インタラクション時にモジュールをインポートする。</li>
<li>クライアントサイドのレンダリングのみでは、パフォーマンスにとって良い選択とは言えない。ページがあまり変化しない場合はプリレンダリングを行い、可能ならばフレームワークの起動を遅らせる。可能な場合はストリーミングサーバサイドレンダリングを使用する。</li>
<li><code class="language-text">&lt;script type=&quot;module&quot;&gt;</code>と<a href="https://philipwalton.com/articles/using-native-javascript-modules-in-production-today/">module/nomoduleパターン</a>によって、古いコードは古いブラウザのみに提供する。</li>
<li>CSSルールの再グループ化を試し、bodyタグ内のCSSをテストする。</li>
<li>リソースヒントを追加し、比較的高速な<code class="language-text">dns-lookup</code>、<code class="language-text">preconnect</code>、<code class="language-text">prefetch</code>、<code class="language-text">preload</code>、<code class="language-text">prerender</code>によってデリバリを高速化する。</li>
<li>Webフォントをサブセット化し、非同期で読み込む。最初のレンダリングを高速化するため、CSSで<code class="language-text">font-display</code>を使用する。</li>
<li>HTTPキャッシュヘッダとセキュリティヘッダが適切に設定されていることを確認する。</li>
<li>サーバ上のBrotli圧縮を有効化する（不可能である場合、少なくともgzip圧縮を確実に有効化する）。</li>
<li>サーバがLinuxカーネルのバージョン4.9以降で実行されている場合、TCP BBRによる輻輳制御を有効化する。</li>
<li>可能な場合、OCSPステープリングとIPv6を有効化する。常にOCSPステープリングされたDV証明書を提供する。</li>
<li>HTTP/2向けのHPACK圧縮を有効化し、利用できる場合はHTTP/3に移行する。</li>
<li>フォント、スタイル、JavaScript、画像などのアセットをサービスワーカのキャッシュにキャッシングする。</li>
</ol>
<h2>チェックリストのダウンロード（PDF、Apple Pages）<a href="#10">#</a><a name="10"></a></h2>
<p>このチェックリストを念頭に置けば、どんな種類のフロントエンドのパフォーマンス最適化プロジェクトにも備えることができるでしょう。すぐに印刷できるPDF版や、ニーズに合わせてカスタマイズできる<strong>編集可能なApple Pagesドキュメント</strong>版のチェックリストをお気軽にダウンロードしてください。</p>
<ul>
<li><a href="https://www.dropbox.com/s/34noajrbm324iai/performance-checklist-1.4.pdf?dl=0">PDFでチェックリストをダウンロードする</a>（PDF、166KB）</li>
<li><a href="https://www.dropbox.com/s/ikuk5ikcxxv39uu/performance-checklist-1.4.pages?dl=0">Apple Pagesでチェックリストをダウンロードする</a>（.pages、275KB）</li>
<li><a href="https://www.dropbox.com/scl/fi/s7ctdj89zd5zlvtt7dkhi/performance-checklist-1.4.docx?dl=0&#x26;rlkey=2xzs55e3kdg1jcraw5u1tnpl8">MS Wordでチェックリストをダウンロードする</a>（.docx、151KB）</li>
</ul>
<p>他の選択肢が必要ならば、<a href="https://github.com/drublic/checklist">Dan Rublicのフロントエンドチェックリスト</a>、Jon Yablonskiの"<a href="https://jonyablonski.com/designers-wpo-checklist/">Designer’s Web Performance Checklist</a>"、<a href="https://github.com/thedaviddias/Front-End-Performance-Checklist">FrontendChecklist</a>もチェックしてみましょう。</p>
<h2>さあ、始めよう！<a href="#11">#</a><a name="11"></a></h2>
<p>一部の最適化は、業務や予算の範囲を超えていたり、処理すべきレガシーコードに対して行き過ぎていたりするかもしれません。それでも大丈夫です。このチェックリストは一般的な（願わくば包括的な）ガイドとして使用し、皆さんの状況に合った独自の課題リストを作成してください。しかし、最も重要なのは、最適化の前にプロジェクトをテスト・測定して課題を特定することです。皆さんの2021年のパフォーマンス最適化が良い結果を生みますように！</p>
<hr>
この記事をレビューしてくれたGuy Podjarny、Yoav Weiss、Addy Osmani、Artem Denysov、Denys Mishunov、Ilya Pukhalski、Jeremy Wagner、Colin Bendell、Mark Zeman、Patrick Meenan、Leonardo Losoviz、Andy Davies、Rachel Andrew、Anselm Hannemann、Barry Pollard、Patrick Hamann、Gideon Pyzer、Andy Davies、Maria Prosvernina、Tim Kadlec、Rey Bango、Matthias Ott、Peter Bowyer、Phil Walton、Mariana Peralta、Pepijn Senders、Mark Nottingham、Jean Pierre Vincent、Philipp Tellis、Ryan Townsend、Ingrid Bergman、Mohamed Hussain S. H.、Jacob Groß、Tim Swalling、Bob Visser、Kev Adamson、Adir Amsalem、Aleksey Kulikov、Rodney Rehm、ならびに、パフォーマンス最適化の取り組みから学んだテクニックと教訓を誰もが使えるように共有してくれたすてきなコミュニティに心から感謝します。皆さんは本当に最高です。<p></p>
<p><em>※編注：本記事は2021年4月時点に公開されていた原文記事を翻訳した内容となります。翻訳記事公開にあたり、2023年6月時点で原文にてリンク切れとなっている箇所の削除や注記、原文に現在表示されていない内容を掲載している場合がございます。ご了承ください。</em></p>]]></content:encoded></item></channel></rss>