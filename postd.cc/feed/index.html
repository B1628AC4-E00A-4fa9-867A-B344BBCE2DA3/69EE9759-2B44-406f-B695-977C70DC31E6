<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア]]></title><description><![CDATA[POSTD は、ニジボックスが運営する、エンジニアに向けたキュレーションメディアです。ニジボックスはWebサービスの企画、制作、開発、運用を一貫して担うリクルートの100%子会社です。 リクルートグループのオンラインサービスをはじめ、様々な業種・業界・業態のサービス開発を行っております。]]></description><link>https://postd.cc</link><generator>GatsbyJS</generator><lastBuildDate>Mon, 25 Dec 2023 02:01:25 GMT</lastBuildDate><language>ja</language><atom:link href="https://postd.cc/feed/" rel="self" type="application/rss+xml"/><image><title>POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア</title><link>https://postd.cc</link></image><item><title><![CDATA[Next.jsを4年間使用してたどりついた、エンタープライズアプリケーションのフロントエンド開発・構築手法]]></title><description><![CDATA[はじめに 目まぐるしく進化するフロントエンド開発の世界では、常に最新の知識や技術をいち早く取り入れることが、エンタープライズアプリケーションの開発を成功させる上で欠かせません。Tailwind CS…]]></description><link>https://postd.cc/how-i-approach-and-structure-enterprise-frontend-applications-after-4-years-of-using-nextjs/</link><guid isPermaLink="false">https://postd.cc/how-i-approach-and-structure-enterprise-frontend-applications-after-4-years-of-using-nextjs/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[Next.js]]></category><category><![CDATA[TypeScript]]></category><category><![CDATA[JavaScript]]></category><category><![CDATA[React]]></category><pubDate>Mon, 25 Dec 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<h2>はじめに</h2>
<p>目まぐるしく進化するフロントエンド開発の世界では、常に最新の知識や技術をいち早く取り入れることが、エンタープライズアプリケーションの開発を成功させる上で欠かせません。Tailwind CSS、TypeScript、Turborepo、ESLint、React Queryなどを含む強力なツールキットとNext.jsを<strong>4</strong>年間使用してきた結果、開発に役立つさまざまな知見やベストプラクティスが得られました。この記事では、大企業向けフロントエンドアプリケーションのパフォーマンス、保守性、拡張性を最大限に高める設計・構築手法を紹介したいと思います。</p>
<p><strong>注記</strong>：ここに記載する内容はあくまでも個人的な見解であり、筆者が推奨する手法が必ずしも適さない場合もあります。</p>
<h2>効果的なエンタープライズ向けフロントエンドアーキテクチャの基本原則</h2>
<p>エンタープライズ規模のアプリケーション向けにフロントエンドソリューションを設計する場合、基本原則を明確に定めておくことで開発作業の方向性を示すことができます。このセクションでは、エンタープライズ環境において筆者が実際にNext.jsを使用してきた経験を踏まえた基本原則を紹介します。</p>
<h3>モジュール性とコンポーネント化</h3>
<p><em>原則：分割統治</em></p>
<p>大規模なエンタープライズアプリケーションでは、コードはすぐに肥大化し、手に負えなくなってしまいます。モジュール性を備えたフロントエンド設計により、コードを扱いやすい大きさのコンポーネントに分割しましょう。コンポーネントはブロック玩具のように、それぞれ特定の役割を担います。そのため、コンポーネント化することでコードを再利用しやすくなるだけでなく、保守や開発チーム内での連携が容易になります。また、アプリケーションを小さなコンポーネントに分割するだけでなく、独立した小さなアプリケーションに分割できないか検討しましょう。それには、Turborepoなどのツールが役立ちます。</p>
<h3>関心の分離（SOC）</h3>
<p><em>原則：コードベースを整理する</em></p>
<p>コードの健全性を保つため、関心の分離（SoC）の原則に従いましょう。UIのレンダリング、ビジネスロジックの処理、状態（ステート）の管理といった各コンポーネントの役割を、それぞれ明確に分離します。そうすることで、コードが分かりやすくなるだけでなく、テストやデバッグを行いやすくなります。</p>
<h3>スケーラブルな設計</h3>
<p><em>原則：拡張に備える</em></p>
<p>エンタープライズアプリケーションは静的ではなく、進化します。スケーラビリティを念頭に置きながらフロントエンドアーキテクチャを設計しましょう。これはつまり、トラフィックやデータ量の増大、機能の複雑化に対応できるパターンやツールを選ぶということです。Next.jsはスケーラビリティに対応可能な設計になっているため、その点においても有益です。</p>
<h3>保守性とコード品質</h3>
<p><em>原則：丁寧にコーディングする</em></p>
<p>コードは製品の土台です。最初から保守性とコード品質を重視し、コーディング規約を定め、コードレビューを実施し、テスト自動化に投資しましょう。管理の行き届いたコードベースは作業しやすいだけでなく、バグやリグレッションが発生しにくくなります。筆者は最近、フロントエンドアプリケーションのコーディング規約を順守させるため、<a href="https://ui.fin.africa/?path=/docs/foundations-guidelines--docs">コンポーネントライブラリと簡単なスタイルガイド</a>を作成しました。ドキュメントはまだ完成していないので、あしからず😂.</p>
<h2>アクセシビリティの標準化</h2>
<p><em>原則：最初からインクルーシブデザイン</em></p>
<p>モダンWeb開発において、アクセシビリティは絶対条件です。最初からアクセシビリティの高いWeb開発を実践しましょう。障がいの有無にかかわらず、誰もがアプリケーションを利用できるようにします。アクセシビリティの基準や、インクルーシブなユーザーエクスペリエンスを生み出すためのツールについては、Next.jsのサポートが役立ちます。筆者は、タブやドロップダウンなどアクセシビリティへの配慮が必要なコンポーネントには、<a href="https://www.radix-ui.com/">Radix UI</a>などのツールを使用します。</p>
<h3>パフォーマンス重視の開発</h3>
<p><em>原則：スピードは重要</em></p>
<p>エンタープライズユーザーはスピードを求めています。あらゆる場面でパフォーマンスを重視しましょう。アセットを最適化し、不要なリクエストを最小限に減らし、自動コード分割、Suspenseを使ったストリーミング、画像最適化といったNext.jsのパフォーマンス機能を活用します。素早く動くアプリケーションはユーザーの満足度が高いだけでなく、SEOにも好影響を与えます。</p>
<h3>セキュリティ第一</h3>
<p><em>原則：城を守る</em></p>
<p>フロントエンドアーキテクチャの構造の中にセキュリティを組み込み、クロスサイトスクリプティング（XSS）やクロスサイトリクエストフォージェリ（CSRF）などの一般的な脆弱性から守りましょう。セキュリティアップデートやベストプラクティスの実践を怠らず、Next.jsに組み込まれたセキュリティ機能は予備的な防御層とみなします。</p>
<h3>国際化（i18n）と地域化（l10n）</h3>
<p><em>原則：グローバルな視点で考える</em></p>
<p>つながりあったこの世界では、グローバルな視点で考えることが不可欠です。多様なユーザーに対応するため、最初から国際化（i18n）と地域化（l10n）を実施しましょう。Next.jsはこれらの機能のサポートが充実しているため、多言語アプリケーションの作成を容易にします。</p>
<p>これらの基本原則は、Next.jsを使用して効果的なエンタープライズ向けフロントエンドアーキテクチャを構築する上での土台を形成します。大規模アプリケーションの要求に沿って開発作業を進め、強固で保守性に優れ、使いやすいアプリケーションを開発できるよう、羅針盤の役割を果たします。以下のセクションでは、これらの原則を実践的な戦略やベストプラクティスに落とし込む方法を詳しく見ていきます。</p>
<h2>フォルダとファイル構造</h2>
<p>Reactでは、綿密に考えられたフォルダ構造によってプロジェクトを整理することが、保守性とスケーラビリティを実現する上で重要です。アプローチとしては、機能や目的に応じてファイルを整理する方法が一般的です。筆者が自分のアプリケーションでよく使用するフォルダ構造をサンプルとして紹介します。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">├─ src/
│ ├─ components/
│ │ ├─ ui/
│ │ │ ├─ Button/
│ │ │ ├─ Input/
│ │ │ ├─ ...
│ │ │ └─ index.tsx
│ │ ├─ shared/
│ │ │ ├─ Navbar/
│ │ └─ charts/
│ │ │ ├─ Bar/
│ ├─ modules/
│ │ ├─ HomePage/
│ │ ├─ ProductAddPage/
│ │ ├─ ProductPage/
│ │ ├─ ProductsPage/
│ │ │ ├─ api/
│ │ │ │ └─ useGetProducts/
│ │ │ ├─ components/
│ │ │ │ ├─ ProductItem/
│ │ │ │ ├─ ProductsStatistics/
│ │ │ │ └─ ...
│ │ │ ├─ utils/
│ │ │ │ └─ filterProductsByType/
│ │ │ └─ index.tsx
│ │ ├─ hooks/
│ │ ├─ consts/
│ │ └─ types/
│ │ └─ lib/
| | └─ styles/
│ │ │ ├─ global.css
│ │ └─ ...
│ ├─ public/
│ │ ├─ ...
│ │ └─ index.tsx
│ ├─ eslintrc.js
│ ├─ package.json
│ └─ tsconfig.json
└─ ...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li><strong>src/components</strong>: このディレクトリにはUIコンポーネントを格納します。さらに、一般的なUIコンポーネントを格納する<code class="language-text">ui</code>と、アプリケーションの他の部分で再利用する可能性のあるコンポーネントを格納する<code class="language-text">shared</code>に分かれています。</li>
<li><strong>src/modules</strong>: このディレクトリには、アプリケーションのさまざまなモジュールやページを格納します。モジュールごとにフォルダが分かれ、APIコール、コンポーネント、ユーティリティ機能のためのサブディレクトリが含まれる場合があります。</li>
<li><strong>src/pages</strong>: Next.jsを使用している場合、このフォルダはアプリケーションのエントリーポイントとしてのみ使用します。ここにはビジネスロジックは格納しません。pagesフォルダに格納されたコンポーネントは、必ずmodulesフォルダからページをレンダリングします。</li>
<li><strong>src/modules/ProductsPage</strong>: このモジュールは製品に関連し、APIコール、コンポーネント（<code class="language-text">ProductItem</code>や<code class="language-text">ProductsStatistics</code>など）、ユーティリティ機能（<code class="language-text">filterProductsByType</code>）のサブディレクトリが含まれます。</li>
<li><strong>src/lib</strong>: このフォルダには、後でパッケージに変換し、複数のアプリケーションで使用することができるユーティリティ機能を格納します。後でパッケージに変換することのないユーティリティ機能を格納する<strong>src/utils</strong>とは異なります。</li>
<li><strong>src/styles</strong>: このディレクトリには、グローバルスタイル（<code class="language-text">global.css</code>）や、スタイルに関連するその他のファイルを格納します。</li>
<li><strong>src/public</strong>: このフォルダには、ビルドプロセスで使用しない画像、フォント、<code class="language-text">index.html</code>ファイルなどの静的アセットを格納します。</li>
<li><strong>src/consts, src/types</strong>: これらのディレクトリには、それぞれ定数とTypeScriptの型定義を格納します。</li>
<li><strong>src/hooks</strong>: このディレクトリには、アプリケーション全体で使用するカスタムフックを格納します。</li>
<li><strong>eslintrc.js</strong>: これは、よく知られたJavaScript用構文チェックツールであるESLintの設定ファイルです。コーディング規約を適用し、コードの間違いを見つけるために使用します。</li>
</ul>
<p><code class="language-text">tsconfig</code>ファイルは、例えば<code class="language-text">Button</code>コンポーネントをインポートしたい場合、<code class="language-text">import { Button } from &#39;@/components/ui&#39;</code>のように指定してインポートできるよう設定されています。これを<code class="language-text">tsconfig.json</code>から設定するためのコードスニペットを以下に示します。</p>
<div class="gatsby-highlight" data-language="jsonc"><pre style="counter-reset: linenumber NaN" class="language-jsonc line-numbers"><code class="language-jsonc">{
  ...
  &quot;compilerOptions&quot;: {
    &quot;baseUrl&quot;: &quot;.&quot;,
    &quot;paths&quot;: {
      &quot;@/*&quot;: [&quot;./src/*&quot;]
    }
  }
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>TypeScriptのコーディング規約</h2>
<p>筆者が使用する規約は<a href="https://mkosir.github.io/typescript-style-guide/">こちら</a>のガイドに基づいています。ぜひ一読してみてください。以下のコードスニペットはこのガイドからの抜粋です。</p>
<h4>型は全て型エイリアスで定義する</h4>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token comment">// ❌ Avoid interface definitions unless you need to extend or implement them</span>

<span class="token keyword">interface</span> <span class="token class-name">UserRole</span> <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">|</span> <span class="token string">'guest'</span><span class="token punctuation">;</span> <span class="token comment">// invalid - interface can't define (commonly used) type unions</span>

<span class="token keyword">interface</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  role<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token operator">|</span> <span class="token string">'guest'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ✅ Use type definition</span>
<span class="token keyword">type</span> <span class="token class-name">UserRole</span> <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">|</span> <span class="token string">'guest'</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">UserInfo</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  role<span class="token operator">:</span> UserRole<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>複数の引数の使用を避ける</h4>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token comment">// ❌ Avoid having multiple arguments</span>
<span class="token function">transformUserInput</span><span class="token punctuation">(</span><span class="token string">'client'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ✅ Use options object as argument</span>
<span class="token function">transformUserInput</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'client'</span><span class="token punctuation">,</span>
  isValidated<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  minLines<span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
  maxLines<span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
  defaultInput<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  shouldLog<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  timeout<span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>命名規則</h4>
<p>最適な名前を決めるのは難しいものですが、既定の規則に従い、今後作業する開発者のためにコードの可読性を高め、一貫性を保つよう努めましょう。</p>
<h4>変数・定数</h4>
<ul>
<li><strong>ローカル変数</strong>　<code class="language-text">products</code>をキャメルケースで記述する（<code class="language-text">productsFiltered</code>）</li>
<li><strong>ブール型変数</strong>　<code class="language-text">is</code>や<code class="language-text">has</code>などの接頭辞を先頭に付ける（<code class="language-text">isDisabled</code>、<code class="language-text">hasProduct</code>）</li>
<li><strong>定数</strong>　大文字で記述（<code class="language-text">PRODUCT_ID</code>）</li>
<li><strong>オブジェクト型の定数</strong></li>
</ul>
<p>単数形を使用し、大文字で記述します。constアサーション（as const）を使用し、任意でsatisfies演算子を使用して型（その型が存在する場合）にマッチするかチェックします。</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript">  <span class="token keyword">const</span> <span class="token constant">ORDER_STATUS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    pending<span class="token operator">:</span> <span class="token string">'pending'</span><span class="token punctuation">,</span>
    fulfilled<span class="token operator">:</span> <span class="token string">'fulfilled'</span><span class="token punctuation">,</span>
    error<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span> satisfies OrderStatus<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>関数</h4>
<p>キャメルケース</p>
<p><code class="language-text">filterProductsByType</code>, <code class="language-text">formatCurrency</code></p>
<h4>ジェネリクス</h4>
<p><code class="language-text">TRequest</code>、<code class="language-text">TFooBar</code>のように先頭に大文字のTが付きます（<a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.dictionary-2?view=net-5.0">.Netの内部</a>実装と同様)。</p>
<p>よく使われる規約ではありますが、ジェネリクスを<code class="language-text">T</code>や<code class="language-text">K</code>など1文字で命名するのは避けましょう。変数が増えれば増えるほど、間違いやすくなります。</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token comment">// ❌ Avoid naming generics with one character</span>
<span class="token keyword">const</span> createPair <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">K</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span><span class="token operator">></span><span class="token punctuation">(</span>first<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> second<span class="token operator">:</span> <span class="token constant">K</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">K</span><span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> second<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pair <span class="token operator">=</span> <span class="token function">createPair</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ✅ Name starts with the capital letter T</span>
<span class="token keyword">const</span> createPair <span class="token operator">=</span> <span class="token operator">&lt;</span>TFirst<span class="token punctuation">,</span> TSecond <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">string</span></span><span class="token operator">></span><span class="token punctuation">(</span>
  first<span class="token operator">:</span> TFirst<span class="token punctuation">,</span>
  second<span class="token operator">:</span> TSecond
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span>TFirst<span class="token punctuation">,</span> TSecond<span class="token punctuation">]</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> second<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pair <span class="token operator">=</span> <span class="token function">createPair</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>パッケージとツール</h2>
<p>アプリケーションの開発では、作業の不要な重複を避けるため、一般的にサードパーティツールを活用します。筆者がスケーラブルなアプリケーションをビルドする際に使用するパッケージをいくつか紹介します。</p>
<h4>React Query/TanStack Query</h4>
<p>React Queryは、複雑なエンタープライズアプリケーションにおけるデータフェッチや同期化を管理するのに非常に便利です。APIからのデータフェッチやキャッシング、ミューテーション関数の処理へのアプローチを統一できます。エンタープライズ環境では、アプリケーションは複数のAPIやサービスと連携しなくてはならない場合が多くあります。React Queryは、データ管理を一元化し、ボイラープレートコードを減らすことで、このプロセスを効率化できます。</p>
<h4>React Context</h4>
<p>React Contextは、propsのバケツリレーを行うことなく、複数のコンポーネントにまたがるグローバルステートを管理するのに役立ちます。これは、アプリケーション全体でユーザー認証や環境設定などの共有ステートにアクセスする必要があるエンタープライズアプリケーションでは特に有益です。</p>
<p>通常、筆者はReact Contextなどの状態管理ツールの使用は最後の手段として取っておきます。グローバルステートに頼るのは必要最低限にとどめておくのがよいでしょう。その代わり、ステートはなるべく必要な場所の近くに置いておきましょう。</p>
<h4>Cypress</h4>
<p>Cypressは、E2Eのテストに非常に役立つツールです。エンタープライズアプリケーションでは、重要なワークフローや機能が異なる画面やコンポーネント上で正常に機能するようにすることが何よりも重要です。Cypressはダントツで筆者が一番気に入っているツールです。テストに合格すれば、新たに導入したコードがアプリケーションに不具合をもたらすことはないと確信できます。エンタープライズアプリケーションが進化していく中で、コードに新たな変更を加えた際にリグレッションテストを実施し、意図せぬ副作用が生じていないか確認することが重要です。Cypressは、テストプロセスを自動化することで、この確認作業を容易にします。</p>
<h4>React Testing Library:</h4>
<p>React Testing Libraryは、Reactコンポーネントの単体テストと統合テストに欠かせません。エンタープライズアプリケーションでは、個々のコンポーネントが期待どおり動作するか検証することが、強固なアプリケーションを作る上で重要です。React Testing Libraryは、各コンポーネントを単体で、さらに他のコンポーネントと組み合わせて、入念にテストすることを可能にします。</p>
<h4>NextAuth.js:</h4>
<p>NextAuth.jsは、Next.jsアプリケーションにおける認証と認可の実装を容易にします。エンタープライズ環境では、ユーザー管理のセキュリティは絶対条件です。企業の間では、複数のアプリケーションをまたいだユーザー認証を効率化するためにシングルサインオン（SSO）ソリューションがしばしば採用されます。NextAuth.jsはさまざまなSSOプロバイダーに対応しているため、エンタープライズ認証のニーズに最適なツールです。また、NextAuth.jsではカスタム認証フローを柔軟に実装することもできます。</p>
<p>NextAuth.jsでTypeScriptによるモジュール拡張を使用してデフォルトの<code class="language-text">User</code>モデルをカスタマイズする方法を説明した筆者の<a href="https://josemukorivo.com/blog/unlock-next-level-authentication-in-nextjs-with-next-auth-and-typescript-module-augmentation-1689">ブログ記事</a>もご覧ください。</p>
<h4>Turborepo</h4>
<p>これも筆者が気に入っているツールの1つです。Turborepoはモノレポの管理に役立ちます。大規模なエンタープライズアプリケーションでは、さまざまなモジュールやサービス、共有コードによりコードベースが膨大になる場合があります。Turborepoは、肥大化したコードベースを効率的に整理し、バージョン管理やデプロイメントを行いやすくします。エンタープライズ環境では、複数のチームやプロジェクトでコードを共有するのは一般的です。Turborepoは、効果的なコード共有を可能にし、共有ライブラリやコンポーネントを使用したチームコラボレーションをサポートします。</p>
<h3>Storybook</h3>
<p>Storybookを使用することで、開発者はUIコンポーネントを切り離し、制御された環境で動かすことができます。そのため、アプリケーション全体を操作することなく、個々のコンポーネントの外観や動作のデモを簡単に実施できます。大規模なエンタープライズアプリケーションでは、複数の開発者やチームがそれぞれUIの異なる部分を担当している場合があります。Storybookは、UIコンポーネントを披露して議論を交わすための一元的なプラットフォームを提供することで、コラボレーションの効率化を促し、デザイン言語の一貫性を確保します。<a href="https://ui.fin.africa/">こちら</a>は筆者がStorybookを使用して開発し、文書化したコンポーネントライブラリのサンプルです（まだ未完成ですが）。</p>
<p><em>エンタープライズ環境では、これらのツールを組み合わせることで、大規模アプリケーションを構築、テスト、維持管理し、データ管理、状態管理、テスト、認証、コード整理などの重要な課題に対処できます。</em></p>
<h2>再利用可能なコンポーネントのコーディングスタイル</h2>
<p>筆者が入力やダイアログなどの再利用可能なコンポーネントを開発する際には、なるべくベストプラクティスに沿って作業するようにしています。</p>
<p>では、<code class="language-text">Button</code>コンポーネントの開発を例にいくつかのベストプラクティスを紹介したいと思います。ベストプラクティスがビジュアルデザインだけにとどまらないことがお分かりいただけるかと思います。</p>
<h4>コンポーネントの再利用性</h4>
<p>ボタンコンポーネントはアプリケーションのさまざまな場所で再利用できるよう設計しましょう。さまざまなユースケースに対応可能な柔軟性が必要です。</p>
<h4>カスタマイズのためのPROPS</h4>
<p>サイズ、色、バリアント（1次、2次など）、無効化状態などの一般的なカスタマイズを行うためのpropsを用意しましょう。そうすることで、開発者はさまざまなUIコンテキストに合わせて容易にボタンを調整できます。</p>
<h4>アクセシビリティへの配慮</h4>
<p>aria-label属性やaria-disabled属性、フォーカス管理などの適切なアクセシビリティ機能を実装しましょう。そうすることで、アシスティブテクノロジー（支援技術）の利用者も効果的にボタンを使用できます。</p>
<h4>セマンティックHTML</h4>
<p>ボタンコンポーネントにセマンティックHTMLの要素を使用しましょう。そうすることで、アクセシビリティとSEOが向上し、異なるデバイス上でも適切な動作を確保できます。</p>
<h4>ボタンのネイティブ要素の模倣</h4>
<p>これらのベストプラクティスは全て、予測可能なコードを記述することにつながります。カスタムボタンコンポーネントを開発する場合、ボタンとして機能し、動作するようにしましょう。後述するコンポーネントの例では、ボタンのネイティブ要素を拡張することで、ボタンに追加できるあらゆるpropsを含めています。</p>
<h4>エラーハンドリング</h4>
<p>ボタンがエラー状態（フォームの送信など）につながる可能性がある場合、エラーを処理し、ユーザーに伝える方法を用意しましょう。</p>
<h4>テスト</h4>
<p>さまざまなシナリオでボタンコンポーネントが期待どおり動作することを検証するための単体テストを作成しましょう。テストケースはさまざまなpropsやイベントハンドラを網羅する必要があります。</p>
<h4>ドキュメント化</h4>
<p>利用可能なprops、イベントハンドラ、特定のユースケースなども含め、ボタンコンポーネントの使用方法をドキュメント化しましょう。開発者の参考になるような例やコードスニペットも記載します。これにはStorybookが役立ちます。</p>
<h4>クロスブラウザ互換性:</h4>
<p>異なるブラウザでボタンコンポーネントをテストし、動作や外観が一貫しているか確認しましょう。</p>
<h4>バージョン管理と変更履歴</h4>
<p>ボタンコンポーネントが共有ライブラリの一部である場合、バージョン管理を実施し、変更履歴を残すことで開発者に更新や変更について知らせましょう。</p>
<h3>コーディング</h3>
<p>筆者のコンポーネントには、大抵<code class="language-text">Button.tsx</code>、<code class="language-text">Button.stories.tsx</code>、<code class="language-text">Docs.mdx</code>、<code class="language-text">Button.test.ts</code>といったファイルが含まれます。CSSを使用している場合、<code class="language-text">Button.module.css</code>のようなファイルがあるかもしれません。</p>
<p><code class="language-text">components/ui/Button.tsx</code></p>
<p>これがメインのコンポーネントであり、<code class="language-text">cn</code>関数でクラスをマージし、コンフリクトに対処します。<code class="language-text">tw-merge</code>ライブラリのラッパーです。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  forwardRef<span class="token punctuation">,</span>
  <span class="token keyword">type</span> <span class="token class-name">ButtonHTMLAttributes</span><span class="token punctuation">,</span>
  <span class="token keyword">type</span> <span class="token class-name">JSXElementConstructor</span><span class="token punctuation">,</span>
  <span class="token keyword">type</span> <span class="token class-name">ReactElement</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AiOutlineLoading3Quarters <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-icons/ai'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> VariantProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'cva'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cva <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'cva'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">'next/link'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/lib'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> button <span class="token operator">=</span> <span class="token function">cva</span><span class="token punctuation">(</span>
  <span class="token string">'flex w-max items-center border-[1.5px] gap-2 transition duration-200 ease-linear focus:outline-0 focus:ring ring-offset-1 dark:ring-offset-blue-dark'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    variants<span class="token operator">:</span> <span class="token punctuation">{</span>
      variant<span class="token operator">:</span> <span class="token punctuation">{</span>
        outline<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        solid<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        naked<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      rounded<span class="token operator">:</span> <span class="token punctuation">{</span>
        none<span class="token operator">:</span> <span class="token string">'rounded-none'</span><span class="token punctuation">,</span>
        sm<span class="token operator">:</span> <span class="token string">'rounded'</span><span class="token punctuation">,</span>
        md<span class="token operator">:</span> <span class="token string">'rounded-lg'</span><span class="token punctuation">,</span>
        lg<span class="token operator">:</span> <span class="token string">'rounded-xl'</span><span class="token punctuation">,</span>
        full<span class="token operator">:</span> <span class="token string">'rounded-full'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      color<span class="token operator">:</span> <span class="token punctuation">{</span>
        primary<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        danger<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        info<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        warning<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        light<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        secondary<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      size<span class="token operator">:</span> <span class="token punctuation">{</span>
        xs<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        sm<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        md<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        lg<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      disabled<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      active<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      loading<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      fullWidth<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      align<span class="token operator">:</span> <span class="token punctuation">{</span>
        center<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        left<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        right<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
        between<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    compoundVariants<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'solid'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'solid'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'primary'</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'outline'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'outline'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'light'</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span>
          <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'naked'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span>
          <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        disabled<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        variant<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'solid'</span><span class="token punctuation">,</span> <span class="token string">'outline'</span><span class="token punctuation">,</span> <span class="token string">'naked'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'light'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'outline'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'light'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        variant<span class="token operator">:</span> <span class="token string">'naked'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'primary'</span><span class="token punctuation">,</span>
        className<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    defaultVariants<span class="token operator">:</span> <span class="token punctuation">{</span>
      size<span class="token operator">:</span> <span class="token string">'md'</span><span class="token punctuation">,</span>
      variant<span class="token operator">:</span> <span class="token string">'solid'</span><span class="token punctuation">,</span>
      color<span class="token operator">:</span> <span class="token string">'primary'</span><span class="token punctuation">,</span>
      rounded<span class="token operator">:</span> <span class="token string">'lg'</span><span class="token punctuation">,</span>
      align<span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">BaseProps</span>
  <span class="token keyword">extends</span> <span class="token class-name">Omit<span class="token operator">&lt;</span>
      ButtonHTMLAttributes<span class="token operator">&lt;</span>HTMLButtonElement<span class="token operator">></span><span class="token punctuation">,</span>
      <span class="token string">'color'</span> <span class="token operator">|</span> <span class="token string">'disabled'</span> <span class="token operator">|</span> <span class="token string">'active'</span>
    <span class="token operator">></span></span><span class="token punctuation">,</span>
    VariantProps<span class="token operator">&lt;</span><span class="token keyword">typeof</span> button<span class="token operator">></span> <span class="token punctuation">{</span>
  href<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  loadingText<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  target<span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'_blank'</span> <span class="token operator">|</span> <span class="token string">'_self'</span> <span class="token operator">|</span> <span class="token string">'_parent'</span> <span class="token operator">|</span> <span class="token string">'_top'</span><span class="token punctuation">;</span>
  <span class="token keyword">as</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'button'</span> <span class="token operator">|</span> <span class="token string">'a'</span> <span class="token operator">|</span> JSXElementConstructor<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ButtonProps</span> <span class="token operator">=</span> BaseProps <span class="token operator">&amp;</span>
  <span class="token punctuation">(</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        rightIcon<span class="token operator">?</span><span class="token operator">:</span> ReactElement<span class="token punctuation">;</span>
        leftIcon<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        rightIcon<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
        leftIcon<span class="token operator">?</span><span class="token operator">:</span> ReactElement<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Button <span class="token operator">=</span> <span class="token generic-function"><span class="token function">forwardRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLButtonElement<span class="token punctuation">,</span> ButtonProps<span class="token operator">></span></span></span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      <span class="token keyword">as</span><span class="token operator">:</span> Tag <span class="token operator">=</span> <span class="token string">'button'</span><span class="token punctuation">,</span>
      variant<span class="token punctuation">,</span>
      color<span class="token punctuation">,</span>
      rounded<span class="token punctuation">,</span>
      size<span class="token punctuation">,</span>
      target <span class="token operator">=</span> <span class="token string">'_self'</span><span class="token punctuation">,</span>
      loading<span class="token punctuation">,</span>
      fullWidth<span class="token punctuation">,</span>
      align<span class="token punctuation">,</span>
      loadingText<span class="token punctuation">,</span>
      href<span class="token punctuation">,</span>
      active<span class="token punctuation">,</span>
      rightIcon<span class="token punctuation">,</span>
      leftIcon<span class="token punctuation">,</span>
      className<span class="token punctuation">,</span>
      disabled<span class="token punctuation">,</span>
      children<span class="token punctuation">,</span>
      <span class="token operator">...</span>rest
    <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>

    <span class="token keyword">const</span> classes <span class="token operator">=</span> <span class="token function">cn</span><span class="token punctuation">(</span>
      <span class="token function">button</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        variant<span class="token punctuation">,</span>
        color<span class="token punctuation">,</span>
        size<span class="token punctuation">,</span>
        disabled<span class="token punctuation">,</span>
        loading<span class="token punctuation">,</span>
        active<span class="token punctuation">,</span>
        rounded<span class="token punctuation">,</span>
        fullWidth<span class="token punctuation">,</span>
        align<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      className
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>href <span class="token operator">?</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>classes<span class="token punctuation">}</span></span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>href<span class="token punctuation">}</span></span> <span class="token attr-name">target</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>target<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span>leftIcon<span class="token punctuation">}</span><span class="token plain-text">
            </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
            </span><span class="token punctuation">{</span>rightIcon<span class="token punctuation">}</span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tag</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>classes<span class="token punctuation">}</span></span> <span class="token attr-name">disabled</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>disabled<span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">rest</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token punctuation">{</span>loading <span class="token operator">?</span> <span class="token punctuation">(</span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">AiOutlineLoading3Quarters</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>animate-spin<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
                </span><span class="token punctuation">{</span>loadingText <span class="token operator">||</span> <span class="token string">'Loading...'</span><span class="token punctuation">}</span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
            <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
                </span><span class="token punctuation">{</span>leftIcon<span class="token punctuation">}</span><span class="token plain-text">
                </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
                </span><span class="token punctuation">{</span>rightIcon<span class="token punctuation">}</span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
            <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Tag</span></span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

Button<span class="token punctuation">.</span>displayName <span class="token operator">=</span> <span class="token string">'Button'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">components/ui/Button.stories.tsx</code></p>
<p>このファイルには、Storybook向けのボタンのストーリーが含まれます。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> Meta<span class="token punctuation">,</span> StoryObj <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@storybook/react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FaRegSmileWink<span class="token punctuation">,</span> FaThumbsUp<span class="token punctuation">,</span> FaYinYang <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-icons/fa'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FiArrowUpRight <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-icons/fi'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./Button'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token string">'Components/Button'</span><span class="token punctuation">,</span>
  component<span class="token operator">:</span> Button<span class="token punctuation">,</span>
  parameters<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    children<span class="token operator">:</span> <span class="token string">'Click me!'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  argTypes<span class="token operator">:</span> <span class="token punctuation">{</span>
    children<span class="token operator">:</span> <span class="token punctuation">{</span>
      description<span class="token operator">:</span> <span class="token string">'This is the text of the button, can be a node.'</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    color<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">,</span> <span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span> <span class="token string">'light'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'select'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'This controls the color scheme of the button'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'primary'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    variant<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'solid'</span><span class="token punctuation">,</span> <span class="token string">'outline'</span><span class="token punctuation">,</span> <span class="token string">'naked'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'select'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'This controls the variant of the button'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'solid'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    size<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'sm'</span><span class="token punctuation">,</span> <span class="token string">'md'</span><span class="token punctuation">,</span> <span class="token string">'lg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'radio'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'This controls the size of the button'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'md'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loading<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'boolean'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'This controls the loading state of the button'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    href<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If this is set, the button will be rendered as an anchor tag.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    className<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'Classes to be applied to the button'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    disabled<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'boolean'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'If true, the button will be disabled'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    rightIcon<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Smile'</span><span class="token punctuation">,</span> <span class="token string">'ThumbsUp'</span><span class="token punctuation">,</span> <span class="token string">'YinYang'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      mapping<span class="token operator">:</span> <span class="token punctuation">{</span>
        Smile<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaRegSmileWink</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
        ThumbsUp<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaThumbsUp</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
        YinYang<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaYinYang</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the icon will be rendered on the right side of the button'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    leftIcon<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Smile'</span><span class="token punctuation">,</span> <span class="token string">'ThumbsUp'</span><span class="token punctuation">,</span> <span class="token string">'YinYang'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      mapping<span class="token operator">:</span> <span class="token punctuation">{</span>
        Smile<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaRegSmileWink</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
        ThumbsUp<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaThumbsUp</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
        YinYang<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FaYinYang</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the icon will be rendered on the left side of the button'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    loadingText<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the text will be rendered while the button is in the loading state'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    target<span class="token operator">:</span> <span class="token punctuation">{</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the target will be rendered as an attribute on the anchor tag'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'_self'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      control<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">'select'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span>
        <span class="token string">'If set, the button will be rendered as the specified element'</span><span class="token punctuation">,</span>
      table<span class="token operator">:</span> <span class="token punctuation">{</span>
        defaultValue<span class="token operator">:</span> <span class="token punctuation">{</span> summary<span class="token operator">:</span> <span class="token string">'button'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">as</span> Meta<span class="token operator">&lt;</span><span class="token keyword">typeof</span> Button<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">Story</span> <span class="token operator">=</span> StoryObj<span class="token operator">&lt;</span><span class="token keyword">typeof</span> Button<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Primary<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Secondary<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'secondary'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Danger<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'danger'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Warning<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Light<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'light'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Info<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    color<span class="token operator">:</span> <span class="token string">'info'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Custom<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    className<span class="token operator">:</span> <span class="token string">'bg-[yellow] text-[black] border-[orange]'</span><span class="token punctuation">,</span>
    style<span class="token operator">:</span> <span class="token punctuation">{</span> borderRadius<span class="token operator">:</span> <span class="token string">'3.5rem'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> WithRightIcon<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    rightIcon<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FiArrowUpRight</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>h-5 w-auto<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> WithLeftIcon<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    leftIcon<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FiArrowUpRight</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>h-5 w-auto<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Disabled<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    disabled<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> OutlineVariant<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    variant<span class="token operator">:</span> <span class="token string">'outline'</span><span class="token punctuation">,</span>
    color<span class="token operator">:</span> <span class="token string">'danger'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> NakedVariant<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    variant<span class="token operator">:</span> <span class="token string">'naked'</span><span class="token punctuation">,</span>
    color<span class="token operator">:</span> <span class="token string">'danger'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> Loading<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> CustomLoadingText<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    loadingText<span class="token operator">:</span> <span class="token string">'Processing...'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> AsLink<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    href<span class="token operator">:</span> <span class="token string">'https://fin.africa'</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token string">'Visit fin website'</span><span class="token punctuation">,</span>
    rightIcon<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FiArrowUpRight</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>h-5 w-auto<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> FullWidth<span class="token operator">:</span> Story <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">{</span>
    fullWidth<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token string">'Visit fin website'</span><span class="token punctuation">,</span>
    rightIcon<span class="token operator">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FiArrowUpRight</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>h-5 w-auto<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">components/ui/Docs.mdx</code></p>
<p>コンポーネントの仕組みをドキュメント化するのにストーリーファイルを使用することもできますが、Markdownファイルのほうがより詳細なドキュメント化が可能です。</p>
<p><code class="language-text">Button</code>コンポーネントの開発に使用した規約は、筆者が全てのコンポーネントで実践している規約と同じものです。</p>
<h2>重要なポイント</h2>
<ul>
<li>オープンソースソリューションであれ、自ら開発したものであれ、何らかのデザインシステムを用意しましょう。</li>
<li>TypeScriptと仲良くなりましょう。TypeScriptをうまく活用し、コンポーネントの使い方を規定しましょう。ボタンコンポーネントが良い例です。<code class="language-text">leftIcon</code>と<code class="language-text">rightIcon</code>という2つのpropsがありますが、この記事ではTypeScriptを使用することでいずれか一方のみが設定されるようにし、両方設定された場合はエラーを返すようにしました。</li>
</ul>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ButtonProps</span> <span class="token operator">=</span> BaseProps <span class="token operator">&amp;</span>
  <span class="token punctuation">(</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        rightIcon<span class="token operator">?</span><span class="token operator">:</span> ReactElement<span class="token punctuation">;</span>
        leftIcon<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        rightIcon<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span>
        leftIcon<span class="token operator">?</span><span class="token operator">:</span> ReactElement<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li>コードとコンポーネントをドキュメント化しましょう。Storybookなどのツールを使用するとよいでしょう。</li>
<li>何らかのスタイルガイドを用意し、チームと共通のデザイン言語を使用しましょう。</li>
<li>分かりやすいコードを書きましょう。コードベースは簡単で分かりやすいものにし、焦点を絞ります。それぞれのコードには単一の明確な目的が必要です。</li>
<li>内部の仕組みを理解しましょう。Reactがどのようにして2つの値が同一であるかを確認するのかについて、筆者が調べた内容をこちらの記事にまとめています。</li>
</ul>
<h2>おわりに</h2>
<p>この記事では、筆者が使用している手法やツールの一部を紹介しました。手元にあるツールを全て網羅してはいませんが、ご自身のニーズに合ったものが見つかると幸いです。全く新しいものを採用するよりも、熟知している技術を使い続けるのが賢明でしょう。</p>
<p>つまるところ、クライアントが最も重視するのは最終製品であって、どのような技術を使用したかではないのです。Reactであれ、Vueであれ、あるいはその他のツールであれ、素早くデプロイでき、ユーザーにメリットがあるようなツールやワークフローを優先的に使用しましょう。</p>
<h2>Resources</h2>
<ul>
<li><a href="https://mkosir.github.io/typescript-style-guide/">TypeScript Style Guide</a></li>
<li><a href="https://turbo.build/">Turborepo</a></li>
<li><a href="https://nextjs.org/">Next.js</a></li>
<li><a href="https://tailwindcss.com/">Tailwind CSS</a></li>
<li><a href="https://prettier.io/">Prettier</a></li>
<li><a href="https://josemukorivo.com/">My website</a></li>
</ul>]]></content:encoded></item><item><title><![CDATA[First Important Paint−カスタム指標の開発]]></title><description><![CDATA[2020年5月、GoogleがWebサイトのパフォーマンス測定を目的としたユーザー中心の指標を発表しました。コアウェブバイタル（CWV）と呼ばれるこの一連の指標には、以下が含まれます。 LCP (L…]]></description><link>https://postd.cc/custom-metrics/</link><guid isPermaLink="false">https://postd.cc/custom-metrics/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[LCP]]></category><category><![CDATA[ブラウザ]]></category><pubDate>Mon, 27 Nov 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>2020年5月、GoogleがWebサイトのパフォーマンス測定を目的とした<a href="https://web.dev/user-centric-performance-metrics/">ユーザー中心</a>の指標を発表しました。<a href="https://web.dev/articles/vitals">コアウェブバイタル（CWV）</a>と呼ばれるこの一連の指標には、以下が含まれます。</p>
<ul>
<li><a href="https://web.dev/lcp">LCP (Largest Contentful Paint)</a>：ビューポート内で最大の要素が表示されるまでの時間。</li>
<li><a href="https://web.dev/fid">FID (First Input Delay)</a>：ユーザーの最初の入力に応答するまでの遅延時間。近々INP (Interaction to Next Paint)に置き換わる予定。</li>
<li><a href="https://web.dev/cls">CLS (Cumulative Layout Shift)</a>：ページのコンテンツがどれだけ移動したかを表す指標。-</li>
</ul>
<p>CWVの狙いは、世の中にあふれるさまざまなパフォーマンス指標を簡素化し、最も重要な指標に優先的に取り組めるようにすることです。この取り組みは好影響をもたらしています。CWVの発表以降、多くのWebオーナーやサービスプロバイダがWebサイトのパフォーマンスに力を注いでおり、Web全体でユーザー体験が向上しています。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-cwv-tech-report.png">
<a href="https://cwvtech.report/">cwvtech.report</a>から引用した上のグラフが示すように、<a href="https://lookerstudio.google.com/u/0/reporting/55bc8fad-44c2-4280-aa0b-5f3f0cd3d2be/page/M6ZPC?params=%7B%22df44%22:%22include%25EE%2580%25800%25EE%2580%2580IN%25EE%2580%2580ALL%22%7D">CWVのしきい値を満たすWebサイトの割合が22%から40%に増えています</a>。</p>
<h2>カスタム指標の役割</h2>
<p>ブラウザにあらかじめ用意されているデフォルト指標に独自のカスタム指標を追加することで、Webサイトのユーザー体験をより正確に測定できる場合があります。例えば、LCPは最も大きな要素が最も重要であると想定します。その通りの場合もありますが、そうではない場合もあります。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-demo.png">
上の画像群では、赤枠で囲まれたフレームの、青のグラデーションの背景画像がLCP要素です。一方、最も重要な要素は、その次のフレームでレンダリングされる「Lorem」というページタイトルでしょう。これは極端な例かもしれませんが、重要な要素がグリッドまたはテーブルの場合や、背景が<code class="language-text">poster</code>画像を含む<code class="language-text">&lt;video&gt;</code>要素の場合にも同じ問題が生じます。</p>
<h3>Element Timing API</h3>
<p>LCPと同様に、<a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceElementTiming">Element Timing API</a>を使用することで、ページ上でDOM要素がレンダリングされるタイミングを測定することができます。しかし、LCPと異なるのは、測定する要素を開発者が選べることです。Element Timing API は、<code class="language-text">elementtiming</code>属性を要素に追加することで設定できます。
Element Timing API の最大の制約は、<a href="https://caniuse.com/mdn-api_element_elementtiming">Chromiumベースのブラウザしか対応していない</a>ことです。また、<a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceElementTiming#description">一部の要素</a>しか対応していません。</p>
<h3>User Timing API</h3>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance_API/User_timing">User Timing API</a>を使用することで、特定のタイミングにマークや指標を設定することができます。例えば、ページ上に要素が描画されたタイミングや、重要なタスクが実行されたタイミングなどに設定できます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// タスク開始時の時間を記録する</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'doSomething:start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// タスク終了時の時間を記録する</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'doSomething:end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// :startと:endの時間差を測定する</span>
performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'doSomething'</span><span class="token punctuation">,</span> <span class="token string">'doSomething:start'</span><span class="token punctuation">,</span> <span class="token string">'doSomething:end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>実ユーザー指標とラボテスト</h2>
<p>カスタム指標を開発するに当たって最初に問うべきことは、この指標を実際のユーザーとデバイスで測定したいのか、それともラボテスト（※）でのみ測定したいのかということです。どちらの指標も有益ですが、それぞれに異なる利点があります。
（※訳注：ユーザーではなく、開発者がツール等を使って行うテストをラボテストと呼称しています）
実ユーザー指標（Real user metrics, RUM）は、ユーザー体験を全面的に測定することができます。単一のスコアではなく、異なるユーザーや体験を反映したさまざまな値が得られます。例えば、90パーセンタイルのユーザーは散々な体験をするかもしれませんが、平均的なユーザーは良い体験をします。指標に影響を及ぼすさまざまな要因（地理的な場所、ブラウザ、デバイス）を理解することで、自分のユーザーのためにWebサイトを最適化することができます。マイナス面としては、RUMソリューションの実装は複雑で、費用がかさむ場合があることです。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-rum.png"></p>
<p>上のスクリーンショットは<a href="https://speedcurve.com/">SpeedCurve</a>から引用したもので、異なるユーザー体験の分布を示しています。</p>
<p>ラボテストは管理された環境で行われます。接続速度、デバイス、テストを実行する場所などいくつかのパラメータは設定できるかもしれません。テスト結果のレポートには、ページ上で測定したさまざまな指標について詳しく記載されます。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-wpt.png"></p>
<p>ラボテストはデバッグに極めて有効です。一定の間隔でラボテストを行うことにより、長期間にわたってページのパフォーマンスを比較し、不具合を特定することができます。筆者がラボテストを行う際には、<a href="https://webpagetest.org/">WebPageTest</a>というツールを愛用しています。</p>
<h2>優れた指標の特徴</h2>
<p><a href="https://www.youtube.com/watch?v=diAc65p15ag">ポール・アイリッシュ</a>が2020年にLCPについて紹介した際、優れた指標が持つべき8つの特徴について説明しました。これを少しアレンジしたものが、<a href="https://chromium.googlesource.com/chromium/src/+/lkgr/docs/speed/good_toplevel_metrics.md">Chromiumのソースコードに関するドキュメント</a>の中にもあります。</p>
<ul>
<li>代表性：ユーザー体験および事業価値と相関する。</li>
<li>解釈可能性：指標およびその価値が理解しやすい。</li>
<li>正確性：測定すべき内容を正確に測定できているか。</li>
<li>単純性：計算方法が複雑でない。</li>
<li>直交性：測定する内容が他の指標と重複しない。</li>
<li>安定性：測定にばらつきが少ない。</li>
<li>弾力性：入力に小さな変化があると、指標にも小さな変化が表れる。</li>
<li>相関性：他の指標との相関性や、ラボテストとフィールドテストの間の相関性がある。</li>
</ul>
<h3>観察者効果</h3>
<p>優れた指標の重要な特徴としてもう一つ挙げられるのが、テストそのものに影響を及ぼさないということです。科学用語では、観察する行為がテストに影響を与えることを<a href="https://en.wikipedia.org/wiki/Observer_effect_(physics)">観察者効果</a>と呼びます。カスタム指標の測定によりページの表示速度が明らかに低下する場合、それは良い指標とは言えません。</p>
<h2>FIP (First Important Paint)</h2>
<p><a href="https://github.com/kevinfarrugia/first-important-paint">First Important Paint</a>は、最初の注釈付きHTML要素がページ上に表示されるまでの時間を測定するために開発されたカスタム指標です。</p>
<p>この指標が必要になったのは、LCP要素がユーザー体験と一致しない場合があったためです。さらに、ページを構成するさまざまなコンポーネントが、異なるチームの開発者によって作成されることも多くありました。ページではなく要素に注釈を付けることで、自動的にFIP候補として扱われるため、開発者はコンポーネントがどのページで使用されるのか知る必要がありません。</p>
<p>（それに、3文字の略称も付いているため正規のものに見えますよね😛）</p>
<h3>FIPは優れた指標か？</h3>
<p>First Important Paintは、ユーザーが実際に使う環境でのテストでも<a href="https://www.webpagetest.org/result/230609_BiDc8Q_1d6bbfd5da548a2bb04076a5c6bf1438/2/details/">ラボテスト</a>でも測定できます。FIPが優れた指標かどうかを判断するため、マーケットの異なる2つの本番サイトでいくつかのラボテストを実施し、データを収集しました。</p>
<h3>代表性</h3>
<p>FIPの代表性を検証するため、異なるページのスクリーンショットと異なるデバイスを使用したラボテストをいくつか用意し、この指標について何も知らない同僚数名に最も重要な要素が描画されていると思うフレームを選んでもらいました。このデータをもとに、重要な要素として扱うべきコンポーネントを判断し、LCPがすでにこの情報を示していたかどうかを評価しました。</p>
<h3>解釈可能性</h3>
<p>FIPは分かりやすく、ミリ秒単位で測定されます。</p>
<h3>正確性</h3>
<p>カスタム指標の正確性を測定するため、FIP要素がLCP要素でもあるラボテストをいくつか実施しました。これはつまり、FIPとLCPの値が同等であることが望ましいということです。テキスト要素には、LCPの代わりにElement Timing APIを使用しました。</p>
<p>テストは<a href="https://docs.google.com/spreadsheets/d/1ola_2GGd1NWOqeVJ_Ea1CGbLn2DvcGNHDI2P43xgtjg/edit?usp=sharing#gid=1072306481">画像</a>要素と<a href="https://docs.google.com/spreadsheets/d/1ola_2GGd1NWOqeVJ_Ea1CGbLn2DvcGNHDI2P43xgtjg/edit?usp=sharing#gid=2063136168">テキスト</a>要素を対象とし、接続速度の異なる3つの回線を使用して行いました。ネイティブ回線では、FIPとLCPの差は50ミリ秒でした。Regular 4G回線とRegular 3G回線では、それぞれ200ミリ秒と1000ミリ秒に差が広がりました。</p>
<p>これらの結果は期待外れに見えるかもしれませんが、測定結果は一貫しており、LCPまたはElement Timing API とFIPの差はテストによって大きく違いませんでした。例えば、あるテストではLCPよりFIPの方が50ミリ秒速く、次のテストでは50ミリ秒遅かった方が問題です。</p>
<p>正確性に欠ける理由はさまざまであり、指標の計算方法の限界でもあります。</p>
<h3>単純性</h3>
<p><a href="https://github.com/kevinfarrugia/first-important-paint">FIPを測定、計算するためのコード</a>は単純で、デバッグや変更も必要に応じて簡単に行えます。</p>
<h3>直交性</h3>
<p>FIPは、ページ上で最も重要な要素を測定するためのカスタム指標です。最も重要な要素が最も大きな要素でもある場合があり、その場合はFIPとLCPが重複することになります。</p>
<h3>安定性</h3>
<p>FIPの安定性を測定するため、接続速度の異なる3つの回線でラボテストを行いました。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-stable.png"></p>
<p>上のグラフが示すように、どの回線でもテストによるばらつきはほとんどありませんでした。</p>
<h3>弾力性</h3>
<p>ユーザー体験の変化に比例した変化が指標に見られる場合、その指標は弾力性があるとみなされます。FIPに弾力性があるかどうかをテストするため、基準となるデモページと、これに変更を加え、フォントファイルをセルフホストしてあらかじめ読み込むようにしたページを作成しました。タイトルのレンダリングが早くなるため、ユーザー体験が改善されることが期待され、それに伴いFIPも改善するはずです。</p>
<p><a href="https://www.webpagetest.org/result/230609_BiDc6F_4f0c2f5d8d52b79857b016b539cc2ebe/3/details/">FIPの古いバージョンの中に、この変更による改善が一切見られないものがありました</a>。そのおかげで、指標に不備があったことが判明しました。FIPはテキスト要素がDOMに追加された時間を記録していたのですが、Webフォントがまだダウンロードされていないケースを考慮していなかったのです。</p>
<p>この問題を解決してからは、ユーザー体験の向上に<a href="https://www.webpagetest.org/video/compare.php?tests=230609_BiDc8Q_1d6bbfd5da548a2bb04076a5c6bf1438-l:Original,230609_AiDcZW_f90f83a17cae800f8fc845dea6c8fd38-l:Optimized-e:filmstrip">比例した小さな改善がFIPに見られるようになりました</a>。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-elastic.png"></p>
<p>上の比較をご覧ください。<a href="https://www.webpagetest.org/result/230609_BiDc8Q_1d6bbfd5da548a2bb04076a5c6bf1438/2/details/#waterfall_view_step1">元ページのテスト</a>では、LCPが1.315秒で、FIPが1.470秒でした。上記の修正を加えた<a href="https://www.webpagetest.org/result/230609_AiDcZW_f90f83a17cae800f8fc845dea6c8fd38/1/details/">最適化ページのテスト</a>では、LCPが1.305秒で、FIPは1.188秒に改善されました。この改善はユーザー体験とも一致しており、2回目のテストではユーザー体験が大幅に改善されています。</p>
<h3>相関性</h3>
<p>FIPと他の指標の相関性を確認するため、正確性の説明で述べたのと同じテストを使用しました。散布図にFIPとLCPの測定結果を記入し、<a href="https://en.wikipedia.org/wiki/Coefficient_of_determination">決定係数</a>を計算しました。2つの指標が相関するためには、両者の値が一致する必要はありませんが、LCPが増えたらそれに比例してFIPも増え、FIPが増えたら同様にLCPも増える必要があります。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-correlates-lcp.png"></p>
<p>テキスト要素の場合、Regular 4G回線で強い相関が見られたものの、Regular 3G回線では同等の強い相関が見られませんでした。</p>
<p>SpeedCurveで入手可能な実ユーザーデータを使用し、FIPとビジネス指標の相関性を見ることもできます。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-correlates-bounce-rate.png"></p>
<p>上のグラフはSpeedCurveから引用したものですが、FIPが増えるとページの直帰率（青い線）も増えており、両者の間には正の相関関係が見られます。</p>
<h3>観察者効果</h3>
<p>最後に、この指標はテスト対象のページのパフォーマンスに影響を及ぼさないことを確認したいと思います。指標を含むページと、指標の代わりに同等のサイズのレンダーブロッキングとなるスクリプトを含むページで同じテストを実施しました。</p>
<p><img src="/article-assets/custom-metrics/first-important-paint-observer-effect.png">
上のグラフが示すように、LCP要素は両者のテスト間でほとんど変わりませんでした。将来的には、LCPの他にJavaScriptの<a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceLongTaskTiming">ロングタスク</a>も含めたテストを行ってみたいと思います。</p>
<h2>まとめ</h2>
<p>この記事の狙いは、社内で指標のレビューを行うきっかけになることです。<a href="https://web.dev/articles/vitals">CWV</a>の対象範囲と優れたカスタム指標の条件を理解することで、自分が使用している指標を評価し、改善することができます。</p>
<p>First Important Paintは優れた指標でしょうか？限界もありますし、有用性もケースバイケースでしょう。しかし、我々にとっては現時点で重要な役割を果たしています。さらに改善を加え、ユーザー体験の他の側面を測定する新たなカスタム指標を追加していきたいと思っています。</p>
<p>最後までお読みいただきありがとうございました。ご意見やご質問のある方はぜひご連絡ください。</p>]]></content:encoded></item><item><title><![CDATA[fetchPriorityと、LCPの最適化]]></title><description><![CDATA[fetchPriority APIは、リソースの相対的な優先度をブラウザに示すために使用します。fetchpriority属性を、、、の各要素に追加するか、Fetch API上で属性を使用することで…]]></description><link>https://postd.cc/fetchpriority-opportunity/</link><guid isPermaLink="false">https://postd.cc/fetchpriority-opportunity/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[LCP]]></category><category><![CDATA[ブラウザ]]></category><pubDate>Mon, 30 Oct 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>fetchPriority APIは、リソースの相対的な優先度をブラウザに示すために使用します。fetchpriority属性を<code class="language-text">&lt;img&gt;</code>、<code class="language-text">&lt;link&gt;</code>、<code class="language-text">&lt;script&gt;</code>、<code class="language-text">&lt;iframe&gt;</code>の各要素に追加するか、Fetch <a href="https://fetch.spec.whatwg.org/#fetch-method">API</a>上で<code class="language-text">priority</code>属性を使用することで優先度を設定できます。</p>
<p>ブラウザのロードプロセスは複雑です。ブラウザは、主にリクエストの種類や、ドキュメントのマークアップ内におけるリクエストの位置によってその優先度を判断します。例えば、ドキュメントの<code class="language-text">&lt;head&gt;</code>内で要求されたCSSファイルの優先度は<code class="language-text">Highest</code>となり、<code class="language-text">defer</code>属性が設定された<code class="language-text">&lt;script&gt;</code>要素の優先度は<code class="language-text">Low</code>となります。ブラウザは、同じ優先度が割り当てられたリソースを、検出した順にダウンロードします。</p>
<h2>fetchpriority</h2>
<p><a href="https://wicg.github.io/priority-hints/#definitions">fetchpriority</a>属性を使用することで、要求されたリソースの優先度を高くしたり低くしたりするようブラウザに指示できます。これは列挙型の属性であり、以下の3つの内いずれかの値を指定できます。</p>
<ul>
<li>high – リソースの優先度がデフォルトの優先度よりも高い</li>
<li>low – リソースの優先度がデフォルトの優先度よりも低い</li>
<li>auto – デフォルト値</li>
</ul>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/lcp.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>A dog<span class="token punctuation">"</span></span> <span class="token attr-name">fetchpriority</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>high<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>上の例では、<code class="language-text">&lt;img&gt;</code>の優先度がデフォルトの優先度よりも高いことをブラウザに示しています。</p>
<p><code class="language-text">fetch</code>メソッドの<a href="https://fetch.spec.whatwg.org/#dom-requestinit-priority">priority</a>属性でも同じ値を指定できます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/api/data.json"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> priority<span class="token operator">:</span> <span class="token string">'high'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>上の[fetch]リクエストでは、リクエストの優先度がデフォルトの優先度よりも高いことをブラウザに示しています。</p>
<h2>デフォルトの優先度</h2>
<p>fetchPriority APIを使用することで、デフォルトの優先度に対してリソースの優先度を高くしたり低くしたりすることができます。例えば、画像のデフォルトの優先度は<code class="language-text">Low</code>ですが、<code class="language-text">fetchpriority=&quot;high&quot;</code>と指定することで優先度を<code class="language-text">High</code>に変更できます。一方、レンダーブロッキングとなるスタイルシートのデフォルトの優先度は<code class="language-text">Highest</code>です。<code class="language-text">fetchpriority=&quot;low&quot;</code>と指定すると、優先度は<code class="language-text">Low</code>ではなく<code class="language-text">High</code>に変更されます。<code class="language-text">fetchpriority</code>は、値を明示的に設定するのではなく、デフォルトを基準としてリソースの優先度を調整するために使用します。</p>
<p><a href="https://docs.google.com/document/d/1bCDuq9H1ih9iNjgzyAL0gpwNFiEP4TZS-YLRp_RuMlc/edit">influence of Fetch Priority on resource prioritization in Chromiumという文書</a>には、各種リソースタイプ、デフォルトの優先度（◉）、<code class="language-text">fetchpriority=&quot;high&quot;</code>（⬆）および<code class="language-text">fetchpriority=&quot;low&quot;</code>（⬇）を使用した場合の優先度が記されています。</p>
<p><em>ビューポート内にあることが判明した画像の優先度はHighに引き上げられます。しかし、その時点ではロードプロセスがかなり進んでいる可能性もあり、すでにリクエストを送信済みの場合はほとんど影響がないか、まったく影響がない可能性もあります。fetchpriority="high"を使用することで、画像がビューポート内にあるかどうかをブラウザが判断するまで待つのではなく、最初から優先度をHighに指定することができます。</em></p>
<h2>「タイトモード」</h2>
<p>ほとんどのブラウザは、2つのフェーズに分けてリソースをダウンロードします。初期フェーズ（Chromiumでは「タイトモード」とも呼ばれます）では、実行中のリクエストの数が2つ未満の場合を除き、優先度が<code class="language-text">Low</code>のリソースはダウンロードされません。</p>
<p><img src="/article-assets/fetchpriority-opportunity/tight-mode.png"></p>
<p>上のウォーターフォールチャートを見ると、リソース<code class="language-text">image-1.jpg</code>のダウンロードは、直ちに検出されたとしても<code class="language-text">style-2.css</code>のダウンロードが完了するまで開始されないことが分かります。この時点でダウンロード中のリソースは<code class="language-text">script.js</code>のみのため、優先度が<code class="language-text">Low</code>の画像のダウンロードが開始されます。</p>
<p>初期フェーズは、<code class="language-text">&lt;head&gt;</code>内のブロッキングスクリプトが全てダウンロードされ、実行された時点で完了します（<code class="language-text">async</code>または<code class="language-text">defer</code>が設定されたスクリプトはレンダーブロッキングではありません）。それ以降は、実行中のリクエストの数が2つ以上ある場合でも、残りのリソースの優先度とマークアップ内における順序に基づいてダウンロードが行われます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/interactive.png"></p>
<p>上のチャートでは、レンダーブロッキングとなるJavaScriptがダウンロードされ、実行（ピンク色のバー）された時点で、2つのCSSファイルのダウンロードがまだ進行中であるものの、画像のダウンロードが開始します。黄色の縦線は、<code class="language-text">readystatechange</code>イベントが発生したタイミング、すなわちDOMインタラクティブを示しています。</p>
<h2>preconnect</h2>
<p>画像が別のドメイン上に存在する場合、ブラウザはファイルをダウンロードする前にドメインへの接続を開く必要があります。</p>
<p><img src="/article-assets/fetchpriority-opportunity/crossorigin-images.png"></p>
<p>これは、WebPageTestチャート上でダウンロードの前にある緑色、オレンジ色、赤紫色のバーによって示されています。<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Link_types/preconnect">preconnect</a>リソースヒントを使用することで、画像のダウンロード開始を早めることができます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/preconnect.png"></p>
<p>上のチャートでは、ブラウザがファイルのダウンロードを開始できる前に、初期フェーズで<code class="language-text">cdn.glitch.global</code>ドメインへの接続が開かれています。初期フェーズが終了した時点（黄色の縦線）で、直ちに画像のダウンロードが開始されます。これにより、約350ミリ秒の節約になります。</p>
<h2>preload</h2>
<p><code class="language-text">preconnect</code>リソースヒントを使用してダウンロード時間を短縮できるのであれば、<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Link_types/preload">preload</a>ディレクティブを使用することでさらに短縮できるのでしょうか。結論から言うとできません。preloadディレクティブは、「遅れて検出」される重要なリソースについて、ブラウザに情報を伝えるために使用できます。これは、スタイルシートやスクリプトに組み込まれた背景画像やフォントなどのリソースを読み込む際に特に役立ちます。ここで紹介する例では、画像はマークアップ内で宣言され、早い段階で検出されるため、プリロードを行ってもほとんど影響がありません。</p>
<p><img src="/article-assets/fetchpriority-opportunity/preload.png"></p>
<p>上のチャートでは、<code class="language-text">preconnect</code>ヒントを以下に置き換えました。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span>
  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span>
  <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image<span class="token punctuation">"</span></span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.glitch.global/.../image-1.jpg<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>プリロードを行ったにもかかわらず、処理中のリクエストの数が2つ未満になるまで画像のダウンロードは開始されません。</p>
<h2>fetchpriority</h2>
<p>以下のように、fetchPriorityを使用することで、<code class="language-text">image-1.jpg</code>がデフォルトの優先度よりも重要であることをブラウザに示すことができます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.glitch.global/.../image-1.jpg<span class="token punctuation">"</span></span>
  <span class="token attr-name">fetchpriority</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>high<span class="token punctuation">"</span></span>
  <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これにより、最初から画像の優先度を<code class="language-text">Low</code>から<code class="language-text">High</code>に高め、初期フェーズで画像を読み込ませることができます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/fetchpriority.png"></p>
<p>上のウォーターフォールチャートでは、<code class="language-text">image-1.jpg</code>が他の重要なリソースと並行して初期フェーズで読み込まれています。これにより、ここまでで最も大きな改善が得られます。</p>
<h2>Firefox</h2>
<p>Firefoxも、同様の方法を用いて初期フェーズで読み込むリソースを判断しています。しかし、Chromiumベースのブラウザとは異なり、<code class="language-text">&lt;head&gt;</code>内のJavaScriptが全てダウンロードされ、実行されるまで、優先度が<code class="language-text">Low</code>のリソースのダウンロードは開始されません。これは、優先度が<code class="language-text">High</code>のリクエストが1つしか進行していない場合でも同じです。</p>
<p><img src="/article-assets/fetchpriority-opportunity/firefox-tight-mode.png"></p>
<p>上はFirefox Webデベロッパーツールのスクリーンショットです。これによると、画像リソース（5行目〜8行目）はスクリプト（2行目）のダウンロードと実行が完了し、ページが<code class="language-text">interactive</code>（青い縦線）になってから取得されることが分かります。</p>
<p><em>Chromeは<code class="language-text">&lt;head&gt;</code>内で宣言されたJavaScriptがダウンロードされ、実行されるまで待ちますが、Firefoxは、<code class="language-text">&lt;head&gt;</code>内で宣言されたものでなくても、画像要素より前に宣言された全てのレンダーブロッキングとなるJavaScriptがダウンロードされ、実行されるまで待ちます。</em></p>
<p>Firefoxはまだ<a href="https://github.com/whatwg/html/issues/7150#issuecomment-1299923593">fetchpriorityに対応</a>していませんが、<code class="language-text">preload</code>ディレクティブを使用することで<code class="language-text">image-1.jpg</code>の優先度を高めることができます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/firefox-preload-and-fetchpriority.png"></p>
<p>上のスクリーンショットでは、他のリソースと並行して<code class="language-text">image-1.jpg</code>ファイルを取得しています。これは、Google Chromeで<code class="language-text">fetchpriority=&quot;high&quot;</code>を追加した際に見た挙動と似ています。</p>
<h2>Safari</h2>
<p>iOSやmacOS上で動作するSafariにも初期フェーズはありますが、ChromeやFirefoxとは挙動が異なります。</p>
<p>優先度が<code class="language-text">Low</code>のリソースは、処理中のリクエストの数が2つ未満になると取得を開始します。<code class="language-text">readystatechange</code>イベントに依存せず、レンダーブロッキングとなるJavaScriptがないページでも、処理中のリクエストが1つになるまで待ちます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/safari-tight-mode.png"></p>
<p>上はSafariのWebインスペクタのスクリーンショットです。ここでは、<code class="language-text">style-1.css</code>のダウンロードが完了し、処理中のリクエストの数が2つ未満になるまで画像のダウンロードは開始していません。</p>
<p>Safariでは、初期フェーズは同じドメイン上にあるリソースにしか適用されません。優先度が<code class="language-text">Low</code>のリソースが別のドメインから読み込まれる場合、検出された時点で取得されます。</p>
<p><img src="/article-assets/fetchpriority-opportunity/safari-crossorigin.png"></p>
<p>上のスクリーンショットでは、優先度が<code class="language-text">High</code>のリソースのダウンロードが終わるまで待つことなく、crossorigin属性の画像が直ちに取得されています。</p>
<p><code class="language-text">preload</code>ディレクティブはリソースの優先度に影響しませんが、検出された時点で処理中のリクエストの数が2つ未満なので、優先度が<code class="language-text">High</code>のリクエストの前に<code class="language-text">&lt;link rel=&quot;preload&quot;&gt;</code>ディレクティブを入れることでダウンロードを早めることができます。この挙動は他のブラウザと同じですが、レンダーブロッキングとなるCSSが優先されるべきなので、ほとんどの場合、優先度が<code class="language-text">High</code>のリソースの上に<code class="language-text">preload</code>ディレクティブを入れることは推奨しません。</p>
<p><img src="/article-assets/fetchpriority-opportunity/safari-preload.png"></p>
<p>このスクリーンショットでは、ドキュメントのマークアップ内で<code class="language-text">&lt;link rel=&quot;preload&quot;&gt;</code>が上に挿入されているため、優先度が<code class="language-text">Low</code>の<code class="language-text">image-1.jpg</code>ファイルのほうが、優先度が<code class="language-text">High</code>の<code class="language-text">style-1.css</code>ファイルより先にダウンロードを開始しています。</p>
<h2>preloadとfetchpriorityを組み合わせる</h2>
<p>現時点でfetchPriorityに<a href="https://caniuse.com/?search=fetchpriority">対応しているのはChromiumベースのブラウザ</a>だけですが、
fetchpriority属性を認識しない未対応ブラウザでも、機能はしないものの大きな支障は来しません。したがって、<code class="language-text">fetchPriority</code>と<code class="language-text">preload</code>ディレクティブを組み合わせて使用することができます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span>
  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span>
  <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image<span class="token punctuation">"</span></span>
  <span class="token attr-name">fetchpriority</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>high<span class="token punctuation">"</span></span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.glitch.global/.../image-1.jpg<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>FetchPriorityに対応したブラウザは、割り当てられた<code class="language-text">fetchpriority</code>属性を使用してリソースをプリロードし、未対応のブラウザは<code class="language-text">preload</code>ディレクティブを使用します。</p>
<p><img src="/article-assets/fetchpriority-opportunity/preload-and-fetchpriority.png"></p>
<p>上のチャートは、<code class="language-text">&lt;img&gt;</code>要素にfetchpriority属性を含んだ前述の例と似た結果を示しています。この方法の利点は、<code class="language-text">fetchPriority</code>に対応したブラウザと未対応のブラウザ上のリソースを優先順位付けするアプローチを統一できることにあります。</p>
<h2>fetchpriorityに関するさまざまな考察</h2>
<p>このセクションでは、<code class="language-text">fetchpriority</code>を使用する潜在的な利点について見ていきます。データは全て<a href="https://httparchive.org/">HTTP Archive</a>から取得したものであり、HTTP/2またはHTTP/3を使用し、LCP（<a href="https://web.dev/lcp">Largest Contentful Paint</a>）要素が画像のページについてのみ検討します。<a href="https://github.com/kevinfarrugia/fetchpriority-opportunity">クエリ</a>と<a href="https://docs.google.com/spreadsheets/d/11QwVrr1zcFGBhOMNe25uFBD9VUfg4JP3AUkhWjod9RY/edit?usp=sharing">結果</a>は全て公開されています。</p>
<p><em>注記：HTTP Archiveのデータは、Chrome上でWebPageTestのプライベートインスタンスを使用して収集したものです。<a href="https://httparchive.org/faq#how-is-the-data-gathered">データの収集方法に関する詳細はこちらをご覧ください</a>。</em></p>
<p><img src="/article-assets/fetchpriority-opportunity/opportunity.png"></p>
<p><code class="language-text">fetchpriority</code>の利点は、リソースが検出されてからダウンロードが開始されるまでの時間差にあると考えられます。筆者はこれをopportunityと呼んでいます。したがって、早い段階でリソースが検出されたものの、ダウンロードが始まるのが遅い場合、その分opportunityは大きくなります。</p>
<p><em>注記：画像が異なるドメインからダウンロードされる場合、接続を開くための時間もopportunityの中に含めています。</em></p>
<p><img src="/article-assets/fetchpriority-opportunity/opportunity-vs-largest-contentful-paint.png"></p>
<p>上のチャートでは、LCPに対するopportunity（ミリ秒単位）を図示しています。opportunityは100ミリ秒単位のバケットに分け、1,000ミリ秒超のopportunityは1つのバケットにまとめています。チャートはopportunityとLCPの間に強い相関関係を示しており、opportunityが大きいほどLCPが悪化しています。</p>
<p><img src="/article-assets/fetchpriority-opportunity/opportunity-by-initial-priority.png"></p>
<p>上のチャートは、優先度が<code class="language-text">Low</code>と<code class="language-text">High</code>のリソースについて、モバイル端末のopportunityの分布を示しています。中央値では、優先度が<code class="language-text">High</code>のLCP画像は検出された21ミリ秒後にダウンロードが始まっていますが、優先度が<code class="language-text">Low</code>のLCP画像は102ミリ秒後にダウンロードされています。75パーセンタイルや90パーセンタイルになるとその差はさらに開きます。</p>
<p><em>fetchpriority="High"の他にも、画像の検出が遅い場合（CSS background-imageを使用する場合やJavaScriptを使用して画像を追加する場合）には優先度の初期設定がHighになっている可能性があります。その場合は、リクエストの優先度がすでにHighに設定されているため、fetchpriorityは役に立ちません。</em></p>
<p>結論としては、LCP画像の優先順位付けを行うことには明確な利点があります。opportunityはページの構成によって異なります。優先度がLowのリソースは、レンダーブロッキングとなるスクリプトが1つ以上、処理中のリクエストが2つ以上ある場合、すぐに取得されないことは前述の通りです。</p>
<p><img src="/article-assets/fetchpriority-opportunity/no-of-render-blocking-resources-vs-median-opportunity.png"></p>
<p>上のチャートは、opportunity（ミリ秒単位）に対するレンダーブロッキングとなるリソースの数を図示しています。ページ上にあるレンダーブロッキングとなるリソースの数が多いほど、LCP画像のダウンロードが遅れることが直感的に分かります。</p>
<h2>まとめ</h2>
<p>リソースヒントやfetchPriorityを使用することで、LCP画像の優先順位付けを行う大きなチャンスがあります。メインドキュメント上ですぐに検出できる場合でも、LCP要素がキューで待機中のページは少なくありません。</p>
<p><img src="/article-assets/fetchpriority-opportunity/distribution-of-opportunity.png"></p>
<p>上のチャートを見ると、中央値のモバイルサイトではLCP画像のダウンロードが開始されるまで98ミリ秒の待機時間があります。90パーセンタイルでは810ミリ秒です。fetchPriorityを使用すれば、LCP画像の優先度を高め、待機時間を減らすことができます。</p>
<p>また、LCP画像に<code class="language-text">fetchpriority=&quot;high&quot;</code>を追加するとLCP（<a href="https://web.dev/lcp">Largest Contentful Paint</a>）が改善することを示す事例もあります。<a href="https://www.etsy.com/codeascraft/priority-hints-what-your-browser-doesnt-know-yet">Etsyは4%の改善を報告しており</a>、20〜30%の改善を報告している企業もあります。</p>
<p>あるリソースの優先度を高めると、大抵は別のリソースにしわ寄せが来るため、fetchPriorityは控えめに使用するべきでしょう。しかし、ブラウザがLCP画像をキューに入れているようであれば、fetchPriorityを使用することで待機時間を減らし、LCPを改善できるか試してみることをお勧めします。</p>
<p>以下にポイントをまとめます。</p>
<ul>
<li>LCP画像はHTMLドキュメントと同じドメイン上にホスティングする。それが難しい場合、<code class="language-text">preconnect</code>を使用して早い段階で接続を開く。</li>
<li>LCP画像はドキュメントのマークアップの一部を構成することが望ましい。それが難しい場合、<code class="language-text">preload</code>を使用し、リクエストされる前に画像をダウンロードするようブラウザに指示する。</li>
<li>リソースは極力ブロックしないこと。優先度が<code class="language-text">Low</code>のLCP画像をダウンロードする場合、<code class="language-text">fetchpriority</code>を使用してダウンロードを早めるようブラウザに指示する。</li>
<li>Firefoxでは、<code class="language-text">fetchpriority</code>に対応するまでは<code class="language-text">preload</code>を使用してLCP画像の優先度を高めることができる。Safariでは、<code class="language-text">preload</code>ディレクティブを使用しても画像のダウンロードは早くならない。</li>
</ul>
<p>本稿に関するご意見やご感想をぜひお聞かせください。</p>
<h2>おすすめリンク</h2>
<ul>
<li><a href="https://fetchpriority-opportunity.glitch.me/">Demos</a></li>
<li><a href="https://github.com/kevinfarrugia/fetchpriority-opportunity">Queries</a> &#x26; <a href="https://docs.google.com/spreadsheets/d/11QwVrr1zcFGBhOMNe25uFBD9VUfg4JP3AUkhWjod9RY/edit?usp=sharing">Results</a></li>
<li><a href="https://web.dev/priority-hints/">Optimizing resource loading with Priority Hints</a> (web.dev)</li>
<li><a href="https://www.debugbear.com/blog/priority-hints">Prioritizing Important Page Resources With Priority Hints</a> (<a href="http://debugbear.com/">debugbear.com</a>)</li>
</ul>
<h2>謝辞</h2>
<p>本稿の執筆にあたり、貴重なフィードバックとアドバイスをいただいた<a href="https://webperf.social/@tunetheweb">バリー・ポラード氏</a>に心より感謝申し上げます。</p>
<h2>注記</h2>
<ul>
<li>この機能は当初Priority Hintsと呼ばれていましたが、標準化後はFetch Priorityに名称が変更されました。</li>
</ul>]]></content:encoded></item><item><title><![CDATA[UIのチラつきを撲滅する：useLayoutEffect、ペインティング、ブラウザについて]]></title><description><![CDATA[この記事では、DOMの測定結果に基づいて要素を変更する方法、useEffectの問題点とuseLayoutEffectによる解決法、ブラウザペインティングとは何か、SSRの役割について説明します。
…]]></description><link>https://postd.cc/no-more-flickering-ui/</link><guid isPermaLink="false">https://postd.cc/no-more-flickering-ui/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><pubDate>Fri, 29 Sep 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>この記事では、DOMの測定結果に基づいて要素を変更する方法、useEffectの問題点とuseLayoutEffectによる解決法、ブラウザペインティングとは何か、SSRの役割について説明します。
この記事と同じ内容を扱ったYouTube動画も公開していますので、活字媒体よりも動画視聴を好まれる方はそちらをご覧ください。文字ではなく、アニメーションと音声で同じ概念を解説しています。
<a href="https://www.youtube.com/watch?v=__tm1dyMi4A">この記事は動画形式でも公開しています。</a></p>
<h2>目次</h2>
<ul>
<li><a href="#01">useEffectの問題点とは？</a></li>
<li><a href="#02">useLayoutEffectでチラつきを解決する</a></li>
<li><a href="#03">解決策が有効な理由：レンダリング、ペインティング、ブラウザ</a></li>
<li><a href="#04">Next.jsやその他のSSRフレームワークでuseLayoutEffectを実行する</a></li>
</ul>
<p>ReactにおけるDOMアクセスについてもう少しお話ししましょう。<a href="/refs-from-dom-to-api/">"前回の記事 ReactにおけるRef：DOMへのアクセスから命令型APIまで"</a>では、Refを使用してDOMにアクセスする方法について説明し、Refに関することは全て網羅しました。しかし、DOMの使用方法については、あまり語られることはないものの非常に重要なトピックがもう1つあります。それは、要素のサイズや位置といったDOMの実際の測定結果に基づいた要素の変更です。
では、具体的な問題点は何であり、「通常」の方法では不十分な理由は何でしょうか。実際に少しコーディングを行いながら解明していきましょう。このプロセスを通じて、<code class="language-text">useLayoutEffect</code>について知るべきあらゆること、<code class="language-text">useEffect</code>ではなく<code class="language-text">useLayoutEffect</code>を使用すべきときとその理由、Reactコードがブラウザによってどのようにレンダリングされるのか、ペインティングとは何か、これらがなぜ重要で、SSRがどのような役割を果たすのかが分かると思います。</p>
<h2>useEffectの問題点とは？ <a name="01"></a></h2>
<p>では実際にコーディングしてみましょう。今日は少し凝ったことがしたいので、レスポンシブ対応のナビゲーションコンポーネントを作ってみます。このコンポーネントは、1列に並んだリンクをレンダリングし、コンテナのサイズに応じてリンクの数を調整することができます。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/menu-full-screen.png"></p>
<p>コンテナに収まりきらないリンクがある場合は「もっと見る」ボタンを表示し、これをクリックするとドロップダウンメニューに残りのリンクが表示されるようにします。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/menu-collapsed.png"></p>
<p>次はコンポーネント本体です。作るのは、データ配列を受け取り、適切なリンクをレンダリングするコンポーネントのみです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navigation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>href<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>では、これをレスポンシブ化するにはどうすればよいでしょうか。問題は、与えられたスペースに入るアイテムの数を計算しなくてはならないことです。そのためには、レンダリングが行われるコンテナの幅と、各アイテムのサイズが分からなくてはなりません。文字数を数えるなどして、事前に仮定することはできません。ブラウザ上でのテキストのレンダリングは、使用するフォントや言語、ブラウザによって異なります。ひょっとすると、月の満ち欠けの影響も受けるかもしれません。
実際のサイズを取得する唯一の方法は、ブラウザにそれらのアイテムをレンダリングさせた上で、<code class="language-text">getBoundingClientRect</code>というJavaScriptのネイティブAPI経由でサイズを抽出するやり方です。
これを行うにはいくつかの手順を踏む必要があります。まず、要素にアクセスします。Refを作成し、対象となるアイテムをラップするdivに代入することができます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navigation<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Refの使い方や、Refを使ったDOMの操作に自信がない方は、<a href="/refs-from-dom-to-api/">"ReactにおけるRef：DOMへのアクセスから命令型APIまで"</a>をお読みください。
次に、useEffectでdiv要素を取得し、そのサイズを確認します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> div <span class="token operator">=</span> ref<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> width <span class="token punctuation">}</span> <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>それからdivの子要素を反復処理し、幅を配列の中に抽出します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// same code as before</span>


    <span class="token comment">// convert div's children into an array</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>div<span class="token punctuation">.</span>childNodes<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// all the widths</span>
    <span class="token keyword">const</span> childrenWidths <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=></span> child<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>後はこの配列を反復処理し、子要素の幅を合計し、その合計を親要素のdivと比較すれば、最終的に表示されるアイテムが分かります。
ただ、1つ忘れているものがあります。「もっと見る」ボタンです。このボタンの幅も考慮に入れなくてはいけません。そうしなければ、いくつかのアイテムは表示されるものの、「もっと見る」ボタンが入りきらないという状況になりかねません。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/more-button-should-fit.png"></p>
<p>「もっと見る」ボタンの場合も同様に、ブラウザ上でレンダリングしなければ幅は分かりません。したがって、最初のレンダリング時に明示的にボタンを追加する必要があります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navigation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>href<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      &lt;!-- add the "more" button after the links explicitly -->
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>more<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>抽象化によって幅計算のロジックを全て関数にまとめるならば、useEffectの中は次のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> itemIndex <span class="token operator">=</span> <span class="token function">getLastVisibleItem</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>ここでは、<code class="language-text">getLastVisibleItem</code>関数が、全ての計算を行い、1つの数字を返してくれます。この数字が、与えられたスペースに入る最後のリンクのインデックスです。今回はロジック自体については詳しく説明しません。やり方は無数にあり、後で紹介する最終コードの中で例をお見せします。
ここで重要なのは、この数字を得たことです。Reactの観点から次に行うべきことは何でしょうか。このままだと、全てのリンクと「もっと見る」ボタンが表示されてしまいます。解決策は1つしかありません。コンポーネントの更新をトリガーし、表示されるべきでないアイテムを取り除く必要があります。
これがほぼ唯一の方法です。数字は取得したときのステートで保存する必要があります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// set the initial value to -1, to indicate that we haven't run the calculations yet</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>lastVisibleMenuItem<span class="token punctuation">,</span> setLastVisibleMenuItem<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> itemIndex <span class="token operator">=</span> <span class="token function">getLastVisibleItem</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// update state with the actual number</span>
      <span class="token function">setLastVisibleMenuItem</span><span class="token punctuation">(</span>itemIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>そして、メニューをレンダリングする際に、それを考慮に入れます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>


  <span class="token comment">// render everything if it's the first pass and the value is still the default</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastVisibleMenuItem <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render all of them here, same as before</span>
    <span class="token keyword">return</span> <span class="token operator">...</span>
  <span class="token punctuation">}</span>


  <span class="token comment">// show "more" button if the last visible item is not the last one in the array</span>
  <span class="token keyword">const</span> isMoreVisible <span class="token operator">=</span> lastVisibleMenuItem <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>


  <span class="token comment">// filter out those items which index is more than the last visible</span>
  <span class="token keyword">const</span> filteredItems <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> index <span class="token operator">&lt;=</span> lastVisibleMenuItem<span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>navigation<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      &lt;!-- render only visible items -->
      </span><span class="token punctuation">{</span>filteredItems<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>href<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
      &lt;!-- render "more" conditionally -->
      </span><span class="token punctuation">{</span>isMoreVisible <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>more<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これだけです。実際の数字でステートを更新すると、ナビゲーションのリレンダリングがトリガーされ、Reactがアイテムを再びレンダリングし、表示されないものを取り除きます。「適切」なレスポンシブ体験を作り出すためには、リサイズイベントを拾い、数字を再計算する必要もありますが、その実装については読者に委ねたいと思います。
完全に機能する例を下のCodeSandboxで公開しているのでご覧ください。リサイズにも対応しています😊。でも喜ぶのはまだ早いです。ユーザーエクスペリエンスに重大な欠陥が1つあります。</p>
<iframe src="https://codesandbox.io/embed/simple-responsive-menu-example-ltdx5r?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="simple-responsive-menu-example"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<p>何度かリフレッシュしてみてください。特に、CPUがスローダウンしている状態で試してみてください。残念なことに、コンテンツのチラつきがかなりひどいことが分かると思います。メニューの全てのアイテムと「もっと見る」ボタンが表示される最初のレンダリング結果は、はっきりと見えなくてはいけません。本番公開までに確実に修正する必要があります。</p>
<h2>useLayoutEffectでチラつきを解決する <a name="02"></a></h2>
<p>画面のチラつきの原因は明らかです。不要なアイテムを除外する前にアイテムをレンダリングして表示させてしまうので、チラつきが発生します。また、レスポンシブデザインが機能するためには最初にレンダリングを行う必要があります。したがって、この問題を解決する方法としては、最初のレンダリングはそのまま実行しますが、opacityを0に設定して行うか、表示領域外のdivの中で見えないように行う方法が考えられます。そして、サイズとマジックナンバーを抽出してから表示させるのです。以前は、このようなケースにはこの方法で対応していました。
しかし、フックが導入されたReact 16.8以降は、<code class="language-text">useEffect</code>フックを<code class="language-text">useLayoutEffect</code>に置き換えるだけで解決できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// everything is exactly the same, only the hook name is different</span>
    <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// the code is still the same</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これだけで、まるで魔法のように最初のチラつきがなくなります。実際にご覧ください。</p>
<iframe src="https://codesandbox.io/embed/simple-responsive-menu-example-fixed-hx1dxc?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="simple-responsive-menu-example-fixed"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<p>しかし、これは安全な方法なのでしょうか。もしそうであるならば、<code class="language-text">useEffect</code>を全てこれに置き換えればよいのではないでしょうか。ドキュメントには、<code class="language-text">useLayoutEffect</code>は<a href="https://react.dev/reference/react/useLayoutEffect">パフォーマンスに悪影響を及ぼす可能性がある</a>ため、使用を避けるべきであるとはっきりと記載されています。なぜでしょうか。ドキュメントには、<code class="language-text">useLayoutEffect</code>は「ブラウザが画面をリペイントする前」に発火するとも書かれています。これはつまり、<code class="language-text">useEffect</code>は画面がリペイントされた後で発火することを暗に示しています。しかし、これは実用面では具体的にどのような意味を持つのでしょうか。単純なドロップダウンを記述する際にブラウザペインティングのような低レイヤーの概念について考える必要があるのでしょうか🤯。
これらの問いに答えるためには、少しReactから離れてブラウザとJavaScriptについて話す必要があります。</p>
<h2>解決策が有効な理由：レンダリング、ペインティング、ブラウザ <a name="03"></a></h2>
<p>ここでまず必要なのは、「ブラウザレンダリング」です。Reactの世界では、Reactにおけるレンダリングと区別するために「ペインティング」とも呼ばれています。Reactにおけるレンダリングとペインティングは全くの別物です。考え方としては比較的単純です。ブラウザは、画面上にリアルタイムで表示する必要があるものを全て継続的に更新するわけではありません。例えば、ホワイトボードに線を描き、線を消し、文字を書き、あるいはフクロウのスケッチを描いたりするのとは違います。
それよりも、スライドを切り替えながら表示するのに似ています。あるスライドを表示して、見ている人がその内容を理解したら次のスライドに移るという要領です。
非常に遅いブラウザにフクロウの描き方を聞いたならば、おそらく以下の絵のようなひどい指示が返ってくるでしょう。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/owl.png"></p>
<p>ただし、ブラウザが描くスピードは非常に速いです。通常、モダンなブラウザは60fps（毎秒60フレーム）のフレームレートを維持しようとします。約13ミリ秒ごとにスライドが切り替わるイメージです。Reactで「ペインティング」と呼ぶのはこの処理のことです。
スライドを更新する情報は複数の「タスク」に分割されます。タスクはキューに入れられます。ブラウザはキューからタスクを取得して実行します。時間に余裕があれば、約13ミリ秒の中で時間がなくなるまで次のタスクを実行していき、最後に画面をリフレッシュします。これを休むことなく続けます。私たちがこうした処理を意識せずにTwitter（X）でドゥームスクローリングを行ったりできるのはそのおかげです。
「タスク」とは何でしょうか。通常のJavaScriptの場合、scriptタグに入れて同時に実行するもの全てをタスクと呼びます。次のコードをご覧ください。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> child <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"&lt;h1>Heyo!&lt;/h1>"</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>


child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 10px solid red"</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 20px solid green"</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 30px solid black"</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>IDを使用して要素を取得し、<code class="language-text">app</code>変数に入れ、<code class="language-text">div</code>を作成します。次に、HTMLを更新してdivをappに付加し、divのborderを3回変更します。ブラウザにとっては、この一連の処理が全て1つのタスクとして認識されます。したがって、全ての行を実行してから、最終結果である黒いborderのdivを描画します。
画面上では、赤→緑→黒の遷移は見えません。
1つの「タスク」に13ミリ秒以上かかる場合はどうなるでしょうか。まあ、残念だと言うしかありません 🤷🏻‍♀️。ブラウザは、タスクを停止することも分割することもできません。完了するまで処理を続けてから、最終結果をペイントします。borderの更新間に1秒間のブロッキング（原文では synchronous delays）を追加した場合、次のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">waitSync</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    now <span class="token operator">=</span> start<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> start <span class="token operator">&lt;</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 10px solid red"</span><span class="token punctuation">;</span>
<span class="token function">waitSync</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 20px solid green"</span><span class="token punctuation">;</span>
<span class="token function">waitSync</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 30px solid black"</span><span class="token punctuation">;</span>
<span class="token function">waitSync</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>その場合でも、「中間」の結果は見えません。ブラウザが処理を行う間は何もない画面が表示されるだけで、最後に黒いborderが表示されます。これを「ブロッキングレンダー」あるいは「ブロッキングペインティング」コードと呼びます。
<a href="https://codesandbox.io/s/understanding-painting-sync-example-m76lzh">CodesSandboxで例をご覧ください</a>。
Reactは単なるJavaScriptですが、もちろん単一のタスクとして実行されるわけではありません。もしそうであるならば、インターネットは耐えがたいものになるでしょう。そうなれば私たちは皆外に出て遊び、直接人と関わることを余儀なくされるでしょう。そんなことを誰が望むでしょうか。アプリ全体をレンダリングするような巨大なタスクを小さなタスクに「分割」するには、コールバック、イベントハンドラー、プロミスなどさまざまな「非同期」メソッドを使用する必要があります。
これらのスタイル調整を、遅延0で<code class="language-text">setTimeout</code>にラップしたとします。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 10px solid red"</span><span class="token punctuation">;</span>
  <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 20px solid green"</span><span class="token punctuation">;</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      child<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token string">"border: 30px solid black"</span><span class="token punctuation">;</span>
      <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>その場合、全てのタイムアウトが新しい「タスク」と見なされます。したがって、ブラウザは1つのタスクを終え、次のタスクを開始する前に、画面をリペイントできます。そして、何もない白い画面を3秒間ぼーっと眺める代わりに、赤から緑へ、そして黒へと、ゆっくりとではあるものの美しく移り変わる様子を見ることができます。
<a href="https://codesandbox.io/embed/understanding-painting-sync-example-m76lzh?fontsize=14&#x26;hidenavigation=1&#x26;theme=dark">コード付きのCodeSandboxはこちらをご覧ください</a>。
Reactはこのようなことを行ってくれます。一言で言えば、Reactはコーディングによって作られた何百ものnpmの依存関係で構成される巨大な塊を、ブラウザが（理想的には）13ミリ秒以内で処理できる最小限の塊に分割してくれる、極めて複雑で効率的なエンジンです。
これは非常にかいつまんだ短い紹介です。きちんと説明しようと思えば1冊の本になってしまいます。<a href="https://blog.xnim.me/event-loop-and-render-queue">"Browser Event loop: micro and macro tasks, call stack, render queue: layout, paint, composite"</a>は、ブラウザのイベントループとクエリに関する極めて秀逸な総合ガイドです。</p>
<h3>useEffectとuseLayoutEffectの比較に戻る <a name="031"></a></h3>
<p>では、<code class="language-text">useEffect</code>と<code class="language-text">useLayoutEffect</code>の比較に戻り、最初に挙げたいくつかの問いについて検討したいと思います。
<code class="language-text">useLayoutEffect</code>は、コンポーネントの更新時にReactが同時に実行するものです。次のコードをご覧ください。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>コンポーネントの中で何かをレンダリングすると、必ず<code class="language-text">useLayoutEffect</code>が同じ「タスク」として実行されます。Reactがそれを保証します。たとえ<code class="language-text">useLayoutEffect</code>の中でステートを更新しても、通常ステートは非同期タスクと見なされますが、Reactはそれでも全体のフローが同時に実行されるようにします。
最初に実装した「ナビゲーション」の例に戻りましょう。ブラウザの観点から言うと、これは1つの「タスク」に過ぎません。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/use-layout-flow.png"></p>
<p>この状況は、見ることができなかった赤→緑→黒のborder線の遷移と全く同じです。
一方、<code class="language-text">useEffect</code>の場合、フローが2つのタスクに分割されます。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/use-effect-flow.png"></p>
<p>1つ目のタスクでは、全てのボタンを含むナビゲーションの「最初」のレンダリングをし、2つ目のタスクでは、不要な子要素を除外します。そして、2つのタスクの間に画面のリペインティングが行われます。タイムアウト間のborderと全く同じ状況です。
では、最初の問いに答えましょう。<code class="language-text">useLayoutEffect</code>を使うのは安全でしょうか。はい、安全です。パフォーマンスに悪影響を及ぼす可能性はあるでしょうか。もちろんです。Reactのアプリ全体が同時に実行される1つの巨大な「タスク」になってしまうのは望ましくありません。
<code class="language-text">useLayoutEffect</code> の使用は、要素の実際のサイズに従ってUIを調整する必要があり、それによって引き起こされる視覚的な「乱れ」を取り除く必要がある場合のみにしてください。それ以外は<code class="language-text">useEffect</code>を使うのが正解です。<a href="https://react.dev/learn/you-might-not-need-an-effect">"You Might Not Need an Effect – React"</a>によると、それさえも必要ないかもしれません。</p>
<h3>useEffectについてもう少し <a name="032"></a></h3>
<p><code class="language-text">setTimeout</code>の中で<code class="language-text">useEffect</code>を実行するメンタルモデルは違いを理解するのには便利ですが、厳密には正確ではありません。まず、実装の詳細を明確にすると、Reactはこのモデルではなく、<code class="language-text">postMessage</code>を<code class="language-text">requestAnimationFrame</code>のトリックと組み合わせて使用します。このトリックについては私も知りませんでした。詳しく知りたい方は、<a href="https://stackoverflow.com/questions/56727477/react-how-does-react-make-sure-that-useeffect-is-called-after-the-browser-has-h/56727837#56727837">"React: How does React make sure that useEffect is called after the browser has had a chance to paint?"</a>で説明されているのでぜひご覧ください。
また、非同期に実行されることは実際には保証されていません。Reactは可能な限り最適化しようとしますが、ブラウザペイントの前に実行され、結果的にブロックされるケースもあります。そのようなケースの1つが、一連の更新のどこかに<code class="language-text">useLayoutEffect</code>がすでに存在する場合です。理屈と仕組みを理解したい場合は、<a href="https://blog.thoughtspile.tech/2021/11/15/unintentional-layout-effect/">"useEffect sometimes fires before paint"</a>をご覧ください。こちらの記事にとても優れた調査結果が詳しくまとめられています。</p>
<h2>Next.jsやその他のSSRフレームワークでuseLayoutEffectを実行する <a name="04"></a></h2>
<p>低レイヤーJavaScriptやブラウザについてはこれくらいにして、本番コードに戻りたいと思います。というのも、「現実世界」では、これらはさほど頻繁に考える必要のないことだからです。「現実世界」では、Next.js（Next.jsの宣伝記事ではないので、もちろん他のフレームワークでも構いません😅​​​​）のようなフレームワーク上で、美しいレスポンシブナビゲーションをコーディングし、優れたユーザーエクスペリエンスを構築できればよいのです。
実際にやってみると、全くうまくいかないことにまず気づきます。チラつきはなくなっておらず、魔法はもう消えています。<a href="https://codesandbox.io/p/sandbox/simple-nextjs-uselayout-example-6sflsg?file=%2FREADME.md">こちらの例を開いて</a>何度かページをリフレッシュしてみてください。もしくは、Next.jsアプリをお持ちでしたら、前に修正したナビゲーションをコピペしてみてください。
何が起きているのでしょうか？🤨
SSR、つまりサーバーサイドレンダリングです。一部のフレームワークがデフォルトでサポートしている素晴らしい機能ですが、このようなケースでは極めて厄介な代物です。
SSRが有効になっていると、Reactコンポーネントの最初のレンダリングと全てのライフサイクルイベントの呼び出しは、コードがブラウザに届く前にサーバー上で行われます。SSRの仕組みに詳しくない人のために説明すると、これは単にバックエンドのどこかで何らかのメソッドが<code class="language-text">React.renderToString(&lt;App /&gt;)</code>のようなものを呼び出すということを意味します。そうすると、Reactは次にアプリ内の全てのコンポーネントを処理して「レンダリング」（単に関数を呼び出すということです。コンポーネントはただの関数なので）し、各コンポーネントが表すHTMLを生成します。</p>
<p><img src="https://www.developerway.com/assets/no-more-flickering-ui/react-to-html-ssr.png"></p>
<p>次に、このHTMLがブラウザに送られるページ内に注入され、ページが送信されます。これは、全てがサーバー上で生成され、メニューを開くためだけにJavaScriptを使用していた昔と同じやり方です。その後、ブラウザがページをダウンロードして表示し、（Reactを含む）全てのスクリプトをダウンロードして（Reactも含めて）実行します。Reactはあらかじめ生成されたHTMLを処理し、多少のインタラクティブ要素を組み込みます。これで再びページが使える状態になります。
問題は、最初のHTMLを生成した時点では、まだブラウザがないということです。したがって、要素の実際のサイズ計算（<code class="language-text">useLayoutEffect</code>で行うような）を必要とする処理は、サーバー上では単純にうまくいきません。サイズのある要素はまだ存在せず、あるのは文字列だけなので。<code class="language-text">useLayoutEffect</code>の目的そのものが要素のサイズを取得することなので、サーバー上で実行してもあまり意味はありません。Reactはサーバー上で実行しません。
その結果、ブラウザが最初に読み込む、まだインタラクティブ要素のないページに表示されるのは、コンポーネントの「最初」のステージでレンダリングされた内容です。すなわち、「もっと見る」ボタンを含む全てのボタンの列です。ブラウザが全ての処理を実行し、Reactが機能する状態になったら、ようやく<code class="language-text">useLayoutEffect</code>を実行できるようになり、ボタンが隠れます。しかし、画面のチラつきはあります。
これをどう修正するかはユーザーエクスペリエンスの問題であり、ユーザーに「デフォルトで」何を表示したいかによります。メニューの代わりに「読み込み中」の状態を表示したり、最も重要なメニュー項目を1つか2つ表示したり、項目を完全に非表示にしてクライアント上でのみレンダリングすることもできるでしょう。どうするかはあなた次第です。
1つの方法としては、shouldRenderというステート変数を導入し、<code class="language-text">useEffect</code>の中でtrueに切り替えます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shouldRender<span class="token punctuation">,</span> setShouldRender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setShouldRender</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldRender<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SomeNavigationSubstitude</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Navigation</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">useEffect</code>はクライアント上でのみ実行されるため、初回のSSRでは代替コンポーネントが表示されます。次に、クライアントコードが作動し、<code class="language-text">useEffect</code>が実行され、ステートが変わり、Reactがそれを通常のレスポンシブナビゲーションに置き換えます。
ここでステートを導入することを恐れる必要はありません。また、次のような条件付きのレンダリングを実行しようとしないでください。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Detecting SSR by checking whether window is there</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> ‘<span class="token keyword">undefined</span>’<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SomeNavigationSubstitude</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Navigation</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>厳密には、typeof window === ‘undefined’はSSR環境を示しますが（サーバー上にウィンドウはありません）、私たちのユースケースでは役に立ちません。Reactでは、SSRから受け取ったHTMLと、クライアント上で初回にレンダリングされたHTMLが完全に一致する必要があります。これらが一致しない場合、アプリは正常に機能しません。さらに詳しく知りたい人は、<a href="https://www.joshwcomeau.com/react/the-perils-of-rehydration/">The Perils of Rehydration</a>という記事がこのテーマについて優れた考察を行っていますので、そちらをご覧ください。</p>
<hr>
<p>手軽で便利なトリックについて簡単に説明するだけのつもりが、レンダリングについてかなり突っ込んだ議論になってしまいました。途中で脱落された方がいないことを願います​​😅
この調査で参考にしたリソースを以下にご紹介します。さらに詳しく学びたい方は、ぜひご覧ください。</p>
<ul>
<li><a href="https://overreacted.io/react-as-a-ui-runtime/">React as a UI Runtime</a>　Dan Abramov氏によるこちらの記事は読み応えがあるので、一晩かけて読むことをお勧めします。</li>
<li><a href="https://github.com/acdlite/react-fiber-architecture">GitHub - acdlite/react-fiber-architecture</a>　Reactの新しいコアアルゴリズムであるReact Fiberについて説明した記事です。</li>
<li><a href="https://blog.xnim.me/event-loop-and-render-queue">Browser Event loop: micro and macro tasks, call stack, render queue: layout, paint, composite</a></li>
<li><a href="https://web.dev/rendering-performance/">Rendering Performance</a></li>
<li><a href="https://www.joshwcomeau.com/react/the-perils-of-rehydration/">The Perils of Rehydration</a></li>
<li><a href="https://blog.thoughtspile.tech/2021/11/15/unintentional-layout-effect/">useEffect sometimes fires before paint</a></li>
<li><a href="https://react.dev/learn/you-might-not-need-an-effect">You Might Not Need an Effect – React</a></li>
<li><a href="https://react.dev/learn/render-and-commit">Render and Commit – React</a></li>
</ul>
<p>さらに理解を深めていただくために、YouTube動画もぜひご覧ください。概念によっては、2パラグラフ分の文章よりも3秒のアニメーションの方が伝わりやすい場合もあります。</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/__tm1dyMi4A?si=5OyDZC2bnkehUXLR" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
<p>ではまた次回お会いしましょう。</p>]]></content:encoded></item><item><title><![CDATA[ReactにおけるRef：DOMへのアクセスから命令的APIまで]]></title><description><![CDATA[この記事では、ReactにおいてDOMへのアクセスが必要な理由と、その際にRefがどう役立つのかを見ていきます。また、useRef、forwardRef、useImperativeHandleという…]]></description><link>https://postd.cc/refs-from-dom-to-api/</link><guid isPermaLink="false">https://postd.cc/refs-from-dom-to-api/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><pubDate>Wed, 30 Aug 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>この記事では、ReactにおいてDOMへのアクセスが必要な理由と、その際にRefがどう役立つのかを見ていきます。また、useRef、forwardRef、useImperativeHandleという3つのフックについて説明し、これらを適切に使用する方法を紹介したいと思います。
この記事と同じ内容を扱ったYouTube動画も公開していますので、活字媒体よりも動画視聴を好まれる方はそちらをご覧ください。文字ではなく、アニメーションと音声で同じ概念を解説しています。
<a href="https://youtu.be/H9KhRiO1UeU">この記事は動画形式でも公開しています。</a></p>
<h2>目次</h2>
<ul>
<li><a href="#01">useRefを使用してReactでDOMにアクセスする</a></li>
<li><a href="#02">親から子にRefをpropとして渡す</a></li>
<li><a href="#03">forwardRefを使用して親から子にRefを渡す</a></li>
<li><a href="#04">useImperativeHandleを使用した命令型API</a></li>
<li><a href="#05">useImperativeHandleを使用しない命令型API</a></li>
</ul>
<p>Reactには素晴らしい点が多数ありますが、その1つは実際のDOMを抽象化することでその複雑性を取り除いてくれることです。手動でクエリを実行して要素を取得したり、取得した要素にどのようにしてクラスを追加するか頭を悩ませたり、ブラウザの不整合に手を焼いたりすることがなく、コンポーネントを記述するだけでよいので、ユーザーエクスペリエンスにフォーカスすることができます。しかし、極めてまれではありますが、実際のDOMにアクセスしなくてはならないケースもあります。
実際のDOMに関しては、RefとRefに関連するあらゆることを理解し、その適切な使用方法を学ぶことが何よりも重要です。したがって、今日はそもそもなぜDOMにアクセスする必要があるのか、その際にRefがどう役立つのかを説明し、<code class="language-text">useRef</code>、<code class="language-text">forwardRef</code>、<code class="language-text">useImperativeHandle</code>の特徴とその適切な使用方法について見ていきたいと思います。また、<code class="language-text">forwardRef</code>と<code class="language-text">useImperativeHandle</code>の使用を避けつつ、その恩恵を受ける方法についても詳しく話します。これらのフックの仕組みについて調べてみたことのある人なら、なぜそうすることが望ましいのかお分かりいただけるでしょう。
さらに、Reactで命令的APIを実装する方法についても紹介します。</p>
<h2>useRefを使用してReactでDOMにアクセスする <a name="01"></a></h2>
<p>自分が主催する会議の登録フォームを実装するとします。参加者に詳細を送れるように、氏名とメールアドレス、Twitter（現在は「X」に名称変更）ハンドルネームを知らせてもらう必要があり、「氏名」と「メールアドレス」の入力欄は必須項目にしたいと思っています。ただし、空欄のまま送信ボタンが押されても、ただ赤枠を表示するだけでは面白くないので、空欄にフォーカスし、入力欄が揺れるようにすることで入力を促します。
Reactには多くの機能が備わっていますが、必要なものが全てそろっているわけではありません。例えば、「手動で要素にフォーカスする」といった機能は提供されていません。したがって、この機能を実装するにはJavaScriptのネイティブAPIを利用しなくてはならず、そのためには実際のDOM要素にアクセスする必要があります。
Reactが存在しない世界では、まず次のような処理を実行します。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"bla"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>次に、要素にフォーカスします。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>もしくは、その要素までスクロールします。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">element<span class="token punctuation">.</span><span class="token function">scrollIntoView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>他にもやり方はあるでしょう。Reactの世界でネイティブのDOM APIを使用する場合、以下のようなユースケースが一般的です。</p>
<ul>
<li>フォームの入力欄のように、要素をレンダリングした後、手動で<strong>要素にフォーカスする</strong></li>
<li>ポップアップのような要素を表示する際、<strong>コンポーネントの外のクリック</strong>を検知する</li>
<li>画面上に要素が表示された後、手動で<strong>要素までスクロールする</strong></li>
<li>ツールチップのようなものを正しい位置に表示するために、コンポーネントの<strong>サイズと境界を計算する</strong></li>
</ul>
<p>厳密には、今でも<code class="language-text">getElementById</code>メソッドを使おうと思えば使えますが、Reactではより強力な方法で指定要素にアクセスすることができます。その方法を使えば、至るところにIDを設定する必要がなく、DOMの基本構造を意識する必要もありません。その方法というのが<a href="https://react.dev/reference/react/useRef#manipulating-the-dom-with-a-ref">Ref</a>です。
Refは単なるミュータブルなオブジェクトであり、Refへの参照は再レンダリングをまたいでReactが保持します。Refは再レンダリングをトリガーしないため、ステートの代わりにはなりません。したがって、ステートをRefで代用しようとするのは避けてください。両者の違いに関する詳細は、<a href="https://react.dev/learn/referencing-values-with-refs#differences-between-refs-and-state">ドキュメントをご覧ください</a>。
Refは、<code class="language-text">useRef</code>フックを使用して作成します。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// create a ref with default value null</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Refに格納された値は、currentという（唯一の）プロパティの中にあります。この中には何でも格納できます。例えば、ステートから取得した値をオブジェクトに格納することもできます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// re-write ref's default value with new object</span>
    ref<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">someFunc</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      someValue<span class="token operator">:</span> stateValue<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>stateValue<span class="token punctuation">]</span><span class="token punctuation">)</span>




  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>あるいは、ここでお話しするユースケースにとってより重要な例を挙げると、Refは任意のDOM要素と一部のReactコンポーネントに代入できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// assign ref to an input element</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">useEffect</code>（コンポーネントがレンダリングされた後のみ利用可能）の中で<code class="language-text">ref.current</code>をログ出力すると、その入力に対して<code class="language-text">getElementById</code>を実行した場合と全く同じ要素が得られます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// this will be a reference to input DOM element!</span>
    <span class="token comment">// exactly the same as if I did getElementById for it</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>そして、登録フォームを1つの巨大なコンポーネントとして実装するならば、次のような処理を実行できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">const</span> <span class="token function-variable function">onSubmitClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// focus the input field if someone tries to submit empty name</span>
      ref<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// submit the data here!</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setName</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSubmitClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Submit the form!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>入力された値をステートに保存し、全ての入力に対してRefを作成し、「送信」ボタンがクリックされたら値が空ではないか確認し、空であれば必要な入力欄にフォーカスします。
このフォームの実装をCodeSandboxで公開していますのでご覧ください。</p>
<iframe src="https://codesandbox.io/embed/giant-form-ref-example-23z9vf?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="giant-form-ref-example"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<h2>親から子にRefをpropとして渡す <a name="02"></a></h2>
<p>もちろん、実際に全てを1つの巨大なコンポーネントとして実装することはありません。どちらかといえば、入力は複数のフォームで再利用し、独自のスタイルをカプセル化して制御できるよう、固有のコンポーネントに抽出したいと思います。そうすることで、上部にラベルを表示したり、右側にアイコンを表示したりといった機能を追加することもできます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onChange<span class="token punctuation">,</span> label <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span>label<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">onChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>
しかし、エラーハンドリングと送信機能はinputではなく、依然としてFormの中にあります。
<span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">const</span> <span class="token function-variable function">onSubmitClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// deal with empty name</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// submit the data here!</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setName<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSubmitClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Submit the form!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>入力に対し、<code class="language-text">Form</code>のコンポーネントから「自らにフォーカスする」ように指示するにはどうすればよいでしょうか。通常、Reactにおいてデータと挙動を制御するには、コンポーネントにpropを渡し、コールバックを監視します。「focusItself」というpropを<code class="language-text">InputField</code>に渡し、これを<code class="language-text">false</code>から<code class="language-text">true</code>に切り替えることもできますが、これがうまくいくのは1回だけです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// don't do this! just to demonstate how it could work in theory</span>
<span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onChange<span class="token punctuation">,</span> focusItself <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>focusItself<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// focus input if the focusItself prop changes</span>
      <span class="token comment">// will work only once, when false changes to true</span>
      ref<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>focusItself<span class="token punctuation">]</span><span class="token punctuation">)</span>


  <span class="token comment">// the rest is the same here</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>「onBlur」というコールバックを追加して、入力がフォーカスを失ったら<code class="language-text">focusItself</code>propをリセットして<code class="language-text">false</code>に戻したり、ブール値の代わりに乱数値に変更したりすることもできます。あるいは、その他の工夫を考案することもできるかもしれません。</p>
<p>おそらく、他にもやり方はあるでしょう。propをいじるのではなく、単にあるコンポーネント（<code class="language-text">Form</code>）の中にRefを作成し、これを別のコンポーネント（<code class="language-text">InputField</code>）に渡して、そこで基本構造のDOM要素に接続することもできるでしょう。結局のところ、Refはただのミュータブルなオブジェクトなので。</p>
<p>次に、<code class="language-text">Form</code>が今までと同じくRefを作成します。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// create the Ref in Form component</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">InputField</code>コンポーネントには、今までと同じくRefを受け取るためのpropと<code class="language-text">input</code>フィールドがあります。違うのは、Refが<code class="language-text">InputField</code>の中で作成されるのではなく、propから渡されるということです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> inputRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// the rest of the code is the same</span>


  <span class="token comment">// pass ref from prop to the internal input component</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Refはミュータブルなオブジェクトであり、そのように設計されています。Refを要素に渡すと、その下にあるReactがRefに変更を加えます。そして、変更されるオブジェクトは<code class="language-text">Form</code>コンポーネントの中で宣言されます。したがって、<code class="language-text">InputField</code>がレンダリングされると、Refオブジェクトはすぐに変更され、<code class="language-text">Form</code>は<code class="language-text">inputRef.current</code>内の<code class="language-text">input</code> DOM要素にアクセスすることができます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// create the Ref in Form component</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// the "input" element, that is rendered inside InputField, will be here</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>inputRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* Pass ref as prop to the input field component */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">inputRef</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>あるいは、submitコールバックの中で、前と全く同じコードであるinputRef.current.focus()を呼び出すことができます。
こちらの例をご覧ください。</p>
<iframe src="https://codesandbox.io/embed/example2-pass-ref-as-prop-5i03u9?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="example2: pass ref as prop"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<h2>forwardRefを使用して親から子にRefを渡す <a name="03"></a></h2>
<p>propの名前を単に<code class="language-text">ref</code>ではなく、<code class="language-text">inputRef</code>としたのはなぜだろうと不思議に思う人もいるかもしれませんが、実際はそれほど単純なことではありません。<code class="language-text">ref</code>は実際にはpropではなく、予約語のようなものです。昔、まだクラスコンポーネントを記述していた頃は、Refをクラスコンポーネントに渡すと、このコンポーネントのインスタンスはそのRefの<code class="language-text">.current</code>値になっていました。
しかし、関数コンポーネントにインスタンスはないため、コンソール上に次のような警告が表示されます。「Function components cannot be given refs. Attempts to access this ref will fail. Did you mean to use React.forwardRef()?」</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// if we just do this, we'll get a warning in console</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これが機能するためには、Reactにこの<code class="language-text">ref</code>が実際に意図したものであり、これを使ってやりたいことがあると伝える必要があります。それには、<code class="language-text">forwardRef</code>関数の助けを借ります。この関数は、コンポーネントを受け入れ、コンポーネントの関数の第2引数として<code class="language-text">ref</code>属性からRefを挿入します。挿入位置はpropのすぐ後ろです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// normally, we'd have only props there</span>
<span class="token comment">// but we wrapped the component's function with forwardRef</span>
<span class="token comment">// which injects the second argument - ref</span>
<span class="token comment">// if it's passed to this component by its consumer</span>
<span class="token keyword">const</span> InputField <span class="token operator">=</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// the rest of the code is the same</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>上のコードを2つの変数に分けることで、可読性を向上させることもできます。</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">InputFieldWithRef</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> ref</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// the rest is the same</span>
<span class="token punctuation">}</span>

<span class="token comment">// this one will be used by the form</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> InputField <span class="token operator">=</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span>InputFieldWithRef<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで、<code class="language-text">Form</code>は通常のDOM要素と同様にRefをInputFieldコンポーネントに渡すことができます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p><code class="language-text">forwardRef</code>を使用するか、Refをpropとして渡すかは、単なる好みの問題であり、最終結果は同じです。
こちらの実例をご覧ください。</p>
<iframe src="https://codesandbox.io/embed/example3-pass-ref-with-forwardref-eg30h5?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="example3: pass ref with forwardRef"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<h2>useImperativeHandleを使用した命令的API <a name="04"></a></h2>
<p><code class="language-text">Form</code>コンポーネントから入力欄にフォーカスする方法については大体お分かりいただけたかと思いますが、目指しているフォームはまだ完成ではありません。エラーが発生した場合、フォーカスするだけでなく入力欄が揺れるようにしたいとお話ししたと思います。JavaScriptのネイティブAPIに<code class="language-text">element.shake()</code>のようなものはありませんので、ここではDOM要素にアクセスしても役に立ちません。
しかし、CSSアニメーションとして簡単にこの機能を実装できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// store whether we should shake or not in state</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shouldShake<span class="token punctuation">,</span> setShouldShake<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// just add the classname when it's time to shake it - css will handle it</span>
  <span class="token keyword">const</span> className <span class="token operator">=</span> shouldShake <span class="token operator">?</span> <span class="token string">"shake-animation"</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>


  <span class="token comment">// when animation is done - transition state back to false, so we can start again if needed</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span></span> <span class="token attr-name">onAnimationEnd</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setShouldShake</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>では、アニメーションをトリガーするにはどうすればよいでしょうか。この場合も、フォーカスのときと要領は同じです。propを使って何かしら工夫を考案することはできるかもしれませんが、見た目が不自然であるだけでなく、かなり複雑なフォームになってしまいます。特に、Refを使用してフォーカスを実現していることを考えると、全く同じ問題に対して2つのソリューションを用いることになります。<code class="language-text">InputField.shake()</code>と<code class="language-text">InputField.focus()</code>のようなことができたら良いのですが。
フォーカスについて言うと、これをトリガーするために<code class="language-text">Form</code>コンポーネントがいまだにネイティブのDOM APIに頼る必要があるのはなぜでしょうか。こうした複雑性を抽象化によって取り除くのが、<code class="language-text">InputField</code>のそもそもの目的であり、担うべき役割ではないのでしょうか。フォームが基本構造のDOM要素にアクセスできるのもおかしな話です。これによって、実装に関する内部の詳細が漏れてしまいます。どのDOM要素を使用しているのか、そもそもDOM要素を使用しているのか、あるいは別のものを使用しているのかは、<code class="language-text">Form</code>コンポーネントの関心事であるべきではないのです。関心の分離の原則があるので。
<code class="language-text">InputField</code>コンポーネントに適切な命令的APIを実装するべきときが来たようです。現状、Reactは宣言的であり、それに従ってコードを記述することが求められています。しかし、命令によって何かをトリガーする方法が必要なこともあります。Reactには、そのようなときのためのescape hatchが用意されています。それが<a href="https://react.dev/reference/react/useImperativeHandle">useImperativeHandle</a>フックです。
このフックは理解するのが少し難しく、筆者もドキュメントを2回読み、何度か自分で試し、実際のReactコードに実装してみてようやくその仕組みを理解できました。しかし必要なものは、基本的に命令的APIの形を決めることと、それを接続するRefの2つだけです。入力はシンプルです。<code class="language-text">.focus()</code>と<code class="language-text">.shake()</code>の関数がAPIとして必要なだけであり、Refについてはすでに分かっています。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// this is how our API could look like</span>
<span class="token keyword">const</span> InputFieldAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// do the focus here magic</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// trigger shake here</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この<code class="language-text">useImperativeHandle</code>フックは、このオブジェクトをRefオブジェクトのcurrentプロパティに接続するだけです。その方法は以下の通りです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>


  <span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>someRef<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>第1引数はRefであり、コンポーネント自体の中で作成されるか、propから、もしくはforwardRefを通して渡されます。第2引数はオブジェクトを返す関数であり、このオブジェクトは<code class="language-text">inputRef.current</code>として利用できます。第3引数は依存配列であり、他のReactフックと同様です。
ここでのコンポーネントには、Refを<code class="language-text">apiRef</code> propとして明示的に渡します。後は、実際のAPIを実装するだけです。そのためには別のRefが必要になります。こちらは<code class="language-text">InputField</code>内のRefであり、通常通り<code class="language-text">input</code> DOM要素に接続してフォーカスをトリガーできます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// pass the Ref that we'll use as our imperative API as a prop</span>
<span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> apiRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// create another ref - internal to Input component</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">// "merge" our API into the apiRef</span>
  <span class="token comment">// the returned object will be available for use as apiRef.current</span>
  <span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>apiRef<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// just trigger focus on internal ref that is attached to the DOM object</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>「揺れる」動きについては、ステートの更新をトリガーします。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// pass the Ref that we'll use as our imperative API as a prop</span>
<span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> apiRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// remember our state for shaking?</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shouldShake<span class="token punctuation">,</span> setShouldShake<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token function">useImperativeHandle</span><span class="token punctuation">(</span>apiRef<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// trigger state update here</span>
      <span class="token function">setShouldShake</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


  <span class="token keyword">return</span> <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで、Formはrefを作成し、InputFieldに渡し、内部の実装について心配することなく、簡単なinputRef.current.focus()とinputRef.current.shake()を実行できます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">Form</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">const</span> <span class="token function-variable function">onSubmitClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// focus the input if the name is empty</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// and shake it off!</span>
      inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">shake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// submit the data here!</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    ...
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">InputField</span></span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>setName<span class="token punctuation">}</span></span> <span class="token attr-name">apiRef</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSubmitClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Submit the form!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>完全に機能するフォームのサンプルを実際に使ってみてください。</p>
<h2>useImperativeHandleを使用しない命令的API <a name="05"></a></h2>
<p><code class="language-text">useImperativeHandle</code>フックは目がけいれんを起こしそうだという人もいるかもしれません。実は、私もその1人です。今お話しした機能は、このフックを実際に使わなくても実装できます。Refの仕組みと、Refが変更可能であることはすでに分かっています。したがって、必要なRefの<code class="language-text">ref.current</code>にAPIオブジェクトを代入するだけでいいのです。以下に例を挙げます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">InputField</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> apiRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    apiRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">focus</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">shake</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>apiRef<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これは、<code class="language-text">useImperativeHandle</code>がバックグラウンドで実行する処理とほぼ同じです。実際の動作は以前と全く同じです。
実際には、<code class="language-text">useLayoutEffect</code>の方がもっと良いかもしれませんが、これについてはまた別の記事でお話ししたいと思います。今回は、従来通り<code class="language-text">useEffect</code>を使用します。
最後の例をご覧ください。</p>
<iframe src="https://codesandbox.io/embed/example5-imperative-api-without-useimperativehandle-yjyxd0?fontsize=14&hidenavigation=1&theme=dark"
     style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
     title="example5: imperative api without useImperativeHandle"
     allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
     sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
   ></iframe>
<p>揺れる動作が実装されたすてきなフォームの完成です。ReactにおけるRefの謎は解明され、命令的APIも使えるようになりました。実に素晴らしい。
次の点を覚えておいてください。Refはいわば「escape hatch」のようなもので、propやコールバックを使用したReactの通常のデータフローやステートの代わりになるものではありません。「通常の」代替策がない場合のみ使用してください。命令的に何かをトリガーするのも同様です。どちらかといえば、propやコールバックを使用した通常のフローの方が望ましいので。
さらに理解を深めていただくために、YouTube動画もぜひご覧ください。概念によっては、2段落分の文章よりも3秒のアニメーションの方が伝わりやすい場合もあります。</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/H9KhRiO1UeU?si=o5H0wzWfvB2Riyy3" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>]]></content:encoded></item><item><title><![CDATA[フロントエンドパフォーマンスのチェックリスト2021年版（PDF、Apple Pages、MS Word）-後編]]></title><description><![CDATA[目次＃ 前編 準備段階：計画と指標
パフォーマンスを重視する文化、Core Web Vitals、パフォーマンスのプロファイル、CrUX、Lighthouse、FID、TTI、CLS、端末。 現実的…]]></description><link>https://postd.cc/front-end-performance-2021-checklist-3/</link><guid isPermaLink="false">https://postd.cc/front-end-performance-2021-checklist-3/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[パフォーマンス]]></category><pubDate>Mon, 24 Jul 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<h2>目次<a href="#00">＃</a></h2>
<p><strong>前編</strong></p>
<ul>
<li><a href="/front-end-performance-2021-checklist-1/#01">準備段階：計画と指標</a><br>
パフォーマンスを重視する文化、Core Web Vitals、パフォーマンスのプロファイル、CrUX、Lighthouse、FID、TTI、CLS、端末。</li>
<li><a href="/front-end-performance-2021-checklist-1/#02">現実的な目標の設定</a><br>
パフォーマンスバジェット、パフォーマンス目標、RAILフレームワーク、170KB/30KBバジェット。</li>
<li><a href="/front-end-performance-2021-checklist-1/#03">環境の定義</a><br>
フレームワークの選択、パフォーマンスコストの基準設定、Webpack、依存関係、CDN、フロントエンドアーキテクチャ、CSR、SSR、CSR + SSR、静的レンダリング、プリレンダリング、PRPLパターン。</li>
</ul>
<p><strong>中編</strong></p>
<ul>
<li><a href="/front-end-performance-2021-checklist-2/#04">アセットの最適化</a><br>
Brotli、AVIF、WebP、レスポンシブ画像、AV1、アダプティブメディア読み込み、動画圧縮、Webフォント、Googleフォント。</li>
<li><a href="/front-end-performance-2021-checklist-2/#05">ビルドの最適化</a><br>
JavaScriptモジュール、モジュール/ノーモジュールのパターン、ツリーシェイキング、コード分割、スコープホイスティング、Webpack、デファレンシャルサービング、Webワーカー、WebAssembly、JavaScriptバンドル、React、SPA、パーシャルハイドレーション、インポート・オン・インタラクション、サードパーティ、キャッシュ</li>
</ul>
<p><strong>後編</strong></p>
<ul>
<li><a href="#06">デリバリの最適化</a><br>
遅延読み込み、インターセクションオブザーバー、遅延レンダリングとデコーディング、クリティカルCSS、ストリーミング、リソースヒント、レイアウトシフト、サービスワーカー。</li>
<li><a href="#07">ネットワーク接続、HTTP/2、HTTP/3</a><br>
OCSPステープリング、EV/DV証明書、パッケージング、IPv6、QUIC、HTTP/3。</li>
<li><a href="#08">テストとモニタリング</a><br>
監査ワークフロー、プロキシブラウザ、404ページ、GDPRに基づくcookie同意プロンプト、パフォーマンス診断CSS、アクセシビリティ。</li>
<li><a href="#09">手軽に成果を上げる</a><br></li>
<li><a href="#10">チェックリストのダウンロード（PDF、Apple Pages、MS Word）</a><br></li>
<li><a href="#11">さあ、始めよう！</a><br></li>
</ul>
<p>（<a href="https://www.dropbox.com/s/34noajrbm324iai/performance-checklist-1.4.pdf?dl=0">チェックリストのPDFファイル</a>（166KB）、<a href="https://www.dropbox.com/s/ikuk5ikcxxv39uu/performance-checklist-1.4.pages?dl=0">編集可能なApple Pagesファイル</a>（275KB）、<a href="https://www.dropbox.com/scl/fi/s7ctdj89zd5zlvtt7dkhi/performance-checklist-1.4.docx?dl=0&#x26;rlkey=2xzs55e3kdg1jcraw5u1tnpl8">.docxファイル</a>（151KB）も自由にダウンロードできます。皆さんが最適化を楽しめますように！）</p>
<h2>デリバリの最適化 <a href="#06">#</a><a name="06"></a></h2>
<h3>45. クリティカルなJavaScriptの非同期読み込みにdeferを使用するか？</h3>
<p>ユーザがページをリクエストするとき、ブラウザはHTMLを取得し、DOMを構築し、それからCSSを取得してCSSOMを構築し、さらにDOMとCSSOMを照合することによってレンダリングツリーを生成します。JavaScriptを解決する必要がある場合、ブラウザは解読が終わるまで<code class="language-text">ページのレンダリングを開始しない</code>ため、レンダリングが遅延します。開発者はブラウザに対して、待機せずにページのレンダリングを開始するよう明確に指示する必要があります。これをスクリプト向けに実現する方法は、HTMLの<code class="language-text">defer</code>と<code class="language-text">async</code>属性を使用することです。</p>
<p>実際には、<a href="https://calendar.perfplanet.com/2016/prefer-defer-over-async/"><code class="language-text">async</code>ではなく<code class="language-text">defer</code>を使用するほう</a>が良いことが分かっています。それでは、<strong>両者の違い</strong>とは何でしょうか。<a href="https://youtu.be/RwSlubTBnew?t=1034">Steve Souders</a>によれば、<code class="language-text">async</code>スクリプトが登場すると、スクリプトは準備ができた段階ですぐに実行されます。このスクリプトがとても速く実行される場合、例えばスクリプトがキャッシュにすでに存在する場合は、実際にはスクリプトがHTMLパーサをブロックする可能性があります。<code class="language-text">defer</code>では、ブラウザはHTMLがパースされるまでスクリプトを実行しません。ですから、レンダリングの開始前にJavaScriptを実行する必要がなければ、<code class="language-text">defer</code>を使用するほうが良いでしょう。また、複数の非同期ファイルが実行される順番は確定的ではありません。</p>
<p>注目すべき点として、<a href="https://twitter.com/csswizardry/status/1346137189009264640"><code class="language-text">async</code>と<code class="language-text">defer</code>はいくつかの面で誤解されています</a>。最も重要なのは、<code class="language-text">async</code>とは、スクリプトの準備ができた時点でいつでもコードを実行するという意味ではないということです。asyncが意味するのは、スクリプトの準備ができており、なおかつ先行する同期作業が全て終了した時点で、いつでもスクリプトを実行するということです。Harry Robertsの言葉を借りれば、「<code class="language-text">async</code>スクリプトを同期スクリプトの後に設定した場合、<code class="language-text">async</code>スクリプトは、最も遅い同期スクリプトと同じ速さにしかなりません」。</p>
<p>また、<a href="https://twitter.com/csswizardry/status/1331721659498319873"><code class="language-text">async</code>と<code class="language-text">defer</code>を両方使用することは推奨されません</a>。モダンなブラウザはどちらもサポートしていますが、いずれの属性も使用されている場合、いつでも<code class="language-text">async</code>が優先されます。</p>
<p>このテーマについてもっと詳しく知りたいならば、Milica Mihajlijaが執筆した<a href="https://hacks.mozilla.org/2017/09/building-the-dom-faster-speculative-parsing-async-defer-and-preload/">Building the DOM faster</a>をご覧ください。このとても詳しいガイドは、投機的パーシング、async、deferの詳細について取り上げています。</p>
<h3>46. コストが大きいコンポーネントをインターセクションオブザーバーとプライオリティヒントで遅延読み込みする。</h3>
<p>一般に、重いJavaScript、動画、iframe、ウィジェット、場合によっては画像など、コストが大きいコンポーネントは全て遅延読み込みすることが推奨されます。画像とiframeの<a href="https://web.dev/native-lazy-loading/">ネイティブ遅延読み込み</a>は、すでに<code class="language-text">loading</code>属性によって利用可能となっています（Chromiumのみ）。この属性は、リソースがビューポートからの<a href="https://web.dev/browser-level-image-lazy-loading/#distance-from-viewport-thresholds">計算上の距離</a>に達するまで、そのリソースの読み込みを内部で遅延させます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Lazy loading for images, iframes, scripts.
Probably for images outside of the viewport. --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>

<span class="token comment">&lt;!-- Prompt an early download of an asset.For critical images, e.g. hero images. --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>eager<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>eager<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この基準となる距離は、取得される画像リソースの種類や有効な接続のタイプなど、いくつかの項目に依存します。しかし、ChromeのAndroid版を使用して行われた実験は、4G接続の場合、遅延読み込みされる画面外の画像の97.5％が<a href="https://web.dev/browser-level-image-lazy-loading/#distance-from-viewport-thresholds">表示後10ミリ秒以内に完全に読み込まれた</a>ことを示しているため、問題はないでしょう。</p>
<p>また、<code class="language-text">&lt;script&gt;</code>、<code class="language-text">&lt;img&gt;</code>、<code class="language-text">&lt;link&gt;</code>要素の<a href="https://developers.google.com/web/updates/2019/02/priority-hints#using_priority_hints">importance属性</a>（<code class="language-text">high</code>または<code class="language-text">low</code>）を使用することもできます（Blinkのみ）。実際、これはカルーセルの<strong>画像の優先順位を下げたり</strong>、スクリプトの優先順位をつけ直したりするための優れた手段となります。しかし、場合によっては、もっときめ細かいコントロールが必要になるでしょう。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!--
When the browser assigns "High" priority to an image,
but we don’t actually want that.
--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>less-important-image.svg<span class="token punctuation">"</span></span> <span class="token attr-name">importance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>low<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">/></span></span>

<span class="token comment">&lt;!--
We want to initiate an early fetch for a resource,
but also deprioritize it.
--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">importance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>low<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/script.js<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>もう少し洗練された遅延読み込みの方法のなかで、最もパフォーマンスが高いのは、<a href="https://www.telerik.com/blogs/intersection-observer-api-makes-lazy-loading-a-snap">インターセクションオブザーバーAPIを使用する</a>ことです。このAPIは、ターゲットとする要素と、その祖先要素または最上位ドキュメントのビューポートとの交差点における<strong>変化を非同期的に監視する</strong>方法を提供します。基本的に、新しい<code class="language-text">IntersectionObserver</code>オブジェクトを作成する必要があり、それがコールバック関数と一連のオプションを受け取ります。その後、観測対象のターゲットを追加します。</p>
<p>コールバック関数は、<strong>ターゲットが表示される</strong>ときか非表示となるときに実行されます。そのため、関数がビューポートに割り込むときに、要素が表示される前に何らかの行動を開始することができます。実際、<code class="language-text">rootMargin</code>（ルート周辺の余白）と<code class="language-text">threshold</code>（目標とするターゲットの表示割合を示す数字やその範囲）を使用することで、オブザーバのコールバックをいつ呼び出すかを細かくコントロールすることが可能です。</p>
<p>Alejandro Garcia Angladaは、インターセクションオブザーバーを実際に導入する方法に関する<a href="https://medium.com/%40aganglada/intersection-observer-in-action-efc118062366">便利なチュートリアル</a>を公表しています。Rahul Nanwaniは、<a href="https://css-tricks.com/the-complete-guide-to-lazy-loading-images/">前景と背景の画像の遅延読み込み</a>に関して詳しい記事を執筆しています。Google Fundamentalsも、<a href="https://developers.google.com/web/fundamentals/performance/lazy-loading-guidance/images-and-video/">インターセクションオブザーバーによる画像と動画の遅延読み込みに関する詳細なチュートリアル</a>を提供しています。</p>
<p>皆さんはアート主体のストーリーテリングを覚えているでしょうか。この形式のストーリーテリングは長大で、オブジェクトは移動するものもあれば、固定されているものもあります。<a href="https://github.com/russellgoldenberg/scrollama">インターセクションオブザーバーでは、高パフォーマンスのスクローリーテリング（スクロールと連動したストーリーテリング）</a>を実装することもできます。</p>
<p>他にも遅延読み込みが可能なものはないか、再度チェックしましょう。<strong>翻訳文字列や絵文字の遅延読み込み</strong>も助けになるかもしれません。Mobile Twitterは、これによって、新たなインターナショナリゼーションパイプラインのJavaScript実行時間を80％高速化しました。</p>
<p>ただし、注意すべき点もあります。<a href="https://twitter.com/csswizardry/status/1326504788360638466">遅延読み込みは、原則というよりは例外であるべき</a>です。実際にはすぐに表示したいものを遅延読み込みするのは、おそらく<a href="https://twitter.com/tunetheweb/status/1346556743308992512?s=20">合理的ではない</a>でしょう。例えば、製品ページの画像、ヒーロー画像、メインナビゲーションをインタラクティブにするために必要なスクリプトなどが挙げられます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a9620dcb-d5c1-449f-872a-552130a1ecd6/old-new-better-thresholds.png">
距離の基準値は最近、高速な接続（4Gなど）では3000pxから1250pxに、低速な接続（3Gなど）では4000pxから2500pxに縮小しました。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a9620dcb-d5c1-449f-872a-552130a1ecd6/old-new-better-thresholds.png">プレビューを拡大</a>）</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d4d6866d-7897-48bd-bc0c-c62a108e3c48/01-internationalization-front-end-performance-checklist-2020.png">
翻訳文字列の遅延読み込みによって、Mobile Twitterは新たなインターナショナリゼーションパイプラインのJavaScript実行時間を80％高速化しました。（画像の出典：<a href="https://twitter.com/addyosmani">Addy Osmani</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d4d6866d-7897-48bd-bc0c-c62a108e3c48/01-internationalization-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</p>
<h3>47. 画像を段階的に読み込む。</h3>
<p><a href="https://calendar.perfplanet.com/2017/progressive-image-loading-using-intersection-observer-and-sqip/">画像の段階的な読み込み</a>をページに追加することで、遅延読み込みをさらに一段上のレベルに引き上げられるかもしれません。Facebook、Pinterest、Medium、Woltと同様に、最初は低品質な画像やぼやけた画像を読み込み、ページの読み込みが進むにつれて、<a href="https://blurha.sh/">BlurHashテクニック</a>や<a href="https://www.guypo.com/introducing-lqip-low-quality-image-placeholders">LQIP（Low Quality Image Placeholders）テクニック</a>を使用して当初の画像を完全な品質のバージョンに置き換えることができます。</p>
<p>こうしたテクニックがユーザ体験を改善するかどうかについての意見はさまざまですが、First Contentful Paintを改善するのは間違いありません。また、SVGプレースホルダとして画像の低品質バージョンを作成する<a href="https://github.com/technopagan/sqip">SQIP</a>や、CSS線形勾配を持つ<a href="https://calendar.perfplanet.com/2018/gradient-image-placeholders/">Gradient Image Placeholders</a>の使用によって、上記を自動化することも可能です。</p>
<p>これらのプレースホルダは、テキストと同様の圧縮方法によって自然と十分に圧縮されるため、HTMLに埋め込むことができます。Dean Humeの記事では、このテクニックをインターセクションオブザーバーによって実装する方法が<a href="https://calendar.perfplanet.com/2017/progressive-image-loading-using-intersection-observer-and-sqip/">解説</a>されています。</p>
<p>フォールバックはどうすべきでしょうか。ブラウザがインターセクションオブザーバーをサポートしていない場合でも、<a href="https://github.com/jeremenichelli/intersection-observer-polyfill">ポリフィル</a>を<a href="https://medium.com/%40aganglada/intersection-observer-in-action-efc118062366">遅延読み込み</a>したり、画像を即座に読み込んだりすることができます。そのための<a href="https://github.com/ApoorvSaxena/lozad.js">ライブラリ</a>もあります。</p>
<p>もっとしゃれたテクニックが好きな方には、こんな方法もあります。<a href="https://jmperezperez.com/svg-placeholders/">画像をトレース</a>し、単純な図形と線を使用して軽いSVGプレースホルダを作成し、それを最初に読み込んだ後、プレースホルダのベクター画像から（読み込み済みの）ビットマップ画像に移行するのです。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f7f56052-6abb-4d18-a5aa-8d84102d812e/jmperez-composition-primitive-full.jpg">
<a href="https://jmperezperez.com/svg-placeholders/">José M. Pérez</a>によるSVG遅延読み込みのテクニック。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f7f56052-6abb-4d18-a5aa-8d84102d812e/jmperez-composition-primitive-full.jpg">プレビューを拡大</a>）</p>
<h3>48. <code class="language-text">content-visibility</code>でレンダリングを遅延させているか？</h3>
<p>大量のコンテンツブロック、画像、動画が含まれる複雑なレイアウトでは、データのデコードとピクセルのレンダリングはコストがとても大きい作業であるかもしれません。特にローエンドの端末ではなおさらです。<a href="https://web.dev/content-visibility/"><code class="language-text">content-visibility: auto</code></a>を使用すると、コンテナがビューポートの外にある間は、ブラウザに子のレイアウトをスキップさせることができます。</p>
<p>例えば、最初の読み込みでは、フッタや後半のセクションのレンダリングはスキップしたほうが良いかもしれません。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">footer</span> <span class="token punctuation">{</span>
  <span class="token property">content-visibility</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
  <span class="token property">contain-intrinsic-size</span><span class="token punctuation">:</span> 1000px<span class="token punctuation">;</span>
  <span class="token comment">/* 1000px is an estimated height for sections that are not rendered yet. */</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://www.terluinwebdesign.nl/en/css/calculating-contain-intrinsic-size-for-content-visibility/"><code class="language-text">content-visibility: auto;の挙動はoverflow: hidden;と似ています</code></a>が、デフォルトの<code class="language-text">margin-left: auto;</code>、<code class="language-text">margin-right: auto;</code>、widthの宣言の代わりに<code class="language-text">padding-left</code>と<code class="language-text">padding-right</code>を適用すれば修正できます。パディングは基本的に、要素がコンテンツボックスからあふれても、全体がボックスモデルの外に出たり、切り取られたりすることなく、パディングボックスに入るようにすることを可能にします。</p>
<p>新たなコンテンツが最終的にレンダリングされたときは、一定のCumulative Layout Shift（CLS）が発生している可能性に注意しましょう。ですから、 <a href="https://twitter.com/Una/status/1291012585807110144">適切なサイズのプレースホルダ</a>と<code class="language-text">contain-intrinsic-size</code>を使用するのは良いアイデアと言えます（Unaに感謝します）。</p>
<p>Thijs Terluinは、<a href="https://www.terluinwebdesign.nl/en/css/calculating-contain-intrinsic-size-for-content-visibility/">上記の2つのプロパティに関するはるかに詳しい内容</a>や、<code class="language-text">contain-intrinsic-size</code>がブラウザによってどのように計算されるかに関する記事を公表しています。Malte Ublは、<a href="https://www.industrialempathy.com/posts/image-optimizations/">読者の方にも可能な計算方法</a>を解説しています。JakeとSurmaによる短い解説動画では<a href="https://www.youtube.com/watch?v=FFA-v-CIxJQ">プロパティの仕組みを説明</a>しています。</p>
<p>もう少し細かい対応が必要なら、<a href="https://developers.google.com/web/updates/2016/06/css-containment">CSS Containment</a>を利用しましょう。これにより、他の要素のサイズ、位置調整や計算済みのスタイルのみが必要である場合、あるいは要素が現在オフキャンバスである場合に、DOMノードの子孫のレイアウト、スタイル、描画作業を手動でスキップできます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/640ed03b-3b1d-40be-84a8-6000698397aa/baseline-chunks-content-visibility-auto.jpg">
デモでは、チャンク化したコンテンツエリアに<code class="language-text">content-visibility: auto</code>を適用することで、最初の読み込みのレンダリングのパフォーマンスが7倍改善されています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/640ed03b-3b1d-40be-84a8-6000698397aa/baseline-chunks-content-visibility-auto.jpg">プレビューを拡大</a>）</p>
<h3>49. decoding="async"でデコードを遅延させているか？</h3>
<p>コンテンツが画面外で表示されていても、顧客が必要なときは利用できるようにしたい場合もあります。クリティカルパス上のどんなものもブロックせず、非同期でデコードやレンダリングが行われるのが理想です。<a href="https://html.spec.whatwg.org/multipage/images.html#decoding-images"><code class="language-text">decoding=&quot;async&quot;</code></a>を使用すれば、ブラウザが画像をメインスレッド外でデコードする許可を与えることができます。これにより、画像のデコードによるCPU使用時間に関して、ユーザへの影響を回避することが可能です（<a href="https://www.industrialempathy.com/posts/image-optimizations/">Malte Ubl</a>より）。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">&lt;img decoding=&quot;async&quot; … /&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>別の選択肢として、画面外の画像については、最初にプレースホルダを表示し、その画像がビューポート内に表示されたときに、インターセクションオブザーバーを使用して画像がバックグラウンドでダウンロードされるようにネットワーク呼び出しをトリガーするという方法もあります。また、<a href="https://youtu.be/YJGCZCaIZkQ?t=570">img.decode()によってデコードまでレンダリングを遅延させる</a>ことや、<a href="https://medium.com/dailyjs/image-loading-with-image-decode-b03652e7d2d2">Image Decode API</a>が利用できない場合は画像をダウンロードすることが可能です。</p>
<p>画像をレンダリングするときは、例えばフェードインアニメーションを使用することができます。Katie HempeniusとAddy Osmaniは、<a href="https://youtu.be/YJGCZCaIZkQ?t=436">Speed at Scale: Web Performance Tips and Tricks from the Trenches</a>という講演で、さらなる知見を共有しています。</p>
<h3>50. クリティカルCSSを生成・提供しているか？</h3>
<p>ブラウザに可能な限り早くページのレンダリングを開始させるには、ページの最初に表示される部分のレンダリング開始に必要な全てのCSS（通称「クリティカルCSS」や「アバブ・ザ・フォールドCSS」）を収集し、それをページの<code class="language-text">&lt;head&gt;</code>内に埋め込むことにより、ラウンドトリップを減らすのが<a href="https://www.smashingmagazine.com/2015/08/understanding-critical-css/">一般的な方法</a>となっています。スロースタートフェーズではやり取りできるパッケージの容量が限られているため、クリティカルCSSのバジェットは約14KBとなります。</p>
<p>それ以上の容量を求めるなら、ブラウザが取得するスタイルを増やすための追加的なラウンドトリップが必要です。<a href="https://github.com/filamentgroup/criticalCSS">CriticalCSS</a>と<a href="https://github.com/addyosmani/critical">Critical</a>は、使用するあらゆるテンプレートのクリティカルCSSの出力を可能にします。しかし、私たちの経験では、過去のどんな自動システムも、全てのテンプレートのクリティカルCSSを手作業で収集することに負けています。実際、私たちは最近、手作業によるアプローチに回帰しました。</p>
<p>収集後は<a href="https://github.com/GoogleChromeLabs/critters">Webpackプラグインのcritters</a>を使用して、クリティカルCSSを埋め込み、残りを遅延読み込みします。可能であれば、Filament Groupが採用している<a href="https://www.filamentgroup.com/lab/modernizing-delivery.html">条件付きの埋め込みアプローチ</a>の使用を検討しましょう。あるいは、<a href="https://www.smashingmagazine.com/2018/11/pitfalls-automatically-inlined-code/">埋め込みコードを静的アセットにオンザフライで変換</a>しましょう。</p>
<p><a href="https://github.com/filamentgroup/loadCSS">loadCSS</a>などのライブラリで<strong>CSS全体を非同期で読み込む</strong>ことは、実際には必要ありません。<code class="language-text">media=&quot;print&quot;</code>を使用することで、<a href="https://www.filamentgroup.com/lab/load-css-simpler/">ブラウザをだましてCSSを非同期で取得</a>させつつ、読み込み後のCSSを画面環境に適用することができます（Scottに感謝します）。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Via Scott Jehl. https://www.filamentgroup.com/lab/load-css-simpler/ --></span>
<span class="token comment">&lt;!-- Load CSS asynchronously, with low priority --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>full.css<span class="token punctuation">"</span></span>
  <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>print<span class="token punctuation">"</span></span>
  <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>this.media=<span class="token punctuation">'</span>all<span class="token punctuation">'</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>各テンプレートの全てのクリティカルCSSを収集するときは、「アバブ・ザ・フォールド」（スクロールしなくても見える範囲）のみを探索するのが一般的です。しかし、複雑なレイアウトでは、レイアウトの土台の部分を探索に含めるのが良いかもしれません。また、Core Web Vitalsスコアが低下しないように、<strong>膨大な再計算と再描画のコストを回避する</strong>のも賢明でしょう。</p>
<p>ユーザがページの中ほどに直接リンクするURLを取得したが、CSSがまだダウンロードされていなかった場合はどうなるでしょうか。この場合、例えば埋め込みCSSでは<code class="language-text">opacity:0;</code>、完全なCSSファイルでは<code class="language-text">opacity:1</code>を使用して、クリティカルではないコンテンツを隠し、CSSが利用可能になった時点で表示するのが一般的です。しかし、この方法の<strong>大きなデメリット</strong>として、接続が遅いユーザはページのコンテンツをまったく読めない可能性があります。そのため、たとえ適切なスタイルではないとしても、コンテンツを常に表示し続けるほうが良いと言えます。</p>
<p>クリティカルCSS（と<a href="https://csswizardry.com/2019/05/self-host-your-static-assets/">他の重要なアセット</a>）をルートドメインの別個のファイルに設定することには、場合によっては埋め込みよりも、キャッシングの面で<a href="https://www.jonathanklein.net/2014/02/revisiting-cookieless-domain.html">メリットがあります</a>。Chromeはページをリクエストするときにルートドメインへの第2のHTTP接続を投機的に開くので、このCSSを取得するためのTCP接続の必要がなくなります。これは、一連のクリティカルCSSファイル（critical-homepage.css、critical-product-page.cssなど）を作成し、それを埋め込むことなくルートから提供できることを意味します（Philipに感謝します）。</p>
<p>注意すべき点もあります。HTTP/2では、クリティカルCSSは個別のCSSファイルに保存され、HTMLを膨張させることなくサーバプッシュ経由で提供できます。問題は、サーバプッシュには多くの落とし穴と複数のブラウザの競合条件があり、厄介だということです。サーバプッシュが一貫してサポートされていたことはなく、キャッシングに関する問題もありました（Hooman Beheshtiのプレゼンテーションのスライド114以降を参照）。</p>
<p>サーバプッシュの影響は、実際にはマイナスとなり、ネットワークのバッファが膨張することでドキュメントの真のフレームの提供が妨げられる可能性があったのです。ですから、Chromeがここ最近、<a href="https://www.filamentgroup.com/lab/modernizing-delivery.html">サーバプッシュ</a>をサポート対象から除外することを計画しているのは、あまり驚きではありませんでした。</p>
<h3>51. CSSルールの再グループ化を試す。</h3>
<p>私たちはクリティカルCSSに慣れ親しんでいますが、それを超える可能性がある最適化も存在します。Harry Robertsが実施した<a href="https://csswizardry.com/2018/11/css-and-network-performance/">素晴らしい調査</a>は、とても驚くべき結果を明らかにしました。例えば、<strong>メインCSSファイルを個別のメディアクエリに分割する</strong>のは良いアイデアかもしれません。これにより、ブラウザは優先順位の高いクリティカルCSSを取得し、それ以外の優先順位が低いものは全てクリティカルパスから完全に除外されます。</p>
<p>また、<code class="language-text">async</code>スニペットの前に<code class="language-text">&lt;link rel=&quot;stylesheet&quot; /&gt;</code>を設置しないようにしましょう。スクリプトがスタイルシートに依存しない場合、ブロックとなるスタイルの上に、ブロックとなるスクリプトを設置することを検討しましょう。依存する場合は、そのJavaScriptを2つに分割し、CSSの両側で読み込みます。</p>
<p>Scott Jehlは、<a href="https://www.filamentgroup.com/lab/inlining-cache.html">埋め込まれたCSSファイルをサービスワーカーでキャッシュする</a>ことにより、別の興味深い問題を解決しました。この問題は、クリティカルCSSを使用している人にとっては共通のよくある問題です。その解決策とは、基本的には<code class="language-text">style</code>要素にID属性を追加し、JavaScriptを使用して要素を発見しやすくすることです。その後、小規模なJavaScriptがそのCSSを発見し、Cache APIを使用してCSSをローカルブラウザのキャッシュに保存し（コンテンツタイプは<code class="language-text">text/css</code>）、その後のページで使えるようにします。その後のページでの埋め込みを避け、代わりにキャッシュされたアセットを外部から参照するために、サイトへの最初のアクセス時にcookieを設定します。これで完成です。</p>
<p>注目すべき点として、<a href="https://calendar.perfplanet.com/2019/the-unseen-performance-costs-of-css-in-js-in-react-apps/">動的なスタイル設定はコストが大きくなる可能性があります</a>が、それは通常、何百もの合成コンポーネントを同時にレンダリングし、そのコンポーネントに依存する場合に限られます。ですから、CSS-in-JSを使用している場合は、CSSがテーマやプロップに依存していないときに、そのCSS-in-JSライブラリが実行を最適化するようにしましょう。また、<strong>styled-components</strong>を合成し過ぎないようにすべきです。Aggelos Arvanitakisは、<a href="https://calendar.perfplanet.com/2019/the-unseen-performance-costs-of-css-in-js-in-react-apps/">CSS-in-JSのパフォーマンスコストに関してさらなる知見を紹介しています</a>。</p>
<h3>52. 応答をストリームするか？</h3>
<p>これは忘れられたり、無視されたりしていることが多いのですが、<a href="https://streams.spec.whatwg.org/">ストリーム</a>は非同期のデータのチャンクを読んだり書き込んだりするためのインタフェースを提供します。こうしたチャンクのうち、任意の時点にメモリ内で利用できるのは一部に限られる可能性があります。これらは基本的に、当初のリクエストを実施したページが、最初のチャンクが利用可能となった時点ですぐに応答の処理を開始できるようにするものです。また、ストリーミングに最適化されたパーサを使用して、コンテンツを段階的に表示できます。</p>
<p>複数のソースから1つのストリームを作成することが可能です。例えば、空のUIシェルを提供してJavaScriptでデータを入力する代わりに、シェルをキャッシュから、本文をネットワークから提供し、サービスワーカーに<strong>ストリームを構築させる</strong>ことができます。Jeff Posnickが<a href="https://developers.google.com/web/updates/2016/06/sw-readablestreams">述べている</a>ように、CMSが部分的なテンプレートをまとめることでHTMLをサーバレンダリングし、それによってWebアプリケーションが動いている場合、そのモデルは応答のストリーミングを使用するモデルへ直接転換することが可能です。このケースでは、テンプレートのロジックはサーバではなくサービスワーカーで再現されます。Jake Archibaldの<a href="https://jakearchibald.com/2016/streams-ftw/">The Year of Web Streams</a>という記事は、この仕組みを構築するための厳密な方法を明らかにしています。これはパフォーマンスの向上に<a href="https://www.youtube.com/watch?v=Cjo9iq8k-bc">とても顕著な効果があります</a>。</p>
<p>HTML応答を全てストリーミングすることの重要な強みの1つは、最初のナビゲーションリクエストの間にレンダリングされたHTMLが、ブラウザのストリーミングHTMLパーサのメリットをフル活用できることです。ページの読み込み後にドキュメントに挿入されるHTMLのチャンクは、（JavaScriptを通じて読み込まれるコンテンツと同様に）この最適化によるメリットを活用できません。</p>
<p>ブラウザのサポート状況はどうでしょうか。<a href="https://caniuse.com/#feat=streams">現在はまだ道半ば</a>で、Chrome、Firefox、Safari、EdgeはこのAPIを部分的にのみサポートしています。一方、サービスワーカーは<a href="https://caniuse.com/#feat=serviceworkers">全てのモダンなブラウザでサポートされています</a>。大胆なことがしたくなったら、ストリーミング応答の試験的な実装をチェックしてみても良いでしょう。これは、まだ本文を生成している間にリクエスト送信を開始することを可能にします。この機能はChrome 85で利用可能です。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d0d3b406-93e8-4ef4-a407-c2453651a02a/save-data-usage-android-chrome.jpg">
<a href="https://twitter.com/colinbendell/status/1265675813204172810">Cloudinaryの調査</a>によれば、世界のAndroid Chromeユーザの18％はライトモード（省データモード）を有効にしています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d0d3b406-93e8-4ef4-a407-c2453651a02a/save-data-usage-android-chrome.jpg">プレビューを拡大</a>）</p>
<h3>53. 接続状況に対応したコンポーネントの導入を検討する。</h3>
<p>データのコストは<a href="https://whatdoesmysitecost.com/">重くなる</a>ことがあります。ペイロードが大きくなるにつれて、サイトやアプリケーションにアクセスする際に省データモードを選択するユーザに配慮する必要が出てきます。<a href="https://simonhearne.com/2020/save-data/">省データクライアントヒントのリクエストヘッダ</a>は、コストやパフォーマンスの制約があるユーザに合わせて、アプリケーションとペイロードをカスタマイズすることを可能にします。</p>
<p>実際、<a href="https://css-tricks.com/help-users-save-data/">高DPI画像を低DPI画像にするためのリクエストの書き換え</a>、Webフォントの削除、手の込んだパララックス効果の削除、サムネイルと無限スクロールのプレビュー、動画の自動再生の停止、サーバプッシュ、表示項目の数の削減、画像の品質の引き下げに加え、<a href="https://dev.to/addyosmani/adaptive-serving-using-javascript-and-the-network-information-api-331p">マークアップを提供する</a>方法の変更さえ可能です。Tim Vereeckeは、<a href="https://calendar.perfplanet.com/2018/data-shaver-strategies/">データを節約（削減）する戦略</a>についてのとても詳しい記事を公開し、省データのための数多くの選択肢を紹介しています。</p>
<p>誰が<code class="language-text">save-data</code>を使用しているのだろうと思う読者もいるかもしれません。<a href="https://twitter.com/colinbendell/status/1265675813204172810">世界のAndroid Chromeユーザの18％はライトモードを有効にしており</a>（つまり<code class="language-text">Save-Data</code>をオンにしており）、さらに実際の人数は<a href="https://twitter.com/addyosmani/status/1265677876608655361">これを上回る可能性が高い</a>と言えます。Simon Hearneの<a href="https://simonhearne.com/2020/save-data/">調査</a>によれば、ライトモードの選択率が最も高いのは比較的安い端末ですが、多くの例外が存在します。例えば、カナダのユーザの選択率は34％超（米国では約7％）で、Samsungの最新の旗艦モデルのユーザによる選択率は世界全体で約18％となっています。</p>
<p><code class="language-text">Save-Data</code>モードがオンになっていると、Chrome Mobileはユーザ体験を最適化して提供します。つまり、<code class="language-text">font-display: swap</code>と遅延読み込みを強制的に適用し、<strong>遅延スクリプトを使用した代替的なWeb体験</strong>です。こうしたブラウザの最適化に頼るよりも、自分でユーザ体験を構築するほうが理にかなっています。</p>
<p>このヘッダは現在Chromiumのみでサポートされており、ChromeのAndroid版か、デスクトップ端末のData Saver拡張機能を通じて提供されています。最後に、ネットワークの種類に応じて、<a href="https://umaar.com/dev-tips/242-considerate-javascript/">コストが大きいJavaScriptモジュール</a>や高解像度の画像と動画を提供するには、<a href="https://googlechrome.github.io/samples/network-information/">Network Information API</a>も使用することができます。Network Information API、特に<code class="language-text">navigator.connection.effectiveType</code>は、<code class="language-text">RTT</code>、<code class="language-text">downlink、effectiveType</code>の値（と<a href="https://wicg.github.io/netinfo/">その他</a>の少数の項目）を使用して、ユーザが処理できる接続とデータを表示します。</p>
<p>これに関連して、Max Böckは<a href="https://mxb.at/blog/connection-aware-components/">接続状況に対応したコンポーネント</a>について、Addy Osmaniは<a href="https://youtu.be/puUPpVrIRkc?t=975">アダプティブなモジュール提供</a>について語っています。例えばReactでは、異なる接続の種類に応じて、異なる方式でレンダリングされるコンポーネントを書くことができます。Maxが示しているとおり、ニュース記事の<Media />コンポーネントは以下のように出力されるでしょう。</p>
<ul>
<li><code class="language-text">Offline</code>：<code class="language-text">alt</code>テキスト付きのプレースホルダ</li>
<li><code class="language-text">2G / save-dataモード</code>：低解像度の画像</li>
<li>Retinaではないディスプレイの<code class="language-text">3G</code>：中解像度の画像</li>
<li>Retinaディスプレイの<code class="language-text">3G</code>：高解像度のRetina画像</li>
<li><code class="language-text">4G</code>：HD動画</li>
</ul>
<p>Dean Humeは、サービスワーカーを使用した<a href="https://deanhume.com/dynamic-resources-using-the-network-information-api-and-service-workers/">同様のロジックの現実的な実装方法</a>を解説しています。動画については、デフォルトでは動画ポスターを表示し、接続が良い場合は「再生」アイコン、動画プレーヤのシェル、動画のメタデータなどを表示することができます。上記をサポートしていないブラウザ向けのフォールバックとして、<a href="https://benrobertson.io/front-end/lazy-load-connection-speed"><code class="language-text">canplaythrough</code>イベントをリッスンし</a>、<code class="language-text">Promise.race()</code>を使用することで、<code class="language-text">canplaythrough</code>イベントが2秒以内に発生しない場合にソース読み込みをタイムアウトすることが可能です。</p>
<p>もう少し詳しく知りたい方向けに、スタートに適したリソースをいくつか紹介します。</p>
<ul>
<li>Addy Osmaniは<a href="https://www.youtube.com/watch?v=puUPpVrIRkc&#x26;t=488s">Reactでアダプティブなデータ提供を実装する方法</a>を示しています。</li>
<li><a href="https://github.com/GoogleChromeLabs/react-adaptive-hooks">React Adaptive Loading Hooks &#x26; Utilities</a>はReact向けのコードスニペットを提供します。</li>
<li>Netanel Basalは<a href="https://netbasal.com/connection-aware-components-in-angular-3a66bb0bab6f">Angularにおける接続状況に対応したコンポーネント</a>について追求しています。</li>
<li>Theodore Vorillasは<a href="https://dev.to/vorillaz/serving-adaptive-components-using-the-network-information-api-lbo">VueでNetwork Information APIを使用してアダプティブコンポーネントを提供する</a>仕組みについて解説しています。</li>
<li>Umar Hansaは<a href="https://umaar.com/dev-tips/242-considerate-javascript/">コストが大きいJavaScriptを選択的にダウンロード/実行する方法</a>を説明しています。</li>
</ul>
<h3>54. 端末のメモリに対応したコンポーネントの導入を検討する。</h3>
<p>しかし、ネットワークの接続からユーザについて知ることができる情報はほんの一面に過ぎません。一歩踏み込んで、<a href="https://developers.google.com/web/updates/2017/12/device-memory">Device Memory API</a>で、<a href="https://calendar.perfplanet.com/2018/dynamic-resources-browser-network-device-memory/">利用できる端末メモリに基づいてリソースを動的に調整する</a>ことも可能です。<code class="language-text">navigator.deviceMemory</code>は、端末のRAMをギガバイト単位（2のべき乗未満は切り捨て）で返します。このAPIには、同じ値を報告する<code class="language-text">Device-Memory</code>というクライアントヒントヘッダも搭載されています。</p>
<p><strong>おまけ</strong>：<em>Umar Hansaは、動的インポートによって<a href="https://twitter.com/umaar/status/1206707408506105858">コストが大きいスクリプトを遅延させる方法</a>を解説しています。これにより、端末のメモリ、ネットワークの接続性、<a href="https://developer.mozilla.org/en-US/docs/Web/API/NavigatorConcurrentHardware/hardwareConcurrency">ハードウエアの並行処理能力</a>に基づいてユーザ体験を変えることが可能になります</em>。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f2dbec5f-c859-4aa6-b10b-f017be63fc3b/resources-in-chrome.jpeg">
Chrome 46以降のBlinkにおけるさまざまなリソースの優先順位の内訳。（画像の出典：<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">Addy Osmani</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f2dbec5f-c859-4aa6-b10b-f017be63fc3b/resources-in-chrome.jpeg">プレビューを拡大</a>）</p>
<h3>55. デリバリを高速化するために接続をウォームアップする。</h3>
<p><a href="https://w3c.github.io/resource-hints">リソースヒント</a>を使用して時間を節約しましょう。例えば、<a href="https://caniuse.com/#search=dns-prefetch"><code class="language-text">dns-prefetch</code></a>（バックグラウンドでDNSルックアップを実行する）、<a href="https://www.caniuse.com/#search=preconnect"><code class="language-text">preconnect</code></a>（ブラウザに対してバックグラウンドで接続のためのハンドシェイク（DNS、TCP、TLS）を開始するように要求する）、<a href="https://caniuse.com/#search=prefetch"><code class="language-text">prefetch</code></a>（ブラウザに対してリソースをリクエストするように要求する）、<a href="https://www.smashingmagazine.com/2016/02/preload-what-is-it-good-for/"><code class="language-text">preload</code></a>（リソースを実行することなく先読みするなど）といったリソースヒントがあります。モダンなブラウザの<a href="https://caniuse.com/?search=preload">サポートも充実</a>しており、<a href="https://twitter.com/__jakub_g/status/1333711930004025346">間もなくFirefoxでもサポートされる見込み</a>です。</p>
<p>皆さんは<a href="https://www.w3.org/TR/resource-hints/#dfn-prerender"><code class="language-text">prerender</code></a>を覚えていますか。これは、次のナビゲーションのために、ブラウザにバックグラウンドでページ全体をビルドさせるのに使用されていたリソースヒントです。その実装には、膨大なメモリフットプリントと帯域幅の使用から、アナリティクスヒットと広告インプレッションが複数回カウントされることに至るまで、<a href="https://vimeo.com/356819848#t=1632s">大きな問題がありました</a>。</p>
<p>当然、非推奨となりましたが、Chromeチームはこれを<a href="https://developers.google.com/web/updates/2018/07/nostate-prefetch">NoState Prefetchの仕組み</a>として復活させました。実際、Chromeは<code class="language-text">prerender</code>ヒントをNoState Prefetchの代わりとして扱っているため、現在もまだ使用することができます。Katie Hempeniusが上記の記事で説明しているとおり、「prerenderingと同様に、<strong>NoState Prefetchはリソースを事前に取得します</strong>。ただし、prerenderingとは異なり、事前に<strong>JavaScriptを実行することや、ページの一部をレンダリングすることはありません</strong>」。</p>
<p>NoState Prefetchは約45MiBのメモリしか使用せず、取得されるサブリソースの取得時のネットプライオリティは<code class="language-text">IDLE</code>となります。Chrome 69以降、NoState Prefetchは全てのリクエストにPurpose: Prefetchヘッダを追加しています。これは全てのリクエストを通常のブラウジングから区別するためのものです。</p>
<p><a href="https://github.com/jeremyroman/alternate-loading-modes">プリレンダリングの別の選択肢</a>と<a href="https://github.com/WICG/portals/blob/master/README.md">portals</a>にも注目しましょう。portalsはプライバシーに配慮したプリレンダリングの新たな取り組みで、シームレスなナビゲーションのためにコンテンツのinsetの<code class="language-text">preview</code>を提供します。</p>
<p>リソースヒントの使用は、<strong>パフォーマンスを向上させる最も簡単な方法</strong>でしょう。<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">実際、リソースヒントは有効です</a>。それでは、何をいつ使用すれば良いのでしょうか。Addy Osmaniが<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">説明</a>しているとおり、現在のページや、複数のナビゲーションの境界をまたいで将来のナビゲーションに利用される可能性が非常に高いことが分かっている場合（ユーザがまだアクセスしていないページに必要なWebpackバンドルなど）は、リソースを先読みするのが合理的です。</p>
<p>Addyの<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf">Chromeの読み込みの優先順位</a>に関する記事では、Chromeがリソースヒントを解釈する厳密な仕組みが説明されています。そのため、どのアセットがレンダリングにとってクリティカルであるかを決めれば、それに高い優先順位を割り当てることができます。リクエストがどのように優先順位づけされているかを確認するには、Chrome DevToolsのネットワークリクエスト表の「priority」欄を有効化します（Safariでも同様です）。</p>
<p>現在では、大体の場合は<strong>少なくとも</strong><code class="language-text">preconnect</code>と<code class="language-text">dns-prefetch</code>を使用することになるでしょう。<code class="language-text">prefetch</code>、<code class="language-text">preload</code>、<code class="language-text">prerender</code>を使用するときは注意しなければなりません。気をつけるべき点として、<code class="language-text">preconnect</code>と<code class="language-text">dns-prefetch</code>を使用しても、ブラウザが並行的にルックアップ/接続できるホストの数には限界があります。ですから、優先順位に基づいて指示を行うのが賢明です（Philip Tellisに感謝します）。</p>
<p><strong>フォント</strong>は通常、ページの重要なアセットであるため、場合によっては<a href="https://css-tricks.com/the-critical-request/#article-header-id-2">ブラウザに対して<code class="language-text">preload</code>でクリティカルなフォントをダウンロードすることを要求する</a>のが良いアイデアとなります。ただし、<a href="https://andydavies.me/blog/2019/02/12/preloading-fonts-and-the-puzzle-of-priorities/">フォントの先読みの優先順位は複雑である</a>ため、実際にパフォーマンスに貢献しているかをダブルチェックすることが必要です。<code class="language-text">preload</code>は優先順位が高いとみなされるので、クリティカルCSSなどのさらに重要なリソースよりも優先される場合があります（Barryに感謝します）。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Loading two rendering-critical fonts, but not all their weights. --></span>
<span class="token comment">&lt;!--
crossorigin="anonymous" is required due to CORS.
Without it, preloaded fonts will be ignored.
https://github.com/w3c/preload/issues/32
via https://twitter.com/iamakulov/status/1275790151642423303
--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font<span class="token punctuation">"</span></span>
      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Elena-Regular.woff2<span class="token punctuation">"</span></span>
      <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font/woff2<span class="token punctuation">"</span></span>
      <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span>
      <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>only screen and (min-width: 48rem)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font<span class="token punctuation">"</span></span>
      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Mija-Bold.woff2<span class="token punctuation">"</span></span>
      <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font/woff2<span class="token punctuation">"</span></span>
      <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span>
      <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>only screen and (min-width: 48rem)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">&lt;link rel=&quot;preload&quot;&gt;</code>は<code class="language-text">media</code>属性を許容するため、上記のように、<code class="language-text">@media</code>クエリのルールに基づいて<a href="https://css-tricks.com/the-critical-request/#article-header-id-3">リソースを選択的にダウンロードする</a>ことを選べます。
さらに、<code class="language-text">imagesrcset</code>属性と<code class="language-text">imagesizes</code>属性を使用して、<a href="https://addyosmani.com/blog/preload-hero-images/">発見されるのが遅いヒーロー画像</a>や、JavaScriptを通じて読み込まれる画像（動画ポスターなど）の先読みを高速化することができます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Addy Osmani. https://addyosmani.com/blog/preload-hero-images/ --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image<span class="token punctuation">"</span></span>
     <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>poster.jpg<span class="token punctuation">"</span></span>
     <span class="token attr-name">imagesrcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
        poster_400px.jpg 400w,
        poster_800px.jpg 800w,
        poster_1600px.jpg 1600w<span class="token punctuation">"</span></span>
    <span class="token attr-name">imagesizes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50vw<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>また、<strong>JSONをfetchとして先読み</strong>し、JavaScriptがリクエストを開始する前に発見することも可能です。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Addy Osmani. https://addyosmani.com/blog/preload-hero-images/ --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fetch<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo.com/api/movies.json<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>さらに、スクリプトの実行を実質的に遅延させるために、<a href="https://www.smashingmagazine.com/2016/02/preload-what-is-it-good-for/#dynamic-loading-without-execution">JavaScriptを動的に読み込む</a>こともできます。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">/* Adding a preload hint to the head */</span>
<span class="token keyword">var</span> preload <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"link"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
link<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">"myscript.js"</span><span class="token punctuation">;</span>
link<span class="token punctuation">.</span>rel <span class="token operator">=</span> <span class="token string">"preload"</span><span class="token punctuation">;</span>
link<span class="token punctuation">.</span>as <span class="token operator">=</span> <span class="token string">"script"</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Injecting a script when we want it to execute */</span>
<span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"myscript.js"</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://dexecure.com/blog/http2-push-vs-http-preload/">注意すべき落とし穴</a>もあります。<code class="language-text">preload</code>は<a href="https://www.youtube.com/watch?v=RWLzUnESylc">アセットのダウンロード開始時間を当初のリクエストに近づける</a>のに適していますが、先読みされたアセットは、リクエストを実施したページとひもづいた<strong>メモリキャッシュ</strong>に保存されます。<code class="language-text">preload</code>はHTTPキャッシュと相性が良く、アイテムがHTTPキャッシュにすでに存在する場合はネットワークリクエストが送信されません。</p>
<p>したがって、発見が遅いリソース、<code class="language-text">background-image</code>を通じて読み込まれるヒーロー画像、クリティカルなCSS（やJavaScript）の埋め込み、残りのCSS（やJavaScript）の先読みに便利です。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/354f16f7-95de-4aa8-accb-83538a5049ed/preload-late-images-js.jpg">
重要な画像を早く先読みしましょう。JavaScriptによる発見を待つ必要はありません。（画像の出典：“<a href="https://addyosmani.com/blog/preload-hero-images/">Preload Late-Discovered Hero Images Faster</a>”（Addy Osmani著））（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/354f16f7-95de-4aa8-accb-83538a5049ed/preload-late-images-js.jpg">プレビューを拡大</a>）</p>
<p><code class="language-text">preload</code>タグは、ブラウザがサーバからHTMLを受け取り、先読みパーサが<code class="language-text">preload</code>タグを発見した後にのみ、先読みを開始することができます。HTTPヘッダを通じた先読みは、ブラウザがリクエストを開始するためにHTMLをパースするのを待つ必要がないため、少し速くなる可能性があります（ただし、これは<a href="https://twitter.com/yoavweiss/status/1151586733177352192?s=20">議論の対象となっています</a>）。</p>
<p><a href="https://www.fastly.com/blog/faster-websites-early-priority-hints">Early Hints</a>はもっと役に立つでしょう。これはHTMLの応答ヘッダが送信される前から、先読みを開始することを可能にします（<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=671310">Chromium</a>と<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1407355">Firefox</a>のロードマップに掲載されています）。さらに、<a href="https://github.com/WICG/priority-hints">Priority Hints</a>はスクリプト読み込みの優先順位を示すのに役立ちます。</p>
<p><strong>注意</strong>：<code class="language-text">preload</code>を使用する場合、<code class="language-text">as</code>を<strong>必ず</strong>定義しなければなりません。さもないと<a href="https://twitter.com/yoavweiss/status/873077451143774209">何も読み込まれない</a>ことになります。さらに、<a href="https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf"><code class="language-text">crossorigin</code>属性なしでフォントを先読みすると、フォントが二重に取得されます</a>。<code class="language-text">prefetch</code>を使用している場合、<a href="https://timkadlec.com/remembers/2020-06-17-prefetching-at-this-age/">Firefoxの<code class="language-text">Age</code>ヘッダの問題</a>に気をつけましょう。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/80b8c02e-701b-4700-8bcf-f88240a78a49/fcp-histogram-by-sw-status-1400w-57a170dca9.png">
サービスワーカーを使用すれば、必要最低限のデータのみをリクエストし、そのデータを完全なHTML文書に変換してFCPを改善することができます。（<a href="https://philipwalton.com/articles/smaller-html-payloads-with-service-workers/">Phil Walton</a>より）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/80b8c02e-701b-4700-8bcf-f88240a78a49/fcp-histogram-by-sw-status-1400w-57a170dca9.png">プレビューを拡大</a>）</p>
<h3>56. キャッシングとネットワークのフォールバックとしてサービスワーカーを使用する。</h3>
<p>どんなネットワーク上のパフォーマンス最適化も、ユーザのマシンにキャッシュをローカル保存するより速くはなりません（ただし、<a href="https://simonhearne.com/2020/network-faster-than-cache/">例外</a>もあります）。WebサイトがHTTPS通信を利用している場合、<a href="https://github.com/lyzadanger/pragmatist-service-worker">サービスワーカーのキャッシュに静的アセットをキャッシング</a>し、オフラインのフォールバックを（あるいはオフラインのページも）保存すれば、ネットワークに接続することなくこれらをユーザのマシンから取得できます。</p>
<p>Phil Waltonが提案するとおり、サービスワーカーでは、応答をプログラムで生成することによって、<a href="https://philipwalton.com/articles/smaller-html-payloads-with-service-workers/">より小さいHTMLペイロード</a>を送信できます。サービスワーカーは、サーバから必要最低限のデータ（HTMLコンテンツの一部、マークダウンファイル、JSONデータなど）のみをリクエストし、そのデータを<strong>プログラムで完全なHTML文書へ変換</strong>することが可能です。ユーザがサイトを1度訪問し、サービスワーカーがインストールされれば、ユーザは二度とHTMLページ全体をリクエストする必要がありません。<a href="https://philipwalton.com/articles/smaller-html-payloads-with-service-workers/">これはパフォーマンスに素晴らしい影響を与える可能性があります</a>。</p>
<p>ブラウザのサポート状況はどうでしょうか。<a href="https://caniuse.com/#search=serviceworker">サービスワーカーは広くサポートされており</a>、どちらにせよネットワークがフォールバックとなります。サービスワーカーは<strong>パフォーマンスの改善</strong>に<a href="https://developers.google.com/web/showcase/2016/service-worker-perf">確かに貢献します</a>。さらに、その貢献度は高まっています。例えば、Background Fetchでは、サービスワーカーを通じたバックグラウンドでのアップロード/ダウンロードも可能です。</p>
<p>サービスワーカーにはいくつもの用途があります。例えば、<a href="https://una.im/save-offline/#%F0%9F%92%81">「オフライン用に保存」機能を実装する</a>、<a href="https://bitsofco.de/handling-broken-images-with-service-worker/">壊れた画像を処理する</a>、タブ間のメッセージングを導入する、あるいは<a href="https://medium.com/dev-channel/service-worker-caching-strategies-based-on-request-types-57411dd7652c">リクエストの種類によって異なるキャッシング戦略を提供する</a>といった使い方が可能です。一般によく見られる信頼性が高い戦略は、少数のクリティカルなページ（オフラインページ、フロントページ、その他の各ケースで重要なページなど）とともに、アプリケーションのシェルをサービスワーカーのキャッシュに保存するというものです。</p>
<p>ただし、注意すべき落とし穴もあります。サービスワーカーを導入している場合、<a href="https://philna.sh/blog/2018/10/23/service-workers-beware-safaris-range-request/">Safariのレンジリクエストに気をつけなければなりません</a>（Workboxをサービスワーカー向けに使用している場合、<a href="https://developers.google.com/web/tools/workbox/modules/workbox-range-requests">Workboxにはレンジリクエストモジュールが存在します</a>）。ブラウザコンソールの<code class="language-text">DOMException: Quota exceeded.</code>エラーにつまずいたことがあるなら、<a href="https://cloudfour.com/thinks/when-7-kb-equals-7-mb/">GerardoのWhen 7KB equals 7MB</a>という記事を見てみましょう。</p>
<p>Gerardoが書いているとおり、「プログレッシブなWebアプリケーションを開発していて、サービスワーカーがCDNから提供された静的アセットをキャッシュすることでキャッシュストレージが膨張しているなら、クロスオリジンのリソース向けに<a href="https://cloudfour.com/thinks/when-7-kb-equals-7-mb/#opaque-responses">適切なCORS応答ヘッダが存在する</a>ようにすること、サービスワーカーで意図せず<a href="https://cloudfour.com/thinks/when-7-kb-equals-7-mb/#should-opaque-responses-be-cached-at-all">不透明な応答をキャッシュしない</a>ようにすること、<code class="language-text">crossorigin</code>属性を<code class="language-text">&lt;img&gt;</code>タグに追加して<a href="https://cloudfour.com/thinks/when-7-kb-equals-7-mb/#opt-in-to-cors-mode">クロスオリジンの画像アセットをCORSモードにオプトインすること</a>を確実にしましょう」。</p>
<p>サービスワーカーを導入するための<strong>素晴らしいリソース</strong>は数多く存在します。</p>
<ul>
<li><a href="https://web.dev/service-worker-mindset/">Service Worker Mindset</a>は、サービスワーカーが水面下で機能する仕組みや、サービスワーカーを構築するときに知っておくべきことを理解するのに役立ちます。</li>
<li>Chris Ferdinandiは、<a href="https://gomakethings.com/series/service-workers/">サービスワーカーに関する素晴らしいシリーズ記事</a>を提供しています。この記事は、オフラインのアプリケーションを作成する方法を説明するとともに、最近閲覧したページのオフライン保存から、サービスワーカーでキャッシュ内の項目の有効期限を設定する方法まで、さまざまなシナリオをカバーしています。</li>
<li><a href="https://www.thecodeship.com/web-development/guide-service-worker-pitfalls-best-practices/">Service Worker Pitfalls and Best Practices</a>という記事では、サービスワーカーの落とし穴とベストプラクティスに加え、サービスワーカーの適用範囲、登録の遅延、キャッシングについてのヒントを紹介しています。</li>
<li>Ire Aderinokunの<a href="https://bitsofco.de/bitsofcode-pwa-part-1-offline-first-with-service-worker/">"Offline First" with Service Worker</a>という素晴らしいシリーズ記事では、アプリケーションのシェルの事前キャッシングに関する戦略を説明しています。</li>
<li><a href="https://developers.google.com/web/fundamentals/primers/service-workers">Service Worker: An Introduction</a>は、リッチなオフライン体験、定期的なバックグラウンド同期、プッシュ通知にサービスワーカーを使用する方法に関する実用的なヒントを提供します。</li>
<li>Jake Archibaldによる<a href="https://jakearchibald.com/2014/offline-cookbook/">Offline Cookbook</a>は昔ながらの記事ですが、いつでも参考に値します。この記事では、自分でサービスワーカーを作るためのレシピが紹介されています。</li>
<li><a href="https://developers.google.com/web/tools/workbox/">Workbox</a>は、特にプログレッシブなWebアプリケーションを構築するために開発されたサービスワーカーのライブラリです。</li>
</ul>
<h3>57. サーバワーカーをA/BテストなどのためにCDN/エッジで実行しているか？</h3>
<p>現在、私たちはサービスワーカーをクライアント側で実行することにすっかり慣れています。しかし、<a href="https://blog.cloudflare.com/introducing-cloudflare-workers/">CDNがサービスワーカーをサーバに実装する</a>ことで、エッジでもパフォーマンスを微調整するためにサービスワーカーを使用できる可能性があります。
例えば、A/Bテストにおいて、HTMLが異なるユーザ向けにコンテンツを変更する必要があるときに、<a href="https://www.filamentgroup.com/lab/servers-workers.html">CDNサーバでサービスワーカーを使用する</a>ことでロジックを処理できるでしょう。また、HTML書き換えのストリームによって、Google Fontsを使用するサイトを高速化できます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4161d64c-521d-41fc-9eec-300dc766a412/pwa-timeseries-of-service-worker-installations-opt.png">
サービスワーカ導入の時系列。<a href="https://almanac.httparchive.org/en/2020/pwa">Web Almanac</a>によれば、サービスワーカを登録しているページは全てのデスクトップページの0.87％にとどまっています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4161d64c-521d-41fc-9eec-300dc766a412/pwa-timeseries-of-service-worker-installations-opt.png">プレビューを拡大</a>）</p>
<h3>58. レンダリングのパフォーマンスを最適化する。</h3>
<p>アプリケーションが重いと、すぐに気づかれてしまいます。ですから、ページをスクロールするときや要素のアニメーションが動くときにラグが生じないようにし、1秒当たり60フレームのフレームレートを常に守らなければなりません。それが不可能な場合は、少なくとも1秒当たりのフレーム数を15～60の範囲内で一定にすることが望ましいと言えます。どの要素やプロパティが変化するかをブラウザに伝えるには、CSSのwill-changeを使用しましょう。</p>
<p>ユーザ体験を確認するときは、DevToolsで<strong>不必要な再描画をデバッグ</strong>するようにします。</p>
<ul>
<li><a href="https://aerotwist.com/blog/my-performance-audit-workflow/#runtime-performance">ランタイムのレンダリングパフォーマンスを測定</a>しましょう。測定結果を理解するための便利なヒントもチェックしてみてください。</li>
<li>出発点として、Paul Lewisによる<a href="https://www.udacity.com/course/browser-rendering-optimization--ud860">ブラウザレンダリングの最適化に関するUdacityの無料講義</a>と、Georgy Marchukによる<a href="https://css-tricks.com/browser-painting-and-considerations-for-web-performance/">Browser painting and considerations for web performance</a>という記事をチェックしてみてください。</li>
<li>Firefox DevToolsで"More tools → Rendering → Paint Flashing"を選択し、<a href="https://twitter.com/iamakulov/status/1275782035655753729">Paint Flashing</a>を有効にしましょう。</li>
<li>React DevToolsでは、<a href="https://twitter.com/iamakulov/status/1275783591293857792">"Highlight updates"にチェックをつけ</a>、<a href="https://twitter.com/iamakulov/status/1275863444944756738">"Record why each component rendered"を有効にしましょう</a>。</li>
<li><a href="https://github.com/welldone-software/why-did-you-render">Why Did You Render</a>を使用すると、コンポーネントが再レンダリングされたときに変更を素早く通知してくれます。</li>
</ul>
<p>Masonryレイアウトを使用している場合は、<a href="https://www.bram.us/2020/05/04/css-grid-layout-module-level-2-masonry-layout/">かなり近いうちにCSSグリッドのみでMasonryレイアウトを構築できるようになる</a>可能性があることを覚えておきましょう。</p>
<p>このテーマについてもっと詳しく知りたいならば、Nolan Lawsonが記事で<a href="https://nolanlawson.com/2018/09/25/accurately-measuring-layout-on-the-web/">レイアウトのパフォーマンスを正確に測定するための技</a>を紹介しており、Jason Millerも<a href="https://twitter.com/_developit/status/1081682550865752064">代わりとなるテクニックを提案</a>しています。Sergey Chikuyonokも、<a href="https://www.smashingmagazine.com/2016/12/gpu-animation-doing-it-right/">適切なGPUアニメーション</a>を作成するための短い記事を執筆しています。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9c4093df-2d79-4a00-82ca-e19e0c439254/high-performance-animations.jpg">
ブラウザは、あまりコストをかけずに変形や透明度に関するアニメーションをつけることができます。<a href="https://csstriggers.com/">CSS Triggers</a>は、CSSが再レイアウトやリフローのきっかけになるかをチェックするのに便利です。（画像の出典：<a href="https://twitter.com/addyosmani/status/1223916476610097154">Addy Osmani</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9c4093df-2d79-4a00-82ca-e19e0c439254/high-performance-animations.jpg">プレビューを拡大</a>）</p>
<p><strong>注記</strong>：GPU合成レイヤの変更は<a href="https://blog.algolia.com/performant-web-animations/">コストがとても小さくなります</a>。そのため、<code class="language-text">opacity</code>と<code class="language-text">transform</code>による合成をトリガーするだけで済むなら、それで問題ありません。Anna Migasは、<a href="https://vimeo.com/302791098">UIのレンダリングパフォーマンスのデバッグ</a>に関する講演で数多くの実用的なアドバイスを提供しています。DevToolsで描画のパフォーマンスをデバッグする方法を知るには、<a href="https://www.youtube.com/watch?v=8-pkB2vGUKk">Umarの描画パフォーマンス監査に関する動画</a>をチェックしましょう。</p>
<h3>59. 体感的なパフォーマンスを最適化しているか？</h3>
<p>コンポーネントがページに表示される順番や、どのようにアセットをブラウザに提供するかという戦略は重要ですが、<a href="https://www.smashingmagazine.com/2015/09/why-performance-matters-the-perception-of-time/">体感的なパフォーマンス</a>の役割も過小評価すべきではありません。この考え方は待つことの心理的な側面に着目したものです。基本的には、顧客に別のことをさせたり、顧客の注意を引きつけたりしている間に、他の処理を済ませるという手法を採用します。<a href="https://www.smashingmagazine.com/2015/11/why-performance-matters-part-2-perception-management/">体感マネジメント</a>、<a href="https://www.smashingmagazine.com/2015/11/why-performance-matters-part-2-perception-management/#preemptive-start">割り込みスタート</a>、<a href="https://www.smashingmagazine.com/2015/11/why-performance-matters-part-2-perception-management/#early-completion">早期完了</a>、<a href="https://www.smashingmagazine.com/2015/12/performance-matters-part-3-tolerance-management/">許容度マネジメント</a>といった要素が重要になります。</p>
<p>これらは何を意味するのでしょうか。アセットを読み込む間、常に顧客の一歩先を行くことを目指しましょう。それによって、水面下では多くのことが起こっていても、スムーズに感じられるユーザ体験を提供できるのです。顧客の注意を引きつけ続けるために、読み込みインジケータの代わりに<a href="https://twitter.com/lukew/status/665288063195594752">スケルトンスクリーン</a>（<a href="https://twitter.com/razvancaliman/status/734088764960690176">実装デモ</a>）を試したり、トランジション/アニメーションを追加したりすることができます。これ以上最適化するものがない場合は、基本的に<a href="https://blog.stephaniewalter.fr/en/cheating-ux-perceived-performance-and-user-experience/">ユーザ体験を実際より良く見せる</a>という手もあります。</p>
<p>Kumar McMillanは、<a href="http://farmdev.com/thoughts/108/the-art-of-ui-skeletons/">The Art of UI Skeletons</a>というケーススタディで、動的リスト、テキスト、最終画面をシミュレーションする方法や、Reactで「Skeleton思考」について検討する方法について、アイデアとテクニックを提供しています。</p>
<p>ただし、スケルトンスクリーンは実装前にテストすべきです。なぜなら、<a href="https://www.viget.com/articles/a-bone-to-pick-with-skeleton-screens/">一部のテストは、スケルトンスクリーンのパフォーマンスが全ての指標で最低となる可能性がある</a>ことを示しているからです。</p>
<h3>60. レイアウトのシフトと再描画を防止しているか？</h3>
<p>体感的なパフォーマンスに関して、特にうっとうしいと感じられるものの1つは<strong>レイアウトシフト</strong>（リフロー）でしょう。これは、画像と動画の寸法の変化、Webフォント、広告の挿入、あるいは発見されるのが遅いスクリプトによってコンポーネントに実際のコンテンツが読み込まれることが原因で発生します。その結果、顧客が記事を読み始めているにもかかわらず、読んでいる場所より上のレイアウトが移動することで邪魔されかねません。こうした体験は突然で、どこを読んでいるかまったく分からなくなることが多いものです。このような場合、読み込みの優先順位を検討し直す必要があるでしょう。</p>
<p>コミュニティでは、リフローを回避するためのテクニックや代替策が開発されています。一般的に、ユーザとのインタラクションによる応答以外では、<strong>既存のコンテンツの上に新しいコンテンツを挿入するのは避ける</strong>べきです。画像には常に[width属性とheight属性]を設定することで、モダンなブラウザがデフォルトでボックスを割り当て、スペースを確保できるようにしましょう（Firefox、Chrome）。</p>
<p>画像と動画の両方について、メディアが表示されるディスプレイボックスを確保するために<a href="https://css-tricks.com/preventing-content-reflow-from-lazy-loaded-images/">SVGプレースホルダ</a>を使用できます。これは、アスペクト比を維持する必要があるときも、その領域が適切に確保されることを意味します。また、レイアウトのスロットを事前に割り当てたり、広告や動的コンテンツのプレースホルダ（フォールバック画像）を使用したりすることも可能です。</p>
<p>外部スクリプトで画像を遅延読み込みする代わりに、ネイティブ遅延読み込みの使用を検討しましょう。<a href="https://web.dev/native-lazy-loading/">ネイティブ遅延読み込み</a>がサポートされていない場合に限り、外部スクリプトの読み込みに<a href="https://www.smashingmagazine.com/2019/05/hybrid-lazy-loading-progressive-migration-native/">ハイブリッド遅延読み込み</a>を使用することも考えてみましょう。</p>
<p>すでに述べたとおり、<a href="https://www.zachleat.com/web/comprehensive-webfonts/#fout-class">Webフォントの再描画は常にグループ化し</a>、全てのフォールバックフォントから全てのWebフォントへ一斉に移行しましょう。移行が唐突過ぎると感じさせないように、<a href="https://meowni.ca/font-style-matcher/">font-style-matcher</a>を使用して、行の高さと間隔をフォント間で調整してください。</p>
<p>フォールバックフォントでWebフォントをエミュレートするために<strong>フォントメトリックを上書きする</strong>には、<a href="https://docs.google.com/document/d/1PW-5ML5hOZw7GczOargelPo6_8Zkuk2DXtgfOtJ59Eo/edit">@font-face記述子を使用できます</a>（<a href="https://jsfiddle.net/wpnjav2k/">デモ</a>、Chrome 87で有効）（ただし、複雑なフォントスタックでは複雑な調整が必要であることにご注意ください）。</p>
<p>CSSが遅い場合は、各テンプレートのヘッダに、<strong>レイアウトにとってクリティカルなCSSを埋め込みましょう</strong>。さらに、長いページの場合、縦のスクロールバーを追加すると<a href="https://twitter.com/paul_irish/status/1239586279924236288">メインコンテンツが16ピクセル左に移動します</a>。スクロールバーを早く表示するには、<a href="https://twitter.com/TimVereecke/status/1239454788116533248"><code class="language-text">html</code>に<code class="language-text">overflow-y: scroll</code>を追加する</a>ことで、スクロールバーを強制的に最初に描画できます。このテクニックが役立つ理由は、幅が変更され、アバブ・ザ・フォールドのコンテンツのリフローが生じると、<a href="https://twitter.com/addyosmani/status/1239592160141307905">スクロールバーが大きなレイアウトシフトを引き起こす可能性がある</a>ためです。ただし、このような事態が起きるのは、ほとんどはWindowsのようにオーバーレイではないスクロールバーを導入しているプラットフォームに限られます。なお、上記の仕組みはposition: stickyを無効にしてしまいます。なぜなら、これらの要素は<a href="https://twitter.com/lfredolo/status/1240301405325361152">スクロールによってコンテナの外に出ることがない</a>ためです。</p>
<p>スクロールページの上部に<a href="https://twitter.com/rick_viscomi/status/1311853000542040066">固定されているヘッダや、スティッキーなヘッダを扱う</a>場合は、プレースホルダ要素やコンテンツの <code class="language-text">margin-top</code>などによって、そのヘッダを固定するためのスペースを確保しましょう。cookie同意バナーは例外で、<a href="https://twitter.com/g33konaut/status/1311709596847927296">CLSに影響しないはず</a>ですが、実装によっては影響を与えることがあります。このTwitterスレッドでは興味深い戦略とポイントが紹介されています。</p>
<p>さまざまな量のテキストが含まれる可能性があるタブコンポーネントについては、<a href="https://www.hsablonniere.com/prevent-layout-shifts-with-css-grid-stacks--qcj5jo/">CSSグリッドのスタックによってレイアウトシフトを防ぐ</a>ことができます。各タブのコンテンツを同じグリッドエリアに配置し、それらを一度に1つずつ隠すことで、コンテナが常により大きい要素の高さを取得し、レイアウトシフトが起こらないようにします。</p>
<p>もちろん、リストの下（フッタなど）にコンテンツがある場合は、<a href="https://addyosmani.com/blog/infinite-scroll-without-layout-shifts/">無限のスクロールと「さらに読み込む」もレイアウトシフトを起こす可能性があります</a>。CLSを改善するには、コンテンツを読み込むための十分なスペースを、ユーザがページのその部分までスクロールする前に確保しましょう。また、コンテンツの読み込みによって押し下げられる可能性があるページ下部のフッタやDOM要素を削除しましょう。さらに、画面外のコンテンツ向けのデータと画像を先読みし、ユーザがそこまでスクロールしたときにはすでにコンテンツが表示されているようにしてください。長いリストを最適化するには、<a href="https://github.com/bvaughn/react-window">react-window</a>などのリスト仮想化ライブラリを使用できます（Addy Osmaniに感謝します）。</p>
<p>リフローの影響を確実に抑えるために、<a href="https://wicg.github.io/layout-instability/">Layout Instability API</a>でレイアウトの安定性を測定しましょう。このAPIでは、<a href="https://web.dev/cls/">Cumulative Layout Shift</a>（CLS）スコアを計算し、それをテストの要件に含めることができます。そのため、スコアが悪化したときはいつでも追跡と修正が可能です。</p>
<p>ブラウザはレイアウトシフトのスコアを計算するうえで、ビューポートのサイズに加え、ビューポート内の不安定な要素が2つのレンダリングされたフレーム間でどれだけ移動したかに着目します。スコアは<code class="language-text">0</code>に近いのが理想です。Milica MihajlijaとPhilip Waltonは、<a href="https://web.dev/cls">CLSとその測定方法</a>に関する素晴らしいガイドを公表しています。これは、特にビジネスに必要不可欠なタスクに関して、体感的なパフォーマンスを測定・維持し、混乱を回避するための良い出発点になります。</p>
<p><strong>簡単なtips</strong>：何がレイアウトシフトの原因になっているかをDevToolsで発見するには、パフォーマンスパネルの"Experience"で<a href="https://youtu.be/AQqFZ5t8uNc?t=454">レイアウトシフトについて調べてみましょう</a>。</p>
<p><strong>おまけ</strong>：リフローと再描画を減らしたいなら、Charis Theodoulouの<a href="https://medium.com/better-programming/web-performance-dom-reflow-76ac7c4d2d4f">DOMのリフロー/レイアウトスラッシングを最小限にする</a>ためのガイド、Paul Irishの<a href="https://gist.github.com/paulirish/5d52fb081b3570c81e3a">レイアウト/リフローの要因</a>のリスト、<a href="https://csstriggers.com/">CSSTriggers.com</a>（レイアウト、描画、合成をトリガーするCSSプロパティの参照表）をチェックしてみましょう。</p>
<h2>ネットワーク接続とHTTP/2 <a href="#07">#</a><a name="07"></a></h2>
<h3>61. OCSPステープリングは有効化されているか？</h3>
<p><a href="https://www.digicert.com/enabling-ocsp-stapling.htm">サーバのOCSPステープリングを有効化する</a>ことでTLSハンドシェイクを高速化できます。オンライン証明書状態プロトコル（OCSP）は証明書失効リスト（CRL）プロトコルの代わりとして開発されました。いずれのプロトコルもSSL証明書が失効していないかを確認するために使用されます。</p>
<p>しかし、OCSPプロトコルはブラウザがリストをダウンロードして証明書情報を検索するのに時間を費やす必要がないため、ハンドシェイクに必要な時間が削減されます。</p>
<h3>62. SSL証明書失効の影響を軽減しているか？</h3>
<p>Simon Hearneは、<a href="https://simonhearne.com/2020/drop-ev-certs/">"The Performance Cost of EV Certificates"</a>という記事で、よく使われる証明書の概要に関する素晴らしい説明と、証明書の選択が全体的なパフォーマンスに及ぼす可能性がある影響に関する情報を提供しています。</p>
<p>Simonが書いているとおり、HTTPSの世界では、トラフィックの安全を確保するために複数の種類の証明書認証レベルが使用されています。</p>
<ul>
<li>ドメイン認証（DV）は、証明書の要求者がドメインを所有していることを認証します。</li>
<li>組織認証（OV）は、組織がドメインを所有していることを認証します。</li>
<li>EV認証（EV）は、厳格な認証によって、組織がドメインを所有していることを認証します。</li>
</ul>
<p>重要なのは、これらの証明書が<a href="https://nooshu.github.io/blog/2020/01/26/the-impact-of-ssl-certificate-revocation-on-web-performance/">全てテクノロジーの面では同一</a>であるということです。違うのは証明書で提供される情報と属性だけです。</p>
<p><strong>EV証明書は、人間が証明書をレビューし、その正当性を確認する必要があるため、高価で時間がかかります</strong>。一方、DV証明書は通常、無料で提供されます。例えば<a href="https://letsencrypt.org/how-it-works/">Let’s Encrypt</a>はオープンで自動化された証明書認証機関で、多くのホスティングプロバイダやCDNにうまく統合されています。実際、この記事の執筆時点で、Let’s Encryptは<a href="https://www.abetterinternet.org/documents/2020-ISRG-Annual-Report.pdf">2億2500万件以上のWebサイト</a>（PDF）に対応しています。ただし、これは<a href="https://telemetry.mozilla.org/new-pipeline/dist.html#!cumulative=0&#x26;end_date=2020-01-03&#x26;include_spill=0&#x26;keys=__none__!__none__!__none__&#x26;max_channel_version=beta%252F72&#x26;measure=CERT_EV_STATUS&#x26;min_channel_version=beta%252F71&#x26;processType=*&#x26;product=Firefox&#x26;sanitize=1&#x26;sort_">ページの2.69％</a>(※訳注：現在原文で意図された期間の参照不可)を占めるに過ぎません（Firefoxで開いた場合）。</p>
<p>それでは、どのような問題があるのでしょうか。問題は、<strong>EV証明書は上記のOCSPステープリングを完全にはサポートしていない</strong>ということです。ステープリングは、サーバが、証明書が失効していないことを証明書認証機関に確認し、その情報を証明書に追加（「ステープル」）することを可能にします。ステープリングがなければ、クライアントが全ての作業を実施しなければならず、TLSネゴシエーションの間に不必要なリクエストが生じます。接続状況が良くない場合、これは大きなパフォーマンスコスト（1000ミリ秒以上）を生み出す可能性があります。</p>
<p>EV証明書はWebパフォーマンスの面から見て優れた選択肢ではなく、DV証明書よりもはるかに大きな影響をパフォーマンスに与える可能性があります。最適なWebパフォーマンスのためには、<a href="https://www.aaronpeters.nl/blog/ev-certificates-make-the-web-slow-and-unreliable/">OCSPステープリングに対応したDV証明書を常に提供しましょう</a>。また、EV証明書に比べて大幅に安く、取得するのに労力もあまりかかりません。少なくとも、<a href="https://blog.mozilla.org/security/2020/01/09/crlite-part-1-all-web-pki-revocations-compressed/">CRLite</a>が利用できるようになるまではそうでしょう。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/26ff04ce-929d-49c3-bbf8-08ca71dd2d88/number-quic-handshakes.png">
圧縮が重要：圧縮されていない証明書チェーンの40～43％はサイズが大き過ぎて、1回のQUICフライトにおける3 UDPデータグラムの範囲に収まりません。（画像の出典：<a href="https://www.fastly.com/blog/quic-handshake-tls-compression-certificates-extension-study">Fastly</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/26ff04ce-929d-49c3-bbf8-08ca71dd2d88/number-quic-handshakes.png">プレビューを拡大</a>）</p>
<p><strong>注記</strong>：QUICやHTTP/3の実用化が進むなかで、<a href="https://www.fastly.com/blog/quic-handshake-tls-compression-certificates-extension-study">TLS証明書チェーンがQUICハンドシェイクのバイト容量の大きな部分を占める可変サイズのコンテンツ</a>であることは注目に値します。サイズは数百バイトから10KB超まで変動します。</p>
<p><a href="https://www.fastly.com/blog/quic-handshake-tls-compression-certificates-extension-study">サイズが大きい証明書は複数回のハンドシェイクを発生させる</a>ので、TLS証明書のサイズを小さく保つことは<a href="https://twitter.com/programmingart/status/1229685029468561409">QUICやHTTP/3ではとても重要</a>です。また<a href="https://twitter.com/mcmanusducksong/status/1262452391208792066">証明書は確実に圧縮する</a>必要があります。さもなければ、証明書チェーンのサイズが大き過ぎて1回のQUICフライトに収まらなくなってしまいます。</p>
<p>この問題と解決策については、はるかに詳しい情報やアドバイスが以下で紹介されています。</p>
<ul>
<li><a href="https://www.aaronpeters.nl/blog/ev-certificates-make-the-web-slow-and-unreliable/">EV Certificates Make The Web Slow and Unreliable</a>（Aaron Peters著）</li>
<li><a href="https://nooshu.github.io/blog/2020/01/26/the-impact-of-ssl-certificate-revocation-on-web-performance/">The impact of SSL certificate revocation on web performance</a>（Matt Hobbs著）</li>
<li><a href="https://simonhearne.com/2020/drop-ev-certs/">The Performance Cost of EV Certificates</a>（Simon Hearne著）</li>
<li><a href="https://www.fastly.com/blog/quic-handshake-tls-compression-certificates-extension-study">Does the QUIC handshake require compression to be fast?</a>（Patrick McManus著）</li>
</ul>
<h3>63. IPv6をすでに導入しているか？</h3>
<p><a href="https://en.wikipedia.org/wiki/IPv4_address_exhaustion">IPv4アドレスは枯渇しつつあり</a>、大規模なモバイルネットワークはIPv6を急速に導入しています（米国ではIPv6の導入率が50％の節目に<a href="https://www.google.com/intl/en/ipv6/statistics.html#tab=ipv6-adoption&#x26;tab=ipv6-adoption">ほとんど到達しました</a>）。そのため、将来に向けて万全に備えるために、DNSをIPv6にアップデートするのが賢明でしょう。ただし、ネットワーク全体でデュアルスタックがサポートされるようにしてください。デュアルスタックでは、IPv6とIPv4をお互いに共存させ、これらを同時に実行できます。結局、IPv6には後方互換性がないのです。また、調査によれば、IPv6は近隣探索プロトコル（NDP）と経路最適化によってWebサイトを10～15％高速化します。</p>
<h3>64. 全てのアセットがHTTP/2（またはHTTP/3）で実行されるようにする。</h3>
<p>Googleが過去数年間で<a href="https://security.googleblog.com/2016/09/moving-towards-more-secure-web.html">より安全なHTTPS Webを推進</a>していることを考えると、<a href="https://http2.github.io/faq/">HTTP/2環境</a>への移行に投資するのは間違いなく賢明です。実際、Web Almanacによれば、<a href="https://almanac.httparchive.org/en/2020/http2">リクエスト全体の64％はすでにHTTP/2で実行されています</a>。</p>
<p><a href="https://www.lucidchart.com/techblog/2019/04/10/why-turning-on-http2-was-a-mistake/">HTTP/2が完璧ではなく</a>、<a href="https://github.com/andydavies/http2-prioritization-issues">優先順位づけに問題がある</a>ことを理解するのは重要です。しかし、HTTP/2は<a href="https://caniuse.com/#search=http2">とても広くサポートされており</a>、ほとんどの場合でHTTP/2の導入は改善につながります。</p>
<p>注意すべき点もあります。<a href="https://groups.google.com/a/chromium.org/g/blink-dev/c/K3rYLvmQUBY/m/vOWBKZGoAQAJ">HTTP/2サーバプッシュはChromeから削除される予定</a>であるため、実装がサーバプッシュに依存している場合は見直す必要があるでしょう。その代わりに、<a href="https://www.fastly.com/blog/beyond-server-push-experimenting-with-the-103-early-hints-status-code">Early Hints</a>を導入すると良いかもしれません。Early Hintsは試験的機能としてすでにFastlyに統合されています。</p>
<p>まだHTTPを利用している場合、最も時間がかかるタスクは、<a href="https://https.cio.gov/faq/">まずHTTPSに移行</a>し、それからHTTP/2の多重化と並列化に合わせてビルドプロセスを調整することでしょう。<a href="https://ldnwebperf.org/sessions/bringing-http-2-to-gov-uk/">Bringing HTTP/2 to Gov.uk</a>は、まさにこれを実現した素晴らしいケーススタディで、実現までの過程でCORS、SRI、WPTの課題を解決しています。本記事では今後、読者の皆さんがHTTP/2に移行中か、すでに移行しているという前提で話を進めます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0005ffe6-5517-4f75-b770-5a547059515c/http2-h2-usage-opt.png">
Web Almanacによれば、HTTP/2の正式な標準化からわずか4年で、2020年終わりにHTTP/2で送信されたリクエストの割合は全体の64％となりました。（画像の出典：<a href="https://almanac.httparchive.org/en/2020/http2">Web Almanac</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0005ffe6-5517-4f75-b770-5a547059515c/http2-h2-usage-opt.png">プレビューを拡大</a>）</p>
<h3>65. HTTP/2を適切に導入する。</h3>
<p>繰り返しになりますが、<a href="https://www.youtube.com/watch?v=yURLTwZ3ehk">アセットをHTTP/2で提供する</a>場合、これまでのアセットの提供方法を部分的に見直すことでメリットを得られる可能性があります。モジュールのパッケージ化と、多くの小さなモジュールの読み込みを並行し、両者のバランスをうまく保つことが必要です。しかし、結局は依然として<a href="https://alistapart.com/article/the-best-request-is-no-request-revisited">リクエストがまったくないことが最善</a>であり、アセットの高速な初期デリバリとキャッシングの間でうまくバランスを取ることが目標になります。</p>
<p>一方、全てのアセットを連結するのは避け、代わりにインタフェース全体を多くの小さなモジュールに分割し、それをビルドプロセスの一環として圧縮し、並行して読み込みたい場合もあるかもしれません。それならば、1つのファイルを変更しても、スタイルシート全体やJavaScriptを再びダウンロードする必要はありません。<a href="https://css-tricks.com/musings-on-http2-and-bundling/">パースにかかる時間も最小限となり</a>、個々のページのペイロードを抑えられます。</p>
<p>一方、<a href="https://engineering.khanacademy.org/posts/js-packaging-http2.htm">パッケージ化も依然として重要です</a>。多くの小さいスクリプトを使用すると、<strong>全体的な圧縮にとって悪影響</strong>となり、<a href="https://simonhearne.com/2020/network-faster-than-cache/">キャッシュからオブジェクトを取得するコストが増加します</a>。大きなパッケージを圧縮すると、ディクショナリを再利用できるというメリットがありますが、小さな個別のパッケージにはそのメリットがありません。この問題に対処するための標準化作業も行われていますが、今のところ実用化は遠い先になりそうです。第2に、ブラウザはこうしたワークフローについて<strong>まだ最適化されていません</strong>。例えば、Chromeはリソースの数に応じて<a href="https://www.chromium.org/developers/design-documents/inter-process-communication">プロセス間通信</a>（IPC）をトリガーするため、何百ものリソースを利用するとブラウザのランタイムコストが生じます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- HTTP/2 push this resource, or inline it, whichever's faster --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/site-header.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/article.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/comment.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>comments<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/about-me.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>about-me<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/site-footer.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>footer</span><span class="token punctuation">></span></span>…<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>footer</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>HTTP/2で最善の結果を達成するには、ChromeのJake Archibaldが提案しているとおり、<a href="https://jakearchibald.com/2016/link-in-body/">CSSを段階的に読み込む</a>ことを検討しましょう。</p>
<p>それでも、<a href="https://jakearchibald.com/2016/link-in-body/">CSSの段階的な読み込み</a>を目指すことはできます。実際、bodyタグ内のCSSは、<a href="https://twitter.com/patmeenan/status/1037027969842208777">現在はChromeのレンダリングをブロックしません</a>。ただし、<a href="https://twitter.com/csswizardry/status/1133867804380270592">優先順位づけに関する問題がある</a>ため、それほど単純ではありませんが、試してみる価値はあります。</p>
<p><a href="https://daniel.haxx.se/blog/2016/08/18/http2-connection-coalescing/">HTTP/2接続の集約</a>も有効かもしれません。これにより、HTTP/2のメリットを享受しつつ、ドメインシャーディングを行うことが可能です。ただし、現実に実行するのは困難で、一般的には優れた方法とは考えられていません。また、<a href="https://nooshu.github.io/blog/2019/12/17/http2-and-sri-dont-always-get-on/">HTTP/2とサブリソース完全性は必ずしも相性が良くありません</a>。</p>
<p>それでは、どうすれば良いのでしょうか。HTTP/2を利用しているなら、送信する<a href="https://nooshu.github.io/blog/2019/12/17/http2-and-sri-dont-always-get-on/">パッケージを6～10個ほどにする</a>のがまずまずの妥協点であると思われます（古いブラウザから見ても悪くありません）。実験と測定によって、自社のWebサイトにとってちょうど良いバランスを見つけましょう。</p>
<h3>66. 全てのアセットを1回のHTTP/2接続で送信しているか？</h3>
<p>HTTP/2の主な利点の1つは、1回の接続でアセットを送信できることです。しかし、例えばCORSに問題がある、<code class="language-text">crossorigin</code>属性を誤って設定するなどの失敗により、ブラウザが新たな接続を開始しなければならない場合もあります。</p>
<p>全てのリクエストを1回のHTTP/2接続で送信できているか、あるいは何かを誤って設定しているかを確認するには、DevTools → Networkで"Connection ID"欄を有効化しましょう。例えば、以下の図ではmanifest.jsonのみが個別の接続（451）を開始しており、それ以外の全てのリクエストは同じ接続（286）を共有しています。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0bc3d810-23d9-49be-b508-f35977a7143c/devtools-3perf.jpg">
manifest.jsonのみが個別の接続（451）を開始しており、それ以外の全てのリクエストは同じHTTP/2接続（286）を共有しています。<a href="https://twitter.com/iamakulov/status/1275849544341901319">iamakulovより</a>。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0bc3d810-23d9-49be-b508-f35977a7143c/devtools-3perf.jpg">プレビューを拡大</a>）</p>
<h3>67. サーバとCDNはHTTP/2をサポートしているか？</h3>
<p>サーバやCDNによって、（依然として）HTTP/2のサポート状況は異なっています。選択肢をチェックするには<a href="https://cdncomparison.com/">CDN Comparison</a>を使用しましょう。このサイトでは、サーバのパフォーマンスや、サポートが予想される機能をすぐに調べることができます。</p>
<p>Pat Meenanによる<a href="https://blog.cloudflare.com/http-2-prioritization-with-nginx/">HTTP/2の優先順位に関する素晴らしい調査</a>（<a href="https://www.youtube.com/watch?v=ct5MvtmL1NM">動画</a>）を参照し、<a href="https://github.com/pmeenan/http2priorities">サーバがHTTP/2の優先順位づけをサポートしているかテストしましょう</a>。Patによれば、Linux 4.9以降のカーネルでHTTP/2の優先順位づけが高い信頼性で機能するには、BBR輻輳制御を有効化し、<code class="language-text">tcp_notsent_lowat</code>を16KBに設定することが推奨されます（Yoavに感謝します）。Andy Daviesは、複数のブラウザ、<a href="https://github.com/andydavies/http2-prioritization-issues#cdns--cloud-hosting-services">CDN、クラウドホスティングサービス</a>でHTTP/2の優先順位づけに関する同様の調査を実施しました。</p>
<p>一方で、カーネルがTCP BBRをサポートしているかダブルチェックし、可能であれば有効化しましょう。TCP BBRは現在、Google Cloud Platform、<a href="https://aws.amazon.com/blogs/networking-and-content-delivery/tcp-bbr-congestion-control-with-amazon-cloudfront/">Amazon Cloudfront</a>、<a href="https://www.techrepublic.com/article/how-to-enable-tcp-bbr-to-improve-network-speed-on-linux/">Linux</a>（<a href="https://www.linuxbabe.com/ubuntu/enable-google-tcp-bbr-ubuntu">Ubuntu</a>など）で使用されています。</p>
<h3>68. HPACK圧縮を利用しているか？</h3>
<p>HTTP/2を使用している場合、不要なオーバーヘッドを削減できるように、サーバがHTTP応答ヘッダの<a href="https://blog.cloudflare.com/hpack-the-silent-killer-feature-of-http-2/">HPACK圧縮を実装</a>しているかをダブルチェックしましょう。一部のHTTP/2サーバはこうした仕様を完全にサポートしていないケースがあり、HPACKがその例となっています。<a href="https://github.com/summerwind/h2spec">H2spec</a>は（技術的にとても細かい内容であるものの）<a href="https://twitter.com/tunetheweb/status/988196156697169920?s=20">サポート状況をチェックするための素晴らしいツールです</a>。HPACKの圧縮アルゴリズムはとても<a href="https://www.mnot.net/blog/2018/11/27/header_compression">優れており</a>、しかも<a href="https://www.keycdn.com/blog/http2-hpack-compression/">有効</a>です。</p>
<h3>69. サーバのセキュリティーが盤石であることを確認する。</h3>
<p>全てのブラウザによるHTTP/2の実装はTLSを利用しています。そのため、セキュリティー上の警告や、ページの一部の要素が機能しない状況は避けたい場合が多いでしょう。<a href="https://securityheaders.io/">セキュリティヘッダが適切に設定されていること</a>をダブルチェックし、<a href="https://www.smashingmagazine.com/2016/01/eliminating-known-security-vulnerabilities-with-snyk/">既知の脆弱性を排除</a>し、<a href="https://www.ssllabs.com/ssltest/">HTTPS設定を確認</a>しましょう。</p>
<p>また、全ての外部プラグインと追跡スクリプトがHTTPSを通じて読み込まれていること、クロスサイトスクリプティングが不可能であること、<a href="https://www.owasp.org/index.php/HTTP_Strict_Transport_Security_Cheat_Sheet">HTTP Strict Transport Securityヘッダ</a>と<a href="https://content-security-policy.com/">Content Security Policyヘッダ</a>の両方が適切に設定されていることを確かめてください。</p>
<h3>70. サーバとCDNはHTTP/3をサポートしているか？</h3>
<p>HTTP/2はいくつもの面でWebのパフォーマンスに重要な改善をもたらしましたが、まだ大きな改善の余地は残っています。特に<a href="https://youtu.be/SuSpghHP0uI?t=290">TCPのヘッドオブラインブロッキング</a>は、低速なネットワークでは顕著で、大きなパケットロスを生みます。<a href="https://youtu.be/SuSpghHP0uI?t=290">HTTP/3はこうした問題を完全に解決しつつあります</a>（<a href="https://calendar.perfplanet.com/2020/head-of-line-blocking-in-quic-and-http-3-the-details/">記事</a>）。</p>
<p>HTTP/2の問題に対処するために、IETFはGoogle、Akamaiなどとともに新たなプロトコルに取り組んでおり、その成果は<a href="https://tools.ietf.org/html/draft-ietf-quic-http">最近、HTTP/3として標準化されました</a>。</p>
<p>Robin Marxは<a href="https://www.youtube.com/watch?v=SuSpghHP0uI&#x26;feature=youtu.be">HTTP/3について素晴らしい解説</a>をしており、以下の説明は彼の解説に基づくものです。HTTP/3の本質は、機能の面では<strong>HTTP/2にとてもよく似ています</strong>が、内部の仕組みは大きく異なっています。<a href="https://blog.cloudflare.com/http3-the-past-present-and-future/">HTTP/3はいくつもの面で改善されています</a>。ハンドシェイクは高速化し、暗号化は改善され、独立したストリームの信頼性は向上し、暗号化とフローの制御も進歩しています。特に目立つ違いは、HTTP/3がトランスポート層としてQUICを使用しており、TCPではなくQUICパケットがUDPダイアグラムの上部に埋め込まれることです。</p>
<p>QUICはTLS 1.3をプロトコルに完全に統合しています。一方、TCPでは、TLS 1.3はプロトコルに上乗せされます。通常のTCPスタックでは、TCPとTLSがそれぞれ別個にハンドシェイクを行う必要があるため、数回分のラウンドトリップのオーバーヘッドが発生します。しかし、QUICでは<strong>両者を結合し、1回のみのラウンドトリップで完了する</strong>ことができます。TLS 1.3では今後の接続のための暗号化キーを設定できるため、2回目の接続以降は最初のラウンドトリップからすでにアプリケーション層のデータを送受信することができます。これは「0-RTT」と呼ばれます。</p>
<p>また、HTTP/2のヘッダ圧縮アルゴリズムは、優先順位づけのシステムとともに完全に書き直されました。さらにQUICは、各QUICパケットのヘッダの接続IDを通じて、Wi-Fiからセルラーネットワークへの<strong>接続のマイグレーション</strong>をサポートしています。ほとんどの実装は（TCPと同様に）カーネル空間ではなくユーザ空間で行われるため、プロトコルは今後、変化していくでしょう。</p>
<p>これらは全て大きな変化をもたらすのでしょうか。<a href="https://twitter.com/FredKSchott/status/1313913507583193088">その答えはおそらくイエスです</a>。特にモバイルの読み込み時間に影響をもたらすと思われますが、それだけではなく、エンドユーザへのアセットの提供方法にも影響する見込みです。HTTP/2では複数のリクエストが接続を共有しますが、HTTP/3のリクエストは接続を共有するだけでなく独立してストリームを送信するため、脱落したパケットが全てのリクエストに影響することはなくなり、1つのストリームのみに影響するようになります。</p>
<p>これは、1つの大きなJavaScriptバンドルでは、1つのストリームが停止したときにアセットの処理が減速しますが、複数のファイルストリームが並行的に送信される場合（HTTP/3）は影響が軽減されることを意味しています。そのため、<strong>パッケージ化は今も重要です</strong>。</p>
<p>HTTP/3への取り組みは<a href="https://twitter.com/programmingart/status/1311656119450972161">依然として進行中です</a>。Chrome、Firefox、Safariには<a href="https://caniuse.com/http3">すでに実装されています</a>。一部の<a href="https://twitter.com/RobertHoeijmak1/status/1313936281039241216">CDNもQUICとHTTP/3をすでにサポートしています</a>。2020年の終わりに、<a href="https://twitter.com/FredKSchott/status/1313910775199612929">ChromeはHTTP/3とIETF QUICの導入を開始しました</a>。実際、Googleの全てのサービス（Google Analytics、YouTubeなど）はすでにHTTP/3を利用しています。<a href="https://www.litespeedtech.com/products/litespeed-web-server">LiteSpeed Web Server</a>はHTTP/3をサポートしていますが、Apache、NGINX、IISはいずれもHTTP/3をまだサポートしていません。しかし、2021年にはこの状況が急速に変化するでしょう。</p>
<p><strong>結論</strong>：サーバとCDNでHTTP/3を使用するという選択肢があるなら、おそらくそれを選ぶのが非常に賢明でしょう。主なメリットは、特にレイテンシが大きい接続において、複数のオブジェクトを同時に取得できることです。この分野ではあまり調査が行われていないため、確定的なことは分かりませんが、<a href="https://blog.cloudflare.com/http-3-vs-http-2/">最初の調査は大きな期待が持てる結果となっています</a>。</p>
<p>このプロトコルの仕様とメリットについてもっと詳しく知りたい方向けに、優れた出発点としてチェックすべき資料を紹介します。</p>
<ul>
<li><a href="https://http3-explained.haxx.se/">HTTP/3 Explained</a>は、HTTP/3とQUICプロトコルの文書化に向けた共同の取り組みの成果です。さまざまな言語で提供されており、PDFでも利用できます。</li>
<li>Daniel Stenbergは<a href="https://cloudflare.tv/event/2EyYvt1zPHViDAxHMjpIdq">Leveling Up Web Performance With HTTP/3</a>という動画を提供しています。</li>
<li>Robin Marxの<a href="https://www.youtube.com/watch?v=SuSpghHP0uI&#x26;feature=youtu.be">An Academic’s Guide to QUIC</a>という講演では、QUICとHTTP/3プロトコルの基本的な概念を紹介し、HTTP/3がヘッドオブラインブロッキングと接続マイグレーションを処理する方法や、HTTP/3が有用性を保つためにどのように設計されているかについて説明しています（<a href="https://twitter.com/simonhearne/status/1330059997213052932">Simon</a>に感謝します）。</li>
<li>サーバがHTTP/3を利用しているかどうかは<a href="https://http3check.net/">HTTP3Check.net</a>で確認できます。</li>
</ul>
<h2>テストとモニタリング <a href="#08">#</a><a name="08"></a></h2>
<h3>71. 監査ワークフローを最適化しているか？</h3>
<p>適切な設定をすぐ利用できるように準備しておくことは、重要には思えないかもしれませんが、テストの時間をかなり削減できる可能性があります。WebPageTestのパブリックインスタンスにテストを送信するために、Tim Kadlecの<a href="https://github.com/tkadlec/webpagetest-alfred-workflow">WebPageTest向けAlfred Workflow</a>の使用を検討しましょう。実際、WebPageTestにはよく知られていない機能が数多くあります。ですから、<a href="https://nooshu.github.io/blog/2019/10/02/how-to-read-a-wpt-waterfall-chart/">時間を取ってWebPageTestのWaterfall Viewチャートを読む方法</a>と<a href="https://nooshu.github.io/blog/2019/12/30/how-to-read-a-wpt-connection-view-chart/">WebPageTestのConnection Viewチャートを読む方法</a>を学習し、パフォーマンスに関する問題を素早く診断・解決できるようにしましょう。</p>
<p>また、<a href="https://calendar.perfplanet.com/2014/driving-webpagetest-from-a-google-docs-spreadsheet/">WebPageTestをGoogle Spreadsheetから実行する</a>ことや、<a href="https://web.dev/fast/using-lighthouse-ci-to-set-a-performance-budget">アクセシビリティ、パフォーマンス、SEOスコアをLighthouse CIでTravisの設定に組み込む</a>こと、あるいはこれらを<a href="https://twitter.com/addyosmani/statuses/1017655423099289600">Webpackに直接組み込む</a>ことも可能です。</p>
<p>最近リリースされた<a href="https://web.dev/autowebperf/">AutoWebPerf</a>にも注目しましょう。これは複数のソースからパフォーマンスデータを自動的に収集できるモジュラーツールです。例えば、クリティカルなページ上に毎日実行されるテストを設定し、CrUX APIからフィールドデータを、PageSpeed InsightsのLighthouseレポートからラボデータを取得できます。</p>
<p>また、何らかのデバッグを素早く実施する必要があるが、ビルドプロセスがとても遅く感じられる場合は、以下のことに気をつけましょう。「ほとんどのJavaScriptコードの軽量化では、手の込んだコード変換ではなく、<a href="https://slack.engineering/keep-webpack-fast-a-field-guide-for-better-build-performance-f56a5995e8f1">ホワイトスペースの削除とシンボル修飾がサイズ削減の95％を占めています</a>。圧縮を無効化するだけでUglifyのビルドを3～4倍高速化できます」。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/705ed9b1-cd4d-4231-b808-ce8c2e72e070/review-required-checks-pr.png">
Lighthouse CIでTravisの設定に<a href="https://web.dev/fast/using-lighthouse-ci-to-set-a-performance-budget">アクセシビリティ、パフォーマンス、SEOスコア</a>を統合することで、プロジェクトに関与している全ての開発者に新たな機能がどのようなパフォーマンス上の影響を与えるかを明らかにすることができます。（<a href="https://cdn-images-1.medium.com/max/1600/1*Y-1sdlIzFBRfEQPprzLnbA.png">画像の出典</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/705ed9b1-cd4d-4231-b808-ce8c2e72e070/review-required-checks-pr.png">プレビューを拡大</a>）</p>
<h3>72. プロキシブラウザと古いブラウザでテストを実施しているか？</h3>
<p>ChromeとFirefoxでテストをするだけでは不十分です。プロキシブラウザと古いブラウザでWebサイトがどのように動作するかも調べましょう。例えば、UC BrowserとOpera Miniは<a href="https://gs.statcounter.com/#mobile_browser-as-monthly-201511-201611">アジアで大きな市場シェアを獲得しています</a>（アジアで最大35％）。今後、予想外の大きな問題が起きるのを避けるため、ターゲットとする国の平均的なインターネット速度を測定しましょう。ネットワークスロットリングを使用してテストを実施し、高DPIの端末をエミュレートしましょう。<a href="https://www.browserstack.com/">BrowserStack</a>はリモートで実物の端末をテストするための素晴らしいツールです。オフィスで少なくとも数台の実物の端末をテストすることで、BrowserStackのテスト結果を補完することには価値があります。</p>
<h3>73. 404ページのパフォーマンスをテストしているか？</h3>
<p>通常、404ページについてよく考えることはありません。クライアントがサーバに存在しないページをリクエストしたとき、サーバは404ステータスコードと、関連する404ページを返します。それだけのことではないのでしょうか。</p>
<p>404応答において重要なのは、ブラウザに送信される実際の<strong>応答の本文サイズ</strong>です。<a href="https://nooshu.github.io/blog/2020/08/25/you-should-be-testing-your-404-pages-web-performance/">Matt Hobbsの404ページの調査</a>によると、404応答の大部分は、失われたファビコン、WordPressのアップロードリクエスト、壊れたJavaScriptリクエスト、マニフェストファイル、CSSとフォントファイルに由来します。クライアントは、存在しないアセットをリクエストするたびに404応答を受け取ります。その応答のサイズはとても大きいことが多いのです。</p>
<p>404ページの<strong>キャッシング戦略</strong>を確実に検証し、最適化しましょう。目標は、ブラウザがHTML応答を予期しているときにのみHTMLをブラウザに提供し、その他の全ての応答には小規模なエラーのペイロードを返すことです。Mattによれば、「CDNをオリジンの前に配置した場合、CDN上に404ページ応答をキャッシュできる可能性があります。これは便利だと言えます。なぜなら、そうしなければ、404ページへのアクセスが、オリジンサーバを全ての404リクエストに応答させることによるDoS攻撃の経路として利用される可能性があるからです。この攻撃には、オリジンサーバの代わりに、CDNがキャッシュ済みのバージョンによって応答することで対応できます」。</p>
<p>404エラーはパフォーマンスに悪影響を及ぼすだけでなく、トラフィックのコストを大きくします。ですから、Lighthouseのテストに404エラーページを含め、そのスコアを時系列で追跡するのは良いアイデアだと言えます。</p>
<h2>74. GDPR同意プロンプトのパフォーマンスをテストしているか？</h2>
<p>現在は一般データ保護規則（GDPR）とカリフォルニア州消費者プライバシー法（CCPA）の時代であり、EUの顧客向けにトラッキングのオプトインとオプトアウトの選択肢を提供するためにサードパーティを利用することが一般的となりました。しかし、他のあらゆるサードパーティスクリプトと同様に、GDPRに関するサードパーティのパフォーマンスは、パフォーマンス向上のための取り組み全体にとても破壊的な影響をもたらす可能性があります。</p>
<p>もちろん、実際に顧客が同意するかどうかによって、スクリプトがパフォーマンス全体にもたらす影響は変わるでしょう。そこで、<a href="https://twitter.com/boostmarks/status/1255867669255000064">Boris Schapira</a>が述べているとおり、以下のさまざまなケースのWebパフォーマンスを調べるのが良いかもしれません。</p>
<ul>
<li>同意が完全に拒否された場合</li>
<li>同意が部分的に拒否された場合</li>
<li>完全な同意が得られた場合</li>
<li>ユーザが同意プロンプトに反応しなかった場合（またはプロンプトがコンテンツブロッカによってブロックされた場合）</li>
</ul>
<p>通常、cookie同意プロンプトは<a href="https://twitter.com/g33konaut/status/1311709596847927296">CLSに影響を与えないはず</a>ですが、<a href="https://twitter.com/rnebhwani/status/1315016813651128320">場合によっては影響を与えます</a>。ですから、無料のオープンソースオプションである<a href="https://www.osano.com/cookieconsent">Osano</a>や<a href="https://github.com/adriandmitroca/cookie-consent-box">cookie-consent-box</a>の使用を検討しましょう。</p>
<p>一般的に、<strong>ポップアップのパフォーマンス</strong>は検討に値します。マウスイベントの縦や横のオフセットを決定したり、ポップアップをアンカーに対して適切に設置したりする必要があるからです。Noam Rosenthalは、<a href="https://techblog.wikimedia.org/2020/11/23/web-performance-case-study-wikipedia-page-previews/">Web performance case study: Wikipedia page previews</a>という記事でWikimediaチームの教訓を共有しています（<a href="https://www.youtube.com/watch?v=sKvK3x9zdt0&#x26;feature=youtu.be">動画</a>と<a href="https://docs.google.com/document/d/e/2PACX-1vR3QYysQvaeXyVD4ObCjqbhGq-yFnBXfBQAiWQrTImKOF2pnGuwLumqYMvmrPaWPHnGP9ENjwlcVNNT/pub">議事録</a>も提供されています）。</p>
<h3>75. パフォーマンス診断CSSを保持しているか？</h3>
<p>パフォーマンスが悪いコードが導入されていないかを調べるには、あらゆる種類のチェック方法を採用することができます。簡単に解決できて、すぐに一定の成果を上げられる問題を手早く知れれば、役に立つことが多いはずです。これに関しては、Tim Kadlecの素晴らしい<a href="https://gist.github.com/tkadlec/683b26344cde774170b94c0fcf0088b4">Performance Diagnostics CSS</a>（<a href="https://twitter.com/csswizardry/status/1346477682544951296">Harry Robertsのスニペット</a>にインスパイアされたものです）を使用できます。これは、読み込みが遅い画像、寸法が合っていない画像、古い形式の画像、同期スクリプトを明らかにするものです。</p>
<p>例えば、<a href="https://twitter.com/csswizardry/status/1346477682544951296">アバブ・ザ・フォールドのどの画像の読み込みも遅延しないようにしたい</a>とします。この場合、使われていないWebフォントをハイライトする、アイコンのフォントを検知するなど、ニーズに合わせてスニペットをカスタマイズすることが可能です。この小規模なツールは、デバッグの間にミスを可視化したり、単純に現在のプロジェクトをとても高速に監査したりできる素晴らしい存在です。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* Performance Diagnostics CSS */</span>
<span class="token comment">/* via Harry Roberts. https://twitter.com/csswizardry/status/1346477682544951296 */</span>
<span class="token selector">img[loading=lazy]</span> <span class="token punctuation">{</span>
  <span class="token property">outline</span><span class="token punctuation">:</span> 10px solid red<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>76. アクセシビリティへの影響をテストしているか？</h3>
<p>ブラウザはページの読み込みを開始するときにDOMを構築します。スクリーンリーダが実行中であるなど、ユーザ援助技術が存在する場合は、アクセシビリティツリーも作成します。スクリーンリーダは、アクセシビリティツリーに対するクエリを行って情報を取得し、それをユーザに提供します。情報提供はデフォルトで行われたり、要求に応じて行われたりします。これには時間がかかることがあります。</p>
<p>Time to Interactiveの速さは通常、ユーザがリンクやボタンをクリックしたり、タップしたりすることによって、どれだけ速くページとのインタラクションができるかという指標を意味します。スクリーンリーダの場合、意味は少し変わります。この場合、Time to Interactiveの速さは、スクリーンリーダが任意のページの<strong>ナビゲーションを読み上げ</strong>、ユーザがインタラクションのために実際にキーボードを打てるまでにどれだけの時間が経過するかを意味します。</p>
<p>Léonie Watsonは、<a href="https://www.youtube.com/watch?v=n1sXj9oAXFU">アクセシビリティのパフォーマンス</a>、特に読み込みの遅さがスクリーンリーダの読み上げの遅延に与える影響について、驚くべき講演を実施しています。スクリーンリーダは、速いペースの読み上げや高速なナビゲーションに慣れているため、視力があるユーザよりもせっかちな可能性さえあります。</p>
<p>JavaScriptによるサイズが大きいページやDOMの操作は、スクリーンリーダの読み上げが遅延する原因となります。この分野はまだまだ未開拓ですが、スクリーンリーダはほとんどのプラットフォームで利用できるため（Jaws、NVDA、Voiceover、Narrator、Orca）、ある程度の注意を払い、テストを行うことが必要でしょう。</p>
<h3>77. 継続的モニタリングを設定しているか？</h3>
<p><a href="https://www.webpagetest.org/">WebPageTest</a>のプライベートインスタンスの設定は、高速で制約がないテストを実現するうえで常にメリットがあります。しかし、<a href="https://www.sitespeed.io/">Sitespeed</a>、<a href="https://calibreapp.com/">Calibre</a>、[SpeedCurve][https://speedcurve.com/]などの継続的モニタリングツールと自動アラートならば、パフォーマンスの全体像をもっと詳しく知ることができます。独自のUser Timingの測定ポイントを設定し、自社のビジネスに固有の指標を測定・モニタリングしましょう。また、時系列の変化をモニタリングするため、<a href="https://calendar.perfplanet.com/2017/automating-web-performance-regression-alerts/">自動化されたパフォーマンス悪化アラート</a>の追加を検討しましょう。</p>
<p>時系列のパフォーマンスの変化をモニタリングするため、RUMソリューションの使用を検討してみてください。ユニットテストと同様の読み込みテストを自動化するツールとして、<a href="https://github.com/loadimpact/k6">k6</a>とそのスクリプティングAPIが使用できます。<a href="https://speedtracker.org/">SpeedTracker</a>、<a href="https://github.com/GoogleChrome/lighthouse">Lighthouse</a>、<a href="https://calibreapp.com/">Calibre</a>もチェックしてみましょう。</p>
<h2>手軽に成果を上げる <a href="#09">#</a><a name="09"></a></h2>
<p>このリストはとても包括的なので、全ての最適化を完了するにはかなりの時間がかかるかもしれません。もし1時間だけで大きな改善を実現する必要があるとしたら、何をすべきでしょうか。そこで、リスト全体を<strong>17の手軽に達成できる項目</strong>にまとめてみました。もちろん、最適化の開始前と終了後に結果を測定するようにしてください。測定対象には3G接続と有線接続のLargest Contentful PaintとTime to Interactiveが含まれます。</p>
<ol>
<li>現実世界のユーザ体験を測定し、適切な目標を設定する。最も速い競合サイトよりも20％以上速くなることを目指す。低速な3GでLargest Contentful Paint ＜ 2.5秒、First Input Delay ＜ 100ミリ秒、Time to Interactive ＜ 5秒、リピート訪問の場合はTTI ＜ 2秒を維持する。少なくともFirst Contentful PaintとTime To Interactiveを最適化する。</li>
<li><a href="https://squoosh.app/">Squoosh</a>、<a href="https://github.com/mozilla/mozjpeg">mozjpeg</a>、<a href="https://github.com/google/guetzli">guetzli</a>、<a href="https://css-ig.net/pingo">pingo</a>、<a href="https://jakearchibald.github.io/svgomg/">SVGOMG</a>で画像を最適化し、画像CDNでAVIF/WebPを提供する。</li>
<li>主要なテンプレート向けのクリティカルCSSを準備し、それを各テンプレートの<code class="language-text">&lt;head&gt;</code>に埋め込む。CSS/JSについては、クリティカルなファイルの容量を、<a href="https://infrequently.org/2017/10/can-you-afford-it-real-world-web-performance-budgets/">gzip形式の圧縮後で最大170KBのバジェットに収める</a>（解凍すると0.7MB）。</li>
<li>スクリプトの縮小、最適化、遅延、遅延読み込みを行う。バンドラの設定に注力し、冗長性を削除し、別の軽い選択肢を探す。</li>
<li>いつでも静的アセットをセルフホストし、サードパーティアセットをなるべくセルフホストする。サードパーティのスクリプトの影響を抑える。ファサードを使用し、インタラクション時にウィジェットを読み込む。ちらつきを防ぐためのスニペットに気をつける。</li>
<li>フレームワークを選択するときは対象を絞り込む。シングルページアプリケーションについては、クリティカルなページを特定し、それを静的に提供する、あるいは少なくともプリレンダリングする。さらに、コンポーネントのレベルでプログレッシブハイドレーションを使用し、インタラクション時にモジュールをインポートする。</li>
<li>クライアントサイドのレンダリングのみでは、パフォーマンスにとって良い選択とは言えない。ページがあまり変化しない場合はプリレンダリングを行い、可能ならばフレームワークの起動を遅らせる。可能な場合はストリーミングサーバサイドレンダリングを使用する。</li>
<li><code class="language-text">&lt;script type=&quot;module&quot;&gt;</code>と<a href="https://philipwalton.com/articles/using-native-javascript-modules-in-production-today/">module/nomoduleパターン</a>によって、古いコードは古いブラウザのみに提供する。</li>
<li>CSSルールの再グループ化を試し、bodyタグ内のCSSをテストする。</li>
<li>リソースヒントを追加し、比較的高速な<code class="language-text">dns-lookup</code>、<code class="language-text">preconnect</code>、<code class="language-text">prefetch</code>、<code class="language-text">preload</code>、<code class="language-text">prerender</code>によってデリバリを高速化する。</li>
<li>Webフォントをサブセット化し、非同期で読み込む。最初のレンダリングを高速化するため、CSSで<code class="language-text">font-display</code>を使用する。</li>
<li>HTTPキャッシュヘッダとセキュリティヘッダが適切に設定されていることを確認する。</li>
<li>サーバ上のBrotli圧縮を有効化する（不可能である場合、少なくともgzip圧縮を確実に有効化する）。</li>
<li>サーバがLinuxカーネルのバージョン4.9以降で実行されている場合、TCP BBRによる輻輳制御を有効化する。</li>
<li>可能な場合、OCSPステープリングとIPv6を有効化する。常にOCSPステープリングされたDV証明書を提供する。</li>
<li>HTTP/2向けのHPACK圧縮を有効化し、利用できる場合はHTTP/3に移行する。</li>
<li>フォント、スタイル、JavaScript、画像などのアセットをサービスワーカのキャッシュにキャッシングする。</li>
</ol>
<h2>チェックリストのダウンロード（PDF、Apple Pages）<a href="#10">#</a><a name="10"></a></h2>
<p>このチェックリストを念頭に置けば、どんな種類のフロントエンドのパフォーマンス最適化プロジェクトにも備えることができるでしょう。すぐに印刷できるPDF版や、ニーズに合わせてカスタマイズできる<strong>編集可能なApple Pagesドキュメント</strong>版のチェックリストをお気軽にダウンロードしてください。</p>
<ul>
<li><a href="https://www.dropbox.com/s/34noajrbm324iai/performance-checklist-1.4.pdf?dl=0">PDFでチェックリストをダウンロードする</a>（PDF、166KB）</li>
<li><a href="https://www.dropbox.com/s/ikuk5ikcxxv39uu/performance-checklist-1.4.pages?dl=0">Apple Pagesでチェックリストをダウンロードする</a>（.pages、275KB）</li>
<li><a href="https://www.dropbox.com/scl/fi/s7ctdj89zd5zlvtt7dkhi/performance-checklist-1.4.docx?dl=0&#x26;rlkey=2xzs55e3kdg1jcraw5u1tnpl8">MS Wordでチェックリストをダウンロードする</a>（.docx、151KB）</li>
</ul>
<p>他の選択肢が必要ならば、<a href="https://github.com/drublic/checklist">Dan Rublicのフロントエンドチェックリスト</a>、Jon Yablonskiの"<a href="https://jonyablonski.com/designers-wpo-checklist/">Designer’s Web Performance Checklist</a>"、<a href="https://github.com/thedaviddias/Front-End-Performance-Checklist">FrontendChecklist</a>もチェックしてみましょう。</p>
<h2>さあ、始めよう！<a href="#11">#</a><a name="11"></a></h2>
<p>一部の最適化は、業務や予算の範囲を超えていたり、処理すべきレガシーコードに対して行き過ぎていたりするかもしれません。それでも大丈夫です。このチェックリストは一般的な（願わくば包括的な）ガイドとして使用し、皆さんの状況に合った独自の課題リストを作成してください。しかし、最も重要なのは、最適化の前にプロジェクトをテスト・測定して課題を特定することです。皆さんの2021年のパフォーマンス最適化が良い結果を生みますように！</p>
<hr>
この記事をレビューしてくれたGuy Podjarny、Yoav Weiss、Addy Osmani、Artem Denysov、Denys Mishunov、Ilya Pukhalski、Jeremy Wagner、Colin Bendell、Mark Zeman、Patrick Meenan、Leonardo Losoviz、Andy Davies、Rachel Andrew、Anselm Hannemann、Barry Pollard、Patrick Hamann、Gideon Pyzer、Andy Davies、Maria Prosvernina、Tim Kadlec、Rey Bango、Matthias Ott、Peter Bowyer、Phil Walton、Mariana Peralta、Pepijn Senders、Mark Nottingham、Jean Pierre Vincent、Philipp Tellis、Ryan Townsend、Ingrid Bergman、Mohamed Hussain S. H.、Jacob Groß、Tim Swalling、Bob Visser、Kev Adamson、Adir Amsalem、Aleksey Kulikov、Rodney Rehm、ならびに、パフォーマンス最適化の取り組みから学んだテクニックと教訓を誰もが使えるように共有してくれたすてきなコミュニティに心から感謝します。皆さんは本当に最高です。<p></p>
<p><em>※編注：本記事は2021年4月時点に公開されていた原文記事を翻訳した内容となります。翻訳記事公開にあたり、2023年6月時点で原文にてリンク切れとなっている箇所の削除や注記、原文に現在表示されていない内容を掲載している場合がございます。ご了承ください。</em></p>]]></content:encoded></item><item><title><![CDATA[フロントエンドパフォーマンスのチェックリスト2021年版（PDF、Apple Pages、MS Word）-中編]]></title><description><![CDATA[目次＃ 前編 準備段階：計画と指標
パフォーマンスを重視する文化、Core Web Vitals、パフォーマンスのプロファイル、CrUX、Lighthouse、FID、TTI、CLS、端末。 現実的…]]></description><link>https://postd.cc/front-end-performance-2021-checklist-2/</link><guid isPermaLink="false">https://postd.cc/front-end-performance-2021-checklist-2/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[パフォーマンス]]></category><pubDate>Fri, 30 Jun 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<h2>目次<a href="#00">＃</a></h2>
<p><strong>前編</strong></p>
<ul>
<li><a href="/front-end-performance-2021-checklist-1/#01">準備段階：計画と指標</a><br>
パフォーマンスを重視する文化、Core Web Vitals、パフォーマンスのプロファイル、CrUX、Lighthouse、FID、TTI、CLS、端末。</li>
<li><a href="/front-end-performance-2021-checklist-1/#02">現実的な目標の設定</a><br>
パフォーマンスバジェット、パフォーマンス目標、RAILフレームワーク、170KB/30KBバジェット。</li>
<li><a href="/front-end-performance-2021-checklist-1/#03">環境の定義</a><br>
フレームワークの選択、パフォーマンスコストの基準設定、Webpack、依存関係、CDN、フロントエンドアーキテクチャ、CSR、SSR、CSR + SSR、静的レンダリング、プリレンダリング、PRPLパターン。</li>
</ul>
<p><strong>中編</strong></p>
<ul>
<li><a href="#04">アセットの最適化</a><br>
Brotli、AVIF、WebP、レスポンシブ画像、AV1、アダプティブメディア読み込み、動画圧縮、Webフォント、Googleフォント。</li>
<li><a href="#05">ビルドの最適化</a><br>
JavaScriptモジュール、モジュール/ノーモジュールのパターン、ツリーシェイキング、コード分割、スコープホイスティング、Webpack、デファレンシャルサービング、Webワーカー、WebAssembly、JavaScriptバンドル、React、SPA、パーシャルハイドレーション、インポート・オン・インタラクション、サードパーティ、キャッシュ</li>
</ul>
<p><strong>後編</strong></p>
<ul>
<li><a href="/front-end-performance-2021-checklist-3/#06">デリバリの最適化</a><br>
遅延読み込み、インターセクションオブザーバー、遅延レンダリングとデコーディング、クリティカルCSS、ストリーミング、リソースヒント、レイアウトシフト、サービスワーカー。</li>
<li><a href="/front-end-performance-2021-checklist-3/#07">ネットワーク接続、HTTP/2、HTTP/3</a><br>
OCSPステープリング、EV/DV証明書、パッケージング、IPv6、QUIC、HTTP/3。</li>
<li><a href="/front-end-performance-2021-checklist-3/#08">テストとモニタリング</a><br>
監査ワークフロー、プロキシブラウザ、404ページ、GDPRに基づくcookie同意プロンプト、パフォーマンス診断CSS、アクセシビリティ。</li>
<li><a href="/front-end-performance-2021-checklist-3/#09">手軽に成果を上げる</a><br></li>
<li><a href="/front-end-performance-2021-checklist-3/#10">チェックリストのダウンロード（PDF、Apple Pages、MS Word）</a><br></li>
<li><a href="/front-end-performance-2021-checklist-3/#11">さあ、始めよう！</a><br></li>
</ul>
<p>（<a href="https://www.dropbox.com/s/34noajrbm324iai/performance-checklist-1.4.pdf?dl=0">チェックリストのPDFファイル</a>（166KB）、<a href="https://www.dropbox.com/s/ikuk5ikcxxv39uu/performance-checklist-1.4.pages?dl=0">編集可能なApple Pagesファイル</a>（275KB）、<a href="https://www.dropbox.com/scl/fi/s7ctdj89zd5zlvtt7dkhi/performance-checklist-1.4.docx?dl=0&#x26;rlkey=2xzs55e3kdg1jcraw5u1tnpl8">.docxファイル</a>（151KB）も自由にダウンロードできます。皆さんが最適化を楽しめますように！）</p>
<h2>アセットの最適化 <a href="#04">#</a><a name="04"></a></h2>
<h3>20. プレーンテキストの圧縮にBrotliを使用する。</h3>
<p>2015年、Googleはオープンソースのロスレスな新しいデータ形式である<a href="https://github.com/google/brotli">Brotli</a>を<a href="https://opensource.googleblog.com/2015/09/introducing-brotli-new-compression.html">導入しました</a>。
現在、Brotliは全てのモダンなブラウザでサポートされています。
<a href="https://github.com/google/brotli">オープンソースのBrotliライブラリ</a>は、Brotli用のエンコーダとデコーダを実装するものです。
エンコーダには11の品質レベルがあらかじめ定められており、品質レベルが高いほど、CPUの要求水準が高い代わりに圧縮率も良くなります。
圧縮が遅いほど最終的な圧縮率は高くなりますが、それでもBrotliの解凍は高速です。
Brotliの圧縮レベル4は、gzipよりも容量が小さく、圧縮が速いことは注目に値します。</p>
<p>実際、Brotliはgzipよりも<a href="https://paulcalvano.com/index.php/2018/07/25/brotli-compression-how-much-will-it-reduce-your-content/">はるかに有効</a>なようです。
Brotliに関する意見や体験はさまざまですが、サイトをgzipで最適化する場合に比べて、
ファイルの容量とFCPのタイミングを<a href="https://blog.bitsrc.io/gzip-to-brotli-better-frontend-load-performance-b2b4d8dbf60f">最低でも1桁台</a>、
最高なら<a href="https://expeditedsecurity.com/blog/nginx-brotli/">2桁台</a>の割合で改善できるでしょう。
<a href="https://tools.paulcalvano.com/compression.php">Brotliによってサイトの圧縮率がどれだけ改善するかを推定する</a>ことも可能です。</p>
<p>ブラウザがBrotliを受け入れるのは、ユーザがWebサイトにHTTPSでアクセスする場合に限られます。
Brotliは広くサポートされており、多くのCDN（
<a href="https://community.akamai.com/community/web-performance/blog/2017/08/18/brotli-support-enablement-on-akamai">Akamai</a>、
<a href="https://www.netlify.com/blog/2020/05/20/gain-instant-performance-boosts-as-brotli-comes-to-netlify-edge/">Netlify Edge</a>、
<a href="https://medium.com/@felice.geracitano/brotli-compression-delivered-from-aws-7be5b467c2e1">AWS</a>、
<a href="https://www.keycdn.com/blog/keycdn-brotli-support">KeyCDN</a>、
<a href="https://docs.fastly.com/guides/detailed-product-descriptions/performance-optimization-package">Fastly</a>（現在はパススルーのみ）、
<a href="https://support.cloudflare.com/hc/en-us/articles/200168396-What-will-Cloudflare-compress-">Cloudflare</a>、
<a href="https://www.cdn77.com/brotli">CDN77</a>）のサポート対象となっています。
さらに、<a href="https://calendar.perfplanet.com/2016/enabling-brotli-even-on-cdns-that-dont-support-it-yet/">BrotliをまだサポートしていないCDNでさえ使用することが可能です</a>（サービスワーカーを利用する場合）。</p>
<p>問題は、全てのアセットをBrotliの高いレベルで圧縮するのはコストが大きく、膨大なオーバーヘッドコストを生み出すため、多くのホスティングプロバイダがBrotliを全面的に使用できないことです。
実際、最高の圧縮レベルでは、Brotliはとても遅くなります。
その結果、ファイル容量を削減できるとしても、サーバが応答を送信し始めるまでにかかる時間によって相殺される可能性があります。
これはサーバが、アセットが動的に圧縮されるのを待つ必要があるためです。
（ただし、ビルドタイムにおいて静的圧縮を行う時間があるなら、当然ながら、<a href="https://css-tricks.com/brotli-static-compression/">圧縮率を高く設定するほうが望ましい</a>でしょう）。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/b62dce07-c24b-443a-8722-e55d8981cfea/new-brotli-compression-opt.png">
<em>さまざまな圧縮手法のバックエンドタイムの比較。驚くことではありませんが、<a href="https://css-tricks.com/brotli-static-compression/">Brotliは（今のところ）gzipよりも低速です</a>。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/b62dce07-c24b-443a-8722-e55d8981cfea/new-brotli-compression-opt.png">プレビューを拡大</a>）</em></p>
<p>しかし、このような状況は変わりつつあるのかもしれません。
Brotliファイル形式には<strong>ビルトインの静的ディクショナリ</strong>が組み込まれています。
複数の言語のさまざまな文字列に加え、これらの文字列に複数の変換を適用するという選択肢もサポートしており、汎用性が高くなっています。
Felix Hanauは、調査によって、
<a href="https://blog.cloudflare.com/brotli-compression-using-a-reduced-dictionary/">レベル5～9でコンテンツを圧縮した場合のパフォーマンスを改善する方法</a>を発見しました。
その方法とは、「デフォルトと比べて絞り込まれたディクショナリのサブセット」を使用し、
<code class="language-text">Content-Type</code>ヘッダを通じて、コンプレッサがHTML、JavaScript、CSSのどのディクショナリを使うべきかを指定することです。
その結果、「Webコンテンツを高いレベルで圧縮する場合でも、限られたディクショナリを使用するアプローチによって、パフォーマンスへの影響をごくわずか（CPUへの影響は通常の12％に対して1～3％）とすることができました」。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9e04e215-b689-4816-9c67-0674767d12fa/compression-gain-brotli-level5.png">
<em>改善後のディクショナリアプローチによって、<a href="https://blog.cloudflare.com/brotli-compression-using-a-reduced-dictionary/">CPU使用時間の増加をわずか1～3％に抑えつつ</a>、アセットを高い圧縮率で高速に圧縮できます。通常、圧縮レベルが5から6になると、CPU使用時間は最大で12％増加します。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9e04e215-b689-4816-9c67-0674767d12fa/compression-gain-brotli-level5.png">プレビューを拡大</a>）</em></p>
<p>さらに、<a href="https://dev.to/riknelix/fast-and-efficient-recompression-using-previous-compression-artifacts-47g5">Elena Kirilenkoの調査によれば</a>、
過去の圧縮アーティファクトを使用することで、高速で<strong>効率的なBrotli再圧縮</strong>を実現できます。
Elenaによると、「Brotliでアセットを圧縮した後、動的なコンテンツをオンザフライで圧縮しようとする場合において、
コンテンツが事前に利用可能なコンテンツと類似しているときは、圧縮時間を大幅に短縮できます」。</p>
<p>このようなケースはどれほどあるのでしょうか。
例えば、＊＊を配信するケース（コードの一部がすでにクライアント側でキャッシュされている場合や、
<a href="https://docs.google.com/document/d/11t4Ix2bvF1_ZCV9HKfafGfWu82zbOD7aUhZ_FyDAgmA/edit">WebBundles</a>で動的なバンドルを提供する場合など）が考えられます。
あるいは、事前に分かっているテンプレートに基づく動的なHTMLや、<strong>WOFF2フォントの動的なサブセット</strong>を使用する場合もあります。
Elenaによれば、コンテンツを10％削減すると、<a href="https://dev.to/riknelix/fast-and-efficient-recompression-using-previous-compression-artifacts-47g5">圧縮率が5.3％</a>、
圧縮速度が39％改善します。コンテンツを50％削減した場合、さらに圧縮率が3.2％、圧縮速度が26％改善します。</p>
<p>Brotli圧縮の品質は向上しています。そのため、静的アセットを動的に圧縮するコストを回避できるなら、間違いなく労力を費やすに値するでしょう。
もちろん、Brotliは、HTML、CSS、SVG、JavaScript、JSONなど、あらゆるプレーンテキストのペイロードに使用できます。</p>
<p>注記：2021年初めの時点で、<a href="https://almanac.httparchive.org/en/2020/compression#current-state-of-http-compression">HTTP応答の約60％はテキストベースの圧縮をすることなく配信されており</a>、
30.82％はgzip、9.1％はBrotliで圧縮されています（いずれもモバイルとデスクトップ）。
例えば、<a href="https://twitter.com/hdjirdeh/status/1280731085379211265">Angularページの23.4％は（gzipやBrotliによって）圧縮されていません</a>。
それでも、圧縮は、スイッチをオンにするように、とても簡単にパフォーマンスを改善する手段となることがよくあります。</p>
<p><strong>圧縮の戦略はどうすべきでしょうか</strong>。<a href="https://css-tricks.com/brotli-static-compression/">Brotliとgzipの最高レベルで静的アセットを事前に圧縮</a>し、
Brotliのレベル4～6で（動的）HTMLをオンザフライで圧縮しましょう。
サーバがBrotliやgzipのためのコンテンツネゴシエーションを適切に処理できるようにしてください。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/82c6a7d0-7d2d-4ed8-87c4-ed6dae698aa3/compression-algorithms-for-http-requests.png">
<em>2020年に圧縮された状態で提供されたリソースのうち、22.59％はBrotliで圧縮されています。約77.39％はgzipで圧縮されています。（画像の出典：<a href="https://almanac.httparchive.org/en/2020/compression">Web Almanac: Compression</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/82c6a7d0-7d2d-4ed8-87c4-ed6dae698aa3/compression-algorithms-for-http-requests.png">プレビューを拡大</a>）</em></p>
<h3>21. アダプティブなメディア読み込みとクライアントヒントを使用するか？</h3>
<p>昔から言われていることですが、
<code class="language-text">srcset</code>、<code class="language-text">sizes</code>、<code class="language-text">&lt;picture&gt;</code>要素によって<a href="https://www.smashingmagazine.com/2014/05/responsive-images-done-right-guide-picture-srcset/">レスポンシブな画像</a>を使用することは、
いつも忘れないようにしてください。
特にメディアのフットプリントが大きいサイトの場合、
<a href="https://glitch.com/~next-episode-adaptive-loading">アダプティブなメディア読み込み</a>（この例ではReactとNext.js）によって一歩踏み込んだ対策を取ることができます。
これは、<strong>ネットワークが遅くメモリが小さい端末にはコストが軽いユーザ体験</strong>を、ネットワークが高速でメモリが大きい端末には完全なユーザ体験を提供するものです。
Reactの場合、サーバ側のクライアントヒントや、クライアント側の<a href="https://github.com/GoogleChromeLabs/react-adaptive-hooks">react-adaptive-hooks</a>によって実現できます。</p>
<p>レスポンシブ画像の未来は、<a href="https://cloudfour.com/thinks/responsive-images-201-client-hints/">クライアントヒント</a>の導入が拡大することで劇的に変化するかもしれません。
クライアントヒントはHTTPリクエストのヘッダフィールドで、例えば<code class="language-text">DPR</code>、<code class="language-text">Viewport-Width</code>、<code class="language-text">Width</code>、<code class="language-text">Save-Data</code>、<code class="language-text">Accept</code>（画像の形式の設定を指定する場合）などがあります。
これらは、ユーザのブラウザ、画面、接続などの詳細をサーバに伝達することとなっています。</p>
<p>これらの情報を踏まえ、サーバは<strong>適切なサイズの画像</strong>によってレイアウトを埋める方法を決定し、画像を望ましい形式でのみ提供できます。
クライアントヒントによって、一連のリソースは、HTMLマークアップから、クライアントとサーバ間のリクエストと応答のネゴシエーションへ移行されます。</p>
<p><img src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/08a226c5-5a9a-4bd2-bba7-dad7e74f69e9/adaptive-media-serving-opt.png">
<em>実際のアダプティブなメディア提供。オフラインのユーザにはテキスト付きのプレースホルダ、2Gのユーザには低解像度の画像、3Gのユーザには高解像度の画像、4GのユーザにはHD動画を送信します。「<a href="https://dev.to/addyosmani/loading-web-pages-fast-on-a-20-feature-phone-8h6">Loading Web Pages Fast On A $20 Feature Phone</a>」より。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/08a226c5-5a9a-4bd2-bba7-dad7e74f69e9/adaptive-media-serving-opt.png">プレビューを拡大</a>）</em></p>
<p>Ilya Grigorikが少し前の<a href="https://developers.google.com/web/updates/2015/09/automating-resource-selection-with-client-hints">記事</a>で述べているとおり、
クライアントヒントは穴を埋める役割を果たすものであって、レスポンシブな画像に代わるものではありません。
「<code class="language-text">&lt;picture&gt;</code>要素は、HTMLマークアップにおいて必要な『演出』のコントロールを実現します。クライアントヒントは、出力される画像リクエストに注釈を付与し、リソース選択の自動化を可能にします。サービスワーカーは、クライアント側の完全なリクエスト・応答管理機能を提供します」。</p>
<p>サービスワーカーは、例えば、<strong>新たなクライアントヒントのヘッダ値をリクエストに追加する</strong>、
URLを上書きしてCDNに画像リクエストを送信する、接続性とユーザ設定に基づいて応答を調整するなどが可能です。
これは画像アセットだけではなく、それ以外のほとんどのリクエストにも当てはまります。</p>
<p>クライアントヒントをサポートするクライアントでは、<a href="https://twitter.com/igrigorik/status/1032657105998700544">画像のバイト数を42％削減</a>し、
上位3割弱のケースでは1MB超のバイト数を削減できました。Smashing Magazineでも<a href="https://www.smashingmagazine.com/2016/01/leaner-responsive-images-client-hints/">19～32％の改善</a>を記録しました。
クライアントヒントは<a href="https://caniuse.com/#search=client-hints">Chromiumベースのブラウザでサポート</a>されていますが、
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=935216">Firefox</a>でのサポートも検討中です。</p>
<p>ただし、通常のレスポンシブ画像マークアップと、クライアントヒント向けの<code class="language-text">&lt;meta&gt;</code>タグの両方を提供した場合、
これらをサポートするブラウザは、レスポンシブ画像マークアップを評価し、クライアントヒントのHTTPヘッダを使用して適切な画像ソースをリクエストします。</p>
<h3>22. 背景の画像にレスポンシブ画像を使用するか？</h3>
<p>間違いなく使用すべきです。<a href="https://caniuse.com/css-image-set"><code class="language-text">image-set</code></a>（現在は<a href="https://twitter.com/nomsternom/status/1298998112933916682">Safari 14</a>、
および<a href="https://caniuse.com/css-image-set">Firefox以外のほとんどのモダンなブラウザでサポート</a>されています）を使用すれば、レスポンシブな背景画像を提供できます。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">"fallback.jpg"</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
<span class="token property">background-image</span><span class="token punctuation">:</span>
  <span class="token function">image-set</span><span class="token punctuation">(</span> <span class="token string">"photo-small.jpg"</span> 1x<span class="token punctuation">,</span>
   <span class="token string">"photo-large.jpg"</span> 2x<span class="token punctuation">,</span>
   <span class="token string">"photo-print.jpg"</span> 600dpi<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>基本的に、背景画像は条件付きで提供することができ、<code class="language-text">1x</code>記述子では低解像度、<code class="language-text">2x</code>記述子では高解像度、<code class="language-text">600dpi</code>記述子では印刷物と同等の品質さえ実現可能です。
ただし、ブラウザは背景画像に関する特別な情報をアシスティブテクノロジー（支援技術）ツールに提供しないので、こうした写真は単なる装飾とするのが理想です。</p>
<h3>23. WebPを使用するか？</h3>
<p>画像の圧縮は、通常は手軽に成果を上げる手段と考えられていますが、それでも実際はまだまだ利用されていません。
もちろん、画像はレンダリングをブロックしませんが、LCPのスコアが低くなる大きな要因の1つです。
画像を表示する端末にとって、画像のコストや容量が大き過ぎるのは非常によくあることです。</p>
<p>ですから、画像に<a href="https://www.smashingmagazine.com/2015/10/webp-images-and-performance/">WebP形式</a>を使用することは、少なくとも検討に値するでしょう。
実際、2020年にAppleが<a href="https://developer.apple.com/documentation/safari-release-notes/safari-14-release-notes">Safari 14にWebPのサポートを追加</a>したことで、
WebPの物語はゴールを迎えつつあります。
長年にわたる議論を経て、現在、<a href="https://caniuse.com/?search=webp">WebPは全てのモダンなブラウザでサポートされています</a>。
WebP画像は、<code class="language-text">&lt;picture&gt;</code>要素に加えて必要に応じてJPEGフォールバックを使用するか（Andreas Bovensの<a href="https://dev.opera.com/articles/responsive-images/#different-image-types-use-case">コードスニペット</a>を参照）、
あるいはコンテンツネゴシエーションを使用することで（<code class="language-text">Accept</code>ヘッダを使用）提供できます。</p>
<p>しかし、WebPに欠点がないわけではありません。
WebP画像のファイル容量は<a href="https://www.ctrl.blog/entry/webp-vs-guetzli-zopfli">GuetzliやZopfliと同等ですが</a>、
WebPは<a href="https://youtu.be/jTXhYj2aCDU?t=630">JPEGのようなプログレッシブレンダリング機能をサポートしていません</a>。
そのため、WebP画像のほうがネットワーク転送速度は速いとしても、ユーザにとっては、画像が完成するのは昔ながらのJPEGのほうが速く感じられるかもしれません。
JPEGでは、データが半分や4分の1だけでも「まとも」なユーザ体験を提供し、残りは後で読み込むことができます。
一方、WebPの場合は、半分が空白の画像を提供することとなります。</p>
<p>どちらを選ぶべきか、それはあなたが何を求めているかによって変わります。
WebPではペイロードを削減し、JPEGでは体感的なパフォーマンスを改善することが可能です。
WebPについてもっと詳しく知りたい方は、GoogleのPascal Massiminoによる<a href="https://www.youtube.com/watch?v=MBVBfLdh984">WebP Rewind</a>という講演をご覧ください。</p>
<p>WebPへの変換ツールとしては<a href="https://webp-converter.com/">WebP Converter</a>、
<a href="https://developers.google.com/speed/webp/docs/cwebp">cwebp</a>、
<a href="https://downloads.webmproject.org/releases/webp/index.html">libwebp</a>があります。
Ire Aderinokunは<a href="https://bitsofco.de/why-and-how-to-use-webp-images-today/">画像をWebPに変換するためのとても詳細なチュートリアル</a>を公表しています。
Josh Comeauの<a href="https://www.joshwcomeau.com/performance/embracing-modern-image-formats/">Embracing modern image formats</a>という記事も同様の手引きとなっています。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/cd5e6234-7669-4759-ab83-10f8dd0db976/maxresdefault-opt.jpg">
<em>Pascal Massiminoの<a href="https://www.youtube.com/watch?v=MBVBfLdh984">WebP Rewind</a>という講演では、WebPについて徹底的に語っています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/cd5e6234-7669-4759-ab83-10f8dd0db976/maxresdefault-opt.jpg">プレビューを拡大</a>）</em></p>
<p>SketchはネイティブでWebPをサポートしており、WebP画像は<a href="https://telegraphics.com.au/sw/product/WebPFormat#webpformat">WebPのPhotoshop用プラグイン</a>を使用することでPhotoshopからエクスポートできます。
しかし、<a href="https://developers.google.com/speed/webp/docs/using">他の選択肢を利用することも可能です</a>。</p>
<p>WordPressかJoomlaを使用している場合は、WebPのサポートを簡単に導入するのに役立つ拡張機能があります。
例えば、WordPress向けの<a href="https://wordpress.org/plugins/optimus/">Optimus</a>と<a href="https://wordpress.org/plugins/cache-enabler/">Cache Enabler</a>や、
<a href="https://extensions.joomla.org/extension/webp/">Joomlaの自前のサポート拡張機能</a>などです（<a href="https://css-tricks.com/comparing-novel-vs-tried-true-image-formats/">Cody Arsenault</a>の記事より）。
また、<a href="https://www.joshwcomeau.com/performance/embracing-modern-image-formats/">React、styled components、gatsby-image</a>によって<code class="language-text">&lt;picture&gt;</code>要素を抽象化することもできます。</p>
<p>宣伝になってしまい恐縮ですが、Jeremy Wagnerは<a href="https://www.smashingmagazine.com/ebooks/the-webp-manual/">WebPについてのSmashing Book</a>を発行しています。
WebPに関する全てに興味があるなら、チェックしてみると良いかもしれません。</p>
<h3>24. AVIFを使用するか？</h3>
<p>あなたも聞いたことがあるかもしれませんが、<a href="https://jakearchibald.com/2020/avif-has-landed/">AVIFの登場</a>は大ニュースです。
AVIFはAV1動画のキーフレームから派生した新たな画像形式です。
オープンでロイヤルティフリーのフォーマットで、ロスありとロスなしの圧縮、<a href="https://colinbendell.github.io/webperf/animated-gif-decode/">アニメーション</a>、
ロスありのアルファチャンネルをサポートしています。
（JPEGでは問題だった）シャープな線とベタ一色を処理することができ、
<a href="https://netflixtechblog.com/avif-for-next-generation-image-coding-b1d75675fe4">どちらについても他の形式より良い結果を生み出します</a>。</p>
<p>実際、WebPやJPEGと比較すると、<strong>AVIFのパフォーマンスははるかに優れています</strong>。
AVIFでは、DSSIM（人間の視覚を近似したアルゴリズムに基づいて測定した、2つ以上の画像の（非）類似度）を同一に維持しつつ、
<a href="https://www.ctrl.blog/entry/webp-avif-comparison.html">ファイル容量を平均で50％も削減できます</a>。
Malte Ublは、<a href="https://www.industrialempathy.com/posts/image-optimizations/">画像読み込みの最適化</a>に関して徹底的に解説した記事で、
「（AVIFの）パフォーマンスは常に一貫してJPEGを大幅に上回っています。これはWebPとは異なる点です。WebPは、常にJPEGより容量が小さい画像を生成するとは限らず、段階的な読み込みをサポートしていないため、実際は全体でマイナスとなっている可能性があります」と述べています。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/ce9d0632-604b-4e0d-b84e-3eb608644cf0/avif-progressive-enhancement.jpg">
<em>AVIFをプログレッシブエンハンスメントとして使用し、古いブラウザにはWebP、JPEGやPNGを配信できます。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/ce9d0632-604b-4e0d-b84e-3eb608644cf0/avif-progressive-enhancement.jpg">プレビューを拡大</a>）。以下のプレーンテキストビューをご覧ください。</em></p>
<p>皮肉なことに、AVIFのパフォーマンスは<a href="https://jakearchibald.com/2020/avif-has-landed/">大規模なSVGさえ上回っています</a>。
ただし、当然ながら、SVGの代わりとみなすべきではありません。
AVIFはHDRカラーをサポートする初めての画像形式の1つでもあり、明度、色深度、色域が向上しています。
唯一のデメリットは、AVIFは現在、<a href="https://www.ctrl.blog/entry/jpeg-progressive-loading.html">段階的な画像デコード</a>を（今のところは？）サポートしておらず、
Brotliと同様に高い圧縮率でのエンコードが<a href="https://twitter.com/etportis/status/1298320096553705472">現時点では非常に遅い</a>ことです（ただし、デコードは高速です）。</p>
<p>AVIFは<a href="https://caniuse.com/?search=avif">現在、Chrome、Firefox、Operaでサポート</a>されており、Safariでも間もなくサポートされる見込みです（AppleはAV1を開発したグループの一員であるため）。</p>
<p>それでは<strong>現在、画像を提供するための最高の方法</strong>は何なのでしょうか？
イラストとベクター画像については、（圧縮した）SVGが間違いなく最高の選択肢です。
写真については、私たちは<code class="language-text">picture</code>要素によるコンテンツネゴシエーションの手法を使用しています。
AVIFがサポートされていればAVIF画像を送信します。
そうでない場合は、まずはWebPにフォールバックし、WebPもサポートされていない場合は、
フォールバックとしてJPEGかPNGに切り替えます（必要に応じて<code class="language-text">@media</code>の条件を適用します）。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image.avif<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/avif<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image.webp<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Photo<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>350<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ただし、正直に言うと、<code class="language-text">picture</code>要素内の何らかの条件を使用する可能性のほうが高いでしょう。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
  <span class="token attr-name">sizes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(max-width: 608px) 100vw, 608px<span class="token punctuation">"</span></span>
  <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
    /img/Z1s3TKV-1920w.avif 1920w,
    /img/Z1s3TKV-1280w.avif 1280w,
    /img/Z1s3TKV-640w.avif   640w,
    /img/Z1s3TKV-320w.avif   320w<span class="token punctuation">"</span></span>
  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/avif<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
  <span class="token attr-name">sizes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(max-width: 608px) 100vw, 608px<span class="token punctuation">"</span></span>
  <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
    /img/Z1s3TKV-1920w.webp 1920w,
    /img/Z1s3TKV-1280w.webp 1280w,
    /img/Z1s3TKV-640w.webp   640w,
    /img/Z1s3TKV-320w.webp   320w<span class="token punctuation">"</span></span>
  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/webp<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span>
  <span class="token attr-name">sizes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(max-width: 608px) 100vw, 608px<span class="token punctuation">"</span></span>
  <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
    /img/Z1s3TKV-1920w.jpg 1920w,
    /img/Z1s3TKV-1280w.jpg 1280w,
    /img/Z1s3TKV-640w.jpg   640w,
    /img/Z1s3TKV-320w.jpg   320w<span class="token punctuation">"</span></span>
  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/jpeg<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fallback-image.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Photo<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>350<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">prefers-reduced-motion</code>を使用すれば、モーションが少ないほうを好む顧客向けに、
<a href="https://twitter.com/brucel/status/1326154982756929536">アニメーション付きの画像を静止画と交換する</a>こともできます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(prefers-reduced-motion: reduce)<span class="token punctuation">"</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-motion.avif<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/avif<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(prefers-reduced-motion: reduce)<span class="token punctuation">"</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-motion.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/jpeg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>motion.avif<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/avif<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>motion.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Animated AVIF<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ここ数カ月でAVIFは勢いを大きく増しています。</p>
<ul>
<li>DevToolsの<a href="https://twitter.com/addyosmani/status/1327174361942552576">RenderingパネルではWebPとAVIFのフォールバックをテストできます</a>。</li>
<li><a href="https://squoosh.app/">Squoosh</a>、<a href="https://avif.io/">AVIF.io</a>、<a href="https://github.com/AOMediaCodec/libavif">libavif</a>では、AVIFファイルのエンコード、デコード、圧縮、変換が可能です。</li>
<li>Jake Archibaldの<a href="https://github.com/jakearchibald/jakearchibald.com/blob/main/shared/demos/2020/avif-has-landed/DecodedImg/index.tsx">AVIF Preactコンポーネント</a>は、AVIFファイルをワーカー内でデコードし、結果をキャンバスに表示します。</li>
<li>AVIFをサポートするブラウザのみにAVIFを配信するには、<a href="https://github.com/nucliweb/avif-in-css">PostCSSプラグインと315Bのスクリプト</a>を利用して、CSS宣言の中でAVIFを使います。</li>
<li><a href="https://jross.me/progressively-delivering-new-image-formats-with-css-and-cloudflare-workers/">CSSとCloudlare Workersを使用して新たな画像形式を段階的に配信</a>できます。この方法では、<code class="language-text">accept</code>ヘッダから情報を推測することで、返送されたHTMLドキュメントを動的に改変し、<code class="language-text">webp/avif</code>などのクラスを適宜追加することが可能です。</li>
<li>AVIFはすでに<a href="https://twitter.com/etportis/status/1298320096553705472">Cloudinaryで使用できます</a>（利用制限あり）。<a href="https://blog.cloudflare.com/generate-avif-images-with-image-resizing/">CloudflareはImage ResizingでAVIFをサポートしており</a>、<a href="https://reachlightspeed.com/blog/using-the-new-high-performance-avif-image-format-on-the-web-today/">NetlifyではCustom AVIF Headers</a>でAVIFを有効化できます。</li>
<li>アニメーションに関しては、AVIFはSafariの<code class="language-text">&lt;img src=mp4&gt;</code>並みのパフォーマンスを実現可能で、<a href="https://twitter.com/colinbendell/status/1309253099836583942">全体としてはGIFとWebPのパフォーマンスを上回っています</a>が、MP4のほうが依然として高パフォーマンスです。</li>
<li>Chromiumベースのブラウザが<code class="language-text">&lt;img src=mp4&gt;</code>をサポートし続けると想定すると、アニメーションの全体的なパフォーマンスは<a href="https://twitter.com/colinbendell/status/1309255819016523781">AVC1 (h264)＞ HVC1 ＞ WebP ＞ AVIF ＞ GIF</a>となります。</li>
<li>AVIFの詳細については、NetflixのAditya Mavlankarによる<a href="https://www.youtube.com/watch?v=5RX6IgIF8bw&#x26;feature=youtu.be">AVIF for Next Generation Image Coding</a>という講演や、CloudflareのKornel Lesińskiによる<a href="https://www.youtube.com/watch?v=VHm5Ql33JYw">The AVIF Image Format</a>という講演で知ることができます。</li>
<li>AVIFの全てに関する素晴らしいガイドとして、Jake ArchibaldがAVIF has landedという包括的な記事を執筆しています。</li>
</ul>
<p><strong>それでは、未来を担うのはAVIFなのでしょうか</strong>。
Jon Sneyersは、<a href="https://twitter.com/jonsneyers/status/1298993416752074753">そうは考えていません。AVIFのパフォーマンスはJPEG XLを60％下回っています</a>。
<a href="https://cloudinary.com/blog/how_jpeg_xl_compares_to_other_image_codecs">JPEG XL</a>とは、GoogleとCloudinaryが開発した別の無料のオープンフォーマットです。
実際、JPEG XLは全体的にはるかに優れたパフォーマンスをあげているように思われます。
しかし、JPEG XLは依然として標準化の最終段階にとどまっており、どのブラウザでもまだ機能しません。
（昔ながらのInternet Explorer 9の時代から存在するMicrosoftの<a href="https://calendar.perfplanet.com/2018/dont-use-jpeg-xr-on-the-web/">JPEG-XR</a>と混同しないようにしましょう）。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_auto/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/db62c469-bbfc-4959-839d-590abb41b64e/responsive-breakpoints-opt.png">
<em><a href="https://www.responsivebreakpoints.com/">Responsive Image Breakpoints Generator</a>は<strong>画像とマークアップの生成を自動化します</strong>。</em></p>
<h3>25. JPEG/PNG/SVGは適切に最適化されているか？</h3>
<p>ランディングページを開発していて、ヒーロー画像をとにかく高速に読み込むことが必要不可欠である場合、JPEGをプログレッシブにし、
<a href="https://github.com/mozilla/mozjpeg">mozJPEG</a>（スキャンレベルを操作することでレンダリング開始時間を改善する）か<a href="https://github.com/google/guetzli">Guetzli</a>で圧縮するようにしましょう。
Guetzliは、GoogleがZopfliとWebPの教訓を踏まえて開発した、体感的なパフォーマンスに重点を置いたオープンソースのエンコーダです。
<a href="https://medium.com/%40fox/talk-the-state-of-the-web-3e12f8e413b3">唯一の欠点</a>は処理時間が遅いことです（メガピクセル当たりCPU使用時間は1分）。</p>
<p>PNGには<a href="https://css-ig.net/pingo">Pingo</a>、SVGには<a href="https://www.npmjs.com/package/svgo">SVGO</a>やSVGOMGを使用できます。
Webサイトの全てのSVGアセットを素早くプレビューし、コピーかダウンロードをする必要がある場合は、
<a href="https://chrome.google.com/webstore/detail/svg-grabber-get-all-the-s/ndakggdliegnegeclmfgodmgemdokdmg">svg-grabber</a>が役立ちます。</p>
<p>画像最適化に関するあらゆる記事で言われていることですが、ベクターアセットを整理しておくことにも触れなければなりません。
使用しないアセットを一掃し、不必要なメタデータを削除し、アートワーク内（とSVGコード）のパスポイントの数を減らしましょう（Jeremyに感謝します）。</p>
<p>他にも便利なオンラインツールを利用できます。</p>
<ul>
<li><a href="https://squoosh.app/">Squoosh</a>は、（ロスありかロスなしの）最適な圧縮レベルで、画像を圧縮、サイズ変更、操作することができます。</li>
<li><a href="https://www.guetzli.it/">Guetzli.it</a>は、GuetzliでJPEG画像を圧縮・最適化するのに使えます。輪郭がシャープな画像や、ベタ一色の画像に有効です（ただし、かなり<a href="https://www.pixelz.com/blog/guetzli-mozjpeg-comparison/">低速</a>な可能性があります）。</li>
<li><a href="https://www.responsivebreakpoints.com/">Responsive Image Breakpoints Generator</a>や、<a href="https://cloudinary.com/documentation/api_and_access_identifiers">Cloudinary</a>、<a href="https://www.imgix.com/">Imgix</a>などのサービスを使えば、画像の最適化を自動化することができます。また、多くの場合は<code class="language-text">srcset</code>と<code class="language-text">sizes</code>を使うだけでも大きな効果が得られます。</li>
<li>レスポンシブマークアップの効率性のチェックには、<a href="https://github.com/filamentgroup/imaging-heap">imaging-heap</a>を使用できます。これはさまざまなビューポートのサイズや端末のピクセル比率について、効率性を測定することが可能なコマンドラインツールです。</li>
<li>画像が圧縮されていない状態で本番環境に導入されないように、<a href="https://github.com/marketplace/actions/image-actions">GitHubワークフローに自動的な画像圧縮を追加することも可能です</a>。このアクションはPNGとJPGに対応したmozjpegとlibvipsを使用します。</li>
<li>内部でのストレージの最適化には、Dropboxが開発した新たな<a href="https://github.com/dropbox/lepton">Lepton形式</a>を使用できるかもしれません。LeptonはJPEGを平均22％の割合でロスレス圧縮するものです。</li>
<li>プレースホルダ画像を早く表示したい場合は、<a href="https://blurha.sh/">BlurHash</a>を使用しましょう。BlurHashは画像を取り込み、その画像のプレースホルダとなる短い文字列（わずか20～30字）を提供します。文字列は十分に短いため、JSONオブジェクトにフィールドとして簡単に追加できます。</li>
</ul>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/1fbe4611-cbf9-4c7e-819d-1236eb2053ce/whyblurhash.png">
<em><a href="https://blurha.sh/">BlurHash</a>は、画像のプレースホルダを小さくコンパクトに表示します。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/1fbe4611-cbf9-4c7e-819d-1236eb2053ce/whyblurhash.png">プレビューを拡大</a>）</em></p>
<p>ときには、画像の最適化だけではうまくいかないこともあります。
<a href="https://calendar.perfplanet.com/2019/the-ugly-truth-about-optimising-beautiful-images/">クリティカルな画像のレンダリング</a>開始までに必要な時間を短縮するには、
あまり重要でない画像の<strong>読み込みを遅らせ</strong>、スクリプトの読み込みはクリティカルな画像のレンダリング後まで先送りしましょう。
最も安全な方法は、ネイティブな遅延読み込みと<a href="https://github.com/verlok/lazyload">lazyload</a>を併用する
<a href="https://www.smashingmagazine.com/2019/05/hybrid-lazy-loading-progressive-migration-native/">ハイブリッド遅延読み込み</a>です。
lazyloadは、IntersectionObserverを使用して、ユーザインタラクションによって発生したあらゆる表示の変化を検知するライブラリです（IntersectionObserverについては後ほど詳しく説明します）。
さらに、以下のような手法もあります。</p>
<ul>
<li><a href="https://twitter.com/glenngabe/status/1292801991715033091">クリティカルな画像を先読み</a>して、
ブラウザによる画像の発見が遅くなり過ぎないようにできないか検討してみましょう。
背景画像については、もっと積極的な最適化を目指すのであれば、<code class="language-text">&lt;img src&gt;</code>で通常の画像として追加した後に画面から隠すという方法もあります。</li>
<li>メディアクエリに応じて、画像を表示する際に異なる寸法を指定し、<a href="https://www.filamentgroup.com/lab/sizes-swap/">sizes属性を利用して画像を切り替える</a>ことを検討しましょう。
これにより、例えばsizesを操作して、ルーペコンポーネントのソースを切り替えられるようになります。</li>
<li><a href="https://csswizardry.com/2018/06/image-inconsistencies-how-and-when-browsers-download-images/">画像のダウンロードが一貫しているか</a>をチェックし、
前景や背景の画像の予期しないダウンロードを防ぎましょう。
注意すべきなのは、カルーセル、アコーディオン、画像ギャラリーなど、デフォルトで読み込まれるが、まったく表示されない可能性がある画像です。</li>
<li>画像には<a href="https://www.smashingmagazine.com/2020/03/setting-height-width-images-important-again/">必ず<code class="language-text">width</code>と<code class="language-text">height</code>を設定してください</a>。
<a href="https://drafts.csswg.org/css-sizing-4/#ratios">CSSの<code class="language-text">aspect-ratio</code>プロパティ</a>と<a href="https://github.com/ojanvafai/intrinsicsize-attribute"><code class="language-text">intrinsicsize属性</code></a>に注意しましょう。
これにより、画像のアスペクト比と寸法を設定することで、ブラウザが所定のレイアウト枠を早いうちに確保し、
ページ読み込み中の<a href="https://24ways.org/2018/jank-free-image-loads/">レイアウトのジャンプを回避</a>できます。</li>
</ul>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/ebcc7dad-3cbc-4595-b141-2c6c80ab8fc6/aspect-ratio-in-browsers.png">
おそらく今後わずか数週間か数カ月で、各ブラウザはaspect-ratioに対応するようになるでしょう。<a href="https://twitter.com/jensimmons/status/1347287421633892356">Safari Technical Preview 118</a>にはすでに搭載されており、<a href="https://caniuse.com/mdn-css_properties_aspect-ratio">FirefoxとChromeにもflags（試験運用機能）として実装されています。</a>（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/ebcc7dad-3cbc-4595-b141-2c6c80ab8fc6/aspect-ratio-in-browsers.png">プレビューを拡大</a>）</p>
<p>思い切って<a href="https://youtu.be/jTXhYj2aCDU?t=854">エッジワーカー</a>を使用し、HTTP/2ストリームを分割・再編することで、ネットワークを通じた画像の送信を高速化することもできます。
エッジワーカーとは、簡単に言えば、CDN上で実行されるリアルタイムフィルタです。
エッジワーカーは、コントロール可能なチャンクを利用したJavaScriptストリームを使用しているため（これらは基本的に、ストリーミングの応答を変更できるCDNエッジ上で実行されるJavaScriptです）、
画像の配信をコントロールすることが可能です。</p>
<p>サービスワーカーでは通信中の内容をコントロールできないため、上記の仕組みでは間に合いませんが、エッジワーカーでは機能します。
そのため、特定のランディングページ向けに段階的に保存された静的JPEGとともに使用できます。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/8422076c-6eea-4b35-a98c-b15445cb2dff/viewport-percentage-match.jpg">
<a href="https://github.com/filamentgroup/imaging-heap">imaging-heap</a>のサンプル出力。imaging-heapは、さまざまなビューポートのサイズや端末のピクセル比率について、効率性を測定することが可能なコマンドラインツールです。（<a href="https://pbs.twimg.com/media/DY1XZ28VwAAwjd8.jpg">画像の出典</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/8422076c-6eea-4b35-a98c-b15445cb2dff/viewport-percentage-match.jpg">プレビューを拡大</a>）</p>
<p>まだ最適化が足りない場合は、<a href="https://jmperezperez.com/medium-image-progressive-loading-placeholder/">背景画像に関する複数のテクニック</a>によっても画像の体感的なパフォーマンスを改善できます。
<a href="https://css-tricks.com/contrast-swap-technique-improved-image-performance-css-filters/">コントラストを調整</a>し、
不必要な細部をぼかす（または色を削除する）ことで、ファイルの容量を縮小できることも忘れないでください。
品質を低下させることなく、<strong>小さい写真を拡大する</strong>必要がある場合は、<a href="https://letsenhance.io/">Letsenhance.io</a>の使用を検討しましょう。</p>
<p>これまでの最適化は基本をカバーしているに過ぎません。
Addy Osmaniは、<a href="https://images.guide/">重要な画像の最適化に関するとても詳細なガイド</a>を公表しています。
このガイドでは、画像の圧縮とカラーマネジメントについて非常に深く解説しています。
例えば、（ガウスぼかしフィルタを適用して）画像の<strong>不要な部分をぼかす</strong>ことでファイル容量を削減できます。
最終的には、色を削除したり、写真を白黒にしたりすることで、容量をさらに削減することも可能です。
背景画像については、Photoshopから0～10％の品質で写真を書き出せば、完全に許容できるレベルになります。</p>
<p>Smashing Magazineでは、画像名の末尾に<code class="language-text">-opt</code>をつけるようにしています（例えば<code class="language-text">brotli-compression-opt.png</code>）。
画像にこの接尾辞が付いていれば、チームの誰もが、その画像がすでに最適化されていることが分かります。</p>
<p>それと、<a href="https://calendar.perfplanet.com/2018/dont-use-jpeg-xr-on-the-web/">JPEG-XRをWebで使用しないようにしましょう</a>。
「仮にバイト容量の削減によるプラスの影響が生じていたとしても、CPU上のJPEG-XRソフトウエア側のデコード処理は、特にSPAの場合、プラスの影響を相殺するか、あるいは上回ってしまいます」
（CloudinaryとGoogleの<a href="https://cloudinary.com/blog/how_jpeg_xl_compares_to_other_image_codecs">JPEG XL</a>と混同しないようにしてください）。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/c987b182-0a0e-40e5-8f8d-dd81feb991f5/replace-animated-gifs.jpg">
Addy Osmaniは、アニメーション付きのGIFを、ループ再生されるインライン動画で代替することを<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/replace-animated-gifs-with-video/">推奨しています</a>。両者のファイル容量には大きな差があります（80％の削減）。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/c987b182-0a0e-40e5-8f8d-dd81feb991f5/replace-animated-gifs.jpg">プレビューを拡大</a>）</p>
<h3>26. 動画は適切に最適化されているか？</h3>
<p>これまでは画像について扱ってきましたが、昔ながらのGIFに関する議論は避けてきました。
私たちはGIFを愛していますが、もはやGIFは（少なくともWebサイトやアプリケーションからは）永久に追放すべきです。
アニメーション付きの重いGIFを読み込むと、レンダリングのパフォーマンスと帯域幅の両方に影響を与えます。
アニメーション付きのWebPに切り替える（GIFをフォールバックとする）か、
<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/replace-animated-gifs-with-video/">ループ再生されるHTML5動画</a>とGIFを完全に入れ替えると良いでしょう。</p>
<p>画像とは異なり、ブラウザは<code class="language-text">&lt;video&gt;</code>コンテンツを先読みしません。
しかし、HTML5動画は通常、GIFよりもはるかに軽く、容量も小さくなります。
HTML5動画が選択肢に入らない場合は、<a href="https://kornel.ski/lossygif">Lossy GIF</a>、
<a href="https://github.com/kohler/gifsicle">gifsicle</a>あるいは<a href="https://github.com/pornel/giflossy">giflossy</a>を使用すれば、
少なくともGIFをロスありで圧縮することができます。</p>
<p>Colin Bendellのテストによれば、Safari Technology Previewにおける<code class="language-text">img</code>タグ内のインライン動画は、
同等のGIFに比べて<a href="https://calendar.perfplanet.com/2017/animated-gif-without-the-gif/">20倍以上速く表示され、7倍以上速くデコード</a>されます。
さらに、ファイルの容量もGIFに比べてごくわずかです。ただし、他のブラウザではサポートされていません。</p>
<p>うれしいことに、動画の形式は、長年の間に<strong>とても大きな進歩</strong>を遂げてきました。
長い間、私たちはWebMが支配的な形式になることを望んでいました。
そして、WebP（本質的にはWebM動画コンテナ内部の静止画の1つ）は時代遅れの画像形式に代わる存在になろうとしています。
実際、Safariは現在、<a href="https://twitter.com/jensimmons/status/1275171897244823553">WebPをサポートしています</a>。
しかし、最近は<a href="https://caniuse.com/webp">WebP</a>と<a href="https://caniuse.com/#feat=webm">WebM</a>のサポートが増えてきたにもかかわらず、真のブレークスルーは起きていませんでした。</p>
<p>それでも、WebMはほとんどのモダンなブラウザで使用することができました。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- By Houssein Djirdeh. https://web.dev/replace-gifs-with-videos/ --></span>
<span class="token comment">&lt;!-- A common scenartio: MP4 with a WEBM fallback. --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">autoplay</span> <span class="token attr-name">loop</span> <span class="token attr-name">muted</span> <span class="token attr-name">playsinline</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>my-animation.webm<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/webm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>my-animation.mp4<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/mp4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>しかし、もしかすると、状況は完全に変わるかもしれません。
2018年、Alliance of Open Mediaは、<a href="https://aomedia.org/av1/">AV1</a>という新しい有力な動画形式を発表しました。
AV1はH.265コーデック（H.264の進化版）と同様の圧縮を実現しますが、H.265とは違って無料です。
ブラウザベンダは、H.265ライセンスの価格設定を受けて、同等のパフォーマンスを有するAV1を代わりに採用しました。
<strong>AV1は（H.265と同様に）WebMの2倍の圧縮性能を持っています</strong>。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/b5a4354f-4a9b-420d-8979-bd7abb87aebc/av1-logo-2018-full.png">
AV1はWeb上の動画の最終的なスタンダードになる可能性が十分にあります。（画像の出典：<a href="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/AV1_logo_2018.svg/2560px-AV1_logo_2018.svg.png">Wikimedia.org</a>）（プレビューを拡大）</p>
<p>実際、Appleは現在、HEIF形式とHEVC（H.265）を使用しており、最新のiOSでは全ての写真と動画をJPEGではなくHEIFとHEVCで保存しています。
<a href="https://caniuse.com/#search=heif">HEIF</a>と<a href="https://caniuse.com/#search=hevc">HEVC（H.265）</a>は、（今のところは？）Webにあまり普及していませんが、AV1はそうではありません。
さらに、<a href="https://caniuse.com/#feat=av1">AV1をサポートするブラウザは増えています</a>。全てのブラウザベンダがAV1に対応するとみられるため、<code class="language-text">&lt;video&gt;</code>タグに<code class="language-text">AV1</code>ソースを追加するのは理にかなっています。</p>
<p>今のところ、最も広く使用・サポートされているエンコード形式はH.264で、MP4ファイル形式で提供されています。
ですから、ファイルを提供する前に、MP4が<a href="https://medium.com/%40borisschapira/optimize-your-mp4-video-for-better-performance-dareboost-blog-fb2f3f3dce77">マルチパスエンコード</a>で処理されていること、
frei0r iirblur effectによるぼかしが行われていること（該当する場合）、moov atomメタデータがファイルの先頭に移動していること、
サーバが<a href="https://medium.com/%40borisschapira/optimize-your-mp4-video-for-better-performance-dareboost-blog-fb2f3f3dce77">バイトサービングを許可していること</a>を確認しましょう。
Boris Schapiraは、動画を最大限まで最適化するための<a href="https://medium.com/%40borisschapira/optimize-your-mp4-video-for-better-performance-dareboost-blog-fb2f3f3dce77">FFmpegの正確な手引き</a>を提供しています。
もちろん、WebM形式を代わりとして提供するのも良いでしょう。</p>
<p>動画のレンダリングの高速化を始める必要があるが、
<strong>動画ファイルの容量が依然として大き過ぎる</strong>場合はどうすべきでしょうか。
例えば、ランディングページに大容量の背景動画がある場合などです。
よくあるテクニックは、まずは1番目のフレームを静止画として表示するか、
または大幅に最適化した短いループのセグメント（動画の一部に見える）を表示し、
次に動画のバッファが十分にたまったら実際の動画を再生するというものです。
Doug Sillarsが執筆した<a href="https://calendar.perfplanet.com/2019/performance-tips-for-background-video/">背景動画のパフォーマンスに関する詳しいガイド</a>は、
このようなケースで役立つかもしれません。（<a href="https://twitter.com/guypod">Guy Podjarny</a>に感謝します）。</p>
<p>上記のシナリオでは、<strong>レスポンシブなポスター画像</strong>を提供したい場合もあるかもしれません。
デフォルトでは、<code class="language-text">video</code>要素は1つの画像のみをポスターとして受け入れますが、それが必ずしも最適とは限りません。
このような場合は<a href="https://nigelotoole.github.io/responsive-video-poster/">Responsive Video Poster</a>が役立ちます。
このJavaScriptライブラリは、画面ごとに異なるポスター画像を使用することを可能にする一方、トランジションオーバーレイを追加することや、
動画のプレースホルダのスタイルを完全にコントロールすることもできます。</p>
<p>調査によれば、<a href="https://www.akamai.com/ja/newsroom/press-release/quality-of-ott-video-streaming-experiences-directly-tied-to-viewer-loyalty-service-provider-success">動画のストリームの品質は視聴者の行動に影響します</a>。
実際、開始の遅れが約2秒を超えると、視聴者は動画から離脱し始めます。
この点を過ぎると、遅延が1秒増えるごとに、離脱率は約5.8％上昇します。
<a href="https://dougsillars.com/2019/09/16/state-of-the-web-video-playback-metrics/">平均的な動画の開始時間が12.8秒</a>で、
40％の動画が1回以上停止し、20％の動画の再生が2秒以上停止することは驚きではありません。
実際、動画はネットワークがコンテンツを供給するよりも速く再生されるため、3Gでは動画が停止することは避けられません。</p>
<p>それでは、どうすれば解決できるのでしょうか。
通常、小型画面の端末は、デスクトップに提供される720pや1080pの解像度に対応できません。
<a href="https://dougsillars.com/2020/03/03/video-playback-on-mobile-devices/">Doug Sillars</a>によれば、
小さいバージョンの動画を作成することや、JavaScriptを使用して小型画面向けのソースを検知することによって、
こうした端末でも確実に<strong>高速でスムーズな再生</strong>を実現できます。
別の選択肢として、ストリーミング動画を使用することも可能です。
HLS動画ストリームは、適切なサイズの動画を端末に配信し、画面ごとに異なる動画を作成する必要がなくなります。
また、ネットワーク速度をネゴシエートし、使用しているネットワークの速度に合わせて動画のビットレートを調整します。</p>
<p>帯域幅のムダを回避するには、動画を実際にしっかりと再生できる端末のみに向けて、動画のソースを追加するという方法があります。
別の方法としては、<code class="language-text">video</code>タグから<code class="language-text">autoplay</code>属性を完全に削除し、JavaScriptを使用して大画面向けに<code class="language-text">autoplay</code>を挿入するという手もあります。
さらに、動画ファイルが実際に必要となるまで、ブラウザがそのファイルをまったくダウンロードしないようにするには、<code class="language-text">video</code>に<code class="language-text">preload=&quot;none&quot;</code>を追加しなければなりません。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Based on Doug Sillars's post. https://dougsillars.com/2020/01/06/hiding-videos-on-the-mbile-web/ --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hero-video<span class="token punctuation">"</span></span>
          <span class="token attr-name">preload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span>
          <span class="token attr-name">playsinline</span>
          <span class="token attr-name">muted</span>
          <span class="token attr-name">loop</span>
          <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1920<span class="token punctuation">"</span></span>
          <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1080<span class="token punctuation">"</span></span>
          <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>poster.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video.webm<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/webm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video.mp4<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/mp4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>それから、<a href="https://evilmartians.com/chronicles/better-web-video-with-av1-codec">AV1を実際にサポートしているブラウザに狙いを絞る</a>ことができます。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token comment">&lt;!-- Based on Doug Sillars's post. https://dougsillars.com/2020/01/06/hiding-videos-on-the-mbile-web/ --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hero-video<span class="token punctuation">"</span></span>
          <span class="token attr-name">preload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span>
          <span class="token attr-name">playsinline</span>
          <span class="token attr-name">muted</span>
          <span class="token attr-name">loop</span>
          <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1920<span class="token punctuation">"</span></span>
          <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1080<span class="token punctuation">"</span></span>
          <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>poster.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video.av1.mp4<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/mp4; codecs=av01.0.05M.08<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video.hevc.mp4<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/mp4; codecs=hevc<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video.webm<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/webm<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video.mp4<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video/mp4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>そのうえ、特定の基準値（1000pxなど）を超える場合は、<code class="language-text">autoplay</code>を再び追加することも可能です。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html">/* By Doug Sillars. https://dougsillars.com/2020/01/06/hiding-videos-on-the-mbile-web/ */
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    window<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token function">addAutoplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> videoLocation  <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"hero-video"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">addAutoplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            videoLocation<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"autoplay"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/952ad18f-bf8e-433e-a02d-1040d3aada55/new-stall-time-opt.png">
<em>端末とネットワーク速度ごとの動画の停止回数。高速なネットワークに接続している高速な端末は、ほとんど停止していません。<a href="https://dougsillars.com/2020/03/03/video-playback-on-mobile-devices/">Doug Sillars</a>の調査より。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/952ad18f-bf8e-433e-a02d-1040d3aada55/new-stall-time-opt.png">プレビューを拡大</a>）</em></p>
<p>動画再生のパフォーマンスは1つの<a href="https://dougsillars.com/2019/09/16/state-of-the-web-video-playback-metrics/">独立した大きなテーマ</a>です。
詳しく知りたい場合は、Doug Sillarsの<a href="https://www.smashingmagazine.com/2018/10/video-playback-on-the-web-part-1/">The Current State of Video</a>と
<a href="https://www.smashingmagazine.com/2018/10/video-playback-on-the-web-part-2/">Video Delivery Best Practices</a>という別のシリーズ記事をご覧ください。
これらの記事では、動画配信の指標、動画の先読み、圧縮、ストリーミングについて詳しく扱っています。
最後に、<a href="https://dougsillars.github.io/StreamOrNot/">Stream or Not</a>では自社サイトの動画ストリーミングがどれだけ速いか（あるいは遅いか）を確認することが可能です。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/eb634666-55ab-4db3-aa40-4b146a859041/font-loading-strategies-opt.png">
<em><a href="https://www.zachleat.com/web/comprehensive-webfonts/">Zach LeathermanのComprehensive Guide to Font-Loading Strategies</a>は、Webフォントの配信を改善するための数多くの選択肢を紹介しています。</em></p>
<h3>27. Webフォントの配信は最適化されているか？</h3>
<p>最初に問うべき疑問は、そもそも<a href="https://www.smashingmagazine.com/2015/11/using-system-ui-fonts-practical-guide/">UIシステムフォントを使用すれば良い</a>のではないか、ということです。
UIシステムフォントなら、さまざまなプラットフォームで<a href="http://fontfamily.io/Roboto,Segoe_UI,TImes,Helvetica,sans-serif">正確に表示されることをダブルチェック</a>するだけで済みます。
UIシステムフォントを使用できない場合、あなたが使用するWebフォントには、使われていないグリフや追加的な機能・太さが含まれている可能性が高いでしょう。
フォント開発会社に依頼すれば、<strong>Webフォントをサブセット化する</strong>ことが可能です。
オープンソースのフォントを使用する場合であれば、<a href="https://www.afasterweb.com/2018/03/09/subsetting-fonts-with-glyphhanger/">Glyphhanger</a>や
<a href="https://www.fontsquirrel.com/tools/webfont-generator">Fontsquirrel</a>を使えば自分でサブセット化できます。
Peter Müllerの<a href="https://github.com/Munter/subfont#readme">subfont</a>では、ワークフロー全体を自動化することさえ可能です。
このコマンドラインツールは、ページを静的に分析することで、Webフォントの最適なサブセットを生成し、ページに挿入します。</p>
<p><a href="https://caniuse.com/#search=woff2">WOFF2のサポート</a>はとても有用です。
ブラウザがWOFF2をサポートしていない場合は、WOFFをフォールバックとして使用できます。
あるいは、古いブラウザにはシステムフォントを提供しても良いでしょう。
Webフォント読み込みの選択肢は本当に数多く存在しており、
<a href="https://www.zachleat.com/web/comprehensive-webfonts/">Zach LeathermanのComprehensive Guide to Font-Loading Strategies</a>という記事ではそういった戦略の1つを選ぶことができます
（<a href="https://github.com/zachleat/web-font-loading-recipes">Web font loading recipes</a>ではコードのスニペットも提供されています）。</p>
<p>現在、検討に値する選択肢は、<a href="https://www.zachleat.com/web/comprehensive-webfonts/#critical-foft-preload"><code class="language-text">preload</code>によるCritical FOFT</a>と、
<a href="https://www.zachleat.com/web/the-compromise/">「Compromise」法</a>でしょう。
いずれの選択肢も、Webフォントを段階的に配信する<strong>2段階レンダリング</strong>を使用しています。
まず、ページを高速かつ正確にレンダリングするために必要なWebフォントのごく一部を読み込み、次に残りのファミリーを非同期で読み込みます。
両者の違いは、「Compromise」法では、<a href="https://www.igvita.com/2014/01/31/optimizing-web-font-rendering-performance/#font-load-events">フォントの読み込みイベント</a>がサポートされていない場合に限り、
ポリフィルを非同期で読み込むということです。
これにより、ポリフィルをデフォルトで読み込む必要がなくなります。
手軽に成果を上げる必要があるときは、Zach Leathermanの<a href="https://www.zachleat.com/web/23-minutes/">わずか23分でフォントを整理するためのチュートリアルとケーススタディ</a>を参考にしましょう。</p>
<p>一般に、フォントの先読みのために<code class="language-text">preload</code>のリソースヒントを使用するのは良いアイデアでしょう。
ただし、マークアップの中では、クリティカルなCSSとJavaScriptへのリンクの後にヒントを設置するようにしてください。
<code class="language-text">preload</code>を使用すると<a href="https://andydavies.me/blog/2019/02/12/preloading-fonts-and-the-puzzle-of-priorities/">優先順位が複雑になります</a>。
そこで、DOMにおいて、外部のブロッキングスクリプトの直前に<code class="language-text">rel=&quot;preload&quot;</code>要素を挿入することを検討しましょう。
Andy Daviesによれば、「スクリプトを使用して挿入されたリソースは、スクリプトが実行されるまでブラウザからは隠れています。
この挙動を利用して、ブラウザが<code class="language-text">preload</code>ヒントを検知するタイミングを遅らせることができます」。
さもなければ、フォントの読み込みによって初期のレンダリング時間が延びるでしょう。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/5cabdd79-67f0-44f4-9cfa-3b87732938cb/pre-render-fonts-opt.png">
<em>全てが重要だということは、何も重要でないということと同じです。各ファミリーのうち、1つだけ、あるいは最大でも2つのフォントを先読みするようにしましょう。（画像の出典：<a href="https://noti.st/zachleat/KNaZEg/the-five-whys-of-web-font-loading-performance#s6vhQNE">Zach Leatherman</a> – スライド93）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/5cabdd79-67f0-44f4-9cfa-3b87732938cb/pre-render-fonts-opt.png">プレビューを拡大</a>）</em></p>
<p><a href="https://youtu.be/FbguhX3n3Uc?t=1637">対象を絞り込み</a>、最も重要なファイルを選択するのは良いアイデアです。
例えば、レンダリングに必要不可欠なファイルや、目に見える邪魔なテキストのリフローを回避するのに役立つファイルなどです。
一般論として、Zachは<strong>各ファミリーにつき1つか2つのフォントを先読みする</strong>ことを推奨しています。
一部のフォントがあまり重要でない場合は、読み込みを遅らせるのも理にかなっています。</p>
<p><code class="language-text">@font-face</code>規則において<code class="language-text">font-family</code>を定義するときに、<code class="language-text">local()</code>バリュー（ローカルフォントを名前によって参照する）を使用することはとても一般的になりました。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* Warning! Not a good idea! */</span>
<span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">{</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> Open Sans<span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token function">local</span><span class="token punctuation">(</span><span class="token string">'Open Sans Regular'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token function">local</span><span class="token punctuation">(</span><span class="token string">'OpenSans-Regular'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'opensans.woff2'</span><span class="token punctuation">)</span></span> format <span class="token punctuation">(</span><span class="token string">'woff2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'opensans.woff'</span><span class="token punctuation">)</span></span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'woff'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このアイデアは合理的です。
Open Sansなど、一部の有名なオープンソースフォントは、ドライバやアプリケーションによっては事前にインストールされていることもあります。
この場合、フォントがローカル環境で利用できれば、ブラウザはWebフォントをダウンロードする必要がなく、ローカルフォントをすぐに表示できます。
<a href="https://www.bramstein.com/writing/web-font-anti-patterns-local-fonts.html">Bram Steinが指摘しているとおり</a>、
「ローカルフォントとWebフォントの名前が同じであっても、<strong>同じフォントではない</strong>可能性が高いと言えます。
多くのWebフォントは『デスクトップ』版とは異なっています。テキストが異なる形でレンダリングされたり、
一部の文字が別のフォントにフォールバックされたりする可能性があります。
OpenType機能が完全に欠けていることや、行の高さが変わることも考えられます」。</p>
<p>また、書体は時とともに変化するため、ローカル環境にインストールしたバージョンがWebフォントとまったく異なっており、
文字の見た目が大きく変わる可能性もあります。
そのため、Bramは、<code class="language-text">@font-face</code>規則において、<strong>ローカル環境にインストールしたフォントとWebフォントを決して一緒にしない</strong>ことを推奨しています。
Google Fontsでは、RobotoのAndroidリクエストを除き、<a href="https://twitter.com/googlefonts/status/1328761547041148929?lang=en">全てのユーザのCSSの出力結果における<code class="language-text">local()</code>を無効化する</a>ことで、同様の措置を講じています。</p>
<p>コンテンツの表示を待つのが好きな人はいません。
<a href="https://font-display.glitch.me/">CSSの<code class="language-text">font-display</code>記述子</a>を使用すれば、フォント読み込みの挙動をコントロールすることが可能です。
<code class="language-text">font-display: optional</code>なら、コンテンツが即座に読める状態になります。
<code class="language-text">font-display: swap</code>を使用する場合でも、フォントのダウンロードが完了するまで3秒のタイムアウトがあるものの、
ほとんど即座に読むことができます（ただし、<a href="https://font-display.glitch.me/">実際はもう少し複雑です</a>）。</p>
<p>ただし、<a href="https://www.zachleat.com/web/font-display-reflow/">テキストのリフローの影響を最小限に抑えたい</a>場合は、
Font Loading APIが便利です（<a href="https://caniuse.com/font-loading">全てのモダンなブラウザでサポートされています</a>）。
これは、具体的には、あらゆるフォントについて<code class="language-text">FontFace</code>オブジェクトを作成し、
その全てを取得した後にのみ、それらをページに適用することを意味します。
このように、全てのフォントを非同期で読み込み、フォールバックフォントからWebフォントへ一斉に切り替えることによって、<strong>全ての再描画をグループ化します</strong>。
<a href="https://vimeo.com/304099438">Zachの説明</a>（32:15から始まります）と<a href="https://github.com/zachleat/performance-sometime/blob/master/css-font-loading.js">コードのスニペット</a>をご覧ください。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">/* Load two web fonts using JavaScript */</span>
<span class="token comment">/* Zach Leatherman: https://noti.st/zachleat/KNaZEg/the-five-whys-of-web-font-loading-performance#sWkN4u4 */</span>

<span class="token comment">// Remove existing @font-face blocks</span>
<span class="token comment">// Create two</span>
<span class="token keyword">let</span> font <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FontFace</span><span class="token punctuation">(</span><span class="token string">"Noto Serif"</span><span class="token punctuation">,</span> <span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fontBold <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FontFace</span><span class="token punctuation">(</span>"Noto Serif<span class="token punctuation">,</span> <span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Load two fonts</span>
<span class="token keyword">let</span> fonts <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  font<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  fontBold<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// Group repaints and render both fonts at the same time!</span>
fonts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">font</span> <span class="token operator">=></span> documents<span class="token punctuation">.</span>fonts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>font<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Adrian Beceは、Font Loading APIを使用した最初のフォント取得の方法として、<code class="language-text">body</code>の最上部にノーブレークスペースの<code class="language-text">nbsp;</code>を追加し、
それを<code class="language-text">aria-visibility: hidden</code>と<code class="language-text">.hidden</code>クラスで非表示にすることを<a href="https://css-tricks.com/how-to-load-fonts-in-a-way-that-fights-fout-and-makes-lighthouse-happy/">提案</a>しています。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- ... Website content ... --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">aria-visibility</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token style language-css"><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'[web-font-name]'</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
      <span class="token comment">&lt;!-- There is a non-breaking space here --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"no-js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これは、異なる読み込み状態に対して異なるフォントファミリーを宣言するCSSと相性が良く、フォントの読み込みが完了するとFont Loading APIによって変更がトリガーされます。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">body:not(.wf-merriweather--loaded):not(.no-js)</span> <span class="token punctuation">{</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> [fallback-system-font]<span class="token punctuation">;</span>
  <span class="token comment">/* Fallback font styles */</span>
<span class="token punctuation">}</span>

<span class="token selector">.wf-merriweather--loaded,
.no-js</span> <span class="token punctuation">{</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"[web-font-name]"</span><span class="token punctuation">;</span>
  <span class="token comment">/* Webfont styles */</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Accessible hiding */</span>
<span class="token selector">.hidden</span> <span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  <span class="token property">clip</span><span class="token punctuation">:</span> <span class="token function">rect</span><span class="token punctuation">(</span>0 0 0 0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 1px<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> -1px<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>あらゆる最適化を試したにもかかわらず、依然としてLighthouseがレンダリングをブロックするリソース（フォント）の削除を提案してくることを不思議に思った経験はありませんか。
Adrian Beceは、上記と同じ記事で、<a href="https://css-tricks.com/how-to-load-fonts-in-a-way-that-fights-fout-and-makes-lighthouse-happy/">Lighthouseを満足させるためのいくつかのテクニック</a>や、
<a href="https://github.com/codeAdrian/gatsby-omni-font-loader">Gatsby Omni Font Loader</a>を紹介しています。
Gatsby Omni Font Loaderは、高パフォーマンスな非同期のフォント読み込みと、フォント切り替えに伴うちらつき（FOUT）の処理に対応したGatsby向けのプラグインです。</p>
<p>現在、多くの人は、Webフォントの読み込み先としてCDNやサードパーティのホストを使用しているかもしれません。
一般に、可能ならば<a href="https://csswizardry.com/2019/05/self-host-your-static-assets/">常に、全ての静的アセットを自分でホストするほう</a>が望ましいと言えます。
Google Fontsを簡単に自分でホストする方法として、<a href="https://google-webfonts-helper.herokuapp.com/fonts">google-webfonts-helper</a>を使用することを検討してみましょう。
それが不可能である場合は、<a href="https://blog.cloudflare.com/fast-google-fonts-with-cloudflare-workers/">ページのオリジンを通じて、Google Fontファイルをプロキシすること</a>ができるかもしれません。</p>
<p>ただし、注目に値する点として、Googleは初期設定の時点で<a href="https://www.tunetheweb.com/blog/should-you-self-host-google-fonts/">とても多くの仕事</a>を済ませているため、
微修正さえすれば、サーバの遅延を回避できる可能性があります（Barryに感謝します）。</p>
<p>これは特にChrome v86（2020年10月リリース）以降は非常に重要となります。
なぜなら、<a href="https://developers.google.com/web/updates/2020/10/http-cache-partitioning">ブラウザのキャッシュがサイトごとに分割されるため</a>、
フォントなどの複数のサイトをまたぐリソースは<a href="https://wicki.io/posts/2020-11-goodbye-google-fonts/">同一のCDNで共有できなくなる</a>からです。
この挙動は、長年にわたってSafariのデフォルトでした。</p>
<p>しかし、上記の手法がまったく使えない場合は、Harry Robertsのスニペットを利用すれば、
<a href="https://csswizardry.com/2020/05/the-fastest-google-fonts/">可能な限り速くGoogle Fontsを取得</a>できます。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css">&lt;!-- By Harry Roberts.
<span class="token property">https</span><span class="token punctuation">:</span>//csswizardry.com/2020/05/the-fastest-google-fonts/

- 1. Preemptively warm up the fonts’ origin.
- 2. Initiate a high-priority<span class="token punctuation">,</span> asynchronous fetch for the CSS file. Works in
-    most modern browsers.
- 3. Initiate a low-priority<span class="token punctuation">,</span> asynchronous fetch that gets applied to the page
-    only after it’s arrived. Works in all browsers with JavaScript enabled.
- 4. In the unlikely event that a visitor has intentionally disabled
-    JavaScript<span class="token punctuation">,</span> fall back to the original method. The good news is that<span class="token punctuation">,</span>
-    although this is a render-blocking request<span class="token punctuation">,</span> it can still make use of the
-    preconnect which makes it marginally faster than the default.
-->

&lt;!-- [1] -->
&lt;link rel=<span class="token string">"preconnect"</span>
      href=<span class="token string">"https://fonts.gstatic.com"</span>
      crossorigin />

&lt;!-- [2] -->
&lt;link rel=<span class="token string">"preload"</span>
      as=<span class="token string">"style"</span>
      href=<span class="token string">"$CSS&amp;display=swap"</span> />

&lt;!-- [3] -->
&lt;link rel=<span class="token string">"stylesheet"</span>
      href=<span class="token string">"$CSS&amp;display=swap"</span>
      media=<span class="token string">"print"</span> onload=<span class="token string">"this.media='all'"</span> />

&lt;!-- [4] -->
&lt;noscript>
  &lt;link rel=<span class="token string">"stylesheet"</span>
        href=<span class="token string">"$CSS&amp;display=swap"</span> />
&lt;/noscript></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Harryの戦略では、まずフォントのオリジンを事前にアップしておきます。
次に、優先度が高いCSSファイルを非同期で取得し始めます。
その後、優先度が低いファイルを非同期で取得し、完了後にのみページに適用します
（<a href="https://www.filamentgroup.com/lab/load-css-simpler/">スタイルシートのprint属性に関するテクニックを利用します</a>）。
最後に、JavaScriptがサポートされていない場合、当初の手法にフォールバックします。</p>
<p>Google Fontsと言えば、<code class="language-text">&amp;text</code>を使用して、<a href="https://developers.google.com/fonts/docs/getting_started#optimizing_your_font_requests">必要な文字だけを宣言する</a>ことで、
Google Fontsリクエストの<strong>容量を最大で90％削減できます</strong>。
さらに、Google Fontsには<a href="https://css-tricks.com/google-fonts-and-font-display/">最近、font-displayのサポートも追加された</a>ため、すぐに使用することができます。</p>
<p>ただし、注意すべき点もあります。<code class="language-text">font-display: optional</code>を使用する場合、
<code class="language-text">preload</code>を併用するのは<a href="https://www.zachleat.com/web/preload-font-display-optional/">最適ではない可能性があります</a>。
なぜなら、<code class="language-text">preload</code>はWebフォントのリクエストを早い段階でトリガーするからです（取得する必要があるクリティカルパスのリソースが他に存在する場合、
<strong>ネットワークの輻輳</strong>を引き起こします）。オリジンをまたぐフォントリクエストを高速化するには<code class="language-text">preconnect</code>を使用しましょう。
ただし、異なるオリジンからフォントを先読みすると、ネットワーク上で競合が起きるため、<code class="language-text">preload</code>には注意しなければなりません。
これらのテクニックは全て、Zachの<a href="https://github.com/zachleat/web-font-loading-recipes">Web font loading recipes</a>で取り上げられています。</p>
<p>一方、ユーザがアクセシビリティ設定において<a href="https://webkit.org/blog/7551/responsive-design-for-motion/">Reduce Motion</a>を有効にしている場合、
<strong>省データモード</strong>を選択している場合（<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/save-data/"><code class="language-text">Save-Data</code>ヘッダ</a>を参照）、
あるいはユーザの接続が遅い場合（<a href="https://developer.mozilla.org/en-US/docs/Web/API/Network_Information_API">Network Information API</a>を通じて判定）は、
<a href="https://calendar.perfplanet.com/2020/a-font-display-setting-for-slow-connections/">Webフォントを使用しない</a>
（または、少なくとも2段階目のレンダリングの対象とする）ことが賢明かもしれません。</p>
<p>また、CSSメディアクエリの<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/%40media/prefers-reduced-data"><code class="language-text">prefers-reduced-data</code></a>を使用して、
ユーザが省データモードを選択している場合はフォント宣言を定義しないようにすることもできます
（<a href="https://polypane.app/blog/creating-websites-with-prefers-reduced-data/">他の使用方法もあります</a>）。
このメディアクエリは基本的に、CSSが使用できるようにするために、クライアントヒントHTTP拡張機能からの<code class="language-text">Save-Data</code>リクエストヘッダがオン/オフのどちらになっているかを明らかにするものです。
現在は<a href="https://caniuse.com/?search=prefers-reduced-data">ChromeとEdgeのみでflagsとしてサポートされています</a>。</p>
<p><strong>指標にはどのようなものがあるでしょうか</strong>。Webフォント読み込みのパフォーマンスを測定したい場合は、
<a href="https://noti.st/zachleat/KNaZEg/the-five-whys-of-web-font-loading-performance#s5IYiho">All Text Visible</a>
（全てのフォントが読み込まれ、全てのコンテンツがWebフォントで表示された時点）、
<a href="https://vimeo.com/336091879#t=1550s">Time to Real Italics</a>、初回のレンダリング後のWeb Font Reflow Countの導入を検討してみましょう。
当然ながら、どの指標も小さいほどパフォーマンスが優れています。</p>
<p><strong>可変フォント</strong>はどうでしょうか。重要な点として、<a href="https://www.smashingmagazine.com/2017/09/new-font-technologies-improve-web/">可変フォント</a>は、
<a href="https://youtu.be/FbguhX3n3Uc?t=2161">パフォーマンスに大きな影響を与える</a>可能性があります。
可変フォントによって、幅広いタイポグラフィックのデザインを選択することが可能になりますが、
複数の個別ファイルのリクエストではなく、1つの連続リクエストを送信しなければならないというコストがかかります。</p>
<p>可変フォントは<a href="https://uxdesign.cc/the-performance-benefits-of-variable-fonts-79af8c4ff56c">フォントファイル全体の合計容量を劇的に削減します</a>が、
上記の1つのリクエストの処理が遅くなり、ページの全てのコンテンツのレンダリングをブロックする可能性があります。
したがって、フォントをサブセット化して、いくつかの文字セットに分割することは、依然として重要です。
ただし、メリットとして、可変フォントを導入するとデフォルトのリフローはきっかり1回となるため、再描画のグループ化にJavaScriptが必要ありません。</p>
<p>それでは、<strong>盤石のWebフォント読み込み戦略</strong>とはどのようなものでしょうか。
それは、フォントをサブセットに分割し、2段階のレンダリングを可能にすること、<code class="language-text">font-display</code>記述子でそれを宣言すること、
Font Loading APIを使用して再描画をグループ化すること、持続的なサービスワーカーのキャッシュでフォントを保存することです。
初回アクセス時には、外部のスクリプトにブロックされる直前にスクリプトの先読みを挿入します。
必要があれば、Bram Steinの<a href="https://github.com/bramstein/fontfaceobserver">Font Face Observer</a>にフォールバックすることも可能です。
フォント読み込みのパフォーマンス測定に関心がある方は、
Andreas Marschkeが<a href="https://www.andreas-marschke.name/posts/2017/12/29/Fonts-API-UserTiming-Boomerang.html">Font APIとUserTiming APIのパフォーマンス測定について追求した記事</a>をご覧ください。</p>
<p>最後に、大規模なフォントをより小規模な言語別のフォントに分割するために、<code class="language-text">unicode-range</code>を含めることを忘れないでください。
また、Monica Dinculescuの<a href="https://meowni.ca/font-style-matcher/">font-style-matcher</a>を使用すると、
フォールバックフォントとWebフォントのサイズの違いによるレイアウトの不快な変化を最小限にすることができます。</p>
<p>あるいは、フォールバックフォントでWebフォントをエミュレートするには、
<a href="https://docs.google.com/document/d/1PW-5ML5hOZw7GczOargelPo6_8Zkuk2DXtgfOtJ59Eo/edit">@font-face記述子でフォントメトリックを上書きする</a>という方法もあります
（<a href="https://jsfiddle.net/wpnjav2k/">デモはこちら</a>。Chrome 87で有効）（ただし、複雑なフォントスタックでは複雑な調整が必要であることにご注意ください）。</p>
<p>これで未来は明るいと言えるでしょうか。
<a href="https://rwt.io/typography-tips/progressive-font-enrichment-reinventing-web-font-performance">フォントの段階的なエンリッチメント</a>により、
いずれは「最初はどのページでもフォントの必要な部分のみをダウンロードし、そのフォントの次のリクエストは、
その後のページの表示に必要となる追加的なグリフをダウンロードすることで、初回ダウンロードの動的な『パッチ』とする」ことができるようになるかもしれないと、
Jason Pamentalは説明しています。<a href="https://fonts.gstatic.com/experimental/incxfer_demo">Incremental Transfer Demo</a>はすでに利用可能であり、
フォントの段階的なエンリッチメントに向けた取り組みは<a href="https://www.w3.org/Fonts/WG/webfonts-2018.html#normative">進行中です</a>。</p>
<h2>ビルドの最適化 <a href="#05">#</a><a name="05"></a></h2>
<h3>28. 優先順位を定義しているか？</h3>
<p>何を最初に処理すべきかを把握するのは良いアイデアです。
全てのアセット（JavaScript、画像、フォント、サードパーティのスクリプトや、カルーセル、複雑なインフォグラフィック、マルチメディアコンテンツなどのページ上の「コストが重い」モジュール）の<strong>インベントリ</strong>を実行し、アセットをグループに分けましょう。</p>
<p><strong>スプレッドシートを設定しましょう</strong>。
古いブラウザ向けの基本的なコアとなるユーザ体験（完全なアクセスが可能なコアとなるコンテンツ）、高性能なブラウザ向けの高水準なユーザ体験（リッチで完全な体験）、
それ以外の部分（絶対に必要というわけではなく、遅延読み込みが可能なアセット。Webフォント、不必要なスタイル、カルーセルのスクリプト、動画プレーヤ、ソーシャルメディアウィジェット、大きな画像）を定義してください。
数年前に私たちが公表した「<a href="https://www.smashingmagazine.com/2014/09/improving-smashing-magazine-performance-case-study/">Improving Smashing Magazine’s Performance</a>」という記事では、
このアプローチについて詳しく説明しています。</p>
<p>パフォーマンスを最適化するときは、優先順位を反映する必要があります。
コアとなるユーザ体験がすぐに読み込まれ、次に高水準なユーザ体験、最後にそれ以外の部分が読み込まれるようにしましょう。</p>
<h3>29. 本番環境でネイティブJavaScriptモジュールを使用しているか？</h3>
<p>コアとなるユーザ体験を古いブラウザに、高水準なユーザ体験をモダンなブラウザに提供するために、
かつては<a href="https://www.filamentgroup.com/lab/modernizing-delivery.html">環境に合わせたテクニック</a>を使用していたことを覚えていますか。
<a href="https://snugug.com/musings/modern-cutting-the-mustard/">このテクニックのアップデート版</a>では、
ES2017+ <code class="language-text">&lt;script type=&quot;module&quot;&gt;</code>、別名<a href="https://philipwalton.com/articles/using-native-javascript-modules-in-production-today/">module/nomoduleパターン</a>を使用できる可能性があります
（Jeremy Wagnerによって<a href="https://calendar.perfplanet.com/2018/doing-differential-serving-in-2019/">Differential Serving</a>としても紹介されています）。</p>
<p>この手法のアイデアは、<strong>2つの異なるJavaScriptバンドル</strong>をコンパイルして提供するというものです。
1つ目はBabel-transformとポリフィル付きの「通常」のビルドで、それらを実際に必要とする古いブラウザのみに提供します。
もう1つのバンドル（機能は同一）にはtransformもポリフィルもありません。</p>
<p>その結果、ブラウザが処理する必要があるスクリプトの量が減少し、メインスレッドのブロックを削減するのに役立ちます。
Jeremy Wagnerは<a href="https://calendar.perfplanet.com/2018/doing-differential-serving-in-2019/">Differential Servingについて幅広く取り扱った記事</a>を公表しています。
この記事では、ビルドのパイプラインにおいてDifferential Servingを設定する方法（Babelの設定から、Webpackにおいて必要な微修正まで）や、
一連の作業に労力を費やすメリットについて紹介しています。</p>
<p>ネイティブJavaScriptモジュールスクリプトは<a href="https://v8.dev/features/modules#defer">デフォルトで遅延するようになっている</a>ため、
HTMLをパースしている間にブラウザが<a href="https://twitter.com/addyosmani/status/1233346105842122754">メインモジュールをダウンロード</a>します。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/cc4a5548-f5a3-41ea-b881-39f9a366261b/js-modules-deferred-default.jpg">
<em>ネイティブJavaScriptモジュールはデフォルトで遅延するようになっています。<a href="https://v8.dev/features/modules">ネイティブJavaScriptモジュールのほぼ全てに関する記事はこちら</a>。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/cc4a5548-f5a3-41ea-b881-39f9a366261b/js-modules-deferred-default.jpg">プレビューを拡大</a>）</em></p>
<p>ただし、注意すべき点として、module/nomoduleパターンは<a href="https://gist.github.com/jakub-g/5fc11af85a061ca29cc84892f1059fec">一部のクライアントでは逆効果となる可能性があります</a>。
そのため、回避策を検討するほうが良いかもしれません。
Jeremyは、プリロードスキャナを避ける<a href="https://web.dev/preload-scanner/">リスクが比較的低いDifferential Servingのパターン</a>を紹介していますが、
この方法は予期しない形でパフォーマンスに影響を及ぼす恐れがあります（Jeremyに感謝します）。</p>
<p>実際、<a href="https://rollupjs.org/guide/en/#outputformat">Rollupはモジュールを出力形式としてサポート</a>しているため、
コードをバンドルしつつ、モジュールを本番環境にデプロイすることができます。
Parcelは<a href="https://github.com/parcel-bundler/parcel/pull/3545">Parcel 2でモジュールをサポートしています</a>。
Webpackでは、<a href="https://github.com/JoviDeCroock/webpack-module-nomodule-plugin">module-nomodule-plugin</a>がmodule/nomoduleスクリプトの生成を自動化します。</p>
<p><strong>注記：</strong>注意すべき点として、機能検出だけでは、そのブラウザに送るペイロードについて、十分な情報に基づく意思決定はできません。
ブラウザのバージョンだけでは、端末の能力を推測することは不可能です。
例えば、発展途上国の安価なAndroidスマートフォンのほとんどにはChromeが搭載されており、メモリとCPUの性能に制約があるにもかかわらず要求水準を満たしています。</p>
<p>最終的には、<a href="https://github.com/w3c/device-memory">Device Memory Client Hints Header</a>を使用することで、
より信頼性が高い方法でローエンドの端末をターゲットとすることができるでしょう。
この記事の執筆時点では、このヘッダはBlinkのみでサポートされています（これは一般に<a href="https://caniuse.com/#search=client%20hints">クライアントヒント</a>の代わりとなります）。
Device Memoryには<a href="https://developers.google.com/web/updates/2017/12/device-memory">Chromeで利用可能</a>なJavaScript APIも存在します。
そのため、APIに基づく機能検知を行い、それがサポートされていない場合はmodule/nomoduleパターンにフォールバックするという選択肢もあり得るでしょう（Yoavに感謝します）。</p>
<h3>30. ツリーシェイキング、スコープホイスティング、コード分割を使用しているか？</h3>
<p><a href="https://developers.google.com/web/fundamentals/performance/optimizing-javascript/tree-shaking/">ツリーシェイキング</a>は、
<a href="https://www.2ality.com/2015/12/webpack-tree-shaking.html">Webpack</a>において、本番環境で実際に使用されるコードのみを採用し
、使われていないインポートを削除することにより、ビルドのプロセスを整理する方法の1つです。
WebpackとRollupの<a href="https://medium.com/webpack/brief-introduction-to-scope-hoisting-in-webpack-8435084c171f">スコープホイスティング</a>は、
これらのツールが、<code class="language-text">import</code>のチェーンをフラット化し、コードを傷つけることなく1つのインライン関数に変換できる場所を発見することを可能にします。
Webpackでは<a href="https://react-etc.net/entry/json-tree-shaking-lands-in-webpack-4-0">JSON Tree Shaking</a>も使用できます。</p>
<p><a href="https://webpack.js.org/guides/code-splitting/">コード分割</a>はWebpackの機能の1つで、必要に応じて読み込まれる「チャンク」にコードベースを分割するものです。
全てのJavaScriptをすぐにダウンロード、パース、コンパイルする必要はありません。コードを分割するポイントを定めれば、
Webpackが依存関係と出力ファイルを処理してくれます。
これにより、初期のダウンロードの容量を小規模に維持し、アプリケーションにリクエストされたときに必要に応じてコードをリクエストすることができます。
Alexander Kondrovは、<a href="https://hackernoon.com/lessons-learned-code-splitting-with-webpack-and-react-f012a989113">WebpackとReactによるコード分割についての素晴らしい紹介記事</a>を公表しています。</p>
<p><a href="https://github.com/GoogleChromeLabs/preload-webpack-plugin">preload-webpack-plugin</a>の使用を検討しましょう。
これはコード分割のルートを示し、<code class="language-text">&lt;link rel=&quot;preload&quot;&gt;</code>や<code class="language-text">&lt;link rel=&quot;prefetch&quot;&gt;</code>を使用してブラウザによる先読みを促すものです。
<a href="https://webpack.js.org/guides/code-splitting/#prefetching-preloading-modules">Webpackインラインディレクティブ</a>も<code class="language-text">preload</code>や<code class="language-text">prefetch</code>をある程度コントロールできます
（ただし、<a href="https://andydavies.me/blog/2019/02/12/preloading-fonts-and-the-puzzle-of-priorities/">優先順位の問題</a>には注意しましょう）。</p>
<p>分割のポイントを決定するには、CSSやJavaScriptのどのチャンクが使用され、どのチャンクが使用されていないかを追跡する必要があります。
Umar Hansaは、DevtoolsのCode Coverageによってそれをどのように実現するかについて<a href="https://vimeo.com/235431630#t=11m37s">説明</a>しています。</p>
<p>シングルページアプリケーションに取り組む場合、ページをレンダリングできる前に、アプリケーションを初期化するのに一定の時間が必要です。
設定にはカスタムソリューションが必要ですが、初期のレンダリング時間を高速化するためのモジュールやテクニックも探すことができます。
例えば、<a href="https://building.calibreapp.com/debugging-react-performance-with-react-16-and-chrome-devtools-c90698a522ad">Reactのパフォーマンスをデバッグする方法</a>、
<a href="https://blog.logrocket.com/death-by-a-thousand-cuts-a-checklist-for-eliminating-common-react-performance-issues/">Reactのパフォーマンスに関するよくある問題の解決方法</a>、
<a href="https://www.youtube.com/watch?v=p9vT0W31ym8">Angularのパフォーマンスを改善する方法</a>が紹介されています。
通常、パフォーマンスに関するほとんどの問題は、アプリケーションを最初にブートストラップするための時間に起因します。</p>
<p>それでは、積極的にコードを分割しつつ、分割し過ぎないようにするための最善の方法は何でしょうか。Phil Waltonによれば、
「動的インポートを通じたコード分割に加え、<strong>パッケージレベルでのコード分割</strong>を活用することもできます。
このコード分割では、パッケージの名称に基づき、インポートした各ノードモジュールをチャンクに分割します」。
Philは<a href="https://philipwalton.com/articles/using-native-javascript-modules-in-production-today/">パッケージレベルのコード分割をビルドするためのチュートリアル</a>も提供しています。</p>
<h3>31. Webpackの出力を改善できるか？</h3>
<p>Webpackは通常、よく分からない存在とみなされているため、Webpackの出力を一段と削減できる便利なWebpackプラグインは数多くあります。
以下では、比較的無名で、もっと注目する必要があるかもしれない手法を紹介します。</p>
<p><a href="https://twitter.com/iamakulov/status/1275807323299160066">Ivan Akulovのスレッド</a>では興味深い手法が紹介されています。
ある関数を1度呼び出し、その結果を変数として保存し、その変数を使用しない場合を想像してください。
ツリーシェイキングはその変数を削除しますが、関数は削除しません。別の場所で使用される可能性があるからです。
しかし、その関数が別の場所で使用されないならば、それを削除したいと思うでしょう。
そのためには、UglifyとTerserでサポートされている<code class="language-text">/*#__PURE__*/</code>を関数呼び出しの先頭に追加するだけで十分です。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/b371aa9f-e712-4710-90f1-70a4aae0915d/function-result-pure.jpg">
結果が使用されない関数を削除するには、関数呼び出しの先頭に/<em>#<strong>PURE</strong></em>/を追加します。<a href="https://twitter.com/iamakulov/status/1275807326184882181">Ivan Akulov</a>より。（プレビューを拡大）</p>
<p>Ivanは他にもいくつかのツールを推奨しています。</p>
<ul>
<li><a href="https://www.npmjs.com/package/purgecss-webpack-plugin">purgecss-webpack-plugin</a>は、特にBootstrapやTailwindを使用している場合に、利用されていないクラスを削除します。</li>
<li><code class="language-text">optimization.splitChunks: &#39;all&#39;</code>を<a href="https://webpack.js.org/plugins/split-chunks-plugin/">split-chunks-plugin</a>で有効化しましょう。これにより、Webpackがエントリーバンドルを自動的にコード分割し、キャッシングを改善することができます。</li>
<li><a href="https://webpack.js.org/configuration/optimization/#optimizationruntimechunk">optimization.runtimeChunk: trueを設定</a>しましょう。これはWebpackのランタイムを別個のチャンクに移行し、キャッシングも改善するものです。</li>
<li><a href="https://www.npmjs.com/package/google-fonts-webpack-plugin">google-fonts-webpack-plugin</a>はフォントファイルをダウンロードし、自分のサーバからフォントファイルを提供することを可能にします。</li>
<li><a href="https://www.npmjs.com/package/workbox-webpack-plugin">workbox-webpack-plugin</a>は、サービスワーカーを生成し、全てのWebpackアセットについてプリキャッシュ設定を行うことを可能にします。すぐに適用できるモジュールの包括的なガイドである<a href="https://developer.chrome.com/docs/workbox/">Service Worker Packages</a>もチェックしましょう。あるいは、<a href="https://www.npmjs.com/package/preload-webpack-plugin">preload-webpack-plugin</a>を使用して、全てのJavaScriptチャンクについて<code class="language-text">preload</code>や<code class="language-text">prefetch</code>を生成しましょう。</li>
<li><a href="https://www.npmjs.com/package/speed-measure-webpack-plugin">speed-measure-webpack-plugin</a>は、Webpackのビルド速度を測定し、ビルドプロセスのどのステップに最も時間がかかっているかに関する情報を提供します。</li>
<li><a href="https://www.npmjs.com/package/duplicate-package-checker-webpack-plugin">duplicate-package-checker-webpack-plugin</a>は、バンドルに同一のパッケージの複数のバージョンが含まれている場合に警告します。</li>
<li>コンパイルの際に、<a href="https://www.freecodecamp.org/news/reducing-css-bundle-size-70-by-cutting-the-class-names-and-using-scope-isolation-625440de600b">スコープの分離を活用し、CSSクラス名を動的に短縮</a>しましょう。</li>
</ul>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4c469462-2e01-4511-8b77-0d5a59597635/responsive-loader-code-example.jpg">
<em>小さい画面には小さい写真を提供することで、画像を高速化できます。これには<a href="https://github.com/dazuaz/responsive-loader">responsive-loader</a>を活用します。Ivan Akulovより。（プレビューを拡大）</em></p>
<h3>32. JavaScriptをWebワーカーへオフロードできるか？</h3>
<p>Time To Interactiveへの悪影響を軽減するには、重いJavaScriptを<a href="https://web.dev/off-main-thread/">Webワーカー</a>へオフロードすることを検討してみると良いかもしれません。</p>
<p>コードベースの拡大に伴い、UIのパフォーマンスのボトルネックが発生し、ユーザ体験が減速します。
これはメインスレッドで<a href="https://medium.com/google-developer-experts/running-fetch-in-a-web-worker-700dc33ac854">JavaScriptと並行してDOMオペレーションが実行されている</a>ためです。
<a href="https://flaviocopes.com/web-workers/">Webワーカー</a>では、こうしたコストが大きいオペレーションを、別のスレッドで実行されるバックグラウンドのプロセスに移行できます。
Webワーカーの一般的な使用法は、<a href="https://blog.sessionstack.com/how-javascript-works-the-building-blocks-of-web-workers-5-cases-when-you-should-use-them-a547c0757f6a">データとProgressive Web Appsを先読みして</a>、
一部のデータを事前に読み込み・保存し、後で必要なときに使用できるようにすることです。
また、メインページとワーカーの間の通信を合理化するために、<a href="https://github.com/GoogleChromeLabs/comlink">Comlink</a>を使用することもできます。
まだ完全ではありませんが、ゴールには近づいています。</p>
<p><a href="https://docs.google.com/document/d/1nu0EcVNC3jtmUVWL8Gs5eCj2p_984kamNhG2nS9gOC0/edit">Webワーカーに関してはいくつかの興味深いケーススタディがあります</a>。
これらは、フレームワークとアプリケーションのロジックをWebワーカーへ移行するさまざまなアプローチを示すものです。
結論としては、全体的に課題は残っているものの、優れたユースケースもすでに存在すると言えます（Ivan Akulovに感謝します）。</p>
<p>Chrome 80以降、JavaScriptモジュールのパフォーマンス上のメリットを持つ<strong>新たなモードのWebワーカー</strong>が実装されています。
これは<a href="https://web.dev/module-workers/#enter-module-workers">モジュールワーカー</a>と呼ばれます。
<code class="language-text">script type=&quot;module&quot;</code>に合わせてスクリプトの読み込みと実行を変更できるうえに、
ワーカーの実行をブロックすることなく、コードの遅延読み込みのための動的なインポートを使用することが可能です。</p>
<p>Webワーカーを始めたいという方向けに、注目に値するいくつかのリソースを紹介します。</p>
<ul>
<li>SurmaはJavaScriptをブラウザのメインスレッド以外で実行するための素晴らしい手引きと、When should you be using Web Workers?という記事を公表しています。</li>
<li><a href="https://www.youtube.com/watch?v=7Rrv9qFMWNM&#x26;feature=emb_title">メインスレッドからの移行のアーキテクチャ</a>に関するSurmaの講演もチェックしてみてください。</li>
<li>Shubhie PanickerとJason MillerのA Quest to Guarantee Responsivenessという講演は、Webワーカーをどのように使用すべきか、どのような場合は使用すべきでないかについての詳細な情報を提供しています。</li>
<li><a href="https://www.youtube.com/watch?v=mDdgfyRB5kg&#x26;feature=youtu.be">Getting Out of Users' Way: Less Jank With Web Workers</a>という講演では、Webワーカーをうまく使用するための便利なパターンに加え、ワーカー間の通信、メインスレッド以外での複雑なデータ処理の取り扱い、それらのテストとデバッグの効果的な方法にスポットライトを当てています。</li>
<li><a href="https://github.com/developit/workerize">Workerize</a>は、モジュールをWebワーカーに移動し、エクスポートされた関数を非同期のプロキシとして自動的に反映することを可能にします。</li>
<li>Webpackを使用している場合、<a href="https://github.com/developit/workerize-loader">workerize-loader</a>を利用できます。あるいは、<a href="https://github.com/GoogleChromeLabs/worker-plugin">worker-plugin</a>を利用しても良いでしょう。</li>
</ul>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4a59924a-f042-4081-a7db-2e134975c647/why-web-workers-example.jpg">
<em>コードが長期にわたりブロックとなっているなら、Webワーカーを使用しましょう。ただし、DOMに依存している場合、入力への応答を取り扱う場合、遅延を最小限に抑える必要がある場合は使用してはなりません。（<a href="https://twitter.com/addyosmani/status/1234017029730045952/photo/1">Addy Osmani</a>より）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4a59924a-f042-4081-a7db-2e134975c647/why-web-workers-example.jpg">プレビューを拡大</a>）</em></p>
<p>DOMは「スレッドセーフ」ではないため、WebワーカーがDOMにアクセスできないことに注意しましょう。
Webワーカーが実行するコードは別個のファイルに収容する必要があります。</p>
<h3>33.「ホットパス」をWebAssemblyにオフロードできるか？</h3>
<p><a href="https://developers.google.com/web/updates/2019/02/hotpath-with-wasm">計算のコストが大きいタスクをWebAssembly（WASM）にオフロードする</a>ことができます。
WebAssembyはバイナリの命令形式で、C/C++/Rustなどの高級言語のコンパイルのポータブルターゲットとして設計されています。
WebAssemblyは<a href="https://caniuse.com/#feat=wasm">ブラウザのサポートが充実</a>しており、
最近は<a href="https://hacks.mozilla.org/2018/10/calls-between-javascript-and-webassembly-are-finally-fast-%F0%9F%8E%89/">JavaScriptとWASMの間の関数呼び出しが高速化している</a>ことで実用的な手法となっています。
さらに、<a href="https://www.fastly.com/blog/announcing-lucet-fastly-native-webassembly-compiler-runtime">Fastlyのエッジクラウドでもサポートされています</a>。</p>
<p>もちろん、WebAssemblyはJavaScriptの代わりになるとは考えられていませんが、
CPUに大きい負荷がかかっている場合において、JavaScriptを補完することができます。
ほとんどのWebアプリケーションにとってはJavaScriptのほうが適しており、
WebAssemblyはゲームなどの<strong>計算の負荷が大きいWebアプリケーション</strong>にとって最も有用です。</p>
<p>WebAssemblyについて詳しく知りたい人は、以下が参考になります。</p>
<ul>
<li>Lin Clarkは<a href="https://hacks.mozilla.org/2017/02/a-cartoon-intro-to-webassembly/">WebAssemblyに関する詳しいシリーズ記事</a>を執筆しています。Milica Mihajlijaは、ブラウザでネイティブコードを実行する方法の<a href="https://blog.logrocket.com/webassembly-how-and-why-559b7f96cd71">概要</a>、そのメリット、それがJavaScriptと未来のWeb開発にとって持つ意味について解説しています。</li>
<li><a href="https://www.smashingmagazine.com/2019/04/webassembly-speed-web-app/">How We Used WebAssembly To Speed Up Our Web App By 20X (Case Study)</a>という記事では、低速なJavaScriptの計算をコンパイル済みのWebAssemblyに置き換えることで、パフォーマンスが大幅に改善されたというケーススタディに焦点を当てています。</li>
<li>Patrick Hamannは<a href="https://www.youtube.com/watch?v=Z6ZhIA8i_8g">WebAssemblyの役割の拡大</a>について語っています。彼はWebAssemblyに関する誤りを示し、WebAssemblyの課題について追求することで、WebAssemblyが現在のアプリケーションで実際に使用できることを明らかにしています。</li>
<li>Google CodelabsはIntroduction to WebAssemblyという60分の講義を提供しています。この講義では、C言語のネイティブコードをWebAssemblyにコンパイルし、JavaScriptから直接呼び出す方法を学習できます。</li>
<li>Alex Daniloは、Google I/Oでの講演で、<a href="https://www.youtube.com/watch?v=6v4E6oksar0">WebAssemblyとその仕組み</a>について説明しています。Benedek Gagyiも<a href="https://www.youtube.com/watch?v=l2DHjRmgAF8">WebAssemblyに関する実用的なケーススタディ</a>を紹介しています。具体的な内容は、WebAssemblyをiOS、Android、Webサイト向けのC++コードベースの出力形式として使用する方法に関するものです。</li>
</ul>
<p>Webワーカー、Web Assembly、ストリーム、あるいはGPUにアクセスするためのWebGL JavaScript APIを使用するタイミングに関して、
<strong>まだ自信が持てない</strong>方もいるかもしれません。そのような方にはAccelerating JavaScriptがお勧めです。
このガイドは、短いながらも便利な内容で、いつ、何を、なぜ使用すべきかについて説明しています。
さらに、使いやすいフローチャートや、数多くの有用なリソースも提供されています。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/bbb2ea83-7674-47d8-9cad-89a2de009915/how-webassembly-works.png">
<em>Milica Mihajlijaは<a href="https://blog.logrocket.com/webassembly-how-and-why-559b7f96cd71">WebAssemblyの仕組みとそれが便利である理由</a>の概要を説明しています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/bbb2ea83-7674-47d8-9cad-89a2de009915/how-webassembly-works.png">プレビューを拡大</a>）</em></p>
<h3>34. 古いコードを古いブラウザのみに提供しているか？</h3>
<p>ES2017は<a href="https://web.dev/publish-modern-javascript/">モダンなブラウザによるサポートがとても充実している</a>ため、
<a href="https://github.com/prateekbh/babel-esm-plugin">babelEsmPluginを使用する</a>のは、
ターゲットとするモダンなブラウザがサポートしていないES2017+の機能をトランスパイルする場合に限定することができます。
Houssein DjirdehとJason Millerは最近、<a href="https://web.dev/publish-modern-javascript/">モダンなJavaScriptと古いJavaScriptのトランスパイルと提供方法についての包括的なガイド</a>を公表しました。
このガイドでは、WebpackとRollupを活用した実現方法や、必要なツールについて詳しく紹介しています。
サイトやアプリケーションのバンドルのJavaScriptをどれだけ削減できるかを推定することも可能です。</p>
<p>JavaScriptモジュールは<a href="https://caniuse.com/#feat=es6-module">全ての主要なブラウザでサポートされている</a>ため、
ESモジュールをサポートしているブラウザにファイルを読み込ませるために<a href="https://developers.google.com/web/fundamentals/primers/modules"><code class="language-text">script type=&quot;module&quot;</code>を使用する</a>ことが可能です。
一方、古いブラウザには<code class="language-text">script nomodule</code>で古いビルドを読み込ませることができます。</p>
<p>最近では、トランスパイラやバンドラがなくても、ブラウザでネイティブに実行できるモジュールベースのJavaScriptを書けるようになりました。
<a href="https://developers.google.com/web/updates/2017/12/modulepreload">&#x3C;<code class="language-text">link rel=&quot;modulepreload&quot;&gt;</code>ヘッダ</a>は、
モジュールスクリプトの読み込みを早い段階で（優先的に）開始するための手段を提供します。
基本的に、ブラウザが取得する必要があるものを指示し、長いラウンドトリップの間に他の作業に邪魔されないようにすることは、
帯域幅を最大限に活用するための効果的な方法の1つです。
また、Jake Archibaldが公表している<a href="https://jakearchibald.com/2017/es-modules-in-browsers/">ESモジュールの落とし穴と注意点</a>に関する詳しい記事も一読に値します。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d46ddc8b-4bd7-4627-b738-baf62807b26f/inline-scripts-deferred.png">
<em>Jake Archibaldは、<a href="https://jakearchibald.com/2017/es-modules-in-browsers/">ESモジュールの落とし穴と注意点</a>（例：インラインスクリプトは、ブロックとなる外部スクリプトとインラインスクリプトが実行されるまで遅延するなど）に関する詳しい記事を公表しています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d46ddc8b-4bd7-4627-b738-baf62807b26f/inline-scripts-deferred.png">プレビューを拡大</a>）</em></p>
<h3>35. 段階的なデカップリングによって古いコードを特定し、書き換える。</h3>
<p>長期のプロジェクトでは、ほこりをかぶった時代遅れのコードが蓄積する傾向があります。
依存関係を見直し、最近の問題の原因となっている古いコードのリファクタリングや書き換えのためにどれだけの時間が必要かを検討しましょう。
もちろん、これはいつでも大変な仕事ですが、古いコードの影響を把握すれば、
<a href="https://githubengineering.com/removing-jquery-from-github-frontend/">段階的なデカップリング</a>を始めることができます。</p>
<p>まず、古いコードの呼び出しの比率が一定か減少しており、増加していないことを確認するための指標を設定します。
また、チームに対してライブラリを使用しないようにと明確に伝え、
プルリクエストでライブラリが使用された場合はCIが開発者に<a href="https://github.com/dgraham/eslint-plugin-jquery">アラート</a>を通知するようにしましょう。
<a href="https://githubengineering.com/removing-jquery-from-github-frontend/#%E3%83%9D%E3%83%AA%E3%83%95%E3%82%A3%E3%83%AB">ポリフィル</a>は、
古いコードから、ブラウザの標準的な機能を使用する書き換え後のコードベースへの移行に役立つでしょう。</p>
<h3>36. 使用していないCSSやJSを特定・削除する。</h3>
<p>Chromeの<a href="https://developers.google.com/web/updates/2017/04/devtools-release-notes#coverage">CSSとJavaScriptのコードカバレッジ</a>を使用すると、
どのコードが実行・適用され、どのコードがそうではないのかを洗い出すことができます。カバレッジの記録を開始し、
ページにおけるアクションを実行し、コードカバレッジの結果を調査します。使用していないコードを発見したら、
<a href="https://twitter.com/TheLarkInn/status/1012429019063578624">そのモジュールを見つけ出し、<code class="language-text">import()</code>で遅延読み込みする</a>ようにしましょう（詳しくはスレッド全体を参照してください）。
さらに、同じプロファイルでカバレッジを繰り返し、初期読み込み時のコードが少なくなったことを確認しましょう。</p>
<p><a href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a>を使用すれば、<a href="https://twitter.com/matijagrcic/statuses/1060863620568043520">コードカバレッジの収集をプログラム化できます</a>。
Chromeでも<a href="https://twitter.com/tkadlec/status/1073330247758684163">コードカバレッジの結果をエクスポートする</a>ことが可能です。
ただし、Andy Daviesが述べているとおり、<a href="https://twitter.com/AndyDavies/status/1073339071106297856">モダンなブラウザと古いブラウザの両方</a>でコードカバレッジを収集したい場合もあるかもしれません。</p>
<p>Puppeteerには他にも、もっと知られるべき多くの使用方法とツールがあります。</p>
<ul>
<li><a href="https://github.com/GoogleChromeLabs/puppeteer-examples">Puppeteerの使用方法</a>としては、例えば<a href="https://meowni.ca/posts/2017-puppeteer-tests/">視覚的な差分を自動的に表示する</a>、<a href="https://blog.cowchimp.com/monitoring-unused-css-by-unleashing-the-devtools-protocol/">使用されていないCSSをビルドごとにモニタリングする</a>などがあります。</li>
<li><a href="https://addyosmani.com/blog/puppeteer-recipes/">Puppeteerを利用したWebパフォーマンスの改善に関する記事</a>。</li>
<li><a href="https://twitter.com/addyosmani/status/1219884904307142659">PuppeteerとPlaywrightのスクリプトを記録・生成するための便利なツール</a>。</li>
<li>さらに、<a href="https://twitter.com/umaar/status/1331924138970255360">DevToolsでテストを記録する</a>こともできます。</li>
<li>Nitay Neemanによる<a href="https://nitayneeman.com/posts/getting-to-know-puppeteer-using-practical-examples/">Puppeteerの包括的な紹介</a>では、事例と使用方法が紹介されています。</li>
</ul>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/76f10c0c-84cd-4658-876d-9bea1a0c160f/puppeteer-recorder-sandbox-opt.jpg">
<em>Puppeteer RecorderとPuppeteer Sandboxを使用することで、ブラウザのインタラクションを記録し、PuppeteerとPlaywrightのスクリプトを生成できます。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/76f10c0c-84cd-4658-876d-9bea1a0c160f/puppeteer-recorder-sandbox-opt.jpg">プレビューを拡大</a>）</em></p>
<p>さらに、<a href="https://github.com/FullHuman/purgecss">purgecss</a>、<a href="https://github.com/giakki/uncss">UnCSS</a>、<a href="https://github.com/geuis/helium-css">Helium</a>は、
使用されていないスタイルをCSSから削除するのに役立ちます。不審なコードがどこかで使用されているかどうかが分からない場合は、
<a href="https://csswizardry.com/2018/01/finding-dead-css/">Harry Robertsのアドバイス</a>に従うと良いでしょう。
すなわち、特定のクラス向けに1×1ピクセルの透明なGIFを作成し、<code class="language-text">dead/</code>ディレクトリにドロップするのです（例えば<code class="language-text">/assets/img/dead/comments.gif</code>）。</p>
<p>その後、CSSの対応するセレクタの背景としてその画像を設定し、数カ月待って、ファイルがログに出現するかを調べます。
エントリがなければ、その古いコンポーネントを誰も画面にレンダリングしていないことになるため、コンポーネントを完全に削除できるでしょう。
思い切ったことがしたいという方は、<a href="https://blog.cowchimp.com/monitoring-unused-css-by-unleashing-the-devtools-protocol/">DevToolsを使用してDevToolsをモニタリング</a>し、
複数のページを通して、使用されていないCSSの収集を自動化することもできます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/e30c7d5b-ef8b-46ba-b0fc-b1d5a31cefff/webpack-comparison.png">
<em>Benedikt Rötschの<a href="https://www.contentful.com/blog/2017/10/27/put-your-webpack-bundle-on-a-diet-part-3/">記事</a>は、Moment.jsからdate-fnsへの移行によって、3G接続のローエンドのスマートフォンで最初の描画までの時間を約300ミリ秒削減できる可能性があることを明らかにしました。（プレビューを拡大）</em></p>
<h3>37. JavaScriptバンドルの容量を削減する。</h3>
<p>Addy Osmaniが<a href="https://medium.com/%40addyosmani/the-cost-of-javascript-in-2018-7d8950fbb5d4">述べている</a>とおり、
JavaScriptライブラリの一部しか必要ではないにもかかわらず、ライブラリ全体を提供していることはよくあります。
また、ブラウザにとって不要な時代遅れのポリフィルや、単に重複したコードを提供してしまうケースもあります。
このようなオーバーヘッドを回避するために、<a href="https://github.com/GoogleChromeLabs/webpack-libs-optimizations">webpack-libs-optimizations</a>を使用して、
ビルドのプロセスに不要なメソッドやポリフィルを削除することを検討してみてください。</p>
<p>古いブラウザとモダンなブラウザに送信している<strong>ポリフィル</strong>を確認・レビューし、より綿密な戦略を立てましょう。
<a href="https://polyfill.io/v3/">polyfill.io</a>にも注目です。
このサービスは、一連のブラウザ機能のリクエストを受け付け、リクエストを実施したブラウザにとって必要なポリフィルのみを返します。</p>
<p>また、通常のワークフローに<strong>バンドル監査</strong>も追加しましょう。
何年も前に追加した重いライブラリに代わって、別の軽いライブラリを使用できるかもしれません。
例えば、Moment.js（現在は<a href="https://momentjs.com/docs/#/-project-status/">開発停止</a>）は以下と置き換えられるでしょう。</p>
<ul>
<li><a href="https://blog.logrocket.com/4-alternatives-to-moment-js-for-internationalizing-dates/">ネイティブInternationalization API</a></li>
<li><a href="https://github.com/iamkun/dayjs">Day.js</a>（なじみあるMoment.jsのAPIとパターンを使用）</li>
<li><a href="https://github.com/date-fns/date-fns">date-fns</a></li>
<li><a href="https://moment.github.io/luxon/#/">Luxon</a></li>
<li><a href="https://www.skypack.dev/">Skypack Discover</a>も使用できます。これは人間がレビューした推奨パッケージと、品質に重点を置いた検索を組み合わせたものです。</li>
</ul>
<p>Benedikt Rötschの<a href="https://www.contentful.com/blog/2017/10/27/put-your-webpack-bundle-on-a-diet-part-3/">調査</a>は、
Moment.jsからdate-fnsへの移行によって、3G接続のローエンドのスマートフォンで最初の描画までの時間を約300ミリ秒削減できる可能性があることを明らかにしました。</p>
<p>バンドル監査については、バンドルにnpmパッケージを追加するコストの計算に<a href="https://bundlephobia.com/">Bundlephobia</a>が役立つでしょう。
<a href="https://github.com/ai/size-limit">size-limit</a>は、基本的なバンドル容量のチェックを拡張し、JavaScriptの実行時間を詳しく調べるものです。
<a href="https://github.com/AymenLoukil/Google-lighthouse-custom-audit">これらのコストをLighthouse Custom Auditで統合する</a>ことも可能です。
フレームワークとも相性が良い機能となっています。
<a href="https://speakerdeck.com/addyosmani/web-performance-made-easy?slide=22">Vue MDC Adapter（VueのMaterial Components）</a>を削除・縮小することで、スタイルの容量は194KBから10KBに低下します。</p>
<p>他にも、依存関係の影響と実用的な選択肢について、十分な情報に基づいた意思決定に役立つ数多くのツールが存在します。</p>
<ul>
<li><a href="https://www.npmjs.com/package/webpack-bundle-analyzer">webpack-bundle-analyzer</a></li>
<li><a href="https://github.com/danvk/source-map-explorer">Source Map Explorer</a></li>
<li><a href="https://github.com/samccone/bundle-buddy">Bundle Buddy</a></li>
<li><a href="https://bundlephobia.com/">Bundlephobia</a></li>
<li><a href="https://webpack.github.io/analyse/">Webpack analyze</a>は、特定のモジュールがバンドルに含まれている理由を明らかにします。</li>
<li><a href="https://www.npmjs.com/package/bundle-wizard">bundle-wizard</a>はページ全体の依存関係のマップを構築します。</li>
<li><a href="https://github.com/GoogleChromeLabs/size-plugin">Webpack size-plugin</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=wix.vscode-import-cost">Import Cost for Visual Code</a></li>
</ul>
<p>あるいは、フレームワーク全体を提供するために、フレームワークを縮小し、追加コードを必要としない<strong>生のJavaScriptバンドル</strong>にコンパイルするという手もあります。
<a href="https://svelte.technology/">Svelte</a>と<a href="https://github.com/sokra/rawact">Rawact Babelプラグイン</a>ならばそれが可能です。
Rawact Babelプラグインは、ビルド時にReact.jsコンポーネントをネイティブDOMオペレーションにトランスパイルします。
なぜでしょうか。
メンテナの説明によれば、「React DOMには、段階的レンダリング、スケジューリング、イベントハンドリングなど、レンダリングされる可能性がある全てのコンポーネントやHTML要素のコードが含まれます。
しかし、これら全ての機能を（初期のページ読み込み時には）必要としないアプリケーションもあります。
こうしたアプリケーションにとっては、インタラクティブなUIをビルドするのにネイティブDOMオペレーションを使用するのが合理的かもしれません。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/8f110101-2f0b-4da2-aaee-746209ee9d68/14-size-limit-front-end-performance-checklist-2020.png">
<em><a href="https://github.com/ai/size-limit">size-limit</a>は、基本的なバンドル容量のチェック機能とともに、JavaScriptの実行時間を詳しく調べる機能を提供します。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/8f110101-2f0b-4da2-aaee-746209ee9d68/14-size-limit-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</em></p>
<h3>38. パーシャルハイドレーションを使用するか？</h3>
<p>アプリケーションで使用するJavaScriptの量が増えるにつれて、クライアントに送信する量を可能な限り小さくする手段を探す必要が出てきます。
その手段の1つが、この記事ですでに簡単に触れた<a href="https://medium.com/%40luke_schmuke/how-we-achieved-the-best-web-performance-with-partial-hydration-20fab9c808d5">パーシャルハイドレーション</a>です。
考え方はとてもシンプルです。
サーバサイドレンダリング（SSR）を実施し、アプリケーション全体をクライアントに送る代わりに、
アプリケーションのJavaScriptのごく一部をクライアントに送り、ハイドレーションするのです。
これは、複数のレンダリングのルートを持つ、複数のとても小規模なReactアプリケーションが、そのアプリケーション以外は静的なWebサイトで機能していると考えることができます。</p>
<p>Lukas Bombachは、<a href="https://medium.com/%40luke_schmuke/how-we-achieved-the-best-web-performance-with-partial-hydration-20fab9c808d5">"The case of partial hydration (with Next and Preact)"</a>という記事で、Welt.de（ドイツのニュースサイトの1つ）のチームが、パーシャルハイドレーションによってどのようにパフォーマンスを改善したかを説明しています。<a href="https://github.com/LukasBombach/next-super-performance">next-super-performance</a>というGitHubリポジトリにも説明とコードスニペットが掲載されています。</p>
<p>別の選択肢として、以下も検討できます。</p>
<ul>
<li><a href="https://markus.oberlehner.net/blog/building-partially-hydrated-progressively-enhanced-static-websites-with-isomorphic-preact-and-eleventy/">PreactとEleventyによるパーシャルハイドレーション</a></li>
<li><a href="https://github.com/midudev/react-rendering-strategies">React GitHubリポジトリにおけるプログレッシブハイドレーション</a></li>
<li><a href="https://markus.oberlehner.net/blog/how-to-drastically-reduce-estimated-input-latency-and-time-to-interactive-of-ssr-vue-applications/">Vue.jsにおける遅延ハイドレーション</a>（<a href="https://github.com/maoberlehner/how-to-drastically-reduce-estimated-input-latency-and-time-to-interactive-of-ssr-vue-applications">GitHubリポジトリ</a>）</li>
<li>クリティカルではないリソース（コンポーネント、エンベッドなど）を、それを必要とするUIとユーザのインタラクション時に遅延読み込みするための<a href="https://calendar.perfplanet.com/2020/optimizing-performance-with-the-import-on-interaction-pattern/">Import on Interactionパターン</a></li>
</ul>
<p>Jason Millerは、プログレッシブハイドレーションをReactで実装する方法についての実用的なデモを公表しており、
<a href="https://codesandbox.io/s/progressive-hydration-react-1-k65r2">デモ1</a>、
<a href="https://codesandbox.io/s/progressive-hydration-react-2-2hprz">デモ2</a>、
<a href="https://codesandbox.io/s/progressive-hydration-react-3-geyzs">デモ3</a>をすぐに使用できます
（<a href="https://github.com/GoogleChromeLabs/progressive-rendering-frameworks-samples">GitHubでも利用可能</a>）。
react-prerendered-componentライブラリもチェックしてみましょう。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/3ae9f9db-97ee-41b9-824b-35d27edc6689/import-on-interation-addy-osmani.png">
<em>ファーストパーティのコード向けの<a href="https://addyosmani.com/blog/import-on-interaction/">Import On Interaction</a>は、インタラクションの前にリソースを先読みできない場合にのみ実行すべきです。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/3ae9f9db-97ee-41b9-824b-35d27edc6689/import-on-interation-addy-osmani.png">プレビューを拡大</a>）</em></p>
<h3>39. ReactやSPA向けの戦略を最適化しているか？</h3>
<p>シングルページアプリケーションのパフォーマンスに関して、困っていることはありませんか。
Jeremy Wagnerは、さまざまな端末に対する<a href="https://css-tricks.com/radeventlistener-a-tale-of-client-side-framework-performance/">クライアントサイドのフレームワークのパフォーマンスの影響を調査</a>し、
それが意味することや、フレームワークを使用するときに気を付けたいガイドラインに焦点を当てています。
調査を踏まえて<a href="https://css-tricks.com/radeventlistener-a-tale-of-client-side-framework-performance/#conclusion">JeremyがReactフレームワーク向けに提案するSPA戦略</a>は以下となります
（ただし、他のフレームワークでも大きくは変わらないでしょう）。</p>
<ul>
<li>可能な場合は常に、ステートフルなコンポーネントを<strong>ステートレスなコンポーネント</strong>にリファクタリングします。</li>
<li>サーバの応答時間を最小限にするため、可能な場合はステートレスなコンポーネントをプリレンダリングします。サーバのみでレンダリングを行います。</li>
<li>シンプルなインタラクティブ性があるステートフルなコンポーネントについては、そのコンポーネントのプリレンダリングやサーバサイドレンダリングを検討し、インタラクティブ性を<strong>フレームワークに依存しないイベントリスナ</strong>に置き換えます。</li>
<li>ステートフルなコンポーネントをクライアント側でハイドレートする必要がある場合、表示やインタラクション時の遅延ハイドレーションを使用しましょう。</li>
<li>遅延ハイドレーションを行うコンポーネントについては、<code class="language-text">requestIdleCallback</code>を使用して、メインスレッドのアイドルタイムの間にハイドレーションをスケジューリングします。</li>
</ul>
<p>他にも、調査やレビューに値するかもしれない戦略はいくつか存在します。</p>
<ul>
<li><a href="https://calendar.perfplanet.com/2019/the-unseen-performance-costs-of-css-in-js-in-react-apps/">ReactアプリケーションのCSS-in-JSのパフォーマンスに関する検討事項</a>。</li>
<li>動的インポートと遅延ハイドレーションを使用して、必要なときにのみポリフィルを読み込むことで、<a href="https://medium.com/ne-digital/how-to-reduce-next-js-bundle-size-68f7ac70c375">Next.jsのバンドル容量</a>を削減できます。</li>
<li><a href="https://levelup.gitconnected.com/secrets-of-javascript-a-tale-of-react-performance-optimization-and-multi-threading-9409332d349f">Secrets of JavaScript: A tale of React, Performance Optimization and Multi-threading</a>は、Reactによってユーザインタフェースの課題を改善することをテーマとした長大な全7回のシリーズ記事です。</li>
<li><a href="https://www.debugbear.com/blog/measuring-react-app-performance">Reactのパフォーマンスを測定する方法</a>と<a href="https://building.calibreapp.com/debugging-react-performance-with-react-16-and-chrome-devtools-c90698a522ad">Reactアプリケーションをプロファイリングする方法</a>。</li>
<li>Alex Holachekは<a href="https://www.youtube.com/watch?v=JDDxR1a15Yo&#x26;feature=youtu.be&#x26;t=10664">Building mobile-first web animations in React</a>という素晴らしい講演を実施しています。[スライド(https://mobile-first-animation.netlify.app/)]と<a href="https://github.com/aholachek/mobile-first-animation">GitHubリポジトリ</a>も公開されています（このTipsを教えてくれたAddyに感謝します）。</li>
<li>webpack-libs-optimizationsという優れたGitHubリポジトリには、Webpack固有のパフォーマンス関連の最適化に役立つツールが数多く含まれています。メンテナは<a href="https://twitter.com/iamakulov">Ivan Akulov</a>です。</li>
<li><a href="https://3perf.com/blog/notion/">React performance improvements in Notion</a>は、Reactにおけるパフォーマンスの改善方法に関して、Ivan Akulovが執筆したガイドです。アプリケーションを約30％高速化するための便利なアドバイスが数多く紹介されています。</li>
<li><a href="https://github.com/pmmmwh/react-refresh-webpack-plugin">React Refresh Webpack Plugin（試験的なプラグイン）</a>は、コンポーネントの状態を保存するホットリロードを可能にするもので、フックと関数コンポーネントをサポートしています。</li>
<li><a href="https://reactjs.org/blog/2020/12/21/data-fetching-with-react-server-components.html">zero-bundle-size React Server Components</a>に注目しましょう。これは新たに提案された種類のコンポーネントで、バンドル容量に影響を与えません。プロジェクトは現在開発中ですが、コミュニティからのフィードバックは大歓迎です（Sophie Alpertによる素晴らしい説明はこちら）。</li>
</ul>
<h3>40. JavaScriptチャンクの予測的な先読みを使用しているか？</h3>
<p>JavaScriptチャンクを先読みするタイミングの決定には、経験則を利用することができます。
<a href="https://github.com/guess-js/guess">Guess.js</a>は、Google Analyticsのデータを利用して、
ユーザがあるページの<strong>次にアクセスする可能性が最も高いページ</strong>を判断する一連のツールとライブラリです。
Google Analyticsなどのソースから収集したユーザの操作パターンに基づき、Guess.jsは機械学習モデルを構築し、
それぞれの後続ページで必要とされるJavaScriptの予測・先読みを行います。</p>
<p>したがって、あらゆるインタラクティブな要素はエンゲージメントの確率スコアを付与され、そのスコアに基づいて、クライアントサイドのスクリプトが事前のリソースの先読みを決定します。
このテクニックは<a href="https://github.com/mgechev/guess-next">Next.jsアプリケーション</a>、
<a href="https://blog.mgechev.com/2018/03/18/machine-learning-data-driven-bundling-webpack-javascript-markov-chain-angular-react/">Angular、React</a>に統合できます。
設定プロセスを自動化する<a href="https://github.com/guess-js/guess/tree/master/packages/guess-webpack">Webpackプラグイン</a>も存在します。</p>
<p>もちろん、ブラウザに不必要なデータを処理させたり、望ましくないページを先読みさせたりしてしまうこともあるでしょう。
ですから、先読みするリクエストの数をかなり保守的に設定するのは良いアイデアです。
優れたユースケースとしては、チェックアウトに必要な検証用スクリプトを先読みすることや、
クリティカルなコール・トゥ・アクション（CTA）がビューポートに表示されたときに投機的先読みを行うことが挙げられます。</p>
<p>もっと素朴なツールが必要な方には、<a href="https://www.npmjs.com/package/dnstradamus">DNStradamus</a>が役立ちます。
これはビューポートに表示されるアウトバウンドリンクのDNSの先読みを行うものです。
<a href="https://github.com/GoogleChromeLabs/quicklink">Quicklink</a>、InstantClick、<a href="https://instant.page/">Instant.page</a>という小規模なライブラリは、
次のページのナビゲーションの読み込みを高速化するために、アイドルタイムの間にビューポートの<strong>リンクを自動的に先読み</strong>します。
QuicklinkはReact RouterのルートとJavaScriptの先読みを可能にします。
さらに、データ通信の容量を考慮するため、2Gや<code class="language-text">Data-Saver</code>がオンの場合は先読みを行いません。
Instant.pageも、モードがビューポート先読み（デフォルト）に設定されている場合は同様に動作します。</p>
<p>予測的な先読みの仕組みを詳しく知りたい場合は、
Divya Tagtachianの<a href="https://www.youtube.com/watch?v=UwjzFGCAuLw&#x26;list=PLSmH2HL6l9pwQmSgpKFtWiISOXua3zq8I&#x26;index=16">The Art of Predictive Prefetch</a>という素晴らしい講演がお勧めです。
全ての選択肢が初めから終わりまで紹介されています。</p>
<h3>41. ターゲットとするJavaScriptエンジンの最適化を利用する。</h3>
<p>自社サイトのユーザ層で多数を占めるJavaScriptエンジンを調査し、そのエンジン向けに最適化する方法を探求しましょう。
例えば、Blinkブラウザ、Node.jsランタイム、Electronで使用されるV8向けに最適化するときは、
モノリシックなスクリプト向けの<a href="https://blog.chromium.org/2015/03/new-javascript-techniques-for-rapid.html">スクリプトストリーミング</a>を利用します。</p>
<p>スクリプトストリーミングは、ダウンロードが始まった時点で、<code class="language-text">async</code>や<code class="language-text">defer scripts</code>を別のバックグラウンドスレッドでパースすることを可能にします。
これにより、場合によってはページの読み込み時間を最大で10％改善できます。
実務では、<code class="language-text">&lt;head&gt;</code>内で<a href="https://medium.com/reloading/javascript-start-up-performance-69200f43b201#3498"><code class="language-text">&lt;script defer&gt;</code>を使用</a>することにより、
<a href="https://medium.com/reloading/javascript-start-up-performance-69200f43b201#3498">ブラウザがリソースを早く発見</a>し、バックグラウンドスレッドでリソースをパースできるようにしましょう。</p>
<p><strong>注意点</strong>：<a href="https://caniuse.com/#search=defer">Opera Miniはスクリプト遅延をサポートしていません</a>。
そのため、インドやアフリカ向けに開発をしている場合、<code class="language-text">defer</code>は無視され、スクリプトの評価が終わるまでレンダリングをブロックすることとなります（Jeremyに感謝します）。</p>
<p>ライブラリとそれを利用するコードを分離して、<a href="https://v8.dev/blog/code-caching-for-devs">V8のコードキャッシング</a>を使用することもできます。
あるいは逆に、ライブラリとその用途を1つのスクリプトにマージし、小さいファイルを一緒にグループ化し、インラインスクリプトを回避することも可能です。
<a href="https://www.npmjs.com/package/v8-compile-cache">v8-compile-cache</a>を使用するのも良いかもしれません。</p>
<p>JavaScript全般に関しては、他にも覚えておくべき実務上のポイントがあります。</p>
<ul>
<li><a href="https://github.com/ryanmcdermott/clean-code-javascript">JavaScript向けのClean Codeコンセプト</a>では、読みやすく、再利用しやすく、リファクタリング可能なコードを書くための大量のパターンを紹介しています。</li>
<li><a href="https://wicg.github.io/compression/">CompressionStream APIを使用して、JavaScriptからのデータを圧縮する</a>ことができます。例えば、データのアップロード前にgzip形式で圧縮するなどの使い方があります（Chrome 80以降）。</li>
<li><a href="https://web.dev/detached-window-memory-leaks/">Detached window memory leaks</a>と<a href="https://nolanlawson.com/2020/02/19/fixing-memory-leaks-in-web-applications/">Fixing memory leaks in web apps</a>は、厄介なJavaScriptのメモリリークを発見・修正する方法に関する詳しいガイドです。さらに、DevToolsのConsoleから<a href="https://twitter.com/mathias/status/1231165158514405377">queryObjects(SomeConstructor)</a>を使用することも可能です（Mathiasに感謝します）。</li>
<li><a href="https://twitter.com/iamakulov/status/1331551351214645251">再エクスポートは読み込みとランタイムのパフォーマンスに悪影響を与えます</a>。これを回避することで、バンドルの容量を<a href="https://twitter.com/iamakulov/status/1331551364636413953">大幅に</a>削減できます。</li>
<li><code class="language-text">options</code>パラメータにフラグを設定することで、<a href="https://developers.google.com/web/updates/2016/06/passive-event-listeners">パッシブイベントリスナによってスクロールのパフォーマンスを改善できます</a>。これによりブラウザは、リスナが終了した後ではなく、即座にページをスクロールすることが可能です（Kayce Basquesより）。</li>
<li><code class="language-text">scroll</code>リスナや<code class="language-text">touch*</code>リスナを設定しているなら、<code class="language-text">passive: true</code>をaddEventListenerにパスしましょう。これはブラウザに対し、内部でe<code class="language-text">vent.preventDefault()</code>を呼び出す予定がないことを伝え、ブラウザがイベントを処理する方法を最適化できるようにするものです（<a href="https://twitter.com/iamakulov/status/1275858862801850370">Ivan Akulov</a>より）。</li>
<li><a href="https://web.dev/isinputpending/">isInputPending()を使用することで、JavaScriptのスケジューリングを改善できます</a>。この新たなAPIは、Web上でのユーザ入力に対する割り込みというコンセプトによって、読み込みと応答のギャップを埋めようとするものです。これによりJavaScriptは、ブラウザよりも優先的に入力をチェックすることができます。</li>
<li><a href="https://twitter.com/umaar/status/1273607178826452992">イベントリスナの実行が終わった後は、それを削除する</a>ことも可能です。</li>
<li>Firefoxが最近リリースした、<a href="https://twitter.com/mozhacks/status/1327280031106801664">SpiderMonkeyの大幅なアップデートであるWarp</a>（Firefox 83に実装）、<a href="https://hacks.mozilla.org/2019/08/the-baseline-interpreter-a-faster-js-interpreter-in-firefox-70/">Baseline Interpreter</a>や、いくつかのJIT最適化戦略も利用できます。</li>
</ul>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/2695b593-d0da-416a-94c2-d94145f92079/isinputpending-opt.png">
新たなブラウザAPIである<a href="https://web.dev/isinputpending/">isInputPending()</a>は読み込みと応答のギャップを埋めようとするものです。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/2695b593-d0da-416a-94c2-d94145f92079/isinputpending-opt.png">プレビューを拡大</a>）</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/abc86cd5-4c43-4382-9ba8-c8b81ec1d8e5/requestmap-http-cnn-com.png"><a href="https://domainmap.webperf.tools/render/190223_BN_18cef49f92088f84fbba5b96f7fd54cd/">CNN.comのリクエストマップ</a>は、各リクエストから異なるドメインへのチェーンを示しており、最大で8次のパーティのスクリプトまで表示されています。<a href="https://dougsillars.com/2019/02/27/4th-parties-uninvited-guests-to-your-site/">出典はこちら</a>。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/abc86cd5-4c43-4382-9ba8-c8b81ec1d8e5/requestmap-http-cnn-com.png">プレビューを拡大</a>）</p>
<h3>42. いつでもサードパーティアセットはなるべくセルフホストする。</h3>
<p>繰り返しになりますが、<a href="https://csswizardry.com/2019/05/self-host-your-static-assets/">静的アセットはセルフホストする</a>ことをデフォルトにしましょう。
多くのサイトが同じパブリックCDNと同一バージョンのJavaScriptライブラリやWebフォントを使用していれば、
訪問者がサイトにアクセスした時点でブラウザにスクリプトとフォントがキャッシュされており、ユーザ体験が大幅に高速化されると想定するのはよくあることです。
しかし、それが<a href="https://calendar.perfplanet.com/2019/bundling-javascript-for-performance-best-practices/">実現する可能性はとても低い</a>と言えます。</p>
<p>セキュリティー上の理由で、フィンガープリントを避けるために、
ブラウザは<a href="https://calendar.perfplanet.com/2019/bundling-javascript-for-performance-best-practices/">パーティション化されたキャッシング</a>を実装しています。
2013年にはSafari、<a href="https://developers.google.com/web/updates/2020/10/http-cache-partitioning">2020年にはChromeが導入</a>しました。
2つのサイトがまったく同じサードパーティのリソースのURLを指定していた場合、コードは<strong>1ドメインにつき1回ダウンロード</strong>されます。
また、キャッシュはプライバシーへの影響を考慮して、そのドメインに「サンドボックス化」されています（Calhounに感謝します）。
そのため、パブリックCDNを使用しても、自動的にパフォーマンスの改善につながるわけでは<a href="https://almanac.httparchive.org/en/2019/cdn#cdns-for-common-libraries-and-content">ありません</a>。</p>
<p>さらに、注目すべき点として、
<a href="https://calendar.perfplanet.com/2019/self-hosting-third-party-resources-the-good-the-bad-and-the-ugly/">リソースは私たちが予想するほど長くはブラウザのキャッシュに残らず</a>、
サードパーティよりもファーストパーティのアセットのほうがキャッシュにとどまりやすい傾向があります。
そのため、通常はセルフホストのほうが信頼性と安全性が高く、パフォーマンスも向上します。</p>
<h3>43. サードパーティのスクリプトの影響を抑える。</h3>
<p>あらゆるパフォーマンスの最適化を導入しても、業務上必要なサードパーティのスクリプトを制御できないことはよくあります。
サードパーティのスクリプトに関する指標はエンドユーザの体験に影響されないため、1つのスクリプトが邪魔な長いサードパーティのスクリプトを呼び出し、
パフォーマンス向上のための懸命な努力を台無しにしてしまうケースはとても多いのです。
こうしたスクリプトがもたらすパフォーマンス上のデメリットを抑制・軽減するには、<a href="https://www.twnsnd.com/posts/performant_third_party_scripts.html">読み込みと実行を遅延させる</a>ことや、
リソースヒント（<code class="language-text">dns-prefetch</code>や<code class="language-text">preconnect</code>）を通じて接続をウオームアップするだけでは不十分です。</p>
<p>現在、JavaScriptコードの実行時間全体の57％は<a href="https://github.com/patrickhulce/third-party-web">サードパーティのコードに費やされています</a>。
平均的なモバイルサイトは<strong>12個のサードパーティドメイン</strong>にアクセスし、平均で37個の異なるリクエスト（各サードパーティにつき約3個のリクエスト）を送信しています。</p>
<p>さらに、これらのサードパーティは<strong>4次のパーティのスクリプト</strong>を呼び込むことが多く、最終的にパフォーマンス上のボトルネックが非常に大きくなり、
場合によっては最大で<a href="https://dougsillars.com/2019/02/27/4th-parties-uninvited-guests-to-your-site/">8次のパーティのスクリプト</a>がページに呼び込まれることとなります。
そのため、依存関係とタグマネジャーを定期的に監査すると、思わぬ大きなコストがかかるかもしれません。</p>
<p>他の問題として、Yoav Weissは、<a href="https://conffab.com/video/taking-back-control-over-third-party-content/">サードパーティのスクリプトに関する講演</a>で、
こうしたスクリプトが動的なリソースをダウンロードするケースが多いことを挙げています。リソースはページの読み込みの間に変化するため、
どのホストからリソースがダウンロードされるか、また、そのリソースがどのようなものかが分かるとは限りません。</p>
<p>上記のとおり、遅延は単なる出発点に過ぎないかもしれません。サードパーティのスクリプトはアプリケーションから帯域幅とCPU時間も奪うからです。
もっと積極的に、<a href="https://3perf.com/blog/notion/#defer-third-parties">アプリケーションが初期化された場合にのみサードパーティのスクリプトを読み込む</a>ことにしても良いでしょう。</p>
<div class="gatsby-highlight" data-language="javasript"><pre style="counter-reset: linenumber NaN" class="language-javasript line-numbers"><code class="language-javasript">/* Before */
const App = () =&gt; {
  return &lt;div&gt;
    &lt;script&gt;
      window.dataLayer = window.dataLayer || [];
      function gtag(){...}
      gtg(&#39;js&#39;, new Date());
    &lt;/script&gt;
  &lt;/div&gt;
}

/* After */
const App = () =&gt; {
  const[isRendered, setRendered] = useState(false);

  useEffect(() =&gt; setRendered(true));

  return &lt;div&gt;
  {isRendered ?
    &lt;script&gt;
      window.dataLayer = window.dataLayer || [];
      function gtag(){...}
      gtg(&#39;js&#39;, new Date());
    &lt;/script&gt;
  : null}
  &lt;/div&gt;
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Andy Daviesは、<a href="https://andydavies.me/blog/2020/10/02/reducing-the-site-speed-impact-of-third-party-tags/">"Reducing the Site-Speed Impact of Third-Party Tags"</a>という素晴らしい記事で、
コストの特定から影響の軽減まで、サードパーティのフットプリントを最小化する戦略を追求しています。</p>
<p>Andyによれば、タグがサイトの速度に影響を与える要因は2通りです。
タグは訪問者の端末の<strong>ネットワークの帯域幅と処理時間</strong>を奪い合い、実装方法によってはHTMLパーシングを遅らせる場合もあります。
そのため、最初のステップは、<a href="https://andydavies.me/blog/2018/02/19/using-webpagetest-to-measure-the-impact-of-3rd-party-tags/">WebPageTestを使用して、スクリプトがある状態とない状態のサイトをテストし</a>、サードパーティが及ぼす影響を特定することとなります。
Simon Hearneの<a href="https://requestmap.herokuapp.com/">リクエストマップ</a>では、ページ上のサードパーティと、その容量、種類、読み込みが発生した原因を視覚化することもできます。</p>
<p><a href="https://www.twnsnd.com/posts/performant_third_party_scripts.html">セルフホストと単一のホスト名を使用する</a>ことが理想的ですが、
<a href="https://www.soasta.com/blog/10-pro-tips-for-managing-the-performance-of-your-third-party-scripts/">リクエストマップを使用</a>して4次の呼び出しを明らかにし、
スクリプトの変更を検知することも可能です。Harry Robertsの<a href="https://csswizardry.com/2018/05/identifying-auditing-discussing-third-parties/">サードパーティ監査のアプローチ</a>を使用し、
<a href="https://docs.google.com/spreadsheets/d/1uTcRSoJAkXfIm2yfG5hvCSzvSZD9fAwXNQMVK3HdPMI/edit#gid=0">このようなスプレッドシート</a>を作成することもできます
（<a href="https://www.youtube.com/watch?v=bmIUYBNKja4">Harryの監査ワークフロー</a>もチェックしましょう）。</p>
<p>その後、<strong>既存のスクリプトの軽量な代わり</strong>を探し、重複やパフォーマンス低下の主な要因をそれらよりも軽い選択肢に少しずつ置き換えていきます。
場合によっては、一部のスクリプトは<a href="https://www.tunetheweb.com/blog/adding-controls-to-google-tag-manager/#pixels">完全なタグの代わりにフォールバックのトラッキングピクセルに置き換えられる</a>かもしれません。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a4482ab7-e2d8-4333-be8b-7d49021ea109/loadyoutube-opt.jpg">
<em><a href="https://github.com/paulirish/lite-youtube-embed">lite-youtube-embed</a>などのファサードを利用したYouTubeの読み込み。実際のYouTubeプレーヤよりも容量が大幅に小さくなります。（<a href="https://web.dev/third-party-facades/">画像の出典</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a4482ab7-e2d8-4333-be8b-7d49021ea109/loadyoutube-opt.jpg">プレビューを拡大</a>）</em></p>
<p>これが不可能であっても、少なくとも<a href="https://web.dev/third-party-facades/">サードパーティのリソースをファサードで遅延読み込みする</a>ことはできます。
ファサードとは、実際に埋め込まれたサードパーティと似ているが、現実には機能せず、そのためページ読み込みの負荷が大幅に軽い静的要素を指します。
ここでのポイントは、<strong>インタラクション時にのみ、実際に埋め込まれた要素を読み込む</strong>ことです。</p>
<p>例えば、以下を使用することができます。</p>
<ul>
<li>Vimeoプレーヤ向けの<a href="https://github.com/luwes/lite-vimeo-embed">lite-vimeo-embed</a></li>
<li>Vimeoプレーヤ向けの<a href="https://github.com/slightlyoff/lite-vimeo">lite-vimeo</a></li>
<li>YouTubeプレーヤ向けの<a href="https://github.com/paulirish/lite-youtube-embed">lite-youtube-embed</a></li>
<li>ライブチャット向けの<a href="https://github.com/calibreapp/react-live-chat-loader">react-live-chat-loader</a>（ケーススタディはこちらとこちら）</li>
<li>iframe向けの<a href="https://github.com/vb/lazyframe">lazyframe</a>]</li>
</ul>
<p>一般にタグマネジャーの容量が大きい理由の1つは、多数の実験が同時並行的に、多くのユーザセグメント、ページURL、サイトに関して同一のタイミングで実行されるためです。
ですからAndyによれば、実験を減らすことで、ダウンロード容量と、ブラウザでスクリプトを実行する時間の両方を削減できます。</p>
<p>さらに<a href="https://andydavies.me/blog/2020/11/16/the-case-against-anti-flicker-snippets/">anti-flickerスニペット</a>もあります。
Google Optimize、Visual Web Optimizer（VWO）などのサードパーティは、いずれもこのスニペットを使用しています。
anti-flickerスニペットは通常、<strong>A/Bテスト</strong>を実行する際に、異なるテストシナリオ間のちらつきを回避するために挿入されます。
このスニペットはドキュメントの<code class="language-text">body</code>を<code class="language-text">opacity: 0</code>によって隠し、その数秒後に関数を呼び出して<code class="language-text">opacity</code>を元に戻すものです。
これによりクライアントサイドの実行コストが膨大になるため、レンダリングが大幅に遅れることが多くなります。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/eb036e99-1355-479a-ba70-bd3b77ac2818/gymshark-annotated.png">
A/Bテストを使用すると、顧客は図のようなちらつきを目にするケースが増えます。Anti-Flickerスニペットはこれを防ぎますが、パフォーマンスの面でコストがかかります。<a href="https://andydavies.me/blog/2020/11/16/the-case-against-anti-flicker-snippets/">Andy Davies</a>より。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/eb036e99-1355-479a-ba70-bd3b77ac2818/gymshark-annotated.png">プレビューを拡大</a>）</p>
<p>そのため、<a href="https://twitter.com/tkadlec/status/1327016687984578560">ちらつきを防ぐためのタイムアウトがどれだけ発生しているかを調査</a>し、タイムアウトを減らすことが重要です。
デフォルトではページの表示が最大で4秒ブロックされるため、コンバージョンレートは低下するでしょう。
Tim Kadlecは、「友人がクライアントサイドのA/Bテストを実行しようとしていたら止めるべきだ」と語っています。
CDN上の<strong>サーバサイドA/Bテスト</strong>（Edge Computingや<a href="https://www.youtube.com/watch?v=W-tBI_n0m_w">Edge Slice Rerendering</a>など）のパフォーマンスは、クライアントサイドよりも常に高いと言えます。</p>
<p>「全能」の<strong>Google Tag Manager</strong>を使用する場合は、
Barry Pollardの<a href="https://www.tunetheweb.com/blog/adding-controls-to-google-tag-manager/">Google Tag Managerの影響を抑えるためのガイドライン</a>をチェックしましょう。
また、Christian Schaeferは<a href="https://schepp.dev/posts/ad-integration-in-2020/">広告の読み込み戦略について追求しています</a>。</p>
<p>注意すべき点として、<a href="https://twitter.com/blue2blond/status/1262309544757207040">一部のサードパーティウィジェットは監査ツールから身を隠す</a>ため、
発見・測定が比較的難しいかもしれません。<a href="https://csswizardry.com/2017/07/performance-and-resilience-stress-testing-third-parties/">サードパーティのストレステストを実施する</a>には、
DevToolsのPerformanceプロファイルページのボトムアップサマリーを調べ、リクエストがブロックされた場合やタイムアウトした場合に何が起きるかをテストしましょう。
後者については、hostsファイル内において、特定のドメインへのリクエストをWebPageTestのBlackholeサーバ（blackhole.webpagetest.org）に送信するように設定すれば良いでしょう。</p>
<p>選択肢の1つとして、<strong>サービスワーカーを使用し、タイムアウト付きのリソースのダウンロードを高速化する</strong>ことを検討してみましょう。
リソースが特定のタイムアウトまでに応答しない場合、空の応答を返し、ブラウザにページのパースを続けさせます。
うまく機能していないサードパーティのリクエストや、特定の基準を満たさないサードパーティのリクエストは、記録やブロックをすることができます。
可能であれば、サードパーティのスクリプトをベンダのサーバから遅延読み込みするのではなく、
<a href="https://medium.com/caspertechteam/we-shaved-1-7-seconds-off-casper-com-by-self-hosting-optimizely-2704bcbff8ec">自分のサーバから読み込む</a>ようにしましょう。</p>
<p>他の選択肢として、サードパーティのスクリプトの影響を制限するための<strong>コンテンツセキュリティーポリシー（CSP）</strong>（音声や動画のダウンロードを許可しないなど）を定めることが挙げられます。
最善の選択肢は、<code class="language-text">&lt;iframe&gt;</code>を通じてスクリプトを埋め込み、iframeのコンテキスト内でスクリプトを実行することで、
スクリプトがページのDOMにアクセスできず、ドメイン上の任意コード実行もできないようにすることです。
iframeは、<code class="language-text">sandbox</code>属性を使用して制約を強化することもできます。
これにより、例えばスクリプトの実行、アラート、フォームの提出、プラグイン、トップナビゲーションへのアクセスなど、iframeが実行する可能性がある任意の機能を無効化することが可能です。</p>
<p><a href="https://timkadlec.com/remembers/2020-02-20-in-browser-performance-linting-with-feature-policies/">Feature Policyによるブラウザ内のパフォーマンスリント</a>を通じたサードパーティのコントロールもできます。
これは比較的新しい機能で、サイト上で特定のブラウザ機能のオプトインやオプトアウトを選択することが可能です。
（ちなみに、寸法が大き過ぎる画像や最適化されていない画像、寸法が適切でないメディア、同期型のスクリプトなどを回避するためにも使用できます）。
現在はBlinkベースのブラウザでサポートされています。</p>
<div class="gatsby-highlight" data-language="http"><pre style="counter-reset: linenumber NaN" class="language-http line-numbers"><code class="language-http">/* Via Tim Kadlec. https://timkadlec.com/remembers/2020-02-20-in-browser-performance-linting-with-feature-policies/ */
/* Block the use of the Geolocation API with a Feature-Policy header. */
<span class="token header-name keyword">Feature-Policy:</span> geolocation 'none'</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>多くのサードパーティのスクリプトはiframeで実行されるため、権限を徹底的に制限する必要があるでしょう。
<a href="https://www.html5rocks.com/en/tutorials/security/sandboxed-iframes/">iframeをサンドボックス化するのは常に良いアイデアと言えます</a>。
それぞれの制約は<code class="language-text">sandbox</code>属性の複数の<code class="language-text">allow</code>値を通じて解除できます。<a href="https://caniuse.com/#search=sandbox">サンドボックスはほとんどの場所でサポートされています</a>。
ですから、サードパーティのスクリプトの権限を、許可すべき必要最低限まで制限しましょう。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/eefa9eb3-1d15-484e-acaa-3060be1c4b5e/third-party-impact-opt.png"><a href="https://www.thirdpartyweb.today/">ThirdPartyWeb.Today</a>は、全てのサードパーティのスクリプトをカテゴリ（アナリティクス、ソーシャル、広告、ホスティング、タグマネジャーなど）ごとにグループ化し、エンティティのスクリプトの実行までにどの程度の（平均）時間がかかるかを視覚化します。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/eefa9eb3-1d15-484e-acaa-3060be1c4b5e/third-party-impact-opt.png">プレビューを拡大</a>）</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API">インターセクションオブザーバー</a>の使用を検討しましょう。
これは、イベントをディスパッチしたり、DOMから必要な情報（広告の表示と非表示など）を取得したりしつつ、<strong>広告にiframeを適用する</strong>ことを可能にします。
ブラウザを減速させる有害なWeb機能やスクリプト（同期スクリプト、同期XHRリクエスト、document.write、時代遅れの実装など）を制限するために、
<a href="https://www.smashingmagazine.com/2018/12/feature-policy/">Feature policy</a>などの新たなポリシー、リソース容量の制限、CPU/帯域幅の優先順位に注目しましょう。</p>
<p>最後に、サードパーティのサービスを選ぶときは、Patrick Hulceの<a href="https://www.thirdpartyweb.today/">ThirdPartyWeb.Today</a>をチェックすることを検討してください。
このサービスは、全ての<strong>サードパーティのスクリプトをカテゴリ（アナリティクス、ソーシャル、広告、ホスティング、タグマネジャーなど）ごとにグループ化</strong>し、
各エンティティのスクリプトの実行までにどの程度の（平均）時間がかかるかを視覚化します。
もちろん、最大のエンティティがページのパフォーマンスに最も大きな悪影響を与えていることとなります。
ページをざっと読み取るだけで、想定すべきパフォーマンスのフットプリントの概要が分かります。</p>
<p>それと、パフォーマンスを減速させる「おなじみのメンバー」も忘れないでください。
シェア用のサードパーティウィジェットの代わりに<a href="https://www.savjee.be/2015/01/Creating-static-social-share-buttons/">静的なソーシャルシェアボタン</a>
（<a href="https://simplesharingbuttons.com/">SSBG</a>によるものなど）を使用したり、インタラクティブマップの代わりに
<a href="https://developers.google.com/maps/documentation/static-maps/intro">そのマップへの静的なリンク</a>を設置したりすることができます。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/cf570272-840e-4cf8-92de-76808a12422c/casper-case-study-optimizely.png"><em>Casper.comは、Optimizelyをセルフホストすることによって、サイトのレンダリング開始時間を1.7秒削減した事例の詳細なケーススタディを公表しています。これは労力に値する結果と言えるでしょう。（<a href="https://medium.com/caspertechteam/we-shaved-1-7-seconds-off-casper-com-by-self-hosting-optimizely-2704bcbff8ec">画像の出典</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/cf570272-840e-4cf8-92de-76808a12422c/casper-case-study-optimizely.png">プレビューを拡大</a>）</em></p>
<h3>44. HTTPキャッシュヘッダを適切に設定する。</h3>
<p>キャッシングをするのは当たり前に思えますが、適切なキャッシングは難しいかもしれません。<code class="language-text">expires</code>、<code class="language-text">max-age</code>、<code class="language-text">cache-control</code>などのHTTPキャッシュヘッダが適切に設定されていることをダブルチェックする必要があります。適切なHTTPキャッシュヘッダが存在しない場合、ブラウザはこれらを<a href="https://paulcalvano.com/2018-03-14-http-heuristic-caching-missing-cache-control-and-expires-headers-explained/"><code class="language-text">last-modified</code>以降の経過時間の10％</a>に自動的に設定するため、<a href="https://twitter.com/simonhearne/status/1259973084880220163">キャッシングの期間が短すぎたり、長すぎたりする</a>可能性があります。</p>
<p>一般に、リソースのキャッシュ期間は<a href="https://jakearchibald.com/2016/caching-best-practices/">とても短くする（変更される可能性が高い場合）か、無期限（静的である場合）にする</a>べきです。必要な場合は、単にURLでバージョンを変更することもできます。この戦略は<a href="https://calendar.perfplanet.com/2020/cache-forever-assets/">永久キャッシュ戦略</a>と呼べます。これは、アセットを1年間のみ保持するために、<code class="language-text">Cache-Control</code>と<code class="language-text">Expires</code>ヘッダをブラウザに中継するものです。そのため、ブラウザは、アセットがキャッシュに存在すれば、リクエストを作成する必要さえありません。
例外は<a href="https://twitter.com/iamakulov/status/1259763674409033735">APIの応答</a>（例えば<code class="language-text">/api/user</code>）です。キャッシングを防ぐには<code class="language-text">private</code>, <code class="language-text">no-store</code>を使用しましょう。<a href="https://docs.fastly.com/en/guides/configuring-caching#do-not-cache"><code class="language-text">max-age=0, no-store</code>ではないことに注意してください</a>。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">Cache-Control: private, no-store</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>ユーザが再読み込みボタンを押したときに、<a href="https://bitsup.blogspot.com/2016/05/cache-control-immutable.html">明示的な長期のキャッシュ存続期間の再検証を避ける</a>ためには、<code class="language-text">Cache-control: immutable</code>を使用しましょう。再読み込みをする場合、immutableによってHTTPリクエストを省略できます。多数の304応答と競合しなくなるため、動的HTMLの読み込み時間を改善することが可能です。</p>
<p><code class="language-text">immutable</code>の使用に適した典型的な例は、その名称にハッシュが含まれているCSS/JavaScriptアセットです。これらは可能な限り長くキャッシュし、二度と再検証されないようにしたい場合が多いでしょう。
<code class="language-text">Cache-Control: max-age= 31556952, immutable</code>
Colin Bendellの調査によれば、<code class="language-text">immutable</code>は<a href="https://twitter.com/colinbendell/status/1256218497941635072">304リダイレクトを約50％削減</a>します。これは<code class="language-text">max-age</code>を使用していても、依然として更新時にクライアント側で再検証とブロックが行われるためです。immutableは<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control">Firefox、Edge、Safariでサポート</a>されており、<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=611416#c70">Chromeでは対応を検討中です</a>。</p>
<p>Web Almanacによれば、「使用率は<a href="https://almanac.httparchive.org/en/2020/caching">3.5％まで上昇</a>し、<a href="https://discuss.httparchive.org/t/cache-control-immutable-a-year-later/1195">FacebookとGoogleへのサードパーティ応答</a>に広く使われています」。</p>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/231b0c68-fec1-45ec-b511-6b8c203a6420/effectiveness-cache-control-immutable.jpg"></p>
<p>あなたは昔ながらの<a href="https://www.fastly.com/blog/stale-while-revalidate-stale-if-error-available-today">stale-while-revalidate</a>を覚えているでしょうか。<code class="language-text">Cache-Control</code>応答ヘッダ（例：<code class="language-text">Cache-Control: max-age=604800</code>）でキャッシュ時間を指定した場合、<code class="language-text">max-age</code>が期限を迎えた後、ブラウザはリクエストされたコンテンツを再取得するため、ページの読み込みが遅くなります。こうした減速は<code class="language-text">stale-while-revalidate</code>によって回避できます。これは基本的に、追加的な時間枠を定め、その間はキャッシュが（バックグラウンドにおいて非同期で再検証を行うという条件で）古いアセットを使用できるようにするものです。このように、レイテンシを（ネットワークとサーバの両方で）クライアントから「隠す」のです。</p>
<p>2019年6～7月、<strong>ChromeとFirefoxはHTTP Cache-Controlヘッダにおける</strong><code class="language-text">stale-while-revalidate</code><strong>のサポートを開始しました</strong>。これにより、古いアセットはクリティカルパスに存在しなくなるため、次のページを読み込む際のレイテンシが改善する見込みでした。結果として、<a href="https://twitter.com/RyanTownsend/status/1072443651844911104">繰り返し表示した場合のRTTは0</a>となりました。</p>
<p><a href="https://www.smashingmagazine.com/2017/11/understanding-vary-header/">Varyヘッダ</a>は、特に<a href="https://www.fastly.com/blog/getting-most-out-vary-fastly">CDNとの関連</a>で警戒が必要です。<a href="https://httpwg.org/http-extensions/draft-ietf-httpbis-variants.html">HTTP Representation Variants</a>にも注目しましょう。これは、新たなリクエストが過去のリクエストと（大きくは違わないが）少し違うときに、検証のための追加的なラウンドトリップを回避するのに役立ちます（GuyとMarkに感謝します）。</p>
<p>また、<a href="https://www.fastly.com/blog/headers-we-dont-want">不要なヘッダ</a>（<code class="language-text">x-powered-by</code>、<code class="language-text">pragma</code>、<code class="language-text">x-ua-compatible</code>、<code class="language-text">expires</code>、<code class="language-text">X-XSS-Protection</code>など）を送信していないことや、<a href="https://www.fastly.com/blog/headers-we-want">便利なセキュリティヘッダやパフォーマンスヘッダ</a>（<code class="language-text">Content-Security-Policy</code>、<code class="language-text">X-Content-Type-Options</code>など）が含まれていることをダブルチェックしましょう。最後に、シングルページアプリケーションにおける<a href="https://medium.com/%40ankur_anand/the-terrible-performance-cost-of-cors-api-on-the-single-page-application-spa-6fcf71e50147">CORSリクエストのパフォーマンスコスト</a>に気をつけましょう。</p>
<p><strong>注記</strong>：キャッシュしたアセットはすぐに取得できると考えがちですが、調査によれば、<a href="https://simonhearne.com/2020/network-faster-than-cache/">オブジェクトをキャッシュから取得するには数百ミリ秒かかることがあります</a>。それどころか、Simon Hearneによれば、「場合によってはネットワークのほうがキャッシュより速いかもしれません。キャッシュされたアセットの数（ファイルの容量ではない）が大量である場合、ユーザの端末によっては、キャッシュからアセットを取得するのには大きなコストがかかる可能性があります。例えば、Chrome OSの平均的なキャッシュ取得時間は、キャッシュされたリソースが5個である場合は約50ミリ秒で、リソースが25個の場合は約100ミリ秒に倍増します」。</p>
<p>さらに、バンドルの容量は大きな問題ではないと考えられがちですが、ユーザはバンドルを一度にダウンロードしてからキャッシュされたバージョンを使用します。また、CI/CDではコードを本番環境に毎日数回プッシュし、<a href="https://twitter.com/csswizardry/status/1261091962280706050">キャッシュが毎回無効化される</a>ため、キャッシングについて戦略を立てるのは重要です。</p>
<p>キャッシングに関しては、一読に値するリソースが豊富に存在します。</p>
<ul>
<li>Harry Robertsの<a href="https://csswizardry.com/2019/03/cache-control-for-civilians/">Cache-Control for Civilians</a>は、キャッシングに関するあらゆるテーマを詳しく扱っています。</li>
<li><a href="https://devcenter.heroku.com/articles/increasing-application-performance-with-http-cache-headers">HerokuのHTTPキャッシングヘッダ入門</a>。</li>
<li>Jake Archibaldの<a href="https://jakearchibald.com/2016/caching-best-practices/">Caching Best Practices</a>。</li>
<li>Ilya Grigorikの<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=en">HTTPキャッシング入門</a>。</li>
<li>Jeff Posnickの<a href="https://web.dev/stale-while-revalidate/">stale-while-revalidateでデータを新鮮に保つ方法</a>。</li>
<li>Lydia Hallieの<a href="https://dev.to/lydiahallie/cs-visualized-cors-5b8h">CS Visualized: CORS</a>は、CORS、その仕組み、それを理解する方法に関する素晴らしい解説記事です。</li>
<li>CORSに関しては、Eric Portisの記事で<a href="https://css-tricks.com/i-learned-to-love-the-same-origin-policy/">同一オリジンポリシー</a>について簡単に復習できます。</li>
</ul>
<p><img src="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0ab1567c-ba71-4274-922d-dc9a97275c6a/cache-retrieval-time.png">
ブラウザはキャッシュしたアセットをすぐに取得できると考えられがちですが、データによれば、オブジェクトをキャッシュから取得するには数百ミリ秒かかることがあります。Simon Hearneによる<a href="https://simonhearne.com/2020/network-faster-than-cache/">When Network Is Faster Than Cache</a>の調査より。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0ab1567c-ba71-4274-922d-dc9a97275c6a/cache-retrieval-time.png">プレビューを拡大</a>）
＜<a href="/front-end-performance-2021-checklist-3/#06">後編に続く</a>＞</p>
<p><em>※編注：本記事は2021年4月時点に公開されていた原文記事を翻訳した内容となります。翻訳記事公開にあたり、2023年6月時点で原文にてリンク切れとなっている箇所の削除や注記、原文に現在表示されていない内容を掲載している場合がございます。ご了承ください。</em></p>]]></content:encoded></item><item><title><![CDATA[フロントエンドパフォーマンスのチェックリスト2021年版（PDF、Apple Pages、MS Word）-前編]]></title><description><![CDATA[クイックサマリー：2021年のWebパフォーマンスを高速化しましょう。
毎年恒例のフロントエンドパフォーマンスのチェックリスト（PDF、Apple Pages、MS Wordに対応）は、指標やツール…]]></description><link>https://postd.cc/front-end-performance-2021-checklist-1/</link><guid isPermaLink="false">https://postd.cc/front-end-performance-2021-checklist-1/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[パフォーマンス]]></category><pubDate>Wed, 31 May 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p><strong>クイックサマリー</strong>：2021年のWebパフォーマンスを高速化しましょう。
毎年恒例のフロントエンドパフォーマンスのチェックリスト（<a href="https://www.dropbox.com/s/34noajrbm324iai/performance-checklist-1.4.pdf?dl=0">PDF</a>、<a href="https://www.dropbox.com/s/ikuk5ikcxxv39uu/performance-checklist-1.4.pages?dl=0">Apple Pages</a>、<a href="https://www.dropbox.com/scl/fi/s7ctdj89zd5zlvtt7dkhi/performance-checklist-1.4.docx?dl=0&#x26;rlkey=2xzs55e3kdg1jcraw5u1tnpl8">MS Word</a>に対応）は、指標やツールからフロントエンドのテクニックに至るまで、現代のWebで高速なユーザ体験を生み出すために知る必要があるすべてを提供します。
このチェックリストは2016年から更新を続けてきました。
<a href="https://www.smashingmagazine.com/the-smashing-newsletter/">メールのニュースレターでも、フロントエンドに関する便利な情報をご確認いただけます</a>。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>このガイドは、<a href="https://logrocket.com/?utm_source=smashing&#x26;utm_medium=syndication&#x26;utm_campaign=sm_q12021#utm_source=smashing&#x26;utm_medium=syndication&#x26;utm_campaign=sm_q12021">LogRocket</a>に勤務する筆者の友人の厚意によるサポートを受けています。
LogRocketは、<strong>フロントエンドパフォーマンスのモニタリング</strong>、セッションリプレイ、製品分析を組み合わせ、顧客体験の向上に貢献するサービスです。
また、DOM完了時間、サーバ初期応答時間（TTFB）、初回入力までの遅延時間（FID）、クライアントのCPUとメモリの利用状況などの重要な指標を追跡します。
LogRocketの無料トライアルは<a href="https://logrocket.com/?utm_source=smashing&#x26;utm_medium=syndication&#x26;utm_campaign=sm_q12021#utm_source=smashing&#x26;utm_medium=syndication&#x26;utm_campaign=sm_q12021">こちら</a>です。</p></div></div>
<p>Webパフォーマンスは厄介な代物だと思いませんか。
どうすれば現在のパフォーマンスを実際に知ることができるのでしょう。
いったい何がパフォーマンスのボトルネックになっているのでしょうか。
読み込みに時間がかかるJavaScriptか、表示が遅いWebフォントか、サイズが大きい画像か、それとも緩慢なレンダリングでしょうか。
果たして私たちは、ツリーシェイキング、スコープホイスティング、コード分割による最適化や、インターセクションオブザーバー、プログレッシブハイドレーション、クライアントヒント、HTTP/3、サービスワーカー、さらにはエッジワーカーによる、手の込んだ読み込みパターンを使用した最適化を十分に行っているでしょうか。
そして最も重要な点として、<strong>いったいどこからパフォーマンス改善に手をつけ</strong>、どのように長期にわたってパフォーマンスを重視する文化を確立すればよいのでしょうか。</p>
<p>かつては、パフォーマンスは通常、あくまで後で考えるものでした。
プロジェクトの最後の最後まで後回しにされた結果、最小化、連結、アセットの最適化に加え、
場合によりサーバのconfigファイルにいくつかの微調整を加えるだけで済むことが珍しくありませんでした。
いま振り返ってみると、状況はずいぶん変わったように感じられます。</p>
<p>パフォーマンスは単なる技術的な問題ではありません。
アクセシビリティやユーザビリティから検索エンジン最適化に至るまで、あらゆる要素に影響を与えます。
パフォーマンスをワークフローに組み込むならば、デザインはパフォーマンスへの影響を考慮して決定する必要があります。
<strong>パフォーマンスは継続的に測定、監視、改良しなければなりません</strong>。
さらに、Webの複雑性が高まることによって新たな課題が生まれ、指標の追跡が困難になっています。
なぜなら、端末、ブラウザ、プロトコル、ネットワークのタイプとレイテンシによってデータが大きく変わるからです（CDN、ISP、キャッシュ、プロキシ、ファイアウォール、ロードバランサ、サーバのすべてがパフォーマンスに関係します）。</p>
<p>それでは、プロジェクトの最初からWebサイトの最終リリースまで、パフォーマンスを改善するときに考慮すべきことをすべてまとめた全体像を作成するとしたら、どのようなものになるでしょうか。
以下に（なるべく偏りがなく客観的な）<strong>フロントエンドパフォーマンスのチェックリスト2021年版</strong>を紹介します。
高速な反応時間と円滑なユーザインタラクションを確保し、Webサイトがユーザの帯域幅を奪わないようにするために、考慮する必要がある項目の最新情報をまとめました。</p>
<h2>目次<a href="#00">＃</a></h2>
<p><strong>前編</strong></p>
<ul>
<li><a href="#01">準備段階：計画と指標</a><br>
パフォーマンスを重視する文化、Core Web Vitals、パフォーマンスのプロファイル、CrUX、Lighthouse、FID、TTI、CLS、端末。</li>
<li><a href="#02">現実的な目標の設定</a><br>
パフォーマンスバジェット、パフォーマンス目標、RAILフレームワーク、170KB/30KBバジェット。</li>
<li><a href="#03">環境の定義</a><br>
フレームワークの選択、パフォーマンスコストの基準設定、Webpack、依存関係、CDN、フロントエンドアーキテクチャ、CSR、SSR、CSR + SSR、静的レンダリング、プリレンダリング、PRPLパターン。</li>
</ul>
<p><strong>中編</strong></p>
<ul>
<li><a href="/front-end-performance-2021-checklist-2/#04">アセットの最適化</a><br>
Brotli、AVIF、WebP、レスポンシブ画像、AV1、アダプティブメディア読み込み、動画圧縮、Webフォント、Googleフォント。</li>
<li><a href="/front-end-performance-2021-checklist-2/#05">ビルドの最適化</a><br>
JavaScriptモジュール、モジュール/ノーモジュールのパターン、ツリーシェイキング、コード分割、スコープホイスティング、Webpack、デファレンシャルサービング、Webワーカー、WebAssembly、JavaScriptバンドル、React、SPA、パーシャルハイドレーション、インポート・オン・インタラクション、サードパーティ、キャッシュ</li>
</ul>
<p><strong>後編</strong></p>
<ul>
<li><a href="/front-end-performance-2021-checklist-3/#06">デリバリの最適化</a><br>
遅延読み込み、インターセクションオブザーバー、遅延レンダリングとデコーディング、クリティカルCSS、ストリーミング、リソースヒント、レイアウトシフト、サービスワーカー。</li>
<li><a href="/front-end-performance-2021-checklist-3/#07">ネットワーク接続、HTTP/2、HTTP/3</a><br>
OCSPステープリング、EV/DV証明書、パッケージング、IPv6、QUIC、HTTP/3。</li>
<li><a href="/front-end-performance-2021-checklist-3/#08">テストとモニタリング</a><br>
監査ワークフロー、プロキシブラウザ、404ページ、GDPRに基づくcookie同意プロンプト、パフォーマンス診断CSS、アクセシビリティ。</li>
<li><a href="/front-end-performance-2021-checklist-3/#09">手軽に成果を上げる</a><br></li>
<li><a href="/front-end-performance-2021-checklist-3/#10">チェックリストのダウンロード（PDF、Apple Pages、MS Word）</a><br></li>
<li><a href="/front-end-performance-2021-checklist-3/#11">さあ、始めよう！</a><br></li>
</ul>
<p>（<a href="https://www.dropbox.com/s/34noajrbm324iai/performance-checklist-1.4.pdf?dl=0">チェックリストのPDFファイル</a>（166KB）、<a href="https://www.dropbox.com/s/ikuk5ikcxxv39uu/performance-checklist-1.4.pages?dl=0">編集可能なApple Pagesファイル</a>（275KB）、<a href="https://www.dropbox.com/scl/fi/s7ctdj89zd5zlvtt7dkhi/performance-checklist-1.4.docx?dl=0&#x26;rlkey=2xzs55e3kdg1jcraw5u1tnpl8">.docxファイル</a>（151KB）も自由にダウンロードできます。皆さんが最適化を楽しめますように！）</p>
<h2>準備段階：計画と指標 <a href="#01">#</a><a name="01"></a></h2>
<p>細かい最適化はパフォーマンスを維持するにはとても重要ですが、明確な目標を念頭に置くことも必要不可欠です。
測定可能な目標を定め、プロセス全体を通したすべての意思決定に反映させるようにしましょう。
目標設定に関してはいくつもの異なるモデルがあり、以下で紹介するモデルは筆者の独断によるものです。
早いうちに自分が何を優先するかを決めるようにしましょう。</p>
<h3>01. パフォーマンスを重視する文化を確立する。</h3>
<p>多くの組織において、フロントエンドの開発者は、共通する基本的な問題が何であるかや、それを修正するためにどんな戦略を採用すべきかをはっきりと把握しています。
しかし、パフォーマンスを重視する文化がしっかりと確立されていないと、意思決定のたびに部門同士で争いが起き、分断化した組織になってしまいます。
開発を進めるには、ビジネスのステークホルダーの支持が必要です。
支持を得るには、速度（特に、後で詳しく説明するCore Web Vitals）の向上が、ステークホルダーが関心を持っている基準や重要業績評価指標（KPI）にプラスの影響を与えるというケーススタディ、すなわち<a href="https://medium.com/%40armelpingault/how-to-convince-your-client-to-focus-on-web-performance-a-case-study-35f12385689">概念実証（PoC）</a>を確立しなければなりません。</p>
<p>パフォーマンス向上のメリットをより明確にする手段として、例えばコンバージョン率と、アプリケーション読み込み速度やレンダリングのパフォーマンスの相関を明らかにし、<a href="https://simplified.dev/performance/impact-of-web-performance">収益パフォーマンスへの影響</a>を示すことができます。
あるいは、<a href="https://drive.google.com/file/d/1o0lWk3c-d3xRuLw61jVeQwHJr_SdOCYP/view">サーチボットのクローリング率</a>（PDF、27～50ページ）を利用しても良いでしょう。</p>
<p>開発/デザインチームと業務/マーケティングチームの方向性がしっかりと一致していなければ、パフォーマンスを長く維持することはできません。
カスタマーサービスと営業チームによく寄せられる苦情を精査し、直帰率が高い場合やコンバージョン率が低下した場合は詳しく分析しましょう。
そして、パフォーマンスの向上によって、こうしたよくある問題を軽減することができないか調べてみましょう。
どのステークホルダーと話すのかに応じて、<a href="https://youtu.be/SE0HhF4TO0Q?t=1052">主張の内容を調整する</a>ことも必要です。</p>
<p>モバイルとデスクトップの両方でパフォーマンス実験を行い、結果を測定してみましょう（例えば、<a href="https://dev.to/thegreengreek/show-me-the-money-justifying-performance-improvements-using-google-analytics-3231">Google Analytics</a>などを利用できます）。
こうした実験は、現実のデータに基づき、自社に合ったケーススタディを構築するのに役立ちます。
さらに、<a href="https://wpostats.com/">WPO Stats</a>上で公表されたケーススタディと実験データを利用することで、なぜパフォーマンスが重要なのか、それがユーザ体験と業績指標にどのような影響を与えるのか、これらに対する企業の感性が磨かれます。
ただし、パフォーマンスが重要だと主張するだけでは不十分です。
測定と追跡が可能な目標を定め、それを継続的に観測する必要があります。</p>
<p>そのためには、どうすればよいのでしょうか。Allison McKnightは、<a href="https://vimeo.com/album/4970467/video/254947097">長期的なパフォーマンスの向上</a>に関する講演の中で、Etsyにおいてパフォーマンスを重視する文化の確立をどのように促進したかに関する包括的なケーススタディを紹介しています（<a href="https://speakerdeck.com/aemcknig/building-performance-for-the-long-term">スライド</a>）。
最近では、Tammy Evertsが、小規模な組織と大規模な組織の両方で<a href="https://www.youtube.com/watch?v=SE0HhF4TO0Q">非常に高いパフォーマンスを上げるチームの習慣</a>について語っています。</p>
<p>こうした対話を組織内で実施するときは、UXがさまざまな体験のスペクトルであるのと同様に、<a href="https://medium.com/firebase-developers/how-fast-should-your-site-load-cfb14be48e8b">Webパフォーマンスにも幅がある</a>という点に留意するのが重要です。
<a href="https://mailchi.mp/perf.email/56?e=7a7df41374">Karolina Szczur</a>が述べているとおり、「1つの数値だけが望ましい評価をもたらすと考えるのは誤っています」。
したがって、パフォーマンスに関する目標は、きめ細かく、追跡可能で、目に見えるものである必要があります。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9b76f03b-6b76-4d18-9c54-f1280ba3e91b/conversion-rate-tracking-performance-szptss.jpg">
<em>モバイルでは、ユーザが体験する読み込み時間が速い場合、セッション当たりの収益は平均と比べて17％増加します。（<a href="https://mailchi.mp/perf.email/56?e=7a7df41374">Addy Osmani</a>による<a href="https://simplified.dev/performance/impact-of-web-performance">Impact of Web Performance</a>からの引用）</em></p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9e69134f-4ec0-4bb7-803b-ebce880b8029/bounce-rate-time-to-app-load-opt.png">
<em>1つの数値だけが望ましい評価をもたらすと考えるのは誤っています。（画像の出典：<a href="https://mailchi.mp/perf.email/56?e=7a7df41374">Karolina Czczur</a>による<a href="https://simplified.dev/performance/impact-of-web-performance">Performance is a distribution</a>からの引用）</em></p>
<h3>02. 目標：最も速い競合サイトよりも20％以上速くなることを目指す。</h3>
<p><a href="https://www.smashingmagazine.com/2015/09/why-performance-matters-the-perception-of-time/#the-need-for-performance-optimization-the-20-rule">心理学的な調査</a>によれば、ユーザがあなたのWebサイトを競合サイトよりも速いと感じるには、比較対象との速度差が20％以上で速くなければなりません。
主要な競合サイトを調べ、こうしたサイトのモバイルとデスクトップにおけるパフォーマンス関連の指標を収集し、それらを上回るための基準値を設定しましょう。
ただし、正確な成果や目標を定めるには、まず自社サイトの分析を精査し、ユーザ体験の全体像を把握する必要があります。
その後は、90パーセンタイル値に相当するユーザ体験を再現し、テストしてみましょう。</p>
<p>競合サイトのパフォーマンスを把握する最初の一歩として、<a href="https://web.dev/fast/chrome-ux-report">Chrome UX Report</a>（CrUX。既製のRUMデータセット。Ilya Grigorikの<a href="https://vimeo.com/254834890">動画による紹介はこちら</a>、Rick Viscomiによる詳細なガイドはこちら）や、Chrome UX Reportに基づくRUMモニタリングツールである<a href="https://treo.sh/sites">Treo</a>を利用することができます。
データはChromeブラウザのユーザから収集されるため、レポートはChrome固有のものとなりますが、幅広い訪問者に関して、とても詳細なパフォーマンスの分布（最も重要なのはCore Web Vitalsのスコア）を知ることが可能です。
なお、新たなCrUXデータセットは毎月第2火曜日に公表されます。</p>
<p>他にも以下を利用することができます。</p>
<ul>
<li>Addy Osmaniの<a href="https://crux-compare.netlify.app/">Chrome UX Report Compare Tool</a></li>
<li><a href="https://www.thinkwithgoogle.com/feature/mobile/">Speed Scorecard</a>（収益への影響の推定も可能）</li>
<li><a href="https://ruxt.dexecure.com/compare">Real User Experience Test Comparison</a></li>
<li><a href="https://www.sitespeed.io/">SiteSpeed CI</a>（合成テストに基づく）</li>
</ul>
<p>注記：<a href="https://developers.google.com/speed/pagespeed/insights/">Page Speed Insights</a>や<a href="https://dev.to/addyosmani/monitoring-performance-with-the-pagespeed-insights-api-33k7">Page Speed Insights API</a>（非推奨とはなっていません）を使用する場合、CrUXのパフォーマンスデータは、単なる合計値ではなく特定ページのデータを取得できます。
このデータは、「ランディングページ」や「商品一覧」などのアセットにパフォーマンス目標を設定するときには、合計値よりもはるかに役立つ可能性があります。
バジェットのテストにCIを使用する場合において、CrUXを目標設定に使用したときは、テスト対象の環境がCrUXと一致するようにしてください（Patrick Meenanに感謝します）。</p>
<p>速度を重視する理由を示すのに助けが必要な場合、パフォーマンス不良遅いパフォーマンスによるコンバージョン率の低下や直帰率の上昇を可視化したい場合、あるいは組織内でRUMソリューションを提唱する必要がある場合は、Sergey Chernyshevが<a href="https://dev.to/addyosmani/monitoring-performance-with-the-pagespeed-insights-api-33k7">開発したUX Speed Calculator</a>を利用しましょう。
このオープンソースのツールは、データをシミュレーションし、可視化することで、あなたの意見を理解してもらうのに役立ちます。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/b5eebba0-3123-4d14-8ead-4be33834e6c0/smashing-distribution-opt.png">
<em>CrUXは、Google Chromeのユーザからトラフィックを収集し、時系列のパフォーマンス分布の概要を作成します。<a href="https://g.co/chromeuxdash">Chrome UXダッシュボード</a>で独自のCrUXを作成することが可能です。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/b5eebba0-3123-4d14-8ead-4be33834e6c0/smashing-distribution-opt.png">プレビューを拡大</a>）</em></p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/430e2362-e8f8-4db9-9ac2-2187fd638d52/16-ux-speed-calculator-front-end-performance-checklist-2020.png">
あなたの意見を理解してもらうために、パフォーマンスに関する証拠が必要なときは、<a href="https://ux-speed-calculator.netlify.com/">UX Speed Calculator</a>が便利です。これは実際のデータに基づき、パフォーマンスが直帰率、コンバージョン率、合計収益に与える影響を可視化します。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/430e2362-e8f8-4db9-9ac2-2187fd638d52/16-ux-speed-calculator-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</p>
<p>時には、もっと詳しいデータが欲しいこともあるでしょう。
CrUXのデータを、すでに持っている他のデータと組み合わせ、競合サイトや自社プロジェクトのどこでパフォーマンスが遅くなり、どこに盲点があり、非効率な部分があるのかを迅速に見つけ出したい場合です。Harry Robertsは、自分の仕事に<a href="https://csswizardry.com/2020/11/site-speed-topography/">Site-Speed Topographyスプレッドシート</a>を利用しています。
彼はこのスプレッドシートを、主要なページの種類ごとにパフォーマンスを分析し、主要指標がどのように変わるかを追跡するのに使っています。
Google Sheets、Excel、OpenOfficeドキュメント、CSV形式で<a href="https://gumroad.com/l/site-speed-topography">スプレッドシートをダウンロード</a>できます。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/cc19294f-7bed-4974-ab6f-6344b51e538c/milestones-chart-opt.png">
<em><a href="https://csswizardry.com/2020/11/site-speed-topography/">Topography</a>。主要指標がサイトの主なページごとに表示されている。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/cc19294f-7bed-4974-ab6f-6344b51e538c/milestones-chart-opt.png">プレビューを拡大</a>）</em></p>
<p>徹底的に追求したい場合は、（<a href="https://www.npmjs.com/package/lighthouse-parade">Lighthouse Parade</a>を通じて）<a href="https://cloudfour.com/thinks/big-picture-performance-analysis-using-lighthouse-parade/">サイトのすべてのページに対してLighthouseのパフォーマンス監査を実施することができます</a>。結果はCSV形式で保存可能です。
これは、競合サイトのどの特定のページ（またはページのタイプ）のパフォーマンスが悪い（または優れている）かや、何に重点的に取り組むべきかを特定するのに役立ちます（ただし、自社サイトなら<a href="https://github.com/GoogleChrome/web-vitals/">分析エンドポイントにデータを送信</a>する方が良いでしょう）。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/98a2d45b-e3b6-468b-994e-1bd6b08b0794/hero-lighthouse-parade-opt.png">
<em><a href="https://cloudfour.com/thinks/big-picture-performance-analysis-using-lighthouse-parade/">Lighthouse Parade</a>を使用すれば、サイトのあらゆるページに対してパフォーマンス監査を実施し、結果をCSV形式で保存できます。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/98a2d45b-e3b6-468b-994e-1bd6b08b0794/hero-lighthouse-parade-opt.png">プレビューを拡大</a>）</em></p>
<p>このようにデータを収集し、<a href="https://danielmall.com/articles/how-to-make-a-performance-budget/">スプレッドシート</a>（※訳注：原文指定URL消失）を設定し、時間を20％削減することで、目標（パフォーマンスバジェット）を確立します。
これで、テストで測定を行う準備ができました。
バジェットを気にかけながら、インタラクティブになるまでの時間（TTI）を高速化するためにペイロードを最小限にしようとしている場合、これが合理的な方法であると言えます。</p>
<p>始めるのにリソースが必要なら、以下を利用してみましょう。</p>
<ul>
<li>Addy Osmaniは、<a href="https://medium.com/%40addyosmani/start-performance-budgeting-dabde04cf6a3">パフォーマンスバジェット作成の始め方</a>、新機能の影響を定量化する方法、バジェットを超過している場合にどこから手をつけるべきかについて、とても詳しい記事を執筆しています。</li>
<li>Lara Hoganの<a href="https://designingforperformance.com/weighing-aesthetics-and-performance/#approach-new-designs-with-a-performance-budget">パフォーマンスバジェットからデザインにアプローチするためのガイド</a>は、デザイナーにとって便利なヒントを提供します。</li>
<li>Harry Robertsは、<a href="https://requestmap.webperf.tools/">Request Map</a>を使用して、サードパーティのスクリプトがパフォーマンスに与える影響を表示するための<a href="https://csswizardry.com/2018/05/identifying-auditing-discussing-third-parties/">Google Sheetsの設定ガイド</a>を公表しています。</li>
<li>Jonathan Fieldingの<a href="https://www.performancebudget.io/">Performance Budget Calculator</a>や、Katie Hempeniusの<a href="https://perf-budget-calculator.firebaseapp.com/">perf-budget-calculator</a>と<a href="https://browserdiet.com/calories/">Browser Calories</a>（※訳注：原文指定URL消失）は、バジェット作成の助けとなります（この情報を教えてくれた<a href="https://medium.com/%40fox/talk-the-state-of-the-web-3e12f8e413b3">Karolina Szczur</a>に感謝します）。</li>
<li>多くの企業では、パフォーマンスバジェットは、特定のポイントを超過しないための目安となるように、野心的ではなく現実的な内容に設定すべきです。この場合、過去2週間で最悪のデータを基準値として選び、それを出発点とするのも方法の一つです。<a href="https://csswizardry.com/2020/01/performance-budgets-pragmatically/">Performance Budgets, Pragmatically</a>という記事では、そのための戦略が紹介されています。</li>
<li>また、ビルドサイズを示したグラフ付きのダッシュボードを設定することで、パフォーマンスバジェットと現在のパフォーマンスの両方を可視化できます。そのためのツールは数多く存在しており、例を挙げると<a href="https://www.sitespeed.io/">SiteSpeed.ioダッシュボード</a>（オープンソース）、<a href="https://speedcurve.com/">SpeedCurve</a>、<a href="https://calibreapp.com/">Calibre</a>などがあります。<a href="https://perf.rocks/tools/">perf.rocks</a>では、さらに多くのツールを探すことができます。</li>
</ul>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/fc5615ec-2ffd-4510-a94f-d781c17267a7/browser-calories-opt.png">
<em><a href="https://browserdiet.com/calories/">Browser Calories</a>は、パフォーマンスバジェットを設定し、ページがその数値を超過しているかどうかを測定するのに役立ちます。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/fc5615ec-2ffd-4510-a94f-d781c17267a7/browser-calories-opt.png">プレビューを拡大</a>）</em></p>
<p>バジェットを設定したら、<a href="https://web.dev/fast/incorporate-performance-budgets-into-your-build-tools">Webpack Performance HintsとBundlesize</a>、<a href="https://github.com/GoogleChrome/lighthouse-ci">Lighthouse CI</a>、<a href="https://github.com/paulirish/pwmetrics">PWMetrics</a>や<a href="https://www.sitespeed.io/">Sitespeed CI</a>を利用してビルドのプロセスに組み込み、プルリクエストに対してバジェットを実行し、PRコメントにスコアの履歴を表示するようにします。</p>
<p>パフォーマンスバジェットをチーム全体に浸透させるには、<a href="https://web.dev/use-lighthouse-for-performance-budgets/">Lightwalletを通じてLighthouseにパフォーマンスバジェットを統合する</a>か、<a href="https://github.com/treosh/lighthouse-ci-action">LHCI Actionを使用してGitHub Actionsに手早く統合しましょう</a>。何らかのカスタマイズが必要な場合は、<a href="https://github.com/trulia/webpagetest-charts-api">webpagetest-charts-api</a>を利用できます。
これはWebPageTestの結果から図表を作成するエンドポイントのAPIです。</p>
<p>しかし、パフォーマンスバジェットだけでは、パフォーマンスに対する認識を高めることはできないでしょう。
<a href="https://medium.com/%40Pinterest_Engineering/a-one-year-pwa-retrospective-f4a2f4129e05">Pinterest</a>のように、カスタマイズされた<a href="https://medium.com/pinterest-engineering/a-one-year-pwa-retrospective-f4a2f4129e05#d6bc">ESLint</a>のルールを定めることで、依存関係が多く、バンドルのサイズを膨張させるファイルやディレクトリからのインポートを禁止できます。
また、チーム全体で共有できる「安全な」パッケージの一覧を設定しましょう。</p>
<p>さらに、ビジネスにとって最もメリットが大きい必要不可欠なカスタマータスクについて考えてみてください。
<strong>必要不可欠なアクションについて、許容できる速度の基準値</strong>に関する調査と議論を行い、その基準値を決定しましょう。
さらに、組織全体が承認した「UXを考慮した」<a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance">User Timingの測定ポイント</a>を設定しましょう。
多くの場合、ユーザジャーニーは多様な部門の業務に関係します。
そのため、許容できる速度について合意できるか次第で、今後のパフォーマンスに関する議論が促進されるか妨げられるかが変わってきます。
追加的なリソースと機能による追加コストを可視化し、把握するようにしてください。</p>
<p>パフォーマンスに関する取り組みと、その他の技術的な取り組み（製品の新機能の開発、リファクタリング、世界中の新たなターゲット層へのリーチなど）の整合性を取るようにしましょう。
そうすれば、今後の展開について議論をするたびに、パフォーマンスについても一緒に議論することができます。
コードベースが新しい場合や、リファクタリングされたばかりの場合は、パフォーマンス目標を達成するのがはるかに簡単になります。</p>
<p>また、<a href="https://twitter.com/patmeenan">Patrick Meenan</a>が提案しているとおり、デザインプロセスの間に、<strong>読み込みのシーケンスとトレードオフについて計画すること</strong>は考慮に値します。
早いうちに必要不可欠な部分に優先順位をつけ、それが表示される順番を定めれば、表示を遅らせて構わないものも把握できます。
この順番はCSSとJavaScriptのインポートシーケンスも反映し、ビルドプロセスでこれらを扱いやすいようにするのが理想的です。
また、ページ読み込み中の「中間」の状態（例えば、Webフォントの読み込みが終わるまで）における視覚的なユーザ体験がどのようなものであるべきかについても検討しておきましょう。</p>
<p>パフォーマンスを重視する強固な文化を組織内で確立したら、過去の自社サイトに比べて20％高速化することを目指し、時が経っても優先順位を忘れないようにしましょう（Guy Podjarnyに感謝します）。
ただし、顧客のタイプと利用行動がさまざまであること（Tobias Baldaufは<a href="https://calendar.perfplanet.com/2020/y-u-no-revenue-cadence-cohorts-trained-behavior/">カデンスとコホート</a>と呼んでいます）や、ボットのトラフィックと季節的な影響も考慮してください。</p>
<p>とにかく計画することが大切です。プロジェクトの初期に、「手の届く所にある」最適化を即座に実行するのは魅力的で、すぐに成果を上げたい場合は良い戦略かもしれません。
しかし、計画を立てず、自社に合った現実的なパフォーマンス目標を定めない限り、パフォーマンスを優先し続けることはとても困難になるでしょう。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/dbbae59c-44fa-4967-9598-33e56ab07475/10-treo-front-end-performance-checklist-2020.jpeg">
<em><a href="https://treo.sh/">Treo</a>は現実のデータに基づく競合分析を提供します。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/dbbae59c-44fa-4967-9598-33e56ab07475/10-treo-front-end-performance-checklist-2020.jpeg">プレビューを拡大</a>）</em></p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0ae6761d-b6d6-4a0f-baa6-22e7543a3830/11-metrics-front-end-performance-checklist-2020.png">
<em>2020年初頭に新たな指標がLighthouse v6に導入されました。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/0ae6761d-b6d6-4a0f-baa6-22e7543a3830/11-metrics-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</em></p>
<h3>03. 適切な指標を選択する。</h3>
<p><a href="https://speedcurve.com/blog/rendering-metrics/">すべての指標が同等に重要なわけではありません</a>。
自社のアプリケーションにとって、どの指標が最も重要であるかを調査しましょう。
通常は、インターフェースの最も重要なピクセルのレンダリングをどれだけ速く開始できるかや、これらのレンダリングされたピクセルへの<strong>入力に対してどれだけ速く応答できるか</strong>が重要となります。
何が重要な指標であるかを知ることで、現在の取り組みに対する最善の最適化目標が分かります。
最終的には、ユーザ体験の決め手となるのは読み込みイベントでもサーバの応答時間でもなく、UIがどれだけサクサク動くと感じられるかです。</p>
<p>どういうことかというと、ページ全体の読み込み時間（例えばonLoadやDOMContentLoadedなど）に注目するよりも、<a href="https://web.dev/user-centric-performance-metrics/">顧客の印象に合わせて</a>ページの読み込みに優先順位を付けるべきだという意味です。
つまり、注目すべき指標が微妙に異なっているのです。
実際、適切な指標の選択というプロセスにおいて、明確に選択すべき指標は存在しません。</p>
<p>Tim Kadlecの調査と、Marcos Iglesiasの<a href="https://docs.google.com/presentation/d/e/2PACX-1vTk8geAszRTDisSIplT02CacJybNtrr6kIYUCjW3-Y_7U9kYSjn_6TbabEQDnk9Ao8DX9IttL-RD_p7/pub?start=false&#x26;loop=false&#x26;delayms=10000&#x26;slide=id.g3ccc19d32d_0_98">講演</a>のメモによれば、<strong>従来の指標</strong>はいくつかのグループに分けられます。
通常、パフォーマンスを完全に把握するにはすべての指標が必要ですが、個別のケースでは一部の指標が他の指標よりも重要となります。</p>
<ul>
<li>数量ベースの指標は、複数のリクエスト、ウェイト、パフォーマンススコアを測定します。
アラートを設定したり、時系列の変化をモニタリングしたりするのには向いていますが、ユーザ体験の把握には向いていません。</li>
<li>マイルストーン指標（例えばTime To First ByteやTime To Interactiveなど）は、プロセスが読み込まれるまでの状態を利用します。
ユーザ体験の把握やモニタリングには向いていますが、複数のマイルストーン間で何が起きているかを把握するのには向きません。</li>
<li>レンダリング指標（例えばStart Render TimeやSpeed Indexなど）は、コンテンツのレンダリングの速さの推定値を提供します。
レンダリングのパフォーマンスの測定や修正には向いていますが、重要なコンテンツが表示されるタイミングや、そのコンテンツとのインタラクションが可能になるタイミングの測定には向きません。</li>
<li>カスタム指標（例えばTwitterの<a href="https://blog.alexmaccaw.com/time-to-first-tweet">Time To First Tweet</a>やPinterestの<a href="https://medium.com/%40Pinterest_Engineering/driving-user-growth-with-performance-improvements-cfc50dafadd7">PinnerWaitTime</a>など）は、ユーザごとにカスタマイズされた特定のイベントを測定します。
ユーザ体験を正確に描写するのには向いていますが、指標を拡張したり、競合サイトと比較したりするのには向きません。</li>
</ul>
<p>全体像を把握するには、通常はこれらすべてのグループの有用な指標に注目します。
一般に、最も特別な意味を持ち、重要とされる指標を以下に紹介します。</p>
<ul>
<li><a href="https://calibreapp.com/blog/time-to-interactive/">Time to Interactive</a>（TTI）<br>
レイアウトが<strong>安定</strong>し、主要なWebフォントが表示され、メインスレッドがユーザの入力を十分に処理できるようになるまでの時間を表します。
つまり、ユーザとUIのインタラクションが可能になるまでの時間です。
ユーザがタイムラグなしでサイトを利用するためにどの程度待つ必要があるかを把握するための主要な指標です。
Boris Schapiraは<a href="https://blog.dareboost.com/en/2019/05/time-to-interactive-tti-measure-interactivity/">信頼性が高いTTIの測定方法</a>に関して詳細な記事を書いています。</li>
<li><a href="https://developers.google.com/web/updates/2018/05/first-input-delay">First Input Delay</a>（FID）、またはInput responsiveness<br>
ユーザが最初にサイトとのインタラクションを実施してから、ブラウザが実際にそのインタラクションに対して<strong>応答できる</strong>までの時間です。
ユーザがサイトと実際にインタラクションをするときに何が起きるかを把握できるため、TTIでは捕捉できない部分を補完する指標としてとても優れています。
これはRUMの指標としてのみ使用されることを意図しています。
ブラウザでFIDを測定するための<a href="https://github.com/GoogleChromeLabs/first-input-delay">JavaScriptライブラリ</a>も存在します。</li>
<li><a href="https://web.dev/lcp/">Largest Contentful Paint</a>（LCP）<br>
ページを読み込む過程において、ページの<strong>重要なコンテンツ</strong>が読み込まれる可能性が高い時点を示します。
前提として、ページの最も重要な要素は、<a href="https://medium.com/speedrank-app/new-performance-metric-what-is-largest-contentful-paint-dc784a497dd5">ユーザのビューポートに表示される最も大きな要素</a>であると想定しています。
スクロールしなくても見える範囲と、スクロールしなければ見えない範囲の両方で要素がレンダリングされる場合、見える範囲の部分のみが重要とみなされます。</li>
<li><a href="https://web.dev/tbt/">Total Blocking Time</a>（TBT）<br>
ページとのインタラクションが確実に可能になる前の時点で、その<a href="https://web.dev/tbt/">ページとのインタラクションが不可能である度合いの深刻さ</a>を定量化することに役立つ指標です（インタラクションが確実に可能であるとは、メインスレッドに、50ミリ秒以上を要するタスク（<a href="https://calendar.perfplanet.com/2017/tracking-cpu-with-long-tasks-api/">ロングタスク</a>）が存在しない時間が5秒以上続くことを指します）。
この指標は、最初の描画からTime to Interactive（TTI）までの間において、メインスレッドが一定時間にわたってブロックされており、入力への応答が妨げられていた時間の合計を測定するものです。
そのため、当然ながら、TBTが小さいことは良いパフォーマンスの目安となります。（ArtemとPhilに感謝します）。</li>
<li><a href="https://web.dev/cls">Cumulative Layout Shift</a>（CLS）<br>
この指標は、ユーザがサイトにアクセスしたときに、予期しない<strong>レイアウトシフト</strong>（ブラウザによるリフロー）（※訳注：ページ閲覧中に広告等の要素が読み込まれて、ガタンとコンテンツの位置がずれること）を体験する頻度を測定します。
これは、不安定な要素と、それが全体的なユーザ体験に与える影響を検証するものです。
このスコアは低いほど優れています。</li>
<li><a href="https://dev.to/borisschapira/web-performance-fundamentals-what-is-the-speed-index-2m5i">Speed Index</a><br>
ページのコンテンツがどれだけ速く目に見える形で表示されるかを測定します。
スコアが低いほど優れています。
Speed Indexのスコアは、<strong>視覚的な表示の速度</strong>に基づいて計算されますが、あくまで計算上の値です。
このスコアはビューポートのサイズにも影響されるため、ターゲット層に合わせてテスト上のさまざまな設定を定める必要があります。
LCPがより重要な指標となるにつれて、Speed Indexの重要性が低下していることに注意してください（<a href="https://twitter.com/borisschapira">Boris</a>（※訳注：原文指定URL消失）とArtemに感謝します）。</li>
<li>CPU使用時間<br>
メインスレッドが描画、レンダリング、スクリプティング、読み込み作業のためにブロックされた頻度と時間の長さを表す指標です。
CPU使用時間が長いことは、低品質なユーザ体験の明確な指標となります。
つまり、ユーザがアクションとレスポンスの間に、はっきりと分かるタイムラグを体験するということです。
WebPageTestでは、<a href="https://deanhume.com/ten-things-you-didnt-know-about-webpagetest-org/">"Chrome"タブで"Capture Dev Tools Timeline"を選択</a>することで、WebPageTestを使用している端末上で実行されるメインスレッドの内訳を明らかにすることができます。</li>
<li><a href="https://calendar.perfplanet.com/2019/javascript-component-level-cpu-costs/">Component-Level CPU Costs</a><br>
Stoyan Stefanovが提案したこの指標は、CPU使用時間と同様に、JavaScriptが<strong>CPUに与える影響</strong>を測定します。
基本的な考え方は、コンポーネント当たりのCPUインストラクションの回数を利用して、全体的なユーザ体験に対する影響を独立に把握するというものです。
<a href="https://calendar.perfplanet.com/2019/javascript-component-level-cpu-costs/">PuppeteerとChrome</a>を利用して実装できます。</li>
<li><a href="https://www.frustrationindex.com/">FrustrationIndex</a><br>
上記の指標の多くは特定のイベントが発生したタイミングを明らかにするものですが、Tim VereeckeのFrustrationIndexは指標を個別に見るのではなく、指標の間のギャップに注目します。
これは、Title is visible、First content is visible、Visually ready、Page looks readyなどのエンドユーザが体験する主要なマイルストーンに注目し、ページ読み込み中のフラストレーションの水準を示すスコアを算出します。
ギャップが大きいほど、ユーザがイライラする可能性は高くなります。
恐らく、ユーザ体験の優れたKPIになるでしょう。
Timは <a href="https://calendar.perfplanet.com/2019/frustrationindex-mind-the-gap/">FrustrationIndexとその機能に関する詳しい記事</a>を公表しています。</li>
<li><a href="https://calendar.perfplanet.com/2017/measuring-adweight/">Ad Weight Impact</a><br>
サイトが広告収入に依存している場合、広告関連のコードの重さを調べることは役に立ちます。
Paddy Gantiの<a href="https://calendar.perfplanet.com/2017/measuring-adweight/">スクリプト</a>は、2つのURL（1つは通常のURL、もう1つは広告をブロックしたもの）を構築し、WebPageTestを通じた比較動画の作成を促し、両者の差に関するレポートを生成します。</li>
<li><a href="https://phabricator.wikimedia.org/phame/live/7/post/117/performance_testing_in_a_controlled_lab_environment_-_the_metrics/">偏りに関する指標</a><br>
<a href="https://phabricator.wikimedia.org/phame/live/7/post/117/performance_testing_in_a_controlled_lab_environment_-_the_metrics/">Wikipediaのエンジニアが述べているとおり</a>、測定結果にどれだけの<strong>変動</strong>があるかというデータは、ツールをどこまで信頼すべきか、データの偏りと外れ値にどこまで注意すべきかに関して、有益な情報をもたらす可能性があります。
大きな変動は、設定を調整する必要があるというサインです。このデータは、例えばサードパーティのスクリプトが大きな変動の原因となっているなどの理由により、特定のページの測定値の信頼性が比較的低いことを把握するのにも役立ちます。
また、ブラウザの新しいバージョンが導入されたときに、パフォーマンスに支障がないか確認するために、ブラウザのバージョンを追跡するのも良い考えかもしれません。</li>
<li><a href="https://speedcurve.com/blog/user-timing-and-custom-metrics/">カスタム指標</a><br>
カスタム指標は、ビジネス上のニーズと顧客体験によって決まります。
それには、重要なピクセル、不可欠なスクリプト、必要なCSS、重要なアセットを特定し、それらがユーザにどれだけ速く提供されるかを測定する必要があります。
例えば、<a href="https://speedcurve.com/blog/web-performance-monitoring-hero-times/">Hero Rendering Times</a>をモニタリングしたり、<a href="https://css-tricks.com/breaking-performance-api/">Performance API</a>を使用したりすることで、ビジネスにとって重要なイベントについて特定のタイムスタンプを示すことができます。
また、テストの終了時に任意のJavaScriptを実行すれば、<a href="https://github.com/WPO-Foundation/webpagetest-docs/blob/master/user/custom_metrics.md">WebPageTestでカスタム指標を収集する</a>（※訳注：原文指定URL消失）ことも可能です。</li>
</ul>
<p>なお、<a href="https://developers.google.com/web/tools/lighthouse/audits/first-meaningful-paint">First Meaningful Paint</a>（FMP）が上記の概要に含まれていないことに注意してください。
FMPは、サーバが何らかのデータをどれだけ速く出力するかに関する情報を提供してきました。
FMPの時間が長いことは通常、JavaScriptがメインスレッドをブロックしていることを表していましたが、バックエンドやサーバの問題に関連している可能性もありました。
しかし、この指標は最近、約20％のケースで正確ではないとみられることが判明し、<a href="https://calendar.perfplanet.com/2019/developing-the-largest-contentful-paint-metric/">非推奨とされています</a>。
FMPは、信頼性が高く、解釈しやすいLCPにほとんど取って代わられています。
<a href="https://web.dev/first-meaningful-paint/">現在はLighthouseでもサポートされていません</a>。
<a href="https://web.dev/metrics/">最新のユーザ中心のパフォーマンス指標と推奨事項</a>をダブルチェックし、自社のページに問題がないことを確認しましょう（Patrick Meenanに感謝します）。</p>
<p>Steve Soudersは<a href="https://speedcurve.com/blog/rendering-metrics/">これらの指標の多くについて詳しく説明しています</a>。
重要な点として、Time-To-Interactiveはいわゆるラボ環境で自動化された監査を実行することによって測定されますが、First Input Delayは実際のユーザ体験を示すものであり、現実のユーザがはっきりと分かるタイムラグを体験したことを意味しています。
一般的には、両方を常に測定・追跡するのが良いでしょう。</p>
<p>アプリケーションの状況に応じて、好ましい指標は変わる可能性があります。
例えば、Netflix TVのUIにとっては<a href="https://medium.com/netflix-techblog/crafting-a-high-performance-tv-user-interface-using-react-3350e5a6ad3b">キー入力への応答性、メモリ使用、TTI</a>が特に決定的な意味を持ち、Wikipediaにとっては、<a href="https://phabricator.wikimedia.org/phame/live/7/post/117/performance_testing_in_a_controlled_lab_environment_-_the_metrics/">最初と最後の視覚的表示の変化と、CPU使用時間の指標</a>がより重要となります。</p>
<p>注記：FIDとTTIはともに、スクロールの挙動を考慮していません。
スクロールはメインスレッド外で処理されるため、独立的に発生する可能性があります。
そのため、コンテンツを消費するサイトの多くでは、これらの指標の重要性は大幅に低くなるかもしれません（Patrickに感謝します）。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/5d80f91c-9807-4565-b616-a4735fcd4949/network-requests-first-input-delay.png">
<em>ユーザ中心のパフォーマンス指標は、実際のユーザ体験について、優れた情報を提供します。<a href="https://developers.google.com/web/updates/2018/05/first-input-delay">First Input Delay</a>（FID）は、まさにこれを実現することを目指す新たな指標です。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/5d80f91c-9807-4565-b616-a4735fcd4949/network-requests-first-input-delay.png">プレビューを拡大</a>）</em></p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/7231a3c8-f610-4609-9829-27628aaf54bf/core-web-vitals-opt.jpg">
<em>新たなCore Web Vitalsの概要。LCP &#x3C; 2.5秒、FID &#x3C; 100ミリ秒、CLS &#x3C; 0.1（<a href="https://twitter.com/addyosmani/status/1257704191528599552/photo/1">Core Web Vitals</a>、<a href="https://twitter.com/addyosmani/status/1257704191528599552">Addy Osmani</a>のツイートより引用）。</em></p>
<h3>04. Core Web Vitalsを測定・最適化する。</h3>
<p>長い間、パフォーマンス指標はかなり技術的なものであり、サーバがどれだけ速く応答するか、ブラウザの読み込みがどれだけ速いかといったエンジニア側の視点に重点を置いていました。
こうした指標は、サーバのタイミングではなく、実際のユーザ体験を把握する方法を見つけ出すために、時とともに変化してきました。
2020年5月、GoogleはCore Web Vitalsを発表しました。
これはユーザに重点を置いた一連の新しいパフォーマンス指標で、各指標が別個のユーザ体験の要素を表します。</p>
<p>各指標について、Googleは許容できる速度の範囲の推奨目標を示しています。
この評価に合格するには、すべてのページビューの75％以上で「Good」の範囲を超える必要があります。
Core Web Vitalsは急速に広まり、2021年5月にはCore Web VitalsがGoogle検索ランキングシグナルに導入されたことで（ページエクスペリエンスのランキングアルゴリズムのアップデート）、多くの企業がパフォーマンススコアに関心を向けるようになりました。</p>
<p>ここでは、Core Web Vitalsを一つずつ見ていくとともに、これらの指標を考慮してユーザ体験を最適化するための便利なテクニックとツールを紹介します（この記事の一般的なアドバイスに従うことで、Core Web Vitalsスコアを改善できるでしょう）。</p>
<ul>
<li>
<p>Largest Contentful Paint （LCP）&#x3C; 2.5秒。</p>
<p>ページの読み込みを測定し、ビューポートに表示される最大の画像またはテキストブロックのレンダリング時間を報告します。
したがって、LCPは、サーバ応答時間の遅さ、ブロッキングCSS、実行中のJavaScript（ファーストパーティかサードパーティかを問わない）、Webフォントの読み込み、重いレンダリングや描画作業、読み込みが遅い画像、スケルトンスクリーン、クライアントサイドのレンダリングなど、重要な情報のレンダリングを遅らせるあらゆる要素の影響を受けます。</p>
<p>優れたユーザ体験を実現するには、LCPは、ページの読み込みが最初に開始されてから2.5秒以内とすべきです。
これは、ページ内で最初に表示される部分を可能な限り早くレンダリングする必要があることを意味します。
そのためには、各テンプレート向けにクリティカルCSSをカスタマイズし、 <code class="language-text">&lt;head&gt;</code> の順番を調整し、クリティカルなアセットを先読みすることが必要となります（これらの点については後で説明します）。</p>
<p>LCPスコアが低い主な理由は、通常は画像です。
Fast 3Gで2.5秒未満のLCPを達成するには（十分に最適化されたサーバでホスティングし、レンダリングはすべて静的で、クライアントサイドでのレンダリングは行わず、画像は専用の画像CDNによるものである場合）、理論上の画像の最大サイズはわずか約144KBとなります。
これが画像の応答性の高さや、（preloadによる）クリティカルな画像の早期の先読みが重要である理由です。</p>
<p>簡単なtips：ページ上で何がLCPの対象となるかを特定するには、DevToolsのパフォーマンスパネルの"Timings"のLCPバッジにカーソルを合わせてください（Tim Kadlecに感謝します）。</p>
</li>
<li>
<p>First Input Delay（FID）&#x3C; 100ミリ秒。</p>
<p>UIの応答性、すなわちユーザによる独立した入力イベント（タップやクリックなど）に反応できるようになる前に、ブラウザが他のタスクによってビジー状態となる時間の長さを測定します。
この指標は、メインスレッドが（特にページの読み込み中に）ビジー状態となることによる遅れを把握できるように設計されています。</p>
<p>目標はすべてのインタラクションにつき50～100ミリ秒を維持することです。
これを達成するには、ロングタスク（50ミリ秒を超える時間にわたってメインスレッドをブロックするタスク）を特定してそれを分割すること、バンドルを複数のまとまりにコード分割すること、JavaScriptの実行時間を短縮すること、データ取得を最適化すること、サードパーティのスクリプト実行を延期すること、WebワーカーによってJavaScriptをバックグラウンドスレッドに移動すること、プログレッシブハイドレーションを活用してSPAにおけるリハイドレーションコストを削減することが必要です。</p>
<p>簡単なtips：一般に、FIDスコアを改善するための信頼性が高い戦略は、大規模なバンドルを小規模なバンドルに分割して、ユーザが必要なときにバンドルを提供することで、メインスレッドの作業を最小化し、ユーザインタラクションの遅延を防ぐことです。この点については後で詳しく説明します。</p>
</li>
<li>
<p>Cumulative Layout Shift（CLS）&#x3C; 0.1。</p>
<p>UIの視覚的な安定性を測定することで、円滑で自然なインタラクションを確実にします。
この指標では、ページのライフスパン全体で発生したあらゆる予期しないレイアウトシフトについて、すべての個々のレイアウトシフトのスコアを合計します。
すでに表示されている要素のページ内の位置が変化した場合は常に、個々のレイアウトシフトが発生したとみなされます。
このスコアは、コンテンツのサイズと、移動した距離に基づいています。</p>
<p>シフトが発生するたびに（例えば、フォールバックフォントとWebフォントのフォントメトリックが異なる場合、広告、エンベッドやインラインフレームが遅れて表示される場合、画像や動画のアスペクト比が保存されない場合、CSSが遅いために再描画が必要になる場合、JavaScriptが遅いために変更が挿入される場合など）、CLSスコアに影響を与えます。
優れたユーザ体験として推奨されるCLSの値は0.1未満です。</p>
</li>
</ul>
<p>Core Web Vitalsが、予測可能な年1回のサイクルで、時とともに変化すると見込まれていることは注目に値します。
初年度のアップデートの可能性としては、First Contentful PaintがCore Web Vitalsに昇格すること、FIDの基準値が引き下げられること、シングルページアプリケーションのサポートが改善することなどが考えられます。
また、セキュリティ、プライバシー、アクセシビリティ（！）に関する考慮事項とともに、読み込み後のユーザ入力に対する応答のウェイトが大きくなる可能性もあります。</p>
<p>Core Web Vitalsに関しては、一見の価値がある有用なリソースや記事が数多く存在します。</p>
<ul>
<li>Web Vitals Leaderboardでは、モバイル、タブレット、デスクトップ、3Gと4Gでスコアを競合と比較することができます。</li>
<li>Core SERP Vitalsは、CrUXのCore Web VitalsをGoogle検索結果に表示できるChromeエクステンションです。</li>
<li>Layout Shift GIF Generatorは、シンプルなGIFでCLSを可視化します（コマンドラインでも利用できます）。</li>
<li>web-vitalsライブラリでは、Core Web Vitalsを収集し、それをGoogle - Analytics、Google Tag Managerなどの分析エンドポイントに送信できます。</li>
<li>Analyzing Web Vitals with WebPageTestでは、Patrick Meenanが、WebPageTestがCore Web Vitalsに関するデータをどのように明らかにするかを説明しています。</li>
<li>Optimizing with Core Web Vitalsは50分間の動画です。この動画では、Addy Osmaniが、eコマースのケーススタディでCore Web Vitalsを改善する方法を明らかにしています。</li>
<li>Cumulative Layout Shift in PracticeとCumulative Layout Shift in the Real Worldは、Nic Jansmaによる総合的な内容の記事です。これらの記事では、CLSに関するほとんどのテーマと、それが直帰率、セッションタイム、レイジクリック（狭いエリアでのクリックやタップの連打）などの主要な指標とどのように関係しているかについて扱っています。</li>
<li>What Forces Reflowは、JavaScriptでリクエストされたときや呼び出されたときに、ブラウザが同期してスタイルとレイアウトを計算するトリガーとなるプロパティやメソッドの一覧です。</li>
<li>CSS Triggersは、レイアウト、ペイント、コンポジットをトリガーするCSSプロパティの一覧です。</li>
<li>Fixing Layout Instabilityは、WebPageTestを使用して不安定なレイアウトの問題を特定・修正するためのガイドです。</li>
<li>Cumulative Layout Shift, The Layout Instability Metricは、Boris Schapiraが執筆したCLSに関するとても詳細なガイドで、CLSの計算、測定、最適化の方法を取り扱っています。</li>
<li>How To Improve Core Web Vitalsでは、各指標（FCP、TTI、TBTなどの他のWeb Vitalsを含む）や、それがいつ、どのように測定されるのかをSimon Hearneが詳細に説明しています。</li>
</ul>
<p>では、Core Web Vitalsとは<strong>追跡すべき究極の指標なのでしょうか？</strong>そうとは限りません。確かにCore Web Vitalsは、<a href="https://blog.cloudflare.com/start-measuring-web-vitals-with-browser-insights/">Cloudflare</a>、<a href="https://treo.sh/">Treo</a>、<a href="https://speedcurve.com/blog/web-vitals-user-experience/">SpeedCurve</a>、<a href="https://calibreapp.com/blog/core-web-vitals">Calibre</a>、<a href="https://calendar.perfplanet.com/2020/analyzing-web-vitals-with-webpagetest/">WebPageTest</a>（<a href="https://twitter.com/patmeenan/status/1346902718837895168">すでにフィルム型のビューに追加済み</a>）、<a href="https://blog.newrelic.com/product-news/w3c-context-trace-cumulative-layout-shift-measurement/">Newrelic</a>、<a href="https://apps.shopify.com/vitals-1">Shopify</a>、<a href="https://twitter.com/vercel/status/1259866549319618560">Next.js</a>、<a href="https://twitter.com/ChromiumDev/status/1266044527409639424">すべてのGoogleツール</a>（PageSpeed Insights、Lighthouse + CI、Search Consoleなど）やその他数多くのソリューションやプラットフォームを含め、ほとんどのRUMソリューションとプラットフォームにすでに導入されています。
しかし、Katie Sylor-Millerが<a href="https://sylormiller.com/posts/2020/core-web-vitals/">説明しているとおり</a>、Core Web Vitalsには、<a href="https://sylormiller.com/posts/2020/core-web-vitals/">対応ブラウザが限られていること</a>、実際はユーザ体験のライフサイクル全体を測定していないこと、FIDとCLSの変化をビジネスの成果と結びつけるのが困難であることといった大きな問題があります。</p>
<p>Core Web Vitalsには進化を期待すべきですが、当面の間は、パフォーマンス面の状況をよく把握できるように、Core Web Vitalsとカスタマイズ指標を常に組み合わせるのが賢明でしょう。</p>
<h3>05. ターゲット層の代表的な端末でデータを収集する。</h3>
<p>正確なデータを収集するには、テストを行う端末を徹底的に選び抜く必要があります。
ほとんどの企業では、最も一般的な端末のタイプに基づいてアナリティクスを検証し、ユーザプロファイルを構築すべきです。
しかし、アナリティクスだけでは全体像が分からないことはよくあります。
ターゲット層の大部分は、反応が遅すぎるというだけでサイトを離れる（そして戻ってこない）可能性があります。
その場合、こうしたユーザの端末は、アナリティクスで最も一般的な端末として表示される可能性は低いでしょう。
そのため、ターゲット層の一般的な端末に関して、追加調査を実施するのは良いアイデアかもしれません。</p>
<p>IDCによれば、2020年の世界の<a href="https://www.idc.com/promo/smartphone-market-share/os">スマートフォン出荷台数全体の84.8％（※訳注：原文執筆時）はAndroid端末</a>でした。
消費者は平均で<a href="https://www.cnbc.com/2019/05/17/smartphone-users-are-waiting-longer-before-upgrading-heres-why.html">2年ごとにスマートフォンをアップグレードしており</a>、米国では<a href="https://www.mobileworldlive.com/devices/news-devices/us-phone-upgrade-cycle-stretches-to-33-months/">スマートフォンの買い替えサイクルは33カ月</a>となっています。
世界で最もよく売れているスマートフォンの平均コストは200ドル未満とみられます。</p>
<p>上記よりもやや悲観的な想定に基づくと、代表的な端末は、<strong>2年以上使用されている</strong>Android端末で、価格は200ドル以下、通信規格は低速の3G、RTTは400ミリ秒、通信速度は400kbpsとなります。
これは当然、企業によって大きく異なる可能性がありますが、世の中の大部分の顧客に十分に近い想定であると言えます。
さらに、ターゲット市場の現在の<a href="https://www.amazon.co.uk/gp/bestsellers/electronics/356496011/ref=sr_bs_1">Amazonベストセラー</a>を確認するのは良いアイデアかもしれません。（このアドバイスをくれたTim Kadlec、Henri Helvetica、Alex Russellに感謝します）。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/1436a0fc-40ed-4665-8fbb-bae8aa1ad740/amazon-bestsellers-opt.png">
<em>新たなサイトやアプリを開発するときは、現在のターゲット市場の<a href="https://www.amazon.co.uk/gp/bestsellers/electronics/356496011/ref=sr_bs_1">Amazonベストセラー</a>を必ず最初にチェックしましょう。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/1436a0fc-40ed-4665-8fbb-bae8aa1ad740/amazon-bestsellers-opt.png">プレビューを拡大</a>）</em></p>
<p>では、どの端末をテストに選べばよいのでしょうか。その答えは、上記のプロファイルによく一致した端末です。<a href="https://twitter.com/katiehempenius/statuses/1067969800205422593">少し古いMoto G4/G5 Plus</a>、中価格帯のSamsung端末（Galaxy A50、S8）、Nexus 5X、Xiaomi Mi A3、Xiaomi Redmi Note 7などの優良な中級レベルの端末、Alcatel 1XやCubot X19などの遅い端末を、<a href="https://www.smashingmagazine.com/2016/11/worlds-best-open-device-labs/">オープンデバイスラボ</a>などでテストするのは良い選択肢の1つです。サーマルスロットリング済みのさらに遅い端末でのテストには、Nexus 4が利用できます。価格はわずか約100ドルです。</p>
<p>また、各端末で使用されているチップセットを確認し、<strong>1つのチップセットに対するテストを過剰に行わないようにしましょう</strong>。
SnapdragonやApple、ローエンドのRockchipやMediatekは数世代で十分です（Patrickに感謝します）。</p>
<p>手元に端末がない場合は、<strong>スロットリングした3Gネットワーク</strong>（例：RTTは300ミリ秒、下り1.6Mbps、上り0.8Mbps）とCPU（5倍減速）でモバイルのユーザ体験をデスクトップでエミュレートしてみましょう。
その後、通常の3G、遅い4G（例：RTTは170ミリ秒、下り9Mbps、上り9Mbps）、Wi-Fiへ徐々に切り替えていきます。パフォーマンスへの影響をより明確にするには、<a href="https://www.theverge.com/2015/10/28/9625062/facebook-2g-tuesdays-slow-internet-developing-world">2G Tuesdays</a>を導入したり、<a href="https://twitter.com/thommaskelly/status/938127039403610112">スロットリングした3G/4Gネットワークをオフィスに設定</a>してテストを高速化したりすることもできます。</p>
<p>モバイル端末では、<a href="https://youtu.be/JvJ0v5OohNg?t=892">デスクトップマシンに比べてスピードが4～5倍遅くなる</a>と予想されることに注意しましょう。
モバイル端末のGPU、CPU、メモリ、バッテリーの特性はさまざまです。
そのため、平均的な端末のプロファイルを把握し、常に<a href="https://www.webpagetest.org/easy">そうしたデバイスでテストを行う</a>ことが重要です。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_auto/w_800/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/dfe1a4ec-2088-4e39-8a39-9f2010380a53/tuesday-2g-opt.png">
<em>1週間で接続が最も遅い日を決めるという手段もあります。Facebookは、接続が遅い環境への認識と感度を高めるため、<a href="https://www.theverge.com/2015/10/28/9625062/facebook-2g-tuesdays-slow-internet-developing-world">2G Tuesdays</a>という取り組みを導入しました。（<a href="https://www.businessinsider.com/facebook-2g-tuesdays-to-slow-employee-internet-speeds-down-2015-10?IR=T">画像の出典</a>）</em></p>
<p>幸運にも、データ収集を自動化したり、上記の指標に従ってWebサイトのパフォーマンスを時系列で測定したりするための素晴らしい選択肢は数多く存在します。パフォーマンスをよく把握するには、<a href="https://twitter.com/izzionfire/status/1326102215573041152">ラボデータとフィールドデータの両方</a>の複数のパフォーマンス指標をカバーする必要があることに注意しましょう。</p>
<ul>
<li><strong>合成テストツール</strong>は、事前に定めた端末とネットワークの設定に基づき、再現可能な環境でラボデータを収集します（Lighthouse、Calibre、WebPageTestなど）。</li>
<li><strong>リアルユーザモニタリング</strong>（RUM）ツールは、ユーザのインタラクションを継続的に評価し、フィールドデータを収集します（SpeedCurve、New Relicなど。これらのツールでは合成テストも可能です）。</li>
</ul>
<p>前者は、サービスを開発しつつ、パフォーマンスに関する問題を特定、分離、修正することに役立つので、開発中は特に便利です。
後者は、生のデータ、つまりユーザが実際にサイトにアクセスしたときのデータを測定し、パフォーマンスのボトルネックを把握するのに役立つので、長期的なメンテナンスに向いています。</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigation_timing_API">Navigation Timing</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/API/Resource_Timing_API">Resource Timing</a>、<a href="https://css-tricks.com/paint-timing-api/">Paint Timing</a>、<a href="https://w3c.github.io/longtasks/">Long Tasks</a>などのビルトインRUM APIを利用することで、合成テストツールとRUMは一体となってアプリケーションのパフォーマンスの全体像を明らかにします。<a href="https://calibreapp.com/">Calibre</a>、<a href="https://treo.sh/">Treo</a>、<a href="https://speedcurve.com/">SpeedCurve</a>、<a href="https://www.akamai.com/us/en/products/performance/mpulse-real-user-monitoring.jsp">mPulse</a>、<a href="https://github.com/akamai/boomerang">Boomerang</a>、<a href="https://www.sitespeed.io/">Sitespeed.io</a>を利用することもできます。これらはいずれも、パフォーマンスをモニタリングするための素晴らしい選択肢です。
さらに、<a href="https://www.smashingmagazine.com/2018/10/performance-server-timing/">Server Timingヘッダ</a>では、バックエンドとフロントエンドのパフォーマンスを1カ所でモニタリングすることも可能です。</p>
<p><strong>注記</strong>：スロットリングについては、ブラウザ外の<a href="https://calendar.perfplanet.com/2016/testing-with-realistic-networking-conditions/">ネットワークレベルで設定を行う</a>方が常に安全です。
その理由の1つとして、DevToolsには、導入方法の関係上、HTTP/2のプッシュとのインタラクションに問題があることが挙げられます（YoavとPatrickに感謝します）。
Mac OSでは<a href="https://nshipster.com/network-link-conditioner/">Network Link Conditioner</a>、Windowsでは<a href="https://github.com/WPO-Foundation/win-shaper/releases">Windows Traffic Shaper</a>、Linuxでは<a href="https://wiki.linuxfoundation.org/networking/netem">netem</a>、FreeBSDでは<a href="http://info.iet.unipi.it/~luigi/dummynet/">dummynet</a>を利用できます。</p>
<p>テストはLighthouseで実施する可能性が高いでしょう。
その場合は以下に留意してください。</p>
<ul>
<li><a href="https://github.com/GoogleChrome/lighthouse-ci">Lighthouse CIを使用</a>することで、Lighthouseスコアを時系列で追跡できます（<a href="https://twitter.com/_developit/status/1266112451155841024">とても素晴らしい</a>機能です）。</li>
<li><a href="https://calendar.perfplanet.com/2020/running-lighthouse-in-github-actions/">GitHub ActionsでLighthouseを実行</a>することで、PRのたびにLighthouseレポートを取得できます。</li>
<li>（<a href="https://www.npmjs.com/package/lighthouse-parade">Lighthouse Parade</a>を通じて）<a href="https://cloudfour.com/thinks/big-picture-performance-analysis-using-lighthouse-parade/">サイトのすべてのページに対してLighthouseのパフォーマンス監査を実施することができます</a>。結果はCSV形式で保存されます。</li>
<li><a href="https://twitter.com/TheRealNooshu/status/1273045993035005952">Lighthouse Scores Calculator</a>と<a href="https://twitter.com/HenriHelvetica/status/1237408016250687488">Lighthouse metric weights</a>を使用することで、必要に応じて詳細な情報を把握できます。</li>
<li>Lighthouseは<a href="https://addons.mozilla.org/en-US/firefox/addon/google-lighthouse/">Firefoxでも利用できます</a>が、内部でPageSpeed Insights APIを利用し、<a href="https://twitter.com/boostmarks/status/1261183488037961728">ヘッドレスChrome 79 User-Agentに基づいてレポートを作成します</a>（※訳注：原文指定URL消失）。</li>
</ul>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9c380575-7a95-48cc-bd49-08bbd2c006bd/lighthouse-ci-opt.png">
<em><a href="https://github.com/GoogleChrome/lighthouse-ci">Lighthouse CI</a>はとても素晴らしいツールで、Lighthouseの継続的な実行、その結果の保存と取得、結果に対するアサーションが可能です。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9c380575-7a95-48cc-bd49-08bbd2c006bd/lighthouse-ci-opt.png">プレビューを拡大</a>）</em></p>
<h3>06. テスト用の「クリーン」な「顧客」プロファイルを設定する。</h3>
<p>パッシブなモニタリングツールでテストを実行する場合、（<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Firefox/Multiple_profiles">Firefox</a>（※訳注：原文指定URL消失）と<a href="https://support.google.com/chrome/answer/2364824?hl=en&#x26;co=GENIE.Platform=Desktop">Chrome</a>において）偏った結果を避けるために、アンチウイルスソフトやバックグラウンドのCPUタスクをオフにする、バックグラウンドの帯域幅転送を除外する、ブラウザ拡張機能がインストールされていないクリーンなユーザプロファイルでテストを行うといった戦略がよく使われます。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/78d6672a-013c-4b55-b258-7efd153a30d9/chrome-extension-page-cpu-time-opt.png">
<em>DebugBearのレポートは、パスワードマネージャ、アドブロッカ、EvernoteやGrammarlyといった人気のアプリケーションなど、<a href="https://www.debugbear.com/blog/2020-chrome-extension-performance-report">遅い拡張機能ワースト20</a>を明らかにしています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/78d6672a-013c-4b55-b258-7efd153a30d9/chrome-extension-page-cpu-time-opt.png">プレビューを拡大</a>）</em></p>
<p>しかし、顧客がどの<strong>ブラウザ拡張機能</strong>を頻繁に使用しているかを調査し、専用の「顧客」プロファイルに基づいてテストを実施するのも良いアイデアです。
実際、一部の拡張機能はアプリケーションの<a href="https://twitter.com/denar90_/statuses/1065712688037277696">パフォーマンスに重大な影響を与える</a>可能性があります（<a href="https://www.debugbear.com/blog/2020-chrome-extension-performance-report">2020 Chrome Extension Performance Report</a>）。
ユーザがその拡張機能を大量に使用する場合、それを事前に織り込んでおくべきかもしれません。したがって、「クリーン」なプロファイルのみによるテスト結果は楽観的過ぎて、現実のシナリオでは悲惨な状況になる可能性があります。`</p>
<h3>07. 同僚とパフォーマンス目標を共有する。</h3>
<p>今後の誤解を避けるために、チームのあらゆるメンバーがパフォーマンス目標をよく理解するようにしましょう。
デザインにせよ、マーケティングにせよ、その中間の何かにせよ、あらゆる意思決定は<strong>パフォーマンスに影響</strong>します。
チーム全体に責任とオーナーシップを分配することは、その後のパフォーマンスに重点を置いた意思決定の合理化につながります。
デザインに関する意思決定と、パフォーマンスバジェットや早期に定めた優先事項の対応関係を明らかにしましょう。</p>
<h2>現実的な目標の設定 <a href="#02">#</a><a name="02"></a></h2>
<h3>08. 応答時間100ミリ秒、60fps。</h3>
<p>インタラクションがスムーズに感じられるには、インターフェースがユーザの入力から100ミリ秒以内に応答する必要があります。
それ以上遅いと、ユーザはアプリにタイムラグがあると感じます。
<a href="https://www.smashingmagazine.com/2015/10/rail-user-centric-model-performance/">ユーザ中心主義のパフォーマンスモデルであるRAIL</a>は、<strong>妥当な目標</strong>を掲げています。
その目標とは、応答時間を100ミリ秒未満にするには、遅くとも50ミリ秒未満ごとにメインスレッドを解放するようにページを作成しなければならないというものです。
<a href="https://developers.google.com/web/tools/lighthouse/audits/estimated-input-latency">Estimated Input Latency</a>は、この基準値を満たしているかどうかを明らかにします。
理想的には、この値は50ミリ秒未満であるべきです。
アニメーションなどの負荷が大きい部分では、可能な場合は他に何も処理せず、不可能な場合は処理を絶対的な最小限に抑えるのが望ましいと言えます。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_auto/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/c91c910d-e934-4610-9dc5-369ec9071b57/rail-perf-model-opt.png">
<em><a href="https://developers.google.com/web/fundamentals/performance/rail">RAIL</a>はユーザ中心主義のパフォーマンスモデル。</em></p>
<p>また、アニメーションの各フレームは16ミリ秒未満とし、1秒間のフレーム数が60フレーム（1秒÷60=16.6ミリ秒）となるようにすべきです。
なるべく1フレームを10ミリ秒未満にするのが望ましいと言えます。
ブラウザは新たなフレームを画面に描画するのに時間がかかるため、16.6ミリ秒の基準値に達する前にコードの実行が終了するようにすべきです。
120fpsに関する議論はすでに始まっており（例えば、iPad Proの画面のリフレッシュレートは120Hz）、Surmaは<a href="https://dassur.ma/things/120fps/">120fpsを実現するためのレンダリングパフォーマンスソリューション</a>についての記事を執筆していますが、現時点では120fpsを目指さなくてもよいでしょう。</p>
<p>パフォーマンスを予想するときは悲観的であるべきですが、<a href="https://www.smashingmagazine.com/2016/11/true-lies-of-optimistic-user-interfaces/">インターフェースをデザインするときは楽観的であるべき</a>であり、<a href="https://philipwalton.com/articles/idle-until-urgent/">アイドルタイムは賢明に活用すべき</a>です（<a href="https://github.com/GoogleChromeLabs/idlize">idlize</a>、<a href="https://github.com/TehShrike/idle-until-urgent">idle-until-urgent</a>、react-idleをチェックしましょう）。
当然ながら、上記の目標は読み込みのパフォーマンスではなく、ランタイムのパフォーマンスに適用されます。</p>
<h3>09. 3GでFID&#x3C;100ミリ秒、LCP&#x3C;2.5秒、TTI&#x3C;5秒。クリティカルなファイルの容量は170KB未満（gzip形式で圧縮した場合）。</h3>
<p>最終的な目標としては、（達成するのはとても困難かもしれませんが）<a href="https://www.youtube.com/watch?v=_srJ7eHS3IM&#x26;feature=youtu.be&#x26;t=6m21s">Time To Interactiveは5秒未満</a>、リピート訪問については2秒未満（サービスワーカーによってのみ達成可能）とするのが良いでしょう。
Largest Contentful Paintは2.5秒未満を目指し、Total Blocking TimeとCumulative Layout Shiftを最小化しましょう。
許容できるFirst Input Delayは70～100ミリ秒未満です。
上記のとおり、低速な3Gネットワークに接続された200ドルのAndroidスマートフォン（Moto G4など）を、400ミリ秒のRTTと400kbpsの転送速度によってエミュレートしたものを基準とします。</p>
<p>Web上のコンテンツを迅速に提供するには、2つの大きな制約があり、それが妥当なファイル容量を実質的に決める要因となります。
まず、<a href="https://hpbn.co/building-blocks-of-tcp/#slow-start">TCP Slow Start</a>による<strong>ネットワークデリバリの制約</strong>があります。
HTMLの最初の14KB（10個のTCPパケットが各1460バイトで約14.25 KB。
<a href="https://www.tunetheweb.com/blog/critical-resources-and-the-first-14kb/">ただし、鵜呑みにすべきではありません</a>）は、最もクリティカルなペイロードのチャンクであり、バジェットのうち最初のラウンドトリップで提供できる唯一の部分です（モバイルのウェイクアップタイムの関係上、RTTが400ミリ秒の場合に1秒間で受信できるのはこの部分に限られます）。</p>
<p><img src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9c5bf6fb-5027-4388-abd2-4355b9c8994f/new-congestion-control-opt.png">
<em>TCP接続では、小規模な輻輳ウィンドウからスタートして、ラウンドトリップごとにウィンドウを2倍に拡大します。最初のラウンドトリップでは14KBを提供することが可能です。出典：<a href="https://hpbn.co/building-blocks-of-tcp/#slow-start">High Performance Browser Networking</a>（Ilya Grigorik著）。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9c5bf6fb-5027-4388-abd2-4355b9c8994f/new-congestion-control-opt.pngv">プレビューを拡大</a>）</em></p>
<p>もう1つの制約として、JavaScriptのパーシングと実行時間の関係上、メモリとCPUに対する<strong>ハードウェアの制約</strong>があります（これらについては後で詳しく説明します）。
最初のパラグラフで述べた目標を達成するには、JavaScriptにとってクリティカルなファイルの容量のバジェットを考慮することが必要です。
バジェットの適切な容量についてはさまざまな意見があります（プロジェクトの性質にも大きく依存します）が、170KBのJavaScriptファイルをgzip形式で圧縮した場合、中価格帯のスマートフォンではパーシングとコンパイルに最大で1秒かかります。
170KBのファイルを解凍すると容量が3倍（0.7MB）になると想定すると、それだけでMoto G4/G5 Plusでは「まとも」なユーザ体験が失われかねません。</p>
<p>Wikipediaのサイトの場合、2020年に、<a href="https://twitter.com/MonsieurPerf/status/1252184196426104832">コードの実行速度はWikipediaのユーザにとって世界全体で19％速くなりました</a>。
ですから、もしWebパフォーマンスの指標に前年比で変化がない場合、それは通常、環境の継続的な改善に伴って、自社サイトが実質的に後退しているという警戒すべきサインです（<a href="https://techblog.wikimedia.org/2020/05/07/measuring-the-performance-of-wikipedia-visitors-devices/">詳細はGilles Dubucのブログ記事を参照</a>）。</p>
<p>東南アジア、アフリカ、インドなどの成長中の市場をターゲットとする場合、まったく異なる制約に直面することになります。
Addy Osmaniは<a href="https://dev.to/addyosmani/loading-web-pages-fast-on-a-20-feature-phone-8h6">フィーチャーフォンの主な制約</a>（例えば、低コストの優良な端末は少数、高品質なネットワークは利用できない、モバイルデータ通信のコストが大きい）、<strong>PRPL-30バジェット</strong>、こうした環境における開発のガイドラインについて述べています。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/02143033-61ad-4808-bf3e-9c5f6a515927/12-30kb-front-end-performance-checklist-2020.png">
<em><a href="https://dev.to/addyosmani/loading-web-pages-fast-on-a-20-feature-phone-8h6">Addy Osmaniによれば</a>、遅延読み込み経路における推奨容量も35KB未満です。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/02143033-61ad-4808-bf3e-9c5f6a515927/12-30kb-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</em></p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d9d1033f-f45f-4789-aca1-1bb61fbd44c5/13-prpl-budget-front-end-performance-checklist-2020.jpeg">
<em>Addy Osmaniは、フィーチャーフォンをターゲットとする場合のPRPL-30パフォーマンスバジェット（gzip形式で圧縮・軽量化した初期バンドル30KB）を<a href="https://dev.to/addyosmani/loading-web-pages-fast-on-a-20-feature-phone-8h6">提唱しています</a>。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d9d1033f-f45f-4789-aca1-1bb61fbd44c5/13-prpl-budget-front-end-performance-checklist-2020.jpeg">プレビューを拡大</a>）</em></p>
<p>実際、GoogleのAlex Russellは、妥当な容量の上限として<a href="https://infrequently.org/2017/10/can-you-afford-it-real-world-web-performance-budgets/">gzip形式で130～170KBを目指すこと</a>を推奨しています。
現実には、ほとんどのサービスはこの上限に近づいてすらいません。
現在のバンドル容量の中央値は<a href="https://beta.httparchive.org/reports/state-of-javascript#bytesJs">約452KB</a>で、2015年初めと比べて53.6％増加しています。
これはミドルクラスのモバイル端末で12～20秒のTime To Interactiveに相当します。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/1b311ffb-7c1e-442c-8122-53ee39fe5b7b/11-perf-phones-front-end-performance-checklist-2020.png">
<em>上記のグラフは、2019年に世界で最も売れたスマートフォンについて、GeekbenchでCPUパフォーマンスのベンチマークを比較したものです。JavaScriptはシングルコアのパフォーマンスにとって負担となり（他のWebプラットフォームに比べて本質的にシングルスレッドとなりやすいことに注意してください）、CPUの制約を受けます。Addyの記事「<a href="https://dev.to/addyosmani/loading-web-pages-fast-on-a-20-feature-phone-8h6">Loading Web Pages Fast On A $20 Feature Phone</a>」より引用。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/1b311ffb-7c1e-442c-8122-53ee39fe5b7b/11-perf-phones-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</em></p>
<p>しかし、バンドル容量のバジェットを超えることもできます。
例えば、ブラウザのメインスレッドのアクティビティ、つまりレンダリング開始前の描画時間に基づいてパフォーマンスバジェットを設定することや、<a href="https://calendar.perfplanet.com/2017/tracking-cpu-with-long-tasks-api/">フロントエンドでCPUに大きな負荷をかけている存在を見つけ出すことが可能です</a>。
<a href="https://calibreapp.com/">Calibre</a>、<a href="https://speedcurve.com/">SpeedCurve</a>、<a href="https://github.com/siddharthkp/bundlesize">Bundlesize</a>などのツールは、バジェットを管理するのに役立ち、ビルドのプロセスに統合できます。</p>
<p>最後に、パフォーマンスのバジェットはおそらく<strong>固定すべきではありません</strong>。
ネットワーク接続に合わせて、<a href="https://twitter.com/katiehempenius/status/1075478356311924737">パフォーマンスのバジェットは調整すべきです</a>。
ただし、接続が遅くなると、どのように利用してもペイロードは大幅に「重く」なります。</p>
<p><strong>注記</strong>：HTTP/2が普及し、<a href="https://www.speedtest.net/ookla-5g-map">5G</a>と<a href="https://twitter.com/FredKSchott/status/1313910775199612929">HTTP/3</a>の登場が近づき、スマートフォンが急速に進化し、SPAが繁栄するなかで、上記のような厳格なバジェットを設定するのは奇妙に思えるかもしれません。
しかし、ネットワークの輻輳、インフラ開発の遅さ、<a href="https://youtu.be/JvJ0v5OohNg?t=397">データ上限</a>、プロキシブラウザ、<a href="https://timkadlec.com/remembers/2019-08-29-save-data-usage/">省データモード</a>から隠れたローミング手数料に至るまで、ネットワークやハードウェアの予測不能な性質に対処するときには、こうしたバジェットは合理的に感じられるはずです。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_auto/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/3bb4ab9e-978a-4db0-83c3-57a93d70516d/file-size-budget-fast-default-addy-osmani-opt.png">
<em><a href="https://speakerdeck.com/addyosmani/fast-by-default-modern-loading-best-practices">Fast By Default:Modern loading best practices</a>（Addy Osmani著）より（スライド19）</em></p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/949e5601-04e7-48ee-91a5-10bd7af19a0f/perf-budgets-network-connection.jpg">
<em>パフォーマンスのバジェットは、平均的なモバイル端末のネットワークの状況に応じて調整すべきです。（画像の出典：<a href="https://twitter.com/katiehempenius/status/1075478356311924737">Katie Hempenius</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/949e5601-04e7-48ee-91a5-10bd7af19a0f/perf-budgets-network-connection.jpg">プレビューを拡大</a>）</em></p>
<h2>環境の定義<a href="#03">#</a><a name="03"></a></h2>
<h3>10. ビルドツールを選択・設定する。</h3>
<p><a href="https://24ways.org/2017/all-that-glisters/">現在、流行しているツールに気をとられすぎないようにしましょう</a>。
Gruntにせよ、Gulpにせよ、Webpackにせよ、Parcelにせよ、あるいは複数のツールの組み合わせにせよ、自分のビルド環境にこだわるべきです。
必要な成果を出していて、ビルドのプロセスを維持するのに支障がない限り、それで問題ありません。</p>
<p>ビルドツールのなかでは、Rollupや<a href="https://www.snowpack.dev/">Snowpack</a>の勢いが強まっていますが、最も定評があるのはWebpackのようです。
Webpackでは、ビルドの容量を最適化するために、文字どおり何百ものプラグインが利用できます。
<a href="https://webpack.js.org/blog/2020-12-08-roadmap-2021/">Webpack Roadmap 2021</a>に注目しましょう。</p>
<p>最近登場した特に注目すべき戦略の1つは、<a href="https://web.dev/granular-chunking-nextjs/">Next.jsとGatsbyにおいてWebpackでグラニュラチャンキングを行い</a>、コードの重複を最小化することです。
デフォルトでは、すべてのエントリポイントで共有されていないモジュールは、それを利用しないルートでもリクエストされる可能性があります。
その結果、必要以上にコードがダウンロードされ、オーバーヘッドが発生します。
Next.jsにおけるグラニュラチャンキングでは、<strong>サーバサイドのビルドマニフェストファイル</strong>を利用して、出力されたどのチャンクをさまざまなエントリポイントで使用するかを決定できます。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/733b3ac0-489e-44d5-b7ed-bcfa67a6a575/js-size-reductions-across-all-routes.jpg">
<em>Webpackプロジェクトのコードの重複を削減するためにgranular chunkingを利用できます。Next.jsとGatsbyではデフォルトで有効です。画像の出典：<a href="https://twitter.com/addyosmani/status/1256153891135258624">Addy Osmani</a>。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/733b3ac0-489e-44d5-b7ed-bcfa67a6a575/js-size-reductions-across-all-routes.jpg">プレビューを拡大</a>）</em></p>
<p><a href="https://webpack.js.org/plugins/split-chunks-plugin/">SplitChunksPlugin</a>では、いくつかの条件に応じて複数の分割済みのチャンクを作成し、複数のルートで重複したコードを取得することを防ぎます。
これはページの読み込み時間や、操作中のキャッシングを改善します。
この機能はNext.js 9.2とGatsby v2.20.7に搭載されています。</p>
<p>とはいえ、Webpackを始めるのは難しいかもしれません。
そこで、Webpackの世界に飛び込みたい人のために、素晴らしいリソースを紹介します。</p>
<ul>
<li><a href="https://webpack.js.org/concepts/">Webpackのドキュメント</a>は、当然ながら、良い出発点となります。Raja Raoの<a href="https://medium.com/%40rajaraodv/webpack-the-confusing-parts-58712f8fcad9">Webpack — The Confusing Bits</a>や、Andrew Welchの<a href="https://medium.com/%40rajaraodv/webpack-the-confusing-parts-58712f8fcad9">An Annotated Webpack Config</a>も最初の一歩に適しています。</li>
<li>Sean Larkinは<a href="https://webpack.academy/p/the-core-concepts">Webpack:The Core Concepts</a>という無料の講義を提供しています。Jeffrey Wayも<a href="https://laracasts.com/series/webpack-for-everyone">Webpack for Everyone</a>という素晴らしい無料の講義を公開しています。どちらもWebpackの導入として優れた内容です。</li>
<li><a href="https://frontendmasters.com/courses/webpack-fundamentals/">Webpack Fundamentals</a>は、FrontendMastersが公開したSean Larkinによる4時間の講義で、とても包括的な内容となっています。</li>
<li><a href="https://github.com/webpack/webpack/tree/master/examples">Webpack examples</a>は、トピックと目的別に、すぐに使えるWebpack設定を数多く公開しています。さらに、基本設定ファイルを生成する<a href="https://webpack.jakoblind.no/">Webpack設定のコンフィギュレータ</a>もあります。</li>
<li><a href="https://github.com/webpack-contrib/awesome-webpack">awesome-webpack</a>は、Webpackに関する便利なリソース、ライブラリ、ツールを厳選したリストです。記事、動画、講義、書籍や、Angular、Reactやフレームワークを問わないプロジェクトの例も含まれています。</li>
<li><a href="https://codeascraft.com/2020/02/03/production-webpack-builds/">The journey to fast production asset builds with Webpack</a>はEtsyのケーススタディです。EtsyがどのようにRequireJSベースのJavaScriptビルドシステムからWebpackへ移行し、どうやってビルドを最適化し、13,200を超えるアセットを平均<strong>4分</strong>で管理しているかを説明しています。
<a href="https://twitter.com/iamakulov/status/1275769142809944064">Webpack performance tips</a>は、Ivan Akulovによる宝の山のようなスレッドです。パフォーマンスに焦点を当てた数多くのtipsを紹介しており、その中には<a href="https://twitter.com/iamakulov/status/1275819105644412942">特にWebpackに焦点を当てたものもあります</a>。</li>
<li><a href="https://github.com/iamakulov/awesome-webpack-perf">awesome-webpack-perf</a>というGitHubリポジトリは、パフォーマンス向上のための便利なWebpackツールとプラグインの宝庫です。こちらもIvan Akulovがメンテナンスしています。</li>
</ul>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/df28a3b5-b899-4a9e-93d1-be97569e9198/etsy-journey-fast-production-builds-webpack.jpg">
<em>Etsyが<a href="https://codeascraft.com/2020/02/03/production-webpack-builds/">Webpackによって本番環境用の高速なビルドを実現するまでの道のり</a>（<a href="https://twitter.com/addyosmani/status/1240563662143668224">Addy Osmani</a>より）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/df28a3b5-b899-4a9e-93d1-be97569e9198/etsy-journey-fast-production-builds-webpack.jpg">プレビューを拡大</a>）</em></p>
<h3>11. プログレッシブエンハンスメントをデフォルトで使用する。</h3>
<p><a href="https://briefs.video/videos/is-progressive-enhancement-dead-yet/">プログレッシブエンハンスメント</a>は、提唱されてから何年も経ちますが、それでもフロントエンドのアーキテクチャやデプロイの指針としておくのが無難です。
まずは中心となるユーザ体験の設計・開発を行い、それから先進的な機能によって対応ブラウザのユーザ体験を向上させることで、ユーザ体験を<a href="https://resilientwebdesign.com/">強固</a>にすることができます。貧弱な画面とブラウザを搭載した遅いマシンが、最適化されていないネットワークからアクセスしてもWebサイトの動作が速いのならば、優れたブラウザを搭載した高速なマシンが、真っ当なネットワークからアクセスすればもっと速く動くはずです。</p>
<p>実際、<a href="https://www.youtube.com/watch?v=puUPpVrIRkc&#x26;t=488s">アダプティブなモジュール提供</a>によって、プログレッシブエンハンスメントは新たなレベルに進んだように感じられます。
これは、ローエンドの端末には中核のみの「ライト」なユーザ体験を提供し、ハイエンドの端末では洗練された機能によってユーザ体験を向上させるというものです。
プログレッシブエンハンスメントは、当面は消えないでしょう。</p>
<h3>12. パフォーマンスの強固な基準を選択する。</h3>
<p>読み込みに影響を与える未知の要因は数多くあります。
例えば、ネットワーク、サーマルスロットリング、キャッシュエビクション、サードパーティのスクリプト、パーサのブロッキングパターン、ディスクI/O、IPCレイテンシ、インストール済みの拡張機能、アンチウイルスソフトウェアとファイアウォール、バックグラウンドのCPUタスク、ハードウェアとメモリの制約、L2とL3のキャッシングの差、RTTSなどです。
その中でも<a href="https://v8.dev/blog/cost-of-javascript-2019">JavaScript</a>は、レンダリングをデフォルトでブロックするWebフォントや、メモリを使いすぎることが多い画像に次いで、ユーザ体験の中で特にコストが重い部分となっています。
パフォーマンスのボトルネックが<a href="https://calendar.perfplanet.com/2017/tracking-cpu-with-long-tasks-api/">サーバからクライアントへ移動している</a>ことを踏まえ、私たち開発者はこうした未知の要因のすべてをもっと詳しく検討する必要があります。</p>
<p>170KBのバジェットには、すでにクリティカルパスHTML/CSS/JavaScript、ルータ、状態管理、ユーティリティ、フレームワーク、アプリケーションロジックが含まれているため、選択したフレームワークの<a href="https://www.twitter.com/kristoferbaxter/status/908144931125858304">ネットワーク転送コスト、パース/コンパイル時間、ランタイムコストを徹底的に検証</a>（※訳注：原文指定URL消失）しなければなりません。
幸運なことに、過去数年間で、ブラウザによるスクリプトのパースとコンパイルの速度は大幅に改善しています。
しかし、JavaScriptの実行は依然として主要なボトルネックとなっているため、スクリプトの実行時間とネットワークによく注意すれば大きな効果があるでしょう。</p>
<p>Tim Kadlecは、モダンなフレームワークのパフォーマンスについて素晴らしい調査を実施しており、その内容を"<a href="https://timkadlec.com/remembers/2020-04-21-the-cost-of-javascript-frameworks/">JavaScript frameworks have a cost</a>"という記事にまとめています。
私たちはスタンドアロンのフレームワークの影響についてよく議論しますが、Timが述べているとおり、<strong>実際には複数のフレームワークを利用する</strong>ことは珍しくありません。
例えば、モダンなフレームワークにゆっくりと移行しつつある旧バージョンのjQueryと、旧バージョンのAngularを利用したいくつかの古いアプリケーションを併用しているかもしれません。
そのため、JavaScriptバイト数とCPU実行時間の<strong>累積コスト</strong>を調査する方が合理的です。
この累積コストによって、たとえハイエンド端末でも、ぎりぎり利用できるレベルのユーザ体験までたちまち落ち込んでしまう可能性があります。</p>
<p>一般に、モダンなフレームワークは、<strong>あまり高性能でない端末を重視していません</strong>。
そのため、スマートフォンとデスクトップにおけるユーザ体験は、パフォーマンスの面で劇的に異なることがよくあります。
調査によれば、ReactやAngularを利用したサイトは、他のサイトよりもCPU時間が長い傾向があります（当然ながら、必ずしもReactがVue.jsよりもCPUにとって高コストという意味ではありません）。</p>
<p>Timによれば、一つ明確に言えるのは、「サイトのビルドにフレームワークを使用する場合、たとえ最善のシナリオであっても、<strong>初期のパフォーマンス</strong>に関するトレードオフが発生する」ということです。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f892dfcd-f690-40b5-ad33-218a33cc85b3/cost-of-frameworks-cpu-mobile-only.png">
<img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/876d32d5-0a68-4a08-b3f1-d4c103729cfa/cost-of-frameworks-bytes-desktop.png">
<em>モバイル端末のスクリプト関連のCPU時間と、デスクトップ端末のJavaScriptバイト数。一般に、ReactやAngularを利用しているサイトは、他のサイトよりもCPU時間が長い傾向があります。しかし、これはサイトをビルドする方法によって変わります。<a href="https://timkadlec.com/remembers/2020-04-21-the-cost-of-javascript-frameworks/">Tim Kadlecの調査</a>より。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/876d32d5-0a68-4a08-b3f1-d4c103729cfa/cost-of-frameworks-bytes-desktop.png">プレビューを拡大</a>）</em></p>
<h3>13. フレームワークと依存関係を評価する。</h3>
<p>現在、<a href="https://twitter.com/jaffathecake/status/923805333268639744">あらゆるプロジェクトがフレームワークを必要とするわけでも、シングルページアプリケーションのあらゆるページがフレームワークの読み込みを必要とするわけでもありません</a>。
Netflixの場合、「React、複数のライブラリ、対応するアプリのコードをクライアントサイドから削除したところ、JavaScriptの総容量を200KB以上削減し、ログアウト後のホームページにおける<a href="https://www.youtube.com/watch?t=11m32s&#x26;v=V8oTJ8OZ5S0&#x26;feature=youtu.be">NetflixのTime To Interactiveを50％以上減らすことができました</a>」。
同社のチームは、ユーザがランディングページで消費する時間を利用して、ユーザが次にアクセスする可能性が高いページのReactを先読みするようにしました（<a href="https://jakearchibald.com/2017/netflix-and-react/">詳細はこちら</a>）。</p>
<p>それでは、クリティカルなページから既存のフレームワークを完全に削除した場合はどうなるでしょうか。
Gatsbyでは、<a href="https://www.npmjs.com/package/gatsby-plugin-no-javascript">gatsby-plugin-no-javascript</a>によって、Gatsbyが作成したすべてのJavaScriptファイルを静的HTMLファイルから削除できます。
Vercelでは、<a href="https://github.com/vercel/next.js/pull/11949">特定のページについて、本番環境のランタイムJavaScriptを無効化できます</a>（実験的な機能です）。</p>
<p>フレームワークを選択すると、少なくとも数年間はそのフレームワークを使い続けます。
そのため、フレームワークを使用する必要がある場合は、<a href="https://www.youtube.com/watch?v=6I_GwgoGm1w">十分な情報に基づき</a>、<a href="https://medium.com/%40ZombieCodeKill/choosing-a-javascript-framework-535745d0ab90#.2op7rjakk">よく考えて</a>選択しなければなりません。これは私たちが重視する主要なパフォーマンス指標に関して特に当てはまります。</p>
<p>データによれば、フレームワークは、デフォルトではとても高コストです。
<a href="https://twitter.com/hdjirdeh/status/1280731085379211265">Reactページの58.6％には1MB超のJavaScriptが含まれており</a>、Vue.jsのページ読み込みのFirst Contentful Paintが1.5秒未満である割合は36％です。
<a href="https://blog.uncommon.is/the-baseline-costs-of-javascript-frameworks-f768e2865d4a">Ankur Sethiの調査</a>によれば、「Reactアプリケーションは、どんなに最適化しても、インドの平均的なスマートフォンでは<strong>読み込みが約1.1秒より速くならない</strong>でしょう。
Angularアプリは、起動まで常に2.7秒以上かかります。Vueアプリのユーザは、利用を始められるまで1秒以上待つ必要があります」。
いずれにせよ、インドはあなたの主要なターゲット市場ではないかもしれません。
しかし、最適ではないネットワーク環境からサイトにアクセスするユーザは、同様の体験をするでしょう。</p>
<p>もちろん、SPAを高速化することは可能ですが、最初から速いわけではありません。
そのため、SPAを高速化し、それを維持し続けるための時間と労力を考慮する必要があります。
おそらく、初めはパフォーマンスコストの基準を低めに設定する方が簡単でしょう。</p>
<p><strong>それでは、どのようにフレームワークを選択すれば良いのでしょうか</strong>。
選択肢を選ぶ前に、少なくとも容量と初期実行時間の合計コストについて考えると良いでしょう。
<a href="https://github.com/developit/preact">Preact</a>、<a href="https://github.com/infernojs/inferno">Inferno</a>、<a href="https://vuejs.org/">Vue</a>、<a href="https://svelte.technology/">Svelte</a>、<a href="https://www.smashingmagazine.com/2020/03/introduction-alpinejs-javascript-framework/">Alpine</a>、<a href="https://github.com/Polymer/polymer">Polymer</a>などのコストが軽い選択肢でも、十分役割を果たします。
基準となる容量が、アプリケーションのコードの制約を定めることとなります。</p>
<p>Seb Markbågeが<a href="https://twitter.com/sebmarkbage/status/829733454119989248">述べている</a>とおり、フレームワークのスタートアップコストを測定する良い方法の1つは、<strong>まず画面をレンダリングし、次にそれを削除し、またレンダリングする</strong>ことです。
それによって、フレームワークがどのように拡大するかが分かります。
最初のレンダリングは、コンパイルが遅いコードのウォームアップとしての役割を果たします。
これらのコードは、拡大する際にツリー全体にメリットをもたらします。
2回目のレンダリングは基本的に、ページの複雑性が増す場合に、ページにおけるコードの再利用がパフォーマンス特性にどのような影響を与えるかをエミュレートするものです。</p>
<p>Sacha Greifの<a href="https://medium.freecodecamp.org/the-12-things-you-need-to-consider-when-evaluating-any-new-javascript-library-3908c4ed3f49">12項目からなるスコアリングシステム</a>では、例えば機能、アクセシビリティ、安定性、パフォーマンス、<strong>パッケージのエコシステム</strong>、コミュニティ、学習曲線、ドキュメント、ツール、実績、チーム、互換性、セキュリティなどを調査することで、候補（あるいはJavaScriptライブラリ全般）を評価することまで可能です。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/6c1d426d-cf12-43de-a926-cea743ac1bf3/perf-track-opt.png">
<em><a href="https://perf-track.web.app/">Perf Track</a>は、フレームワークのパフォーマンスを広範囲にわたって追跡します。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/6c1d426d-cf12-43de-a926-cea743ac1bf3/perf-track-opt.png">プレビューを拡大</a>）</em></p>
<p>長い時間をかけてWebで収集されたデータに頼ることもできます。
例えば、<a href="https://perf-track.web.app/">Perf Track</a>は広範囲にわたってフレームワークのパフォーマンスを追跡しており、Angular、React、Vue、Polymer、Preact、Ember、Svelte、AMPでビルドしたWebサイトのオリジンの<strong>Core Web Vitals</strong>スコアの合計値を明らかにしています。
Gatsby、Next.js、Create React Appや、Nuxt.js（Vue）、Sapper（Svelte）でビルドしたWebサイトを指定し、比較することも可能です。</p>
<p>手始めに、アプリケーションにとって<strong>適切なデフォルトのフレームワーク</strong>を選ぶことから始めると良いでしょう。
<a href="https://gatsbyjs.org/">Gatsby</a>（React）、<a href="https://nextjs.org/">Next.js</a>（React）、<a href="https://vuepress.vuejs.org/">Vuepress</a>（Vue）、<a href="https://github.com/developit/preact-cli">Preact CLI</a>、<a href="https://github.com/Polymer/pwa-starter-kit">PWA Starter Kit</a>は、平均的なモバイルハードウェアにおいて初期設定で高速な読み込みを実現できるため、デフォルトとしてちょうど良い存在です。
また、<a href="https://web.dev/learn/#frameworks">web.devによるReactとAngularのためのフレームワークごとのパフォーマンスガイド</a>も見てみましょう（Phillipに感謝します）。</p>
<p>シングルページアプリケーションを丸ごとビルドするときは、少し目新しいアプローチを実践できるかもしれません。
<a href="https://github.com/turbolinks/turbolinks">Turbolinks</a>は15KBのJavaScriptライブラリで、画面のレンダリングにJSONではなくHTMLを使用します。
リンク先にアクセスすると、ページ全体を読み込むコストを発生させることなく、Turbolinksがページを自動的に取得し、 <code class="language-text">&lt;body&gt;</code> 要素を置き換え、 <code class="language-text">&lt;head&gt;</code> 要素をマージします。
<a href="https://twitter.com/dhh/status/1341420143239450624">詳細を手早く知りたい人はこちら</a>、<a href="https://hotwire.dev/">Turbolinksの完全なドキュメントについてはこちら（Hotwire）</a>をご確認ください。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/fb9e201e-6247-4cf2-911f-ab968623981c/09-high-sell-phones-front-end-performance-checklist-2020.jpg">
<em>最も売れているスマートフォンのCPUと演算性能（画像の出典：<a href="https://speakerdeck.com/addyosmani/the-cost-of-javascript-in-2019">Addy Osmani</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/fb9e201e-6247-4cf2-911f-ab968623981c/09-high-sell-phones-front-end-performance-checklist-2020.jpg">プレビューを拡大</a>）</em></p>
<h3>14. クライアントサイドレンダリングか、サーバサイドレンダリングか？答えは両方。</h3>
<p>これはとても熱い議論が交わされるテーマです。
究極的なアプローチは、一種の<a href="https://aerotwist.com/blog/when-everything-is-important-nothing-is/">段階的な起動</a>を導入することでしょう。
つまり、サーバサイドレンダリングを使用してFirst Contentful Paintを高速化する一方、必要最低限のJavaScriptを導入し、Time To InteractiveがFirst Contentful Paintと乖離しないようにします。
JavaScriptがFCPよりも遅すぎる場合、ブラウザは、そのJavaScriptをパース、コンパイル、実行する間に<a href="https://davidea.st/articles/measuring-server-side-rendering-performance-is-tricky">メインスレッドをロック</a>するため、<a href="https://philipwalton.com/articles/why-web-developers-need-to-care-about-interactivity/">サイトやアプリケーションのインタラクティブ性を低下させる</a>こととなります。</p>
<p>これを避けるには、<strong>関数の実行を個別の非同期タスクに常に分割</strong>し、可能な場合は<code class="language-text">requestIdleCallback</code>を使用しましょう。
Webpackの<a href="https://developers.google.com/web/updates/2017/11/dynamic-import">動的な<code class="language-text">import()</code>サポート</a>を利用してUIの一部の読み込みを遅延させることで、読み込み、パース、コンパイルのコストを、ユーザが本当に必要になるまで回避できないか検討してみましょう（Addyに感謝します）。</p>
<p>上記のとおり、Time To Interactive（TTI）は、ナビゲーションの時点とインタラクションが可能になる時点までの間の時間を表します。
厳密には、この指標は、最初のコンテンツのレンダリング後、<strong>所要時間が50ミリ秒を超える</strong>JavaScriptタスク（ロングタスク）が存在しない状態が初めて5秒間続いた時点として定義されます。
50ミリ秒を超えるタスクが発生すると、5秒間の計測はやり直しです。
その結果、ブラウザが初めてインタラクティブになったかと思えば、すぐにインタラクティブでなくなり、最終的にはインタラクティブな状態に戻るという状況が起きます。</p>
<p>インタラクティブな状態に達すると、必要に応じて、あるいは時間が許す限り、アプリの本質的でない部分を起動することができます。
残念ながら、<a href="https://aerotwist.com/blog/when-everything-is-important-nothing-is/#which-to-use-progressive-booting">Paul Lewisが指摘したとおり</a>、フレームワークは通常、開発者にも分かる単純な優先順位の概念を持っていません。
そのため、ほとんどのライブラリとフレームワークでは、段階的な起動を導入するのは簡単ではありません。</p>
<p>それでも、私たちは段階的な起動に近づいています。最近はいくつかの選択肢を検討できるようになりました。
Houssein DjirdehとJason Millerの<a href="https://www.youtube.com/watch?v=k-A2VfuUROg">Rendering on the Web</a>という講演と、JasonとAddyの<a href="https://developers.google.com/web/updates/2019/02/rendering-on-the-web">モダンなフロントエンドアーキテクチャ</a>に関する記事は、こうした選択肢の全体像が分かる素晴らしい内容です。
以下の概要は、彼らの優れた成果に基づくものです。</p>
<ul>
<li>
<p><strong>フルサーバサイドレンダリング（SSR）</strong></p>
<p>WordPressなどの古典的なSSRでは、すべてのリクエストは完全にサーバ上で処理されています。
リクエストされたコンテンツは、完成したHTMLページとして返送され、ブラウザはそれをすぐにレンダリングすることができます。
そのため、SSRアプリは、例えばDOM APIをあまり活用できません。
First Contentful PaintとTime To Interactiveのギャップは通常は小さく、HTMLがブラウザに送信された時点ですぐにページをレンダリングできます。</p>
<p>ブラウザが応答を得る前に処理が行われるため、データを取得し、クライアント側でテンプレートを作成するための追加的なラウンドトリップの必要はありません。
しかし、<strong>サーバのシンクタイム</strong>、ひいてはTime To First Byteが<strong>長くなり</strong>、モダンなアプリケーションのレスポンシブでリッチな機能は活用できません。</p>
</li>
<li>
<p><strong>静的レンダリング</strong></p>
<p>プロダクトはシングルページアプリケーションとしてビルドされますが、ビルドのステップの一環として、すべてのページが最小限のJavaScriptによって静的HTMLへとプリレンダリングされます。
このことは、静的レンダリングでは、<strong>あり得るすべてのURL</strong>に対して個別のHTMLファイルを事前に生成することを意味しますが、これは多くのアプリケーションにとって可能ではありません。
しかし、ページのHTMLをすぐに生成する必要はないため、一貫して高速なTime To First Byteを実現できます。
したがって、ランディングページを速く表示し、その後のページのSPAフレームワークを先読みすることが可能です。
<a href="https://medium.com/dev-channel/a-netflix-web-performance-case-study-c0bcde26a9d9">Netflixはこのアプローチを採用し</a>、読み込みとTime To Interactiveを50％削減しています。</p>
</li>
<li>
<p><strong>サーバサイドレンダリングと（リ）ハイドレーション（ユニバーサルレンダリング、SSR + CSR）</strong></p>
<p>SSRとCSRの両方のアプローチの良いとこ取りを目指すことも可能です。
ハイドレーションを利用する場合、サーバから返送されるHTMLページには、クライアントサイドの完全なアプリケーションを読み込むスクリプトも含まれています。
それによって、（SSRのように）高速なFirst Contentful Paintを実現し、それから（リ）ハイドレーションによるレンダリングを続けるのが理想です。
残念なことに、こうしたケースはまれです。
たいてい、ページの準備は整っているように見えるのに、ユーザの入力には応答できず、レイジクリックや離脱につながっています。</p>
<p>Reactでは、<a href="https://alligator.io/react/server-side-rendering/">ExpressなどのNodeサーバで<code class="language-text">ReactDOMServer</code>モジュールを使用</a>し、トップレベルのコンポーネントを静的なHTML文字列としてレンダリングするために<code class="language-text">renderToString</code>メソッドを呼び出すことができます。</p>
<p>Vue.jsでは、<a href="https://ssr.vuejs.org/">vue-server-rendererを使用</a>し、<code class="language-text">renderToString</code>でVueインスタンスをHTMLにレンダリングすることが可能です。
Angularでは、<a href="https://angular.io/guide/universal">@nguniversalを使用</a>し、クライアントのリクエストを、サーバによって完全にレンダリングされたHTMLページに変換できます。
<a href="https://nextjs.org/">Next.js</a>（React）や<a href="https://nuxtjs.org/">Nuxt.js</a>（Vue）では、完全なサーバサイドレンダリング体験を最初から実現可能です。</p>
<p>このアプローチにはデメリットがあります。クライアントサイドアプリの完全な柔軟性を実現しつつ、高速なサーバサイドレンダリングを提供できる一方で、First Contentful PaintとTime To Interactiveの<strong>ギャップが拡大</strong>し、First Input Delayが増加するのです。
<a href="https://addyosmani.com/blog/rehydration/">リハイドレーションはコストがとても大きくなります</a>。
この戦略だけでは、Time To Interactiveが大幅に遅くなるため、通常は十分ではありません。</p>
</li>
<li>
<p><strong>ストリーミングサーバサイドレンダリングとプログレッシブハイドレーション（SSR + CSR）</strong></p>
<p>Time To InteractiveとFirst Contentful Paintのギャップを最小限にするために、複数のリクエストを同時にレンダリングし、<strong>コンテンツが生成されるたびにチャンクとして送信</strong>します。
そのため、ブラウザにコンテンツを送信する前に完全なHTML文字列を待つ必要がなく、Time To First Byteが改善されます。</p>
<p>Reactでは、renderToString()の代わりに<a href="https://reactjs.org/docs/react-dom-server.html#rendertonodestream">renderToNodeStream()</a>を使用することで、応答をパイプし、HTMLをチャンクで送信できます。
Vueでは、<a href="https://ssr.vuejs.org/guide/streaming.html">renderToStream()</a>によるパイプとストリームが可能です。
React Suspenseでは、同じ目的に<a href="https://medium.com/maxime-heckel/asynchronous-rendering-with-react-c323cda68f41">非同期レンダリング</a>を使用できるでしょう。</p>
<p>クライアントサイドでは、アプリケーション全体を一度に起動するのではなく、<strong>コンポーネントを段階的に起動します</strong>。
まずアプリケーションのセクションをコード分割によって独立したスクリプトに分割し、次にそれを（優先順位に従って）徐々にハイドレートします。
つまり、クリティカルなコンポーネントを先にハイドレートし、残りは後でハイドレートすることができます。
クライアントサイドとサーバサイドのレンダリングの役割は、コンポーネントごとに異なる形で定義することが可能です。
また、コンポーネントが表示されるまで、またはそれがユーザとのインタラクションに必要になるまで、あるいはブラウザがアイドル状態になるまで、一部のコンポーネントの<strong>ハイドレーションを遅らせる</strong>こともできます。</p>
<p>Vueについては、Markus Oberlehnerが、<a href="https://markus.oberlehner.net/blog/how-to-drastically-reduce-estimated-input-latency-and-time-to-interactive-of-ssr-vue-applications/">ユーザとのインタラクションに応じたハイドレーション</a>と<a href="https://github.com/maoberlehner/vue-lazy-hydration">vue-lazy-hydration</a>を使用してSSRアプリのTime To Interactiveを削減するためのガイドを公表しています。
vue-lazy-hydrationは、コンポーネントの表示や特定のユーザインタラクションに応じたハイドレーションを可能にする初期段階のプラグインです。
Angularチームは、<a href="https://github.com/vikerman/ivy-universal">Ivy Universal</a>を使用してプログレッシブハイドレーションに取り組んでいます。
<a href="https://medium.com/%40luke_schmuke/how-we-achieved-the-best-web-performance-with-partial-hydration-20fab9c808d5">PreactとNext.jsでパーシャルハイドレーションを実装する</a>こともできます。</p>
</li>
<li>
<p><a href="https://developers.google.com/web/updates/2019/02/rendering-on-the-web#trisomorphic"><strong>トライソモルフィックレンダリング</strong></a></p>
<p>サービスワーカーを導入している場合、初期やJS以外のナビゲーションには<strong>ストリーミングサーバレンダリング</strong>を使用し、それらがインストールされた後に、サービスワーカーがナビゲーションのためのHTMLレンダリングに取りかかるようにすることができます。
この場合、サービスワーカーはコンテンツをプリレンダリングし、同一セッション内の新規ビューをレンダリングするためのSPAスタイルのナビゲーションを有効にします。
サーバ、クライアントページ、サービスワーカーの間で同じテンプレートやルーティングコードを共有できる場合に効果的です。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d1c78c47-f803-4923-96ff-99c6a4a14cbb/08-trisomorphic-front-end-performance-checklist-2020.png">
<em>トライソモルフィックレンダリングでは、サーバ、DOM、サービスワーカーの3カ所のどこでも同じコードをレンダリングします。（画像の出典：<a href="https://developers.google.com/web/updates/2019/02/rendering-on-the-web#trisomorphic">Google Developers</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/d1c78c47-f803-4923-96ff-99c6a4a14cbb/08-trisomorphic-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</em></p>
</li>
<li>
<p><strong>CSRとプリレンダリング</strong></p>
<p>プリレンダリングはサーバサイドレンダリングに似ていますが、サーバでページを動的にレンダリングするのではなく、ビルドの際にアプリケーションを静的HTMLへレンダリングします。
静的なページは、クライアントサイドのJavaScriptがあまり存在しなくても完全にインタラクティブとなりますが、<strong>プリレンダリングの仕組みは異なっています</strong>。
基本的に、プリレンダリングは、ビルド時にクライアントサイドアプリケーションの初期状態を静的HTMLとして取得します。
一方で、ページをインタラクティブにするにはアプリケーションをクライアント側で起動する必要があります。</p>
<p>Next.jsでは、アプリを静的HTMLにプリレンダリングすることで、<a href="https://nextjs.org/docs/advanced-features/static-html-export">静的HTMLエクスポート</a>を使用できます。
Reactを使用したオープンソースの静的サイトジェネレータである<a href="https://www.gatsbyjs.org/">Gatsby</a>では、<code class="language-text">renderToString</code>メソッドの代わりに<code class="language-text">renderToStaticMarkup</code>メソッドをビルド時に使用しています。
シンプルな静的ページには不要なDOM属性を使わず、メインのJSチャンクをプリロードし、将来のルートをプリフェッチします。</p>
<p>Vueでは、同じ目的を達成するために<a href="https://vuepress.vuejs.org/">Vuepress</a>を使用可能です。
<a href="https://github.com/GoogleChromeLabs/prerender-loader">Webpackではprerender-loader</a>も使用できます。
Naviも<a href="https://frontarm.com/navi/en/guides/static-rendering/">静的レンダリング</a>を提供しています。</p>
<p>その結果、Time To First ByteとFirst Contentful Paintが改善し、両者のギャップが縮小します。
コンテンツが大きく変化すると予想される場合、このアプローチは使用できません。
また、すべてのページを生成するには、事前にすべてのURLを把握する必要があります。
一部のコンポーネントはプリレンダリングを使用してレンダリングできることもありますが、動的な要素が必要な場合は、コンテンツを取得するためにアプリに頼らなければなりません。</p>
</li>
<li>
<p><strong>フルクライアントサイドレンダリング（CSR）</strong></p>
<p>すべてのロジック、レンダリング、起動がクライアント側で実施されます。
そのため、通常はTime To InteractiveとFirst Contentful Paintの間に膨大なギャップが発生します。
結果として、一部をレンダリングするだけでもクライアント側でアプリ全体を起動する必要があるため、アプリケーションが<strong>遅く感じることがよくあります</strong>。
JavaScriptにはパフォーマンスコストがあるため、アプリケーションに応じてJavaScriptの量が増加すると、その影響を抑えるために、積極的なコード分割とJavaScriptの遅延が絶対に必要になります。
こうしたケースでは、インタラクティブ性があまり必要とされない場合に備え、通常は<strong>サーバサイドレンダリング</strong>を採用する方が良いアプローチとなるでしょう。
それが不可能な場合は、<a href="https://developers.google.com/web/fundamentals/architecture/app-shell">App Shellモデル</a>の使用を検討してみましょう。</p>
<p>一般に、<a href="https://itnext.io/server-side-rendering-with-react-redux-and-react-router-fa5b67d4965e">SSRはCSRよりも高速です</a>。しかし、世の中の多くのアプリは、依然としてCSRを導入していることがよくあります。</p>
</li>
</ul>
<p>結局、クライアントサイドとサーバサイドのどちらが良いのでしょうか。一般に、<strong>完全なクライアントサイドのフレームワークを使用するのは、それが絶対に必要なページだけに制限する</strong>のが良いでしょう。高度なアプリケーションでは、サーバサイドのレンダリングのみに頼るのも良い考えではありません。サーバレンダリングとクライアントレンダリングのどちらも、不完全だと悲惨なことになります。
CSRとSSRのどちらが好みであるにせよ、重要なピクセルは可能な限り早くレンダリングし、レンダリングとTime To Interactiveのギャップは最小限になるようにしましょう。ページがあまり変化しない場合はプリレンダリングを検討し、可能ならばフレームワークの起動を遅らせてみてください。サーバサイドレンダリングでは<strong>HTMLをチャンクでストリーム</strong>し、クライアントサイドレンダリングでは<strong>プログレッシブハイドレーション</strong>を実装しましょう。そして、表示やインタラクションのタイミングで、あるいはアイドルタイムの間にハイドレーションを実施し、両者の良いとこ取りをしましょう。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/e8d2728f-ab3c-4b56-a265-e6c6d456e600/03-jason-front-end-performance-checklist-2020.png">
<em>クライアントサイドとサーバサイドのレンダリングの選択肢をスペクトルで表しています。また、Google I/OでJasonとHousseinが<a href="https://www.youtube.com/watch?v=k-A2VfuUROg">アプリケーションのアーキテクチャによるパフォーマンスへの影響</a>について議論した内容もチェックしてみましょう。（画像の出典：<a href="https://twitter.com/_developit/status/1093223382223605762">Jason Miller</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/e8d2728f-ab3c-4b56-a265-e6c6d456e600/03-jason-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</em></p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f7b675e3-6338-40ea-b7a1-5a07ee6e52cc/08-progressive-hydration-front-end-performance-checklist-2020.png">
<em>AirBnBはプログレッシブハイドレーションの実験を実施しています。不要なコンポーネントを遅らせ、ユーザインタラクション（スクロール）に応じて、またはアイドルタイムの間に読み込んでいます。これにより、TTIが改善することがテストで判明しています。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f7b675e3-6338-40ea-b7a1-5a07ee6e52cc/08-progressive-hydration-front-end-performance-checklist-2020.png">プレビューを拡大</a>）</em></p>
<h3>15. どれだけのコンテンツを静的な状態で提供できるか？</h3>
<p>開発しているのが大規模なアプリケーションであるにせよ、小規模なサイトであるにせよ、どのコンテンツなら、実行時に動的に生成するのではなく<strong>CDN（<a href="https://jamstack.org/">JAM Stack</a>）から静的に提供</strong>できるかを検討することには価値があります。
無数のプロダクトとフィルタや、数多くのカスタマイズの選択肢があったとしても、クリティカルなランディングページを静的に提供し、あなたが選んだフレームワークからそれらのページを分離したいと思うかもしれません。</p>
<p>世の中には多くの<a href="https://jamstack.org/generators/">静的サイトジェネレータ</a>があり、ジェネレータが生成するページは通常、<a href="https://www.11ty.dev/speedlify/">とても高速です</a>。
リクエスト時にサーバやクライアントでページビューを生成するのではなく、事前にプリビルドするコンテンツが多いほど、優れたパフォーマンスを実現できます。</p>
<p>Markus Oberlehnerは、<a href="https://markus.oberlehner.net/blog/building-partially-hydrated-progressively-enhanced-static-websites-with-isomorphic-preact-and-eleventy/">Building Partially Hydrated, Progressively Enhanced Static Websites</a>という記事で、プログレッシブエンハンスメントを実現し、JavaScriptのバンドル容量を最小限にしつつ、静的サイトジェネレータとSPAを使用してWebサイトを構築する方法を説明しています。
Markusはツールとして<strong>EleventyとPreact</strong>を使用しており、ツールの設定、パーシャルハイドレーションの追加、遅延ハイドレーション、クライアントエントリファイル、Preact向けのBabelの設定、RollupによるPreactのバンドルについて、始めから終わりまで解説しています。</p>
<p>最近は大規模サイトでJAMStackが使用されるようになったことで、パフォーマンスに関して新たに検討すべき問題が出てきました。
その問題とは<strong>ビルド時間</strong>です。
実際、新たなデプロイのたびに無数のページをビルドするのには数分間かかる可能性があります。
そのため、ビルド時間を60倍改善する<a href="https://www.gatsbyjs.com/blog/2020-04-22-announcing-incremental-builds/">Gatsbyのインクリメンタルビルド</a>を利用すると良いでしょう。
WordPress、Contentful、Drupal、Netlify CMSなどの一般的なCMSソリューションとのインテグレーション機能もあります。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/93501951-ccc7-48be-8f01-f148cbfa6c75/incremental-static-regeneration.png">
<em>Next.jsによるインクリメンタルな静的サイト再生成。（画像の出典：<a href="https://www.prisma.io/blog/jamstack-with-nextjs-prisma-jamstackN3XT">Prisma.io</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/93501951-ccc7-48be-8f01-f148cbfa6c75/incremental-static-regeneration.png">プレビューを拡大</a>）</em></p>
<p>また、Next.jsは<a href="https://nextjs.org/blog/next-9-5#stable-incremental-static-regeneration">事前のインクリメンタルな静的サイト生成</a>機能を発表しました。
この機能では、トラフィックの流入に伴い、バックグラウンドで再レンダリングを行うことで、ランタイムに新たな静的ページを追加し、既存のページがすでにビルドされた後も更新できるようになります。</p>
<p>もっとコストが軽いアプローチが必要な場合はどうすべきでしょうか。
Nicola Goutayは、<a href="https://www.youtube.com/watch?v=taOyVmLgym4">Eleventy, Alpine and Tailwind: towards a lightweight Jamstack</a>という講演で、CSR、SSRや両者の中間にあるものの違いや、コストが軽いアプローチを使用する方法を説明しています。
また、<a href="https://github.com/orbit-love/orbit-web">GitHubリポジトリ</a>ではアプローチの実践方法も紹介しています。</p>
<h3>16. PRPLパターンとアプリケーションシェルアーキテクチャの使用を検討する。</h3>
<p>フレームワークによって、パフォーマンスに与える影響は違っており、異なる最適化戦略が必要とされます。
そのため、自分が使用するフレームワークの仕組みはすべて明確に理解しなければなりません。
Webアプリを開発するときは、<a href="https://developers.google.com/web/fundamentals/performance/prpl-pattern/">PRPLパターン</a>と<a href="https://developers.google.com/web/updates/2015/11/app-shell">アプリケーションシェルアーキテクチャ</a>について検討しましょう。
考え方はとても単純です。
初期ルートが高速にレンダリングされるように、インタラクティブな状態を実現するために必要最小限のコードをプッシュし、サービスワーカーを使用したリソースのキャッシングとプリキャッシングを行います。
その後、必要なルートの非同期的な遅延読み込みを実施します。</p>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_auto/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/bb4716e5-d25b-4b80-b468-f28d07bae685/app-build-components-dibweb-c-scalew-879-opt.png">
<em><a href="https://developers.google.com/web/fundamentals/performance/prpl-pattern/">PRPL</a>は、クリティカルなリソースのプッシュ（Pushing）、初期ルートのレンダリング（Rendering）、残りのルートのプリキャッシング（Pre-caching）、残りのルートの必要に応じた遅延読み込み（Lazy-loading）の頭文字を表します。</em>
<img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_auto/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/6423db84-4717-4aeb-9174-7ae96bf4f3aa/appshell-1-o0t8qd-c-scalew-799-opt.jpg">
<a href="https://developers.google.com/web/updates/2015/11/app-shell">アプリケーションシェル</a>とは、ユーザインタフェースの機能に必要な最小限のHTML、CSS、JavaScriptです。</p>
<h3>17. APIのパフォーマンスを最適化しているか？</h3>
<p>APIは、アプリケーションがエンドポイントを通じて内部やサードパーティのアプリケーションにデータを提供するための通信チャネルです。
<a href="https://www.smashingmagazine.com/2012/10/designing-javascript-apis-usability/">APIのデザインとビルド</a>をするときは、サーバとサードパーティのリクエストの間の通信を可能にする妥当なプロトコルが必要です。
<a href="https://www.smashingmagazine.com/2018/01/understanding-using-rest-api/">Representational State Transfer</a>（<a href="https://web.archive.org/web/20130116005443/https:/tomayko.com/writings/rest-to-my-wife">REST</a>）は、そのようなプロトコルの中で、定評ある合理的な選択肢です。
RESTでは、パフォーマンスと信頼性が高いスケーラブルな方法でコンテンツをアクセス可能にするために、開発者が従うべき一連の制約を定めています。
RESTの制約に従うWebサービスは、RESTfulなWebサービスと呼ばれます。</p>
<p>古き良きHTTPリクエストと同様に、APIからデータが取得される場合、サーバの応答の遅れはエンドユーザにも波及し、そのため<strong>レンダリングが遅延</strong>します。
リソースが何らかのデータをAPIから取得する場合、対応するエンドポイントからデータをリクエストする必要があります。
コメント、および各コメントの筆者の写真が付属している記事など、複数のリソースからデータをレンダリングするコンポーネントは、レンダリングが可能になる前に、すべてのデータを取得するためにサーバとの間で複数回のラウンドトリップが必要になるかもしれません。
さらに、RESTを通じて返されるデータの量は、コンポーネントのレンダリングに必要な量を超えていることがよくあります。</p>
<p>多くのリソースがAPIからのデータを必要とする場合、APIがパフォーマンスのボトルネックとなりかねません。</p>
<p><a href="https://graphql.org/">GraphQL</a>は、こうした問題の有効な解決策となります。
GraphQLはいわば、API向けのクエリ言語であり、データ用に定義した型システムを使用してクエリを実行するためのサーバサイドのランタイムです。
RESTとは異なり、GraphQLは1度のリクエストですべてのデータを取得できます。
返されるデータは必要なちょうどの量となっており、RESTでよくある過大なデータや過少なデータの取得は起きません。</p>
<p>さらに、GraphQLはスキーマ（データの構造に関するメタデータ）を使用しているため、好きな構造にデータを組織することが可能です。
例えば、<a href="https://medium.com/%40wmdmark/how-graphql-replaces-redux-3fff8289221d">GraphQLなら、状態管理を処理するためのJavaScriptコードを削除</a>することで、以前よりもクリーンなアプリケーションコードを生成し、クライアント側での実行を高速化できます。</p>
<p>GraphQLを始めたい場合や、パフォーマンスに関する問題に直面している場合は、以下の記事が良い参考になるかもしれません。</p>
<ul>
<li><a href="https://www.smashingmagazine.com/2018/01/graphql-primer-new-api-part-1/">A GraphQL Primer: Why We Need A New Kind Of API</a>（Eric Baer著）</li>
<li><a href="https://www.smashingmagazine.com/2018/01/graphql-primer-new-api-part-2/">A GraphQL Primer: The Evolution Of API Design</a>（Eric Baer著）</li>
<li><a href="https://blog.logrocket.com/designing-graphql-server-optimal-performance/">Designing a GraphQL server for optimal performance</a>（Leonardo Losoviz著）</li>
<li><a href="https://medium.com/%40wtr/graphql-performance-explained-cb4b43412fb4">GraphQL performance explained</a>（Wojciech Trocki著）</li>
</ul>
<p><img src="https://res.cloudinary.com/indysigner/image/fetch/f_auto,q_80/w_2000/https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/5fda8d85-1151-4d0b-b2f6-da354ebae345/redux-rest-apollo-graphql.png">
<em>RESTとGraphQLの差を現した図。左側はRedux + REST、右側はApollo + GraphQLとの対話を表しています。（画像の出典：<a href="https://web.archive.org/web/20180324125829/https:/hackernoon.com/how-graphql-replaces-redux-3fff8289221d?gi=47fd50e442aa">Hacker Noon</a>）（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/5fda8d85-1151-4d0b-b2f6-da354ebae345/redux-rest-apollo-graphql.png">プレビューを拡大</a>）</em></p>
<h3>18. AMPとInstant Articlesのどちらを使用するか？</h3>
<p>組織の優先課題と戦略に応じて、Googleの<a href="https://www.ampproject.org/">AMP</a>、Facebookの<a href="https://www.facebook.com/formedia/solutions/instant-articles">Instant Articles</a>（※訳注：原文指定URL消失）、あるいはAppleの<a href="https://developer.apple.com/news-publisher/">Apple News</a>の使用を検討すると良いかもしれません。
これらがなくても優れたパフォーマンスを実現することはできますが、AMPは堅固なパフォーマンスフレームワークと無料のコンテンツデリバリネットワーク（CDN）を提供します。
一方、Instant ArticlesはFacebook上の表示とパフォーマンスを改善します。</p>
<p>こうした技術には、<strong>パフォーマンスが保証される</strong>というユーザにとって明確なメリットがあるように思われます。
ですから、場合によっては、サイズが膨大な可能性がある「通常の」ページよりも、AMP、Apple News、Instant Articlesのページへのリンクの方が好まれることさえあるでしょう。
大量のコンテンツを搭載し、多くのサードパーティコンテンツを扱うWebサイトにとって、こうした選択肢は、レンダリング時間を劇的に高速化するのに役立つ可能性があります。</p>
<p><a href="https://timkadlec.com/remembers/2018-03-19-how-fast-is-amp-really/">しかし、必ずしもそうとは限りません</a>。
Tim Kadlecによれば、例えば「AMPドキュメントは他のドキュメントよりも高速な傾向がありますが、それは必ずしもページのパフォーマンスが高いということを意味しません。
AMPは、パフォーマンスの観点で特に大きな違いをもたらすものではないのです」。</p>
<p>Webサイトの所有者にとってのメリットは明確です。
こうしたフォーマットは、各プラットフォーム上で見つけやすく、<a href="https://ethanmarcotte.com/wrote/ampersand/">検索エンジンにおいて見やすくなります</a>。</p>
<p>少なくとも、以前まではそうでした。
AMPはトップストーリーに表示されるための<a href="https://developers.google.com/search/blog/2020/05/evaluating-page-experience">必要条件ではなくなった</a>ため、パブリッシャは<a href="https://searchengineland.com/will-publishers-drop-amp-when-its-no-longer-a-requirement-for-top-stories-335612">AMPから離れ</a>、従来の方式に回帰する可能性があります（Barryに感謝します）。</p>
<p>それでも、AMPをPWAのデータソースとして再利用することで、<a href="https://www.smashingmagazine.com/2016/12/progressive-web-amps/">プログレッシブWeb AMP</a>を構築することも可能です。
デメリットはあるでしょうか。
当然ながら、クローズドプラットフォームでの表示のために、開発者は異なるバージョンのコンテンツを生成・維持する必要があります。
Instant ArticlesとApple Newsの場合は、そのバージョンには<a href="https://www.w3.org/blog/TAG/2017/07/27/distributed-and-syndicated-content-whats-wrong-with-this-picture/">実際のURLが存在しないこととなります</a>（AddyとJeremyに感謝します）。</p>
<h3>19. CDNを賢く選ぶ。</h3>
<p>上記のとおり、データが動的である度合いによっては、コンテンツの一部を<a href="https://www.staticgen.com/">静的サイトジェネレータ</a>に「アウトソース」できるかもしれません。
これをCDNにプッシュし、そこから静的なバージョンのコンテンツを提供すれば、サーバへのリクエストを回避することが可能です。
もっと言えば、こうしたジェネレータの一部は、実際には<a href="https://tomdale.net/2017/09/compilers-are-the-new-frameworks/">Webサイトのコンパイラ</a>であり、最初から多くの自動最適化機能が提供されています。
コンパイラが徐々に最適化を進めるため、コンパイルの出力も時とともに小さく、高速になります。</p>
<p>注目すべき点として、CDNは動的なコンテンツも提供（およびオフロード）することができます。
ですから、CDNを静的なアセットに限定する必要はありません。
利用しているCDNが圧縮と変換（例：エッジでの画像の最適化とサイズ変更）を行っているか、CDNが<a href="https://www.filamentgroup.com/lab/servers-workers.html">サーバワーカー</a>、<a href="https://www.youtube.com/watch?v=W-tBI_n0m_w">A/Bテスト</a>（CDNのエッジ（サーバがユーザと最も近い部分）でページの静的な部分と動的な部分を組み立てるエッジ処理を含む）などのタスクに対応しているかをダブルチェックしましょう。
また、<a href="https://blog.cloudflare.com/the-quicening/">利用しているCDNがHTTP over QUIC（HTTP/3）</a>をサポートしているか確認しましょう。</p>
<p>Katie Hempeniusは<a href="https://web.dev/content-delivery-networks/">CDNの素晴らしいガイド</a>を執筆しており、<strong>優れたCDNの選び方</strong>、それを微調整する方法、CDNを評価するときに留意が必要なあらゆる細かい事項に関する情報を提供しています。
一般に、コンテンツは可能な限り積極的にキャッシュし、Brotli、TLS 1.3、HTTP/2、HTTP/3などのCDNのパフォーマンス関連機能を有効化すると良いでしょう。</p>
<p><strong>注記</strong>：Patrick MeenanとAndy Daviesの調査によれば、<code class="language-text">HTTP/2における優先度の制御</code>は、<a href="https://github.com/andydavies/http2-prioritization-issues#cdns--cloud-hosting-services">多くのCDNでは実質的に機能していない</a>ため、CDNを選択するときは気を付けましょう。
Patrickは、自らの講演で<a href="https://youtu.be/sgjxuhFQktE?t=2626">HTTP/2における優先度</a>の制御について詳しく説明しています（Barryに感謝します）。</p>
<p><img src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/647c043f-c4f7-4d6f-ad28-31ca1828352b/cdnperf-preview.png">
<em><a href="https://www.cdnperf.com/">CDNPerf</a>は、毎日3億件のテストを収集・分析することにより、CDNのクエリの速度を測定します。（<a href="https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/647c043f-c4f7-4d6f-ad28-31ca1828352b/cdnperf-preview.png">プレビューを拡大</a>）</em></p>
<p>CDNを選ぶときは、以下の<strong>比較サイト</strong>で、機能の詳細を確認することができます。</p>
<ul>
<li><a href="https://cdncomparison.com/">CDN Comparison</a>は、Cloudfront、Azure、KeyCDN、Fastly、Verizon、Stackpach、Akamaiなどの数多くのCDNの比較表です。</li>
<li><a href="https://www.cdnperf.com/">CDN Perf</a>は、毎日3億件のテストを収集・分析することにより、CDNのクエリの速度を測定します。すべてのテスト結果は世界中のユーザのRUMデータに基づいています。<a href="https://www.dnsperf.com/">DNS Performance Comparison</a>と<a href="https://www.cloudperf.com/">Cloud Peformance Comparison</a>も確認してみましょう。</li>
<li><a href="https://www.cdnplanet.com/guides/">CDN Planet Guides</a>では、Serve Stale、Purge、Origin Shield、Prefetch、Compressionなどの個別のトピックに関して、CDNの概要を説明しています。</li>
<li><a href="https://almanac.httparchive.org/en/2019/cdn#cdn-adoption-and-usage">Web Almanac:CDN Adoption and Usage</a>は、上位のCDNプロバイダ、そのRTTとTLSの管理、TLSネゴシエーションタイム、HTTP/2の導入などに関する情報を提供します（残念ながら、データは2019年以降のものに限られます）。</li>
</ul>
<p>＜<a href="/front-end-performance-2021-checklist-2/#04">中編に続く</a>＞</p>
<p><em>※編注：本記事は2021年4月時点に公開されていた原文記事を翻訳した内容となります。翻訳記事公開にあたり、2023年6月時点で原文にてリンク切れとなっている箇所の削除や注記、原文に現在表示されていない内容を掲載している場合がございます。ご了承ください。</em></p>]]></content:encoded></item><item><title><![CDATA[2022年のCSS]]></title><description><![CDATA[写真： Jr Korpa on Unsplash Intro：2021年はこれまでCSSにとって盛りだくさんな一年でした。
CSSワーキンググループはCSSの仕様にさまざまな変更を加え、既存機能を改…]]></description><link>https://postd.cc/css-in-2022/</link><guid isPermaLink="false">https://postd.cc/css-in-2022/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[CSS]]></category><pubDate>Thu, 27 Apr 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p><em>写真： <a href="https://unsplash.com/@jrkorpa">Jr Korpa</a> on <a href="https://unsplash.com/s/photos/future">Unsplash</a></em></p>
<p><strong>Intro</strong>：2021年はこれまでCSSにとって盛りだくさんな一年でした。
CSSワーキンググループはCSSの仕様にさまざまな変更を加え、既存機能を改良するとともに多くの新機能を追加しました。
一部のブラウザには、すでに実験的に実装されているものもあります。</p>
<p>ブラウザベンダーは、新機能のサポートだけでなく、<a href="https://web.dev/compat2021/">開発者を悩ませるブラウザの互換性に関する5大問題</a>（<a href="https://wpt.fyi/compat2021?feature=summary">#compat2021</a>）の解決にも注力しています。</p>
<p><strong>2021年もそろそろ終わりに近づいているので、今回は2022年に実装されそうなCSS機能を紹介したいと思います。</strong></p>
<p><em>(※訳注：翻訳元の記事は2021年12月27日公開)</em></p>
<h2>目次</h2>
<ul>
<li><a href="#01">はじめに</a></li>
<li>
<p><a href="#02">注目の新機能（クロスブラウザ対応）</a></p>
<ul>
<li><a href="#03">コンテナクエリ</a></li>
<li><a href="#04">カスケードレイヤー</a></li>
<li><a href="#05">カラー関数</a></li>
<li><a href="#06">新しいビューポート単位</a></li>
<li><a href="#07">:has()擬似クラス</a></li>
<li><a href="#08">overscroll-behavior</a></li>
<li><a href="#09">サブグリッド</a></li>
<li><a href="#10">accent-color</a></li>
<li><a href="#11">メディアクエリの範囲指定</a></li>
</ul>
</li>
<li>
<p><a href="#12">今後期待の新機能（実験的実装／シングルブラウザ対応）</a></p>
<ul>
<li><a href="#13">ネスト（入れ子）</a></li>
<li><a href="#14">@scope</a></li>
<li><a href="#15">@when / @else</a></li>
</ul>
</li>
<li>
<p><a href="#16">現状維持が濃厚な期待の新機能</a></p>
<ul>
<li><a href="#17">スクロール連動型アニメーション</a></li>
<li><a href="#18">@property (😭)</a></li>
</ul>
</li>
<li><a href="#19">気になるSafariの動向</a></li>
<li><a href="#20">おわりに</a></li>
</ul>
<h2><a href="#01">#</a>はじめに<a name="01"></a></h2>
<p>誤解のないよう言っておきますが、この記事で紹介するリストは、筆者の<strong>個人的</strong>な予想です。
独自の情報や内部情報も、未来を映し出す水晶玉もありません。
あるのは、予想の根拠となる公開ソースだけです。
<a href="https://github.com/w3c/csswg-drafts/">CSSワーキンググループのIssue Tracker</a>を注視し、さまざまなブラウザベンダーをフォローすることで、このリストを作成するのに十分な情報を得ています。</p>
<p>これはあくまでも予想なので間違っている可能性もありますが、自信はかなりあります。
最終的にはほとんどの予想が的中していることでしょう。🙂</p>
<p>なお、このリストでは全く新しい機能やまだ一部のブラウザしか対応していない機能のみ紹介しています。
<a href="https://www.bram.us/2021/03/26/css-logical-properties-are-the-future-of-the-web-i18n/">論理値や論理プロパティ</a>、<a href="https://brm.us/aspect-ratio"><code class="language-text">aspect-ratio</code></a>、<a href="https://www.bram.us/2020/04/27/colors-in-css-hello-space-separated-functional-color-notations/">スペース区切りのカラー関数表記</a>などの機能が含まれていないのはそのためです。
これらも比較的新しい機能であり、まだ一般的には使用されていませんが、ほとんどのブラウザがすでに対応しています。</p>
<h2><a href="#02">#</a>注目の新機能（クロスブラウザ対応）<a name="02"></a></h2>
<p><strong>以下の機能については、2022年中にすべてのブラウザが対応すると確信しています</strong>。
一部のブラウザにはすでに搭載されている機能もあり、残りのブラウザも順次対応していくと思われます。
2022年は以下のCSS機能を学ぶと有益でしょう。</p>
<h3><a href="#03">#</a>コンテナクエリ<a name="03"></a></h3>
<p><em>（※訳注：2023年4月現在、全モダンブラウザでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/03/container-queries.png"></p>
<p>コンテナクエリ—<a href="https://drafts.csswg.org/css-contain-3/">css-contain-3</a>の一部を使用することで、作者はコンテナのサイズまたは見た目（スタイル）に応じて要素をスタイリングすることができます。
コンテナのサイズを基準としたコンテナクエリは<code class="language-text">@media</code>クエリと似ていますが、ビューポートではなく親コンテナのサイズが評価基準となる点が異なります。
コンテナのスタイルを基準としたコンテナクエリについては、別のCSSプロパティの計算値に応じてスタイルを条件付きで適用します。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">main, aside</span> <span class="token punctuation">{</span>
  <span class="token property">container</span><span class="token punctuation">:</span> inline-size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.media-object</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> grid<span class="token punctuation">;</span>
  <span class="token property">grid-template</span><span class="token punctuation">:</span> <span class="token string">'img'</span> auto <span class="token string">'content'</span> auto / 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@container</span> <span class="token punctuation">(</span>inline-size > 45em<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">.media-object</span> <span class="token punctuation">{</span>
    <span class="token property">grid-template</span><span class="token punctuation">:</span> <span class="token string">'img content'</span> auto / auto 1fr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>詳しくはこちらもご覧ください。<a href="https://brm.us/container-queries">CSS Container Queries: A First Look + Demo →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Blink/Chromium：Issue <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1145970">#1145970</a></em></li>
<li><em>Gecko/Firefox：Issue <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1744221">#1744221</a></em></li>
<li><em>WebKit/Safari：Issue <a href="https://bugs.webkit.org/show_bug.cgi?id=229659">#229659</a></em></li>
</ul></div></div>
<h3><a href="#04">#</a>カスケードレイヤー<a name="04"></a></h3>
<p><em>（※訳注：2023年4月現在、全モダンブラウザでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/09/css-cascade-cascade-layers-champ-bramus-560x315.png"></p>
<p>カスケードレイヤーを使用すると、同一オリジンルールのカスケード順序を適切に制御できます。
そのために、<code class="language-text">@layer</code>ルールを使用してスタイルをレイヤー化します。
カスケードにおけるレイヤーの順序は、詳細度（Specificity）と記述の順番（Order of Appearance）よりも上位に位置します。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@import</span><span class="token punctuation">(</span>reset.css<span class="token punctuation">)</span> <span class="token function">layer</span><span class="token punctuation">(</span>reset<span class="token punctuation">)</span><span class="token punctuation">;</span></span> <span class="token comment">/* 1st layer */</span>

<span class="token atrule"><span class="token rule">@layer</span> base</span> <span class="token punctuation">{</span> <span class="token comment">/* 2nd layer */</span>
  <span class="token selector">form input</span> <span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> inherit<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@layer</span> theme</span> <span class="token punctuation">{</span> <span class="token comment">/* 3rd layer */</span>
  <span class="token selector">input</span> <span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 2rem<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>カスケードレイヤーはChromium 99とFirefox 97でサポートされます。
Safari TP 133でもサポートされており（フィーチャーフラグを使用）、2022年の第1四半期にはリリースされると予想されます。</p>
<p>詳しくはこちらもご覧ください。<a href="https://brm.us/at-layer">The Future of CSS: Cascade Layers (CSS @layer) →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Chromium：Issue <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1095765">#1095765</a></em></li>
<li><em>Firefox：Issue <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1699215">#1699215</a></em></li>
<li><em>Safari：Issue <a href="https://bugs.webkit.org/show_bug.cgi?id=220779">#220779</a></em></li>
</ul></div></div>
<h3><a href="#05">#</a>カラー関数<a name="05"></a></h3>
<p><em>（※訳注：2023年4月現在、全モダンブラウザでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/04/css-color-level-5-560x348.png"></p>
<p><a href="https://www.w3.org/TR/css-color-5/">css-color-5仕様</a>は、色の使用についての細かい機能をいくつか提供します。
<code class="language-text">color-mix()</code>、<code class="language-text">color-contrast()</code>という2つの新しい関数を追加したほか、相対カラー構文を使用して既存の関数を拡張しています。</p>
<ul>
<li><code class="language-text">color-mix()</code>関数を使用すると、任意の色空間において2つの色を混ぜることができます。</li>
</ul>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.text-primary-dark</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">color-mix</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>--theme-primary<span class="token punctuation">)</span><span class="token punctuation">,</span> black 10%<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.text-primary-darker</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">color-mix</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>--theme-primary<span class="token punctuation">)</span><span class="token punctuation">,</span> black 20%<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<ul>
<li><code class="language-text">color-contrast()</code>関数を使用すると、特定のベースカラーと比較したコントラストが基準値以上の色の中からベストな色を選ぶことができます。</li>
</ul>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* Compares wheat against tan, sienna, and #d2691e */</span>
<span class="token comment">/* Sienna will be selected as it has a contstast of 4.273 against wheat, which exceeds the threshold of AA-large (3) */</span>
<span class="token function">color-contrast</span><span class="token punctuation">(</span>wheat vs tan<span class="token punctuation">,</span> sienna<span class="token punctuation">,</span> #d2691e to AA-large<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<ul>
<li>相対カラー構文を用いることで、どの色でも操作でき、任意のフォーマットに変換できます。</li>
</ul>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">:root</span> <span class="token punctuation">{</span>
  <span class="token property">--color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.selector</span> <span class="token punctuation">{</span>
  <span class="token comment">/* change the transparency */</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">hsl</span><span class="token punctuation">(</span>from <span class="token function">var</span><span class="token punctuation">(</span>--color<span class="token punctuation">)</span> h s l / .5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* change the hue */</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">hsl</span><span class="token punctuation">(</span>from <span class="token function">var</span><span class="token punctuation">(</span>--color<span class="token punctuation">)</span> <span class="token function">calc</span><span class="token punctuation">(</span>h + 180deg<span class="token punctuation">)</span> s l<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* change the saturation */</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">hsl</span><span class="token punctuation">(</span>from <span class="token function">var</span><span class="token punctuation">(</span>--color<span class="token punctuation">)</span> h <span class="token function">calc</span><span class="token punctuation">(</span>s + 5%<span class="token punctuation">)</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これらの関数は、通常CSSプリプロセッサから提供されています。WebKit/Safariではすでにサポートされています。
詳しくはこちらもご覧ください。</p>
<ul>
<li><a href="https://www.bram.us/2021/04/28/create-a-color-theme-with-css-relative-color-syntax-css-color-mix-and-css-color-contrast/">Create a color theme with CSS Relative Color Syntax, CSS color-mix(), and CSS color-contrast() →</a></li>
<li><a href="https://www.bram.us/2021/11/26/dynamic-color-manipulation-with-css-relative-colors/">Dynamic Color Manipulation with CSS Relative Colors →</a></li>
</ul>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Chromium：Issue <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1152772">#1152772</a>、<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1152772">#1092638</a>、<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1274133">#1274133</a></em></li>
<li><em>Firefox：メタ <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1679227">Issue #1679227</a></em></li>
<li><em>Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=222530">Issue #222530</a>、<a href="https://bugs.webkit.org/show_bug.cgi?id=222258">#222258</a>、<a href="https://bugs.webkit.org/show_bug.cgi?id=221880">#221880</a></em></li>
</ul></div></div>
<h3><a href="#06">#</a>新しいビューポート単位<a name="06"></a></h3>
<p><em>（※訳注：2023年4月現在、全モダンブラウザでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/07/viewports-teaser-560x373.png"></p>
<p>ビューポートのvh単位を使用する際、<a href="https://www.bram.us/2020/05/06/100vh-in-safari-on-ios/">iOSのSafariで不具合が生じる極めて厄介なバグが、かなり前から存在します</a>。
コンテナを<code class="language-text">100vh</code>に設定すると、要素が若干高くなりすぎてしまうのです。
これは、MobileSafariが<code class="language-text">100vh</code>を計算する際にUIの一部を無視してしまうことが原因です。</p>
<p>CSSワーキンググループは、css-values-4仕様においてvh単位には変更を加えず、ビューポートの新しい定義とそれに伴う<a href="https://www.w3.org/TR/css-values-4/#viewport-relative-lengths">新しいビューポート相対長</a>をいくつか導入しました。</p>
<ul>
<li><code class="language-text">svh</code>/<code class="language-text">svw</code>：スモールビューポートの高さ／幅の1%</li>
<li><code class="language-text">lvh</code>/<code class="language-text">lvw</code>：ラージビューポートの高さ／幅の1%</li>
<li><code class="language-text">dvh</code>/<code class="language-text">dvw</code>：ダイナミックビューポートの高さ／幅の1%</li>
</ul>
<p>ほかにも、<code class="language-text">svi</code>/<code class="language-text">svb</code>などの論理変数が利用可能です。</p>
<p>詳しくはこちらもご覧ください。<a href="http://brm.us/viewport-units">The Large, Small, and Dynamic Viewports →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Blink/Chromium：Issue <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1093055">#1093055</a></em></li>
<li><em>Gecko/Firefox：Issue <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1610815">#1610815</a></em></li>
<li><em>WebKit/Safari：Issue <a href="https://bugs.webkit.org/show_bug.cgi?id=219287">#219287</a></em></li>
</ul></div></div>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>同じ仕様で、<a href="https://www.w3.org/TR/css-values-4/#math">計算で使用できる新しい数学関数</a>のログも導入されています。ぜひチェックしてみてください。</em></p></div></div>
<h3><a href="#07">#</a>:has()擬似クラス<a name="07"></a></h3>
<p><em>（※訳注：2023年4月現在、全モダンブラウザでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/12/forms-css-has.css-560x310.png"></p>
<p>CSSのリレーショナル擬似クラス<code class="language-text">:has()</code>は、<a href="https://drafts.csswg.org/selectors-4/#has-pseudo">selectors-4</a>の一部です。
これは、<code class="language-text">:has()</code>に指定された追加セレクタのいずれかと一致した場合のみ要素がマッチするため、要素をより細かく選択することを可能にします。
しばしば「親セレクタ」と呼ばれますが、機能はそれだけに留まりません。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* Matches &lt;a> elements that contain an &lt;img> child */</span>
<span class="token selector">a:has(img)</span> <span class="token punctuation">{</span> … <span class="token punctuation">}</span>

<span class="token comment">/* Matches &lt;a> elements that directly contain an &lt;img> child */</span>
<span class="token selector">a:has(> img)</span> <span class="token punctuation">{</span> … <span class="token punctuation">}</span>

<span class="token comment">/* Matches &lt;section> elements that don’t contain any heading elements: */</span>
<span class="token property">section</span><span class="token punctuation">:</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">:</span><span class="token function">has</span><span class="token punctuation">(</span>h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">,</span> h4<span class="token punctuation">,</span> h5<span class="token punctuation">,</span> h6<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">/* Matches &lt;h1> elements only if they have a &lt;p> element directly following them */</span>
<span class="token selector">h1:has(+ p)</span> <span class="token punctuation">{</span> … <span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>詳しくはこちらもご覧ください。<a href="https://brm.us/css-has">The CSS :has() selector is way more than a “Parent Selector” →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Blink/Chromium：<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=669058">Issue #669058</a></em></li>
<li><em>Gecko/Firefox：<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=418039">Issue #418039</a></em></li>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=227702">Issue #227702</a></em></li>
</ul></div></div>
<h3><a href="#08">#</a>Overscroll-behavior<a name="08"></a></h3>
<p>CSSの<code class="language-text">overscroll-behavior</code>プロパティを使用すると、コンテナを”<em>オーバースクロール</em>” する際にデフォルトの挙動をオーバーライドできます。
これにより、Pull-to-Refreshのジェスチャーが実施された場合に完全にリロードされないようにしたり、rubber banding（※）を無効化したり、スクロールを一つのレイヤー内に収めたりすることが可能です。
<em>（※訳注：スクロール領域の限界を超えてスクロールした時に、ゴムのように引き戻されるような効果）</em></p>
<p class="codepen" data-height="300" data-default-tab="html,result" data-slug-hash="ZEzmzxj" data-user="aaroniker" style="height: 300px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;">
  <span>See the Pen <a href="https://codepen.io/aaroniker/pen/ZEzmzxj">
  overscroll-behavior: contain</a> by Aaron Iker (<a href="https://codepen.io/aaroniker">@aaroniker</a>)
  on <a href="https://codepen.io">CodePen</a>.</span>
</p>
<script async src="https://cpwebassets.codepen.io/assets/embed/ei.js"></script>
<p>Firefox（バージョン36）とChromium（バージョン63）ではかなり前からサポートされています。Safariでもようやくサポートの動きが見られます。</p>
<p>詳しくはこちらもご覧ください。<a href="https://www.bram.us/2017/12/10/customizing-pull-to-refresh-and-overflow-effects-with-css-overscroll-behavior/">Customizing Pull-to-Refresh and Overflow Effects with CSS <code class="language-text">overscroll-behavior</code></a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=176454">Issue #176454</a></em></li>
</ul></div></div>
<h3><a href="#09">#</a>サブグリッド<a name="09"></a></h3>
<p><em>（※訳注：2023年4月現在、SafariとFirefoxでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/12/subgrid-560x341.png"></p>
<p>グリッドを入れ子にする際、入れ子のグリッドアイテムをメイングリッドに沿って整列させるのは容易ではありません。
そこで役立つのがサブグリッドです。
<code class="language-text">grid-template-columns</code>または<code class="language-text">grid-template-rows</code>を<code class="language-text">subgrid</code>に設定すると、親グリッドに沿って整列します。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">.grid</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> grid<span class="token punctuation">;</span>
  <span class="token property">grid-template-columns</span><span class="token punctuation">:</span> <span class="token function">repeat</span><span class="token punctuation">(</span>9<span class="token punctuation">,</span> 1fr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">grid-template-rows</span><span class="token punctuation">:</span> <span class="token function">repeat</span><span class="token punctuation">(</span>4<span class="token punctuation">,</span> <span class="token function">minmax</span><span class="token punctuation">(</span>100px<span class="token punctuation">,</span> auto<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.item</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> grid<span class="token punctuation">;</span>
  <span class="token property">grid-column</span><span class="token punctuation">:</span> 2 / 7<span class="token punctuation">;</span>
  <span class="token property">grid-row</span><span class="token punctuation">:</span> 2 / 4<span class="token punctuation">;</span>
  <span class="token property">grid-template-columns</span><span class="token punctuation">:</span> subgrid<span class="token punctuation">;</span>
  <span class="token property">grid-template-rows</span><span class="token punctuation">:</span> subgrid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.subitem</span> <span class="token punctuation">{</span>
  <span class="token property">grid-column</span><span class="token punctuation">:</span> 3 / 6<span class="token punctuation">;</span>
  <span class="token property">grid-row</span><span class="token punctuation">:</span> 1 / 3<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Firefoxではすでにサポートされています。Chromiumでもサポートに向けた作業が進められています。</p>
<p>詳しくはこちらもご覧ください。<a href="https://www.bram.us/2021/11/04/practical-css-subgrid-video-tutorials/">Practical CSS Subgrid Video Tutorials →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Blink/Chromium：<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=618969">Issue #618969</a></em></li>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=202115">Issue #202115</a></em></li>
</ul></div></div>
<h3><a href="#10">#</a>accent-color<a name="10"></a></h3>
<p><em>（※訳注：2023年4月現在、全モダンブラウザでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/08/accent-color-560x383.png"></p>
<p><code class="language-text">accent-color</code>は<a href="https://www.w3.org/TR/css-ui-4/#widget-accent">css-ui-4</a>の一部です。</p>
<blockquote>
<p>CSSのUI仕様に規定されるaccent-colorは、CSSに1行追加するだけで要素を色付けできるため、自社ブランドを要素に組み込むことができ、カスタマイズに要する労力を削減することができます。</p>
</blockquote>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">form</span> <span class="token punctuation">{</span>
  <span class="token property">accent-color</span><span class="token punctuation">:</span> hotpink<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>accent-colorを使用すると、<a href="https://www.bram.us/2021/12/10/checkbox-rasterizer/">チェックボックスを使用したピクセルアートを作成することもできます。🙃</a></p>
<p>Chromium 93以上とFirefox 92以上でサポートされています。</p>
<p>詳しくはこちらもご覧ください。<a href="https://web.dev/accent-color/">CSS <code class="language-text">accent-color</code> →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=227587">Issue #227587</a></em></li>
</ul></div></div>
<h3><a href="#11">#</a>メディアクエリの範囲指定<a name="11"></a></h3>
<p><em>（※訳注：2023年4月現在、全モダンブラウザでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/10/media-query-range-context-560x400.png"></p>
<p><a href="https://www.w3.org/TR/mediaqueries-4/">mediaqueries-4</a>で新たに追加された仕様により、通常の数学で用いるような比較演算子を使用したMedia Query Ranges構文を用いて特定のメディアクエリを書き直すことができます。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* Old Way */</span>
<span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 750px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
	…
<span class="token punctuation">}</span>
<span class="token comment">/* New Way */</span>
<span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span>width &lt;= 750px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
	…
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Safariでの対応に向けた積極的な動きは確認できていないのですが、これに関しては筆者が間違っていると信じたいですね。</p>
<p>詳しくはこちらもご覧ください。<a href="https://brm.us/media-query-ranges">Media Queries Level 4: Media Query Range Contex →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=180234">Issue #180234</a></em></li>
</ul></div></div>
<h2><a href="#12">#</a>今後期待の新機能（実験的実装／シングルブラウザ対応）<a name="12"></a></h2>
<p>以下の機能については、すべてのブラウザでサポートされるのは2023年以降になりそうな予感がしています。
一部のブラウザではサポートされる可能性が高そうですが、フィーチャーフラグを使用した実装がメインになると思います。
これらに時間を費やす場合、すべてのブラウザがサポートし、すべてのユーザがブラウザをアップデートするまでは、一部のブラウザでしか使用できないことを理解する必要があります。</p>
<h3><a href="#13">#</a>ネスト（入れ子）<a name="13"></a></h3>
<p><em>（※訳注：2023年4月現在、Firefoxを除く全モダンブラウザでサポートされています。（ただし Safari はTechnology Preview版(16.5)でのみサポート））</em></p>
<p>この夏、スタイルルールの入れ子を可能にするモジュールである<a href="https://www.w3.org/TR/css-nesting-1/">css-nesting-1</a>のFirst Public Working Draftが公開されました。</p>
<details>
<summary>Working Draft（WD）とは何か？</summary>
<p><em>Working Draft（WD）成熟度レベルは、W3C勧告行程の最初の公式フェーズであり、W3C仕様の設計フェーズとみなされます。この段階では、CSSワーキンググループがモジュールの内容を調査、改訂します。
WDの最初に公開されるバージョンは、First Public Working Draftと呼ばれ、ここからWDフェーズが実行されます。
続いて、候補勧告（Candidate Recommendation; CR）になり、最終的には勧告（Recommendation; REC）になります。
これらの3つの段階の間には、最終草案（Last Call Working Draft; LCWD）と提案された勧告案（Proposed Recommendation; PR）という2つの移行段階があります。</em></p>
<p><em>勧告行程は以下のようになります：</em>
<img src="https://www.bram.us/wordpress/wp-content/uploads/2020/11/W3C-recommendation-track.png"></p>
<p><em>詳しくはこちらもご覧ください。<a href="http://fantasai.inkedblade.net/weblog/2011/inside-csswg/process">An Inside View of the CSS Working Group at W3C →</a></em></p>
</details>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token selector">table.colortable</span> <span class="token punctuation">{</span>
  <span class="token selector">&amp; td</span> <span class="token punctuation">{</span>
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token selector">;
    &amp;.c</span> <span class="token punctuation">{</span> <span class="token property">text-transform</span><span class="token punctuation">:</span> uppercase <span class="token punctuation">}</span>
    <span class="token selector">&amp;:first-child, &amp;:first-child + td</span> <span class="token punctuation">{</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid black <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token selector">&amp; th</span> <span class="token punctuation">{</span>
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">background</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token atrule"><span class="token rule">@nest</span> footer &amp;</span> <span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><strong>この機能がCSSに追加されたのは画期的なことであり、できれば上で紹介した注目の新機能に入れたいと思っていました。
しかし残念ながら、2022年中にサポートされるのはChromiumのみ（場合によってはもう1社）になると予想しています。
この点については筆者の予想が外れていることを期待しましょう</strong>。
あるいは、プリプロセッサの拡張機能により、2022年中に使用可能になる道が開けるかもしれません。</p>
<p>詳しくはこちらもご覧ください。<a href="https://brm.us/css-nesting">The future of CSS: Nesting Selectors →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Blink/Chromium：<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1095675">Issue #1095675</a></em></li>
<li><em>Gecko/Firefox：<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1648037">Issue #1648037</a></em></li>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=223497">Issue #223497</a></em></li>
</ul></div></div>
<h3><a href="#14">#</a>@scope<a name="14"></a></h3>
<p><em>（※訳注：2023年4月現在、これをサポートしているモダンブラウザはまだありません）</em></p>
<p><a href="https://www.bram.us/2021/12/27/css-in-2022/#the-hotlist--cascade-layers">カスケードレイヤー</a>を導入した<a href="https://drafts.csswg.org/css-cascade-5/">css-cascade-5</a>がリリースされ、<a href="https://drafts.csswg.org/css-cascade-6/">css-cascade-6</a>に向けた作業がすでに始まっています。
次の仕様では、カスケードにスコーピング機能が導入され、スタイルをDOMツリーの一部にスコーピングできるようになります。</p>
<div class="gatsby-highlight" data-language="html"><pre style="counter-reset: linenumber NaN" class="language-html line-numbers"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dark-theme<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>plum<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>light-theme<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>also plum???<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* When .light-theme and .dark-theme get nested, you may not get the expected result */</span>
<span class="token selector">.light-theme a</span> <span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> purple<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">.dark-theme a</span> <span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> plum<span class="token punctuation">;</span> <span class="token punctuation">}</span>


<span class="token comment">/* By scoping, we can fix this, as the a elements will be styled by their nearest scope */</span>
<span class="token atrule"><span class="token rule">@scope</span> <span class="token punctuation">(</span>.light-scheme<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">a</span> <span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> darkmagenta<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token atrule"><span class="token rule">@scope</span> <span class="token punctuation">(</span>.dark-scheme<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">a</span> <span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> plum<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>また、スコープリミット（下限値）を定義することもできます。</p>
<p><strong>現時点では、これ以上掘り下げるのは時期尚早です。筆者の予想では、2022年中にChromiumが実験的に実装するのではないかと思います。</strong></p>
<h3><a href="#15">#</a>@when/@else<a name="15"></a></h3>
<p><em>（※訳注：2023年4月現在、これをサポートしているモダンブラウザはまだありません）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/12/css-conditional-5.css-560x404.png"></p>
<p>2021年末の12月21日、<a href="https://www.w3.org/TR/css-conditional-5/">css-conditional-5</a>仕様のFirst Public Working Draftが公開されました。</p>
<details>
<summary>Working Draft（WD）とは何か？</summary>
<p><em>Working Draft（WD）成熟度レベルは、W3C勧告行程の最初の公式フェーズであり、W3C仕様の設計フェーズとみなされます。この段階では、CSSワーキンググループがモジュールの内容を調査、改訂します。
WDの最初に公開されるバージョンは、First Public Working Draftと呼ばれ、ここからWDフェーズが実行されます。
続いて、候補勧告（Candidate Recommendation; CR）になり、最終的には勧告（Recommendation; REC）になります。
これらの3つの段階の間には、最終草案（Last Call Working Draft; LCWD）と提案された勧告案（Proposed Recommendation; PR）という2つの移行段階があります。</em></p>
<p><em>勧告行程は以下のようになります：</em>
<img src="https://www.bram.us/wordpress/wp-content/uploads/2020/11/W3C-recommendation-track.png"></p>
<p><em>詳しくはこちらもご覧ください。<a href="http://fantasai.inkedblade.net/weblog/2011/inside-csswg/process">An Inside View of the CSS Working Group at W3C →</a></em></p>
</details>
<blockquote>
<p>CSS Conditional 4の機能を含め、拡張し、一般化した条件ルール<code class="language-text">@when</code>と連鎖した条件ルール<code class="language-text">@else</code>を追加し、<code class="language-text">@supports</code>ルールで使用されるsupportsクエリ構文にフォント処理クエリを導入します。</p>
</blockquote>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token atrule"><span class="token rule">@when</span> <span class="token function">media</span><span class="token punctuation">(</span>width >= 400px<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token function">media</span><span class="token punctuation">(</span><span class="token property">pointer</span><span class="token punctuation">:</span> fine<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token comment">/* A */</span>
<span class="token punctuation">}</span> <span class="token atrule"><span class="token rule">@else</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token property">caret-color</span><span class="token punctuation">:</span> pink<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">double-rainbow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token comment">/* B */</span>
<span class="token punctuation">}</span> <span class="token atrule"><span class="token rule">@else</span></span> <span class="token punctuation">{</span>
  <span class="token comment">/* C */</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>筆者が思うに素晴らしい機能追加です。<strong>しかし、どのベンダーにも対応する兆しが見えないため（ホリデーシーズンだからかもしれませんが）、2022年中にすべてのブラウザがこの機能を搭載することはないと予想し、このリストに加えています。</strong></p>
<p>詳しくはこちらもご覧ください。<a href="https://css-tricks.com/proposal-for-css-when/">Proposal for CSS @when →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Blink/Chromium：<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1282896">Issue #1282896</a></em></li>
<li><em>Gecko/Firefox：<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1747727">Issue #1747727</a></em></li>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=234701">Issue #234701</a></em></li>
</ul></div></div>
<h2><a href="#16">#</a>現状維持が濃厚な期待の新機能<a name="16"></a></h2>
<p>残念ながら、以下の機能については2022年中あまり動きが見られないと思われます。
これらの機能は非常に有益ではあるのですが、実際に使用するにはより多くのブラウザが対応する必要があります。</p>
<h3><a href="#17">#</a>スクロール連動型アニメーション<a name="17"></a></h3>
<p><em>（※訳注：2023年4月現在、これをサポートしているモダンブラウザはまだありません。）</em></p>
<p><a href="https://drafts.csswg.org/scroll-animations-1/">scroll-animations-1 specification</a>が提供する<code class="language-text">@scroll-timeline</code>ルールと<code class="language-text">animation-timeline</code>プロパティを使用することで、CSSアニメーションをスクロールコンテナのスクロールオフセットに連動させることができます。
コンテナの中を上下にスクロールすると、連動したアニメーションがそれに合わせて進んだり戻ったりします。</p>
<div class="gatsby-highlight" data-language="css"><pre style="counter-reset: linenumber NaN" class="language-css line-numbers"><code class="language-css"><span class="token comment">/* (1) Define Keyframes */</span>
<span class="token atrule"><span class="token rule">@keyframes</span> adjust-progressbar</span> <span class="token punctuation">{</span>
    <span class="token selector">from</span> <span class="token punctuation">{</span>
        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scaleX</span><span class="token punctuation">(</span>0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">to</span> <span class="token punctuation">{</span>
        <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">scaleX</span><span class="token punctuation">(</span>1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/* (2) Define a ScrollTimeline */</span>
<span class="token atrule"><span class="token rule">@scroll-timeline</span> scroll-in-document</span> <span class="token punctuation">{</span>
  <span class="token property">source</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
  <span class="token property">orientation</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
  <span class="token property">scroll-offsets</span><span class="token punctuation">:</span> 0<span class="token punctuation">,</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* (3) Attach the Animation + set the ScrollTimeline as the driver for the Animation */</span>
<span class="token selector">#progressbar</span> <span class="token punctuation">{</span>
    <span class="token property">animation</span><span class="token punctuation">:</span> 1s linear forwards adjust-progressbar<span class="token punctuation">;</span>
    <span class="token property">animation-timeline</span><span class="token punctuation">:</span> scroll-in-document<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>スクロール連動型アニメーションは、現在Chromiumしかサポートしていません（フィーチャーフラグを使用）。
Gecko/Firefoxは、すでに構文解析機能は追加していますが、実際のレンダリングにはまだ対応していません。
筆者はスクロール連動型アニメーションの熱烈な支持者であり、このテーマについて多数の記事を執筆していますが、<strong><a href="https://github.com/w3c/csswg-drafts/issues/6674">現状構文に関する議論が行われているため、</a>開発は停滞すると思われます。</strong></p>
<p>詳しくはこちらもご覧ください。</p>
<ul>
<li><a href="https://brm.us/scroll-linked-animations-pt1">Part 1: Introduction + Basic Scroll-Linked Animations →</a></li>
<li><a href="https://brm.us/scroll-linked-animations-pt2">Part 2: Scroll-Linked Animations with Element-based offsets →</a></li>
<li><a href="https://brm.us/scroll-linked-animations-pt3">Part 3: Practical Use-Cases →</a></li>
<li><a href="https://brm.us/scroll-linked-animations-pt4">Part 4: Scroll-Linked Animations With the Web Animations API (WAAPI) →</a></li>
</ul>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Blink/Chromium：<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1023424">Issue #1023424</a></em></li>
<li><em>Gecko/Firefox：<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1676780">Issue #1676780</a></em></li>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=222295">Issue #222295</a></em></li>
</ul></div></div>
<h3><a href="#18">#</a>@property (😭)<a name="18"></a></h3>
<p><em>（訳注：2023年4月現在、Firefoxを除く全モダンブラウザでサポートされています。）</em></p>
<p><img src="https://www.bram.us/wordpress/wp-content/uploads/2021/12/at-property.css-560x446.png"></p>
<p>CSS Properties and Values APIは「CSS Houdini」の一部です。
このAPIが提供する<code class="language-text">@property</code>を使用することで、CSSカスタムプロパティを登録し、特定のタイプ（構文）と初期値を設定し、継承機能を制御できます。</p>
<details>
<summary>🎩Houdiniはまるで魔法のようです。</summary>
<p><em>HoudiniはCSSエンジンの一部を公開する低レベルAPIのセットです。開発者がブラウザのレンダリングエンジンのスタイリングとレイアウトプロセスにフックすることで、CSSを拡張できるようになります。
また、開発者がCSSとしてコードを書くことができるように、CSSオブジェクトモデル（CSSOM）への直接アクセスを提供するAPIグループでもあります。これにより、ブラウザでネイティブに実装されるのを待つことなく、新しいCSS機能も作成できます。</em></p>
</details>
<p>本当に魔法のように便利なので、Houdiniという名前がついています。
試してみるなら、こちらの<a href="https://www.bram.us/2018/06/01/demystifying-the-future-of-css-with-sparkles-of-js/">ページ</a>と<a href="https://www.bram.us/2020/12/11/extending-css-with-houdini/">ビデオ</a>をお勧めします。</p>
<p><strong>Houdini、とりわけProperties and Values APIの部分がすべてのブラウザに搭載されることを願ってやみませんが、関連するWebKitとGeckoのバグはここ数か月（数年！）全く動きがないため、残念ながら現状維持になると思います。😭</strong></p>
<p>詳しくはこちらもご覧ください。<a href="https://web.dev/at-property/">@property: giving superpowers to CSS variables →</a></p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>関連するIssue：</em></p><ul>
<li><em>Gecko/Firefox：<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1273706">Issue #1273706</a></em></li>
<li><em>WebKit/Safari：<a href="https://bugs.webkit.org/show_bug.cgi?id=189692">Issue #189692</a></em></li>
</ul></div></div>
<h2><a href="#19">#</a>気になるSafariの動向<a name="19"></a></h2>
<p>昨年多くの批判にさらされたSafariは、しばしば「新しいIE6」と呼ばれています。
筆者自身もそのように言っていた一人ですが、現在は少し考えを改めています。</p>
<p>Safariの開発チームは最近多くの成果を上げており（カラー関数、<code class="language-text">:has()擬似クラス</code>、カスケードレイヤーなど）、その他にも複数のポジションで積極的に採用を進めています。
2022年中にSafariが「巻き返し」に成功したとしても、驚くことはないでしょう。</p>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p><em>☝️それでも、あいにく<a href="https://www.bram.us/2021/09/13/chrome-is-the-new-safari-and-so-are-edge-and-firefox/">WebKitがiOS</a>を独占する状況については何も変わりません。この状況については、筆者同様Safariの関係者も好ましく思っていないはずです。おそらく、上層部の決定なのでしょう。</em></p></div></div>
<h2><a href="#20">#</a>おわりに<a name="20"></a></h2>
<p>ここで紹介したように、2022年には多数の機能がCSSに追加されると予想されます。
特に注目している機能や、ここで触れなかった機能についてコメントのある方は、<a href="https://www.bram.us/2021/12/27/css-in-2022/#%E5%9B%9E%E7%AD%94">こちら</a>からご連絡いただくか、<a href="https://twitter.com/bramus">Twitter</a>でメッセージを送っていただければと思います。🙂</p>
<p>発表ツイートのいずれかをリツイートし、ぜひこの記事の内容の拡散にご協力ください。</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">🔥 CSS Features to start learning, as I expect them to ship in all browsers in 2022:<br><br>1. Container Queries<br>2. Cascade Layers<br>3. Color Functions<br>4. Viewport Units<br>5. :has()<br>6. Overscroll Behaviour<br>7. Subgrid<br>8. Accent Color<br>9. Media Query Ranges</p>&mdash; Bramus (@bramus) <a href="https://twitter.com/bramus/status/1475583226165055501?ref_src=twsrc%5Etfw">December 27, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">With 2021 coming to an end, let&#39;s take a look at what we can expect from CSS and browsers in 2022.<br><br>🔗 <a href="https://t.co/CsTn4nvyG7">https://t.co/CsTn4nvyG7</a><br><br>🏷 <a href="https://twitter.com/hashtag/css?src=hash&amp;ref_src=twsrc%5Etfw">#css</a> <a href="https://t.co/rxlspa4gw2">pic.twitter.com/rxlspa4gw2</a></p>&mdash; Bram.us (@bramusblog) <a href="https://twitter.com/bramusblog/status/1475511382997090306?ref_src=twsrc%5Etfw">December 27, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<hr>
<div class="admonition admonition-none alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg></svg></span>none</h5></div><div class="admonition-content"><p>🔥<em>気に入っていただけましたか？最新情報を受け取りたいですか？以下の方法でどうぞ:</em></p><ul>
<li><em><a href="https://twitter.com/bramus">Follow @bramus on Twitter</a></em></li>
<li><em><a href="https://front-end.social/@bramus">Follow @bramus on Mastodon</a></em></li>
<li><em><a href="https://twitter.com/bramusblog">Follow @bramusblog on Twitter</a></em></li>
<li><em><a href="https://bram.us/feed">Follow bram.us using RSS</a></em></li>
</ul></div></div>]]></content:encoded></item><item><title><![CDATA[WebAssemblyに注目]]></title><description><![CDATA[WebAssemblyは今、転換点にあります。今後数年間で、コンテナ化からプラグインシステムやサーバレス・コンピューティング・プラットフォームに至るまで、IT業界全体でWebAssemblyの導入が…]]></description><link>https://postd.cc/pay-attention-to-web-assembly/</link><guid isPermaLink="false">https://postd.cc/pay-attention-to-web-assembly/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[プログラミング言語]]></category><pubDate>Thu, 30 Mar 2023 00:00:01 GMT</pubDate><content:encoded><![CDATA[<p>WebAssemblyは今、転換点にあります。今後数年間で、コンテナ化からプラグインシステムやサーバレス・コンピューティング・プラットフォームに至るまで、IT業界全体でWebAssemblyの導入が増えると筆者は予想しています。この記事では、WebAssemblyとは何か、なぜそれが重要なテクノロジーであるのか、現在はどのような分野で利用されているかを説明します。また、WebAssemblyが大きな影響をもたらす可能性がある用途や、WebAssemblyの将来に関する予測も紹介します。</p>
<h2>WebAssemblyとは何か</h2>
<p>WebAssembly（Wasm）とは、さまざまなプログラミング言語と多様な実行環境の間に位置する中間層です。30以上の異なるプログラミング言語で書かれたコードを.wasmファイルにコンパイルし、そのファイルをブラウザ、サーバ、あるいは自動車でも実行できます。</p>
<p>「WebAssembly」という名前は誤解を招きます。WebAssemblyは元々、Webでのコードの実行を高速化するために開発されましたが、今ではブラウザ以外のさまざまな環境でも実行できます。さらに、WebAssemblyはアセンブリではなく、アセンブリより若干高水準なバイトコードです。</p>
<p>WebAssemblyの解説とその歴史の説明については、数多くの記事が書かれています。ですから、ここでは優れた入門記事をいくつか紹介するにとどめたいと思います。</p>
<ul>
<li><a href="https://hacks.mozilla.org/2017/02/a-cartoon-intro-to-webassembly/">A cartoon intro to WebAssembly - Mozilla Hacks - the Web developer blog</a></li>
<li><a href="https://nickymeuleman.netlify.app/blog/webassembly">WebAssembly. Scary name, exciting applications. | Nicky blogs</a></li>
<li><a href="https://desiatov.com/why-webassembly/">How WebAssembly changes software distribution | Max Desiatov</a></li>
</ul>
<h2>WebAssemblyの長所</h2>
<p>WebAssemblyが優れているのは、以下の5つの特徴があるためです。</p>
<ul>
<li><strong>ポータブル</strong>：Wasmのバイトコードのバイナリ形式は標準化されています。このことは、Wasmを実行可能なあらゆるランタイムがどんなWasmコードでも実行できることを意味します<a href="#01">1</a>。これはJavaの「write once, run anywhere」（一度書けばどこでも実行できる）というスローガンと似ています。ブラウザに関しては、<a href="https://caniuse.com/wasm">95%のユーザのブラウザ</a>でWebAssemblyを実行でき、残り5%もwasm2jsコンパイラを利用すれば対応できます。サーバに関しては、<a href="https://github.com/bytecodealliance/wasmtime">Wasmtime</a>や<a href="https://github.com/wasmerio/wasmer">Wasmer</a>などのランタイムがあります。リソースが限られているIoT端末でも、<a href="https://github.com/bytecodealliance/wasm-micro-runtime">WAMR</a>を利用すればWasmコードを実行可能です<a href="#02">2</a>。</li>
<li><strong>普遍性</strong>：多くのプログラミング言語をWasmにコンパイルできます。Wasmがサポートしている言語には、C、C++、Rustなどのシステム言語だけでなく、Go、Python、Rubyなどのガベージコレクション機能を導入している高水準言語も含まれます<a href="#03">3</a>。Wasmにコンパイルできるプログラミング言語の一覧は<a href="https://github.com/appcypher/awesome-wasm-langs">こちら</a>です。</li>
<li><strong>“ニアネイティブパフォーマンス”</strong>：Wasmは「ニアネイティブパフォーマンス」（ネイティブに近いパフォーマンス）を<a href="https://developer.mozilla.org/en-US/docs/WebAssembly">実現するとよく言われます</a>。実際には、Wasmはほとんどの状況でJavaScriptより高速で、特に演算の負荷が大きいワークロードでその傾向が顕著です。また、Wasmは平均で<a href="https://www.usenix.org/conference/atc19/presentation/jangda">ネイティブコード</a>より1.45～1.55倍遅いものの、<a href="https://00f.net/2021/02/22/webassembly-runtimes-benchmarks/">ランタイムによって</a>結果は異なります。</li>
<li><strong>高速な起動時間</strong>：Wasmのコールドスタート時間は、それ自体が一つのカテゴリを構成するほど重要です。サーバ上では、WasmはDockerのコンテナと比べて10～100倍<a href="https://repositum.tuwien.at/bitstream/20.500.12708/17598/1/Gackstatter%20Philipp%20-%202021%20-%20A%20WebAssembly%20Container%20Runtime%20for%20Serverless%20Edge...pdf">高速なコールドスタート</a>時間を実現できます。これはWasmがすべてのコンテナについて新たなOSプロセスを作成する必要がないためです。ブラウザでは、Wasmのデコードと機械語への変換はJavaScriptのパース、解釈、最適化よりも高速であるため、WasmコードはJavaScriptよりも速く最大のパフォーマンスで実行を開始できます<a href="#04">4</a>。</li>
<li><strong>安全性</strong>：WebAssemblyはWebを念頭に置いていたため、セキュリティを重視して設計されました。Wasmランタイムで実行されるコードは、メモリがサンドボックス化され、機能が制約されています。これはコードが明示的に許可されていることしか実行できないことを意味します<a href="#05">5</a>。Wasmコードはサンドボックス化されていますが、システムレベルのインタフェースやハードウェア機能など、下層のシステムへのアクセスも依然として許可されています。</li>
</ul>
<h2>WebAssemblyの便利な利用法</h2>
<h3>JavaScriptの高速化</h3>
<p>Wasmとその前身であるasm.jsが開発された元々の動機は、Web上でのクライアントサイドのコードを高速化することでした。Wasmがこの分野で優れていることを示す事例は数多く存在します。</p>
<ul>
<li>例えば、デザインツールのFigmaの中心的なプログラムはC++で書かれ、WebAssemblyにコンパイルされています。Figmaの開発者は、C++で書かれたプログラムには<a href="https://www.figma.com/blog/building-a-professional-design-tool-on-the-web/">パフォーマンスとユーザビリティの面</a>で大きなメリットがあり、それを<a href="https://www.figma.com/blog/webassembly-cut-figmas-load-time-by-3x/">WebAssemblyにコンパイルする</a>ことによって読み込み時間を3分の1に削減し、ダウンロードするファイルの容量を劇的に縮小できると述べています。</li>
<li>パスワードマネージャの1Passwordでは、Wasmへの転換によって、フォームが多いサイトでの動作が最大で<a href="https://blog.1password.com/1password-x-may-2019-update/">13～39倍高速化</a>しました。また、WasmがJavaScriptよりもパフォーマンスが<a href="https://developers.google.com/web/updates/2019/02/hotpath-with-wasm">安定している</a>という点は、レイテンシの影響を受けやすいアプリケーションにとって重要です<a href="#06">6</a>。</li>
</ul>
<h3>プログラミング言語の相互運用性</h3>
<p>WebAssemblyはプログラミング言語の境界を簡単に越えることを可能にします。通常、ライブラリとフレームワークは1つの言語のみで書かれているため、完全に書き換えない限り、そのコードを別の言語で利用するのは困難です。WebAssemblyでは、別の言語で書かれたコードの実行を簡単にすることができます。<strong>これにより、コードを一から書き直すのではなく再利用することが可能になります。</strong></p>
<p>現在、この機能は主にアプリケーションをWebに移植するために利用されています。以下に例を紹介します。</p>
<ul>
<li>Figmaは、一部のグラフィックアルゴリズムについて、Skiaという低水準のC++ライブラリを利用しています。自社でアルゴリズムを開発したり、それをJavaScriptに移植したりはしていません<a href="#07">7</a>。</li>
<li>筆者のお気に入りのチェスサーバであるlichess.orgは、世界クラスのチェスエンジンであるStockfishをユーザのブラウザで実行しており、サーバサイドでStockfishを実行することによる演算負荷を回避しています。</li>
<li><a href="https://medium.com/google-earth/google-earth-comes-to-more-browsers-thanks-to-webassembly-1877d95810d6">Google Earth</a>と<a href="https://web.dev/ps-on-the-web/">Adobe Photoshop</a>はWasmを利用してC++のコードベースをWebに移植しています。</li>
</ul>
<p>アプリケーションのWeb移植はWasmを利用するうえで最も簡単な出発点となっており、<a href="https://paulbutler.org/2020/the-webassembly-app-gap/">その傾向は今後も続く</a>と予想されます。しかし、Wasmの相互運用性はブラウザに限られません。Wasmはプラットフォームや端末を越えてコードを実行するのにも利用されています。</p>
<ul>
<li><a href="https://platform.uno/">Uno Platform</a>は、単一のアプリケーションを開発し、それをWindows、macOS、iOS、Android、Linux、ブラウザで実行できるUIプラットフォームです。このプラットフォームは、アプリケーションがC#とXAMLで書かれており、かなりWindows中心に設計されているようです。また、レガシーアプリケーションを新たなプラットフォームに移植するために必要な労力を減らすことを目的とした活用例が非常に多いのも特徴です。</li>
<li><a href="https://www.amazon.science/blog/how-prime-video-updates-its-app-for-more-than-8-000-device-types">Amazon Prime</a>、<a href="https://medium.com/disney-streaming/introducing-the-disney-application-development-kit-adk-ad85ca139073">Disney+</a>、<a href="https://www.youtube.com/watch?v=28paRXqI-Gk">BBC</a>はいずれも自社の動画配信プラットフォームでWebAssemblyを利用しています。例えば、Amazon Primeでは、新機能を膨大な種類の端末に対応させつつ、問題ないパフォーマンスを維持するためにWebAssemblyが活用されています。</li>
</ul>
<p>WebAssemblyは、アプリケーションの移植以外にも、サーバサイドでの言語間の橋渡しとしても役立ちます。残念ながら、この用途の活用例はまだ多くありません。なぜなら、OSとの通信に利用されるインタフェース（<a href="https://hacks.mozilla.org/2019/03/standardizing-wasi-a-webassembly-system-interface/">Web Assembly System Interface</a>、略称WASI）や言語の境界を越えて機能するインタフェース（<a href="https://github.com/WebAssembly/component-model">Wasm Component Model</a>）は依然として開発途上であり、必要な成熟度に達していないためです。</p>
<h3>プラグインシステム</h3>
<p>ほとんどのアプリケーションは、ある程度の成熟度に達すると、エンドユーザによる拡張性が必要になります。従来のアプリケーションは、設定項目を大量に増やしたり、複雑なドメイン固有言語（DSL）を開発したりしてきましたが、管理がとても面倒になることや、開発者がよく知らない言語での作業を強いられることが常でした。</p>
<p>例を考えてみましょう。NGINXなどのシステムでリクエストのフィルタリング規則を設定するとします。そのためには、システム管理者は、なじみのない独自の設定言語で望ましいロジックを宣言型で実装しなければなりません。NGINXの開発者があらかじめ設定したマッチング演算子やフィルタリング演算子は、普段は役立ちますが、システム管理者が望む挙動を実装するうえで大きな妨げとなることがよくあります。また、利用できるツールが少ないので、問題が生じたときのデバッグはストレスがたまるでしょう。</p>
<p>一部の比較的新しいアプリケーションは異なるアプローチを採用しています。そのアプローチとは、インタフェースの標準的なセットを提供し、Wasmランタイムを組み込んだうえで、必要なカスタムロジックを実装するためのWasmバイナリはエンドユーザに提供させるものです。これにより、エンドユーザにとってはるかに柔軟でなじみのあるインタフェースが実現されます。エンドユーザは、自分が選んだ言語で、複雑なビジネスロジックを自由に実装できます。この機能は、他の言語ではセキュリティ上の懸念により不可能でしたが、Wasmではユーザが提供するコードをランタイムがサンドボックス化することによって実現しています。</p>
<p>現在の活用例を見てみましょう。</p>
<ul>
<li>元々Lyftによって開発され、現在では業界全体で利用されているEnvoyプロキシは、拡張機能をWasmで開発し、ランタイムで動的に<a href="https://github.com/proxy-wasm/spec/blob/master/docs/WebAssembly-in-Envoy.md">読み込む</a>ことを可能にしています。Envoyを基に開発されたサービスメッシュのIstioにも同様の機能があります。</li>
<li>Kafkaの代わりとして使用されているRedpandaでは、ユーザがWasmを利用して、独自の<a href="https://vectorized.io/blog/wasm-architecture/">ストリーミングデータ変換プログラム</a>を書くことができます。</li>
<li>Open Policy Agentでは<a href="https://www.openpolicyagent.org/docs/latest/wasm/">Wasmを利用</a>してポリシーを定義できます。</li>
<li>Minecraftサーバの<a href="https://github.com/feather-rs/feather">Feather</a>は、サンドボックス内でのプラグインの実行にWebAssemblyを利用しています。</li>
</ul>
<h3>サンドボックス化機能の組み込み</h3>
<p>WebAssemblyを他のアプリケーションに組み込むというアイデアは、プラグインシステム以外にとっても有用です。実際、サードパーティライブラリ全体のサンドボックス化や、ファーストパーティコード向けのセキュリティ層の構築に利用できます。</p>
<p>Firefoxはこの分野で<a href="https://hacks.mozilla.org/2021/12/webassembly-and-back-again-fine-grained-sandboxing-in-firefox-95/">先頭に立っており</a>、スペルチェックや画像のデコードなどに利用するサードパーティライブラリのバグから自らを守っています。Wasmは、「<a href="https://hacks.mozilla.org/2020/02/securing-firefox-with-webassembly/">汚染レイヤ</a>」を提供するRLBoxというツールと組み合わせることで、強引なプロセス隔離に頼ることなく、こうしたライブラリの脆弱性からシステムを保護します。Firefoxの場合、Wasmバイナリを最終リリースに搭載してすらいません。Wasmへのコンパイルと別の言語へのトランスパイルというプロセスによって、RLBoxとともに、必要なセキュリティを確保しているのです。</p>
<p>このアプローチは一部の重大な脆弱性の悪用を防止できるかもしれません。攻撃者は通常、複数の脆弱性を組み合わせて利用するため、こうした中間的なセキュリティ層は今後の安全性向上にとても役に立つでしょう。</p>
<h3>コンテナ化</h3>
<p>Dockerの創業者であるSolomon Hykesは、よく引用されている<a href="https://twitter.com/solomonstre/status/1111004913222324225?ref_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1111004913222324225%7Ctwgr%5E%7Ctwcon%5Es1_&#x26;ref_url=https%3A%2F%2Fnickymeuleman.netlify.app%2Fblog%2Fwebassemblysecurity">ツイート</a>で、WebAssemblyの重要性を次のように強調しています。</p>
<blockquote>
<p>WASMとWASIが2008年に存在していたらDockerを開発する必要はなかった。それくらい重要な存在だ。サーバサイドのWebAssemblyはコンピューティングの未来だ。</p>
</blockquote>
<p>Wasmがコンテナ化の未来を示していると考えるのには<a href="https://kubesphere.io/blogs/will-cloud-native-webassembly-replace-docker_/">十分な理由</a>があります。<strong>Dockerと比べて、Wasmはコールドスタート時間が10～100倍高速で、メモリの使用量が少なく、機能の制約による優れたセキュリティモデルを採用しています</strong>。コンテナではなくWasmモジュールが演算とデプロイの標準的な単位となれば、拡張性とセキュリティは向上するでしょう。</p>
<p>こうした変化は突然起きるものではありません。したがって、Wasmベースのコンテナ化は、完全にDockerを代替するのではなく、既存のオーケストレーションシステムに統合される可能性が高いでしょう。</p>
<p>筆者は今後数年間でこの分野の動きがとても盛んになると予想します。既にいくつかのプロジェクトがいち早く動き始めています。</p>
<ul>
<li>Microsoft AzureのDeis Labsは<a href="https://krustlet.dev/">Krustlet</a>を開発しました。これは既存のKubernetesクラスタでWasmワークロードを実行する方法の一つです。</li>
<li>Deis Labsは、Wasmを中心とするPaaS（platform-as-a-service）の<a href="https://github.com/deislabs/hippo">Hippo</a>もリリースしました。筆者は<a href="https://github.com/fermyon">Fermyon</a>がこのテクノロジーの商用化を目指しているのではないかと推測します。</li>
<li><a href="https://cosmonic.com/">Cosmonic</a>は、<a href="https://github.com/wasmCloud/wasmCloud">wasmCloud</a>プロジェクトにおいて、分散システム向けにWasmコンテナ化とアクターモデルを結合するプラットフォーム兼オーケストレーション層を構築しています。</li>
<li><a href="https://github.com/lunatic-solutions/lunatic">Lunatic</a>プラットフォームもアクターモデルを採用しており、単一のWebAssemblyランタイムプロセス上で複数の軽量なコンテナを実行するための最高のサポート機能を搭載しているとみられます。</li>
<li><a href="https://suborbital.dev/">Suborbital</a>の<a href="https://github.com/suborbital/atmo">Atmo</a>もプラットフォーム兼オーケストレーションシステムですが、サーバレスのワークロードに比較的大きな重点を置いています。
### FaaS/サーバレスプラットフォーム
FaaS（function-as-a-service）プラットフォームは、ユーザ提供コードを高速かつ安全に実行する必要があります。サーバレスプラットフォームは、コードを短期間実行するために利用されることが多いため、起動時間が特に重要な指標となります。<strong>Wasmは超高速なコールドスタートと幅広い言語のサポートにより、サーバレスのワークロードにとって優れた選択肢となっています</strong><a href="#08">8</a>。</li>
</ul>
<p><a href="https://blog.cloudflare.com/webassembly-on-cloudflare-workers/">Cloudflare Workers</a>とFastly <a href="https://www.fastly.com/blog/how-compute-edge-is-tackling-the-most-frustrating-aspects-of-serverless">Compute@Edge</a>が提供するCDNエッジ・コンピューティング・プラットフォームには既にWebAssemblyの実行機能が搭載されています。Fastlyは、市場の他のサービスよりも起動時間が100倍速いと主張しており、その高速化の理由をWebAssemblyベースのコンパイラとランタイムにあるとしています。NetlifyとVercelもこの分野の製品を開発中です。</p>
<p>主要なクラウドプロバイダが構築したサーバレスプラットフォームも後れを取ってはいません。AWS Lambdaは数カ月前（※訳注：翻訳元の記事は2022年1月31日公開）にWebAssemblyサーバレス関数をローンチしており、GCPとAzureもこれに続くと予想されます。</p>
<h3>ブロックチェーン</h3>
<p>EthereumやSolanaなどのプラットフォームは、ブロックチェーン上で実行できる「スマートコントラクト」と呼ばれるコードをユーザが書くための仕組みを提供します。Ethereumは完全な独自システムを構築しており、コンパイル済みバイトコードのバイナリ表現であるSolidityという言語や、サンドボックスでコードを実行するためのEthereum Virtual Machineを作成しています。Solanaは一部既存のイノベーションを再利用することを選択しており、LLVMコンパイラインフラを利用して、C、C++やRustのコードをバイナリ形式のBerkeley Packet Filterバイトコードの一種にコンパイルします。しかし、Solanaも依然としてSealevelという独自のランタイムを開発しています。</p>
<p>WebAssemblyはこうしたインフラの大部分を既に提供しています。ユーザは、任意の言語でコードを書き、コンパイラインフラによってWasmバイトコードを作成し、無数の高性能なランタイムを利用できます。</p>
<p>しかし、EthereumとSolanaが既にこうしたインフラを構築しているならば、WebAssemblyはどんな価値を提供できるのでしょうか？実際には、主な付加価値はエコシステム関連にあります。例えば、Ethereumはスマートコントラクトを書くための独自言語を持っていますが、これは他言語で書かれたライブラリや共通関数をすべて活用することはできないという意味です。SolanaはRustエコシステムを利用できるため、その点ではEthereumをわずかに上回っています。<strong>WebAssemblyの技術的な課題が克服されれば、現在よりはるかに多くの人がスマートコントラクトを開発し、既に使い慣れたライブラリやツールを利用できるようになるでしょう</strong>。</p>
<p>このように考えているのは決して筆者だけではありません。例えば、Polkadotネットワークはランタイムとして<a href="https://eos.io/news/eos-virtual-machine-a-high-performance-blockchain-webassembly-interpreter/">WebAssemblyベースの仮想マシン</a>を使用しています。EOS仮想マシンも<a href="https://eos.io/news/eos-virtual-machine-a-high-performance-blockchain-webassembly-interpreter/">WebAssemblyがベース</a>です。<a href="https://cosmwasm.com/">CosmWasm</a>は複数のブロックチェーンで機能するスマートコントラクトの構築にWebAssemblyを使用しています。Ethereum Virtual MachineをWebAssemblyの一部のみで代替する「<a href="https://github.com/ewasm/design">eWASM</a>」という案もありましたが、これは立ち消えになったようです。Wasmerランタイムは、明確にブロックチェーン向けに構築された「シングルパス」コンパイラモードを提供します。一方、WasmEdgeは、Ethereumとの互換性があるスマートコントラクト実行エンジンを搭載していると主張しています。</p>
<h2>予測と展望</h2>
<h3>新たなアプリケーションアーキテクチャ</h3>
<p>Dockerが仮想マシンを完全に代替できなかったように、WasmもDockerを完全には代替できません。例えば、仮想マシンがカスタムOSカーネルを実行できるのに対して、Dockerのコンテナでは実行できません。同様に、Wasmのコンテナは、x86の256ビットAVX命令などの一部の特殊なCPU命令を利用できないため<a href="#09">9</a>、アプリケーションによってはDockerと同等のパフォーマンスを発揮することが不可能です。</p>
<p>筆者の見解では、DockerではサポートされているがWasmではサポートされていないワークロードの差は、現時点ではDockerと仮想マシンの同様の差よりも大きいと考えられます。しかし、Wasmはまだ発展途上のテクノロジーであるため、対応可能なワークロードの種類は増えていくでしょう。Dockerの台頭はマイクロサービスアーキテクチャの台頭と密接に連動していました。これにより、仮想マシンに適したモノリシックなアプリケーションはDockerのコンテナに適したマイクロサービスに置き換えられていきました。<strong>いずれはWebAssembly の独自機能を活用した新たなアプリケーションアーキテクチャが登場するでしょう</strong>。</p>
<p>コンウェイの法則によれば、アプリケーションのアーキテクチャは、そのアプリケーションを設計した組織のコミュニケーション構造を反映します。コンピューティングの歴史上すべての新しい「リファレンスアーキテクチャ」は、人と人の間で必要な調整の量を減らしてきました。メインフレームから仮想マシンやDockerのコンテナまで、デプロイ可能なユニットを生産するために必要な人間の数は徐々に減少しています。これは、システムをどんどん小さいコンポーネントに分解し、それらのコンポーネントを構築する作業者が、明確に定義されたインタフェースを参照しながら個別に作業できるようにすることによって実現されました。マイクロサービスがモノリシックなアプリケーションを複数の独立したサービスに分解する一方、<strong>WebAssemblyはマイクロサービスをさらに小さいコンポーネントに分解しやすくしています</strong><a href="#10">10</a>。</p>
<p>これはどのような結果を生むでしょうか？いくつかの可能性を紹介します。</p>
<ul>
<li>アプリケーションを中核的なビジネスロジックと他のシステムとの連携に必要なグルーコードに分割した場合、通常はビジネスロジックが他の部分よりかなり小さくなります。グルーコードのインタフェースを、それが提供する機能の実装から分離すれば、ビジネスロジック中心のアプリケーションを構築し、残りを外部の機能プロバイダに任せることが可能になります。これと、長く蚊帳の外に置かれていた<a href="https://www.brianstorti.com/the-actor-model/">アクターモデル</a>を組み合わせたものが<a href="https://github.com/wasmCloud/wasmCloud">wasmCloud</a>のアプローチの本質です。</li>
<li>もう一つの可能性は、サーバレスアーキテクチャがマイクロサービスを超える次のステップになるというものです。ほとんどのサービスはステートフルな部分とステートレスな部分に分割でき、ステートレスな部分は任意に拡張可能なサーバレス関数として実行できます。この場合、WebAssemblyは、こうしたサーバレス関数にとって便利で簡単に拡張可能なランタイムとして機能します。</li>
<li>WebAssemblyはサードパーティの依存関係についての見方を変えるかもしれません。モダンなコードはサードパーティのライブラリに大きく依存しており<a href="#11">11</a>、そうした依存関係のほとんどは十分に何度も調査されることがありません。最近の<a href="https://en.wikipedia.org/wiki/Log4Shell">Log4jの脆弱性</a>のようなソフトウェアのサプライチェーンの問題が明らかになるにつれて、人々はサードパーティライブラリのセキュリティを真剣に考えるようになると筆者は予想しています。Firefoxのように、WasmとRLBoxを利用して特定のライブラリを隔離するアプローチはいっそう広まっていくでしょう。パフォーマンス上の制約を克服できれば、同一のWasmランタイム内の機能が制約された別個のコンテナにサードパーティライブラリを隔離することも可能かもしれません<a href="#12">12</a>。</li>
</ul>
<h3>ブラウンフィールドへのデプロイ</h3>
<p>Wasmはいずれ何らかの形でDockerと相互運用できるようになる必要があります。今後2～3年は、Wasmの主な用途は後方互換性の要件が少ないグリーンフィールド（※訳注）へのデプロイとなるため、相互運用性が絶対に必要というわけではありません。しかし、最終的には、Wasmが（特に法人向け環境で）コンテナ化をめぐる競争に完全に勝利するには、ブラウンフィールド（※訳注）へのデプロイが簡単であることが必要です。
（※訳注：本翻訳は既存の投資用語を参照した表現として解釈します。「グリーンフィールド」既存環境による制約がない、新規開発できる環境。「ブラウンフィールド」既に既存のシステム等が動作している、制約つきの環境。）</p>
<p>考えられる結末の一つは、DockerがWasmランタイムを統合することです。これはあり得そうな話ですが、Wasmは今後、十分に差別化され、完全に別個のツールとして利用することが妥当になると筆者は予想しています。その代わり、<strong>DockerとWasmのコンテナはオーケストレーション層で統合されるでしょう</strong>。</p>
<p>KubernetesがWasmベースの実行を効果的に統合できるか、あるいは新たなオーケストレーションシステムが登場するかは、あまりはっきりしません。一方では、Kubernetesは現在、オーケストレーションに関して他の追随を許さない王者です。その勢いは驚異的で、Wasmによるコンテナ化の推進派はそれに乗じるのが賢明でしょう。MicrosoftのエンジニアはKubernetesとWasmが統合されるという未来に投資しており、<a href="https://github.com/krustlet/krustlet">Krustlet</a>を開発しています。これはKubernetesでWasmのワークロードを実行できるようにするものです。他方、WasmのコードはDockerのコンテナとは要件が異なるとみられるため、Kubernetesとは相性が良くない可能性があります。例えば、Wasmによるサードパーティライブラリの隔離を採用している場合、コンテナ間の通信のために共有メモリを設定するのが便利ですが、これはKubernetesでは困難でしょう。いずれはこうしたWasmネイティブのオーケストレータが懸け橋となり、Dockerからの移行やDockerとの統合が簡単になるはずです。</p>
<p>筆者はこれからWasmオーケストレータの波が来ることを期待していますが、Kubernetesは十分に定着しているため、すぐに廃れはしないでしょう。

### 標準化されたサーバレス/エッジフレームワーク</p>
<p>ほとんどのサーバレスプロバイダはルートやラムダ関数を定義するための独自のフレームワークを定めています。例えば、Cloudflareは独自の「cf」という型を定め、コードのスキャフォールディングを設定するためにwranglerというCLIツールを提供しています。Fastlyにはキャッシュとのインタラクションとロギングのための一連の独自インタフェースがあり、AWS Lambdaにも同様の設定が存在します。KubernetesのFissionフレームワークは、さまざまな言語を統合するための独自ライブラリを持っています。一部のプラットフォームは、ユーザにDockerのコンテナを提供させ、プラットフォームが実行のみをすれば良いようにすることで、この問題を回避しようとしています。<a href="https://knative.dev/docs/">Knative</a>と<a href="https://fly.io/">Fly.io</a>はどちらもこのアプローチを採用しています。しかし、これらはコールドスタート時間の影響を軽減するために「ワーカープールを温めておく」問題をユーザに転嫁しなければなりません。</p>
<p>現在は標準化されたサーバレス関数の定義とデプロイ仕様を構築するチャンスがあります。人気の<a href="https://github.com/serverless/serverless">Serverless Framework</a>は、デプロイの抽象化にはそれなりに役立ちますが、依然としてプロバイダ固有の詳細な部分は関数の実装に委ねられています。こうした詳細部分が抽象化されれば、すぐにマルチクラウドのデプロイは大幅に簡単になり、このフレームワークははるかに強力になるでしょう。いずれはサーバレスにおけるTerraformのような存在になるかもしれません<a href="#13">13</a>。</p>
<h3>パッケージ管理</h3>
<p>あらゆるプログラミング言語には、その言語を取り巻くエコシステムが存在します。ほとんどのモダンな言語は一元的なパッケージレジストリを利用しており、PythonにはPyPI、Node.jsにはnpm、Rustにはcrates.ioがあります。こうしたレジストリやそれに付属するツールとワークフローは、高品質なエコシステムの開発や開発者の作業の効率化にとって重要です。</p>
<p>Wasmの場合、<a href="https://wapm.io/">WebAssembly Package Manager</a>（WAPM）がこの需要を満たすはずでした。しかし、実際にはプロジェクトはほとんど休止しているようです。この記事の執筆時点（※訳注：翻訳元の記事は2022年1月31日公開）で、<a href="https://web.archive.org/web/20211229050050/https://wapm.io/">過去2カ月</a>に更新されたパッケージは3つにとどまっています。問題は、パッケージがお互いに依存すると想定されているのに対し、WAPMが相互依存関係のないスタンドアロンのWasmバイナリでしか機能しないことです。開発者にとって他の選択肢はWasmモジュールをnpmに公開することですが、npmは言語をまたぐ相互運用性を促進するものではないため、当然ながらJavaScriptやAssemblyScriptを越えるWasmエコシステムを構築するうえで理想的とは言えません。</p>
<p>問題の原因は、実際にはWAPMやnpmではなく、WebAssembly自体が粗削りな点にあります。</p>
<blockquote>
<p>現在、意味のあるWebAssemblyアプリケーションを書き、それがランタイムや言語の境界を越える相互運用性を持つようにするには、多大な労力が求められます。また、基本的でないデータ型（文字列や構造体など）のやり取りにはポインタの演算と低水準なメモリの操作が必要です。</p>
<p><a href="https://radu-matei.com/blog/intro-wasm-components/">― Introduction to WebAssembly components | radu’s blog</a></p>
</blockquote>
<p>これこそ、まさにWebAssembly Component Modelが解決しようとしている問題です。WasmコンポーネントはWebAssembly Interfaceフォーマットを標準化し、こうしたインタフェースの実装・利用の両方のための<a href="https://github.com/bytecodealliance/wit-bindgen">コードジェネレータ</a>を提供します。つまり、Wasmでランタイムと言語の壁を乗り越えるのが簡単になるのです。</p>
<p>WebAssemblyには高品質なパッケージマネージャを構築する大きな機会があります。このパッケージマネージャは、Wasmモジュールを他の言語から利用するためのバインディングを生成するのにWasmコンポーネントのcodegenを利用すべきでしょう。このツールが十分に優れていれば、言語をまたぐ開発がとても簡単になり、サーバサイドのWebAssemblyエコシステムの可能性を本当の意味で広げる可能性があります。Wasmパッケージレジストリは、他のパッケージレジストリと連携し、適切に生成されたバインディングとともにパッケージをPyPI、npm、crates.ioに自動的に公開することもできるかもしれません。</p>
<h2>終わりに</h2>
<p>ここまで読んできた方は、「WebAssemblyがそんなに優れているなら、なぜ広く使われていないのか？」と考えていることでしょう。その理由をいくつか挙げたいと思います。</p>
<ul>
<li>WebAssemblyはマーケティングがうまくありません。WebAssemblyはWeb限定でもアセンブリでもなく、名前が実体とかけ離れています。WebAssemblyは主にWeb開発者向けにマーケティングと宣伝が行われていますが、実際のポテンシャルは<a href="https://blog.bitsrc.io/whats-wrong-with-web-assembly-3b9abb671ec2">ブラウザを越えたところ</a>にあります。本当の力が明らかになるのは、C++とRustの開発者がWasmの持つポテンシャルに一斉に気づき始めたときでしょう。</li>
<li>WebAssemblyは依然として標準化されていません。例えば、WebAssembly System Interfaceには正式に標準化されていない無数の拡張機能がありますが、さまざまなランタイムがこうした拡張機能の一部を実装しています。ユニバーサルポータビリティという目標も完全には実現されていません。</li>
<li>言語間のインタラクション機能が不便です。ユーザが実際にさまざまな言語でWasmを使用し始めるには、クリティカルマスに相当する数の言語について、WebAssemblyコンポーネントと優れたコードジェネレータが必要です。</li>
<li>開発者体験に大きな改善の余地があります。<a href="https://thenewstack.io/the-pain-of-debugging-webassembly/">デバッグをはじめ</a>とするツールや、パッケージマネージャ、ビルドシステム、IDEとの統合性が改善されることが理想です。</li>
<li>こういうことは言いたくないのですが、WebAssemblyのライブラリ隔離機能が正当に評価されるには、Log4Shellと同様の規模の深刻なソフトウェア・サプライチェーン・インシデントがあと何回か起きる必要があるでしょう。</li>
</ul>
<p>WebAssemblyは名だたる数々のサービスで導入されており、さまざまな用途に利用できますが、IT業界全体では一部で散発的に使われているにすぎません。筆者の友人の中でWebAssemblyを知っている数少ない人たちは、基本的にはWebAssemblyをとても面白いと考えているものの、まだ十分に成熟していないため開発には利用していません。しかし、こうした課題の多くに対して積極的な取り組みが行われており、今後1～2年で問題ない状態に達するでしょう。ですから、<strong>私たちは現在、WebAssemblyの利用、エコシステム、コミュニティが爆発的に拡大する瀬戸際にあると思われます</strong>。</p>
<p><em><a href="https://news.ycombinator.com/item?id=30155295">Hacker News</a>での議論にぜひご参加ください。また、<a href="https://harshal.sheth.io/about">筆者へのご意見も歓迎します</a>。この記事の初期の草案に対するフィードバックをくれたNihar Sheth、Mohak Jain、Andrew Sun、Michelle Fangに感謝します。</em></p>
<h3>注記</h3>
<ol>
<li><a name="01"></a>実際には若干微妙な部分があります。WasmにはWeb APIとWebAssembly System Interface（WASI）APIという2つの<a href="https://v8.dev/blog/emscripten-standalone-wasm">標準的なAPI</a>が存在します。また、WebAssemblyは急速に進化しているため、例えばスレッディングのように、広く実装されているが正式には標準化されていない実験的機能が数多くあります。それ以外にも、Wasmが別のアプリケーションに組み込まれる場合、そのアプリケーションが独自のAPIを提供するかもしれません。したがって、Wasmコードが実行されるのは、そのランタイムが対応しているAPIと機能のみを使用する場合に限られますが、これは十分に妥当な想定と言えます。↩</li>
<li><a name="02"></a>なぜかは分かりませんが、WebAssemblyのランタイムの名前はすべて「wa」で始まるようです。他にも<a href="https://github.com/WasmEdge/WasmEdge">WasmEdge</a>、<a href="https://github.com/WAVM/WAVM">WAVM</a>、<a href="https://github.com/wasm3/wasm3">wasm3</a>があります。数少ない例外の一つが<a href="https://github.com/wasmx/fizzy">Fizzy</a>ですが、このプロジェクトもwasmxという組織によってホストされています。↩</li>
<li><a name="03"></a>ただし、PythonやRubyなどのインタプリタ型言語やGoなどのランタイムが複雑な言語は、Wasmで実行しても良いパフォーマンスを生まないでしょう。↩</li>
<li><a name="04"></a>Firefoxでは、Wasmへのコンパイルはネットワークによるパケットの送信よりも実際に<a href="https://hacks.mozilla.org/2018/01/making-webassembly-even-faster-firefoxs-new-streaming-and-tiering-compiler/">速くなります</a>。<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming">WebAssembly.instantiateStreaming</a>メソッドにより、ファイルのダウンロード完了前からコンパイルのプロセスを開始できるため、Wasmコードの実行開始前のレイテンシはごくわずかしか増加しません。↩</li>
<li><a name="05"></a>ただし、それでも小さな欠点は残っています。機能ベースの許可システムは依然として粒度が非常に高いわけではなく、ほとんどのWasmランタイムはSpectreのようなサイドチャネル攻撃を防止できないため、追加的な戦略が必要になります。CloudflareのKenton Vardaは、自社の脅威モデルと、脅威を軽減するために実装した対策について、<a href="https://blog.cloudflare.com/mitigating-spectre-and-other-security-threats-the-cloudflare-workers-security-model/">詳細な記事</a>を執筆しています。↩</li>
<li><a name="06"></a>WasmはJavaScriptの「ファストパス」から逸脱した場合に生じる脱最適化の問題を回避できるため、JavaScriptの最高のパフォーマンスと同等以上のパフォーマンスで安定して高速にコードを実行できます。面白いことに、実はJavaScriptをWebAssemblyにコンパイルして元のコードの代わりに実行するだけで、ブラウザでJavaScriptの実行を高速化することが可能です。Lin Clarkはその方法とそれがうまくいく理由について、<a href="https://www.youtube.com/watch?v=CRaMls9oVBw">素晴らしい講演</a>を実施しています。↩</li>
<li><a name="07"></a>数年前にFigmaの技術リーダーとの個人的な会話で聞いた情報です。Google ChromeやFirefoxなどの多くのブラウザは既に内部でSkiaを利用しています。しかし、こうしたブラウザはSkia APIを直接は公開していないため、アプリケーションは低速なブラウザDOMやSVGインタフェースを利用しなければなりません。Figmaはこうした低速なレイヤを回避し、ブラウザのキャンバス要素に直接描画しますが、依然としてアプリケーションへの<a href="https://skia.org/docs/user/modules/canvaskit/">組み込み</a>を通じてSkiaの一部の機能を利用しています。↩</li>
<li><a name="08"></a>他にも注目すべき選択肢があります。例えば、AWS Lambdaは軽量な<a href="https://firecracker-microvm.github.io/">Firecracker microVM</a>を利用しています。両者を直接比較すると、<a href="https://arxiv.org/ftp/arxiv/papers/2010/2010.07115.pdf">WebAssemblyのパフォーマンスの方が少し優れています</a>。↩</li>
<li><a name="09"></a>WebAssemblyによる128ビット型のSIMDのサポートは、現在は実験的な段階にありますが、多くのブラウザとランタイムに実装されています。「ロングSIMD」のサポートは引き続き<a href="https://github.com/WebAssembly/design/blob/5b2c607fe173c813214afde33e0ea82d33dd0983/FutureFeatures.md#long-simd">今後の課題</a>と言えます。↩</li>
<li><a name="10"></a>この主張に対する反論は、「マイクロサービスを分解できるからといって、実際に分解するとは限らない」というものです。これは確かにもっともな批判であり、実はモノリスとマイクロサービスの関係にも当てはまります。例えば、「マイクロサービスを本番環境で始めるべきではない――モノリスは君の友人だ」という<a href="https://arnoldgalovics.com/microservices-in-production/">最近の記事</a>は<a href="https://news.ycombinator.com/item?id=29576352">大きな議論</a>を呼びました。それでも、マイクロサービスアーキテクチャは、適切な状況で導入すればとてつもなく有効で、生産性を大幅に高めます。筆者はWebAssembly中心のアーキテクチャにも同じことが言えると予想しています。ただし、WebAssemblyに適した状況がどれだけ存在するかはあまりはっきりしません。↩</li>
<li><a name="11"></a>この問題はとても有名で、<a href="https://www.reddit.com/r/ProgrammerHumor/comments/992u1p/dependencies_101/">これ</a>に<a href="https://xkcd.com/2347/">関する</a><a href="https://www.reddit.com/r/ProgrammerHumor/comments/6s0wov/heaviest_objects_in_the_universe/">ミーム</a>が存在するほどです。↩</li>
<li><a name="12"></a>誰かがこうしたサービスを提供する企業を設立すべきでしょう。最近Log4jの脆弱性が判明したことで、ソフトウェアのサプライチェーンは現在、最も重要な問題となっています。さらに、ほとんどの既存企業は依存関係の隔離よりも検証に重点を置いているようです。↩</li>
<li><a name="13"></a>これは最適な比較対象ではないかもしれません。なぜなら、Terraformがデプロイやクラウドプロバイダとのインタラクションのみを抽象化するのに対し、このフレームワークはコード層でも機能するからです。↩</li>
</ol>]]></content:encoded></item></channel></rss>