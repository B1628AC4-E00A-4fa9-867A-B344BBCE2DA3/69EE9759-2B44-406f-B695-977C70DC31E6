<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア]]></title><description><![CDATA[POSTD は、ニジボックスが運営する、エンジニアに向けたキュレーションメディアです。ニジボックスはWebサービスの企画、制作、開発、運用を一貫して担うリクルートの100%子会社です。 リクルートグループのオンラインサービスをはじめ、様々な業種・業界・業態のサービス開発を行っております。]]></description><link>https://postd.cc</link><generator>GatsbyJS</generator><lastBuildDate>Wed, 27 Jul 2022 03:17:38 GMT</lastBuildDate><language>ja</language><atom:link href="https://postd.cc/feed/" rel="self" type="application/rss+xml"/><image><title>POSTD | ニジボックスが運営するエンジニアに向けたキュレーションメディア</title><link>https://postd.cc</link></image><item><title><![CDATA[React Server Componentsの仕組み：詳細ガイド]]></title><description><![CDATA[React Server Components（RSC）は、ページの読み込みパフォーマンスやバンドルサイズのほか、Reactアプリケーションの書き方に近い将来大きな影響を与えることになる、素晴らしい…]]></description><link>https://postd.cc/how-react-server-components-work/</link><guid isPermaLink="false">https://postd.cc/how-react-server-components-work/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[React]]></category><pubDate>Wed, 27 Jul 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>React Server Components（RSC）は、ページの読み込みパフォーマンスやバンドルサイズのほか、Reactアプリケーションの書き方に近い将来大きな影響を与えることになる、素晴らしい新機能です。
Plasmicでは、<a href="https://plasmic.app/">Reactのビジュアルビルダー</a>を開発しており、Reactのパフォーマンスには大きな関心を持もっています。
当社のクライアントの多くは、Plasmicを使用して高いパフォーマンスが求められるマーケティングサイトやECサイトを構築しています。
したがって、RSCはまだReact 18の初期実験機能ですが、Plasmicではその仕組みを詳しく調べています。
このブログ記事では、これまでに分かったことを紹介したいと思います。
Plasmicのメンバーによる<a href="https://www.reddit.com/r/reactjs/comments/s8r0ve/how_react_server_components_work_an_indepth_guide/">ツイートまとめ</a>もご覧ください。</p>
<ul class="toc-for-article">
    <li><a href="#01">React Server Componentsとは何か</a></li>
    <li><a href="#02">サーバサイドレンダリングとの違いは？</a></li>
    <li><a href="#03">RSCを使うメリット</a></li>
    <li><a href="#04">RSCの全体像</a></li>
    <li><a href="#05">サーバコンポーネントとクライアントコンポーネントの分断</a></li>
    <li>
        <a href="#06">RSCレンダリングの流れ</a>
        <ul>
            <li><a href="#07">1. サーバがレンダリングリクエストを受け取る</a></li>
            <li><a href="#08">2. サーバがルートコンポーネント要素をJSON形式にシリアライズ</a></li>
            <li><a href="#09">3. ブラウザがReactツリーを再構築</a></li>
            <li><a href="#10">Suspenseとの互換性は問題ないか？</a></li>
        </ul>
    </li>
    <li>
        <a href="#11">RSCワイヤーフォーマット</a>
        <ul>
            <li><a href="#12">RSCフォーマットを使う</a></li>
            <li><a href="#13">単にプレーンHTMLを出力すればよいのでは？</a></li>
            <li><a href="#14">クライアントコンポーネントからデータを取得するだけよりもメリットがある？</a></li>
            <li><a href="#15">サーバサイドレンダリングはどうなる？</a></li>
        </ul>
    </li>
    <li><a href="#16">サーバコンポーネントがレンダリングしているコンテンツのアップデート</a></li>
    <li><a href="#17">RSCにメタフレームワークを使うべき理由</a></li>
    <li><a href="#18">RSCは実用化の準備ができているのか？</a></li>
</ul>
<h2>React Server Componentsとは何か<a name="01"></a></h2>
<p>React Server Components（RSC）は、サーバとクライアント（ブラウザ）が連携してReactアプリケーションのレンダリングを行うことを可能にします。
Webページを表示する際にレンダリングされる一般的なReact要素ツリーは、通常異なるReactコンポーネントがさらに多くのReactコンポーネントをレンダリングする構成になっています。
RSCは、このツリーを構成する一部のコンポーネントが<em>サーバによって</em>レンダリングされ、他のコンポーネントが<em>ブラウザによって</em>レンダリングされることを可能にします。🤯</p>
<p>これはReactチームによる概略図です。
最終的なゴールは、オレンジのコンポーネントはサーバ側でレンダリングされ、青のコンポーネントはクライアント側でレンダリングされるようなReactツリーです。</p>
<p><img src="https://www.plasmic.app/blog/static/images/react-server-components.png"></p>
<h2>サーバサイドレンダリングとの違いは？<a name="02"></a></h2>
<p><strong>RSCはサーバサイドレンダリング（SSR）ではありません</strong>。
どちらも名前に「サーバ」が含まれ、どちらもサーバ上で動いているので少し混乱しますね。
しかし、両者はそれぞれ独立した直交する機能であると理解した方がずっと分かりやすいでしょう。
RSCはSSRを必要とせず、その逆もまたしかりです。
SSRは、Reactツリーを生HTMLにレンダリングするための環境をシミュレーションします。
<em>サーバコンポーネントとクライアントコンポーネントを区別せず、どちらも同じようにレンダリングします。</em></p>
<p>SSRとRSCを組み合わせ、サーバコンポーネントでサーバサイドレンダリングを行い、ブラウザ上で適切にハイドレーションすることも可能です。
両者を併用する方法については、後日別の記事で詳しく話したいと思います。</p>
<p>SSRについてはひとまず無視し、RSCだけにフォーカスしましょう。</p>
<h2>RSCを使うメリット<a name="03"></a></h2>
<p>RSC以前のReactコンポーネントはすべてクライアントコンポーネントであり、ブラウザ上で実行されます。
Reactページにアクセスすると、ブラウザは必要なReactコンポーネントすべてのコードをダウンロードし、React要素ツリーを構築してDOMにレンダリングします（SSRを使用している場合は、DOMをハイドレーションします）。
これらの処理がブラウザ上で行われることで React アプリケーションはインタラクティブに（イベントハンドラをインストールし、ステートを追跡し、イベントに応じてReactツリーに変更を加え、DOMを効率的にアップデートできるように）なります。
では、サーバ上でレンダリングを行うメリットは何でしょうか。
ブラウザよりサーバ上でレンダリングを行った方がよい理由はいくつかあります。</p>
<ul>
<li>サーバは、データベース、GraphQLエンドポイント、ファイルシステムなどのデータソースにもっとダイレクトにアクセスできます。パブリックAPIエンドポイントを経由することなく、必要なデータを直接取得でき、通常データソースに近い場所に配置されているため、ブラウザよりも素早くデータを取得できます。</li>
<li>サーバは、たとえばマークダウンをHTMLに変換してレンダリングするためのnpmパッケージなどの「重い」コードモジュールを手軽に利用できます。それは、これらの依存関係を使用するたびにダウンロードする必要がないからです。ブラウザの場合、使用するコードをすべてJavaScriptのバンドルとしてダウンロードする必要があります。</li>
</ul>
<p>要するに、<strong>RSCはサーバとブラウザが互いに得意な処理を行えるようにするのです</strong>。
サーバコンポーネントはデータの取得とコンテンツのレンダリング、クライアントコンポーネントはステートフルなインタラクティビティに注力できるため、ページの読み込み速度が速くなるほか、JavaScriptのバンドルサイズが小さくなり、ユーザ体験が改善されます。</p>
<h2>RSCの全体像<a name="04"></a></h2>
<p>では、まずその仕組みについて直感的に理解することから始めましょう。</p>
<p>筆者の子供たちはカップケーキのデコレーションは<em>大好き</em>なのですが、焼くことに関してはさほど興味を示しません。
カップケーキを一から作らせ、デコレーションまでさせるのは、きっと（かわいらしい）悪夢のような経験になるでしょう。
小麦粉と砂糖、バターを用意し、オーブンの使用を許可し、さまざまな取扱説明書を延々と読んで聞かせなくてはいけません。
そんなことをしていては、丸一日かかってしまいます。
しかし筆者ならば、オーブンで焼く作業をずっと速く行えます。
一部の作業を事前に行っておけば（原材料をそのまま渡すのではなく、カップケーキを焼き、アイシングを作り、それらを渡す）、子供たちは楽しいデコレーションにもっと早く取り掛かれます。
さらに良いことに、子供たちがオーブンを使用することについて心配する必要がありません。
素晴らしい！</p>
<p><img src="https://www.plasmic.app/blog/static/images/cake.jpg"></p>
<p>RSCの目的は、この役割分担を可能にすることです。
サーバが得意な作業は事前にサーバに行わせてから、残りの作業をブラウザに引き継ぐのです。
そうすることで、サーバがブラウザに渡すデータ量も減らすことができます。
袋いっぱいの小麦粉とオーブンに比べ、小さなカップケーキ12個の方がはるかに効率的に運べます。</p>
<p>一部のコンポーネントはサーバ側で、残りはクライアント側でレンダリングされるようなページのReactツリーを想像してみてください。
RSCのハイレベルな戦略を簡略化すると以下のような形になります。
サーバは、いつも通りサーバコンポーネントをレンダリングし、Reactコンポーネントを<code class="language-text">div</code>や<code class="language-text">p</code>などのネイティブHTML要素に変換します。
しかし、ブラウザ上でレンダリングされるクライアントコンポーネントに遭遇すると、代わりにプレースホルダを出力します。
サーバは、プレースホルダーに適切なクライアントコンポーネントとpropsを適用するように指示を加えます。
ブラウザはこの出力を受け取り、クライアントコンポーネントで穴埋めを行います。
これで完成です。</p>
<p><strong>実際の仕組みはそんなに単純ではありません</strong>。
詳細については後ほど話しますが、まずは全体像を頭に入れておくと有益です。</p>
<h2>サーバコンポーネントとクライアントコンポーネントの分断<a name="05"></a></h2>
<p>ところで、サーバコンポーネントとは何でしょうか。
サーバ用とクライアント用のコンポーネントはどのようにして区別するのでしょうか。</p>
<p>Reactチームでは、コンポーネントが記述されたファイルの拡張子を基に定義しています。
<code class="language-text">.server.jsx</code>で終わるファイルにはサーバコンポーネント、<code class="language-text">.client.jsx</code>で終わるファイルにはクライアントコンポーネントが含まれています。
これらいずれの拡張子ももたないファイルには、サーバ用としてもクライアント用としても使用できるコンポーネントが含まれています。</p>
<p>これは実用的な定義であり、人間にとってもバンドラーにとっても区別が容易です。
特にバンドラーにとっては、ファイル名を調べることでクライアントコンポーネントを区別し、処理方法を変えられるようになりました。
後述しますが、バンドラーはRSCが適切に機能する上で重要な役割を果たします。</p>
<p>サーバコンポーネントはサーバ上で、クライアントコンポーネントはクライアント上で実行されるため、それぞれできることにさまざまな制限があります。
その中でも最も重要なのが、<strong>クライアントコンポーネントはサーバコンポーネントをインポートできない</strong>ということです。
それは、サーバコンポーネントはブラウザ上で実行できず、ブラウザ上では機能しないコードが含まれる可能性があるためです。
クライアントコンポーネントがサーバコンポーネントに依存する場合、不正な依存関係がブラウザバンドルに入り込んでしまうことになります。
つまり、以下のようなクライアントコンポーネントは不正ということになってしまうため、この最後の点は難題になり得ます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// ClientComponent.client.jsx</span>
<span class="token comment">// 悪い例:</span>
<span class="token keyword">import</span> ServerComponent <span class="token keyword">from</span> <span class="token string">'./ServerComponent.server'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ClientComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ServerComponent</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>しかし、クライアントコンポーネントがサーバコンポーネントをインポートできず、サーバコンポーネントのインスタンスを生成できないのであれば、どうすれば以下のようにサーバコンポーネントとクライアントコンポーネントが交互に配置されたReactツリーができるのでしょうか。またどうすれば、クライアントコンポーネント（青い丸）の下にサーバコンポーネント（オレンジ色の丸）を配置できるのでしょうか。</p>
<p><img src="https://www.plasmic.app/blog/static/images/react-server-components.png"></p>
<p>クライアントコンポーネントからサーバコンポーネントをインポートしてレンダリングすることはできませんが、コンポジションは使用できます。
つまり、クライアントコンポーネントは単なる不透明な<code class="language-text">ReactNode</code>であるpropsを取り込むことはでき、<code class="language-text">ReactNode</code>がサーバコンポーネントによってレンダリングされることも可能です。
以下に例を挙げます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// ClientComponent.client.jsx</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ClientComponent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Hello from client land</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ServerComponent.server.jsx</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ServerComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">></span></span><span class="token plain-text">Hello from server land</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>

<span class="token comment">// OuterServerComponentはクライアントコンポーネントも</span>
<span class="token comment">// サーバーコンポーネントもインスタンス化することができ、</span>
<span class="token comment">// ClientComponentのchildrenとして&lt;ServerComponent/>を渡します。</span>
<span class="token keyword">import</span> ClientComponent <span class="token keyword">from</span> <span class="token string">'./ClientComponent.client'</span>
<span class="token keyword">import</span> ServerComponent <span class="token keyword">from</span> <span class="token string">'./ServerComponent.server'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">OuterServerComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ClientComponent</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ServerComponent</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ClientComponent</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この制限は、RSCを有効に活用するためのコンポーネントの配置を検討する上で大きな影響があります。</p>
<h2>RSCレンダリングの流れ<a name="06"></a></h2>
<p>それでは、Reactサーバコンポーネントをレンダリングするときに実際何が起こるのか、肝心な部分を詳しく見ていきましょう。
ここで説明することをすべて理解しなくてもサーバコンポーネントは使えますが、仕組みについて直感的な理解は得られると思います。</p>
<h3>1. サーバがレンダリングリクエストを受け取る<a name="07"></a></h3>
<p>レンダリングの一部はサーバが行わなくてはならないため、RSCを使用する場合、ページのレンダリングは必ずサーバで始まります。
その際、APIコールによってReactコンポーネントのレンダリングが開始します。
この「ルート」コンポーネントは必ずサーバコンポーネントであり、他のサーバコンポーネントまたはクライアントコンポーネントをレンダリングする場合もあります。
サーバは、リクエストに含まれる情報をもとに、使用するサーバコンポーネントとpropsを判断します。
このリクエストは、通常特定のURLでページリクエストの形で届きますが、Shopify Hydrogenはより<a href="https://shopify.dev/custom-storefronts/hydrogen/framework/server-state">きめ細かい方法</a>を使用しており、Reactチームの公式デモでは<a href="https://github.com/reactjs/server-components-demo/blob/main/server/api.server.js">raw実装</a>を行っています。</p>
<h3>2. サーバがルートコンポーネント要素をJSON形式にシリアライズ<a name="08"></a></h3>
<p>ここでの最終目的は、最初のルートサーバコンポーネントをHTMLのタグとクライアントコンポーネントのプレースホルダで構成されるツリーとしてレンダリングすることです。
次に、そのツリーをシリアライズしてブラウザに送ります。
ブラウザ側では、受け取ったデータをデシリアライズし、プレースホルダを実際のクライアントコンポーネントに置き換え、最終結果をレンダリングします。</p>
<p>上の例に沿って見てみましょう。
<code class="language-text">&lt;OuterServerComponent/&gt;</code>をレンダリングしたい場合、<code class="language-text">JSON.stringify(&lt;OuterServerComponent /&gt;)</code>を実行すればシリアライズされた要素ツリーが得られるでしょうか？</p>
<p>惜しいですが、少し違います。😅
React要素とは実際のところどういうものだったか、思い出してみてください。
<code class="language-text">type</code>というフィールドに文字列または関数をとるオブジェクトです。
<code class="language-text">type</code> には、文字列なら<code class="language-text">&quot;div&quot;</code>のようなhtmlのタグ名が、関数ならReactコンポーネントのインスタンスが入ります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// &lt;div>oh my&lt;/div> を返す場合</span>
<span class="token operator">></span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"oh my"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">"div"</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"oh my"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// &lt;MyComponent>oh my&lt;/MyComponent> を返す場合</span>
<span class="token operator">></span> <span class="token keyword">function</span> <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>children<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">></span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> children<span class="token operator">:</span> <span class="token string">"oh my"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
  $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> MyComponent   <span class="token comment">// MyComponent 関数への参照 function</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span> children<span class="token operator">:</span> <span class="token string">"oh my"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">type</code>にHTMLタグではなくコンポーネントを指定した場合、typeフィールドはコンポーネントとして定義した関数（訳注: 原文ではcomponent function。本記事では、以降「コンポーネント関数」と訳します）を参照します。
しかし、関数はJSON 形式にシリアライズできません。</p>
<p>すべての要素をJSON文字列に適切に変換するために、Reactはこれらのコンポーネント関数の参照に適切に対処する特別な<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#the_replacer_parameter">置換関数</a>を<code class="language-text">JSON.stringify()</code>に渡します。
そのa関数は、<a href="https://github.com/facebook/react/blob/42c30e8b122841d7fe72e28e36848a6de1363b0c/packages/react-server/src/ReactFlightServer.js#L368">ReactFlightServer.jsにあるresolveModelToJSON()</a>です。</p>
<p>具体的には、シリアライズ対象のReact要素に対して以下の処理を行います。</p>
<ul>
<li>HTMLのbaseタグ（<code class="language-text">type</code>フィールドには、「<code class="language-text">div</code>」のような文字列が入ります）の場合、すでにシリアライズ可能です。特別な処理は必要ありません。</li>
<li>サーバコンポーネントの要素の場合、サーバコンポーネント関数（<code class="language-text">type</code>フィールドに格納されている）とそのpropsを呼び出し、その結果をシリアライズします。これは実質的にサーバーコンポーネントのレンダリングに相当します。つまり、全てのサーバーコンポーネントをただのHTMLタグに変換するのです。</li>
<li>クライアントコンポーネントの場合も、すでにシリアライズ可能です。<code class="language-text">type</code>フィールドはすでにコンポーネント関数ではなく、モジュール参照オブジェクトを指し示しています。このモジュール参照オブジェクトとは一体何なのでしょう。</li>
</ul>
<h4>「モジュール参照」オブジェクトとは何か</h4>
<p>RSCでは、React要素の<code class="language-text">type</code>フィールドに「モジュール参照」と呼ばれる新しい値を導入できます。
コンポーネント関数の代わりに、コンポーネント関数へのシリアライズ可能な「参照」を渡すのです。
例えば、<code class="language-text">ClientComponent</code>という要素は以下のような形を取ることができます。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token punctuation">{</span>
  $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// type フィールドが、実際のコンポーネント関数の代わりに参照オブジェクトを持つようになりました</span>
  type<span class="token operator">:</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>module<span class="token punctuation">.</span>reference<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// ClientComponent は以下のファイルから default export されます</span>
    name<span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
    <span class="token comment">// ClientComponent を default export しているファイルのパス</span>
    filename<span class="token operator">:</span> <span class="token string">"./src/ClientComponent.client.js"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span> children<span class="token operator">:</span> <span class="token string">"oh my"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>しかし、このマジックのような処理はどこで行われているのでしょうか。
クライアントコンポーネント関数への参照は、どこでシリアライズ可能な「モジュール参照」オブジェクトに変換されているのでしょうか。</p>
<p>なんと、この手品のような処理はバンドラーが行なっているのです。
Reactチームは、webpack向けの公式RSCサポートを、<code class="language-text">react-server-dom-webpack</code>で<a href="https://github.com/facebook/react/blob/main/packages/react-server-dom-webpack/src/ReactFlightWebpackNodeLoader.js">webpackローダ</a>または<a href="https://github.com/facebook/react/blob/main/packages/react-server-dom-webpack/src/ReactFlightWebpackNodeRegister.js">node-register</a>として公開しています。
サーバコンポーネントが<code class="language-text">*.client.jsx</code>ファイルから何かをインポートする際、実際のインポート対象を取得する代わりに、そのファイル名とエクスポート名が含まれたモジュール参照オブジェクトだけを取得しています。
クライアントコンポーネント関数が、サーバ上に構築されるReactツリーの一部に組み込まれることはありません。</p>
<p><a href="#08">このセクションの冒頭で</a><code class="language-text">&lt;OuterServerComponent /&gt;</code>をシリアライズしようとした例を思い出してください。
最終的には以下のようなJSONツリーになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token punctuation">{</span>
  <span class="token comment">//「モジュール参照」を持つ ClientComponent のプレースホルダー</span>
  $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>module<span class="token punctuation">.</span>reference<span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">"./src/ClientComponent.client.js"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ClientComponent に渡される children（ここでは &lt;ServerComponent />）</span>
    children<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// ServerComponentは html タグに直でレンダリングされます。</span>
      <span class="token comment">// ServerComponent への参照が一切なく、直でspanをレンダリングしていることに注目してください。</span>
      $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span>react<span class="token punctuation">.</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">"span"</span><span class="token punctuation">,</span>
      props<span class="token operator">:</span> <span class="token punctuation">{</span>
        children<span class="token operator">:</span> <span class="token string">"Hello from server land"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h4>シリアライズ可能なReactツリー</h4>
<p>このプロセスの終わりには、サーバ上に以下のようなReactツリーができていることが望まれます。
これをブラウザに送信して「仕上げ」を行います。</p>
<p><img src="https://www.plasmic.app/blog/static/images/react-server-components-placeholders.png"></p>
<p><strong>propsはすべてシリアライズ可能であること</strong></p>
<p>Reactツリー全体をJSON形式にシリアライズするため、クライアントコンポーネントまたはHTMLのbaseタグに渡すpropsもすべてシリアライズ可能でなくてはなりません。
これはつまり、サーバコンポーネントからイベントハンドラをpropsとして渡すことはできないということです。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// 悪い例: サーバーコンポーネントは props として子孫コンポーネントに関数を渡すことができません。なぜなら関数はシリアライズできないからです。</span>
<span class="token keyword">function</span> <span class="token function">SomeServerComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'OHHAI'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Click me!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>しかし、1つ留意すべき点として、RSCプロセスの際にクライアントコンポーネントに遭遇しても、決してクライアントコンポーネント関数を呼び出したり、クライアントコンポーネントに「降りて行く」ことはありません。
したがって、別のクライアントコンポーネントのインスタンスを生成するクライアントコンポーネントがある場合、以下のようになります。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">SomeServerComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ClientComponent1</span></span><span class="token punctuation">></span></span><span class="token plain-text">Hello world!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ClientComponent1</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ClientComponent1</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>children<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// クライアントからクライアントコンポーネントに props として関数を渡すのは可</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ClientComponent2</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ClientComponent2</span></span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このRSC JSONツリーには、<code class="language-text">ClientComponent2</code>は一切出てきません。
その代わり、<code class="language-text">ClientComponent1</code>のモジュール参照とpropsをもつ要素だけがあります。
そのため、<code class="language-text">ClientComponent1</code>がpropsとしてイベントハンドラを<code class="language-text">ClientComponent2</code>に渡すのは、全く正常なことです。</p>
<h3>3. ブラウザがReactツリーを再構築<a name="09"></a></h3>
<p>ブラウザは、サーバからJSON出力を受け取ったら、ブラウザ上でレンダリングするReactツリーの再構築を開始しなくてはいけません。
<code class="language-text">type</code>がモジュール参照である要素に遭遇した場合、実際のクライアントコンポーネント関数への参照に置き換える必要があります。
この作業には、再びバンドラーの助けが必要になります。
バンドラーを用いてサーバ上でクライアントコンポーネント関数をモジュール参照に置き換えたように、今度はバンドラーを用いてブラウザ上でモジュール参照を実際のクライアントコンポーネント関数に置き換えます。
再構築されたReactツリーは以下のようになります。異なる点は、ネイティブのタグとクライアントコンポーネントが置き換わっていることだけです。</p>
<p><img src="https://www.plasmic.app/blog/static/images/react-server-components-client.png"></p>
<p>あとは、いつも通りこのツリーをレンダリングし、DOMにコミットするだけです。</p>
<h3>Suspenseとの互換性は問題ないか？<a name="10"></a></h3>
<p>問題ありません。
Suspenseは、上で述べたすべてのステップで欠かせない役割を果たします。</p>
<p>Suspenseはそれ自体が壮大なテーマであり、それ単体でブログ記事1本分に相当するものなので、この記事ではあえて軽く触れるだけに留めています。
ごく簡単に説明すると、Suspenseは何か準備ができていないもの（データのフェッチ、コンポーネントの遅延インポートなど）を必要とする際、ReactコンポーネントからPromiseをスローすることを可能にします。
それらのPromiseは、Suspenseの境界でキャッチされます。
Suspenseサブツリーのレンダリング時にPromiseがスローされると、ReactはPromiseが解決されるまでサブツリーのレンダリングを停止し、再度トライします。</p>
<p>RSC出力を生成するためにサーバ上でサーバコンポーネント関数を呼び出すと、それらの関数が必要なデータを取得する際にPromiseを返す場合があります。
<a href="https://github.com/facebook/react/blob/42c30e8b122841d7fe72e28e36848a6de1363b0c/packages/react-server/src/ReactFlightServer.js#L416">スローされたPromiseに遭遇</a>すると、プレースホルダを出力します。
Promiseが解決すると、再びサーバコンポーネント関数を呼び出し、成功すれば完成したチャンクを出力します。
RSC出力ストリームを作成しているのであり、Promiseがスローされると停止し、解決すると追加のチャンクをストリーミングします。</p>
<p>同様に、ブラウザ上では上の<code class="language-text">fetch()</code>コールからRSC JSON出力ストリームを作成します。
このプロセスも、出力の中にSuspenseのプレースホルダがあり（サーバがスローされたPromiseに遭遇している）、ストリーム内にまだプレースホルダのコンテンツを見つけていない（<a href="https://github.com/facebook/react/blob/main/packages/react-client/src/ReactFlightClientStream.js">詳細はこちら</a>）場合、Promiseをスローすることになるかもしれません。
あるいは、クライアントコンポーネントのモジュール参照に遭遇したものの、まだブラウザ上にクライアントコンポーネント関数が読み込まれていない場合も、Promiseをスローする可能性があります。
その場合、バンドラーのランタイムが動的に<a href="https://github.com/facebook/react/blob/main/packages/react-server-dom-webpack/src/ReactFlightClientWebpackBundlerConfig.js">必要なチャンクを取得</a>する必要があります。</p>
<p>Suspenseのおかげで、サーバコンポーネントがデータを取得する間にサーバはRSC出力をストリーミングし、ブラウザは受け取ったデータから徐々にレンダリングし、必要になったクライアントコンポーネントバンドルを動的に取得します。</p>
<h2>RSCワイヤーフォーマット<a name="11"></a></h2>
<p>具体的にサーバは何を出力しているのでしょうか。
「JSON」と「ストリーム」の文字を見て疑念を抱いたのであれば、それは正しい反応です。
では、サーバはブラウザにどのようなデータをストリーミングしているのでしょうか。</p>
<p>IDがタグ付けされたJSONの塊が各行に一つ追加された、単純なフォーマットです。
以下は、<code class="language-text">&lt;OuterServerComponent/&gt;</code>の例のRSC出力です。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">M1:{&quot;id&quot;:&quot;./src/ClientComponent.client.js&quot;,&quot;chunks&quot;:[&quot;client1&quot;],&quot;name&quot;:&quot;&quot;}
J0:[&quot;$&quot;,&quot;@1&quot;,null,{&quot;children&quot;:[&quot;$&quot;,&quot;span&quot;,null,{&quot;children&quot;:&quot;Hello from server land&quot;}]}]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>上のスニペットでは、<code class="language-text">M</code>で始まる行はクライアントコンポーネントのモジュール参照を定義しており、クライアントバンドルの中からコンポーネント関数を検索するのに必要な情報が含まれています。
<code class="language-text">J</code>で始まる行は、実際のReact要素ツリーを定義しており、<code class="language-text">M</code>行で定義されたクライアントコンポーネントを参照する<code class="language-text">@1</code>などが含まれます。</p>
<p>このフォーマットは非常にストリーミングしやすく、クライアントは1行読み終えるとすぐにJSONのスニペットを解析して処理を進めることができます。
サーバがレンダリング中にSuspense境界に遭遇した場合、各チャンクが解決される度たびにそれと一致する複数の<code class="language-text">J</code>行が出てきます。</p>
<p>もう少し興味深い例を見てみましょう。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token comment">// Tweets.server.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-fetch'</span> <span class="token comment">// React の Suspense 対応した fetch()</span>
                                    
<span class="token keyword">import</span> Tweet <span class="token keyword">from</span> <span class="token string">'./Tweet.client'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Tweets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tweets <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/tweets</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>tweets<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">tweet</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tweet</span></span> <span class="token attr-name">tweet</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>tweet<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Tweet.client.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Tweet</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> tweet <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Written by </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tweet<span class="token punctuation">.</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>tweet<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>

<span class="token comment">// OuterServerComponent.server.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">OuterServerComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ClientComponent</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ServerComponent</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Suspense</span></span> <span class="token attr-name">fallback</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">'Loading tweets...'</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Tweets</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Suspense</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ClientComponent</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この場合、RSCストリームはどのように見えるでしょうか。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">M1:{&quot;id&quot;:&quot;./src/ClientComponent.client.js&quot;,&quot;chunks&quot;:[&quot;client1&quot;],&quot;name&quot;:&quot;&quot;}
S2:&quot;react.suspense&quot;
J0:[&quot;$&quot;,&quot;@1&quot;,null,{&quot;children&quot;:[[&quot;$&quot;,&quot;span&quot;,null,{&quot;children&quot;:&quot;Hello from server land&quot;}],[&quot;$&quot;,&quot;$2&quot;,null,{&quot;fallback&quot;:&quot;Loading tweets...&quot;,&quot;children&quot;:&quot;@3&quot;}]]}]
M4:{&quot;id&quot;:&quot;./src/Tweet.client.js&quot;,&quot;chunks&quot;:[&quot;client8&quot;],&quot;name&quot;:&quot;&quot;}
J3:[&quot;$&quot;,&quot;ul&quot;,null,{&quot;children&quot;:[[&quot;$&quot;,&quot;li&quot;,null,{&quot;children&quot;:[&quot;$&quot;,&quot;@4&quot;,null,{&quot;tweet&quot;:{...}}}]}],[&quot;$&quot;,&quot;li&quot;,null,{&quot;children&quot;:[&quot;$&quot;,&quot;@4&quot;,null,{&quot;tweet&quot;:{...}}}]}]]}]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">J0</code>行には新たな子が追加されています。
<code class="language-text">children</code>が参照<code class="language-text">@3</code>を指している新しい<code class="language-text">Suspense</code>境界です。
興味深いことに、この時点ではまだ<code class="language-text">@3</code>は定義されていません。
サーバはツイートの読み込みを完了すると、<code class="language-text">M4</code>と<code class="language-text">J3</code>の行を出力します。
前者は<code class="language-text">Tweet.client.js</code>コンポーネントへのモジュール参照を定義し、後者は<code class="language-text">@3</code>を置き換えるべき別のReact要素ツリーを定義します（ここでも、<code class="language-text">J3</code>のchildrenは<code class="language-text">M4</code>で定義された<code class="language-text">Tweet</code>コンポーネントを参照しています）。</p>
<p>バンドラーが<code class="language-text">ClientComponent</code>と<code class="language-text">Tweet</code>を二つの異なるバンドルに自動的に入れており、それによってブラウザが<code class="language-text">Tweet</code>バンドルのダウンロードを遅らせることができる点も、ここで述べておくべきでしょう。</p>
<h3>RSCフォーマットを使う<a name="12"></a></h3>
<p>このRSCストリームをブラウザ上で実際のReact要素に変換するにはどうすればよいのでしょうか。
<code class="language-text">react-server-dom-webpack</code>には、RSCレスポンスを用いてReact要素ツリーを再構築する<a href="https://github.com/facebook/react/blob/main/packages/react-server-dom-webpack/src/ReactFlightDOMClient.js">エントリーポイント</a>があります。
以下はルートクライアントコンポーネントを簡略化した例です。</p>
<div class="gatsby-highlight" data-language="jsx"><pre style="counter-reset: linenumber NaN" class="language-jsx line-numbers"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> createFromFetch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-server-dom-webpack'</span>
<span class="token keyword">function</span> <span class="token function">ClientRootComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// RSC API のエンドポイントから fetch() を実行します。</span>
  <span class="token comment">// react-server-dom-webpack はフェッチした結果を受け取り、</span>
  <span class="token comment">// React の要素ツリーを再構築することができます。</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token function">createFromFetch</span><span class="token punctuation">(</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/rsc?...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Suspense</span></span> <span class="token attr-name">fallback</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>response<span class="token punctuation">.</span><span class="token function">readRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">/* Returns a React element! */</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Suspense</span></span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">react-server-dom-webpack</code>に、APIエンドポイントからのRSCレスポンスを読むよう指示します。
次に、<code class="language-text">response.readRoot()</code>が、レスポンスストリームが処理されると更新されるReact要素を返します。
ストリームがまだ読まれる前に、直ちにPromiseがスローされます。
これは、まだコンテンツが用意できていないからです。
最初の<code class="language-text">J0</code>が処理されると、対応するReact要素ツリーが作成され、返されたPromiseが解決されます。
Reactはレンダリングを再開しますが、まだ準備ができていない<code class="language-text">@3</code>の参照に遭遇すると、新たなPromiseがスローされます。
そのPromiseは<code class="language-text">J3</code>を読んだ時点で解決され、Reactは再びレンダリングを開始し、今回は完了します。
したがって、RSCレスポンスをストリーミングしながら、Suspense境界によって定義されたチャンク単位で要素ツリーの更新とレンダリングを完了するまで継続します。</p>
<h3>単にプレーンHTMLを出力すればよいのでは？<a name="13"></a></h3>
<p>なぜ全く新しいワイヤーフォーマットを発明する必要があるのでしょうか。
クライアント側における目的は、React要素ツリーを再構築することです。
HTMLは、解析しなければReact要素を作成できないため、この目的はHTMLよりもこのフォーマットから行う方がずっと簡単に果たせます。
React要素ツリーを再構築することで、DOMへのコミットを最小限に留めつつReactツリーへのその後の変更をマージできるようになるため、これは重要なプロセスです。</p>
<h3>クライアントコンポーネントからデータを取得するだけよりもメリットがある？<a name="14"></a></h3>
<p>このコンテンツを取得するために、どちらにしてもサーバにAPIリクエストを送信する必要があるのであれば、現在のようにリクエストを送信してデータだけを取得し、クライアント側ですべてのレンダリングを行うよりも、RSCを使った方が本当によいのでしょうか。</p>
<p>最終的には、何をレンダリングして画面上に表示するのかによります。
RSCでは、ユーザに向けて表示されるコンテンツに直接マッピングされる、非正規化された「処理済み」のデータを受け取ります。
したがって、取得するデータの一部だけをレンダリングしたい場合や、レンダリング自体に大量のJavaScriptが必要なため、ブラウザへのダウンロードを避けたい場合はメリットがあります。
さらに、レンダリングを行うために複数回データを取得する必要があり、ウォーターフォールにおいてそれぞれ互いに依存し合う場合、ブラウザよりもデータのレイテンシがはるかに低いサーバ上でデータを取得した方がよいでしょう。</p>
<h3>サーバサイドレンダリングはどうなる？<a name="15"></a></h3>
<p>SSRがどうなるのか気になる方が多いのはよく分かります。
React 18ではSSRとRSCの併用が可能なため、サーバ上でHTMLを生成し、ブラウザ上でRSCを用いてHTMLをハイドレーションすることが可能です。
このテーマについてはまた別の機会に詳しく話したいと思います。</p>
<h2>サーバコンポーネントがレンダリングしているコンテンツのアップデート<a name="16"></a></h2>
<p>ある製品のページから別の製品のページに切り替えたい場合など、サーバコンポーネントに新しいコンテンツをレンダリングさせる必要がある場合はどうすればよいでしょうか。</p>
<p>この場合も、レンダリングはサーバ側で行われるため、新しいコンテンツをRSCワイヤーフォーマットで取得するためにはサーバに新たなAPIコールを行う必要があります。
よいニュースは、ブラウザが新しいコンテンツを受け取ると、クライアントコンポーネントにステートハンドラとイベントハンドラを保持しつつ、新しいReact要素ツリーを構築し、前のReactツリーとの差分を取るための通常の差分検出処理を行い、DOMに対する必要最小限のアップデートを判断できるという点です。
クライアントコンポーネントにとっては、このアップデートはすべてブラウザ上で行われた場合と比べても何ら違いがありません。</p>
<p>現時点では、Reactツリー全体をルートサーバコンポーネントから再レンダリングする必要がありますが、将来的にはこれをサブツリーに対して行えるようになるかもしれません。</p>
<h2>RSCにメタフレームワークを使うべき理由<a name="17"></a></h2>
<p>Reactチームは、RSCは当初プレーンなReactプロジェクトで直接使用するのではなく、Next.jsやShopify Hydrogenのように<a href="https://github.com/josephsavona/rfcs/blob/server-components/text/0000-server-components.md#adoption-strategy">メタフレームワーク経由での導入</a>を意図していると述べています。
これはなぜでしょうか。
メタフレームワークにはどのようなメリットがあるのでしょうか。</p>
<p>メタフレームワークの使用は必須ではありませんが、作業が楽になります。
メタフレームワークが提供するラッパーや抽象化は使いやすいため、サーバ上でRSCストリームを生成し、ブラウザ上で消費することを考える必要がありません。
また、メタフレームワークはサーバサイドレンダリングもサポートしており、サーバコンポーネントを使用している場合にサーバが生成したHTMLを適切にハイドレーションできるよう、必要な<a href="https://github.com/Shopify/hydrogen/issues/250">作業</a>を<a href="https://github.com/vercel/next.js/issues/30994">実施</a>しています。</p>
<p>上で説明したように、クライアントコンポーネントを適切に送信し、ブラウザ上で使用するためにはバンドラーの助けも必要です。
webpackインテグレーションはすでにあり、現在はShopifyが<a href="https://github.com/facebook/react/pull/22952">viteへのインテグレーション</a>に取り組んでいます。
RSCに必要なプラグインの多くはパブリックnpmパッケージとして公開されていないため、これらのプラグインはReactリポジトリの一部でなくてはいけません。
しかし、一度開発されれば、メタフレームワークなしでこれらのプラグインを使用できるようになるはずです。</p>
<h2>RSCは実用化の準備ができているのか？<a name="18"></a></h2>
<p>RSCは、現在<a href="https://nextjs.org/docs/advanced-features/react-18">Next.jsの実験的な機能</a>として提供されており、<a href="https://hydrogen.shopify.dev/">Shopify Hydrogenの現在の開発者プレビュー</a>段階にありますが、どちらもまだ本番環境で使用できる状態ではありません。
今後のブログ記事では、これらのフレームワークがそれぞれRSCをどのように使用しているのか詳しく説明したいと思います。</p>
<p>しかし、RSCが今後のReactを大きく左右する存在であることは間違いありません。RSCは、ページの読み込み速度向上、JavaScriptバンドルの軽量化、Time To Interactive（TTI）の短縮という課題に対するReactの答えであり、Reactを使用して複数ページのアプリケーションを構築する方法に関するより包括的なテーゼです。未完成ではあるものの、注目すべき時が近づいています。</p>
<p><em>この記事の草案をレビューしてくれた<a href="https://twitter.com/Nutlope">Hassan</a>と<a href="https://twitter.com/jplhomer">Josh</a>に感謝します。</em></p>]]></content:encoded></item><item><title><![CDATA[tscをGoに移植]]></title><description><![CDATA[筆者はTypeScript型チェッカーtscをRustではなく、Goに移植しようと思います。拡張可能なRustプラットフォームSWCの作者の発言としては、奇妙に聞こえるかもしれません。理由を説明した…]]></description><link>https://postd.cc/tsc-go/</link><guid isPermaLink="false">https://postd.cc/tsc-go/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[TypeScript]]></category><category><![CDATA[Go言語]]></category><category><![CDATA[tsc]]></category><category><![CDATA[SWC]]></category><pubDate>Mon, 13 Jun 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>筆者はTypeScript型チェッカー<strong>tsc</strong>をRustではなく、Goに移植しようと思います。拡張可能なRustプラットフォーム<a href="https://swc.rs/">SWC</a>の作者の発言としては、奇妙に聞こえるかもしれません。理由を説明したいと思います。</p>
<h2>なぜtscを移植するのか</h2>
<p>TypeScriptの普及が進むにつれて、大規模プロジェクトではあるジレンマに直面しています。<strong>型チェックは、ワークフローの中で最も時間がかかるプロセスの一つになっているのです</strong>。開発者は、イテレーションのサイクルを遅らせることなく、型安全を保証することを望んでいます。
<strong>tsc</strong>（TypeScript Compiler）は、型の妥当性をチェックし、コードをJavaScriptにコンパイルします。コードの量が多いほど、コンパイルには時間がかかります。中規模から大規模のTypeScriptプロジェクトでは、このコンパイルに膨大な時間がかかります。開発者はワークフローのトランスパイル部分をSWCに置き換えることができますが、それでも型チェックはボトルネックとなっています。</p>
<h2>型チェッカーとは何か</h2>
<p>型チェッカーは、実行前にプログラムを検証し、関数呼び出しや変数割り当ての値が正しいことを確認します。また、いたるところで型を指定することがないよう、可能な限り変数の型を推測します。型チェックは、自信を持って開発を行い、エラーをなくし、大規模なコードベースのリファクタリングをよりスムーズに行うことを可能にします。</p>
<h2>なぜRustではないのか</h2>
<p>筆者は<strong>tsc</strong>をRustで書き直そうと試みました。最初はサイドプロジェクトとして取り組み、大いに楽しみました。<strong>tsc</strong>のソースコードを見ずに型チェックのロジックを作り直す作業を開始しました。
筆者が書き直したRust版の初期テストでは、<strong>型チェックのスピードがtscの62倍に改善されていました</strong>。SWCとtscのコンパイル時間を測定するため、公式TypeScriptコンパイラの<strong>コンフォーマンス（適合性）</strong>テストスイートを使用しました。結果は以下の通りです（8スレッド使用）：</p>
<ul>
<li><strong>tsc</strong>：133.2秒</li>
<li>Rustリライト版：<strong>2.13秒（62倍速い）</strong></li>
</ul>
<p>最終的に、<strong>tsc</strong>のような巨大プロジェクトを書き直すのは、継続するのが極めて難しいことを悟りました。しかし、パフォーマンスの向上はかなりのものだったため、別の方法として完全なリライトではなく移植を試してみることにしたのです。そこで、TypeScriptのソースコードを見始めました。
<strong>tsc</strong>は共有の可変性を多く使い、<a href="https://en.wikipedia.org/wiki/Garbage_collection_(computer_science)">ガベージコレクション</a>に依存する部分が多くあります。筆者はRustの支持者であり、信者ですが、このプロジェクトに合ったツールではないと感じます。このプロジェクトでRustを使用するには、<a href="https://doc.rust-lang.org/std/keyword.unsafe.html">unsafe</a>を使用しなければならない場面が多すぎました。
<strong>tsc</strong>は共有の可変性に依存しており、周期的な可変参照を持っています。Rustはこの挙動を防ぐよう設計されています。同じデータに対し二つの参照を持つこと（共有の可変性）は、Rustでは定義されていない挙動です。
どの言語を選ぶかは、好みではなく作業によって決めるべきです。筆者はRustを好みますが、このプロジェクトのためにGoとZigを試し、Goを使うことにしました。</p>
<h2>オープンソース化するのか</h2>
<p><strong>tsc</strong>をGoに移植する作業は、Vercelがスポンサーとして資金を提供しています。将来的にはオープンソース化する予定です。この新バージョンの<strong>tsc</strong>をSWCとともに使用するためのブリッジも作成します。
型チェックのサポートを得て、SWCはJavaScriptとTypeScriptのツールチェーン全体のパフォーマンス向上に取り組んでいます。</p>
<ul>
<li>✅トランスパイル（Babelの代替）</li>
<li>🚧型チェック（<strong>tsc</strong>の代替）</li>
<li>🚧最小化（Terserの代替）</li>
<li>🚧バンドリング（webpackの代替）</li>
</ul>
<p>プロジェクトの最新情報については、<a href="https://twitter.com/kdy1dev">Twitterをフォローしてください</a>。</p>]]></content:encoded></item><item><title><![CDATA[Next.jsアプリのローカライゼーション]]></title><description><![CDATA[クイックサマリー ‐ 国際化ルーティングは、厳密にはNext.jsの新機能ではありません。（v.10以降搭載されています。）この記事では、この機能のメリットだけではなく、こうした機能を利用して最高の…]]></description><link>https://postd.cc/localizing-your-nextjs-app/</link><guid isPermaLink="false">https://postd.cc/localizing-your-nextjs-app/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[Next.js]]></category><category><![CDATA[UX]]></category><pubDate>Mon, 16 May 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>クイックサマリー ‐ 国際化ルーティングは、厳密にはNext.jsの新機能ではありません。（<a href="https://nextjs.org/blog/next-10">v.10</a>以降搭載されています。）この記事では、この機能のメリットだけではなく、こうした機能を利用して最高のユーザ体験と円滑な開発者体験を実現する方法についても見ていきます。自己文書化コードやバンドルサイズの削減、さらにはランタイムエラーではなくコンパイル時エラーに興味のある方は、是非このまま読み進めてください。
開発中のアプリにおいて、ロケール（または国、あるいは両方）ごとにルートを設定したい場合、Next.jsで簡単に対応できるようになりました。プロジェクトのrootディレクトリにnext.config.jsがない場合、新たに作成してください。このスニペットからコピーしても構いません。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">/** @type {import('next').NextConfig} */</span>
 
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  reactStrictMode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  i18n<span class="token operator">:</span> <span class="token punctuation">{</span>
    locales<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'en'</span><span class="token punctuation">,</span> <span class="token string">'gc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    defaultLocale<span class="token operator">:</span> <span class="token string">'en'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><em>注記：1行目はTSサーバ（TypeScriptプロジェクトに参画している場合、またはVSCodeを使用している場合）を許可するためのもので、構成オブジェクトでサポートされる属性です。必須ではありませんが良い機能です。</em></p>
<p><code class="language-text">i18n</code>オブジェクトの中にプロパティが2つあります。</p>
<ul>
<li><code class="language-text">locales</code>
開発中のアプリがサポートする全ロケールのリスト。文字列の配列。</li>
<li><code class="language-text">defaultLocale</code>
メインrootのロケール。ユーザ設定がない場合やrootが強制的に設定される場合のデフォルト設定。</li>
</ul>
<p>これらのプロパティ値がルートを決定するため、あまり凝りすぎない方が良いでしょう。<a href="https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes">ロケールコード</a>や<a href="https://en.wikipedia.org/wiki/List_of_ISO_3166_country_codes">国コード</a>を使用して有効な属性値を作成し、すぐに<code class="language-text">url</code>が作成されるため小文字を使用しましょう。</p>
<p>アプリが複数のロケールに対応したら、Next.jsで認識しておくべきことが最後に1つあります。全てのロケールに全てのルートが存在し、これらが同一であることをフレームワークは認識しています。特定のロケールに移動したい場合、Linkコンポーネントに<code class="language-text">locale props</code>を設定する必要があります。これを行わないと、ブラウザの<code class="language-text">Accept-Language</code>ヘッダに基づきデフォルトに戻ります。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span> <span class="token attr-name">locale</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>de<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">&lt;a>Home page in German</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Link</span></span><span class="token punctuation">></span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>最終的には、ユーザが選択したロケールに従い、適切なルートに転送するアンカーを記述するのが良いでしょう。これは、Next.jsから<code class="language-text">useRouter</code>カスタムフックを使用することで容易に行うことができ、objectが返され、選択した<code class="language-text">locale</code>が<code class="language-text">key</code>となります。</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> <span class="token constant">FC</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">'next/link'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/router'</span>

<span class="token keyword">const</span> Anchor<span class="token operator">:</span> <span class="token constant">FC</span><span class="token operator">&lt;</span><span class="token punctuation">{</span> href<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> href<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> locale <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Link href<span class="token operator">=</span><span class="token punctuation">{</span>href<span class="token punctuation">}</span> locale<span class="token operator">=</span><span class="token punctuation">{</span>locale<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>a<span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Next.jsはこれで国際化の準備が整い、以下を行うようになります。</p>
<ul>
<li>Next.jsの機能を使用し、リクエストの<code class="language-text">Accepted-Languages</code>ヘッダからユーザが指定したロケールを取得する</li>
<li>上で作成した<code class="language-text">Anchor</code>コンポーネントを使用し、ユーザが指定したルートに常にユーザを転送する</li>
<li>必要に応じてデフォルト言語に戻る</li>
</ul>
<p>最後に行うべきことは、翻訳を確実に扱えるようにすることです。現時点では、ルーティングは問題なく機能しているものの、各ページのコンテンツを調整する方法がありません。</p>
<h2>ディクショナリの作成</h2>
<p>翻訳管理サービスを使用している場合でも、他の方法でテキストを入手している場合でも、最終的に欲しいのはJavaScriptがランタイム中に処理するJSONオブジェクトです。Next.jsは3つの異なるランタイムを提供します。</p>
<ul>
<li>クライアントサイド</li>
<li>サーバサイド</li>
<li>コンパイル時</li>
</ul>
<p>これについては一旦置いておきましょう。まずはデータを構造化する必要があります。</p>
<p>翻訳の対象となるデータは、周辺のツールに応じてさまざまな形態を取りますが、最終的にはロケール、キー、値に絞られます。したがって、まずはこれらから見ていきます。筆者のロケールは、英語の<code class="language-text">en</code>とポルトガル語の<code class="language-text">pt</code>です。</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  en<span class="token operator">:</span> <span class="token punctuation">{</span>
    hello<span class="token operator">:</span> <span class="token string">'hello world'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  pt<span class="token operator">:</span> <span class="token punctuation">{</span>
    hello<span class="token operator">:</span> <span class="token string">'oi mundo'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>翻訳カスタムフック</h2>
<p>ロケールが決まったら、次は翻訳カスタムフックを作成します。</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/router'</span>
<span class="token keyword">import</span> dictionary <span class="token keyword">from</span> <span class="token string">'./dictionary'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useTranslation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> locales <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> defaultLocale<span class="token punctuation">,</span> <span class="token operator">...</span>nextRouter<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> locale <span class="token operator">=</span> locales<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>nextRouter<span class="token punctuation">.</span>locale <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token operator">?</span> nextRouter<span class="token punctuation">.</span>locale
    <span class="token operator">:</span> defaultLocale
  
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">translate</span><span class="token operator">:</span> <span class="token punctuation">(</span>term<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> translation <span class="token operator">=</span> dictionary<span class="token punctuation">[</span>locale<span class="token punctuation">]</span><span class="token punctuation">[</span>term<span class="token punctuation">]</span>

      <span class="token keyword">return</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>translation<span class="token punctuation">)</span> <span class="token operator">?</span> translation <span class="token operator">:</span> term
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>上の内容を細かく見ていきましょう。</p>
<ol>
<li><code class="language-text">useRouter</code>は、利用可能な全ロケール、デフォルトのロケール、現在のロケールを取得するために使用します。</li>
<li>これらを取得したら、有効なロケールがあるかを確認し、なければデフォルトのロケールにフォールバックします。</li>
<li>次に、<code class="language-text">translate</code>メソッドを返します。<code class="language-text">term</code>とディクショナリからのフェッチを指定されたロケールに届けます。値がない場合、再度翻訳<code class="language-text">term</code>を返します。</li>
</ol>
<p>これで、Next.jsアプリは少なくとも一般的で初歩的なケースを翻訳する準備が整いました。ここでは完璧な翻訳ライブラリを構築しようとしているわけではありません。我々のカスタムフックには、挿入句、複数形、性別などの<strong>重要な要素が多数</strong>欠けています。</p>
<h2>スケーリングの時間</h2>
<p>カスタムフックの要素の欠如は、直ちに必要でなければ許容できます。実際に必要になってから実装することはいつでも可能であり、その方が良い場合もあります。しかし、現行の戦略において懸念される根本的問題が1つあります。それは、Next.jsの同型要素を活用していないことです。</p>
<p>ローカライズされたアプリの規模拡大において最も好ましくないのは、翻訳作業そのものを管理しないことです。これまでに何度も起こっていることなので、ある程度は予測できます。問題は、ブラウザに送信される無数のディクショナリの肥大化に対処することであり、ディクショナリはアプリで対応が求められる言語数とともに増えていく一方です。これは、エンドユーザにとって使い物にならないデータとなることが多く、言語を切り替える際に新しいキーや値をフェッチする必要がある場合にパフォーマンスに影響を及ぼします。ユーザ体験について1つの大きな真理があるとしたら、それは、ユーザの行動を全て予期することはできないということです。</p>
<p>ユーザが言語を切り替えるのか、いつ切り替えるのか、追加のキーを必要とするのか、いつ必要なのかを予想することはできません。理想を言えば、特定のルートにデータが読み込まれたときに、アプリに全ての翻訳が用意されていることがベストです。現時点では、ページのレンダリング結果と状態の考え得るバリエーションに基づき、ディクショナリのチャンクを分割する必要があります。非常に気の遠くなるような話です。</p>
<h2>サーバサイド・プリレンダリング</h2>
<p>では、拡張性に関する新規要件を整理しましょう。</p>
<ol>
<li>クライアントサイドに送るデータは最小限に留める</li>
<li>ユーザインタラクションに基づく追加のリクエストは避ける</li>
<li>既に翻訳済みの最初のレンダリングをユーザに送る</li>
</ol>
<p>Next.jsページの<code class="language-text">getStaticProps</code>メソッドのお陰で、コンパイラの構成に一切踏み込むことなくこれを実現できます。この特殊なサーバレス関数にディクショナリ全体をインポートし、各キーの翻訳を保持する特殊オブジェクトのリストをページに送ります。</p>
<h2>SSR翻訳の設定</h2>
<p>アプリに話を戻しますが、新しいメソッドを作成します。<code class="language-text">/utils</code>や<code class="language-text">/helpers</code>といったディレクトリを設定し、その中のどこかに以下を置きます。</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ssrI18n</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dictionary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>dictionary<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>keySet<span class="token punctuation">,</span> locale<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      keySet<span class="token punctuation">[</span>locale<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>dictionary<span class="token punctuation">[</span>locale <span class="token keyword">as</span> <span class="token keyword">keyof</span> <span class="token keyword">typeof</span> dictionary<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> keySet
    <span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>細かく見ていきましょう。</p>
<ol>
<li>翻訳<code class="language-text">key</code>または<code class="language-text">term</code>と<code class="language-text">dictionary</code>を取得する</li>
<li><code class="language-text">dictionary</code>オブジェクトをその<code class="language-text">key</code>の配列に変換する</li>
<li>ディクショナリの各キーは<code class="language-text">locale</code>であるため、<code class="language-text">key</code>の名前を用いてオブジェクトを作成し、各<code class="language-text">locale</code>はその特定の言語の値となります。</li>
</ol>
<p>そのメソッドの出力例は以下のような形になります。</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset: linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token punctuation">{</span>
  <span class="token string">'hello'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'en'</span><span class="token operator">:</span> <span class="token string">'Hello World'</span><span class="token punctuation">,</span>
    <span class="token string">'pt'</span><span class="token operator">:</span> <span class="token string">'Oi Mundo'</span><span class="token punctuation">,</span>
    <span class="token string">'de'</span><span class="token operator">:</span> <span class="token string">'Hallo Welt'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>では、Next.jsページに移動しましょう。</p>
<div class="gatsby-highlight" data-language="tsx"><pre style="counter-reset: linenumber NaN" class="language-tsx line-numbers"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ssrI18n <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/ssrI18n'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">DICTIONARY</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../dictionary'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'next/router'</span>

<span class="token keyword">const</span> <span class="token function-variable function">Home</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> hello <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> i18nLocale <span class="token operator">=</span> <span class="token function">getLocale</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>hello<span class="token punctuation">[</span>i18nLocale<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getStaticProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    hello<span class="token operator">:</span> <span class="token function">ssrI18n</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token constant">DICTIONARY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// add another entry to each translation key</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで終わりです！ページには各言語で必要な翻訳しか送られません。逆に、途中で言語を切り替えても外部にリクエストは送られないため、非常に迅速です。</p>
<h2>設定を全て省略する</h2>
<p>このままでも十分素晴らしいですが、まだまだ改善の余地があります。開発者の皆さん注目です。ブートストラップが多く使われているにもかかわらず、依然としてタイプミスがないことを前提としています。翻訳されたアプリを使用したことのある人なら、タイプミスを含むキーがどこかに紛れ込んでいるものだということをご存じでしょう。したがって、TypeScriptによる安全なタイピングを翻訳手法にもたらすことができます。
この設定を省略し、TypeScriptの安全性と自動補完を手に入れるには、<a href="https://github.com/atilafassina/next-g11n">next-g11n</a>を使用できます。これは、上記で行ったのと全く同じことを行う小さなライブラリですが、型といくつかのオプション機能が追加されます。</p>
<h2>まとめ</h2>
<p>この記事が、<a href="https://nextjs.org/docs/advanced-features/i18n-routing">Next.jsの国際化ルーティング</a>がグローバル化に向けてアプリにどのようなメリットをもたらし、現在のWebにおけるローカライズされたアプリで最高のユーザ体験を提供するということが何を意味するのかについて、知見を深める一助となれば幸いです。是非以下のコメント欄からご意見やご感想をお聞かせください。<a href="https://atila.io/twitter">ツイート</a>も歓迎いたします。</p>]]></content:encoded></item><item><title><![CDATA[あまり知られていないPostgreSQLの機能]]></title><description><![CDATA[あなたが知らない既存機能があるかもしれません！ マイクロソフト社は2006年、Microsoft Officeの新バージョンで追加してほしい機能について、顧客調査を実施しました。驚いたことに、ユーザ…]]></description><link>https://postd.cc/postgresql-unknown-features/</link><guid isPermaLink="false">https://postd.cc/postgresql-unknown-features/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[PostgreSQL]]></category><pubDate>Mon, 18 Apr 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<style>
    .toc-for-article {
        clear: both;
        box-shadow: 0 9px 30px -5px rgb(50 50 83 / 25%), 0 8px 8px -12px rgb(0 0 0 / 20%), 0 -6px 16px -6px rgb(0 0 0 / 3%);
        border-radius: 11px;
        padding: 2em;
        background-color: #fff;
        margin: 1.25em 0 3em;
        columns: 2;

    }
</style>
<p>あなたが知らない既存機能があるかもしれません！</p>
<p>マイクロソフト社は2006年、Microsoft Officeの新バージョンで追加してほしい機能について、顧客調査を実施しました。驚いたことに、ユーザが希望した機能の90%以上はすでに実装されており、その存在が知られていないだけであることが判明しました。機能の「見つけにくさ」の問題の解決策として同社が考案したのが、現在のMicrosoft Office製品でおなじみの「リボンUI」です。</p>
<p>この問題はOfficeに限ったものではありません。日々使用するツールの機能をすべて把握している人はほとんどいません。PostgreSQLのように大規模なツールであればなおさらです。数週間前にPostgreSQL 14がリリースされたばかりなので、この機会にPostgreSQLのあまり知られていない機能に注目してみたいと思います。</p>
<p><strong>この記事では、PostgreSQLのあまり知られていない機能を紹介します。</strong></p>
<div style="margin: 0 auto; text-align: center;">
<img src="https://hakibenita.com/images/00-postgresql-unknown-features.png" style="height: 350px; width: 270px;">
<br>Illustration by <a href="https://www.instagram.com/_wrightdesign/">Eleanor Wright</a>
</div>
<h3>目次</h3>
<ul class="toc-for-article">
    <li><a href="#01">UPSERTにおいて更新、挿入された行数の取得</a></li>
    <li><a href="#02">特定の列の権限付与</a></li>
    <li><a href="#03">複数パターンに対するマッチング</a></li>
    <li><a href="#04">シーケンスを進めることなく現在値を確認する</a></li>
    <li><a href="#05">複数行のSQLで\COPYを使用する</a></li>
    <li><a href="#06">自動生成キーの値の設定を防ぐ</a></li>
    <li><a href="#07">ピボットテーブルを作成するもう2つの方法</a></li>
    <li><a href="#08">ドル引用</a></li>
    <li><a href="#09">データベースオブジェクトに関するコメント</a></li>
    <li><a href="#10">データベースごとに個別の履歴ファイルを維持する</a></li>
    <li><a href="#11">大文字の予約語の自動補完</a></li>
    <li><a href="#12">スリープ時間の指定</a></li>
    <li><a href="#13">サブクエリを使用せず、グループの最初または最後の行を取得する</a></li>
    <li><a href="#14">拡張機能なしでUUIDを生成する</a></li>
    <li><a href="#15">再現可能なランダムデータの生成</a></li>
    <li><a href="#16">直ちに検証することなく制約を追加する</a></li>
    <li><a href="#17">PostgreSQLにおけるシノニム</a></li>
    <li><a href="#18">重複レンジを探す</a></li>
</ul>
<h2>UPSERTにおいて更新、挿入された行数の取得 <a name="01"></a></h2>
<p>INSERT ON CONFLICTは、Extract(抽出) Transform(変換) Load(読み込み) プロセスでは特に便利なコマンドであり、Oracleの「MERGE」に相当し、「UPSERT」（UPDATEとINSERTを組み合わせた造語）とも呼ばれます。INSERT文のON CONFLICT句を使用することで、キー列に重複がある場合の処理をデータベースに指示できます。</p>
<p>以下は従業員テーブルのデータを同期するためのクエリの例です。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">WITH</span> new_employees <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'George'</span><span class="token punctuation">,</span> <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Manager'</span><span class="token punctuation">,</span>   <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Jane'</span><span class="token punctuation">,</span>   <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Developer'</span><span class="token punctuation">,</span> <span class="token number">1200</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
         <span class="token keyword">name</span><span class="token punctuation">,</span>      department<span class="token punctuation">,</span> role<span class="token punctuation">,</span>       salary
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token punctuation">(</span><span class="token keyword">name</span><span class="token punctuation">,</span> department<span class="token punctuation">,</span> role<span class="token punctuation">,</span> salary<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">name</span><span class="token punctuation">,</span> department<span class="token punctuation">,</span> role<span class="token punctuation">,</span> salary
<span class="token keyword">FROM</span> new_employees
<span class="token keyword">ON</span> CONFLICT <span class="token punctuation">(</span><span class="token keyword">name</span><span class="token punctuation">)</span> <span class="token keyword">DO</span> <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span>
    department <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>department<span class="token punctuation">,</span>
    role <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>role<span class="token punctuation">,</span>
    salary <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>salary
<span class="token keyword">RETURNING</span> <span class="token operator">*</span><span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ department │   role    │ salary
────────┼────────────┼───────────┼────────
 George │ Sales      │ Manager   │   <span class="token number">1000</span>
 Jane   │ R<span class="token operator">&amp;</span>D        │ Developer │   <span class="token number">1200</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このクエリは、新しい従業員データをテーブルに挿入します。追加しようとした従業員の名前がすでに存在する場合、データを挿入する代わりにその行が更新されます。</p>
<div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>RETURNING *</h5></div><div class="admonition-content"><p><a href="https://hakibenita.com/sql-tricks-application-dba#implement-complete-processes-using-with-and-returning">WITHとRETURNINGを使用して完全なプロセスを実行する方法</a>はこちらをご覧ください。</p></div></div>
<p>上記コマンドの出力INSERT 0 2から、影響のある従業員が2名いることが分かります。では、挿入された行数と更新された行数はいくつでしょうか。この出力からは判断できません。</p>
<p>筆者が同様のクエリを使用したETLプロセスのロギングを改善する方法を探していた際、<a href="https://stackoverflow.com/a/39204667/2000875">Stack Overflowで投稿された質問に対する回答</a>に、これと全く同じ問題に対する有効な解決策を偶然見つけました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">WITH</span> new_employees <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'George'</span><span class="token punctuation">,</span> <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Manager'</span><span class="token punctuation">,</span>   <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Jane'</span><span class="token punctuation">,</span>   <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Developer'</span><span class="token punctuation">,</span> <span class="token number">1200</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
         <span class="token keyword">name</span><span class="token punctuation">,</span>      department<span class="token punctuation">,</span> role<span class="token punctuation">,</span>       salary
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token punctuation">(</span><span class="token keyword">name</span><span class="token punctuation">,</span> department<span class="token punctuation">,</span> role<span class="token punctuation">,</span> salary<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">name</span><span class="token punctuation">,</span> department<span class="token punctuation">,</span> role<span class="token punctuation">,</span> salary
<span class="token keyword">FROM</span> new_employees
<span class="token keyword">ON</span> CONFLICT <span class="token punctuation">(</span><span class="token keyword">name</span><span class="token punctuation">)</span> <span class="token keyword">DO</span> <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span>
    department <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>department<span class="token punctuation">,</span>
    role <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>role<span class="token punctuation">,</span>
    salary <span class="token operator">=</span> EXCLUDED<span class="token punctuation">.</span>salary
<span class="token keyword">RETURNING</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>xmax <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> inserted<span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ department │   role    │ salary │ inserted
────────┼────────────┼───────────┼────────┼──────────
 Jane   │ R<span class="token operator">&amp;</span>D        │ Developer │   <span class="token number">1200</span> │ t
 George │ Sales      │ Manager   │   <span class="token number">1000</span> │ f
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>RETURNING句の違いに注目してください。こちらの例では、xmaxという特殊な列を使用して挿入された行数を計算するinsertedという計算済みフィールドが含まれています。コマンドによって返されたデータから、「Jane」の行が新たに挿入されたものの、「George」はすでにテーブルに存在したため、その行は更新されたことが分かります。</p>
<p>xmax列は、<a href="https://www.postgresql.org/docs/current/ddl-system-columns.html">特殊なシステム列</a>です。</p>
<p>削除トランザクションの識別情報（トランザクションID）です。削除されていない行ではゼロです。
PostgreSQLでは、行が更新されると古いバージョンが削除され、xmaxに削除トランザクションのIDが保持されます。行が挿入されると、古い行の削除は行われないため、xmaxの値は0になります。この解決策では、この挙動を賢く利用して更新された行と挿入された行を区別しています。</p>
<hr>
<h2>特定の列の権限付与 <a name="02"></a></h2>
<p>認証情報、パスワード、個人を特定できる情報などのセンシティブ情報を含むユーザテーブルがあるとします。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">,</span>
    username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    personal_id <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    password_hash <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'haki'</span><span class="token punctuation">,</span> <span class="token string">'12222227'</span><span class="token punctuation">,</span> <span class="token string">'super-secret-hash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">1</span> <span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このテーブルは、アナリストなど組織内のさまざまな人が、データにアクセスして随時レポートを作成するために使用します。アナリストにアクセスを許可するため、データベースに特別ユーザを追加します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">USER</span> analyst<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span>

db<span class="token operator">=</span># <span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> users <span class="token keyword">TO</span> analyst<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>現在、データベース「db」にユーザ「analyst」として接続されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \<span class="token keyword">connect</span> db analyst
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"analyst"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
 id │ username │ personal_id │   password_hash
────┼──────────┼─────────────┼───────────────────
  <span class="token number">1</span> │ haki     │ <span class="token number">12222227</span>    │ super<span class="token operator">-</span>secret<span class="token operator">-</span><span class="token keyword">hash</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>前に述べたように、アナリストはレポートを作成し、分析を行うためにユーザデータにアクセスしますが、センシティブ情報や個人を特定できる情報にアクセスできることは望ましくありません。</p>
<p>ユーザがテーブル内でアクセスできるデータを詳細に制御するため、PostgreSQLでは特定の列のみを対象に権限を付与できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \<span class="token keyword">connect</span> db postgres
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"postgres"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">REVOKE</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> users <span class="token keyword">FROM</span> analyst<span class="token punctuation">;</span>
<span class="token keyword">REVOKE</span>

db<span class="token operator">=</span># <span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">)</span> <span class="token keyword">ON</span> users <span class="token keyword">TO</span> analyst<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>テーブル上の既存の選択権限を取り消した後、id列とusername列のみを対象として、analystに選択権限を付与しました。これで、analystはこれら以外の列にはアクセスできなくなります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \<span class="token keyword">connect</span> db analyst
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"analyst"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
ERROR:  permission denied <span class="token keyword">for</span> <span class="token keyword">table</span> users

db<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> personal_id <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
ERROR:  permission denied <span class="token keyword">for</span> <span class="token keyword">table</span> users

db<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> username <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
 id │ username
────┼──────────
  <span class="token number">1</span> │ haki</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ユーザ「analyst」が制限された列に明示的、あるいは「*」を使用して黙示的にアクセスしようとすると、「permission denied」エラーが返されます。</p>
<hr>
<h2>複数パターンに対するマッチング <a name="03"></a></h2>
<p>SQLでは、パターンマッチングをよく使用します。以下は「gmail.com」のメールアカウントを保有するユーザを検索するクエリの例です。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> email <span class="token operator">LIKE</span> <span class="token string">'%@gmail.com'</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>このクエリは、ワイルドカード「%」を使用し、メールアドレスが「@gmail.com」で終わるユーザを検索します。では、同じクエリの中で「yahoo.com」のメールアカウントを保有するユーザも検索したい場合はどうすればよいでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span>
    email <span class="token operator">LIKE</span> <span class="token string">'%@gmail.com'</span>
    <span class="token operator">OR</span> email <span class="token operator">LIKE</span> <span class="token string">'%@yahoo.com'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>いずれかのパターンに対するマッチングを行うには、OR条件を指定する方法があります。しかし、PostgreSQLでは、複数パターンに対してマッチングを行う方法は他にもあります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> email SIMILAR <span class="token keyword">TO</span> <span class="token string">'%@gmail.com|%@yahoo.com'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p><a href="https://www.postgresql.org/docs/current/functions-matching.html#FUNCTIONS-SIMILARTO-REGEXP">SIMILAR TO</a>演算子を使用することで、単純なクエリにより複数パターンとのマッチングを行うことができます。</p>
<p>regexpを使用して複数パターンとのマッチングを行う方法もあります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> email <span class="token operator">~</span> <span class="token string">'@gmail\.com$|@yahoo\.com$'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>regexpを使用する際には注意が必要です。ピリオド（.）は任意の文字にマッチするため、gmail.comやyahoo.comに含まれるピリオドとマッチングするには、「.」のようにエスケープ文字を追加する必要があります。</p>
<p>筆者がこの情報を<a href="https://twitter.com/be_haki/status/1435859174538293248?s=20">Twitterに</a>投稿したところ、いくつかの興味深い反応が得られました。Pythonに対応したPostgreSQLドライバであるpsycopgの公式アカウントから届いた<a href="https://twitter.com/psycopg/status/1435926642388516866?s=20">コメント</a>は、別の方法を提案しました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> email <span class="token operator">~</span> <span class="token keyword">ANY</span><span class="token punctuation">(</span><span class="token keyword">ARRAY</span><span class="token punctuation">[</span><span class="token string">'@gmail\.com$'</span><span class="token punctuation">,</span> <span class="token string">'@yahoo\.com$'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>このクエリでは、ANY演算子を使用してさまざまなパターンに対してマッチングを行います。メールアドレスがいずれかのパターンにマッチすれば、条件は真となります。このアプローチは、Pythonなどのホスト言語から行うとやりやすいでしょう。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">with</span> connection<span class="token punctuation">.</span><span class="token keyword">cursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">cursor</span>:
    <span class="token keyword">cursor</span><span class="token punctuation">.</span><span class="token keyword">execute</span><span class="token punctuation">(</span><span class="token string">'''
        SELECT *
        FROM users
        WHERE email ~ ANY(ARRAY%(patterns)s)
    '''</span> <span class="token operator">%</span> {
        <span class="token string">'patterns'</span>: <span class="token punctuation">[</span>
            <span class="token string">'@gmail\.com$'</span><span class="token punctuation">,</span>
            <span class="token string">'@yahoo\.com$'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    }<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>SIMILAR TO演算子を用いた前述のアプローチとは異なり、ANY演算子を使用すればパターンのリストを変数に結合できます。</p>
<hr>
<h2>シーケンスを進めることなく現在値を確認する <a name="04"></a></h2>
<p>シーケンスの現在値を確認する必要がある場合、おそらく最初に<a href="https://www.postgresql.org/docs/current/functions-sequence.html">currval</a>を使用するでしょう。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> currval<span class="token punctuation">(</span><span class="token string">'sale_id_seq'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR:  currval <span class="token keyword">of</span> <span class="token keyword">sequence</span> <span class="token string">"sale_id_seq"</span> <span class="token operator">is</span> <span class="token operator">not</span> yet defined <span class="token operator">in</span> this <span class="token keyword">session</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>その場合、筆者と同じように、currvalはシーケンスが現在のセッションで定義または使用されていなければ使えないことに気付くと思います。特に理由もなくシーケンスを進めることは通常避けたいため、これは好ましい解決策ではありません。</p>
<p>PostgreSQL 10では、シーケンスに関する情報に容易にアクセスできるよう、<a href="https://www.postgresql.org/docs/current/view-pg-sequences.html">pg_sequences</a>ビューが追加されました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> pg_sequences <span class="token keyword">WHERE</span> sequencename <span class="token operator">=</span> <span class="token string">'sale_id_seq'</span><span class="token punctuation">;</span>
─<span class="token punctuation">[</span> <span class="token keyword">RECORD</span> <span class="token number">1</span> <span class="token punctuation">]</span>─┬────────────
schemaname    │ <span class="token keyword">public</span>
sequencename  │ sale_id_seq
sequenceowner │ db
data_type     │ <span class="token keyword">integer</span>
start_value   │ <span class="token number">1</span>
min_value     │ <span class="token number">1</span>
max_value     │ <span class="token number">2147483647</span>
increment_by  │ <span class="token number">1</span>
<span class="token keyword">cycle</span>         │ f
cache_size    │ <span class="token number">1</span>
last_value    │ <span class="token number">155</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このテーブルでも現在値は確認できますが、これは「あまり知られていない機能」というよりも、情報スキーマにおけるテーブルの1つに過ぎません。</p>
<p>ドキュメントには記載されていないのですが、pg<em>sequence</em>last_valueという関数を使用してシーケンスの現在値を確認する方法もあります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> pg_sequence_last_value<span class="token punctuation">(</span><span class="token string">'sale_id_seq'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pg_sequence_last_value
────────────────────────
                   <span class="token number">155</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>なぜこの関数がドキュメントに記載されていないのかは定かではありませんが、筆者が確認したところ、<a href="https://www.postgresql.org/search/?u=%2Fdocs%2F14%2F&#x26;q=pg_sequence_last_value">公式ドキュメント</a>の中では言及されていませんでした。使用する場合はその点も考慮してください。</p>
<p>興味深いことに、このテーマについて調査をしているとき、テーブルと同じようにシーケンスもクエリできることを発見しました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sale_id_seq<span class="token punctuation">;</span>

 last_value │ log_cnt │ is_called
────────────┼─────────┼───────────
        <span class="token number">155</span> │      <span class="token number">10</span> │ t</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>PostgreSQLでは他にどのような種類のオブジェクトをクエリでき、どのような値が返されるのか気になるところです。</p>
<p>注意すべき点として、この機能はシーケンスを大まかに確認するためだけに使用してください。この出力の値をもとにIDの更新を試みるべきではありません。IDを更新したい場合はnextvalを使用してください。</p>
<hr>
<h2>複数行のSQLで\COPYを使用する <a name="05"></a></h2>
<p>psqlを頻繁に使用する人は、データベースからデータをエクスポートするために\COPYをかなりの頻度で使用しているのではないでしょうか。筆者は頻繁に使用しています。\COPYに関する不満点の1つは、複数行のクエリに対応していないことです。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \COPY <span class="token punctuation">(</span>
\copy: parse error <span class="token keyword">at</span> <span class="token keyword">end</span> <span class="token keyword">of</span> line</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>\COPYコマンドに新しい行を追加しようとすると、このようなエラーメッセージが表示されます。
この制約を回避するため、筆者はまずビューを使用しました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> v_department_dbas <span class="token keyword">AS</span>
    <span class="token keyword">SELECT</span> department<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> employees
    <span class="token keyword">FROM</span> emp
    <span class="token keyword">WHERE</span> role <span class="token operator">=</span> <span class="token string">'dba'</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> department
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> employees<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span>

db<span class="token operator">=</span># \COPY <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> v_department_dbas<span class="token punctuation">)</span> <span class="token keyword">TO</span> department_dbas<span class="token punctuation">.</span>csv <span class="token keyword">WITH</span> CSV HEADER<span class="token punctuation">;</span>
COPY <span class="token number">5</span>

db<span class="token operator">=</span># <span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> v_department_dbas<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">VIEW</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この方法も有効ではあるものの、途中で何かがうまく行かなかった場合、ビューが散乱する結果になりかねません。スキーマはきれいに整理された状態にしておきたいので、作業後のクリーンアップを自動的に行える方法を探してみました。検索すると、<a href="https://www.postgresql.org/docs/current/sql-createview.html#id-1.9.3.97.6">一時ビュー</a>がすぐに出てきました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TEMPORARY</span> <span class="token keyword">VIEW</span> v_department_dbas <span class="token keyword">AS</span> # <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span>

db<span class="token operator">=</span># \COPY <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> v_department_dbas<span class="token punctuation">)</span> <span class="token keyword">TO</span> department_dbas<span class="token punctuation">.</span>csv <span class="token keyword">WITH</span> CSV HEADER<span class="token punctuation">;</span>
COPY <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>一時ビューは、セッションが終了すると自動的に削除されるため、これを使用することで作業後のクリーンアップを行う必要がなくなりました。
しばらく一時ビューを使用していましたが、<a href="https://www.postgresql.org/docs/current/app-psql.html#APP-PSQL-META-COMMANDS-COPY">psqlドキュメント</a>の中に素晴らしい発見がありました。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># COPY <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> department<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> employees
    <span class="token keyword">FROM</span> emp
    <span class="token keyword">WHERE</span> role <span class="token operator">=</span> <span class="token string">'dba'</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> department
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> employees
<span class="token punctuation">)</span> <span class="token keyword">TO</span> STDOUT <span class="token keyword">WITH</span> CSV HEADER \g department_dbas<span class="token punctuation">.</span>csv
COPY <span class="token number">5</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>実に秀逸ではないでしょうか。細かく見ていきましょう。</p>
<ul>
<li><strong>\COPYの代わりにCOPYを使用する</strong>：COPYコマンドはサーバ上で実行されるサーバコマンドであり、\COPYは同じインターフェースを持つpsqlコマンドです。したがって、\COPYは複数行のクエリに対応していませんが、COPYは対応しています。</li>
<li><strong>STDOUTに結果を書き込む</strong>：クエリの結果は、COPYを使用してサーバ上のディレクトリに書き込むか、TO STDOUTを使用して標準出力に書き込むことができます。</li>
<li><strong>\gを使用してSTDOUTをローカルファイルに書き込む</strong>：最後に、psqlは出力を標準出力からファイルに書き込むためのコマンドを提供しています。</li>
</ul>
<p>これら3つの機能を組み合わせることで、求めていた通りの結果が得られました。</p>
<div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>コピーの達人</h5></div><div class="admonition-content"><p>大量のデータを動かす場合、<a href="https://hakibenita.com/fast-load-data-python-postgresql">Fastest Way to Load Data Into PostgreSQL Using Python</a>もチェックしてみてください。</p></div></div>
<hr>
<h2>自動生成キーの値の設定を防ぐ <a name="06"></a></h2>
<p>PostgreSQLで自動生成の主キーを使用している場合、おそらくまだ<a href="https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL">SERIALデータ型</a>を使用しているのではないでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sale <span class="token punctuation">(</span>
    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    sold_at TIMESTAMPTZ<span class="token punctuation">,</span>
    amount <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>裏では、PostgreSQLは行が追加された場合に使用するシーケンスを作成しています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sale<span class="token punctuation">;</span>
 id │           sold_at             │ amount
────┼───────────────────────────────┼────────
  <span class="token number">1</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">10</span>:<span class="token number">06</span>:<span class="token number">56.646298</span><span class="token operator">+</span><span class="token number">03</span> │   <span class="token number">1000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>SERIALデータ型はPostgreSQLに固有のものであり、いくつか既知の問題があります。したがって、バージョン10以降、SERIALデータ型はやんわり非推奨とされ、id列の使用が推奨されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sale <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> GENERATED <span class="token keyword">BY</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">AS</span> <span class="token keyword">IDENTITY</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    sold_at TIMESTAMPTZ<span class="token punctuation">,</span>
    amount <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>id列は、SERIALデータ型の仕組みと非常に似ています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sale<span class="token punctuation">;</span>
 id │           sold_at             │ amount
────┼───────────────────────────────┼────────
  <span class="token number">1</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">25</span> <span class="token number">10</span>:<span class="token number">11</span>:<span class="token number">57.771121</span><span class="token operator">+</span><span class="token number">03</span> │   <span class="token number">1000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>では、次のシナリオを検討してみてください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR:  <span class="token keyword">duplicate</span> <span class="token keyword">key</span> <span class="token keyword">value</span> violates <span class="token keyword">unique</span> <span class="token keyword">constraint</span> <span class="token string">"sale_pkey"</span>
DETAIL:  <span class="token keyword">Key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> already <span class="token keyword">exists</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>なぜエラーになったのでしょうか？</p>
<ul>
<li>最初のINSERTコマンドは、id列の値2を明示的に指定しているため、シーケンスは使用されませんでした。</li>
<li>2つ目のINSERTコマンドはidの値を指定していないため、シーケンスが使用されます。このコマンドは、シーケンスの次の値が偶然2であったため、一意性制約違反によりエラーになりました。</li>
</ul>
<p>自動採番するIDを手動で設定する必要があることはまれであり、手動で設定すると混乱を招くおそれがあります。では、ユーザが設定を行わないようにするにはどうすればよいでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sale <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> GENERATED ALWAYS <span class="token keyword">AS</span> <span class="token keyword">IDENTITY</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    sold_at TIMESTAMPTZ<span class="token punctuation">,</span>
    amount <span class="token keyword">INT</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>GENERATED BY DEFAULTの代わりにGENERATED ALWAYSを使用するのです。両者の違いを理解するために、再び同じシナリオを試してみましょう。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR:  cannot <span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">column</span> <span class="token string">"id"</span>
DETAIL:  <span class="token keyword">Column</span> <span class="token string">"id"</span> <span class="token operator">is</span> an <span class="token keyword">identity</span> <span class="token keyword">column</span> defined <span class="token keyword">as</span> GENERATED ALWAYS<span class="token punctuation">.</span>
HINT:  <span class="token keyword">Use</span> <span class="token keyword">OVERRIDING</span> SYSTEM <span class="token keyword">VALUE</span> <span class="token keyword">to</span> override<span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>何が変わりましたか？</p>
<ul>
<li>最初のINSERTコマンドはidの値を指定せず、正常に完了します。
しかし、2つ目のINSERTコマンドはidに値2を設定しようとしてエラーになっています。</li>
<li>親切にも、PostgreSQLではid列に明示的に値を設定したい場合の解決策がエラーメッセージに記述されています。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sale <span class="token punctuation">(</span>id<span class="token punctuation">,</span> sold_at<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>
<span class="token keyword">OVERRIDING</span> SYSTEM <span class="token keyword">VALUE</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>INSERTコマンドにOVERRIDING SYSTEM VALUEを追加することで、id列の値を設定可能にするようPostgreSQLに明示的に指示できます。それでも、一意性制約違反に対処する必要はあるかもしれませんが、それをPostgreSQLのせいにすることはもはやできません。</p>
<hr>
<h2>ピボットテーブルを作成するもう2つの方法 <a name="07"></a></h2>
<p>以前執筆した記事の中で、筆者は<a href="https://hakibenita.com/sql-for-data-analysis#pivot-tables">条件付き集計を使用してピボットテーブルを作成する方法</a>を説明しました。その記事を書いた後、PostgreSQLでピボットテーブルを生成する方法をさらに2つ発見しました。</p>
<p>各部門の職務ごとの従業員数を調べたいと思います。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">WITH</span> employees <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'Haki'</span><span class="token punctuation">,</span>    <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Manager'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Dan'</span><span class="token punctuation">,</span>     <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Developer'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Jax'</span><span class="token punctuation">,</span>     <span class="token string">'R&amp;D'</span><span class="token punctuation">,</span>      <span class="token string">'Developer'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'George'</span><span class="token punctuation">,</span>  <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Manager'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Bill'</span><span class="token punctuation">,</span>    <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Developer'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'David'</span><span class="token punctuation">,</span>   <span class="token string">'Sales'</span><span class="token punctuation">,</span>    <span class="token string">'Developer'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
        <span class="token keyword">name</span><span class="token punctuation">,</span>       department<span class="token punctuation">,</span>  role
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> role<span class="token punctuation">,</span> department<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> employees
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> role<span class="token punctuation">,</span> department<span class="token punctuation">;</span>

   role    │ department │ count
───────────┼────────────┼───────
 Developer │ Sales      │     <span class="token number">2</span>
 Manager   │ Sales      │     <span class="token number">1</span>
 Manager   │ R<span class="token operator">&amp;</span>D        │     <span class="token number">1</span>
 Developer │ R<span class="token operator">&amp;</span>D        │     <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>同じ情報でも、ピボットテーブルを使用した方が見やすいでしょう。psqlでは、\crosstabviewコマンドを使用することで、前回のクエリの結果をピボットテーブルに変換できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \crosstabview

   role    │ Sales │ R<span class="token operator">&amp;</span>D
───────────┼───────┼─────
 Developer │     <span class="token number">2</span> │   <span class="token number">2</span>
 Manager   │     <span class="token number">1</span> │   <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この通り！</p>
<p>このコマンドは、デフォルトで最初の2つの列からピボットテーブルを作成しますが、これは引数を使用することで制御できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \crosstabview department role

 department │ Developer │ Manager
────────────┼───────────┼─────────
 Sales      │         <span class="token number">2</span> │       <span class="token number">1</span>
 R<span class="token operator">&amp;</span>D        │         <span class="token number">2</span> │       <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>利便性の面では若干劣りますが、あらかじめ組み込まれている<a href="https://www.postgresql.org/docs/current/tablefunc.html">tablefunc拡張機能</a>を使用してピボットテーブルを作成する方法もあります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> EXTENSION tablefunc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTENSION

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> crosstab<span class="token punctuation">(</span><span class="token string">'
    SELECT role, department, count(*) AS employees
    FROM employees
    GROUP BY 1, 2
    ORDER BY role
'</span><span class="token punctuation">,</span> <span class="token string">'
    SELECT DISTINCT department
    FROM employees
    ORDER BY 1
'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>role <span class="token keyword">text</span><span class="token punctuation">,</span> sales <span class="token keyword">int</span><span class="token punctuation">,</span> rnd <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   role    │ sales │ rnd
───────────┼───────┼─────
 Developer │     <span class="token number">2</span> │   <span class="token number">2</span>
 Manager   │     <span class="token number">1</span> │   <span class="token number">1</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://www.postgresql.org/docs/current/tablefunc.html#id-1.11.7.47.5.5">crosstab</a>関数を使用することで、ピボットテーブルを作成できます。この方法の欠点は、出力列をあらかじめ定義しておく必要があることです。しかし、crosstab関数が作成したテーブルをサブクエリとして使用し、さらなる処理を行えることは利点です。</p>
<hr>
<h2>ドル引用 <a name="08"></a></h2>
<p>データベースにテキストフィールド、特にパラグラフ全体を格納している場合、おそらくエスケープ文字についてはよくご存じでしょう。例えば、文字列リテラルにシングルクォート（'）を含める場合、もう1つシングルクォート（''）を使用して
エスケープする必要があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token string">'John''s Pizza'</span><span class="token punctuation">;</span>
   ?<span class="token keyword">column</span>?
──────────────
 John's Pizza</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>テキストの規模が大きくなり、バックスラッシュなどの文字や新しい行が含まれるようになると、エスケープ文字を追加するのがかなり面倒になってきます。この問題に対処するため、PostgreSQLでは文字列定数を記述する方法が他にも用意されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> $$a <span class="token keyword">long</span>
<span class="token keyword">string</span> <span class="token keyword">with</span> <span class="token keyword">new</span> <span class="token keyword">lines</span>
<span class="token operator">and</span> <span class="token string">'single quotes'</span>
<span class="token operator">and</span> <span class="token string">"double quotes

PostgreSQL doesn't mind ;)$$ AS text;
           text
───────────────────────────
 a long                   ↵
 string with new lines    ↵
 and 'single quotes'      ↵
 and "</span><span class="token keyword">double</span> quotes       ↵
                          ↵
 PostgreSQL doesn't mind <span class="token punctuation">;</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>文字列の始めと終わりにあるドル記号$$に注目してください。$$の間にある文字は文字列として扱われます。PostgreSQLでは、これを<a href="https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING">「ドル引用」</a>と呼んでいます。</p>
<p>これだけではありません。テキスト内で$$記号を使用する必要がある場合、タグを追加できるのですが、これが利便性を一層高めてくれるのです。以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> $JSON${
    <span class="token string">"name"</span>: <span class="token string">"John's Pizza"</span><span class="token punctuation">,</span>
    <span class="token string">"tagline"</span>: <span class="token string">"Best value for your $$"</span>
}$JSON$ <span class="token keyword">AS</span> json<span class="token punctuation">;</span>

                  json
─────────────────────────────────────────
 {                                      ↵
     <span class="token string">"name"</span>: <span class="token string">"John's Pizza"</span><span class="token punctuation">,</span>            ↵
     <span class="token string">"tagline"</span>: <span class="token string">"Best value for your $$"</span>↵
 }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このブロックでは、$JSON$というタグを付けているため、出力には「$$」記号全体が含まれています。</p>
<p>また、これを使用して特殊文字を含むjsonbオブジェクトを素早く生成することもできます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> $JSON${
    <span class="token string">"name"</span>: <span class="token string">"John's Pizza"</span><span class="token punctuation">,</span>
    <span class="token string">"tagline"</span>: <span class="token string">"Best value for your $$"</span>
}$JSON$::jsonb <span class="token keyword">AS</span> json<span class="token punctuation">;</span>
                          json
─────────────────────────────────────────────────────────────
 {<span class="token string">"name"</span>: <span class="token string">"John's Pizza"</span><span class="token punctuation">,</span> <span class="token string">"tagline"</span>: <span class="token string">"Best value for your $$"</span>}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>値はjsonbオブジェクトとなり、意のままに操作できます。</p>
<h2>データベースオブジェクトに関するコメント <a name="09"></a></h2>
<p>PostgreSQLには、<a href="https://www.postgresql.org/docs/current/sql-comment.html">ほぼすべてのデータベースオブジェクトについてコメントを追加できる</a>便利な機能があります。以下の例では、テーブルに関するコメントを追加しています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">TABLE</span> sale <span class="token operator">IS</span> <span class="token string">'Sales made in the system'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>このコメントは、psql（およびおそらく他のIDE）で表示できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \dt<span class="token operator">+</span> sale
                                  List <span class="token keyword">of</span> relations
 <span class="token keyword">Schema</span> │ <span class="token keyword">Name</span> │ <span class="token keyword">Type</span>  │ Owner │ Persistence │    <span class="token keyword">Size</span>    │       Description
────────┼──────┼───────┼───────┼─────────────┼────────────┼──────────────────────────
 <span class="token keyword">public</span> │ sale │ <span class="token keyword">table</span> │ haki  │ permanent   │ <span class="token number">8192</span> bytes │ Sales made <span class="token operator">in</span> <span class="token keyword">the</span> system</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>テーブルの列に関するコメントを追加し、拡張記述を使用する際に表示できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> sale<span class="token punctuation">.</span>sold_at <span class="token operator">IS</span> <span class="token string">'When was the sale finalized'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span>

db<span class="token operator">=</span># \d<span class="token operator">+</span> sale
  <span class="token keyword">Column</span>  │           <span class="token keyword">Type</span>           │         Description
──────────┼──────────────────────────┼─────────────────────────────
 id       │ <span class="token keyword">integer</span>                  │
 sold_at │ <span class="token keyword">timestamp</span> <span class="token keyword">with</span> <span class="token keyword">time</span> <span class="token keyword">zone</span> │ <span class="token keyword">When</span> was <span class="token keyword">the</span> sale finalized
 amount   │ <span class="token keyword">integer</span>                  │</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>また、COMMENTコマンドとドル引用を組み合わせて、関数などのより長く意義のある記述を含めることができます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">FUNCTION</span> generate_random_string <span class="token operator">IS</span> $docstring$
Generate a random <span class="token keyword">string</span> <span class="token keyword">at</span> a given <span class="token keyword">length</span> <span class="token keyword">from</span> a list <span class="token keyword">of</span> possible characters<span class="token punctuation">.</span>

<span class="token keyword">Parameters</span>:

    <span class="token operator">-</span> <span class="token keyword">length</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>: <span class="token keyword">length</span> <span class="token keyword">of</span> <span class="token keyword">the</span> output <span class="token keyword">string</span>
    <span class="token operator">-</span> characters <span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span>: possible characters <span class="token keyword">to</span> choose <span class="token keyword">from</span>

Example:

    db<span class="token operator">=</span># <span class="token keyword">SELECT</span> generate_random_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     generate_random_string
    ────────────────────────
     o0QsrMYRvp

    db<span class="token operator">=</span># <span class="token keyword">SELECT</span> generate_random_string<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'AB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     generate_random_string
    ────────────────────────
     ABB
$docstring$<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この関数は、筆者が過去に<a href="https://hakibenita.com/sql-medium-text-performance#toast-compression">中規模のテキストがパフォーマンスに与える影響</a>を実証するために使用したものです。コメントにdocstringを記述しているため、関数の使い方を思い出すために再び記事を見返す必要はもうありません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \df<span class="token operator">+</span> generate_random_string
List <span class="token keyword">of</span> functions
────────────┬────────────────────────────────────────────────────────────────────────────────
<span class="token keyword">Schema</span>      │ <span class="token keyword">public</span>
<span class="token keyword">Name</span>        │ generate_random_string
<span class="token comment">/* ... */</span>
Description │ Generate a random <span class="token keyword">string</span> <span class="token keyword">at</span> a given <span class="token keyword">length</span> <span class="token keyword">from</span> a list <span class="token keyword">of</span> possible characters<span class="token punctuation">.</span>↵
            │                                                                               ↵
            │ <span class="token keyword">Parameters</span>:                                                                   ↵
            │                                                                               ↵
            │     <span class="token operator">-</span> <span class="token keyword">length</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>: <span class="token keyword">length</span> <span class="token keyword">of</span> <span class="token keyword">the</span> output <span class="token keyword">string</span>                               ↵
            │     <span class="token operator">-</span> characters <span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span>: possible characters <span class="token keyword">to</span> choose <span class="token keyword">from</span>                   ↵
            │                                                                               ↵
            │ Example:                                                                      ↵
            │                                                                               ↵
            │     db<span class="token operator">=</span># <span class="token keyword">SELECT</span> generate_random_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                   ↵
            │      generate_random_string                                                   ↵
            │     ────────────────────────                                                  ↵
            │      o0QsrMYRvp                                                               ↵
            │                                                                               ↵
            │     db<span class="token operator">=</span># <span class="token keyword">SELECT</span> generate_random_string<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'AB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                              ↵
            │      generate_random_string                                                   ↵
            │     ────────────────────────                                                  ↵
            │      ABB                                                                      ↵
            │</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<hr>
<h2>データベースごとに個別の履歴ファイルを維持する <a name="10"></a></h2>
<p>CLIツールを使用している場合、過去のコマンドを検索する機能をかなり頻繁に使用しているのではないでしょうか。bashとpsqlでは、<code class="language-text">CTRL + R</code>を押すことで通常逆引きが可能です。</p>
<p>ターミナルの他に複数のデータベースで作業する場合、データベースごとに個別の履歴ファイルを維持すると便利かもしれません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \<span class="token keyword">set</span> HISTFILE <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>psql_history<span class="token operator">-</span> :DBNAME</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>そうすることで、現在接続しているデータベースに関連するマッチを見つけやすくなります。このファイルは、<a href="https://www.postgresql.org/docs/current/app-psql.html#id-1.9.4.20.10">~/.psqlrc file</a>に置くことで永続化できます。</p>
<hr>
<h2>大文字の予約語の自動補完 <a name="11"></a></h2>
<p>SQLのキーワードを小文字で記述すべきか、それとも大文字で記述すべきかについては常に多くの議論（と冗談）の的になっています。このテーマに関する筆者の意見は明白です。</p>
<p>筆者のようにSQLで大文字のキーワードを使用するのを好む場合、大文字のキーワードを自動補完するオプションがpsqlに用意されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># selec <span class="token operator">&lt;</span>tab<span class="token operator">></span>
db<span class="token operator">=</span># <span class="token keyword">select</span>

db<span class="token operator">=</span># \<span class="token keyword">set</span> COMP_KEYWORD_CASE upper
db<span class="token operator">=</span># selec <span class="token operator">&lt;</span>tab<span class="token operator">></span>
db<span class="token operator">=</span># <span class="token keyword">SELECT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>COMP<em>KEYWORD</em>CASEをupperに設定すると、<strong>TAB</strong>キーを押すことでキーワードが大文字で自動補完されるようになります。</p>
<hr>
<h2>スリープ時間の指定 <a name="12"></a></h2>
<p>プログラムの実行を遅らせることは、テストやスロットリングなどにおいてかなり有益な場合があります。PostgreSQLでプログラムの実行を遅らせるには、通常pg_sleep関数を使用します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \timing
Timing <span class="token operator">is</span> <span class="token keyword">on</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> pg_sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pg_sleep
──────────

<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span>

<span class="token keyword">Time</span>: <span class="token number">3014.913</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">03.015</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この関数は、指定した秒数スリープします。しかし、長い時間スリープする必要がある場合、秒数の計算が煩わしくなることもあります。以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> pg_sleep<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>この関数がどれだけの時間スリープするか分かりますか？計算機を取り出す必要はありません。4分15秒です。
長い時間スリープする場合の利便性向上のため、PostgreSQLでは別の関数が用意されています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> pg_sleep_for<span class="token punctuation">(</span><span class="token string">'4 minutes 15 seconds'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>姉妹関数のpg<em>sleepとは異なり、[pg</em>sleep_for](<a href="https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-DELAY">https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-DELAY</a>)関数は時間間隔（interval）での設定が可能であり、秒数よりもはるかに読みやすく、直感的に理解できます。</p>
<hr>
<h2>サブクエリを使用せず、グループの最初または最後の行を取得する <a name="13"></a></h2>
<p>筆者はこの機能をいつも使用しているため、最初にこのリストを作成したときは、これを「あまり知られていない機能」だとは考えていませんでした。しかし、意外にもこの問題に対して奇妙な解決策が提示されていることが多く、これからお見せする方法で簡単に解決できるため、リストに加えることにしました。
以下のような生徒テーブルがあるとします。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> students<span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height
────────┼───────┼────────
 Haki   │ A     │    <span class="token number">186</span>
 Dan    │ A     │    <span class="token number">175</span>
 Jax    │ A     │    <span class="token number">182</span>
 George │ B     │    <span class="token number">178</span>
 Bill   │ B     │    <span class="token number">167</span>
 David  │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<details>
<summary>⚙テーブルデータ</summary>
<p>このセクションのクエリーを再現するために、以下のCTEを使用することができます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> students <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'Haki'</span><span class="token punctuation">,</span>    <span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token number">186</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Dan'</span><span class="token punctuation">,</span>     <span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token number">175</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Jax'</span><span class="token punctuation">,</span>     <span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token number">182</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'George'</span><span class="token punctuation">,</span>  <span class="token string">'B'</span><span class="token punctuation">,</span>    <span class="token number">178</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Bill'</span><span class="token punctuation">,</span>    <span class="token string">'B'</span><span class="token punctuation">,</span>    <span class="token number">167</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'David'</span><span class="token punctuation">,</span>   <span class="token string">'B'</span><span class="token punctuation">,</span>    <span class="token number">178</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
        <span class="token keyword">name</span><span class="token punctuation">,</span>       class<span class="token punctuation">,</span>  height
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> students<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p><strong>各クラスで一番背の高い生徒の行全体を取得するにはどうすればよいでしょうか?</strong></p>
<p>最初に思いつく方法は次のようなものではないでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> class<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token keyword">as</span> tallest
<span class="token keyword">FROM</span> students
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> class<span class="token punctuation">;</span>

 class │ tallest
───────┼─────────
 A     │     <span class="token number">186</span>
 B     │     <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これだと身長は取得できますが、生徒の名前は得られません。次に、サブクエリを使用して、身長をもとに一番背の高い生徒を見つけようとするかもしれません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> students
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>class<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> class<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token keyword">as</span> tallest
    <span class="token keyword">FROM</span> students
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> class
<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height
────────┼───────┼────────
 Haki   │ A     │    <span class="token number">186</span>
 George │ B     │    <span class="token number">178</span>
 David  │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで、各クラスで一番背の高い生徒に関する情報がすべて揃いましたが、まだ別の問題があります。</p>
<div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>追記</h5></div><div class="admonition-content"><p>前のクエリ（(class, height) IN (...)）のようにレコードのセットをマッチングする機能もあまり知られていない、非常に強力なPostgreSQLの機能です。</p></div></div>
<p>クラス「B」には同じ身長の生徒が2人いますが、これがクラスで一番高い身長でもあります。集計関数MAXを使用すると身長しか得られないため、このような状況に直面する可能性があります。</p>
<p>MAXの使用が難しいのは、身長だけをもとに身長を選ばなくてはならないことであり、この場合は全く理にかなっているのですが、生徒を1人だけ選ぶ必要があります。2つ以上の列をもとに行を「ランク付け」できる別のアプローチとして、ウィンドウ関数を使用する方法があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span>
    students<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
    ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
        <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> class
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
<span class="token keyword">FROM</span>
    students<span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height │ rn
────────┼───────┼────────┼────
 Haki   │ A     │    <span class="token number">186</span> │  <span class="token number">1</span>
 Jax    │ A     │    <span class="token number">182</span> │  <span class="token number">2</span>
 Dan    │ A     │    <span class="token number">175</span> │  <span class="token number">3</span>
 David  │ B     │    <span class="token number">178</span> │  <span class="token number">1</span>
 George │ B     │    <span class="token number">178</span> │  <span class="token number">2</span>
 Bill   │ B     │    <span class="token number">167</span> │  <span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>身長をもとに生徒を「ランク付け」するには、各行に行番号を振ることができます。行番号はクラスごとに決められ（PARTITION BY class）まず身長の高い順にランク付けされ、次に生徒の名前でランク付けされます（ORDER BY height DESC, name）。身長の他に生徒の名前も追加することで、決定性のある結果が得られます（同じ名前がないと仮定した場合）。</p>
<p>各クラスで一番背の高い生徒の行だけを取得するには、サブクエリを使用できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span>
    <span class="token keyword">name</span><span class="token punctuation">,</span> class<span class="token punctuation">,</span> height
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        students<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
        ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> class
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        students
<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">inner</span>
<span class="token keyword">WHERE</span>
    rn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

 <span class="token keyword">name</span>  │ class │ height
───────┼───────┼────────
 Haki  │ A     │    <span class="token number">186</span>
 David │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>できました！これが各クラスで一番背の高い生徒の行全体です。</p>
<p>DISTINCT ONを<strong>使用する</strong></p>
<p>かなり手間のかかる方法を見てきましたが、次はもっと簡単な方法を紹介したいと思います。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">ON</span> <span class="token punctuation">(</span>class<span class="token punctuation">)</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    students
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    class<span class="token punctuation">,</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token punctuation">;</span>

 <span class="token keyword">name</span>  │ class │ height
───────┼───────┼────────
 Haki  │ A     │    <span class="token number">186</span>
 David │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>いかがでしょうか？<a href="https://hakibenita.com/the-many-faces-of-distinct-in-postgre-sql#distinct-on">最初にDISTINCT ONを発見した</a>ときは、とても感動しました。Oracleから来たものですが、他に同じような機能はなく、筆者が知る限りでは、PostgreSQL以外のデータベースに同様の機能はありません。</p>
<p>DISTINCT ONを<strong>直感的に理解する</strong></p>
<p>DISTINCT ONの仕組みを理解するために、その挙動について順を追って見ていきましょう。以下がテーブル上の生データです。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> students<span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height
────────┼───────┼────────
 Haki   │ A     │    <span class="token number">186</span>
 Dan    │ A     │    <span class="token number">175</span>
 Jax    │ A     │    <span class="token number">182</span>
 George │ B     │    <span class="token number">178</span>
 Bill   │ B     │    <span class="token number">167</span>
 David  │ B     │    <span class="token number">178</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>次に、データを並べ替えます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> students
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> class<span class="token punctuation">,</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token punctuation">;</span>

  <span class="token keyword">name</span>  │ class │ height
────────┼───────┼────────
 Haki   │ A     │    <span class="token number">186</span>
 Jax    │ A     │    <span class="token number">182</span>
 Dan    │ A     │    <span class="token number">175</span>
 David  │ B     │    <span class="token number">178</span>
 George │ B     │    <span class="token number">178</span>
 Bill   │ B     │    <span class="token number">167</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>DISTINCT ON句を追加します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">ON</span> <span class="token punctuation">(</span>class<span class="token punctuation">)</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> students
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> class<span class="token punctuation">,</span> height <span class="token keyword">DESC</span><span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>DISTINCT ONがこの時点で何をするかを理解するには、2つのステップを経なくてはいけません。</p>
<p>まず、DISTINCT ON句の中の列（この場合はclass）をもとに、データをグループに分けます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">  <span class="token keyword">name</span>  │ class │ height
─────────────────────────
 Haki   │ A     │    <span class="token number">186</span>  ┓
 Jax    │ A     │    <span class="token number">182</span>  ┣━━ class<span class="token operator">=</span>A
 Dan    │ A     │    <span class="token number">175</span>  ┛

 David  │ B     │    <span class="token number">178</span>  ┓
 George │ B     │    <span class="token number">178</span>  ┣━━ class<span class="token operator">=</span>B
 Bill   │ B     │    <span class="token number">167</span>  ┛</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>次に、各グループの1行目だけを残します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"> <span class="token keyword">name</span>  │ class │ height
─────────────────────────
 Haki   │ A     │    <span class="token number">186</span>  ┣━━ class<span class="token operator">=</span>A
 David  │ B     │    <span class="token number">178</span>  ┣━━ class<span class="token operator">=</span>B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>これで終わりです。各クラスで一番背の高い生徒が得られました。</p>
<p>DISTINCT ONを使う上での唯一の要件は、ORDER BY句の先行列がDISTINCT ON句の列と一致することです。ORDER BY句の残りの列は、各グループのどの行を選択するかを判断するために使用します。</p>
<p>ORDER BYが結果にどう影響するかを理解するには、各クラスで一番背の低い生徒を特定する次のクエリを検討してください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">ON</span> <span class="token punctuation">(</span>class<span class="token punctuation">)</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    students
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    class<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token keyword">name</span><span class="token punctuation">;</span>

 <span class="token keyword">name</span> │ class │ height
──────┼───────┼────────
 Dan  │ A     │    <span class="token number">175</span>
 Bill │ B     │    <span class="token number">167</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>各クラスで一番背の低い生徒を選ぶには、各グループの1行目が一番背の低い生徒になるよう並び順を変えるだけでいいのです。</p>
<hr>
<h2>拡張機能なしでUUIDを生成する <a name="14"></a></h2>
<p>PostgreSQLのバージョン13より前では、おそらく<a href="https://www.postgresql.org/docs/current/uuid-ossp.html#id-1.11.7.53.5">拡張機能uuid-ossp</a>を使用してUUIDを生成していたのではないでしょうか。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> EXTENSION <span class="token string">"uuid-ossp"</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTENSION

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> uuid_generate_v4<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> uuid<span class="token punctuation">;</span>
                 uuid
──────────────────────────────────────
 <span class="token number">8</span>e55146d<span class="token operator">-</span><span class="token number">0</span>ce5<span class="token operator">-</span><span class="token number">40</span>ab<span class="token operator">-</span>a346<span class="token operator">-</span><span class="token number">5</span>dbd466ff5f2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>バージョン13以降、<a href="https://www.postgresql.org/docs/current/functions-uuid.html">ランダムなUUID（バージョン4）を生成するための関数</a>が組み込まれています。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> uuid<span class="token punctuation">;</span>
                 uuid
──────────────────────────────────────
 ba1ac0f5<span class="token operator">-</span><span class="token number">5</span>d4d<span class="token operator">-</span><span class="token number">4</span>d80<span class="token operator">-</span><span class="token number">974</span>d<span class="token operator">-</span><span class="token number">521</span>dbdcca2b2</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>拡張機能uuid-osspは、バージョン4以外のUUIDを生成したい場合はまだ必要です。</p>
<hr>
<h2>再現可能なランダムデータの生成 <a name="15"></a></h2>
<p>ランダムデータの生成は、デモやテストなどさまざまな場面で非常に役立ちます。いずれの場合も、「ランダム」データを再現できると有用です。</p>
<p>PostgreSQLのrandom関数を使用することで、<a href="https://hakibenita.com/sql-for-data-analysis#random">さまざまなタイプのランダムデータを生成</a>できます。以下の例をご覧ください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span>
    random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_float<span class="token punctuation">,</span>
    ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_int_0_10<span class="token punctuation">,</span>
    <span class="token string">'2022-01-01'</span>::<span class="token keyword">date</span> <span class="token operator">+</span> <span class="token keyword">interval</span> <span class="token string">'1 days'</span> <span class="token operator">*</span> ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_day_in_2022<span class="token punctuation">;</span>

─<span class="token punctuation">[</span> <span class="token keyword">RECORD</span> <span class="token number">1</span> <span class="token punctuation">]</span>──────┬────────────────────
random_float       │ <span class="token number">0.6031888056092001</span>
random_int_0_10    │ <span class="token number">3</span>
random_day_in_2022 │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このクエリを再度実行すると、異なる結果が得られます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span>
    random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_float<span class="token punctuation">,</span>
    ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_int_0_10<span class="token punctuation">,</span>
    <span class="token string">'2022-01-01'</span>::<span class="token keyword">date</span> <span class="token operator">+</span> <span class="token keyword">interval</span> <span class="token string">'1 days'</span> <span class="token operator">*</span> ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_day_in_2022<span class="token punctuation">;</span>

─<span class="token punctuation">[</span> <span class="token keyword">RECORD</span> <span class="token number">1</span> <span class="token punctuation">]</span>──────┬────────────────────
random_float       │ <span class="token number">0.7363406030115378</span>
random_int_0_10    │ <span class="token number">2</span>
random_day_in_2022 │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>再現可能なランダムデータを生成するには、<a href="https://www.postgresql.org/docs/current/functions-math.html#FUNCTIONS-MATH-RANDOM-TABLE">setseed</a>を使用できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> setseed<span class="token punctuation">(</span><span class="token number">0.4050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 setseed
─────────

<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span>
    random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_float<span class="token punctuation">,</span>
    ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_int_0_10<span class="token punctuation">,</span>
    <span class="token string">'2022-01-01'</span>::<span class="token keyword">date</span> <span class="token operator">+</span> <span class="token keyword">interval</span> <span class="token string">'1 days'</span> <span class="token operator">*</span> ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_day_in_2022
<span class="token keyword">FROM</span>
    generate_series<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    random_float    │ random_int_0_10 │ random_day_in_2022
────────────────────┼─────────────────┼─────────────────────
 <span class="token number">0.1924247516794324</span> │               <span class="token number">9</span> │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span>
 <span class="token number">0.9720620908236377</span> │               <span class="token number">5</span> │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>新しいセッションで再び同じブロックを実行すると、異なるデータベースであっても全く同じ結果が得られます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">otherdb<span class="token operator">=</span># <span class="token keyword">SELECT</span> setseed<span class="token punctuation">(</span><span class="token number">0.4050</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 setseed
─────────

<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span>

otherdb<span class="token operator">=</span># <span class="token keyword">SELECT</span>
    random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_float<span class="token punctuation">,</span>
    ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_int_0_10<span class="token punctuation">,</span>
    <span class="token string">'2022-01-01'</span>::<span class="token keyword">date</span> <span class="token operator">+</span> <span class="token keyword">interval</span> <span class="token string">'1 days'</span> <span class="token operator">*</span> ceil<span class="token punctuation">(</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> random_day_in_2022
<span class="token keyword">FROM</span>
    generate_series<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    random_float    │ random_int_0_10 │ random_day_in_2022
────────────────────┼─────────────────┼─────────────────────
 <span class="token number">0.1924247516794324</span> │               <span class="token number">9</span> │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">17</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span>
 <span class="token number">0.9720620908236377</span> │               <span class="token number">5</span> │ <span class="token number">2022</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">13</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>結果はランダムであるものの、全く同じであることに注目してください。次にデモを行ったり、スクリプトを共有したりする場合、結果を簡単に再現できるようsetseedを使用してみてください。</p>
<hr>
<h2>直ちに検証することなく制約を追加する <a name="16"></a></h2>
<p>制約はRDBMSに不可欠な要素です。制約はデータをクリーンで信頼できる状態に保つため、なるべく使用することが望まれます。本番稼働中のシステムでは、新たな制約を追加しなくてはならないことがしばしばありますが、制約の種類によっては、システムの動作を妨げる非常に制限の厳しいロックが必要になることもあります。</p>
<p>例として、大規模なテーブルに単純なチェック制約を追加してみてください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> orders <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> check_price_gt_zero <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>price <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span>
<span class="token keyword">Time</span>: <span class="token number">10745.662</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">10.746</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>この文は、注文の価格が0以上になるようチェック制約を追加します。制約を追加する際、データベースがテーブル全体をスキャンし、制約が既存のすべての行に対して有効であることを確認しました。このプロセスには約10秒かかり、その間テーブルはロックされました。</p>
<p><strong>PostgreSQLでは、制約を追加するプロセスを2つのステップに分けることができます。</strong></p>
<p>まず、制約を追加して新しいデータのみを検証し、既存のデータについては有効かどうかをチェックしません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> orders <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> check_price_gt_zero <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>price <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> VALID<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span>
<span class="token keyword">Time</span>: <span class="token number">13.590</span> ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>最後のNOT VALIDは、既存の行について新しい制約の検証を行わないようPostgreSQLに指示するものです。これは、データベースがテーブル全体をスキャンする必要がないことを意味します。この文が前の文に比べて所要時間が大幅に短く、ほぼ瞬時に処理されたことに注目してください。</p>
<p>次に、既存のデータについて、はるかに制限が緩く、テーブル上の他の演算を許容するロックを使用し、制約を検証します。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> orders <span class="token keyword">VALIDATE</span> <span class="token keyword">CONSTRAINT</span> check_price_gt_zero<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span>
<span class="token keyword">Time</span>: <span class="token number">11231.189</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">11.231</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>制約の検証に要した時間が、制約の追加と検証を行った最初の例とおおむね同じであることにお気づきでしょうか。これは、既存のテーブルに制約を追加する際、ほとんどの時間が既存の行の検証に費やされていることを再確認させるものです。プロセスを2つのステップに分けることで、テーブルがロックされている時間を短縮できます。</p>
<p>ドキュメントは、<a href="https://www.postgresql.org/docs/current/sql-altertable.html#SQL-ALTERTABLE-NOTES">NOT VALIDの別のユースケース</a>についても言及しています。それは、たとえ好ましくない値があったとしても、将来のアップデートに対してのみ制約を適用するというものです。つまり、NOT VALIDを追加し、VALIDATEは行わないということです。</p>
<p>Paypalのエンジニアリングチームが<a href="https://medium.com/paypal-tech/postgresql-at-scale-database-schema-changes-without-downtime-20d3749ed680">ダウンタイムなしでスキーマに変更を加える</a>方法について素晴らしい記事を執筆しています。<a href="https://hakibenita.com/sql-tricks-application-dba#disable-constraints-and-indexes-during-bulk-loads">バルクロードを行う際に制約とインデックスを無効化する</a>ことを提案した筆者の記事も併せてご覧ください。</p>
<hr>
<h2>PostgreSQLにおけるシノニム <a name="17"></a></h2>
<p>シノニム（同義語）は、オブジェクトを別の名前で参照する手段を提供するもので、Linuxのシンボリックリンクと似ています。Oracleの使用経験がある方はシノニムになじみがあるかと思われますが、そうでなければ聞いたことがないかもしれません。PostgreSQLには「シノニム」という名前の機能はありませんが、同様のことができないわけではありません。</p>
<p>特定の名前に別のデータベースオブジェクトを参照させるには、まず、PostgreSQLが条件を持たない名前をどのように解決するのか理解する必要があります。例えば、ユーザhakiとしてデータベースに接続し、テーブルfooを参照した場合、PostgreSQLは以下のオブジェクトを、以下の順序で検索します。</p>
<ol>
<li>haki.foo</li>
<li>public.foo</li>
</ol>
<p>この順序は<a href="https://www.postgresql.org/docs/current/ddl-schemas.html#DDL-SCHEMAS-PATH">search_pathパラメータ</a>によって決まります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SHOW</span> search_path<span class="token punctuation">;</span>
   search_path
─────────────────
 <span class="token string">"$user"</span><span class="token punctuation">,</span> <span class="token keyword">public</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>最初の値"$user"は特殊な値であり、現在接続しているユーザの名前に解決されます。2つ目の値publicはデフォルトスキーマの名前です。</p>
<p>サーチパスに関してできることを実証するため、データベースdbにテーブルfooを作成してみてください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> foo <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">TEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> foo <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> foo<span class="token punctuation">;</span>
 <span class="token keyword">value</span>
───────
 A
<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>何らかの理由により、ユーザhakiがfooという名前を参照した際に異なるオブジェクトを表示させたい場合、2つの選択肢があります。</p>
<p><strong>1. hakiという名前のスキーマにfooという名前のオブジェクトを作成する。</strong></p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span> haki<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span>

db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> haki<span class="token punctuation">.</span>foo <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> haki<span class="token punctuation">.</span>foo <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># \conninfo
You are connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"haki"</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> foo<span class="token punctuation">;</span>
<span class="token keyword">value</span>
───────
B</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ユーザhakiがfooという名前を参照すると、PostgreSQLがpublic.fooではなくhaki.fooに名前を解決することに注目してください。これは、サーチパス上でスキーマhakiがpublicよりも前に来るためです。</p>
<p><strong>2.サーチパスのアップデート。</strong></p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span> synonyms<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span>

db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> synonyms<span class="token punctuation">.</span>foo <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> synonyms<span class="token punctuation">.</span>foo <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token number">0</span> <span class="token number">1</span>

db<span class="token operator">=</span># <span class="token keyword">SHOW</span> search_path<span class="token punctuation">;</span>
   search_path
─────────────────
 <span class="token string">"$user"</span><span class="token punctuation">,</span> <span class="token keyword">public</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> foo<span class="token punctuation">;</span>
 <span class="token keyword">value</span>
───────
 A

db<span class="token operator">=</span># <span class="token keyword">SET</span> search_path <span class="token keyword">TO</span> synonyms<span class="token punctuation">,</span> <span class="token string">"$user"</span><span class="token punctuation">,</span> <span class="token keyword">public</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> foo<span class="token punctuation">;</span>
 <span class="token keyword">value</span>
───────
 C</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>サーチパスにスキーマsynonymsが含まれるよう変更を加えると、PostgreSQLがfooという名前をsynonyms.fooに解決するようになります。</p>
<p><strong>シノニムはなぜ有用か？</strong></p>
<p>筆者は以前、シノニムは避けるべきコードの臭いだと考えていましたが、その後シノニムが有用なユースケースをいくつか発見しました。その1つは、ゼロダウンタイムの移行です。</p>
<p>本番稼働中のシステムのテーブルに変更を加える際、アプリケーションの新旧バージョン両方を同時にサポートしなくてはならないことが多々あります。これは、アプリケーションの各バージョンが想定するテーブル構造が異なるため、困難を伴います。</p>
<p>テーブルから特定の列を削除する移行を例に検討してみましょう。移行が実行されている間、アプリケーションの古いバージョンは稼働しており、テーブルにその列があることを想定しているため、単純に削除することはできません。この問題に対処する1つの方法として、新しいバージョンを2段階に分けてリリースできます。1つ目のリリースではその列を無視し、2つ目のリリースで削除するのです。</p>
<p>ただし、1回のリリースで変更を行う必要がある場合、その列を含むテーブルのビューを古いバージョンに提供してから削除できます。これには「シノニム」を使用できます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \conninfo
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"app"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
 username │ active
──────────┼────────
 haki     │ t</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>アプリケーションは、ユーザappとしてデータベースdbに接続しています。active列を削除したいのですが、アプリケーションがこの列を使用しています。移行を無事完了するためには、古いバージョンが稼働している間、その列がまだそこにあるとユーザappに思わせる必要があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \conninfo
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"admin"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span> app<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span>

db<span class="token operator">=</span># <span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span> <span class="token keyword">ON</span> <span class="token keyword">SCHEMA</span> app <span class="token keyword">TO</span> app<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span>

db<span class="token operator">=</span># <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> app<span class="token punctuation">.</span>users <span class="token keyword">AS</span> <span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token keyword">AS</span> active <span class="token keyword">FROM</span> <span class="token keyword">public</span><span class="token punctuation">.</span>users<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span>

db<span class="token operator">=</span># <span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> app<span class="token punctuation">.</span>users <span class="token keyword">TO</span> app<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ユーザappを「騙す」ために、ユーザの名前を用いたスキーマと、計算済みフィールドactiveを持つビューを作成しました。アプリケーションがユーザappとして接続しているとき、テーブルではなくそのビューが見えるため、列を削除しても問題ありません。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># \conninfo
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"admin"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> users <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> active<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span>

db<span class="token operator">=</span># \<span class="token keyword">connect</span> db app
You are now connected <span class="token keyword">to</span> <span class="token keyword">database</span> <span class="token string">"db"</span> <span class="token keyword">as</span> <span class="token keyword">user</span> <span class="token string">"app"</span><span class="token punctuation">.</span>

db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users<span class="token punctuation">;</span>
 username │ active
──────────┼────────
 haki     │ t</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>列を削除すると、アプリケーションは代わりに計算済みフィールドを参照します。後は少しクリーンアップを行って終了です。</p>
<hr>
<h2>重複レンジを探す <a name="18"></a></h2>
<p>以下のような会議テーブルがあるとします。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">db<span class="token operator">=</span># <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> meetings<span class="token punctuation">;</span>
       starts_at     │        ends_at
─────────────────────┼─────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">00</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">30</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">30</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">45</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<details>
<summary>⚙テーブルデータ</summary>
<p>以下のCTEを使用して、このセクションのクエリーを再現することができます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        starts_at::timestamptz <span class="token keyword">AS</span> starts_at<span class="token punctuation">,</span>
        ends_at::timestamptz <span class="token keyword">AS</span> ends_at
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'2021-10-01 10:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 10:30 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'2021-10-01 12:30 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:45 UTC'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> t<span class="token punctuation">(</span>
        starts_at<span class="token punctuation">,</span>               ends_at<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> meetings<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</details>
<p>新しい会議の予定を入れたいのですが、その前に、他の会議と重ならないことを確認する必要があります。いくつか検討すべきシナリオがあります。</p>
<ul>
<li>[A] 新しい会議は既存の会議が開始した後終了する。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token operator">|</span><span class="token comment">-------NEW MEETING--------|</span>
    <span class="token operator">|</span><span class="token comment">--------*EXISTING MEETING--------*|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[B] 新しい会議は既存の会議が終わる前に開始する。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">        <span class="token operator">|</span><span class="token comment">-------NEW MEETING--------|</span>
<span class="token operator">|</span><span class="token comment">--------*EXISTING MEETING--------*|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[C] 新しい会議は既存の会議が実施されている間に行われる。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">   <span class="token operator">|</span><span class="token comment">----NEW MEETING----|</span>
<span class="token operator">|</span><span class="token comment">--------*EXISTING MEETING--------*|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[D] 既存の会議は新しい会議が予定されている時間内に行われる。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token operator">|</span><span class="token comment">--------NEW MEETING--------|</span>
    <span class="token operator">|</span><span class="token operator">*</span><span class="token operator">*</span>EXISTING MEETING<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[E] 新しい会議は既存の会議と全く同じ時間に予定されている。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token operator">|</span><span class="token comment">--------NEW MEETING--------|</span>
<span class="token operator">|</span><span class="token comment">----**EXISTING MEETING--------|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>重複の有無をチェックするクエリをテストするため、上記のシナリオがすべて含まれるテーブルを作成し、以下の簡単な条件式を試してみてください。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        id<span class="token punctuation">,</span>
        starts_at::timestamptz <span class="token keyword">as</span> starts_at<span class="token punctuation">,</span>
        ends_at::timestamptz <span class="token keyword">as</span> ends_at
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> t<span class="token punctuation">(</span>
        id<span class="token punctuation">,</span>   starts_at<span class="token punctuation">,</span>               ends_at
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">;</span>

       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>最初の試みでは、5 つのシナリオのうち 4 つのシナリオで重複を発見しました
。シナリオDでは、新しい会議が既存の会議の前に始まり、後に終わる場合、重複を検出しませんでした。このシナリオも処理するためには、条件をもう少し長くする必要があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> new_meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">;</span>


       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ D  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このクエリは5つすべてのシナリオで重複を検出しますが、以下の追加シナリオを検討してください。</p>
<ul>
<li>[F] 新しい会議は既存の会議の直後に予定されている。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql">                            <span class="token operator">|</span><span class="token comment">--------NEW MEETING--------|</span>
<span class="token operator">|</span><span class="token comment">----**EXISTING MEETING--------|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<ul>
<li>[G] 新しい会議は既存の会議の開始直後に終了する予定になっている。</li>
</ul>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token operator">|</span><span class="token comment">--------NEW MEETING--------|</span>
                            <span class="token operator">|</span><span class="token comment">----**EXISTING MEETING--------|</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p>会議が連続するのはよくあることですが、これらについては重複と認識されるべきではありません。2つのシナリオをテストに追加し、クエリを実行してみます。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        id<span class="token punctuation">,</span>
        starts_at::timestamptz <span class="token keyword">as</span> starts_at<span class="token punctuation">,</span>
        ends_at::timestamptz <span class="token keyword">as</span> ends_at
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:10 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> t<span class="token punctuation">(</span>
        id<span class="token punctuation">,</span>   starts_at<span class="token punctuation">,</span>               ends_at
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">BETWEEN</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> new_meetings<span class="token punctuation">.</span>ends_at
    <span class="token operator">OR</span> meetings<span class="token punctuation">.</span>ends_at <span class="token operator">BETWEEN</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">and</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">;</span>

       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ D  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ F  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">10</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ G  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">00</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>2つの会議が連続するシナリオFとGは、誤って重複に分類されています。これは、<a href="https://hakibenita.com/sql-dos-and-donts#use-between-only-for-inclusive-ranges">演算子BETWEENがその前後を含む</a>ためです。BETWEENを使用せずにこの条件式を実行するには、以下のようにする必要があります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    <span class="token punctuation">(</span>new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">></span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">&lt;</span> meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
    <span class="token operator">OR</span>
    <span class="token punctuation">(</span>new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">></span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> new_meetings<span class="token punctuation">.</span>ends_at <span class="token operator">&lt;</span> meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
    <span class="token operator">OR</span>
    <span class="token punctuation">(</span>meetings<span class="token punctuation">.</span>starts_at <span class="token operator">></span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> meetings<span class="token punctuation">.</span>starts_at <span class="token operator">&lt;</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
    <span class="token operator">OR</span>
    <span class="token punctuation">(</span>meetings<span class="token punctuation">.</span>ends_at <span class="token operator">></span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> meetings<span class="token punctuation">.</span>ends_at <span class="token operator">&lt;</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
    <span class="token operator">OR</span>
    <span class="token punctuation">(</span>meetings<span class="token punctuation">.</span>starts_at <span class="token operator">=</span> new_meetings<span class="token punctuation">.</span>starts_at <span class="token operator">AND</span> meetings<span class="token punctuation">.</span>ends_at <span class="token operator">=</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ D  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>クエリはシナリオA～Eを重複として正しく認識し、会議が連続するシナリオFとGは重複とは認識しません。求めていた結果はこれです。しかし、この条件式はあまりにも複雑です。容易に手に負えなくなってしまうでしょう。</p>
<p>そこで、PostgreSQLの以下の演算子が極めて有益となります。</p>
<div class="gatsby-highlight" data-language="plsql"><pre style="counter-reset: linenumber NaN" class="language-plsql line-numbers"><code class="language-plsql"><span class="token keyword">WITH</span> new_meetings <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span>
        id<span class="token punctuation">,</span>
        starts_at::timestamptz <span class="token keyword">as</span> starts_at<span class="token punctuation">,</span>
        ends_at::timestamptz <span class="token keyword">as</span> ends_at
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">VALUES</span>
        <span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:20 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:55 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:10 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:05 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 12:10 UTC'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:00 UTC'</span><span class="token punctuation">,</span> <span class="token string">'2021-10-01 11:15 UTC'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> t<span class="token punctuation">(</span>
        id<span class="token punctuation">,</span>   starts_at<span class="token punctuation">,</span>               ends_at
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    meetings<span class="token punctuation">,</span> new_meetings
<span class="token keyword">WHERE</span>
    <span class="token punctuation">(</span>new_meetings<span class="token punctuation">.</span>starts_at<span class="token punctuation">,</span> new_meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span>
        <span class="token keyword">OVERLAPS</span> <span class="token punctuation">(</span>meetings<span class="token punctuation">.</span>starts_at<span class="token punctuation">,</span> meetings<span class="token punctuation">.</span>ends_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

       starts_at     │        ends_at      │ id │       starts_at     │        ends_at
─────────────────────┼─────────────────────┼────┼─────────────────────┼────────────────────
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ A  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ B  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ C  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">20</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">55</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ D  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">10</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">05</span>:<span class="token number">00</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span> │ E  │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">11</span>:<span class="token number">15</span>:<span class="token number">00</span> │ <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">12</span>:<span class="token number">00</span>:<span class="token number">00</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これです！<a href="https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-TABLE">OVERLAPS演算子</a>を使用することで、5つの複雑な条件式が不要になり、クエリは短く単純で、読みやすく、分かりやすくなりました。</p>
<hr>
<p><em>改訂履歴</em></p>
<ul>
<li>2021年11月9日：<a href="https://www.reddit.com/r/programming/comments/qpj4cy/comment/hjwwqgi/?utm_source=share&#x26;utm_medium=web2x&#x26;context=3">Redditのコメント投稿者</a>が、「大文字の予約語の自動補完」のセクションでpsqlパラメータの名前の誤りを見つけてくれました。COMP<em>KEYWORD</em>UPPERをCOMP<em>KEYWORD</em>CASEに修正しました。</li>
<li>2021年11月9日：pg<em>sleepの例は、記事の中で以前述べていたように4分ではなく4時間（14400秒）のスリープでした。pg</em>sleep_forによる時間間隔を用いるメリットをより明確に伝えるため、例に変更を加えました。</li>
</ul>]]></content:encoded></item><item><title><![CDATA[Web開発者の悩みの種ランキング（2021年版）]]></title><description><![CDATA[私は先日、開発者が何を最も大きな課題に挙げているかを知ることで、開発者コミュニティのニーズを理解できるという記事を書きました。 元々の投稿はMDN Developer Needs Assessmen…]]></description><link>https://postd.cc/top-web-developer-pain-points-in-2021/</link><guid isPermaLink="false">https://postd.cc/top-web-developer-pain-points-in-2021/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[まとめ]]></category><category><![CDATA[Web開発]]></category><pubDate>Tue, 15 Mar 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>私は先日、開発者が何を<a href="https://paul.kinlan.me/thinking-about-developer-satisfaction-and-web-developers/">最も大きな課題</a>に挙げているかを知ることで、開発者コミュニティのニーズを理解できるという記事を書きました。</p>
<p>元々の投稿は<a href="https://insights.developer.mozilla.org/">MDN Developer Needs Assessment</a>（2019年）の結果を要約したものでしたが、不運なことに、この調査は2020年に中止されました。この調査情報は、Webプラットフォーム全体の方向性を定めるのに役立つ点で、私たちのチームにとって重要だったため、調査の中止は残念なことです。</p>
<p>調査を実施していたMozillaの代わりとして、私はチームのために、開発者の大まかなニーズを把握する調査を企画しました。</p>
<p>3カ月ごとに、米国、英国、インドのWeb開発者やWeb開発における意思決定者約700人をランダムにサンプリングして実施し、過去に実施したすべての調査とデータを比較して、トレンドに変化があるかを見ていきます。</p>
<p>注意すべきなのは、MDN Surveyと私たちの調査は違うということです。両者調査の回答者は異なっており、質問内容も（可能な限り似せようとしましたが）微妙に違います。回答者の人数も違うため、Max-Diff法を使用せずに、問題だと思っていること上位3つを選択する形式です。そのため、回答の優先順位をどのように付けるべきかという疑問が生じますが、結果を詳しく見てみると、結論に大差はありません。</p>
<p>2020年の調査では、開発者がフラストレーションを感じる主な点として、以下が挙げられました。</p>
<blockquote>
<ol>
<li>ブラウザの互換性 – <a href="https://paul.kinlan.me/the-lumpy-web/">Webは「でこぼこ」している、</a>もっと滑らかであるべきだ。Chromeは幅広いWebプラットフォームとの互換性を確保し続けるべき。Chromeはすべてのブラウザベンダーと協力して互換性を支援すべき。ChromeはWebブラウザがChromeのみにならないように手助けすべき。</li>
<li>テスト – すべてのブラウザでサイトのエンドツーエンドテストを簡単に実施できるようにすべきだ。現在はテストを実施するのが難しすぎる。</li>
<li>ドキュメント – 最適かつ最新の参照資料や、筆者の意見が記された検証済みのベストプラクティスガイダンスを、開発者が簡単に見つけられるようにすべきだ。</li>
<li>デバッグ – 開発者はデバッグを失敗と捉えている。直面している問題について、開発者が理解し、可能な限り速やかに解決できるように、あらゆるツールを利用できるようにすべきだ。</li>
<li>フレームワーク - 非常に多くの開発者がフレームワークを利用している事実から逃れることはできない。ブラウザベンダーとフレームワーク作者との強固な関係を確実に維持するには、また、開発者がこうしたツールの効果的な利用ノウハウを維持していくには、どうすればよいか？</li>
<li>プライバシーとセキュリティ – 有効競争によって生じるエコシステムの変化のみならず、非常に多くの法令が開発スピードを遅らせる要因となっている。こうした変化は開発者を悩ませ、私たちは人々の助けとなるガイダンスとツールを必要としている。</li>
</ol>
</blockquote>
<p>それでは、2021年はどうでしょうか？</p>
<p>（ドラムロール）</p>
<p>結果はほとんど変わりませんでした。測定方法が変わったため、一定の変化はありましたが、全体的な方向性は同じです。</p>
<p>トップ5は以下の通りです（パーセンテージは、その問題を上位3つに入れた開発者の割合を表します）。</p>
<table>
<thead>
<tr>
<th>課題</th>
<th>第1四半期</th>
<th>第2四半期</th>
<th>第3四半期</th>
</tr>
</thead>
<tbody>
<tr>
<td>WebプラットフォームやWeb標準の変化についていく</td>
<td>27%</td>
<td>26%</td>
<td>27%</td>
</tr>
<tr>
<td>大量の新しい（および既存の）ツールやフレームワークについていく</td>
<td>26%</td>
<td>26%</td>
<td>25%</td>
</tr>
<tr>
<td>異なるブラウザでもデザインやユーザー体験が同一になるようにする</td>
<td>26%</td>
<td>28%</td>
<td>24%</td>
</tr>
<tr>
<td>複数のブラウザでテストを行う</td>
<td>23%</td>
<td>24%</td>
<td>20%</td>
</tr>
<tr>
<td>セキュリティ対策を理解し、実装する</td>
<td>23%</td>
<td>25%</td>
<td>20%</td>
</tr>
</tbody>
</table>
<p>各四半期の結果はほとんど同じです。</p>
<p>私にとって、このデータは、具体的に何を修正すべきかを教えてはくれませんが、どの分野の調査を深めればよいか分かる点で価値があります。</p>
<p>例えば、私は昨年、このデータの解釈として、「開発者にとって、プラットフォームレベルでも、ツールのエコシステムという点でも、変化やツールの数が多すぎる（両者は常に問題の上位に入っている）。この問題に対処する必要がある」と考えました。</p>
<p>上記のデータからは、開発者が利用するツールが、複数のブラウザにおけるテストや、ブラウザをまたぐ均一なユーザー体験を実現するには不十分であることも分かります。<a href="https://web.dev/compat2021/">Compat 2021</a>は、こうしたデータに基づいて私たちが構築したプログラムの1つであり、開発者はその成果に気づき始めていると言えるでしょう。しかし、このようなブラウザ間の互換性向上に関する取り組みが、開発者にとって有意義な変化をもたらしたかどうかを判断するには、まだ時期尚早であると考えられます。</p>
<h2>追記</h2>
<p>「Webサイトやアプリを開発するときに直面する最も大きな課題は何ですか？（3つ選択してください）」という質問に対する回答の結果全体。</p>
<table>
<thead>
<tr>
<th>課題</th>
<th>第1四半期 n=698</th>
<th>第2四半期 n=760</th>
<th>第3四半期 n=738</th>
</tr>
</thead>
<tbody>
<tr>
<td>WebプラットフォームやWeb標準の変化についていく</td>
<td>27%</td>
<td>26%</td>
<td>27%</td>
</tr>
<tr>
<td>大量の新しい（および既存の）ツールやフレームワークについていく</td>
<td>26%</td>
<td>26%</td>
<td>25%</td>
</tr>
<tr>
<td>異なるブラウザでもデザインやユーザー体験が同一になるようにする</td>
<td>26%</td>
<td>28%</td>
<td>24%</td>
</tr>
<tr>
<td>複数のブラウザでテストを行う</td>
<td>23%</td>
<td>24%</td>
<td>20%</td>
</tr>
<tr>
<td>セキュリティ対策を理解し、実装する</td>
<td>23%</td>
<td>25%</td>
<td>20%</td>
</tr>
<tr>
<td>よく実施する小さなタスクが自動化されていない</td>
<td>15%</td>
<td>17%</td>
<td>18%</td>
</tr>
<tr>
<td>能力が不足しているため、望ましいユーザー体験を生み出すことができない</td>
<td>15%</td>
<td>13%</td>
<td>18%</td>
</tr>
<tr>
<td>最新のWebテクノロジーを活用するための知識が不足している</td>
<td>16%</td>
<td>16%</td>
<td>17%</td>
</tr>
<tr>
<td>既存のツールやフレームワークの使用法を理解する</td>
<td>16%</td>
<td>14%</td>
<td>17%</td>
</tr>
<tr>
<td>望ましいパフォーマンスを達成するのが困難/不可能</td>
<td>11%</td>
<td>12%</td>
<td>17%</td>
</tr>
<tr>
<td>組織内においてWebへの取り組みを優先させる</td>
<td>15%</td>
<td>16%</td>
<td>16%</td>
</tr>
<tr>
<td>古いブラウザをサポートする</td>
<td>21%</td>
<td>23%</td>
<td>16%</td>
</tr>
<tr>
<td>参照資料やドキュメントが不足している</td>
<td>14%</td>
<td>13%</td>
<td>15%</td>
</tr>
<tr>
<td>開発者向けのツールが不足している/乏しい</td>
<td>11%</td>
<td>14%</td>
<td>15%</td>
</tr>
<tr>
<td>望ましいUIを実現するのが困難/不可能</td>
<td>14%</td>
<td>13%</td>
<td>15%</td>
</tr>
<tr>
<td>上記のいずれでもない上記のいずれでもない</td>
<td>3%</td>
<td>1%</td>
<td>1%</td>
</tr>
</tbody>
</table>
<ul>
<li>「古いブラウザをサポートする」が大幅に低下しているのは興味深い点です。</li>
</ul>
<h3>筆者について：Paul Kinlan</h3>
<p>GoogleのChrome Developer Relationsチームでリーダーを務めています。
私たちは、ユーザーがネイティブアプリをインストールしたり、クローズドプラットフォームの中でコンテンツを制作したりしなくても、Web上で可能な限り最高の体験を享受できるようにしたいと考えています。</p>
<p>私たちのチームが目指すのは、開発者がWeb上での開発を進めやすくすることです。そのために、すべてのChromeのリリースをサポートし、<a href="https://web.dev/">web.dev</a>上で開発者を支援するための優れたコンテンツを生み出し、MDNに貢献しているほか、ブラウザの互換性や、特に優れた開発者向けツール（ほんの数例を挙げるとLighthouse、Workbox、Squooshなど）の改善を支援しています。</p>]]></content:encoded></item><item><title><![CDATA[Core Web VitalsはWebを高速化したか？]]></title><description><![CDATA[Core Web Vitals（CWV）は2020年5月に発表されました。Googleはこの発表の中で、「より良いWebのためにページエクスペリエンスを評価する」と述べています。特に重要なのは、この…]]></description><link>https://postd.cc/have-core-web-vitals-made-the-web-faster/</link><guid isPermaLink="false">https://postd.cc/have-core-web-vitals-made-the-web-faster/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[CWV]]></category><pubDate>Mon, 14 Feb 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<style>
  .image-text {
    margin-left: 1rem;
    margin-right: 1rem;
  }
  .image-text, .image-text ul li {
    font-size: 0.6rem;
  }
</style>
<p><a href="https://web.dev/vitals/">Core Web Vitals（CWV）</a>は2020年5月に発表されました。Googleはこの発表の中で、「<a href="https://developers.google.com/search/blog/2020/05/evaluating-page-experience">より良いWebのためにページエクスペリエンスを評価する</a>」と述べています。特に重要なのは、この評価がGoogleの検索順位アルゴリズムの一部を構成することでした。つまり、高速なWebサイトは、同等の遅いWebサイトよりも順位が上になり、Google検索によるトラフィック（ほとんどのWebサイトにとってWebトラフィックの最も大きな部分を占める）が増えます。</p>
<p>Webパフォーマンスコミュニティは、Webパフォーマンスのビジネス上のメリットを売り込むことに関して、常にSEO業界に劣っていました。Webパフォーマンスがビジネスのパフォーマンスに<a href="https://wpostats.com/">直接影響を及ぼす証拠</a>が数多く存在するにもかかわらずです。しかし、今やSEO業界全体がWebパフォーマンスを重視するようになり、企業もWebパフォーマンスについて真剣に考えなければならなくなったのです。</p>
<p>Googleは2020年11月に次の発表を行い、<a href="https://developers.google.com/search/blog/2020/11/timing-for-page-experience">2021年5月までにWebサイトをCore Web Vitalsに対応させる必要があるという明確な期限を定めました</a>（モバイルサイトの場合。<a href="https://developers.google.com/search/blog/2021/11/bringing-page-experience-to-desktop">デスクトップ向けサイトは1年後の予定</a>）。</p>
<p>そうして、Core Web Vitalsが検索順位に影響を与えるようになってから約半年が経ちました。実際に、何らかの影響はあったのでしょうか？GoogleがSEOという大きな力を振るったことで、Webは高速化したのでしょうか？</p>
<p>確かに影響はあったと示唆するサクセスストーリーは数多く存在します。しかし、筆者は「クリスマス嫌いのグリンチ」（※訳注：米国の童話の登場人物）のようにひねくれ者なので、あまり納得できずにいます。</p>
<h2>Core Web Vitalsに肯定的な証拠</h2>
<p>筆者は<a href="https://httparchive.org/">HTTP Archive</a>のメンテナンスに関わっています。このプロジェクトはWebの状態のトラッキングを目指すものです。HTTP Archiveは毎月Webのクローリングを実行し、発見したさまざまな事実や数値を報告することでトラッキングを行っています。このプロジェクトでは主に3つの方法でデータを提供しています。</p>
<ol>
<li>すべての基礎データを<a href="https://github.com/HTTPArchive/httparchive.org/blob/main/docs/gettingstarted_bigquery.md">BigQueryのデータセットとして公開しています</a>。SQLに関する多少の知識があればクエリを実行できます。</li>
<li><a href="https://httparchive.org/reports">Webサイト上でレポートとしてさまざまな統計を提供しています</a>。</li>
<li><a href="https://calendar.perfplanet.com/2021/have-core-web-vitals-made-the-web-faster/#:~:text=report%20called%20the-,Web%20Almanac,-which%20is%20a">Web Almanac</a>というレポートを毎年公開しています。このレポートは、業界の専門家がデータを詳細に分析し、そこから読み取れることを報告するものです（<a href="https://almanac.httparchive.org/en/2021/">2021年版</a>は最近発表されたばかりです。ぜひご覧ください）。</li>
</ol>
<p>また、HTTP Archiveは<a href="https://developers.google.com/web/tools/chrome-user-experience-report">Chrome User Experience Report（CrUX）</a>データセットとも連携し、より多くのデータについて報告するためにCrUXを活用しています。CrUXは、実際にWeb VitalsがどのようにGoogleに報告されるのかを明らかにするものです。そのレポートの1つは、特に2021年5月の期限以降において、Core Web Vitalsを達成したWebサイトが増加したことを明確に示しています。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image8.png"></p>
<div class="image-text">
画像内訳
<em>Core Web Vitals（LCP、FID、CLS）の３つの指標すべてで「良好」なエクスペリエンスを達成したオリジンの割合。オリジンのFIDのデータがない場合、残りの指標のパフォーマンスに基づいて評価。</em>
</div>
<p>さらに、他にも統計は公表されています（筆者自身も統計を公表している1人です）。多くの統計はHTTP Archiveのデータに基づいており、特に<a href="https://datastudio.google.com/u/0/reporting/55bc8fad-44c2-4280-aa0b-5f3f0cd3d2be/page/M6ZPC">Core Web Vitals Technology</a>レポートを活用しています。このレポートは、テクノロジーを通じてデータの詳細分析を行うためにHTTP Archiveが作成したものです。これらの統計はいずれも、とても前向きなストーリーを示しています。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image3.png"></p>
<div class="image-text">
画像内訳
<em>Webのパフォーマンスは改善しているか？答えはYES :) 今やオリジンの33%がCore Web Vitalsのしきい値を達成！フレームワークを利用しているサイトも大幅に改善</em>
<ul>
  <li><em>現在、全体で33%のオリジンがCore Web Vitalsの推奨しきい値を達成</em></li>
  <li><em>昨年以降、Core Web Vitalsのしきい値を達成したオリジンは26%増加</em></li>
</ul>
</div>
<p>このように、問題の答えは明らかになりました。このとても短いブログ記事は、タイトルで提示した疑問（Core Web VitalsはWebを高速化したか？）に回答したことになります。記事を読んでいただき、ありがとうございました！</p>
<h2>あまり楽観的ではない見方</h2>
<p>いやいや、ちょっと待ってください。最初のグラフはCore Web Vitalsを達成したWebサイトの数を表しています。これをWebが高速化しているかどうかを示す代理データとして使用するには、いくつかの前提が必要です。</p>
<ul>
<li>Core Web Vitalsを達成するためのしきい値は変化していない（実際もほとんど変化していない）。</li>
<li>測定対象のWebサイトは同一（CrUXは「広く知られているかどうか」（popularity threshold）を定めており、対象は毎月変わるが、全体としては概ね同一）。</li>
<li>改善の主な理由はCore Web Vitalsである（ネットワーク全般の速度が改善したことや、パンデミックによって多くの人が家にこもり、ブロードバンド接続を利用するようになったことなどが理由ではない）。</li>
<li>Core Web Vitalsの測定方法は、測定期間を通じて一貫しており、大幅に変更されていない。</li>
</ul>
<p>特に気になるのは最後の項目です。Core Web Vitalsは<strong>生まれたばかり</strong>の指標です。<a href="https://twitter.com/anniesullie">Annie Sullivan</a>はちょうど2年前に、<a href="https://calendar.perfplanet.com/2019/developing-the-largest-contentful-paint-metric/">3つのCore Web Vitalsの1つ（LCP）がどのように開発されたかに関する記事</a>をWeb Performance Calendarに投稿しています。つまり、Core Web Vitalsは人間でいうところの「魔の2歳児」と呼ばれる時期です。そして、親なら誰でも知っているとおり、生まれてから2歳になるまでには多くの変化が起こります。</p>
<p>このような新しい指標を最初から完璧な形で導入するのは不可能です。GoogleのChromeチームは、特にSEOへの影響を考慮して、熱心にCore Web Vitalsの改善に取り組み、適切な測定ができていないケースに対処してきました。Core Web Vitalsは多くの点で改善されています（すべての改善点は<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/README.md">公開変更ログ</a>で明確に追跡できます）。</p>
<p><a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/lcp.md">Largest Contentful Paint（LCP）は、最大のコンテンツ要素を正しく特定するためにいくつかの点が変更されています</a>。非表示の画像や背景の画像は「コンテンツ」ではないものとして無視され、LCPの計算が停止するタイミングも変更されました。これらはすべて（プラスとマイナスの）影響を及ぼすとみられ、LCPの改善のグラフは最初に示したグラフよりも（特にモバイルで）やや横ばいとなっています。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image10.png"></p>
<div class="image-text">
画像内訳
<em>LCPエクスペリエンスが「良好」（2.5秒以下）であるオリジンの割合。</em>
</div>
<p><a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/fid.md">First Input Delay（FID）の変更点</a>は、LCPに比べると多くありません。ただし、Chromeが<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/2021_05_fid.md">ダブルタップによるズームの禁止</a>条件を変更したことはプラスの影響を及ぼしています。これは2021年5月にリリースされており、リリース直後からモバイルのFIDの数値に影響を与えていることが分かります。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image7.png"></p>
<div class="image-text">
画像内訳
<em>FIDエクスペリエンスが「良好」（100ミリ秒以下）であるオリジンの割合。CrUXのFIDを参照。</em>
</div>
<p>FIDは通常、Core Web Vitalsの中で達成するのが最も簡単です。そのため、多くの人（何よりも<a href="https://web.dev/better-responsiveness-metric/">Chromeチーム自身</a>）が、抜本的な変更が必要ではないかという疑問を提起しています。したがって、来年ごろにはFID（少なくともCore Web VitalsにおけるFID）に何らかの大きな変化があるでしょう。</p>
<p>最後に、3番目のCore Web VitalsであるCumulative Layout Shift（CLS）は最も大きく変更されています。CLSは、Cumulative（累積）という名称が示すとおり、以前はページが存在する限り増加し続けていました。これは、シングルページアプリケーション（SPA）が不当に不利な立場に置かれているという苦情の原因となりました。SPAのページは長期にわたって存続すると見込まれるためです。CLSに対する影響がわずかであっても、時とともに蓄積し、しきい値を超えて「改善が必要」や「不十分」となる可能性が高まります。</p>
<p>CLSは、<a href="https://web.dev/evolving-cls/">1回のセッションウィンドウの間の最大累積CLSのみを報告する</a>ように変更されました。実質的に、現在のCLSスコアはすべてのCLSシフトの合計ではなく、一定の時間におけるCLSシフトの最大の部分を示すものとなっています。この変更は2021年5月ごろのChrome 91でリリースされており、グラフでは同じ時期にCLSスコアが良好なサイトが急増しているのが分かります。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image2.png"></p>
<div class="image-text">
画像内訳
<em>CLSエクスペリエンスが「良好」（0.1以下）であるオリジンの割合。</em>
</div>
<p>2021年9月のChrome 93では<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/cls.md">さらなる改善点</a>がリリースされており、再びグラフが上昇しています。</p>
<p>指標の変更と同様に、測定のベースラインにも留意する必要があります。3つすべてのCore Web Vitalsを達成したAngularサイトの数が111%増加したのは結構なことですが、詳しく見てみると、<a href="https://datastudio.google.com/u/0/reporting/55bc8fad-44c2-4280-aa0b-5f3f0cd3d2be/page/M6ZPC?params=%7B%22df44%22:%22include%25EE%2580%25800%25EE%2580%2580IN%25EE%2580%2580Angular%22%7D">Angularサイト全体の3%から6%に増えただけ</a>であり、素晴らしい改善というには程遠いようです。しかも、これらの統計が示す改善がなされていないAngularサイトであっても、上記の指標の変更による恩恵を受けているはずです。</p>
<h2>Webは高速化したのか？</h2>
<p>これまで筆者は、気難しいエベニーザ・スクルージ（※訳注：小説『クリスマス・キャロル』の登場人物）のように、クリスマスに水を差してきました。そして、Core Web Vitalsが向上した理由は、単に測定方法が改善されたためである可能性があるので、プラスの影響を主張するのはやや時期尚早かもしれないことを示しました。しかし、実際に多くのサイトはパフォーマンスの改善に忙しく取り組んでいます。そのため、Core Web Vitalsの向上の理由はすべて測定方法にあると主張するのは、逆の方向に極端であり、あまりに悲観的過ぎるかもしれません。では、指標の定義の大幅な変更を踏まえ、測定方法による影響と真のパフォーマンスの向上を分離し、Web全体が改善したのかを確認するにはどうすれば良いのでしょうか？</p>
<p>そのための方法の1つは、従来のより安定した指標に回帰し、それを読み解くことです。真新しく光るLCP、FID、CLSという指標が舞台に突然現れスポットライトを浴びる以前、Webパフォーマンスコミュニティでは、<a href="https://web.dev/first-contentful-paint/">First Contentful Paint</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/Events/load">onLoad</a>、<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/DOMContentLoaded_event">edDOMContentLoad</a>、<a href="https://web.dev/lighthouse-total-blocking-time/">Total Blocking Time</a>、<a href="https://web.dev/interactive/">Time to Interactive</a>など多くの他の指標に頼っていました。筆者のお気に入りの1つは<a href="https://web.dev/speed-index/">Speed Index</a>です。</p>
<p>誤解のないように言うと、筆者はCore Web Vitalsの方が<strong>はるかに</strong>優れた指標だと考えています。Core Web Vitalsの3つの指標は、ユーザー体験の代わりとなることを意図した恣意的で細かな数値ではなく、ユーザーにとって意味のある影響を測定しようとしています。ユーザーはDOMがいつ読み込まれるかなどといったことは気にしません。ユーザーが気にするのは、目的のコンテンツがページにいつ表示されるかです。特に、ラボベース（※訳注：開発者内部の環境下で行われるモニタリング）の完全に人為的な測定から、リアルユーザモニタリング（RUM）ベースの現場での測定への転換は非常に大きな進歩です。ラボベースのテストがユーザー体験の良い指標となるように膨大な仮定を置く必要がなく、ユーザーが体験する実際のWebパフォーマンスを報告できるのはとても良いことです。</p>
<p>しかし、これまで見てきたとおり、この記事で挙げている疑問に答えるには、新たな指標は変動が大き過ぎると言わなければなりません。新しい指標は優れていますが、古い指標が役に立たなかったわけではありません。Webパフォーマンスが改善されれば、古い指標にもプラスの影響があるはずです。そこで、これらの指標を詳しく調べ、何が分かるのかを見ていきましょう。</p>
<p>筆者はSpeed Indexがお気に入りの「昔ながらの」指標だと述べました。Speed Indexは基本的に、読み込み中のページのスクリーンショットを保存して、変化ごとのページの「完成度」を計算し、それを使用してページの読み込みに関するスコアを算出するものです。ロゴなどわずかな一部を除いてほとんど読み込みが終わっているページと、最後まで一切描画されないページを比べると、一部の指標（onLoad、DOMContentLoadedなど）は同じであっても、Speed Indexでは前者の方が良い数値になります。</p>
<p>このように、Speed IndexはLCPの測定対象とそれほど違っておらず、CLSの一部も含まれています。LCPに影響する要素の読み込みが速く、読み込み中のビューポート内のコンテンツがあまり移動しなければ、Speed Indexも改善するでしょう。Annieは、上記の過去の記事で、Speed IndexがCore Web Vitalsとして使用されず、代わりにLCPが考案された主な理由として「Speed Indexを実行するのは大きなコストがかかり、リアルタイムで利用できないこと」を挙げています。Speed Indexはあくまでラボベースの指標なのです。</p>
<p>HTTP Archiveは2016年から、調査の一環としてSpeed Indexを算出しています。Speed Indexがラボベースであるという事実は、RUMベースの指標に影響を与える一部の変動やノイズに左右されないことを意味します。このような変動やノイズには、例えばネットワーク速度の改善や、パンデミックによってモバイルネットワークよりも家庭用のWi-Fiを利用した在宅勤務が増えていることなどがあります。HTTP Archiveの調査ではこうした要素が除去されています。クローリングに使用するハードウェアや、ネットワークの調査手法に（とても）一貫性があるからです。</p>
<p>注意すべき点として、HTTP Archiveは、Speed Indexの独自の定義を定めている<a href="https://www.webpagetest.org/">WebPageTest</a>（WPT）を利用しています。これは（WPTの定義を基礎とする）Lighthouseの定義とはわずかに異なります。WPTは色ヒストグラムを利用しているため、（コンテンツがビューポートの内外を移動しない限り）コンテンツの移動による影響をあまり受けません。一方、Lighthouse版はより複雑な<a href="https://www.imatest.com/docs/ssim/">構造的類似性</a>（SSIM）指数を利用しており、コンテンツの移動による影響を受けやすくなっています。</p>
<p>Speed IndexのグラフはHTTP ArchiveのWebサイトでは提供していませんでした。しかし、データは既に収集してあったので、この記事を作成する一環として<a href="https://httparchive.org/reports/loading-speed#speedIndex">グラフを追加しました</a>。以下がそのグラフです（数値は低いほど良い）。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image6.png"></p>
<div class="image-text">
画像内訳
<em>ページのコンテンツが視覚的に表示される速度。この指標はWebPageTestによるものであり、（WebPageTestの定義を基礎とする）Lighthouse版とはわずかに異なる。</em>
</div>
<p>グラフは筆者が恐れていたことを示しています。Core Web Vitalsの代わりに変動の小さいSpeed Indexで測定したところ、Core Web Vitalsの導入以降、Webは全体として大幅に高速化してはいないようです。それどころか、モバイルでは2021年6月以降にSpeed Indexも悪化しています。</p>
<p>HTTP Archiveによる<a href="https://httparchive.org/reports/loading-speed">読み込み速度レポート</a>では、他の指標も同様の結果を示しています。実質的な変化はなく、First Contentful Paintがある程度改善した程度にとどまりました（ただし、この指標も<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/speed/metrics_changelog/fcp.md">最近変更がありました</a>）。Time to InteractiveもWebサイトの応答時間の長期化を示しています（恐らく<a href="https://almanac.httparchive.org/en/2021/javascript#how-much-javascript-do-we-load">JavaScriptの使用が多過ぎる</a>ためでしょう）。この傾向はCore Web Vitalsが登場する以前から続いているものです。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image9.png"></p>
<div class="image-text">
画像内訳
<em>操作が開始された時点から、CPUが5秒以上停止するまでの秒数。この指標はLighthouseによるもので、モバイルのテストでのみ利用できる。</em>
</div>
<h2>とても残念な結果に思えるが……</h2>
<p>以上のように、Googleや、同社の最も人気のあるWebブラウザや検索エンジンの絶大な影響力をもってしても、パフォーマンスを改善できていないようです。これはとても残念な結果であり、Webパフォーマンスマニアのクリスマスを台無しにしてしまったことを申し訳なく思います……。しかし、筆者はそこまで残念だとは思っていません。ですから、この記事はもっと明るい雰囲気で終わらせましょう。</p>
<p>HTTP ArchiveとCrUXのデータの重要な違いは、HTTP Archiveがホームページのみをクローリングしているという点です。CrUXのデータは、Webサイト全ページの実際の利用状況に基づいています。この取り組みの優れた点の1つは、ホームページ以外のパフォーマンス指標を明らかにしているところにあります。過去のWebパフォーマンス測定ツールでは、ホームページのみを測定対象としていた場合もあったはずです。</p>
<p>かつてのパフォーマンス測定ではホームページばかりが注目されていたことや、ホームページは比較的シンプルなので問題がある可能性が低いことは、十分にあり得ます。もしかすると、筆者が悲観的過ぎるだけであって、上記のCrUXデータの方が、ユーザーが体験した実際のパフォーマンスの改善状況をよく表しているのでしょうか。筆者は、真実はその中間にあるとみています。しかし、胸に手を当てて考えてみると、HTTP Archiveのクローリングによるグラフの方が恐らく真実に近いでしょう。ただし、指標が成熟するにつれて変化が小さくなると仮定すれば、将来的にはCrUXベースのグラフは大いに興味深いものになるとみられます。</p>
<p>どれほどの影響力を持っていても、Web全体で何かを変えるのは困難です。<a href="https://httparchive.org/reports/state-of-the-web#numUrls">HTTP Archiveはクローリングの一環として750万件以上のWebサイトをクロールしています</a>。そして、WebパフォーマンスやSEOのコミュニティがパフォーマンスについて大騒ぎをしていたにもかかわらず、大部分のサイトはその間も大きく変化してはいないでしょう。一方で、変化したサイトも数多く存在するため、Webサイトは実際に高速化したのかもしれません。しかし、それはまだWeb全体を見た場合に有意義な影響を与えられるほど十分な規模ではありません。</p>
<p>筆者はCore Web Vitalsを気に入っており、優れた指標だと考えています。また、GoogleによるCore Web Vitalsへの投資や、同社がWebサイトに対して改善に向けた圧力をかけていることも評価しています。たとえその取り組みの一部に不満があったとしてもです（Google Search Consoleにおけるページのグルーピングの不透明さは大いに不満です）。指標が依然として発展途上であるという指摘は、批判ではなく、とても前向きなものです。この事実は、Core Web Vitalsは変化を拒むものではなく、あくまでWebパフォーマンスの改善に向けた次のステップだという認識を示しており、だからこそ前進できるのです。</p>
<p>たとえ上記のHTTP Archiveのデータに対する影響がまだ表れていないとしても、Webパフォーマンスに関する議論が大幅に増えたのは事実です。そして、こうした議論が今や、比較的小さいWebパフォーマンスコミュニティ（いつでも歓迎します！）の外でも行われるようになったのは素晴らしいことです。</p>
<h2>最後にうれしいニュースを紹介</h2>
<p>上位1,000件のWebサイトを見てみると、Core Web Vitalsを達成したWebサイトの割合は全体よりも大幅に上昇していることが分かります。2021年5月以降の改善割合は、モバイルWebサイト全体では32.8%ですが、上位1,000件のサイトでは37.1%となっています。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image5.png"></p>
<div class="image-text">
画像内訳
<em>Core Web Vitals達成割合の時系列データ</em>
</div>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image1.png"></p>
<div class="image-text">
画像内訳
<em>上位1,000件のサイトのCore Web Vitals達成割合の時系列データ</em>
</div>
<p>当然ながら、大規模なサイトほど予算も多く（改善のインセンティブも大きく）、SEOのトレンドをより正確に把握しているかもしれません。また、こうしたサイトは指標の改善による影響が比較的大きい場合があるという事実が一因となっている可能性もあります。しかし、それでも筆者はこれを前向きな兆候と捉えています。こうしたサイトが先頭を進み、他のWebサイトがそれを追いかけるというトリクルダウン効果が起きるのはよくあることです。</p>
<p>また、Wixなどの一部のプラットフォームは、<a href="https://www.smashingmagazine.com/2021/11/improving-performance-wix-websites-case-study/">パフォーマンスを改善するための取り組みに膨大な労力を費やしています</a>。これらのWebサイトの取り組みは、HTTP ArchiveのSpeed Indexのスコアに反映されています（これは、Speed Indexを使用するという筆者の判断を正当化するのに役立っており、Speed IndexがCrUXに比べて実情を反映していないのではないかという筆者の懸念をある程度緩和するものです）。</p>
<p><img src="https://calendar.perfplanet.com/images/2021/barry/image4.png"></p>
<p>一度に1つのプラットフォームのみに注目するよりも、（<a href="https://datastudio.google.com/u/0/reporting/55bc8fad-44c2-4280-aa0b-5f3f0cd3d2be/page/M6ZPC?params=%7B%22df44%22:%22include%25EE%2580%25800%25EE%2580%2580IN%25EE%2580%2580Angular%22%7D">Core Web Vitals Technology Report</a>が示すように）その他のプラットフォームの相対的な改善度合いに注目する方が指標として優れているかもしれません。しかし、<a href="https://twitter.com/igrigorik/status/1415340002494402564?s=20">多少の競争がある</a>のはきっと良いことです。</p>
<p>恐らくもっと興味深い点として、<a href="https://almanac.httparchive.org/en/2021/cms#fig-6">Web全体の3分の1に利用されている</a>WordPressは最近、「<a href="https://make.wordpress.org/core/2021/10/12/proposal-for-a-performance-team/">パフォーマンス改善提案チーム</a>」を立ち上げました。これはWixなどが強調しているパフォーマンスの改善に対応して、WordPressが後れを取っているという印象を避けるためです。WordPressはまさに「Webを動かす」力を持っており、そのことは<a href="https://twitter.com/rick_viscomi/status/1344380340153016321?s=20">ネイティブLazyload</a>の導入にも表れています（ただし、大いなる力には大いなる責任が伴うもので、<a href="https://web.dev/lcp-lazy-loading/">導入の方法がやや稚拙だったという証拠もあります</a>）。</p>
<h2>そろそろ質問に答えてくれ！</h2>
<p>結局、Core Web VitalsによってWebは高速化したのでしょうか？筆者はイエスだと考えていますが、Core Web Vitalsの一部のデータが示すほど数値は明確に改善してはいません。しかし、この記事で言及した一部のプラットフォームの例に追随するプラットフォームが増え、Webパフォーマンスへの投資が増加すれば、上記の数値も間違いなく追いつくでしょう。もしかすると、来年のブログ記事はもっと短くなり、すべてうまくいっていると述べるだけになるかもしれません。それまでは、指標から読み取れることをしっかりと理解し、出来過ぎた話には疑問を持つようにしてください。たとえ、それが本当であってほしいと望むストーリーであってもです。</p>
<p><em>この記事のために質問に答えてくれたこと、また言うまでもなく、Speed Index、WebPageTestや、その他にもWebパフォーマンスを測定・改善するための素晴らしいツールを数多く作成してくれたことについて、<a href="https://twitter.com/patmeenan">Patrick Meenan</a>にとても感謝しています。</em></p>]]></content:encoded></item><item><title><![CDATA[Rustのビルドを高速化する方法]]></title><description><![CDATA[Rustコードのコンパイルが遅いことは誰でも知っています。しかし筆者は、世の中のほとんどのRustコードはコンパイルをもっと速くできると強く感じています。 例えば、つい最近の記事にこのように書かれて…]]></description><link>https://postd.cc/fast-rust-builds/</link><guid isPermaLink="false">https://postd.cc/fast-rust-builds/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[Rust]]></category><pubDate>Mon, 24 Jan 2022 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>Rustコードのコンパイルが遅いことは誰でも知っています。しかし筆者は、世の中のほとんどのRustコードはコンパイルをもっと速くできると強く感じています。</p>
<p>例えば、つい最近の<a href="https://kerkour.com/blog/rust-development-workflow/">記事</a>にこのように書かれていました。</p>
<blockquote>
<p>一方、Rustでは、プロジェクトやCIサーバーの性能にもよりますが、
CIパイプラインの実行に15～45分かかります。</p>
</blockquote>
<p>これは筆者には理解できません。GitHub Actions上にあるrust-analyzerのCIの所要時間は8分です。しかも、これは100万行の依存関係に加え、20万行の独自コードが記述されたとても大規模で複雑なプロジェクトでの話です。</p>
<p>確かに、Rustは根本的な部分で非常にコンパイルが遅いのは間違いありません。Rustは<a href="https://research.swtch.com/generic">ジェネリクスのジレンマ</a>において「遅いコンパイラ」を選び、全体的な設計思想としてコンパイル時間よりもランタイムを優先しています（この点に関する優れたシリーズ記事を紹介します：<a href="https://pingcap.com/blog/rust-compilation-model-calamity">1</a>、<a href="https://pingcap.com/blog/generics-and-compile-time-in-rust">2</a>、<a href="https://pingcap.com/blog/rust-huge-compilation-units">3</a>、<a href="https://pingcap.com/blog/reasons-rust-compiles-slowly">4</a>）。しかし、rustcは低速なコンパイラではありません。rustcは業務用コンパイラの中で最も<a href="https://blog.jetbrains.com/kotlin/2020/09/the-dark-secrets-of-fast-compilation-for-kotlin/#:~:text=I%20think%20Rust%20qualifies%20as%20a%20counter%20example%20here">先進的なインクリメンタルコンパイル手法</a>を導入し、適切なモジュール（クレート）に基づくコンパイルモデルを活用しており、<a href="https://blog.mozilla.org/nnethercote/2020/09/08/how-to-speed-up-the-rust-compiler-one-last-time/">細かい部分まで最適化されています</a>。Rustプロジェクトの高速なコンパイルは、たとえ一般的ではなくても現実に可能です。ただし、それにはいくつかの注意点と専門知識が必要です。</p>
<p>それでは、私たちがrust-analyzerのコンパイル時間を妥当な範囲に収めるために実施した対策を詳しく見ていきましょう。</p>
<h2>ビルド時間を気にする理由</h2>
<p>筆者が明確にしておきたいのは、プロジェクトのビルド時間を最適化するのは、ある意味ではあまり価値のない取り組みだという点です。コンパイル時間を削減しても、ユーザーにとっての<strong>直接的</strong>なメリットはごくわずかで、あくまで本質から外れた問題にすぎません。</p>
<p>とはいえ、コンパイル時間はほぼすべての作業の所要時間を<strong>倍増</strong>させます。追加機能の搭載、コードの高速化、要件変更への対応や、新しいコントリビュータの勧誘にもビルド時間が関わってきます。</p>
<p>コンパイル時間には間接的な影響もあります。コンパイラの作業を待つだけなら比較的小さな問題です。大きな問題は、コードのコンパイルの間に、集中力が失われたり、さらに悪いことに気分が変わって別の作業をしたくなったりすることです。コンパイラにとっては1分の仕事でも、人間にとっては1分以上の時間が無駄になります。</p>
<p>こうした影響を定量化するのは困難ですが、直感的にはプロジェクトの1人当たりのコードが数千行を超えると、ビルド時間は非常に重要になると思います。</p>
<p>ビルド時間の最も恐ろしい特徴は、気づかないうちに増大する点です。プロジェクトが小規模なうちは、ビルド時間は許容できる範囲にとどまるでしょう。プロジェクトが成長するにつれて、ビルド時間もゆっくりと増加し始めます。放っておくと、後でコントロールできる状態に戻そうとしても困難になる恐れがあります。</p>
<p>プロジェクトのコンパイル時間がすでに許容できないほど遅くなっている場合は、以下のような事態を招きます。</p>
<ul>
<li>ビルド時間の改善には時間がかかります。なぜなら、「変更を試し、ビルドを実行して、改善度を測定する」ためのイテレーションに毎回長い時間がかかるからです（ビルド時間はすべての作業の所要時間を倍増させますが、それにはビルド時間自体も含まれます）。</li>
<li>簡単に成果を上げるのは難しいでしょう。ランタイムのパフォーマンスとは異なり、パレートの法則は機能しません。1,000行のコードのうち、パフォーマンスに影響するのは100行かもしれませんが、コンパイル時間は1行ごとに増えます。</li>
<li>ビルド時間がわずかに短縮されても、それが十分に蓄積するまでは、取るに足らないと感じられるでしょう。コンパイル時間を5秒削減できたとして、元々のビルド時間が5分であれば非常に大きな成果ですが、1時間であればそうでもありません。</li>
<li>同様に、ビルド時間がわずかに増加しても誰も気づきません。</li>
</ul>
<p>これには文化的な要因もあります。あなたがプロジェクトに参加して、そのCIに1時間かかるとしたら、1時間のCIは普通だと思うようになるでしょう。</p>
<p>うれしいことに、ビルド時間の問題を解決するには簡単なコツがあります。</p>
<h2>銀の弾丸</h2>
<p>ビルド時間は、問題になる<strong>前</strong>から注視し、修正する必要があります。ビルド時間の短縮は、最適化に関する問題としてはかなり簡単です。直接的なフィードバックを得る方法は明確で（ビルド時間を測るだけです）、プロファイリングツールも数多く存在し、目安となるベンチマークを考案する必要さえありません。課題となるのはコンパイラ全般のパフォーマンスの向上ではなく、特定のプロジェクトのビルド時間の最適化です。一般に、ビルド時間の最適化のように本質的でない問題では、ほとんどのケースでこのような好ましい特徴が見られます。つまり、エンジニアリング問題としての定義が明確で、その解決策もよく知られている傾向があります。</p>
<p>コンパイル時間に関して唯一難しいのは、実際に問題になるまで、それが問題だと認識できない点です。ですから、この記事から学べる最も有益なポイントは、もしあなたがRustプロジェクトに取り組んでいるなら、今日はビルドの最適化のためにある程度時間をとり、今後もなるべく、たまには最適化を行うべきだということです。</p>
<p>これでソフトウェアエンジニアリングの話は終わったので、ようやく実用的なプログラミングのアドバイスに入ることができます。</p>
<h2>bors</h2>
<p>筆者は、注目すべき主要な指標の1つとして好んでCI実行時間を利用します。</p>
<p>理由の1つはCI時間それ自体が重要だからです。機能の開発がCIに制約されない場合でも、CI時間は1つの作業を終えて次の作業を始めるための意識の切り替えによる負担に直接影響します。CI完了を待ちながら、5件のプルリクエスト（PR）を同時並行で処理するのは生産的ではありません。またCIが長くなると、作業を独立したまとまりに分割しにくくなります。1つのタイポを訂正するのにPRタブを30分開いておく必要があるなら、次の機能のブランチで修正を実行する方が良いでしょう。</p>
<p>しかし、それより大きな理由は、CIが標準的なベンチマークになることです。ローカル環境では、コンパイルは徐々に行われ、変更の内容によってビルド時間は大きく異なります。通常、コンパイルするのはプロジェクトの一部です。こうした変動が避けられないため、ローカル環境におけるビルドでは、ビルド時間に関する継続的なフィードバックを十分に得られません。一方、標準化されたCIはすべての変更に対して実行されるので、直接比較可能なデータを時系列で把握できます。</p>
<p>CIによる標準化を推進するには、“<a href="https://graydon2.dreamwidth.org/1597.html">ロケットサイエンスのルール</a>”ではなく、メインブランチのあらゆる段階でCIを確実に実行するためのマージボットの設定をお勧めします。筆者は特に<a href="https://bors.tech/">bors</a>をよく導入していますが、他の方法もあります。</p>
<p>borsのようなツールには、（導入の決め手には全くなりませんが）妥当なコンパイル時間を実現するうえで2つのメリットがあります。</p>
<ul>
<li>あらゆる変更に対してCIが確実に実行されるようにし、全体的なCIの健全性の維持を推進します。</li>
<li>PRに<code class="language-text">r+</code>コメントを付けてから「PR merged」の通知を受け取るまでの時間を常にフィードバックループで活用できます。わざわざビルド時間を測定する必要はなく、あらゆるPRがビルドのベンチマークとなります。</li>
</ul>
<h2>CIキャッシング</h2>
<p>考えてみれば、優れたキャッシング戦略がCIにとって有効なのはどう見ても明らかです。めったに変更されないものをキャッシュするのは理にかなっていますが、頻繁に変更されるものをキャッシュしても無意味です。つまり、依存関係はすべてキャッシュすべきですが、プロジェクト自体のクレートはキャッシュすべきではありません。</p>
<p>しかし、残念なことに、これを実践している人はほとんどいません。<a href="https://github.com/actions/cache/blob/main/examples.md#rust---cargo">よくあるのが</a><code class="language-text">./target</code>ディレクトリ全体をキャッシュしているケースです。これは間違っています。<code class="language-text">./target</code>はサイズが大きく、その大部分はCIには不要です。</p>
<p>とはいえ、修正するのはそれほど簡単ではありません。悲しいことに、Cargoを使用しても、<code class="language-text">./target</code>のどの部分が持続的な依存関係で、どの部分が変更されやすいローカルなクレートであるかを容易には判別できません。ですから、キャッシュを保存する前に<code class="language-text">./target</code>を整理するための<a href="https://github.com/rust-analyzer/rust-analyzer/blob/94d9fc2a28ea5d97e3a9293b9dac05bdb00304cc/xtask/src/pre_cache.rs#L30-L53">コード</a>を書く必要があります。特にGitHub Actionsでは<a href="https://github.com/Swatinem/rust-cache">Swatinem/rust-cache</a>も利用できます。</p>
<h2>CIワークフロー</h2>
<p>キャッシングは通常、簡単に大きな成果を上げられます。しかし、他にも微調整できる点はいくつか存在します。</p>
<p>まず、CIを<code class="language-text">cargo test --no-run</code>と<code class="language-text">cargo test</code>に<a href="https://github.com/rust-analyzer/rust-analyzer/blob/48f84a7b60bcbd7ec5fa6434d92d9e7a8eb9731b/.github/workflows/ci.yaml#L56-L61">分割</a>します。CIのどの部分がビルドで、どの部分がテストかを把握するのは必要不可欠です。</p>
<p>次に、インクリメンタルコンパイルを<a href="https://github.com/rust-analyzer/rust-analyzer/blob/25368d24308d6a94ffe8b99f0122bcf5a2175322/.github/workflows/ci.yaml#L11">無効化</a>します。CIビルドはスクラッチビルドに近いケースが多いです。通常、変更はローカルな編集とコンパイルのサイクルよりはるかに大規模になるからです。スクラッチビルドでは、インクリメンタルコンパイルによって、新たな依存関係を追跡するオーバーヘッドが増えます。IOの量と<code class="language-text">./target</code>のサイズも大幅に増加し、キャッシングの有効性が低下します。</p>
<p>debuginfoを<a href="https://github.com/rust-analyzer/rust-analyzer/blob/48f84a7b60bcbd7ec5fa6434d92d9e7a8eb9731b/Cargo.toml#L6-L10">無効化</a>するのも有効です。debuginfoは<code class="language-text">./target</code>のサイズを大幅に増大させるため、やはりキャッシングにとって悪影響です。望ましいワークフローに応じて、debuginfoを無条件に無効化することを検討しても良いでしょう。ローカル環境でのビルドにとっても一定のメリットがあります。</p>
<p>ついでに、<code class="language-text">-D warnings</code>を<code class="language-text">RUSTFLAGS</code>環境変数に<a href="https://github.com/rust-analyzer/rust-analyzer/blob/3dae94bf2b3e496adb049da589c7efef272a39b8/.github/workflows/ci.yaml#L15">追加</a>して、すべてのクレートの警告をまとめて拒否しましょう。<code class="language-text">#![deny(warnings)]</code>をコードに追加するのは良いアイデアではありません。すべてのクレートで同じことを繰り返さなければならず、ローカルの開発を不必要に困難にし、ユーザーがコンパイラをアップグレードする際に気力をそがれる恐れがあります。Cargoネットワークのリトライ回数を増やすのも有効かもしれません。</p>
<h2>Lockfileを読み込む</h2>
<p>他のアドバイスとしては、当然のことですが、利用する依存関係の数を減らし小規模化すると良いでしょう。</p>
<p>ただし、これには微妙な点があります。ライブラリは実際に問題を解決するものです。crates.ioで解決済みの問題に自分でソリューションを導入するのはばかげています。そして、あなたのソリューションがより小規模である保証はありません。</p>
<p>しかし、アプリケーションが解決しようとしている問題と、そうでない問題を認識するのは重要です。数千人が利用するCLIユーティリティを構築している場合、<a href="http://clap.rs/">clap</a>とそのすべての機能は絶対に必要です。一方、CIの間に実行する簡単なスクリプトを書いていて、それがチームにしか使用されない場合、コマンドラインのパーシングを単純にして、ビルドを高速化しても構わないでしょう。</p>
<p>これに関して、<code class="language-text">Cargo.lock</code>（Cargo.tomlではありません）を読み、それぞれの依存関係が自分のアプリケーションを使用する人たちにとってどんな実際の問題を解決するか考えてみるのは、とても有用なトレーニングとなります。<strong>自分の環境</strong>では依存関係が全く意味を持たないのに気づくのは非常によくあることです。</p>
<p>例を挙げると、rust-analyzerはregexに依存していますが、これは無意味です。私たちには RustとMarkdown向けの厳密なパーサーとレキサーがあるため、ランタイムで正規表現を解釈する必要はありません。さらに、regexは小規模な言語を丸ごと導入するため、依存関係がかなり重いクレートの1つです。この依存関係が存在する理由は、私たちが利用しているロギングライブラリにおいて、以下のような記述が可能になるためです。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">RUST_LOG=rust_analyzer=very complex filtering expression</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>この場合、フィルタリング式のパーシングは正規表現によって行われます。</p>
<p>これは一部のアプリケーションにとって間違いなくとても便利な機能ですが、rust-analyzerに関しては不要です。<code class="language-text">env_logger-</code>の単純なフィルタリングで十分でしょう。</p>
<p>同様に冗長な依存関係を特定したら、どこかのfeaturesフィールドを微修正するか、PRを上流に送信して不必要な部分を変更可能にすれば十分です。</p>
<p>時にはもっと大規模なyak shaving（※訳注 問題を解決しようとすると別の問題が出てきて、それを解決しようとするとさらに別の問題が出てくるという繰り返しのこと）が必要な場合もあります。例えば、rust-analyzerはオプションでjemallocクレートを利用しており、そのビルドスクリプトは<a href="https://docs.rs/fs_extra">fs_extra</a>と（よりによって）<a href="https://docs.rs/paste">paste</a>を呼び出します。ここでの理想的な解決策はもちろん、堅牢で安定した純正なrustメモリアロケータの導入です。</p>
<h2>最適化の前にプロファイリングを</h2>
<p>ここまで常識的な対策を実施してきたので、そろそろビルド時間を削減する前に測定してみましょう。今回使用するツールはCargoのtimingsフラグです（<a href="https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#timings">ドキュメントはこちら</a>）。悲しいことに、筆者はこの機能の質の高さと洗練性を十分に表現できるだけの雄弁さを持ち合わせていません。そこで、ここでは愛 ❤️ を表明するだけにとどめ、ドライに説明を続けさせてください。</p>
<p><code class="language-text">cargo build -Z timingsは</code>、ビルド中のプロファイリングデータを記録し、それをとても読みやすくて情報が詰まったHTMLファイルとして出力します。これはナイトリー版の機能であるため、<code class="language-text">+nightly</code>トグルが必要です。とはいえ、ときどき手動で実行すればよいだけなので、実際は問題ありません。</p>
<p>以下はrust-analyzerの例です。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">cargo +nightly build -p rust-analyzer --bin rust-analyzer \
  -Z timings –release</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<p><img src="https://matklad.github.io/assets/cargo-timings.png"></p>
<p>各クレートのコンパイルにどれだけ時間がかかったかだけでなく、個々のコンパイルがどのようにスケジューリングされ、各クレートのコンパイルがいつ開始されたかや、クリティカルな依存関係も分かります。</p>
<h2>コンパイルのモデル：クレート</h2>
<p>ここからは重要な最後のポイントを説明します。クレートは依存関係の有向非巡回グラフを形成し、マルチコアのCPUではこのグラフの形状がコンパイル時間に大きく影響します。</p>
<p>以下はすべてのクレートを順番にコンパイルする必要があるため、コンパイルに時間がかかります。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">A -&gt; B -&gt; C -&gt; D -&gt; E</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>一方、以下のグラフでは並列処理が可能な部分が大幅に増えるため、コンパイルははるかに速くなります。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">   +-  B  -+
  /         \
A  -&gt;  C  -&gt;  E
  \         /
   +-  D  -+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>並列処理とインクリメンタリティにも関係があります。2番目の大きいグラフでは、Bを変更してもCとDを再びコンパイルする必要はありません。</p>
<p>Rustのコンパイル時間について不満を言うと、最初に返ってくるアドバイスは「コードをクレートに分割しよう」です。しかし、これはさほど簡単ではありません。最初のグラフのような形状になっている場合、大きな成果は見込めません。アプリケーションを2番目のグラフのように構築するのが重要となります。つまり、共通用語のクレート、複数の独立した機能、そしてすべてを繋ぐ「葉」の役割を果たすクレートから成る構造です。クレートの最も重要なプロパティは、そのクレートが（推移的に）依存していないクレートはどれかということです。</p>
<p>もう1つの重要な検討事項は、最終的なアーティファクト（最も一般的にはバイナリ）の数です。Rustは静的リンク方式であるため、2つの異なるバイナリが同一のライブラリを使用する場合、各バイナリにはそれぞれ別にリンクされたライブラリのコピーが含まれます。仮にn個のバイナリとm個のライブラリが存在し、各バイナリが各ライブラリを使用するとき、リンクを作成する際の作業量は<strong>m * n</strong>です。そのため、アーティファクトの数は最小限に抑えると良いでしょう。よくあるテクニックの1つが、<a href="https://www.busybox.net/FAQ.html#design">BusyBox</a>のような多機能ナイフ型の実行可能ファイルです。このアイデアは、同じ実行可能ファイルを、異なる名前を持つ複数のファイルとしてハードリンクするものです。プログラムは0番目のコマンドライン引数を参照することで、自らが呼び出されたファイル名を把握し、それをサブコマンドの名前として有効に利用できます。ただし、Cargoに特有の注意点として、<code class="language-text">./examples</code>と<code class="language-text">./tests</code>フォルダ内の各ファイルはデフォルトで新たな実行可能ファイルを作成します。</p>
<h2>コンパイルのモデル：マクロとパイプライン化</h2>
<p>しかし、Cargoにはそれ以上にスマートな機能があります。それはコンパイルのパイプライン化です。Cargoはクレートのコンパイルをメタデータとコード生成の段階に分け、メタデータの段階が終わるとすぐに依存するクレートのコンパイルを開始します。</p>
<p>このとき、手続きマクロ（とビルドスクリプト）との間に面白い関係が発生します。<code class="language-text">rustc</code>はクレートのメタデータを計算するために手続きマクロを実行する必要があります。これは手続きマクロがパイプライン化できないことや、手続きマクロが完全にコンパイルされてバイナリコードになるまで、その手続きマクロを使用するクレートがブロックされることを意味します。</p>
<p>一方、手続きマクロはRustコードをパースする必要がありますが、これはかなり複雑なタスクです。この機能を担うデファクトスタンダードのクレートである<code class="language-text">syn/serde</code>はコンパイルに長い時間がかかります（肥大化しているからではなく、単純にRustのパーシングが難しいからです）。</p>
<p>これは一般に、プロジェクトにおいて、コンパイル中のCPU稼働率のプロファイルに <code class="language-text">syn/serde</code> は大きく穴をあける傾向にあることを意味します。（訳注: syn/serde によって、 コンパイル中にCPUに対して大きく負荷がかかります）そのため、手続きマクロはそれが十分に活用される場合のみ使用し、<code class="language-text">cargo -Z timings</code>グラフで<code class="language-text">syn</code>の前にクレートを配置することがかなり重要です。</p>
<p>ただし、後者は難しい場合があります。手続きマクロの依存関係はいつの間にか増大する可能性があるからです。こうした依存関係はフィーチャーフラグに隠れていることが多く、それらのフィーチャーフラグが川下のクレートによって有効化されるケースが問題となります。以下の例を考えてみましょう。</p>
<p>便利なユーティリティ型、例えばSSO文字列が<code class="language-text">small_string</code>クレートに存在するとします。シリアル化を実装するには、実は継承は必要ないため（Stringへの委譲で十分です）、<code class="language-text">serde</code>との（任意の）依存関係を追加します。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[package]
name = &quot;small-string&quot;

[dependencies]
serde = { version = &quot;1&quot; }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>SSO文字列は非常に便利な抽象型なので、コードベース全体で使用されます。その後、例えばJSON APIを公開する必要がある葉のクレートに、<code class="language-text">serde</code>フィーチャーを持つ<code class="language-text">small_string</code>と、deriveフィーチャーを持つ<code class="language-text">serde</code>自体との依存関係を追加します。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">[package]
name = &quot;json-api&quot;

[dependencies]
small-string = { version = &quot;1&quot;, features = [ &quot;serde&quot; ] }
serde = { version = &quot;1&quot;, features = [ &quot;derive&quot; ] }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>ここで問題になるのは、<code class="language-text">json-api</code>が<code class="language-text">serde</code>の<code class="language-text">derive</code>フィーチャーを有効化するため、<code class="language-text">small-string</code>とその逆依存関係のすべてが<code class="language-text">syn</code>のコンパイルを待つ必要があることです。同様に、あるクレートが<code class="language-text">syn</code>のフィーチャーの一部にしか依存していなくても、クレートグラフ内の別の何かがすべてのフィーチャーを有効化すると、元のクレートにはそのフィーチャーも追加されます。</p>
<p>これは必ずしも破滅的な状況ではありませんが、依存関係グラフがフィーチャーの存在によって厄介なものとなり得ることが分かります。うれしいことに、<code class="language-text">cargo -Z timings</code>は問題の発生を気づきやすくしてくれます。もっとも、いったい何が間違っているのか明らかになるとは限りませんが。</p>
<p>手続きマクロは、もっと直接的にコンパイルを遅くする原因にもなります。マクロが大量のコードを生成する場合、コンパイルに一定の時間がかかります。というのも、一部のマクロは少量のソースコードを書くことを可能にしており、それ自体は害がないように感じられますが、そのコードが大量のロジックに拡大するのです。代表的な例はシリアル化です。筆者は、数値からJSONへの変換（とその逆）がコンパイルにおいて驚くほど大きな部分を占めていると気づきました。ここではクレートのグラフ全体について考えるのが役立ちます。シリアル化は、システムの境界の葉のクレートで実行するようにすべきです。システムの根幹の付近にシリアル化を導入すると、すべての中間クレートがビルド時間のコストを負担することになります。</p>
<p>いずれにせよ、面白いポイントは、手続きマクロは本質的にコンパイルが遅いわけではないことです。むしろ、ほとんどの手続きマクロはRustをパースする必要があるか、あるいは多くのコードを生成するために遅くなっています。ときには、マクロはsynなしでパースできる単純な構文を受け入れ、それに基づいてわずかなRustコードを生成する場合もあります。有効なRustの生成は、そのパーシングに比べれば全く複雑ではありません。</p>
<h2>コンパイルのモデル：モノモーフィゼーション</h2>
<p>以上でクレートレベルのマクロに関する問題はカバーしたので、コードレベルの問題を詳しく見ていきましょう。主に注目するのはジェネリクスです。ジェネリクスがどのようにコンパイルされるかを理解するのは非常に重要です。Rustの場合はモノモーフィゼーションによって実現されます。以下のありふれたジェネリック関数について考えてみましょう。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">fn frobnicate&lt;T: SomeTrait&gt;(x: &amp;T) {
   ...
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>Rustがこの関数をコンパイルするとき、実際には機械語は出力しません。代わりに、関数の本体の抽象表現をライブラリに保存します。実際のコンパイルは、関数を特定の型の変数で<strong>インスタンス化</strong>したときに行われます。直感的な理解のためにC++の用語を借用するならば、 <code class="language-text">frobnicate</code>は「テンプレート」です。これは変数Tに具体的な型が代入された際に実際の関数を生成します。</p>
<p>言い換えると、以下のケースでは</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">fn frobnicate_both(x: String, y: Widget) {
  frobnicate(&amp;x);
  frobnicate(&amp;y);
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>機械語のレベルで2つの異なる<code class="language-text">frobnicate</code>のコピーが生成されます。両者は変数の詳細な処理が違っていますが、それ以外は同一です。</p>
<p>これではとても困ると思いませんか？どうやら大規模なジェネリック関数を書くと、それをインスタンス化するために複数の型のコードを少し書いただけで、コンパイラに大きな負荷がかかるようです。</p>
<p>ここで残念なお知らせがあります。現実は想像よりもはるかに悪いのです。型が異なっていない場合さえ、重複は発生します。例えば、以下のようなダイヤモンド型の4つのクレートがあるとしましょう。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">   +- B -+
  /       \
A           D
  \       /
   +- C -+</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">frobnicate</code>はAで定義され、BとCで使用されます。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">// A
pub fn frobnicate&lt;T: SomeTrait&gt;(x: &amp;T) { ... }

// B
pub fn do_b(s: String) { a::frobnicate(&amp;s) }

// C
pub fn do_c(s: String) { a::frobnicate(&amp;s) }

// D
fn main() {
  let hello = &quot;hello&quot;.to_owned();
  b::do_b(&amp;hello);
  c::do_c(&amp;hello);
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>このケースでは<code class="language-text">frobincate</code>を<code class="language-text">String</code>でしかインスタンス化していませんが、モノモーフィゼーションはクレートごとに行われるため、コンパイルは2回となります。BとCは別々にコンパイルされ、それぞれに<code class="language-text">do_*</code>関数の機械語が含まれるため、<code class="language-text">frobnicate&lt;String&gt;</code>を必要とします。最適化が無効な場合、<code class="language-text">rustc</code>はテンプレートのインスタンス化を直接の依存関係と共有できますが、親が共通の依存関係とは共有しません。最適化が有効な場合、<code class="language-text">rustc</code>は直接の依存関係とさえモノモーフィゼーションを共有しません。</p>
<p>言い換えると、Rustのジェネリクスによって、多くのクレートでコンパイル回数が意図せず二次関数的に増加する恐れがあります。</p>
<p>これ以上悪いことがあり得るのかと考えているなら、その答えはイエスです。筆者は、モノモーフィゼーションの実際の単位はコード生成単位だと考えており、そのため重複は1つのクレート内でも発生する可能性があります。</p>
<h2>インスタンス化に注意</h2>
<p>ジェネリクスには、重複に加えて、コンパイル時間を利用者に転嫁する問題もあります。ジェネリック関数のコンパイル時間のコストの大部分はその機能を使用するクレートが負担する一方、定義が記述されたクレートはコードを一切生成せず、コードの型をチェックするだけです。何が、どこで、なぜインスタンス化されるかが全く明確でない場合（<a href="https://github.com/rust-analyzer/rust-analyzer/issues/10065">例</a>）もあるため、ジェネリックAPIを直接追跡するのは困難です。</p>
<p>しかし、うれしいことに、その作業は必要ありません。そのためのツールがあるからです。<a href="https://github.com/dtolnay/cargo-llvm-lines">cargo llvm-lines</a>は、特定のクレートでどのようなモノモーフィゼーションが起きているかを教えてくれます。</p>
<p>以下は<a href="https://github.com/rust-analyzer/rust-analyzer/issues/10065">最近の調査に基づく例</a>です。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ cargo llvm-lines --lib --release -p ide_ssr | head -n 12
 Lines          Copies        Function name
  -----          ------        -------------
  533069 (100%)  28309 (100%)  (TOTAL)
   20349 (3.8%)    357 (1.3%)  RawVec&lt;T,A&gt;::current_memory
   18324 (3.4%)    332 (1.2%)  &lt;Weak&lt;T&gt; as Drop&gt;::drop
   14024 (2.6%)    332 (1.2%)  Weak&lt;T&gt;::inner
   11718 (2.2%)    378 (1.3%)  core::ptr::metadata::from_raw_parts_mut
   10710 (2.0%)    357 (1.3%)  &lt;RawVec&lt;T,A&gt; as Drop&gt;::drop
    7984 (1.5%)    332 (1.2%)  &lt;Arc&lt;T&gt; as Drop&gt;::drop
    7968 (1.5%)    332 (1.2%)  Layout::for_value_raw
    6790 (1.3%)     97 (0.3%)  hashbrown::raw::RawTable&lt;T,A&gt;::drop_elements
    6596 (1.2%)     97 (0.3%)  &lt;hashbrown::raw::RawIterRange&lt;T&gt; as Iterator&gt;::next</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この表は各ジェネリック関数について、生成されたコピーの数とその合計サイズを示しています。サイズは関数のエンコードに必要なllvm irの行数として非常に大ざっぱに測定されています。有益な情報としては、llvmはジェネリック関数を持っていません。関数テンプレートをインスタンス化によって実際の関数に変えるのはrustcの仕事です。</p>
<h2>インスタンス化のコントロール</h2>
<p>モノモーフィゼーションの落とし穴が分かれば、大まかな対策も明らかになります。それはジェネリックコードをクレート間の境界に設置しないことです。大規模なシステムを設計するときは、一連のコンポーネントとして設計したうえで、各コンポーネントが具体的な作業を行い、ジェネリックでないインターフェースを持つようにします。</p>
<p>型安全性や作業効率を改善するためにジェネリックインターフェースが必要な場合は、必ずインターフェースのレイヤーを薄くし、ジェネリックでない実装にすぐに委譲するようにします。ここで埋め込むべき関数の典型的な例は、<code class="language-text">str::fs</code>モジュールに記述され、パス上で動作するさまざまな関数です。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">pub fn read&lt;P: AsRef&lt;Path&gt;&gt;(path: P) -&gt; io::Result&lt;Vec&lt;u8&gt;&gt; {
  fn inner(path: &amp;Path) -&gt; io::Result&lt;Vec&lt;u8&gt;&gt; {
    let mut file = File::open(path)?;
    let mut bytes = Vec::new();
    file.read_to_end(&amp;mut bytes)?;
    Ok(bytes)
  }
  inner(path.as_ref())
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>外側の関数はパラメータ化されており、効率良く使用できますが、川下のあらゆるクレートで毎回コンパイルされます。とはいえ、この関数は非常に小規模で、stdでコンパイルされるジェネリックでない関数にすぐ移譲されるので問題ありません。</p>
<p>引数としてパスを必要とする関数を記述する場合、<code class="language-text">&amp;Path</code>を利用するか、あるいは<code class="language-text">impl AsRef&lt;Path&gt;</code>を利用してジェネリックでない実装へ委譲しましょう。APIの効率が気になって、implトレイトを利用するくらいなら、<code class="language-text">inner</code>をうまく使うべきです。関数を呼び出すのに使用される構文と同様に、コンパイル時間も効率の大きな要素となります。</p>
<p>第2の典型的なケースはクロージャです。基本的に<code class="language-text">&amp;dyn Fn()</code>を<code class="language-text">impl Fn()</code>よりも優先しましょう。パスの場合と同様に、<code class="language-text">impl</code>ベースの優れたAPIを薄いラッパーとして、<code class="language-text">dyn</code>ベースの実装が大部分の作業を実施するのが良いでしょう。</p>
<p>これに関する別のアイデアは、「ジェネリックなインラインのホットパスと、コンクリート（具体的）なアウトラインのコールドパス」です。<a href="https://lib.rs/crates/once_cell">once_cell</a>クレートには、以下のような面白いパターンが記述されています（以下は簡略化済み。<a href="https://github.com/matklad/once_cell/blob/f92720a4cac370c117e9d565aebbae2b8de51852/src/imp_std.rs#L86">実際のソース</a>はこちら）。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">struct OnceCell&lt;T&gt; {
  state: AtomicUsize,
  inner: Option&lt;T&gt;,
}

impl&lt;T&gt; OnceCell&lt;T&gt; {
  #[cold]
  fn initialize&lt;F: FnOnce() -&gt; T&gt;(&amp;self, f: F) {
    let mut f = Some(f);
    synchronize_access(self.state, &amp;mut || {
      let f = f.take().unwrap();
      match self.inner {
        None =&gt; self.inner = Some(f()),
        Some(_value) =&gt; (),
      }
    });
  }
}

fn synchronize_access(state: &amp;AtomicUsize, init: &amp;mut dyn FnMut()) {
  // One hundred lines of tricky synchronization code on atomics.
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>この<code class="language-text">initialize</code>関数は2回ジェネリックになります。最初に<code class="language-text">OnceCell</code>が、保存された値の型とともに変数化され、次に<code class="language-text">initialize</code>がジェネリックなクロージャ変数を受け取ります。<code class="language-text">initialize</code>の仕事は、（たとえ同時に多くのスレッドから呼び出されたとしても）最大で1つのfしか実行されないようにすることです。この相互排他タスクは、コンパイル時間を改善するために、実際は具体的なTやFに依存せず、ジェネリックではない<code class="language-text">synchronize_access</code>として実装されています。理想的には<code class="language-text">init: dyn FnOnce()</code>引数を使用したいのですが、現在のRustでは記述できないのが欠点です。このケースでは、<code class="language-text">let mut f = Some(f) / let f = f.take().unwrap()</code>が標準的な次善の策となります。</p>
<h2>結論</h2>
<p>大体こんなところでしょうか！要点を振り返っておきましょう。</p>
<p>ビルド時間はプロジェクトに取り組む人間のトータルな生産性に大きく影響します。ビルド時間の最適化はエンジニアリング課題としては単純で、ツールも存在します。恐らく難しいのは、取り組みが少しずつ後退しないようにすることです。この記事がそのための十分なモチベーションとインスピレーションになるように願っています。大まかな目安として、20万行のRustプロジェクトのビルド時間を妥当な範囲に収めるためにある程度最適化すれば、GitHub Actions上のCIの所要時間は約10分となるはずです。</p>
<p><a href="https://old.reddit.com/r/rust/comments/pid70f/blog_post_fast_rust_builds">/r/rust</a>での議論はこちらです。</p>
<p>本記事は<a href="https://matklad.github.io/2021/09/05/Rust100k.html">One Hundred Thousand Lines of Rust</a>シリーズの一部です。</p>]]></content:encoded></item><item><title><![CDATA[中身のないnpmパッケージ「-」が70万回以上ダウンロードされる— その理由とは]]></title><description><![CDATA[名前が1文字の「-」という謎めいたnpmパッケージは、2020年にレジストリで公開されて以来、70万回以上ダウンロードされています。 さらに、このパッケージには有効なコードが含まれていません。では、…]]></description><link>https://postd.cc/empty-npm-package-has-over-700-000-downloads-heres-why/</link><guid isPermaLink="false">https://postd.cc/empty-npm-package-has-over-700-000-downloads-heres-why/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[npm]]></category><category><![CDATA[JavaScript]]></category><category><![CDATA[NodeJS]]></category><category><![CDATA[オープンソース]]></category><category><![CDATA[OSS]]></category><pubDate>Mon, 13 Dec 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>名前が1文字の「-」という謎めいたnpmパッケージは、2020年にレジストリで公開されて以来、70万回以上ダウンロードされています。</p>
<p>さらに、このパッケージには有効なコードが含まれていません。では、一体なぜこれほど多くダウンロードされているのでしょうか？</p>
<h2>npmパッケージ「-」の中身</h2>
<p>「-」というnpmパッケージは、2020年初めにnpmレジストリで公開されてから、約72万回もダウンロードされてきました。</p>
<p>パッケージのバージョンは0.0.1のみで、ファイルは3つです。</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">tar tvf 0.0.1/--0.0.1.tgz

package/dist/index.js
package/package.json
package/README.md</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>これらのファイルは主にマニフェスト（package.json）とindex.jsで、特に面白い点はなく、スケルトンコードが書かれているだけです。</p>
<p>マニフェストはdevDependenciesでパッケージを導入し、「ts-node」コンポーネントのコマンドを呼び出していますが、それ以上のことは書かれていません。今のところ、実質的にはデッドコードです。
<img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/npm-package-contents.jpg">
<em>「-」のindex.jsファイルとマニフェストファイル（package.json）（BleepingComputer）</em></p>
<h2>50以上のパッケージが「-」を使用</h2>
<p>さらに不思議なこともあります。</p>
<p>無用同然のパッケージ「-」は50以上のnpmパッケージで、明確な説明なしに依存関係として使用されているのです。
<img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/dash-package-dependencies.jpg">
<em>56のパッケージがnpmパッケージ「-」を使用（npmjs.org）</em></p>
<p>しかし、ほとんどの依存関係は週に数十回しかダウンロードされていません。</p>
<p>それでは、なぜ「-」は約72万回もダウンロードされているのでしょうか？</p>
<p>おそらく、このパッケージが呼び出される理由は、npmコマンドをターミナルから実行する際のタイプミスでしょう。</p>
<p>例えば、「somepackage」というnpmパッケージをインストールするときは、以下を実行する必要があります。</p>
<p><code class="language-text">npm i somepackage</code></p>
<p>フラグを指定するときに、例えば次のようなミスをしたとします。</p>
<p><code class="language-text">npm i - someFlag somepackage</code></p>
<p>「-」とsomeFlagの間にスペースがあります。そのため、「-」という名前のパッケージが存在する場合、npm によってそのパッケージがインストールされます。</p>
<p>つまり、このパッケージが何十万回もダウンロードされたのは、開発者のタイプミスによるものと考えられます。</p>
<p>同様に、コマンドラインを通じて<a href="https://docs.npmjs.com/specifying-dependencies-and-devdependencies-in-a-package-json-file#adding-dependencies-to-a-packagejson-file-from-the-command-line">package.json</a>に依存関係を追加するとき、誤って「-」が混入することは簡単に予想できます。</p>
<p>BleepingComputerは、テストで「<a href="https://twitter.com/Ax_Sharma/status/1360311640621654016">somepackage</a>」と「<a href="https://twitter.com/Ax_Sharma/status/1360311640621654016">axsharma</a>」をnpmからダウンロードするため、以下のコマンドを実行しました。</p>
<p>ただし、意図的にタイプミスして、「--save」フラグの前に余計な「-」を入れました。</p>
<p><code class="language-text">npm install somepackage axsharma - --save</code></p>
<p>予想通り、実行後のpackage-lock.jsonファイルとnode_modules/フォルダには「-」パッケージが含まれています。このように現実の依存関係にも「-」が混入する可能性があります。</p>
<p><img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/bc-poc2.jpeg">
<em>生成されたnode_modulesフォルダとpackage-lock.jsonファイルには「-」パッケージが含まれる（BleepingComputer）</em></p>
<p>パッケージのREADME.mdファイルとnpmページは、いずれも「-」がスクリプトによって生成されたことを示しています。</p>
<p><img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/readme.jpg">
<em>「-」のREADMEファイル（BleepingComputer）</em></p>
<h2>「-」を作成した開発者のインタビュー</h2>
<p>BleepingComputerはパッケージの作成者<a href="https://www.npmjs.com/~parzhitsky">Dmitry Parzhitsky</a>氏を取材し、このパッケージを作成した理由などを質問しました。以下はその回答です。</p>
<p>「最初に言っておくと、このパッケージによって、誰かに害を与えるつもりは全くありません」とParzhitsky氏は語りました。パッケージは作成当時のnpmの命名規則に完全に準拠しており、テストとして作成されたものだと強く主張したのです。</p>
<p>「もともとパッケージを公開した理由は、『-』が<a href="https://github.com/npm/validate-npm-package-name#naming-rules">命名規則</a>に沿った有効なパッケージであるかを確認することでした。不思議なことですが、この名前は有効です。例えば『--』という名前のパッケージも公開できます」と彼は続けました。</p>
<p>Parzhitsky氏は、ダウンロード回数が異様に多い理由について、おそらく開発者のタイプミスだろうというBleepingComputerの仮説に同意しています。</p>
<p>さらに彼は、今のところ「-」には何の機能もないが、誤ってパッケージをインストールしたときにエラーメッセージを返すように修正するという意向を明確にしました。</p>
<p>Parzhitsky氏は「このパッケージの挙動は奇妙で、いくらか危険かもしれません。ですから、『-』や『g』、『D』などのパッケージを誤ってインストールしたと疑われる場合に警告を返す機能を導入する予定です」と述べて、私たちとのメールによるインタビューを締めくくりました。
<img src="https://www.bleepstatic.com/images/news/u/1164866/2021/Aug-2021/github-issue.jpg">
<em>GitHubのイシューでは開発者が警告を導入する計画が公表されている</em></p>
<p>今のところ、「-」が悪意あるプログラムだと示すものは何もありませんが、開発者は誤って「-」などのパッケージをビルドに混入させないよう注意すべきだといえます。</p>
<p>その他、1文字の名前のパッケージや、npmコマンドに似た名前のパッケージとしては、<a href="https://www.npmjs.com/package/i">i</a>、<a href="https://www.npmjs.com/package/g">g</a>、<a href="https://www.npmjs.com/package/install">install</a>、<a href="https://www.npmjs.com/package/D">D</a>、<a href="https://www.npmjs.com/package/s">s</a>などが挙げられます。</p>
<p>つまり、誤って「npm i somePackage」ではなく「npm i i somePackage」とタイプした場合、somePackageに加えてiというパッケージもインストールされます。</p>
<p>「本当に問題なのは、これらのパッケージが気づかないうちにインストールされることです。誤ってnpm install - g my-packageを実行しても、目的のパッケージはインストールできます」</p>
<p>「後で別の場所からパッケージにアクセスしようとするまで、タイプミスの可能性には気づきません。それまでは『-』と『g』の両方がプロジェクトに混入しています」</p>
<p>「npmはコマンドと同じ名前のコンポーネントを禁止できるはずです（おそらく禁止すべきでしょう）」。Sonatypeのソフトウェア開発者である<a href="https://www.linkedin.com/in/mtfreeland/">Matt Freeland</a>氏は、BleepingComputerに情報を提供した後でこのように語りました。</p>
<p>さらにFreeland氏は、npm install の実行後に、インストールされたパッケージ名がそのままリストアップされず、「3つのパッケージを追加し、8つのパッケージを検査しました」といった簡単な成功メッセージが表示されることを指摘しました。</p>
<p>そして「インストールしたパッケージ名を成功メッセージに記載すれば、開発者が誤りに気づく可能性があります」と続けています。</p>
<p>最近はnpmなどのオープンソースレジストリがマルウェアや<a href="https://www.bleepingcomputer.com/news/security/spammers-flood-pypi-with-pirated-movie-links-and-bogus-packages/">害のあるコンテンツ</a>であふれる事態が再三にわたり発生しています[<a href="https://www.bleepingcomputer.com/news/security/npm-package-steals-chrome-passwords-on-windows-via-recovery-tool/">1</a>, <a href="https://www.bleepingcomputer.com/news/security/new-linux-macos-malware-hidden-in-fake-browserify-npm-package/">2</a>, <a href="https://www.bleepingcomputer.com/news/security/malicious-npm-packages-target-amazon-slack-with-new-dependency-attacks/">3</a>]。</p>
<p>開発者は、ターミナルにnpmコマンドを入力するとき（特にフラグを使用する場合）は、注意を払うべきです。また、自分のパッケージがなぜこのような謎めいたパッケージに依存しているのかを確認するのも良いでしょう。</p>
<p><em>※2021年8月4日午前7時15分（米国東部時間）更新：BleepingComputerがParzhitsky氏（「-」の開発者）に連絡したのは、本記事が公表されるかなり以前のことです。しかし、詳細な回答が返ってきたのは相当の時間が経ってからで、本記事を公表した後でした。そのため、本記事の一部を更新し、開発者の回答を追加しました。透明性を確保するため、元記事をアーカイブしたコピーを<a href="http://web.archive.org/web/20210803104122/https:/www.bleepingcomputer.com/news/software/empty-npm-package-has-over-700-000-downloads-heres-why/">Wayback Machine</a>で閲覧できるようにしています。</em></p>
<p>関連記事:</p>
<ul>
<li><a href="https://www.bleepingcomputer.com/news/security/npm-fixes-private-package-names-leak-serious-authorization-bug/">NPM fixes private package names leak, serious authorization bug</a></li>
<li><a href="https://www.bleepingcomputer.com/news/security/popular-coa-npm-library-hijacked-to-steal-user-passwords/">Popular 'coa' NPM library hijacked to steal user passwords</a></li>
<li><a href="https://www.bleepingcomputer.com/offer/deals/give-the-gift-of-learning-a-new-language-with-this-subscription/">Give the gift of learning a new language with this subscription</a></li>
<li><a href="https://www.bleepingcomputer.com/offer/deals/get-unlimited-access-to-210-top-mac-apps-for-42-this-black-friday/">Get unlimited access to 210 top Mac apps for $42 this Black Friday</a></li>
<li><a href="https://www.bleepingcomputer.com/offer/deals/read-edit-and-write-pdfs-with-apples-app-of-the-year/">Read, edit, and write PDFs with Apple's App of the year</a></li>
</ul>]]></content:encoded></item><item><title><![CDATA[JavaScriptのバンドルとトランスパイルが不要なモダンWebアプリ]]></title><description><![CDATA[筆者はES6以前のVanilla JSがあまり好きではありませんでした。
そこで、バニラJavaScriptをなるべく書かなくていいように、2000年代を通じてさまざまなアプローチを追求してきました…]]></description><link>https://postd.cc/modern-web-apps-without-javascript-bundling-or-transpiling/</link><guid isPermaLink="false">https://postd.cc/modern-web-apps-without-javascript-bundling-or-transpiling/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[JavaScript]]></category><pubDate>Mon, 15 Nov 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>筆者はES6以前のVanilla JSがあまり好きではありませんでした。
そこで、バニラJavaScriptをなるべく書かなくていいように、2000年代を通じてさまざまなアプローチを追求してきました。最初はRJS（Ruby-to-JavaScript）、次はCoffeeScriptでした。どちらのアプローチも、バニラJavaScriptより楽しく書けるソースコードを、ブラウザが実行できるバージョンのJavaScriptへトランスパイルするものです。ある程度は、うまくいっていました。</p>
<p>とはいえ、これは明らかにその場しのぎの手段に過ぎず、ブラウザがより洗練されたJavaScriptを理解できる日を待ちわびていたのです。ただ、そんな日が来ることはなく、永久にその場しのぎでやり過ごすのかと思われる時期がしばらく続きました。</p>
<p>しかし、幸いなことにJavaScriptは改善を続け、2015年にはES6の仕様が確定し飛躍的な進歩を遂げました。そのかなり前から（そして確定後もしばらくの間）Babelトランスパイラによって未来のJavaScriptであるES6を書くことができました。</p>
<p>これは素晴らしいことでした。さまざまなブラウザがES6のサポートを開始する前から、大幅に改善されたJavaScriptでプログラムを書くことができたのです。まるでズルをしているような気分でした。何の対価も支払うことなく、得をしているように感じたのです。とはいえ、それは必ずしも正しくありませんでした。</p>
<p>Babelでトランスパイルが行われるようになったことで、複雑極まりないパイプラインやツールが増え続けることになりました。未来のJavaScriptは無償で書けるわけではなく、複雑性が増大し続けるという代償を伴っていたのです。目指すゴールがこれではないことは明らかでした。</p>
<p>とはいえ、webpackなどのツールによって、この変化に対応できたのはありがたいことです。webpackは複雑ですが、それを差し引いても価値があると思えるものでした。そこで筆者は、2016年に<a href="https://github.com/rails/webpacker/">Webpacker</a>を作成し、2017年にはRailsでJavaScriptを管理するためのアプローチとしてWebpackerを採用した<a href="https://weblog.rubyonrails.org/2017/2/23/Rails-5-1-beta1/">Rails 5.2</a>をリリースしました。</p>
<p>それから5年が経ち、ついに開発現場の状況は変わりました。筆者はもはや、新しく登場したほとんどのアプリケーションにとって、複雑さに目をつぶってまでwebpackを使い続ける価値があるとは考えていません。ただし、webpackは完全に終わったわけではなく、依然として一部のアプリケーション（たとえばReactなど）で利用するのは理にかなっています。あくまでRailsにとっては優れたデフォルトツールではなくなったということです。</p>
<p>最初の決定的な変化は、すべての主要なブラウザでES6がサポートされるようになったことです。Chrome、Edge、Safari、FirefoxはいずれもES6を完全にサポートしています。最後に残ったのはIE11でしたが、<a href="https://www.onmsft.com/news/microsoft-end-support-for-ie11-on-june-2022">Microsoftは今年、ありがたいことにサポート終了を宣言しました</a>。</p>
<p>その結果、ES6をブラウザで実行するために、トランスパイルによって別のコードに変換する作業が必要なくなりました。ES6はそのままで問題なく実行され、変更は不要です。これは非常に大きな進歩です。</p>
<p>第二の決定的な変化はHTTP2が普及したことです。HTTP2では、1つの大規模なファイルを送信する代わりに、多くの小さなファイルをさほどのデメリットもなく送信できるようになりました。1回の接続で、必要なレスポンスをすべて多重送信できるのです。複数の接続を管理したり、複数のSSLハンドシェイクの費用を支払ったりする必要はありません。これは、すべてのJavaScriptを1つのファイルにバンドルしても、パフォーマンス上のメリットはあまりないことも意味します（ツリーシェイキングのメリットはまだありますが）。</p>
<p>実際、単独の大規模なバンドルの利用は、今や開発者の作業効率（バンドルにかかる時間が長いなど）以外にも複数のデメリットがあります。例えば、すべてのJavaScriptモジュールを1つのファイルにバンドルすると、1つのモジュールが変更されただけでバンドル全体が無効となってしまいます。この場合、ブラウザがバンドル全体を改めてダウンロードし、再びすべてをパースする必要があります。これはよろしくありません。</p>
<p>ちなみに、各モジュールを分ければ、1個のモジュールが無効となっても他のモジュールには影響しません。モジュールが20個あり、1個だけが変更される場合、他の19個はキャッシュされたままです。こうしたキャッシュの仕組みは、パフォーマンスの改善に熱心な人にとっては特にありがたいでしょう。</p>
<p>しかし、それ以上に強調しておきたいのは、バンドルする理由がパフォーマンスのためだけだったとしたら、今後バンドラーは一切不要になることです。シンプルに各モジュールを独立したファイルとして直接ブラウザに提供すれば済むのです。</p>
<p>どういうことか分かりますか？書きやすいJavaScriptを書くためのトランスパイルも、すべてのモジュールをパッケージ化するためのバンドルも必要ありません。つまり、ソースコードを別の何かに変換するためのJavaScriptツールチェーンは不要なのです。そもそも複雑性そのものが取り払われつつあるのです。</p>
<p>上記2つの決定的な変化に加え、パラダイムが変わる最後の一押しは、インポートマップです。インポートマップは、ES6（別名ESM）のモジュールについて、論理参照を可能にします。これまでの明示的なファイル参照方法の問題は、ダイジェスト化されたファイル名を利用した、キャッシュを長期間持続する標準的なアプローチとの相性が悪いことでした。</p>
<p>例えば、<code class="language-text">main-a6d26cef87d241eba5fa.js</code>のようなファイル名において、最後の英数字の部分はファイル全体のダイジェストを表しています。ダイジェストは各ファイルに固有で、ファイルが変更されるとダイジェストも変わります。同じファイルのダイジェストは決して変わらないため、ブラウザはファイルとダイジェストを永久にキャッシュすることができるわけです。もちろん、ファイルが変更されれば、ファイル名も新しくなります。このことは、キャッシュの有効期限をコントロールし、優れたパフォーマンスを実現する上でとても重要です。</p>
<p>しかし、もし50個のファイルが存在し、そのすべてについて<code class="language-text">&quot;import { Controller } from &#39;./javascript/stimulus-a6d26cef87d241eba5fa.js&#39;&quot;</code>のようなimport文をプログラムの初めに書く必要があるとすればどうでしょうか。きっとうんざりするはずです。Stimulusに依存する箇所を変更するたびに、ファイルをひとつずつ更新しなければなりません。しかも、これらのファイルは個別に無効となるのです。</p>
<p>この問題を解決するのが<a href="https://github.com/WICG/import-maps">インポートマップ</a>です。<a href="https://caniuse.com/?search=importmap">この機能はすでにChromeとEdgeに搭載されています</a>。Firefoxも搭載を検討中のようです。Safariはインポートマップに全く言及していませんが、心配は無用です。<a href="https://github.com/guybedford/es-module-shims">完全な実行機能を持つshim</a>を利用して、ESMをサポートするすべてのブラウザ（ES6をサポートするすべてのブラウザに該当）にインポートマップのサポートを導入できます。</p>
<p>インポートマップではインポートの対応関係を定義できます。つまり、<code class="language-text">&quot;./javascript/stimulus-a6d26cef87d241eba5fa.js&quot;</code>に代わって単に<code class="language-text">&quot;stimulus&quot;</code>と記載し、インポートマップは<code class="language-text">&quot;stimulus&quot;: &quot;/javascript/stimulus-a6d26cef87d241eba5fa.js&quot;</code>とします。Stimulusを変更しても、参照文ではなくマップを変更するだけで済みます。</p>
<p>とはいえ、インポートマップを手作業でメンテナンスするのは少々手間がかかります。そこで、筆者はRails向けに<a href="https://github.com/rails/importmap-rails/">importmap-rails</a>というgemを新たに作成しました。このgemでは、プログラムでマップを構築できます。shimも搭載されているため、すべてのブラウザで機能します。さらに、使い慣れた信頼性の高いアセットパイプラインエンジンのSprocketsを利用して、ダイジェスト作業を実施します。まさに完全なパッケージです。</p>
<p>トランスパイラとバンドラーが不要であるのに加え、インポートマップを生成できれば、Node.jsをローカル環境にインストールすることもなく、最新で素晴らしいWebアプリの開発環境を整えることができます。</p>
<p>Rails向けの<a href="https://hotwired.dev/">Hotwire</a> gemは、<a href="https://github.com/hotwired/stimulus-rails">Stimulus</a>と<a href="https://github.com/hotwired/turbo-rails">Turbo</a>の両方について、上記の設定に依存するように変更されています。このgemは、プログラムによるアクセスを利用してバックグラウンドでインポートマップの設定を行うため、application.jsにモジュールを直接インポートできます。</p>
<p>このように、膨大な量の複雑な作業をすっかりなくしてしまうことで、開発体験は言葉にできないほど劇的に変化します。まるで生まれ変わったようです。しかし、依然として未解決の課題や妥協点も残っています。</p>
<p>第一に、上記のとおり、JSXをコンパイルして利用するReactなど人気フレームワークの一部では、これまで紹介してきた技術は（今のところは？）いずれもうまくいきません。明示的なトランスパイルやコンパイルのステップが必要である場合、トランスパイラやコンパイラが求められるのは明らかです。これでは振り出しに戻ってしまいます。</p>
<p>第二に、Action Text、Active Storage、Action Cableなどの機能については、Rails上でJavaScriptを併用しつつ、HotwireをRubyの gemとアセットパイプラインで利用することはできますが、他にも改善が必要なJavaScriptエコシステムはまだ大量に残っています。</p>
<p>このエコシステムは、UMD（Node.jsが使用している旧来のパッケージングシステム）の代わりにESMパッケージを公開する必要があります。とはいえ、<a href="https://www.skypack.dev/">skypack.dev</a>などのサービスは、UMDパッケージをESMに変換することで橋渡しとなるかもしれません。</p>
<p>Railsは、package.jsonファイルを使用し、npmを通じてパッケージを管理しない場合、これらのパッケージに依存し、更新を行う方法を見つけなければなりません。いくつかアイデアはあるものの、まだ具体化には至っていません。それまでの間は、単純にこれらのESMパッケージをダウンロードして、vendorディレクトリにローカルで保存すると良いでしょう。</p>
<p>このように、これまで紹介した技術はいずれも有望で、またES6、HTTP2、インポートマップの普及は飛躍的な進歩を実現しましたが、webpack（とWebpacker）を必要とするアプリが依然として数多く存在するのは明らかです。しかし、それは問題ではありません。私たちは無駄をなくすことで前進してきました。webpackやWebpackerはまだ完全にはなくなりませんが、不要になった人は大いに満足するでしょう。</p>
<p>この基本的な考え方に反する新たなエビデンスが出てこない限り、Rails 7.0のデフォルト設定はインポートマップに基づくものとし、Webpackerによるアプローチはオプションの選択肢にとどめる予定です。</p>
<p>複雑化したフロントエンドを修正し、シンプルな状態に回帰する動きは非常に遅れていました。しかし、ES6、HTTP2、インポートマップがまさにそれを実現してくれるでしょう。本当にうれしい限りです。</p>]]></content:encoded></item><item><title><![CDATA[CDNは5時間で開発できる]]></title><description><![CDATA[「CDN」（content delivery network）という言葉からは、Googleのような大企業がいくつもの巨大なハードウェアを管理し、1秒当たり何百ギガビットものデータを処理する様子が想…]]></description><link>https://postd.cc/the-5-hour-cdn/</link><guid isPermaLink="false">https://postd.cc/the-5-hour-cdn/</guid><category><![CDATA[開発手法・プロジェクト管理]]></category><category><![CDATA[CDN]]></category><pubDate>Mon, 18 Oct 2021 00:00:00 GMT</pubDate><content:encoded><![CDATA[<p>「CDN」（content delivery network）という言葉からは、Googleのような大企業がいくつもの巨大なハードウェアを管理し、1秒当たり何百ギガビットものデータを処理する様子が想像されます。しかし、CDNは単なるWebアプリケーションです。私たちのイメージとは違いますが、それが事実です。8年前に買ったノートパソコンを使って、コーヒーショップの席に座りながらでも、きちんと機能するCDNを構築できます。この記事では、これから5時間でCDNを開発しようとするときに、<a href="https://github.com/fly-apps/nginx-cluster">直面するかもしれないこと</a>を紹介します。</p>
<p>まずはCDNの機能を明らかにしておきましょう。CDNはセントラルリポジトリ（通称：<code class="language-text">オリジン</code>）からファイルを吸い上げ、ユーザーに近い場所でコピーを保存します。初期のオリジンはCDNのFTPサーバーでした。現在、オリジンは単なるWebアプリとなり、CDNはプロキシサーバーとして機能しています。つまり、私たちが構築しようとしているCDNとは分散キャッシングプロキシです。</p>
<h2>プロキシによるキャッシュ</h2>
<p>HTTPが定義するキャッシュ機能は<a href="https://portswigger.net/research/practical-web-cache-poisoning">非常に細かく複雑で</a>、取っつき難いものです。ですから、一からから構築したい欲求は抑えて、他の人が作ってくれたものを利用しましょう。</p>
<p>CDNにはいくつかの選択肢があります。<a href="https://varnish-cache.org/">Varnish</a>（スクリプト、Edge Side Includes、開発者ブログあり）、<a href="https://trafficserver.apache.org/">Apache Traffic Server</a>（導入すれば、今年新たにATSを採用する唯一のチームとなるでしょう）、<a href="https://www.nginx.com/">NGINX</a>（当社も既に利用しています）のどれを利用しても構いません。しかし、これだけは断言できますが、どれを選んでも使いこなすのは大変です。全部試してみて、一番使いやすいものを選びましょう。</p>
<p>（NetlifyはATSで構築されています。CloudflareはNGINX、FastlyはVarnishを利用しています。）</p>
<p>これから構築するCDNは、基本的な水準には達していません。しかし、全く使えないものでもありません。やるべきことは、昔ながらのRailsで開発し、複数の都市で実行するだけです。もしオーストラリアのユーザーをシドニーのサーバーに、チリのユーザーをサンティアゴのサーバーに誘導できれば、それをCDNと呼んで差し支えないでしょう。</p>
<h2>トラフィックのルーティング</h2>
<p>ユーザーを最寄りのサーバーにルーティングするという問題に対しては、基本的に3つの選択肢があります。</p>
<ol>
<li>エニーキャスト：ルーティング可能なアドレスのブロックを取得し、BGP4を通じて複数箇所に対して転送します。あとはTwitterで「コミュニティ」や「ルートリフレクタ」について詳しいふりをしていましょう。代わりにインターネットがルーティングを済ませてくれます。この方法のデメリットは、難易度が高く、インターネットに任せてもうまくいかない場合があることです。メリットは、知ったかぶりできることくらいでしょうか。</li>
<li>DNS：特殊なDNSサーバーを稼働し、IPジオロケーションに基づく特定のサーバーのアドレスを返します。デメリットは、インターネットにおいて、位置を特定できるDNSソースアドレスの利用が減っていることです。メリットとしては、助けを借りずにどこにでも導入できます。</li>
<li>ゲームのサーバーと同様の方式：複数のサーバーにpingを送り、ベストなサーバーを利用します。デメリットとしてはクライアントが必要になります。しかし、あなたはクライアントを持っていないので、ここでは関係ありません。</li>
</ol>
<p>通常、この3つの選択肢のうち（1）と（2）をそれぞれ少しずつ利用することになるでしょう。DNSのロードバランシングは非常にシンプルです。自力で構築する必要はなく、DNSimpleなどの企業のサービスを利用してDNSをホストし、アドレスを返すための規則を定義するだけで済みます。</p>
<p>エニーキャストは難易度が高いです。説明すべきことがたくさんありますが、この記事ではこれ以上踏み込みません。その代わり、<a href="https://fly.io/">当社のサービス</a>を利用すれば、エニーキャストアドレス付きのアプリを2分で実装できます。当社の宣伝のようになってしまいましたが、事実でもあります。</p>
<p>CDNの開発に戻ります。NGINXをそれぞれの都市群に設定し、トラフィックのルーティングのためにDNSかエニーキャストを実行したら、もう90%完了です。しかし、残りの10%に数カ月かかります。</p>
<h2>インターネットの障害</h2>
<p>深海の底に敷き詰められた海底ケーブルは、<a href="https://www.theguardian.com/business/2008/feb/01/internationalpersonalfinancebusiness.internet">常に近くを航行する船に切断される危険にさらされています</a>。とはいえ、陸が海に比べて安全というわけではありません。昔のネットワーク技術者は、「ショベルでうんと深く掘ると、バックボーン（回線）がダメになる」とよく口ずさんでいたものです。回線が切断される懸念は、サーバー1台を1カ所で稼働させるだけならあまり気にならないでしょう。2台以上稼働すると徐々に気になってきます。世界中でサーバーを稼働するとなると心配で夜も眠れません。</p>
<p>しかし、幸いにも、1つのNGINXを複数の都市で稼働すれば、大きな冗長性をすぐに確保できます。サーバーの1つが何らかの理由でダウンしたとしても、多くのサーバーにトラフィックを送信可能です。1台のサーバーがオフラインになっても、残りのサーバーは引き続きほとんどのユーザーにサービスを提供できます。</p>
<p>これを実現するための作業は、退屈ですが簡単です。まずはヘルスチェックを行います（ちなみに、CDNのリージョンがダウンすると通常は通信速度が遅くなります。そのため、ヘルスチェックで検知できるはずです）。すると、NGINXのサーバーがダウンしたタイミングが分かります。それに応じて、DNSを変更するスクリプトを実行したり、BGPのルートを取り消したり（場合によっては単にそのリージョンのBGP4サービスを停止したり）します。</p>
<p>これはサーバーの障害なので発見するのは簡単ですが、インターネットの障害は発見しづらくなります。複数のロケーションから外部のヘルスチェックを実施しなければならないからです。しかし、複数の視点を持つ、基本的なモニタリングは難しくありません。当社では<a href="https://www.datadoghq.com/product/synthetic-monitoring/">Datadog</a>と<a href="https://updown.io/">updown.io</a>を利用しており、<a href="https://fly.io/blog/building-clusters-with-serf/">独自の社内サービスも開発中です</a>。必要な情報は、<code class="language-text">cURL</code>で分かる情報と大差ないはずです。繰り返しになりますが、CDNに関して特に注意すべきことは、リージョンの通信速度が遅くなることであって、インターネットが完全に遮断されることではありません。</p>
<p>ちなみに、こうしたモニタリングのオプションは全て、他のデータセンターから自分のデータセンターへの通信をモニタリングするものです。データセンター間のトラフィックは、出発点としては悪くありませんし、通信量も膨大です。しかし、ユーザーはデータセンターに（おそらく）住んではいないため、代表的なトラフィックとは言えません。あなたのサイトが非常に人気なら、実際のクライアントの状況がよく分かるようなモニタリングが望ましいでしょう。そうしたニーズに応えて、何百もの企業が、通常は密かに埋め込まれたJavaScriptのバグという形態でRUM（リアルユーザーモニタリング）サービスを販売しています。私が好きなRUMはお酒のほうのラムですけどね。これをたくさん飲みながら、<a href="https://www.honeycomb.io/">Honeycomb.io</a>を利用して自分でモニタリング用のコードを追加します。</p>
<p>インターネットのくだらない問題には本当にうんざりします。しかし、幸いにも、多くの人がインターネットを利用する中で解決策を編み出しているため、この問題についてそれほど語る必要はありません。キャッシュの仕組みはもっと面白いものです。以下では「玉ねぎ（※後述参照）」についてお話ししましょう。</p>
<h2>黄金のキャッシュヒット率</h2>
<p>キャッシュの効率性の指標を「キャッシュ率」といいます。キャッシュ率は、オリジンからデータを読み込む場合に対して、キャッシュからデータを読み込む場合の割合を測定したものです。</p>
<p>キャッシュ率80%とは、「リクエストを受信したとき、80%はキャッシュからデータを提供できるが、残りの20%はリクエストをオリジンに転送しなければならない」という意味です。CDNのようなサービスを構築する場合、キャッシュ率が高いほうが良いです。</p>
<p>前述のGitHubリポジトリのリンクにアクセスすると、当社の<a href="https://github.com/fly-apps/nginx/">素朴なNGINX設定</a>ファイルで、サーバーの設定が分離された単独サーバーとなっていることに気づくかもしれません。これを20カ所で導入すると、20台の個別サーバーを所有していることになります。実にシンプルです。しかし、シンプルさの代償として、リージョンごとの冗長性がありません。20台のサーバーは全て、オリジンにリクエストを送信する必要があります。この構造は脆弱で、キャッシュ率は低くなるでしょう。もっと良い方法がほかにあるはずです。</p>
<p>各リージョンに2台目のサーバーを追加すれば、冗長性を簡単に高めることができます。しかし、これはキャッシュ率を大幅に低下させかねません。サーバーを1台のみにするメリットは、全てのユーザーに1つのキャッシュをホスティングすれば良い点です。サーバーが2台だと、オリジン1台当たりのリクエスト件数は2倍になり、キャッシュがないケースも倍増します。</p>
<p>この問題を解決するには、サーバー同士がコミュニケーションを取り、相手のサーバーがコンテンツをキャッシュしている場合はそれを要求できるようにすれば良いでしょう。そのための最も簡単な方法は、キャッシュシャードの作成です。データを分割し、各サーバーがその一部を保持するようにして、リクエストを受けたサーバーは適切な部分のキャッシュシャードを保持しているサーバーにリクエストを転送します。</p>
<p>これは複雑に思えますが、NGINXに搭載されたロードバランサーはハッシュベースのロードバランシングをサポートしています。この機能ではリクエストをハッシュ化し、サーバーが利用可能であると想定して「同じリクエスト」を同じサーバーに転送します。このブログ記事のホーム版をご覧の方は、こちらから<a href="https://github.com/fly-apps/nginx-cluster">すぐに使えるNGINXクラスタの例</a>を確認できます。このクラスタでは、ピアを発見し、URLをハッシュ化し、利用可能なサーバーを通じてリクエストを送信します。</p>
<p><img src="https://fly.io/blog/2021-03-16/consistent-hashing.png?2/3&#x26;centered"></p>
<p><code class="language-text">a.jpg</code>のリクエストがNGINXインスタンスに到達すると、全てのインスタンスがリクエストをクラスタ内の同じサーバーに転送します。<code class="language-text">b.jpg</code>についても同様です。この設定によって、サーバーはロードバランサーのプロキシとストレージの一部としての両方の機能を果たします。さらに先進的な機能をCDNに搭載したい場合は、これらのレイヤーを分離することもできます。</p>
<blockquote>
<h2>PRのためのちょっとした余談</h2>
<p>クラスタNGINXの例ではFlyを利用しています。当社は、Flyの機能は本当に素晴らしいと考えています。<a href="https://fly.io/blog/persistent-storage-and-fast-remote-builds/">永続ボリューム</a>はNGINXのアップグレード間もキャッシュ率を高水準に維持することに寄与します。<a href="https://fly.io/blog/incoming-6pn-private-networks/">暗号化されたプライベートネットワーキング</a>は、NGINX間の安全・簡単なコミュニケーションを実現し、<a href="https://twitter.com/colmmacc/status/1057018254940504064?lang=en">mTLSの複雑な設定</a>の手間を省きます。ビルトインのDNSサービスディスカバリーは、サーバーを追加・削除するときにクラスタを最新に保つのに役立ちます。こうした機能がCDNとあまりに完璧にマッチしているではないかと思われるかもしれませんね。それは当社がこれらの機能をCDN型のワークロード専用に構築したからです。
もちろん、上記の機能は全てFly以外でも実現できます。しかし、<a href="https://fly.io/docs/speedrun/">Flyなら簡単です</a>。</p>
</blockquote>
<h2>玉ねぎのレイヤー</h2>
<p>2つの真実をお伝えしましょう。高いキャッシュ率は善、インターネットは悪です。一石二鳥を好む人なら、キャッシュ率の問題と、インターネットのルーティングがうまくいかない問題を同時に解決できればありがたいと思うでしょう。どちらの問題の解決にも、インターネットがHTTPリクエストを雑に処理しないようにすることが必要となります。キャッシュ率を高めるには、コントロールできないインターネットは迂回して、適切に機能して信頼が置けるネットワークを通じてオリジンへのリクエストを送信することです。</p>
<p>CDNは通常、顧客のオリジンに近いリージョンへサーバーを設置しています。当社のNGINXの例をバージニア州に設定すれば、即座にAWSの最大のリージョン近くにサーバーを所有したことになります。そして、あなたには間違いなくAWSを利用している顧客がいるはずです。これが大規模で強力な独占企業に寄り添うメリットです。</p>
<p><img src="https://fly.io/blog/2021-03-16/proxy-region-to-origin.png?2/3&#x26;centered"></p>
<p>NGINXとプロキシを少し調整すれば、オリジンサーバーへのリクエストを全てバージニア経由で送信できます。これはうれしいことです。というのも、あなたのバージニアのサーバーと、顧客の<code class="language-text">us-east-1</code>（AWSのバージニア州北部リージョン）のサーバーの間には、インターネットに比べてデータ通信を妨げる罠が少ないからです。これで特定の顧客のリクエストを処理する単独の正式なサーバーの組み合わせが設定できました。</p>
<p>うれしいことに、上記の設定はキャッシュ率を改善するだけでなく、インターネットによるルーティングを回避することも可能です。さらに、追加のCDN機能の基礎としての役割も果たします。</p>
<p>CDNを選ぼうとすると、「シールディング」や「リクエスト集約」といった言葉を目にします。オリジンのシールディングとは通常、単に全てのトラフィックを所定のデータセンターを通じて送信することを意味します。オリジンサーバーへのトラフィックを最小化するだけでなく、自分のCDNリージョンが利用しているIPが分かる可能性が高いので、シンプルなL4ファイアウォール規則によってアクセスを制御できます。</p>
<p>また、リクエストの集約もオリジンのトラフィックを最小化できます。この方法は、多くのユーザーが同じコンテンツにアクセスしようとする大規模なイベントで特に有効です。10万人のユーザーが一斉に、<a href="https://fly.io/blog/the-5-hour-content-delivery-network/#">あなたが執筆した最新のブログ記事にアクセス</a>し、しかもその記事がまだキャッシュされていない場合、オリジンに10万件のリクエストが同時に送信される可能性があります。これはほとんどのオリジンが処理しきれないレベルのトラフィックです。この問題を解決するには、特定のURLを「ロック」し、1つのNGINXサーバーがリクエストをオリジンに送信している間、他のクライアントはファイルがキャッシュされるまで一時停止するようにすれば良いのです。当社のクラスタNGINXの例では、<a href="https://github.com/fly-apps/nginx-cluster/blob/main/nginx.conf#L114-L115">この設定はわずか2行で済みます</a>。</p>
<h2>それでも通信が遅いときは</h2>
<p>1つのリージョンを通じてリクエストを送信してキャッシュ率を高めるのは、ちょっとした裏技のようなものです。CDN全体の目的は、ユーザーのために速度を速めることにあります。オーストラリアからバージニアにリクエストを送れば、速度はほんの少しだけ速くなります。コンテンツをキャッシュしたNGINXサーバーからの応答は、ほぼ必ずオリジンサーバーよりも速いからです。しかし、これでも速度は遅く、満足とは言えません。</p>
<p>この問題は玉ねぎのレイヤーを増やすことで解決できます。</p>
<p><img src="https://fly.io/blog/2021-03-16/proxy-region-to-origin-2.png?2/3&#x26;centered"></p>
<p>オーストラリアからのリクエストを、シンガポールを通じてバージニアに送信すれば良いのです。オーストラリアからバージニアまでの14,624kmは光の速さでも時間がかかります。そこで、オーストラリアからの距離が4,300kmのシンガポールへリクエストを送信し、シンガポールのキャッシュを利用することで、はっきりと分かるような遅延を回避します。この場合、キャッシュが存在しないと、直接バージニアにリクエストを送信する場合より通信速度が少し遅くなります。しかし、ここでの差は「イライラするほどの遅さ」と「イライラするほどの遅さよりも150ミリ秒遅い」の違い程度のわずかなものです。</p>
<p>汎用的なCDNを構築している場合は、これは良い方法といえます。各リージョンのキャッシュデータを集積するいくつかの広域リージョンを設定すればよいのです。</p>
<p>汎用的なCDNではなく、単にアプリケーションの速度を速めたい場合、この解決策には不安があります。アプリケーションの一部を複数のリージョンに分散させるほうが良いでしょう。</p>
<h2>まとめ</h2>
<p>CDNの基本的な考え方は目新しいものではなく、簡単に理解できます。一方で、CDNの構築は従来、野心的なチームのための事業であり、個人の開発者が週末に手掛けるようなプロジェクトではありませんでした。</p>
<p>しかし今や、有用なCDNを構築するための基本要素をNGINXなどのツールで利用できるようになってずいぶん経ちました。<a href="https://github.com/fly-apps/nginx-cluster">自宅で前述のGitHubリポジトリを試した</a>方は、ここで取り扱っている最も複雑な設計のイテレーション、つまりリージョンごとの冗長性を有し、リクエストのリージョン間ルーティングの基本的な制御が可能な設計でさえも、ほとんどの場合はNGINXを設定するだけで済むことに気づいたでしょう。しかも、その設定もそれほど複雑ではありません。当社が追加した「コード」は、アドレスのプラグインに必要な<code class="language-text">bash</code>だけです。</p>
<p>これでCDNの出来上がりです。単純なキャッシュなら問題なくこなせます。ただし、複雑なアプリで利用するには足りない部分があります。</p>
<p>特に、この記事ではキャッシュの期限切れについて全く取り上げませんでした。CDNを利用するときに必ずと言っていいほど起きるのが、ローンチのリリースに恥ずかしいタイプミスがあり、気づくのが遅れ、あらゆるキャッシュサーバーに誤字入りのコピーが保存されることです。分散されたキャッシュの削除は、CDNにとって厄介で大きな問題です。この問題だけでまるまる1本記事が書けるでしょう。</p>
<p>CDNレイヤーはアプリの機能を追加する場所としても非常に優れています。画像の最適化、WAF、APIレート制限、ボット検知などの機能が利用できます。これらのテーマだけで10本記事が書けるでしょう。</p>
<p>最後にもう1点。前述のとおり、この記事は全体にバイアスがかかっています。当社がこのCDN設計を取り上げているのは、それをとても簡単に実現できるプラットフォームを当社が構築したからです（皆さんもぜひお試しください）。このプラットフォームの機能を利用すれば、FlyでCDNを容易に構築できるだけでなく、アプリケーション全体を簡単に配信することも可能です。エッジ配信用に設計されたアプリケーションは、CDNを全く必要としない場合もあります。</p>
<hr>
<p>詳細については<a href="https://community.fly.io/t/the-5-hour-cdn/946">こちら</a>までお問い合わせください。</p>
<p>最終更新日：2021年3月16日（*訳註　翻訳時の原文記載更新日）</p>]]></content:encoded></item></channel></rss>